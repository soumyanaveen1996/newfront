var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}(function(){var _this=this;var Bot=function Bot(botState){var _=botState._;var R=botState.R;var d=botState.developer;var LAST_LOGIN='lastLogin';var PREVIOUS_INTENT='previousIntent';var NLPId='FMBot';var smartSuggestionsConstants={CHECKRECENTCALLS:'Check recent calls',EMAILHISTORY:'Email me usage history',CHECKCALLRATES:'Check calling rates',WHYUSEFRONTMCALLS:'Why use FrontM voice calling'};var INMARSAT='Inmarsat';var IRIDIUM='Iridium';var SAT_PHONE='SAT_PHONE';var CALL_HISTORY_FIELD='callHistoryField';var YES='Yes, sure';var NO='No';var TRAVEL='Travel';var MARITIME_PRODUCTIVITY='Maritime Productivity';var MARITIME_OPERATIONS='Maritime Operations';var COMMUNICATIONS_COLLABORATION='Collaborate with crew';var IOT_SENSOR_MANAGEMENT='IoT Sensor Management';var AVIATION_OPERATIONS='Airlines Administation';var PROCESS_AUTOMATION='Process Automation';var CHATBOT_DEVELOPMENT='FrontM Development';var NOTHING_SPECIFIC='Default Settings';var USER_QUALIFICATION_FINISHED='Set Personalisation';var SERVICE_PROVIDER_ACCESS='Access Service Provider Apps';var CANCEL_EDGE_CODE_VALIDATION_PROCESS='Abort';var HELP_CODE_VALIDATION_PROCESS='What is an Access Code?';var DO_NOT_KNOW_CODE_VALIDATION_PROCESS="I don't know the code";var SELECT_POLLING_STRATEGY='Internet usage settings';var TERRESTRIAL_POLLING_STRATEGY='Terrestrial';var SATELLITE_POLLING_STRATEGY='Satellite';var MANUAL_POLLING_STRATEGY='Manual';var AUTOMATIC_POLLING_STRATEGY='Automatic';var CANCEL_POLLING_STRATEGY='Leave it as it is';var MY_ACCOUNT='My Account';var CANCEL_MY_ACCOUNT='Leave my account as is';var CHANGE_PASSWORD='Change Password';var LOGOUT='Logout';var ACTIVE_PUSH_NOTIFICATIONS='Activate Notifications';var DEACTIVE_PUSH_NOTIFICATIONS='Deactivate Notifications';var LOGOUT_INTENT='logoutIntent';var DEREGISTER_PUSH_ON_EDGE='deregisterPushOnEdge';var DEREGISTER_PUSH_ON_BACKEND='deregisterPushOnBackend';var USER_QUALIFICATION='userQualification';var EDGE_CODE_VALIDATION_PROCESS='edgeCodeValidationProcess';var SAVE_NEW_PASSWORD='saveNewPassword';var USER_QUALIFICATION_FIELD='userQualificationField';var AUTO_INSTALLATION_STATUS='autoInstallationStatus';var NOTIFICATION_CHANGES_IN_PROGRESS='notificationsChangesInProgress';var COMPLAINT_FORM='COMPLAINT_FORM';var AUTO_INSTALL_INITIAL_BOTS_INTENT='autoInstallInitialBots';var AUTO_INSTALL_INITIAL_MARITIME_BOTS_INTENT='autoInstallInitialMaritimeBots';var AUTO_INSTALL_INITIAL_BOTS_TRAVEL_INTENT='autoInstallInitialTravelBots';var AUTO_INSTALL_INITIAL_BOTS_PROCESSES_INTENT='autoInstallInitialProcessesBots';var AUTO_INSTALL_INITIAL_BOTS_COMMS_INTENT='autoInstallInitialCommsBots';var AUTO_INSTALL_INITIAL_BOTS_AIRLINES_INTENT='autoInstallInitialAirlinesBots';var AUTO_INSTALL_INITIAL_BOTS_FM_DEV_INTENT='autoInstallInitialFrontMDevBots';var ACTIVATE_DOMAIN_ENTITY='activateDomainEntity';var CHANGE_PASSWORD_FORM='passwordForm';var ALL_QUESTIONS='allQuestions';var HOW_TO_USE_FRONTM='How to use frontM?';var HOW_DO_I_MAKE_CALLS='How do I make calls?';var HOW_DO_I_ADD_CALL_CREDIT='How do I add call credit?';var HOW_DO_I_ADD_CONTACTS='How do I add contacts?';var WHAT_ARE_CHANNELS='What are channels?';var WHAT_IS_AN_ASSISTANT='What is a FrontM app?';var INVITE_PEOPLE_TO_FRONTM='How do I invite people to FrontM?';var WELCOME_MESSAGE='Welcome to FrontM Assistant. I am here to assist you with setup and answer your questions. All you need to do is chat with me here.';var suggestionsArrayForPredictions=function suggestionsArrayForPredictions(){return[Intent.SPEECH(),Intent.NO_INTENT(),main.intentId,yesPush.intentId,edgeValidationProcess.intentId,automaticPollingStrategy.intentId,satellitePollingStrategy.intentId,terrestrialPollingStrategy.intentId,manualPollingStrategy.intentId,cancelPollingStrategySelection.intentId,cancelMyAccount.intentId,noLogout.intentId,noBackend.intentId,cancelValidationProcess.intentId,deregisterPushOnBackend.intentId,checkBalance.intentId,tariffCheck.intentId,tariffCheckSat.intentId,recentCalls.intentId,emailUsageHistory.intentId,callSatFailed.intentId,inviteQuestion,validationCode.intentId,howToUseFrontM.intentId,howDoIAddCallCredits.intentId,howDoIAddContacts.intentId,whatIsFrontM.intentId,howToAccessApps.intentId,cannotFindApp.intentId,howToChat.intentId,dunno.intentId,howToMakeCalls.intentId,inviteQuestion.intentId];};var setComplaintForm=function setComplaintForm(botState){var formId=botState.getField(COMPLAINT_FORM);if(!formId){formId=botState.getUniqueId();botState.setField(COMPLAINT_FORM,formId);}var complaintForm=new Form(botState,{formId:formId,title:'Support Request',description:'Click here to enter details',confirm:'Save',cancel:'Cancel'});complaintForm.addField({id:'title',title:'Title',type:FormFieldTypes.TEXT_FIELD(),mandatory:true});complaintForm.addField({id:'description',title:'Description',type:FormFieldTypes.TEXT_AREA(),mandatory:true});complaintForm.onSubmit=function(data){var ticket=data.fieldsAsObject();botState.addStringResponse('I am generating a support case. Please bear with me for a second');botState.sendMessage({intentId:'emailSupport',title:ticket.title,description:ticket.description});};botState.addForm(complaintForm);};var setChangePasswordForm=function setChangePasswordForm(botState){var formId=botState.getField(CHANGE_PASSWORD_FORM);if(!formId){formId=botState.getUniqueId();botState.setField(CHANGE_PASSWORD_FORM,formId);}var chgPasswordForm=new Form(botState,{formId:formId,title:'Change Password Form',description:'Open this form to change the password',confirm:'Submit',cancel:'Cancel'});chgPasswordForm.addField({id:'oldPassword',title:'Old Password',type:FormFieldTypes.PASSWORD_FIELD(),mandatory:true});chgPasswordForm.addField({id:'newPassword1',title:'New Password',info:'Different from the previous passwords. Minimal 8 characters long. At least one capital letter, number and special character',type:FormFieldTypes.PASSWORD_FIELD(),mandatory:true,validation:true,onMoveOut:function onMoveOut(form){var formObject=form.fieldsAsObject();var response={field:'newPassword1',validationResult:true};if(formObject.oldPassword===formObject.newPassword1){response.validationResult=false;response.validationMessage='Your new password must be different than your old Password';}else if(formObject.newPassword1.length<8){response.validationResult=false;response.validationMessage='Your new password must be minimal 8 characters long';}return response;}});chgPasswordForm.addField({id:'newPassword2',title:'Repeat Password',info:'For security repeat the password from the previous field',type:FormFieldTypes.PASSWORD_FIELD(),mandatory:true,validation:true,onMoveOut:function onMoveOut(form){var formObject=form.fieldsAsObject();var response={field:'newPassword2',validationResult:true};if(formObject.newPassword1!==formObject.newPassword2){response.validationResult=false;response.validationMessage="The new password fields don't match";}return response;}});chgPasswordForm.onSubmit=function(data){var form=data.fieldsAsObject();if(form.newPassword1!==form.newPassword2){botState.addErrorToStack(1002,"The new password fields don't match");}else if(form.oldPassword===form.newPassword1){botState.addErrorToStack(1003,'Your new password must be different than your old Password');}else if(botState._.size(form.newPassword1)<8){botState.addErrorToStack(1004,'Your new password must be minimal 8 characters long');}if(botState.inError){var _chgPasswordForm=botState.getForm(botState.getField(CHANGE_PASSWORD_FORM));botState.addResponse('form2',_chgPasswordForm);}else{botState.sendMessage({intentId:SAVE_NEW_PASSWORD,oldPassword:form.oldPassword,newPassword:form.newPassword1});}};botState.addForm(chgPasswordForm);};var main=new Intent('main');main.onInit=function(){setChangePasswordForm(botState);setComplaintForm(botState);botState.nlp.addNlp(NLPId);};main.onResolution=function _callee(){return regeneratorRuntime.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:botState.runFunctionOnceAnHour(function(){var autoInstallationStatus=botState.getField(AUTO_INSTALLATION_STATUS);var lastLogin=botState.getField(LAST_LOGIN);if(!autoInstallationStatus&&!lastLogin||autoInstallationStatus&&lastLogin){if(!lastLogin){botState.addStringResponse('Hello! '+botState.userName);sendWelcomeMessages(botState);botState.setField(LAST_LOGIN,new Date().toUTCString());if(botState.client===State.MOBILECLIENT()){botState.developer.debug('User is on mobile device');if(botState.amIOnline){botState.developer.debug('User is online');}else{botState.developer.debug('User is offline');botState.addStringResponse("You don't appear to have Internet connection at this moment. In order to personalise the app configuration, I need to be online. Let us skip this for now.");}}else{botState.developer.debug('User is on web');}}else{botState.developer.debug('User logged in before');}}});case 1:case'end':return _context.stop();}}},null,_this);};var showErrorsToUser=function showErrorsToUser(botState){botState.defaultOnError();botState.clearField(NOTIFICATION_CHANGES_IN_PROGRESS);};var yesPush=new Intent('yesPush');yesPush.suggestionsArray=[{lang:'en',list:[ACTIVE_PUSH_NOTIFICATIONS]}];yesPush.onMatching=function(botState){return botState.messageFromUser===ACTIVE_PUSH_NOTIFICATIONS||botState.getNlpResultsForId(NLPId).action==='ActivatePush';};yesPush.onError=function(botState){showErrorsToUser(botState);};yesPush.onResolution=function _callee2(botState){return regeneratorRuntime.async(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:botState.notification.registerDeviceForPushOnEdge();botState.addStringResponse('Push notifications are now active');botState.clearField(PREVIOUS_INTENT);case 3:case'end':return _context2.stop();}}},null,_this);};yesPush.onPrediction=function _callee3(){var notificationsActive;return regeneratorRuntime.async(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:notificationsActive=true;if(!(botState.client===State.MOBILECLIENT())){_context3.next=5;break;}_context3.next=4;return regeneratorRuntime.awrap(botState.notification.isDeviceRegisteredForPush());case 4:notificationsActive=_context3.sent;case 5:if(!([myAccount.intentId].indexOf(botState.activeIntent)>-1&&!notificationsActive)){_context3.next=7;break;}return _context3.abrupt('return',1);case 7:return _context3.abrupt('return',0);case 8:case'end':return _context3.stop();}}},null,_this);};var yesLogout=new Intent('yesLogout');yesLogout.onMatching=function(botState){var previousIntent=botState.getField(PREVIOUS_INTENT);return(botState.messageFromUser===YES||botState.getNlpResultsForId(NLPId).action==='yes')&&previousIntent===LOGOUT_INTENT;};yesLogout.onError=function(botState){showErrorsToUser(botState);};yesLogout.onResolution=function _callee4(botState){return regeneratorRuntime.async(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:botState.processIntentWithId(DEREGISTER_PUSH_ON_EDGE);botState.clearField(PREVIOUS_INTENT);botState.blockSuggestions=true;case 3:case'end':return _context4.stop();}}},null,_this);};var yes=new Intent('yes');yes.suggestionsArray=[{lang:'en',list:[YES]}];yes.onPrediction=function _callee5(){return regeneratorRuntime.async(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:if(!(botState.getField(NOTIFICATION_CHANGES_IN_PROGRESS)===null&&[logout.intentId].indexOf(botState.activeIntent)>-1)){_context5.next=2;break;}return _context5.abrupt('return',1);case 2:return _context5.abrupt('return',0);case 3:case'end':return _context5.stop();}}},null,_this);};var yesBackend=new Intent('yesBackend');yesBackend.onMatching=function(botState){var previousIntent=botState.getField(PREVIOUS_INTENT);return!previousIntent&&botState.getNlpResultsForId(NLPId).action==='yes';};yesBackend.onResolution=function _callee6(botState){return regeneratorRuntime.async(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:botState.addStringResponse('Say yes to you!');case 1:case'end':return _context6.stop();}}},null,_this);};var deActivatePushNotifications=new Intent('deActivatePushNotifications');deActivatePushNotifications.suggestionsArray=[{lang:'en',list:[DEACTIVE_PUSH_NOTIFICATIONS]}];deActivatePushNotifications.onMatching=function(botState){return(botState.messageTypeFromUser==='string'&&botState.messageFromUser===DEACTIVE_PUSH_NOTIFICATIONS||botState.getNlpResultsForId(NLPId).action==='DeactivateNotifications'||botState.messageTypeFromUser==='object'&&botState.messageFromUser.intentId===DEREGISTER_PUSH_ON_EDGE)&&botState.client===State.MOBILECLIENT();};deActivatePushNotifications.onError=function(botState){showErrorsToUser(botState);};deActivatePushNotifications.onResolution=function _callee7(botState){var callNextIntent;return regeneratorRuntime.async(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:callNextIntent=function callNextIntent(notificationDeviceInfo){var forLogOut=false;if(botState.messageTypeFromUser==='object'){forLogOut=true;}if(notificationDeviceInfo){botState.processIntentWithIdAndMessage(DEREGISTER_PUSH_ON_BACKEND,{notificationDeviceInfo:notificationDeviceInfo,forLogOut:forLogOut});}else{if(forLogOut){botState.processIntentWithId(LOGOUT);}}};return _context7.abrupt('return',botState.notification.isDeviceRegisteredForPush().then(function(isRegistered){if(isRegistered){return botState.notification.deregisterDeviceForPushOnEdge().then(function(notificationDeviceInfo){callNextIntent(notificationDeviceInfo);});}else{callNextIntent();}}));case 2:case'end':return _context7.stop();}}},null,_this);};deActivatePushNotifications.onPrediction=function _callee8(){var notificationsActive;return regeneratorRuntime.async(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:notificationsActive=true;if(!(botState.client===State.MOBILECLIENT())){_context8.next=5;break;}_context8.next=4;return regeneratorRuntime.awrap(botState.notification.isDeviceRegisteredForPush());case 4:notificationsActive=_context8.sent;case 5:if(!([myAccount.intentId].indexOf(botState.activeIntent)>-1&&notificationsActive)){_context8.next=7;break;}return _context8.abrupt('return',1);case 7:return _context8.abrupt('return',0);case 8:case'end':return _context8.stop();}}},null,_this);};var deregisterPushOnBackend=new Intent(DEREGISTER_PUSH_ON_BACKEND);deregisterPushOnBackend.runOnCloud();deregisterPushOnBackend.onMatching=function(botState){return botState.messageTypeFromUser==='object'&&botState.messageFromUser.intentId===DEREGISTER_PUSH_ON_BACKEND;};deregisterPushOnBackend.onError=function(botState){showErrorsToUser(botState);};deregisterPushOnBackend.onResolution=function _callee9(botState){return regeneratorRuntime.async(function _callee9$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:return _context9.abrupt('return',botState.notification.deregisterDeviceForPushOnBackend(botState.messageFromUser.notificationDeviceInfo).then(function(){if(botState.messageFromUser.forLogOut){botState.processIntentWithId(LOGOUT);}else{botState.addStringResponse('Notifications are now deactivated');}botState.clearField(NOTIFICATION_CHANGES_IN_PROGRESS);}));case 1:case'end':return _context9.stop();}}},null,_this);};var noPush=new Intent('noPush');noPush.onMatching=function(botState){var previousIntent=botState.getField(PREVIOUS_INTENT);return(botState.messageFromUser===NO||botState.getNlpResultsForId(NLPId).action==='no')&&previousIntent===PUSH_NOTIFICATIONS_CHECK_INTENT;};noPush.onResolution=function _callee10(botState){return regeneratorRuntime.async(function _callee10$(_context10){while(1){switch(_context10.prev=_context10.next){case 0:botState.addStringResponse('No problem, any incoming messages and alerts will not be notified. You can always ask me to switch on notifications here');botState.processIntentWithId(AUTO_INSTALL_INITIAL_BOTS_INTENT);botState.clearField(PREVIOUS_INTENT);case 3:case'end':return _context10.stop();}}},null,_this);};var noLogout=new Intent('noLogout');noLogout.onMatching=function(botState){var previousIntent=botState.getField(PREVIOUS_INTENT);return(botState.messageFromUser===NO||botState.getNlpResultsForId(NLPId).action==='no')&&previousIntent===LOGOUT_INTENT;};noLogout.onResolution=function _callee11(botState){return regeneratorRuntime.async(function _callee11$(_context11){while(1){switch(_context11.prev=_context11.next){case 0:botState.addStringResponse('Ok');botState.clearField(PREVIOUS_INTENT);case 2:case'end':return _context11.stop();}}},null,_this);};var no=new Intent('no');no.suggestionsArray=[{lang:'en',list:[NO]}];no.onPrediction=function _callee12(){return regeneratorRuntime.async(function _callee12$(_context12){while(1){switch(_context12.prev=_context12.next){case 0:if(!(botState.getField(NOTIFICATION_CHANGES_IN_PROGRESS)===null&&[logout.intentId].indexOf(botState.activeIntent)>-1)){_context12.next=2;break;}return _context12.abrupt('return',1);case 2:return _context12.abrupt('return',0);case 3:case'end':return _context12.stop();}}},null,_this);};var noBackend=new Intent('noBackend');noBackend.onMatching=function(botState){return botState.messageFromUser==='TEST';};noBackend.onResolution=function _callee13(botState){return regeneratorRuntime.async(function _callee13$(_context13){while(1){switch(_context13.prev=_context13.next){case 0:botState.addStringResponse('Testing testing');case 1:case'end':return _context13.stop();}}},null,_this);};var sendWelcomeMessages=function sendWelcomeMessages(botState){botState.addStringResponse(WELCOME_MESSAGE);if(botState.client===State.MOBILECLIENT()){botState.addStringResponse('To start using the app, touch the back button to go to the home screen. Explore Contacts, Channels and Apps to start collaborating!');}else{if(botState.user.info.lastLoggedInDomain==='gns'){botState.addStringResponse('To start using the app, simply add credit to make calls to satellite numbers â€“ use the dialpad or add contacts on the left menu');}else{botState.addStringResponse('To start using the app, simply add credit to make calls to satellite numbers, use the dialpad or add contacts on the left menu. Join Channels for group messages, and browse our Apps for other add ons');}}};var amIinGNS=function amIinGNS(){return botState.client===State.WEBCLIENT()&&botState.user.info.lastLoggedInDomain==='gns';};var allQuestions=new Intent(ALL_QUESTIONS);allQuestions.setEnglishSmartSuggestions([HOW_TO_USE_FRONTM,HOW_DO_I_MAKE_CALLS,HOW_DO_I_ADD_CALL_CREDIT,HOW_DO_I_ADD_CONTACTS,WHAT_ARE_CHANNELS,INVITE_PEOPLE_TO_FRONTM,smartSuggestionsConstants.CHECKCALLRATES,smartSuggestionsConstants.CHECKRECENTCALLS,smartSuggestionsConstants.EMAILHISTORY,smartSuggestionsConstants.WHYUSEFRONTMCALLS],[HOW_TO_USE_FRONTM,HOW_DO_I_MAKE_CALLS,HOW_DO_I_ADD_CALL_CREDIT,HOW_DO_I_ADD_CONTACTS,INVITE_PEOPLE_TO_FRONTM,smartSuggestionsConstants.CHECKCALLRATES,smartSuggestionsConstants.CHECKRECENTCALLS,smartSuggestionsConstants.EMAILHISTORY,smartSuggestionsConstants.WHYUSEFRONTMCALLS],amIinGNS);allQuestions.onPrediction=function _callee14(){var formId;return regeneratorRuntime.async(function _callee14$(_context14){while(1){switch(_context14.prev=_context14.next){case 0:formId=botState.getField(CHANGE_PASSWORD_FORM)||' ';if(!(R.append(formId,suggestionsArrayForPredictions()).indexOf(botState.activeIntent)>-1)){_context14.next=3;break;}return _context14.abrupt('return',1);case 3:return _context14.abrupt('return',0);case 4:case'end':return _context14.stop();}}},null,_this);};var testVideo=new Intent('testVideo');testVideo.onMatching=function(){return botState.messageFromUser==='TestVideo';};testVideo.onResolution=function _callee15(){return regeneratorRuntime.async(function _callee15$(_context15){while(1){switch(_context15.prev=_context15.next){case 0:botState.addStringResponse('This is google https://google.com');botState.addResponse('video','https://frontm-contentdelivery-mobilehub-1030065648.s3.amazonaws.com/videos/How+to+call+using+contact+list.mp4');case 2:case'end':return _context15.stop();}}},null,_this);};var userQualification=new Intent(USER_QUALIFICATION);userQualification.onMatching=function(botState){return botState.messageTypeFromUser==='object'&&botState.messageFromUser.intentId===USER_QUALIFICATION;};userQualification.onResolution=function _callee16(botState){var userQualificationField,cards;return regeneratorRuntime.async(function _callee16$(_context16){while(1){switch(_context16.prev=_context16.next){case 0:userQualificationField=botState.getField(USER_QUALIFICATION_FIELD);if(!userQualificationField){botState.addStringResponse('We provide a range of Apps to address your context-specific needs. Explore the below options and select one that best applies to you.');cards=[];if(botState.client===State.MOBILECLIENT()){cards=[{pictureUrl:'https://s3.amazonaws.com/frontm-contentdelivery-mobilehub-1030065648/botLogos/cardIcons/Travel.jpeg',description:'For those with a travel bug, a suite of Apps that accompany you on your flight or cruise. \n'+'Apps that ensure you are in control during your travel. \n'+'1. Flight tracker: From the comfort of your aeroplane seats, track your flight, discover destination, explore hotels and more\n'+'2. Journey planner: For the air traveller to easily access transit info, baggage tracking, flight status, booking changes and more\n'+'3. Coming soon',action:TRAVEL},{pictureUrl:'https://s3.amazonaws.com/frontm-contentdelivery-mobilehub-1030065648/botLogos/cardIcons/Ship.jpeg',description:'For mariners and crew, applications that enhance collaboration, operations and productivity\n'+'Applications that help you save time, money and be more efficient in marine operations\n'+'1. Boat tracker: For the shore coordinator and ship master, track you boats, get safety alerts and situational information\n'+'2. Service provider specific applications: You need a licence code to unlock them, follow through the conversation next. \n'+'3. New applications coming soon',action:MARITIME_PRODUCTIVITY},{pictureUrl:'https://s3.amazonaws.com/frontm-contentdelivery-mobilehub-1030065648/botLogos/cardIcons/Process.jpeg',description:'For teams dealing with satellite terminals, Industrial IoT and other operations in remote industries\n'+'Applications that help you save time, money and be more efficient in remote operations \n'+'1. Sensor manager: Activate and manage your sensors on your LoRaWAN network\n'+'2. Service provider specific applications: You need a licence code to unlock them, follow through the conversation next. \n'+'3. Many new applications coming soon',action:PROCESS_AUTOMATION},{pictureUrl:'https://s3.amazonaws.com/frontm-contentdelivery-mobilehub-1030065648/botLogos/cardIcons/Check.jpeg',description:"For generic users to mainly take advantage of FrontM's default chat, channels and voice calling features \n"+'We are constantly adding new Apps for your generic use\n'+'1. Survey: Tell us about the app, \n'+'2. New applications coming soon',action:NOTHING_SPECIFIC}];}else{cards=[{pictureUrl:'https://s3.amazonaws.com/frontm-contentdelivery-mobilehub-1030065648/botLogos/cardIcons/Ship.jpeg',description:'Manage your digital wallet, call satellite numbers, administrate your team channels, view performance metrics and more',action:COMMUNICATIONS_COLLABORATION},{pictureUrl:'https://s3.amazonaws.com/frontm-contentdelivery-mobilehub-1030065648/botLogos/cardIcons/Travel.jpeg',description:'Track your fleet, install apps on your flight edge servers, manage performance, perform upgrades and obtain insights.  \n',action:AVIATION_OPERATIONS},{pictureUrl:'https://s3.amazonaws.com/frontm-contentdelivery-mobilehub-1030065648/botLogos/cardIcons/Process.jpeg',description:'Develop with FrontM and integrate your application for FrontM marketplace. Access airlines, cruises, shipping and remote enterprise markets through a single channel',action:CHATBOT_DEVELOPMENT},{pictureUrl:'https://s3.amazonaws.com/frontm-contentdelivery-mobilehub-1030065648/botLogos/cardIcons/Check.jpeg',description:"For generic users to mainly take advantage of FrontM's default chat, channels and voice calling features \n"+'We are constantly adding new Apps for your generic use\n'+'1. Survey: Tell us about the app, \n'+'2. New applications coming soon',action:NOTHING_SPECIFIC}];}botState.addResponse('cards',cards);botState.blockSuggestions=true;}else{botState.addResponse('silent',{});}case 2:case'end':return _context16.stop();}}},null,_this);};var userQualificationFinished=new Intent('userQualificationFinished');userQualificationFinished.onMatching=function(botState){return botState.messageFromUser===USER_QUALIFICATION_FINISHED;};userQualificationFinished.onResolution=function _callee17(botState){return regeneratorRuntime.async(function _callee17$(_context17){while(1){switch(_context17.prev=_context17.next){case 0:sendWelcomeMessages(botState);case 1:case'end':return _context17.stop();}}},null,_this);};var setNewPersonalisationTo=function setNewPersonalisationTo(botState,personalisation,text){var userQualificationField=botState.getField(USER_QUALIFICATION_FIELD);if(userQualificationField){if(personalisation==='nothing'){botState.addStringResponse('Ok');return;}var index=_.findIndex(userQualificationField,function(existingPersonalisation){return existingPersonalisation===personalisation;});if(index===-1){userQualificationField.push(personalisation);botState.setField(USER_QUALIFICATION_FIELD,userQualificationField);botState.addStringResponse('Sure, '+personalisation+' is also added to your preferences.\n'+'Again remember that I am always here to help you with any general enquiries and app settings');}else{botState.addStringResponse("You've already set "+personalisation+' as your preferred context');}}else{botState.setField(USER_QUALIFICATION_FIELD,[personalisation]);switch(personalisation){case maritimeProductivity.intentId:{botState.sendMessage({intentId:AUTO_INSTALL_INITIAL_MARITIME_BOTS_INTENT});break;}case aviationProductivity.intentId:{botState.sendMessage({intentId:AUTO_INSTALL_INITIAL_BOTS_AIRLINES_INTENT});break;}case communicationCollaboration.intentId:{botState.sendMessage({intentId:AUTO_INSTALL_INITIAL_BOTS_COMMS_INTENT});break;}case chatbotDevelopment.intentId:{botState.sendMessage({intentId:AUTO_INSTALL_INITIAL_BOTS_FM_DEV_INTENT});break;}case processAutomation.intentId:{botState.sendMessage({intentId:AUTO_INSTALL_INITIAL_BOTS_PROCESSES_INTENT});break;}case processAutomation.intentId:{botState.sendMessage({intentId:AUTO_INSTALL_INITIAL_BOTS_TRAVEL_INTENT});break;}default:{botState.sendMessage({intentId:AUTO_INSTALL_INITIAL_BOTS_INTENT});break;}}}};var travel=new Intent('travel');travel.suggestionsArray=[{lang:'en',list:[TRAVEL]}];travel.onMatching=function(botState){return botState.messageFromUser===TRAVEL||botState.getNlpResultsForId(NLPId).action==='travel';};travel.onResolution=function _callee18(botState){return regeneratorRuntime.async(function _callee18$(_context18){while(1){switch(_context18.prev=_context18.next){case 0:setNewPersonalisationTo(botState,travel.intentId,'Travel');case 1:case'end':return _context18.stop();}}},null,_this);};travel.onPrediction=function _callee19(){return regeneratorRuntime.async(function _callee19$(_context19){while(1){switch(_context19.prev=_context19.next){case 0:if(!([userQualificationFinished.intentId].indexOf(botState.activeIntent)>-1)){_context19.next=2;break;}return _context19.abrupt('return',1);case 2:return _context19.abrupt('return',0);case 3:case'end':return _context19.stop();}}},null,_this);};var maritimeProductivity=new Intent('maritimeProductivity');maritimeProductivity.suggestionsArray=[{lang:'en',list:[MARITIME_PRODUCTIVITY]}];maritimeProductivity.onMatching=function(botState){return botState.messageFromUser===MARITIME_PRODUCTIVITY||botState.getNlpResultsForId(NLPId).action==='MaritimeProductivity';};maritimeProductivity.onResolution=function _callee20(botState){return regeneratorRuntime.async(function _callee20$(_context20){while(1){switch(_context20.prev=_context20.next){case 0:setNewPersonalisationTo(botState,maritimeProductivity.intentId,'Maritime Productivity');case 1:case'end':return _context20.stop();}}},null,_this);};maritimeProductivity.onPrediction=function _callee21(){return regeneratorRuntime.async(function _callee21$(_context21){while(1){switch(_context21.prev=_context21.next){case 0:if(!([userQualificationFinished.intentId].indexOf(botState.activeIntent)>-1)){_context21.next=2;break;}return _context21.abrupt('return',1);case 2:return _context21.abrupt('return',0);case 3:case'end':return _context21.stop();}}},null,_this);};var aviationProductivity=new Intent('aviationProductivity');aviationProductivity.suggestionsArray=[{lang:'en',list:[AVIATION_OPERATIONS]}];aviationProductivity.onMatching=function(botState){return botState.messageFromUser===AVIATION_OPERATIONS||botState.getNlpResultsForId(NLPId).action==='AviationOperations';};aviationProductivity.onResolution=function _callee22(botState){return regeneratorRuntime.async(function _callee22$(_context22){while(1){switch(_context22.prev=_context22.next){case 0:setNewPersonalisationTo(botState,aviationProductivity.intentId,'Aviation Productivity');case 1:case'end':return _context22.stop();}}},null,_this);};aviationProductivity.onPrediction=function _callee23(){return regeneratorRuntime.async(function _callee23$(_context23){while(1){switch(_context23.prev=_context23.next){case 0:if(!([userQualificationFinished.intentId].indexOf(botState.activeIntent)>-1)){_context23.next=2;break;}return _context23.abrupt('return',1);case 2:return _context23.abrupt('return',0);case 3:case'end':return _context23.stop();}}},null,_this);};var maritimeOperations=new Intent('maritimeOperations');maritimeOperations.suggestionsArray=[{lang:'en',list:[MARITIME_OPERATIONS]}];maritimeOperations.onMatching=function(botState){return(botState.messageFromUser===MARITIME_OPERATIONS||botState.getNlpResultsForId(NLPId).action==='MaritimeProductivity')&&botState.client===State.WEBCLIENT();};maritimeOperations.onResolution=function _callee24(botState){return regeneratorRuntime.async(function _callee24$(_context24){while(1){switch(_context24.prev=_context24.next){case 0:setNewPersonalisationTo(botState,maritimeOperations.intentId,MARITIME_OPERATIONS);case 1:case'end':return _context24.stop();}}},null,_this);};maritimeOperations.onPrediction=function _callee25(){return regeneratorRuntime.async(function _callee25$(_context25){while(1){switch(_context25.prev=_context25.next){case 0:if(!([userQualificationFinished.intentId].indexOf(botState.activeIntent)>-1)){_context25.next=2;break;}return _context25.abrupt('return',1);case 2:return _context25.abrupt('return',0);case 3:case'end':return _context25.stop();}}},null,_this);};var communicationCollaboration=new Intent('communicationCollaboration');communicationCollaboration.suggestionsArray=[{lang:'en',list:[COMMUNICATIONS_COLLABORATION]}];communicationCollaboration.onMatching=function(botState){return botState.messageFromUser===COMMUNICATIONS_COLLABORATION||botState.getNlpResultsForId(NLPId).action==='CommunicationCollaboration';};communicationCollaboration.onResolution=function _callee26(botState){return regeneratorRuntime.async(function _callee26$(_context26){while(1){switch(_context26.prev=_context26.next){case 0:setNewPersonalisationTo(botState,communicationCollaboration.intentId,COMMUNICATIONS_COLLABORATION);case 1:case'end':return _context26.stop();}}},null,_this);};communicationCollaboration.onPrediction=function _callee27(){return regeneratorRuntime.async(function _callee27$(_context27){while(1){switch(_context27.prev=_context27.next){case 0:if(!([userQualificationFinished.intentId].indexOf(botState.activeIntent)>-1)){_context27.next=2;break;}return _context27.abrupt('return',1);case 2:return _context27.abrupt('return',0);case 3:case'end':return _context27.stop();}}},null,_this);};var iotSensorManagement=new Intent('iotSensorManagement');iotSensorManagement.suggestionsArray=[{lang:'en',list:[IOT_SENSOR_MANAGEMENT]}];iotSensorManagement.onMatching=function(botState){return botState.messageFromUser===IOT_SENSOR_MANAGEMENT||botState.getNlpResultsForId(NLPId).action==='IOT';};iotSensorManagement.onResolution=function _callee28(botState){return regeneratorRuntime.async(function _callee28$(_context28){while(1){switch(_context28.prev=_context28.next){case 0:setNewPersonalisationTo(botState,iotSensorManagement.intentId,IOT_SENSOR_MANAGEMENT);case 1:case'end':return _context28.stop();}}},null,_this);};iotSensorManagement.onPrediction=function _callee29(){return regeneratorRuntime.async(function _callee29$(_context29){while(1){switch(_context29.prev=_context29.next){case 0:if(!([userQualificationFinished.intentId].indexOf(botState.activeIntent)>-1)){_context29.next=2;break;}return _context29.abrupt('return',1);case 2:return _context29.abrupt('return',0);case 3:case'end':return _context29.stop();}}},null,_this);};var chatbotDevelopment=new Intent('chatbotDevelopment');chatbotDevelopment.suggestionsArray=[{lang:'en',list:[CHATBOT_DEVELOPMENT]}];chatbotDevelopment.onMatching=function(botState){return botState.messageFromUser===CHATBOT_DEVELOPMENT||botState.getNlpResultsForId(NLPId).action==='development';};chatbotDevelopment.onResolution=function _callee30(botState){return regeneratorRuntime.async(function _callee30$(_context30){while(1){switch(_context30.prev=_context30.next){case 0:setNewPersonalisationTo(botState,chatbotDevelopment.intentId,CHATBOT_DEVELOPMENT);case 1:case'end':return _context30.stop();}}},null,_this);};chatbotDevelopment.onPrediction=function _callee31(){return regeneratorRuntime.async(function _callee31$(_context31){while(1){switch(_context31.prev=_context31.next){case 0:if(!([userQualificationFinished.intentId].indexOf(botState.activeIntent)>-1)){_context31.next=2;break;}return _context31.abrupt('return',1);case 2:return _context31.abrupt('return',0);case 3:case'end':return _context31.stop();}}},null,_this);};var processAutomation=new Intent('processAutomation');processAutomation.suggestionsArray=[{lang:'en',list:[PROCESS_AUTOMATION]}];processAutomation.onMatching=function(botState){return botState.messageFromUser===PROCESS_AUTOMATION||botState.getNlpResultsForId(NLPId).action==='ProcessAutomation';};processAutomation.onResolution=function _callee32(botState){return regeneratorRuntime.async(function _callee32$(_context32){while(1){switch(_context32.prev=_context32.next){case 0:setNewPersonalisationTo(botState,processAutomation.intentId,'Process Automation');case 1:case'end':return _context32.stop();}}},null,_this);};processAutomation.onPrediction=function _callee33(){return regeneratorRuntime.async(function _callee33$(_context33){while(1){switch(_context33.prev=_context33.next){case 0:if(!([userQualificationFinished.intentId].indexOf(botState.activeIntent)>-1)){_context33.next=2;break;}return _context33.abrupt('return',1);case 2:return _context33.abrupt('return',0);case 3:case'end':return _context33.stop();}}},null,_this);};var nothingSpecific=new Intent('nothingSpecific');nothingSpecific.suggestionsArray=[{lang:'en',list:[NOTHING_SPECIFIC]}];nothingSpecific.onMatching=function(botState){return botState.messageFromUser===NOTHING_SPECIFIC||botState.getNlpResultsForId(NLPId).action==='NothingSpecific';};nothingSpecific.onResolution=function _callee34(botState){return regeneratorRuntime.async(function _callee34$(_context34){while(1){switch(_context34.prev=_context34.next){case 0:setNewPersonalisationTo(botState,nothingSpecific.intentId,'nothing');case 1:case'end':return _context34.stop();}}},null,_this);};nothingSpecific.onPrediction=function _callee35(){return regeneratorRuntime.async(function _callee35$(_context35){while(1){switch(_context35.prev=_context35.next){case 0:if(!([userQualificationFinished.intentId].indexOf(botState.activeIntent)>-1)){_context35.next=2;break;}return _context35.abrupt('return',1);case 2:return _context35.abrupt('return',0);case 3:case'end':return _context35.stop();}}},null,_this);};var serviceProviderAccess=new Intent('serviceProviderAccess');serviceProviderAccess.onMatching=function(botState){return botState.messageFromUser===SERVICE_PROVIDER_ACCESS||botState.getNlpResultsForId(NLPId).action==='InvitationCode';};serviceProviderAccess.onResolution=function _callee36(botState){return regeneratorRuntime.async(function _callee36$(_context36){while(1){switch(_context36.prev=_context36.next){case 0:if(botState.client===State.WEBCLIENT()){botState.addStringResponse('Open the drop down at the top left of this page and then click on +. Then enter the code you have been given');}else{botState.addStringResponse('Please type in or scan the invitation code provided');}case 1:case'end':return _context36.stop();}}},null,_this);};serviceProviderAccess.onPrediction=function _callee37(){var lastLogin,userQualificationField,formId;return regeneratorRuntime.async(function _callee37$(_context37){while(1){switch(_context37.prev=_context37.next){case 0:lastLogin=botState.getField(LAST_LOGIN);userQualificationField=botState.getField(USER_QUALIFICATION_FIELD);formId=botState.getField(CHANGE_PASSWORD_FORM)||'';if(!([formId,Intent.SPEECH(),Intent.NO_INTENT(),main.intentId,edgeValidationProcess.intentId,automaticPollingStrategy.intentId,satellitePollingStrategy.intentId,terrestrialPollingStrategy.intentId,manualPollingStrategy.intentId,cancelPollingStrategySelection.intentId,cancelMyAccount.intentId,noLogout.intentId,noBackend.intentId,cancelValidationProcess.intentId,deregisterPushOnBackend.intentId].indexOf(botState.activeIntent)>-1&&lastLogin&&userQualificationField)){_context37.next=5;break;}return _context37.abrupt('return',1);case 5:return _context37.abrupt('return',0);case 6:case'end':return _context37.stop();}}},null,_this);};var validationCode=new Intent('validationCode');validationCode.runOnCloud();validationCode.onMatching=function(botState){return(botState.previousActiveIntent===serviceProviderAccess.intentId||botState.previousActiveIntent===validationCode.intentId||botState.messageTypeFromUser==='barcode')&&(botState.getNlpResultsForId(NLPId).action===Intent.NO_INTENT()||botState.getNlpResultsForId(NLPId).action==='undefined');};validationCode.onResolution=function _callee38(botState){return regeneratorRuntime.async(function _callee38$(_context38){while(1){switch(_context38.prev=_context38.next){case 0:return _context38.abrupt('return',botState.marketplace.validateActivationCode(botState.messageFromUser).then(function(domains){if(domains&&!botState._.isEmpty(domains)){var activationEntity=botState.getField(ACTIVATE_DOMAIN_ENTITY);botState.setField(ACTIVATE_DOMAIN_ENTITY,domains);botState.sendMessage({intentId:EDGE_CODE_VALIDATION_PROCESS});}else{botState.addErrorToStack(1001,"I could not validate the code. Please try again or click Abort if you wouldn't like to try further.");}}));case 1:case'end':return _context38.stop();}}},null,_this);};var autoInstallInitialBots=new Intent(AUTO_INSTALL_INITIAL_BOTS_INTENT);autoInstallInitialBots.runOnCloud();autoInstallInitialBots.onMatching=function(){var intentId=botState.messageFromUser.intentId||'';return intentId.substr(0,18)==='autoInstallInitial';};autoInstallInitialBots.onResolution=function _callee39(botState){var intentId;return regeneratorRuntime.async(function _callee39$(_context39){while(1){switch(_context39.prev=_context39.next){case 0:intentId=botState.messageFromUser.intentId||'';if(!(intentId!=='')){_context39.next=4;break;}botState.addStringResponse('Activating code');return _context39.abrupt('return',botState.marketplace.validateActivationCode(intentId).then(function(domains){if(domains&&!botState._.isEmpty(domains)){botState.processIntentWithId(EDGE_CODE_VALIDATION_PROCESS);}else{botState.addErrorToStack(1001,"I could not validate the code. Please try again or click Abort if you wouldn't like to try further.");}}));case 4:case'end':return _context39.stop();}}},null,_this);};var cancelValidationProcess=new Intent('cancelValidationCode');cancelValidationProcess.onMatching=function(botState){return botState.messageFromUser===CANCEL_EDGE_CODE_VALIDATION_PROCESS;};cancelValidationProcess.onResolution=function _callee40(botState){return regeneratorRuntime.async(function _callee40$(_context40){while(1){switch(_context40.prev=_context40.next){case 0:botState.addStringResponse('Ok');case 1:case'end':return _context40.stop();}}},null,_this);};cancelValidationProcess.onPrediction=function _callee41(){return regeneratorRuntime.async(function _callee41$(_context41){while(1){switch(_context41.prev=_context41.next){case 0:if(!([validationCode.intentId,serviceProviderAccess.intentId].indexOf(botState.activeIntent)>-1)){_context41.next=2;break;}return _context41.abrupt('return',1);case 2:return _context41.abrupt('return',0);case 3:case'end':return _context41.stop();}}},null,_this);};var edgeValidationProcess=new Intent(EDGE_CODE_VALIDATION_PROCESS);edgeValidationProcess.onMatching=function(botState){var activationEntity=botState.getField(ACTIVATE_DOMAIN_ENTITY);return activationEntity&&!botState.messageFromUser.intentId||botState.messageFromUser.intentId===EDGE_CODE_VALIDATION_PROCESS;};edgeValidationProcess.onResolution=function _callee42(botState){var domains;return regeneratorRuntime.async(function _callee42$(_context42){while(1){switch(_context42.prev=_context42.next){case 0:domains=botState.getField(ACTIVATE_DOMAIN_ENTITY)||['frontmai'];return _context42.abrupt('return',botState.marketplace.activateDomainsOnEdge(domains).then(function(){return botState.marketplace.autoInstallAllBotsOnEdge().then(function(){botState.setField(AUTO_INSTALLATION_STATUS,true);sendWelcomeMessages(botState);botState.clearField(ACTIVATE_DOMAIN_ENTITY);});}).catch(function(){}));case 2:case'end':return _context42.stop();}}},null,_this);};var selectPollingStrategy=new Intent('selectPollingStrategy');selectPollingStrategy.suggestionsArray=[{lang:'en',list:[SELECT_POLLING_STRATEGY]}];selectPollingStrategy.onMatching=function(botState){return botState.messageFromUser===SELECT_POLLING_STRATEGY||botState.getNlpResultsForId(NLPId).action==='Polling Strategy';};selectPollingStrategy.onResolution=function _callee43(botState){return regeneratorRuntime.async(function _callee43$(_context43){while(1){switch(_context43.prev=_context43.next){case 0:botState.addStringResponse("Uniquely, FrontM helps you control how you use your available internet. This is particularly useful when you're on in-flight WiFi or on a Ship.");botState.addStringResponse('Select a setting from below suggestions');case 2:case'end':return _context43.stop();}}},null,_this);};selectPollingStrategy.onPrediction=function _callee44(){var lastLogin,formId;return regeneratorRuntime.async(function _callee44$(_context44){while(1){switch(_context44.prev=_context44.next){case 0:lastLogin=botState.getField(LAST_LOGIN);formId=botState.getField(CHANGE_PASSWORD_FORM)||'';if(!(R.append(formId,suggestionsArrayForPredictions()).indexOf(botState.activeIntent)>-1&&lastLogin)){_context44.next=4;break;}return _context44.abrupt('return',1);case 4:return _context44.abrupt('return',0);case 5:case'end':return _context44.stop();}}},null,_this);};var automaticPollingStrategy=new Intent('automaticPollingStrategy');automaticPollingStrategy.suggestionsArray=[{lang:'en',list:[AUTOMATIC_POLLING_STRATEGY]}];automaticPollingStrategy.onMatching=function(botState){return(botState.messageFromUser===AUTOMATIC_POLLING_STRATEGY||botState.getNlpResultsForId(NLPId).action==='AutomaticNetworkMode')&&botState.client===State.MOBILECLIENT();};automaticPollingStrategy.onResolution=function _callee45(botState){return regeneratorRuntime.async(function _callee45$(_context45){while(1){switch(_context45.prev=_context45.next){case 0:return _context45.abrupt('return',botState.setNetworkModeTo('automatic').then(function(){botState.addStringResponse('I will be detecting automatically the type of network you are using');}));case 1:case'end':return _context45.stop();}}},null,_this);};automaticPollingStrategy.onPrediction=function _callee46(){return regeneratorRuntime.async(function _callee46$(_context46){while(1){switch(_context46.prev=_context46.next){case 0:if(!([selectPollingStrategy.intentId].indexOf(botState.activeIntent)>-1)){_context46.next=2;break;}return _context46.abrupt('return',1);case 2:return _context46.abrupt('return',0);case 3:case'end':return _context46.stop();}}},null,_this);};var terrestrialPollingStrategy=new Intent('terrestrialPollingStrategy');terrestrialPollingStrategy.suggestionsArray=[{lang:'en',list:[TERRESTRIAL_POLLING_STRATEGY]}];terrestrialPollingStrategy.onMatching=function(botState){return(botState.messageFromUser===TERRESTRIAL_POLLING_STRATEGY||botState.getNlpResultsForId(NLPId).action==='TerrestrialMode')&&botState.client===State.MOBILECLIENT();};terrestrialPollingStrategy.onResolution=function _callee47(botState){return regeneratorRuntime.async(function _callee47$(_context47){while(1){switch(_context47.prev=_context47.next){case 0:return _context47.abrupt('return',botState.setNetworkModeTo('gsm').then(function(){botState.addStringResponse('I will be assuming you are in a terrestrial network all the time. If you are connected over a satellite the screen will turn pink to let you know');}));case 1:case'end':return _context47.stop();}}},null,_this);};terrestrialPollingStrategy.onPrediction=function _callee48(){return regeneratorRuntime.async(function _callee48$(_context48){while(1){switch(_context48.prev=_context48.next){case 0:if(!([selectPollingStrategy.intentId].indexOf(botState.activeIntent)>-1)){_context48.next=2;break;}return _context48.abrupt('return',1);case 2:return _context48.abrupt('return',0);case 3:case'end':return _context48.stop();}}},null,_this);};var satellitePollingStrategy=new Intent('satellitePollingStrategy');satellitePollingStrategy.suggestionsArray=[{lang:'en',list:[SATELLITE_POLLING_STRATEGY]}];satellitePollingStrategy.onMatching=function(botState){return(botState.messageFromUser===SATELLITE_POLLING_STRATEGY||botState.getNlpResultsForId(NLPId).action==='SatelliteMode')&&botState.client===State.MOBILECLIENT();};satellitePollingStrategy.onResolution=function _callee49(botState){return regeneratorRuntime.async(function _callee49$(_context49){while(1){switch(_context49.prev=_context49.next){case 0:return _context49.abrupt('return',botState.setNetworkModeTo('satellite').then(function(){botState.addStringResponse('I will be assuming you are connected over a satellite all the time saving data as much as possible');}));case 1:case'end':return _context49.stop();}}},null,_this);};satellitePollingStrategy.onPrediction=function _callee50(){return regeneratorRuntime.async(function _callee50$(_context50){while(1){switch(_context50.prev=_context50.next){case 0:if(!([selectPollingStrategy.intentId].indexOf(botState.activeIntent)>-1)){_context50.next=2;break;}return _context50.abrupt('return',1);case 2:return _context50.abrupt('return',0);case 3:case'end':return _context50.stop();}}},null,_this);};var manualPollingStrategy=new Intent('manualPollingStrategy');manualPollingStrategy.suggestionsArray=[{lang:'en',list:[MANUAL_POLLING_STRATEGY]}];manualPollingStrategy.onMatching=function(botState){return(botState.messageFromUser===MANUAL_POLLING_STRATEGY||botState.getNlpResultsForId(NLPId).action==='ManualNetworkMode')&&botState.client===State.MOBILECLIENT();};manualPollingStrategy.onResolution=function _callee51(botState){return regeneratorRuntime.async(function _callee51$(_context51){while(1){switch(_context51.prev=_context51.next){case 0:return _context51.abrupt('return',botState.setNetworkModeTo('manual').then(function(){botState.addStringResponse('You are in Manual Network Mode. You are consuming 0KB background data currently. You will need to touch the refresh button to fetch messages.');}));case 1:case'end':return _context51.stop();}}},null,_this);};manualPollingStrategy.onPrediction=function _callee52(){return regeneratorRuntime.async(function _callee52$(_context52){while(1){switch(_context52.prev=_context52.next){case 0:if(!([selectPollingStrategy.intentId].indexOf(botState.activeIntent)>-1)){_context52.next=2;break;}return _context52.abrupt('return',1);case 2:return _context52.abrupt('return',0);case 3:case'end':return _context52.stop();}}},null,_this);};var cancelPollingStrategySelection=new Intent('cancelPollingStrategySelection');cancelPollingStrategySelection.suggestionsArray=[{lang:'en',list:[CANCEL_POLLING_STRATEGY]}];cancelPollingStrategySelection.onMatching=function(botState){return botState.messageFromUser===CANCEL_POLLING_STRATEGY;};cancelPollingStrategySelection.onResolution=function _callee53(botState){return regeneratorRuntime.async(function _callee53$(_context53){while(1){switch(_context53.prev=_context53.next){case 0:botState.addStringResponse('Ok');case 1:case'end':return _context53.stop();}}},null,_this);};cancelPollingStrategySelection.onPrediction=function _callee54(){return regeneratorRuntime.async(function _callee54$(_context54){while(1){switch(_context54.prev=_context54.next){case 0:if(!([selectPollingStrategy.intentId].indexOf(botState.activeIntent)>-1)){_context54.next=2;break;}return _context54.abrupt('return',1);case 2:return _context54.abrupt('return',0);case 3:case'end':return _context54.stop();}}},null,_this);};var myAccount=new Intent('myAccount');myAccount.suggestionsArray=[{lang:'en',list:[MY_ACCOUNT]}];myAccount.onMatching=function(botState){return botState.messageFromUser===MY_ACCOUNT||botState.getNlpResultsForId(NLPId).action==='MyAccount';};myAccount.onResolution=function _callee55(botState){return regeneratorRuntime.async(function _callee55$(_context55){while(1){switch(_context55.prev=_context55.next){case 0:botState.addStringResponse('Select from the suggestions below');case 1:case'end':return _context55.stop();}}},null,_this);};myAccount.onPrediction=function _callee56(){var lastLogin,formId;return regeneratorRuntime.async(function _callee56$(_context56){while(1){switch(_context56.prev=_context56.next){case 0:lastLogin=botState.getField(LAST_LOGIN);formId=botState.getField(CHANGE_PASSWORD_FORM)||'';if(!(R.append(formId,suggestionsArrayForPredictions()).indexOf(botState.activeIntent)>-1&&lastLogin)){_context56.next=4;break;}return _context56.abrupt('return',1);case 4:return _context56.abrupt('return',0);case 5:case'end':return _context56.stop();}}},null,_this);};var cancelMyAccount=new Intent('cancelMyAccount');cancelMyAccount.suggestionsArray=[{lang:'en',list:[CANCEL_MY_ACCOUNT]}];cancelMyAccount.onMatching=function(botState){return botState.messageFromUser===CANCEL_MY_ACCOUNT;};cancelMyAccount.onResolution=function _callee57(botState){var formId,form;return regeneratorRuntime.async(function _callee57$(_context57){while(1){switch(_context57.prev=_context57.next){case 0:formId=botState.getField(CHANGE_PASSWORD_FORM);form=botState.getForm(formId);if(form.isOpen){form.cancelForm();}botState.addStringResponse('Ok');case 4:case'end':return _context57.stop();}}},null,_this);};cancelMyAccount.onPrediction=function _callee58(){return regeneratorRuntime.async(function _callee58$(_context58){while(1){switch(_context58.prev=_context58.next){case 0:if(!([myAccount.intentId,changePassword.intentId].indexOf(botState.activeIntent)>-1&&botState.client===State.MOBILECLIENT())){_context58.next=2;break;}return _context58.abrupt('return',1);case 2:return _context58.abrupt('return',0);case 3:case'end':return _context58.stop();}}},null,_this);};var changePassword=new Intent('changePassword');changePassword.suggestionsArray=[{lang:'en',list:[CHANGE_PASSWORD]}];changePassword.onMatching=function(botState){return botState.messageFromUser===CHANGE_PASSWORD||botState.getNlpResultsForId(NLPId).action==='ChangePassword';};changePassword.onResolution=function _callee59(botState){var provider,formId,form;return regeneratorRuntime.async(function _callee59$(_context59){while(1){switch(_context59.prev=_context59.next){case 0:provider='';if(botState.client===State.MOBILECLIENT()){provider=_.trim(botState.user.provider.name);}if(provider!=='google'&&provider!=='facebook'){if(botState.client===State.MOBILECLIENT()){formId=botState.getField(CHANGE_PASSWORD_FORM);form=botState.getForm(formId);form.clearAllFields();botState.addResponse('form2',form);}else{botState.addStringResponse('You can change your password from your profile screen that can be reached at the top right of the page');}}else{botState.addStringResponse('You have used '+provider+' to register in FrontM, if you wish to change your password you need to do it there');}case 3:case'end':return _context59.stop();}}},null,_this);};changePassword.onPrediction=function _callee60(){var provider;return regeneratorRuntime.async(function _callee60$(_context60){while(1){switch(_context60.prev=_context60.next){case 0:provider='';if(botState.client===State.MOBILECLIENT()){provider=_.trim(botState.user.provider.name);}if(!(provider!=='google'&&[myAccount.intentId].indexOf(botState.activeIntent)>-1)){_context60.next=4;break;}return _context60.abrupt('return',1);case 4:return _context60.abrupt('return',0);case 5:case'end':return _context60.stop();}}},null,_this);};var saveNewPassword=new Intent(SAVE_NEW_PASSWORD);saveNewPassword.onMatching=function(botState){return botState.messageTypeFromUser==='object'&&botState.messageFromUser.intentId===SAVE_NEW_PASSWORD;};saveNewPassword.onError=function(){botState.addStringResponse('I could not change your password. Either your old password typed is wrong or the password is not strong enough');};saveNewPassword.onResolution=function _callee61(botState){return regeneratorRuntime.async(function _callee61$(_context61){while(1){switch(_context61.prev=_context61.next){case 0:return _context61.abrupt('return',botState.updatePassword(botState.messageFromUser.oldPassword,botState.messageFromUser.newPassword).then(function(){if(!botState.inError){botState.addStringResponse('Your password have been updated');}}));case 1:case'end':return _context61.stop();}}},null,_this);};var logout=new Intent(LOGOUT);logout.suggestionsArray=[{lang:'en',list:[LOGOUT]}];logout.onMatching=function(botState){return botState.messageTypeFromUser==='string'&&botState.messageFromUser===LOGOUT||botState.messageTypeFromUser==='object'&&botState.messageFromUser.intentId===LOGOUT||botState.getNlpResultsForId(NLPId).action==='logout';};logout.onResolution=function _callee62(botState){return regeneratorRuntime.async(function _callee62$(_context62){while(1){switch(_context62.prev=_context62.next){case 0:if(!(botState.messageTypeFromUser==='string'||botState.getNlpResultsForId(NLPId).action==='logout')){_context62.next=4;break;}if(botState.getField(NOTIFICATION_CHANGES_IN_PROGRESS)===null){botState.setField(PREVIOUS_INTENT,LOGOUT_INTENT);botState.addStringResponse('Are you sure you would like to logout?');}else{botState.addStringResponse('Your notification settings are still being updated. Please try me again in just a moment.');}_context62.next=5;break;case 4:return _context62.abrupt('return',botState.logout());case 5:case'end':return _context62.stop();}}},null,_this);};logout.onPrediction=function _callee63(){return regeneratorRuntime.async(function _callee63$(_context63){while(1){switch(_context63.prev=_context63.next){case 0:if(!([myAccount.intentId].indexOf(botState.activeIntent)>-1)){_context63.next=2;break;}return _context63.abrupt('return',1);case 2:return _context63.abrupt('return',0);case 3:case'end':return _context63.stop();}}},null,_this);};var support=new Intent('support');support.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='support';};support.onResolution=function _callee64(botState){var formId,form;return regeneratorRuntime.async(function _callee64$(_context64){while(1){switch(_context64.prev=_context64.next){case 0:formId=botState.getField(COMPLAINT_FORM);form=botState.getForm(formId);botState.addResponse('form2',form);case 3:case'end':return _context64.stop();}}},null,_this);};var emailSupport=new Intent('emailSupport');emailSupport.runOnCloud();emailSupport.onMatching=function(botState){return botState.messageTypeFromUser==='object'&&botState.messageFromUser.intentId==='emailSupport';};emailSupport.onResolution=function _callee65(botState){var supportId,body,clientBody;return regeneratorRuntime.async(function _callee65$(_context65){while(1){switch(_context65.prev=_context65.next){case 0:supportId=Math.round(Math.random()*(99999999-1)+1);body='Support request; support id: '+supportId+'\n                Title: '+botState.messageFromUser.title+'\n                Description: '+botState.messageFromUser.description+'\n                User Email: '+botState.user.userEmail;clientBody='Thank you for contacting FrontM Platform.\nWe have opened case \u201C'+supportId+'\u201D to address your issue.\nThe details of your case are as follows:\n\nCase ID: '+supportId+'\nSubject: '+botState.messageFromUser.title+'\n\nTo contact us again about this issue, please email us to support@frontm.com with the case ID in your subject.\n\nSincerely,\nThe FrontM Platform Team\n\n*Please note: this e-mail was sent from an address that cannot accept incoming e-mail. Please use support@frontm.com if you need to contact us again about this same issue.\n\nSome of the content and links in this email may have been generated by a FrontM customer. FrontM is not responsible for the contents or links within.';return _context65.abrupt('return',botState.notification.sendEmail('support@frontm.com','Support request from '+botState.user.userEmail,body).then(function(response){return botState.notification.sendEmail(botState.user.userEmail,'Confirmation',clientBody);}).then(function(response){botState.addStringResponse('I have informed our team about your concern, they will contact you soon.');botState.addStringResponse('Your case number is '+supportId);}).catch(function(err){botState.developer.debug('Error while sending mail to support message: '+err);}));case 4:case'end':return _context65.stop();}}},null,_this);};var checkBalance=new Intent('4_balanceCheck');checkBalance.runOnCloud();checkBalance.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='4_balanceCheck';};checkBalance.onResolution=function _callee66(botState){return regeneratorRuntime.async(function _callee66$(_context66){while(1){switch(_context66.prev=_context66.next){case 0:return _context66.abrupt('return',botState.accounts.getBalance('pstn-balance').then(function(responseBalance){var _=botState._;var balance=_.get(responseBalance,'pstn-balance.available',0);botState.addStringResponse('You have US$'+Math.round(balance*100)/100+' in your account');}));case 1:case'end':return _context66.stop();}}},null,_this);};var inviteQuestion=new Intent('inviteQuestion');inviteQuestion.runOnCloud();inviteQuestion.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='inviteQuestion';};inviteQuestion.onResolution=function _callee67(botState){return regeneratorRuntime.async(function _callee67$(_context67){while(1){switch(_context67.prev=_context67.next){case 0:if(botState.client===State.MOBILECLIENT()){botState.addStringResponse('Go back to your timeline, then touch the Contacts tab at the bottom of the screen, then touch the + button at the top right and follow the instructions on screen');}else{botState.addStringResponse('Click "Add Contact" under Contacts on the left menu. Then choose "Send an email invitation to a friend"');}case 1:case'end':return _context67.stop();}}},null,_this);};var InvitationCode=new Intent('InvitationCode');InvitationCode.runOnCloud();InvitationCode.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='InvitationCode';};InvitationCode.onResolution=function _callee68(botState){return regeneratorRuntime.async(function _callee68$(_context68){while(1){switch(_context68.prev=_context68.next){case 0:if(botState.client===State.MOBILECLIENT()){botState.addStringResponse('To activate a new service provider, please touch on the Apps catalogue tab at the bottom of the home screen then touch Providers section at the top and you will find the button to activate a new provider');}else{botState.addStringResponse('Open the drop down at the top left of this page and then click on +');}case 1:case'end':return _context68.stop();}}},null,_this);};var callingRates=new Intent('checkCallingRates');callingRates.onMatching=function(botState){return botState.messageFromUser===smartSuggestionsConstants.CHECKCALLRATES||botState.messageFromUser===smartSuggestionsConstants.CHECKCALLINGRATESOTHER||botState.getNlpResultsForId(NLPId).action==='checkCallingRates';};callingRates.onResolution=function _callee69(botState){return regeneratorRuntime.async(function _callee69$(_context69){while(1){switch(_context69.prev=_context69.next){case 0:botState.addStringResponse('Sure, let me know which destination you want the call rates for?');case 1:case'end':return _context69.stop();}}},null,_this);};var tariffCheck=new Intent('1_tariffCheck');tariffCheck.runOnCloud();tariffCheck.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='1_tariffCheck';};tariffCheck.onResolution=function _callee70(botState){var _,isoCountry;return regeneratorRuntime.async(function _callee70$(_context70){while(1){switch(_context70.prev=_context70.next){case 0:_=botState._;isoCountry=_.get(botState.getNlpResultsForId(NLPId),'nlpParameters.geo-country-code.alpha-2');if(!isoCountry){botState.addErrorToStack(1001,'Sorry, could you confirm the destination country name?');}return _context70.abrupt('return',botState.accounts.getCallRates(isoCountry).then(function(tariffsArray){_.each(tariffsArray,function(tariff){botState.addStringResponse('Calling rates to '+tariff.planName+' is $'+tariff.currentPrice+' per minute');});}));case 4:case'end':return _context70.stop();}}},null,_this);};var tariffCheckSat=new Intent('1_tariffCheckSat');tariffCheckSat.suggestionsArray=[{lang:'en',list:['India','Argentina','France',INMARSAT,IRIDIUM]}];tariffCheckSat.runOnCloud();tariffCheckSat.onMatching=function(){return botState.messageFromUser===INMARSAT||botState.messageFromUser===IRIDIUM||botState.getNlpResultsForId(NLPId).action==='qs_IridiumCallingcosts'||botState.getNlpResultsForId(NLPId).action==='qs_InmarsatCallingCosts';};tariffCheckSat.onResolution=function _callee71(botState){return regeneratorRuntime.async(function _callee71$(_context71){while(1){switch(_context71.prev=_context71.next){case 0:return _context71.abrupt('return',botState.accounts.getCallRates(SAT_PHONE).then(function(tariffsArray){_.each(tariffsArray,function(tariff){var platform='Inmarsat';if(botState.getNlpResultsForId(NLPId).action==='qs_IridiumCallingcosts'){platform='Iridium';}botState.addStringResponse('Calling rate to '+platform+' is $'+tariff.currentPrice+' per minute');});}));case 1:case'end':return _context71.stop();}}},null,_this);};tariffCheckSat.onPrediction=function _callee72(){return regeneratorRuntime.async(function _callee72$(_context72){while(1){switch(_context72.prev=_context72.next){case 0:if(!([callingRates.intentId].indexOf(botState.activeIntent)>-1)){_context72.next=2;break;}return _context72.abrupt('return',1);case 2:return _context72.abrupt('return',0);case 3:case'end':return _context72.stop();}}},null,_this);};var callSatFailed=new Intent('callSatFailed');callSatFailed.runOnCloud();callSatFailed.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='8_CheckCallFailure'&&botState.messageFromUser!==INMARSAT&&botState.messageFromUser!==IRIDIUM;};callSatFailed.onResolution=function _callee73(botState){return regeneratorRuntime.async(function _callee73$(_context73){while(1){switch(_context73.prev=_context73.next){case 0:return _context73.abrupt('return',botState.accounts.getBalance('pstn-balance').then(function(responseBalance){var balance=_.get(responseBalance,'pstn-balance.available',0);if(balance<=0){botState.addStringResponse('Sorry, but you do not have sufficient balance to call Satellite Numbers. Please top up and try again');}else{botState.sendMessage({intentId:'emailSupport',title:'Support Request with Satphone numbers',description:botState.messageFromUser,priority:1});botState.addResponse('silent',{});}}));case 1:case'end':return _context73.stop();}}},null,_this);};var formattedHistory=function formattedHistory(botState,callHistoryArray){var callEntriesArray=[];botState._.each(callHistoryArray,function(callEntry){var newCallForCard={title:'Call data',To:callEntry.callTo,Duration:callEntry.duration+' minutes',Charge:'$'+Math.round(_.get(callEntry,'callCharge',0)*100)/100,Time:new Date(callEntry.callTimestamp).toLocaleString(),Balance:'$'+Math.round(_.get(callEntry,'currentBalance',0)*100)/100};callEntriesArray.push(newCallForCard);});return callEntriesArray;};var recentCalls=new Intent('5_callHistory');recentCalls.runOnCloud();recentCalls.onMatching=function(botState){return botState.messageFromUser===smartSuggestionsConstants.CHECKRECENTCALLS||botState.getNlpResultsForId(NLPId).action==='5_callHistory';};recentCalls.onResolution=function _callee74(botState){var callHistorySize;return regeneratorRuntime.async(function _callee74$(_context74){while(1){switch(_context74.prev=_context74.next){case 0:callHistorySize=botState.getField(CALL_HISTORY_FIELD);return _context74.abrupt('return',botState.accounts.getCallHistory().then(function(callHistoryArray){callHistorySize=_.size(callHistoryArray);botState.setField(CALL_HISTORY_FIELD,callHistorySize);if(callHistorySize>0){if(botState.client===State.WEBCLIENT()){botState.addResponse('table',{options:{title:'Calls History',description:'This table displays the calls you have previously made'},rows:formattedHistory(botState,callHistoryArray)});}else{botState.addResponse('data_card',formattedHistory(botState,callHistoryArray));}}else{botState.addStringResponse("Sorry but you haven't made any calls recently");}}));case 2:case'end':return _context74.stop();}}},null,_this);};var emailUsageHistory=new Intent('6_emailUsageHistory');emailUsageHistory.runOnCloud();emailUsageHistory.onMatching=function(botState){return botState.messageFromUser===smartSuggestionsConstants.EMAILHISTORY||botState.getNlpResultsForId(NLPId).action==='6_emailUsageHistory';};emailUsageHistory.onResolution=function _callee75(botState){return regeneratorRuntime.async(function _callee75$(_context75){while(1){switch(_context75.prev=_context75.next){case 0:return _context75.abrupt('return',botState.accounts.getCallHistory().then(function(callHistoryArray){if(botState._.size(callHistoryArray)>0){var body='Hi '+botState.userName+'!\n\nAttached you can find the call history with the phone numbers you called using FrontM.\n\nFrontM Team';var attachment={name:'FrontMCallHistory.txt',content:formattedHistory(botState,callHistoryArray)};return botState.notification.sendEmail(botState.user.userEmail,'FrontM Call History',body,attachment).then(function(response){botState.addStringResponse('I have sent you the email');});}else{botState.addStringResponse('Sorry but you have not made any calls so far ');}}));case 1:case'end':return _context75.stop();}}},null,_this);};var howToUseFrontM=new Intent('howToUseFrontM');howToUseFrontM.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='howToUseFrontM';};howToUseFrontM.onResolution=function _callee76(){return regeneratorRuntime.async(function _callee76$(_context76){while(1){switch(_context76.prev=_context76.next){case 0:botState.addStringResponse('You can use FrontM to make low cost calls to satellite phones and other numbers. Top up credit to use the dialpad or call numbers you have saved as Contacts. You can also connect with other app users to make free app-to-app calls over the internet');if(botState.client===State.MOBILECLIENT()){botState.addStringResponse('You can also send instant messages to contacts who have accepted your request, join or create channels for group chat, and install other helper applications. You can also use FrontM online at www.frontm.ai');}else{if(botState.user.info.lastLoggedInDomain==='gns'){botState.addStringResponse('You can also download our mobile app from the Apple or Google Play app stores');}else{botState.addStringResponse('You can also sent instant messages to contacts who have accepted your request, join or create channels for group chat, and install other apps');botState.addStringResponse('You can also download our mobile app from the Apple or Google Play app stores');}}case 2:case'end':return _context76.stop();}}},null,_this);};var howToMakeCalls=new Intent('howToMakeCalls');howToMakeCalls.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='howToMakeCalls';};howToMakeCalls.onResolution=function _callee77(){return regeneratorRuntime.async(function _callee77$(_context77){while(1){switch(_context77.prev=_context77.next){case 0:if(botState.client===State.MOBILECLIENT()){botState.addStringResponse('You can enter numbers using the dialpad, or call saved contacts. First, click back, and then click on the phone button');botState.addStringResponse("To dial directly, select the dialpad. You'll need to dial the full international number including the code for the country or Iridium/Inmarsat (e.g. +870)");botState.addStringResponse('To call a contact from your list, click their name and click the phone button next to the number to call');botState.addStringResponse('If you do not have any call credit, you will need to top up by selecting Get Credit first');}else{botState.addStringResponse('You can enter numbers using the dialpad, or call saved contacts. If you do not have any call credit, you will need to top up by selecting Get Credit first');botState.addStringResponse("To dial directly, click on the dialpad above. You'll need to dial the full international number including the code for the country or Iridium/Inmarsat (e.g. +870)");botState.addStringResponse('To call a contact, click their name on the contacts button, and click the phone button next to their name or number');}case 1:case'end':return _context77.stop();}}},null,_this);};var howDoIAddCallCredits=new Intent('howDoIAddCallCredits');howDoIAddCallCredits.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='howDoIAddCallCredits';};howDoIAddCallCredits.onResolution=function _callee78(){return regeneratorRuntime.async(function _callee78$(_context78){while(1){switch(_context78.prev=_context78.next){case 0:if(botState.client===State.MOBILECLIENT()){botState.addStringResponse('You will be prompted to Get Credit when you try to make a call. You can then top up using in-app payments. You can also make card payments using our frontm.ai web app');}else{botState.addStringResponse('Click "Get Credit" above and choose an amount to top up. You will then be able to add payment details to make a card payment');}case 1:case'end':return _context78.stop();}}},null,_this);};var howDoIAddContacts=new Intent('howDoIAddContacts');howDoIAddContacts.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='howDoIAddContacts';};howDoIAddContacts.onResolution=function _callee79(){return regeneratorRuntime.async(function _callee79$(_context79){while(1){switch(_context79.prev=_context79.next){case 0:if(botState.client===State.WEBCLIENT()){if(botState.user.info.lastLoggedInDomain==='gns'){botState.addStringResponse('Click â€œAdd Contactâ€ under â€œContactsâ€ on the left menu. From here, you can create a new contact using their phone number, invite your friends by email or search existing app users to request a direct connection. Install the FrontM mobile app to import your existing mobile contacts');}else{botState.addStringResponse('Click "Add Contact" under "Contacts" on the left menu. From here, you can create a new contact using their phone number, invite your friends by email or search existing app users and request a direct connection to make app-to-app calls or send instant messages. Install the FrontM mobile app to import your existing mobile contacts');}}else{botState.addStringResponse('Go back, and tap "Contacts" at the bottom. From here, you can import your phone book contacts, create a new contact using their phone number, invite your friends by email or search existing app users and request a direct connection to make app-to-app calls or send instant messages');}case 1:case'end':return _context79.stop();}}},null,_this);};var whatIsFrontM=new Intent('whatIsFrontM');whatIsFrontM.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='whatIsFrontM';};whatIsFrontM.onResolution=function _callee80(){return regeneratorRuntime.async(function _callee80$(_context80){while(1){switch(_context80.prev=_context80.next){case 0:if(botState.client===State.WEBCLIENT()&&botState.user.info.lastLoggedInDomain==='gns'){botState.addStringResponse('FrontM app is for communication, collaboration and easy access to information in remote spaces, and low cost calls to satellite phones. Use this app for calling satellite phone numbers and for messaging, voice calling and other interactions from sea, mid air or in remote places');}else{botState.addStringResponse('FrontM app is for low cost calls to satellite phones. Use this app for calling from shore and HQ to ships bridges or other satellite phones');}case 1:case'end':return _context80.stop();}}},null,_this);};var howToAccessApps=new Intent('howToAccessApps');howToAccessApps.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='howToAccessApps';};howToAccessApps.onResolution=function _callee81(){return regeneratorRuntime.async(function _callee81$(_context81){while(1){switch(_context81.prev=_context81.next){case 0:if(botState.client===State.WEBCLIENT()){if(botState.user.info.lastLoggedInDomain==='gns'){botState.addStringResponse('You are already using FrontM assistant! Ask me anything and I will try to help. There are currently no other apps available to use on this workspace');}else{botState.addStringResponse('The FrontM applications are accessed by clicking Apps on the left navigation menu');}}else{botState.addStringResponse('Go back and touch on Apps on the bottom menu');}case 1:case'end':return _context81.stop();}}},null,_this);};var cannotFindApp=new Intent('cannotFindApp');cannotFindApp.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='cannotFindApp';};cannotFindApp.onResolution=function _callee82(){return regeneratorRuntime.async(function _callee82$(_context82){while(1){switch(_context82.prev=_context82.next){case 0:if(botState.client===State.WEBCLIENT()&&botState.user.info.lastLoggedInDomain==='gns'){botState.addStringResponse('Only the FrontM Assistant is available on this workspace');}else{botState.addStringResponse("Sorry, you can't find what you are looking for. If you have been invited by a partner, you may need to enter an Access Code. Otherwise, please raise a Customer Feature Request with FrontM below");}case 1:case'end':return _context82.stop();}}},null,_this);};var howToChat=new Intent('howToChat');howToChat.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='howToChat';};howToChat.onResolution=function _callee83(){return regeneratorRuntime.async(function _callee83$(_context83){while(1){switch(_context83.prev=_context83.next){case 0:if(botState.client===State.WEBCLIENT()&&botState.user.info.lastLoggedInDomain==='gns'){botState.addStringResponse('Chats are disabled in this workspace');}else{botState.addStringResponse('If the contact is a FrontM user and they have authorised your connection request, you will be able to chat with them by clicking on them in your Contacts list, and then clicking the chat icon next to their name. You can also start or join Channels for group chat.');}case 1:case'end':return _context83.stop();}}},null,_this);};var dunno=new Intent('dunno');dunno.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='dunno';};dunno.onResolution=function _callee84(){return regeneratorRuntime.async(function _callee84$(_context84){while(1){switch(_context84.prev=_context84.next){case 0:botState.addStringResponse("I am sorry to hear that. I am here to help you as far as I can, with your enquiries. If I can't, you always have the option of requesting help from our Support team.");if(botState.client===State.WEBCLIENT()&&botState.user.info.lastLoggedInDomain==='gns'){botState.addEnglishSmartSuggestions(['Raise a Support Request','What is this app for','How to make phone calls']);}else{botState.addEnglishSmartSuggestions(['Raise a Support Request','What is this app for','How to make phone calls','How to chat']);}case 2:case'end':return _context84.stop();}}},null,_this);};if(botState.client===State.MOBILECLIENT()){return[main,inviteQuestion,InvitationCode,callingRates,tariffCheck,tariffCheckSat,callSatFailed,yes,yesPush,yesLogout,no,noLogout,noPush,noBackend,validationCode,cancelValidationProcess,edgeValidationProcess,selectPollingStrategy,automaticPollingStrategy,terrestrialPollingStrategy,satellitePollingStrategy,manualPollingStrategy,cancelPollingStrategySelection,deActivatePushNotifications,deregisterPushOnBackend,myAccount,cancelMyAccount,changePassword,logout,saveNewPassword,support,emailSupport,autoInstallInitialBots,allQuestions,testVideo,checkBalance,recentCalls,emailUsageHistory,howToMakeCalls,howToUseFrontM,howDoIAddCallCredits,howDoIAddContacts,whatIsFrontM,howToAccessApps,cannotFindApp,howToChat,dunno];}else{return[main,inviteQuestion,InvitationCode,callSatFailed,callingRates,tariffCheck,tariffCheckSat,yesBackend,changePassword,noBackend,validationCode,cancelValidationProcess,edgeValidationProcess,cancelMyAccount,support,emailSupport,autoInstallInitialBots,allQuestions,testVideo,checkBalance,recentCalls,emailUsageHistory,howToMakeCalls,howToUseFrontM,howDoIAddCallCredits,howDoIAddContacts,whatIsFrontM,howToAccessApps,cannotFindApp,howToChat,dunno];}};var NLP=function(){_createClass(NLP,null,[{key:'DIALOGFLOW',value:function DIALOGFLOW(){return'dialogflow';}},{key:'LEX',value:function LEX(){return'lex';}}]);function NLP(botState){_classCallCheck(this,NLP);this['_botState']=botState;this._nlpEngine=NLP.DIALOGFLOW();this._nlpIds=[];this._nlpAlias='';}_createClass(NLP,[{key:'addNlp',value:function addNlp(nlpId){this._nlpIds.push(nlpId);}},{key:'nlpEngine',set:function set(nlpEngine){this._nlpEngine=nlpEngine;},get:function get(){return this._nlpEngine;}},{key:'nlpIds',get:function get(){return this._nlpIds;}},{key:'nlpAlias',get:function get(){return this._nlpAlias;},set:function set(nlpAlias){this._nlpAlias=nlpAlias;}}]);return NLP;}();var Intent=function(){_createClass(Intent,null,[{key:'EDGE',value:function EDGE(){return'Edge';}},{key:'CLOUD',value:function CLOUD(){return'Cloud';}},{key:'NO_INTENT',value:function NO_INTENT(){return'input.unknown';}},{key:'SPEECH',value:function SPEECH(){return'speech';}},{key:'LOCATION',value:function LOCATION(){return'__location_';}},{key:'CONTACT',value:function CONTACT(){return'__contact_';}},{key:'IMAGE',value:function IMAGE(){return'__image_';}},{key:'VIDEO',value:function VIDEO(){return'__video_';}},{key:'FILE',value:function FILE(){return'__file_';}}]);function Intent(intentId){_classCallCheck(this,Intent);this['_intentId']=intentId;this['_runLocation']=Intent.EDGE();this['_nlpId']='';this['_smartSuggestions']=[];this['_botFlow']='';this['_botFlowStartIntent']=false;this['_dependencies']=[];this['_logHistory']=true;this['_silentIntent']=false;}_createClass(Intent,[{key:'runOnCloud',value:function runOnCloud(){this._runLocation=Intent.CLOUD();}},{key:'runOnEdge',value:function runOnEdge(){this._runLocation=Intent.EDGE();}},{key:'disableHistoryLogging',value:function disableHistoryLogging(){this._logHistory=false;}},{key:'silenceIntent',value:function silenceIntent(){this._silentIntent=true;}},{key:'setEnglishSmartSuggestions',value:function setEnglishSmartSuggestions(suggestions){this._smartSuggestions=[{lang:'en',list:suggestions.reverse()}];}},{key:'setEnglishSmartSuggestionsWithCondition',value:function setEnglishSmartSuggestionsWithCondition(defaultSuggestions,newSuggestions,conditionBlock){if(Array.isArray(newSuggestions)&&Array.isArray(defaultSuggestions)){if(conditionBlock()){this._smartSuggestions=[{lang:'en',list:newSuggestions.reverse()}];}else{this._smartSuggestions=[{lang:'en',list:defaultSuggestions.reverse()}];}}else{this._smartSuggestions=[{lang:'en',list:['Invalid smart suggestion type. Must be array']}];}}},{key:'setSmartSuggestions',value:function setSmartSuggestions(lang,suggestions){this._smartSuggestions=[{lang:lang,list:suggestions}];}},{key:'matchSuggestions',value:function matchSuggestions(message){if(typeof message==='string'){console.log(message);console.log(JSON.stringify(this._smartSuggestions));var findSuggestion=function findSuggestion(suggestion){var list=suggestion.list;return list.includes(message);};console.log(JSON.stringify(this._smartSuggestions.find(findSuggestion)));return!!this._smartSuggestions.find(findSuggestion);}return false;}},{key:'silentIntent',get:function get(){return this._silentIntent;}},{key:'logHistory',get:function get(){return this._logHistory;}},{key:'runLocation',get:function get(){return this._runLocation;}},{key:'onValidation',get:function get(){return this._onValidation;},set:function set(onValidationBlock){this._onValidation=onValidationBlock;}},{key:'onError',get:function get(){return this._onError;},set:function set(onErrorBlock){this._onError=onErrorBlock;}},{key:'intentId',get:function get(){return this._intentId;}},{key:'nlpId',set:function set(nlpId){this._nlpId=nlpId;},get:function get(){return this._nlpId;}},{key:'suggestionsArray',get:function get(){return this._smartSuggestions;},set:function set(suggestions){this._smartSuggestions=suggestions;}},{key:'onMatching',get:function get(){return this._onMatching;},set:function set(matcher){this._onMatching=matcher;}},{key:'onResolution',get:function get(){return this['_onResolution'];},set:function set(resolver){this['_onResolution']=resolver;}}]);return Intent;}();var LocationServices=function(){_createClass(LocationServices,null,[{key:'START_TRACKING',value:function START_TRACKING(){return'startTracking';}},{key:'STOP_TRACKING',value:function STOP_TRACKING(){return'stopTracking';}},{key:'VESSEL',value:function VESSEL(){return'vessel';}},{key:'FLIGHT',value:function FLIGHT(){return'flight';}},{key:'TRACKER_BOT',value:function TRACKER_BOT(){return'tracker-bot';}}]);function LocationServices(botState){_classCallCheck(this,LocationServices);this._botState=botState;this._=botState._;if(this._botState.client===State.MOBILECLIENT()&&this._botState.location===Intent.EDGE()){this.offlineMaps=this._botState.context.getCapability('OfflineMap');}}_createClass(LocationServices,[{key:'getDeviceLocation',value:function getDeviceLocation(){return this._botState.context.getCapability('DeviceLocation').getDeviceLocation();}},{key:'startLocationTracking',value:function startLocationTracking(){return this._botState.context.getCapability('LocationTracker').start_tracking({botId:this._botState.context.botManifest.botId,conversationId:this._botState.conversationId});}},{key:'stopLocationTracking',value:function stopLocationTracking(){return this._botState.context.getCapability('LocationTracker').stop_tracking({botId:this._botState.context.botManifest.botId,conversationId:this._botState.conversationId});}},{key:'progessListener',value:function progessListener(){}},{key:'errorListener',value:function errorListener(){}},{key:'saveMap',value:function saveMap(name,neBound,swBound){var minZoom=arguments.length>3&&arguments[3]!==undefined?arguments[3]:12;var maxZoom=arguments.length>4&&arguments[4]!==undefined?arguments[4]:16;var progressListener=arguments.length>5&&arguments[5]!==undefined?arguments[5]:this.progessListener;var errorListener=arguments.length>6&&arguments[6]!==undefined?arguments[6]:this.errorListener;this._botState._maps.push(name);this.offlineMaps.saveMap(name,neBound,swBound,minZoom,maxZoom,progressListener,errorListener);}},{key:'deleteMap',value:function deleteMap(name){var index=this._botState.R.findIndex(name)(this._botState._maps);this._botState._maps.splice(index,1);this.offlineMaps.deleteMap(name);}},{key:'startTracking',value:function startTracking(assetType,assetDetails,schedule,intentId){var trackingSessionId,messageToTracker;return regeneratorRuntime.async(function startTracking$(_context85){while(1){switch(_context85.prev=_context85.next){case 0:trackingSessionId=this._botState.getUniqueId();messageToTracker={intentId:LocationServices.START_TRACKING(),jobId:trackingSessionId,assetType:assetType,assetDetails:assetDetails};if(schedule){messageToTracker.repeats=schedule;}if(intentId){messageToTracker.respondsTo={userId:this._botState.user.userId,botId:this._botState.conversation.bot,userDomain:this._botState.conversation.userDomain,intentId:intentId};}_context85.next=6;return regeneratorRuntime.awrap(this._botState.notification.sendBroadcastNotificationToBot(LocationServices.TRACKER_BOT(),this._botState.conversation.userDomain,MessageTypes.BOT_TO_BOT(),messageToTracker));case 6:return _context85.abrupt('return',trackingSessionId);case 7:case'end':return _context85.stop();}}},null,this);}},{key:'startTrackingVessel',value:function startTrackingVessel(assetDetails,schedule,intentId){return this.startTracking(LocationServices.VESSEL(),assetDetails,schedule,intentId);}},{key:'startTrackingFlight',value:function startTrackingFlight(assetDetails,schedule,intentId){return this.startTracking(LocationServices.FLIGHT(),assetDetails,schedule,intentId);}},{key:'stopTracking',value:function stopTracking(trackingSessionId){}},{key:'getLatestKnownLocation',value:function getLatestKnownLocation(asset,trackingSessionId){var params={capability:'AssetTrackerCapability',capabilityFileName:'assetTrackerCapability',action:'getLatestAssetLocation',assetId:asset,sessionId:trackingSessionId,userId:this._botState.user.userId,conversation:this._botState.conversation};return this._botState.callCapability(params);}},{key:'getLocation',value:function getLocation(asset,trackingSessionId,from,to){var params={capability:'AssetTrackerCapability',capabilityFileName:'assetTrackerCapability',action:'getAssetLocationForDuration',assetId:asset,sessionId:trackingSessionId,from:from,to:to,userId:this._botState.user.userId,conversation:this._botState.conversation};return this._botState.callCapability(params);}},{key:'storeNewLocation',value:function storeNewLocation(trackingSessionId,assetId,assetDetails){var params={capability:'AssetTrackerCapability',capabilityFileName:'assetTrackerCapability',action:'addNewLocation',assetId:assetId,sessionId:trackingSessionId,details:assetDetails,userId:this._botState.user.userId,conversation:this._botState.conversation};return this._botState.callCapability(params);}}]);return LocationServices;}();var TrackingServices=function(){function TrackingServices(botState){_classCallCheck(this,TrackingServices);this._botState=botState;this._=botState._;}_createClass(TrackingServices,[{key:'startTracking',value:function startTracking(){return this._botState.context.getCapability('LocationTracker').start_tracking({botId:this._botState.context.botManifest.botId,conversationId:this._botState.conversationId});}},{key:'stopTracking',value:function stopTracking(){return this._botState.context.getCapability('LocationTracker').stop_tracking({botId:this._botState.context.botManifest.botId,conversationId:this._botState.conversationId});}}]);return TrackingServices;}();var LogEntrytype=function(){function LogEntrytype(){_classCallCheck(this,LogEntrytype);}_createClass(LogEntrytype,null,[{key:'SYSTEM_ERROR',value:function SYSTEM_ERROR(){return'System Error';}},{key:'USER_ERROR',value:function USER_ERROR(){return'User Error';}},{key:'WARNING',value:function WARNING(){return'Warning';}},{key:'INFO',value:function INFO(){return'Info';}},{key:'DEBUG',value:function DEBUG(){return'Debug';}}]);return LogEntrytype;}();var SearchBox=function(){function SearchBox(botState,theId,name,selectionType){_classCallCheck(this,SearchBox);this['_botState']=botState;this['_']=botState._;this['_id']=theId;this['name']=name;this['selectionType']=selectionType;}_createClass(SearchBox,[{key:'getMessageWith',value:function getMessageWith(action,results){if(results){return{action:action,results:results,selectionType:this.selectionType};}else{return{action:'open',placeholder:this.name,selectionType:this.selectionType};}}},{key:'id',get:function get(){return this._id;}},{key:'onSearch',set:function set(onSearchBlock){this._onSearch=onSearchBlock;},get:function get(){return this._onSearch;}},{key:'onCompletion',set:function set(onCompletionBlock){this._onCompletion=onCompletionBlock;},get:function get(){return this._onCompletion;}},{key:'onCancel',set:function set(onCancelBlock){this._onCancel=onCancelBlock;},get:function get(){return this._onCancel;}}]);return SearchBox;}();var Marketplace=function(){function Marketplace(botState){_classCallCheck(this,Marketplace);this['_botState']=botState;this['_']=botState._;}_createClass(Marketplace,[{key:'validateActivationCode',value:function validateActivationCode(code){var _this2=this;var params={capability:'SubscribeDomainRole',capabilityFileName:'subscribeDomainRole',verificationCode:code,sync:true,userId:this._botState.user.userId,conversation:this._botState.conversation};var capabilities=this._botState.context.capabilities;var capFileName=params.capabilityFileName;var capabilityModule=capabilities[capFileName];if(capabilityModule){console.log('Executing the capability module');return capabilityModule.execute(params,this._botState.context).then(function(response){_this2._botState.developer.debug(JSON.stringify(response));return _this2._botState._.compact(response);});}else{return callLambda('CapabilityExecutorLambda',params,this._botState.context.aws).then(function(response){var payload=JSON.parse(response.Payload);return _this2._botState._.compact(payload);});}}},{key:'activateDomainsOnEdge',value:function activateDomainsOnEdge(domains){return this._botState.context.getCapability('authContext').setDomains(domains,this._botState.context);}},{key:'autoInstallAllBotsOnEdge',value:function autoInstallAllBotsOnEdge(){return this._botState.context.getCapability('RemoteBotInstall').syncronizeBots();}}]);return Marketplace;}();var Developer=function(){_createClass(Developer,null,[{key:'DEV',value:function DEV(){return'Dev';}},{key:'PROD',value:function PROD(){return'Prod';}},{key:'TEST',value:function TEST(){return'Test';}}]);function Developer(botState){_classCallCheck(this,Developer);this['_botState']=botState;this['_']=botState._;this['R']=botState.R;this['_debugMode']=false;this['_command']=[];this['_runMode']=Developer.DEV();}_createClass(Developer,[{key:'callBotPublisher',value:function callBotPublisher(newBot,action){var _this3=this;var params={action:action,conversation:this._botState.conversation,botMetadata:newBot,userId:this._botState.user.userId};return callLambda('BotPublisher',params,this._botState.context.aws).then(function(response){var payload=JSON.parse(response.Payload);if(payload.error!==0){if(payload.error===9){_this3._botState.addSystemErrorToStack(9);}else{_this3._botState.addSystemErrorToStack(7,payload.error);}}return payload.error;});}},{key:'publishBot',value:function publishBot(newBot){return this.callBotPublisher(newBot,'publishNewBot');}},{key:'updateBot',value:function updateBot(newBot){return this.callBotPublisher(newBot,'updateBot');}},{key:'deleteBotFromCatalogue',value:function deleteBotFromCatalogue(newBot){return this.callBotPublisher(newBot,'deleteBot');}},{key:'setDebugActive',value:function setDebugActive(){this.debug('Activating debug mode');this._debugMode=true;}},{key:'validDeveloperDomains',value:function validDeveloperDomains(){var _this4=this;var domains=[];if(this._botState.user.info.lastLoggedInDomain==='frontmai'){this._botState._.each(this._botState.userDomains,function(userDomain){var index=_this4._botState._.findIndex(userDomain.roles,function(role){return role='developer';});if(index>-1){domains.push(userDomain.domain);}});}else{domains.push(this._botState.user.info.lastLoggedInDomain);}return domains;}},{key:'isDeveloperIntent',value:function isDeveloperIntent(){if(this._botState.messageTypeFromUser==='string'&&this._botState.messageFromUser.substring(0,2)==='@@'){return true;}return false;}},{key:'identifyDeveloperIntent',value:function identifyDeveloperIntent(){if(typeof this._botState.messageFromUser==='string'){var command=this.R.toLower(this._botState.messageFromUser);switch(command){case'@@reset conversation':return'_dev_reset_conversation';case'@@show log':return'_dev_show_log';case'@@clear log':return'_dev_clearLog';case'@@debug on':return'_dev_debug_switch';case'@@debug off':return'_dev_debug_switch';case'@@inspect all':return'_dev_inspect_all';case'@@inspect nlp':return'_dev_inspect_nlp';case'@@show performance':return'_dev_show_performance';case'@@email performance':return'_dev_backend_email_performance';default:if(this.R.includes('@@inspect state',command)){return'_dev_inspect_state';}else if(this.R.includes('@@inspect',command)){return'_dev_inspect';}}}return null;}},{key:'badCommandSyntax',value:function badCommandSyntax(){this._botState.addActiveIntent(Intent.NO_INTENT());}},{key:'log',value:function log(message,entryType){if(this._debugMode){var logEntry={dateTime:this._.now(),entryType:entryType,loggedMessage:message};var rowsToRemove=this._.size(this._botState._log)-39;if(rowsToRemove>0){console.log('Deleting logs');this._botState._log.splice(0,rowsToRemove);}this._botState._log.push(logEntry);}}},{key:'debug',value:function debug(message){console.log('Adding log entry');this.log(message,LogEntrytype.DEBUG());}},{key:'processCommand',value:function processCommand(command){switch(command){case'_dev_reset_conversation':{this.resetConversation();break;}case'_dev_show_log':{this.showLog();break;}case'_dev_clearLog':{this.clearLogCommand();break;}case'_dev_debug_switch':{this.debugSwitch();break;}case'_dev_inspect':{this.inspectField();break;}case'_dev_inspect_all':{this.inspectAllFields();break;}case'_dev_show_performance':{this.showPerformance();break;}case'_dev_inspect_nlp':{this.inspectNLPFields();break;}case'_dev_inspect_state':{this.inspectStateField();break;}case'_dev_backend_email_performance':{return this.emailPerformance();}}}},{key:'inspectField',value:function inspectField(){var fieldName=this.R.head(this.R.drop(1,this.R.split(' ')(this._botState.messageFromUser)));if(fieldName){var fieldContent=this.R.toString(this._.get(this._botState.fields,fieldName));if(fieldContent){this._botState.addStringResponse(fieldContent);return;}}this._botState.addStringResponse('Could not find '+fieldName);}},{key:'inspectAllFields',value:function inspectAllFields(){var fieldContent=this.R.toString(this._botState.fields);this._botState.addStringResponse(fieldContent);}},{key:'inspectNLPFields',value:function inspectNLPFields(){var fieldContent=this.R.toString(this._botState._lastNLPResults);this._botState.addStringResponse(fieldContent);}},{key:'inspectStateField',value:function inspectStateField(){var fieldName=this.R.head(this.R.drop(2,this.R.split(' ')(this._botState.messageFromUser)));if(fieldName){var fieldContent=this.R.toString(this._.get(this._botState,fieldName));if(fieldContent){this._botState.addStringResponse(fieldContent);return;}}this._botState.addStringResponse('Could not find '+fieldName);}},{key:'debugSwitch',value:function debugSwitch(){this._debugMode=!this._debugMode;if(this._debugMode){this.debug('Debug mode set to active');this._botState.addStringResponse('Debug mode activated');}else{this.debug('Debug mode set to inactive');this._botState.addStringResponse('Debug mode deactivated');}}},{key:'genericShowLogs',value:function genericShowLogs(options,rows){if(this._botState.client===State.WEBCLIENT()){this._botState.addResponse(this._botState.messageTypes.MESSAGE_TYPE_TABLE,{options:options,rows:rows});}else{this._botState.addResponse(this._botState.messageTypes.MESSAGE_TYPE_DATA_CARD,rows);}}},{key:'showLog',value:function showLog(){var _this5=this;var options={title:'Logged data',description:'App log data'};var rows=[];var rowIterator=function rowIterator(logEntry){var row={date:new Date(logEntry.dateTime),type:logEntry.entryType,message:logEntry.loggedMessage};if(_this5._botState.client===State.MOBILECLIENT()){row.title='Log Entry';}rows.push(row);};this.R.forEach(rowIterator,this.R.reverse(this._botState._log));this.genericShowLogs(options,rows);}},{key:'resetConversation',value:function resetConversation(){this._botState._activeIntent='';this._botState.requestIdsArray=[];this._botState._forms=[];this._botState._botFlows=[];this._botState._log=[];this._botState._intentHistory=[];this._botState._intentStats={};this._botState.lastGreetingTime=0;this._botState.errorStack=[];this._botState.fields={};this._botState.waitingCustomCap=0;this._botState.promptAlive='';this._botState._currentSearchBox='';this._botState._intentDurations=[];this._botState._lastNLPResults={};delete this._botState._maps;this._botState.clearSmartSuggestionsArray();this._botState.blockSuggestions=true;this._botState._silentIntent=false;this._botState.addStringResponse('The conversation has been reset');this._botState.sendMessage({intentId:'@@reset'});}},{key:'clearLogCommand',value:function clearLogCommand(){var _this6=this;return new Promise(function(resolve,reject){_this6._botState.addStringResponse('The log has been cleared');_this6._botState._log=[];resolve();});}},{key:'showPerformance',value:function showPerformance(){var _this7=this;console.log('Starting showing performance');var options={title:'Performance report',description:'Performance readings'};var rows=[];var intentIterator=function intentIterator(entry){var row={intent:entry.intent,event:entry.event,statTime:entry.startTime,duration:_this7.R.toString(entry.duration)};rows.push(row);};console.log('Before loop');this.R.forEach(intentIterator,this.R.reverse(this._botState._intentDurations));console.log('After loop '+this.R.toString(rows));this.genericShowLogs(options,rows);}},{key:'emailPerformance',value:function emailPerformance(){var _this8=this;var email='support@frontm.com';var title='Performance report';var body='See attached performance report from '+this._botState.user.userEmail;var attachment={name:'performance.json',content:this._botState._intentDurations};return this._botState.notification.sendEmail(email,title,body,attachment).then(function(){_this8._botState.addStringResponse('The email with the performance report has been sent');});}},{key:'logCurrentEventDurationWithStartTime',value:function logCurrentEventDurationWithStartTime(event,startTime,endTime){try{if(this._debugMode){var activeIntent='noIntentMatchedYet';if(this._botState.activeIntent!==''){activeIntent=this._botState.activeIntent;}var newEventLog={intent:activeIntent,event:event,startTime:startTime,duration:endTime-startTime};this._botState._intentDurations.push(newEventLog);}}catch(error){return;}}},{key:'addTestCase',value:function addTestCase(){}},{key:'runMode',get:function get(){return this._runMode;},set:function set(runMode){this._runMode=runMode;}}]);return Developer;}();var Notification=function(){function Notification(botState){_classCallCheck(this,Notification);this['_botState']=botState;this['_']=botState._;if(this._botState.client===State.MOBILECLIENT()){this['notification']=this._botState.context.getCapability('Notification');}}_createClass(Notification,[{key:'sendEmail',value:function sendEmail(to,title,body,attachment){var params={capability:'SendEmailCustomCapability',capabilityFileName:'email',address:to,body:body,title:title,sync:true,userId:this._botState.user.userId,conversation:this._botState.conversation};if(attachment){params.attachments=[{fileContentName:attachment.name,jsonContent:attachment.content}];}var capabilities=this._botState.context.capabilities;var capFileName=params.capabilityFileName;var capabilityModule=capabilities[capFileName];if(capabilityModule){console.log('Executing the capability module');return capabilityModule.execute(params,this._botState.context);}else{return callLambda('EmailLambda',params,this._botState.context.aws).then(function(response){console.log('Back from email lambda '+JSON.stringify(response));var payload=JSON.parse(response.Payload);return payload;});}}},{key:'inviteUsers',value:function inviteUsers(emailIds){var params={capability:'InviteUsers',capabilityFileName:'userInvitation',emailIds:emailIds,sync:true,userId:this._botState.user.userId,conversation:this._botState.conversation};var capabilities=this._botState.context.capabilities;var capFileName=params.capabilityFileName;var capabilityModule=capabilities[capFileName];if(capabilityModule){console.log('Executing the capability module');return capabilityModule.execute(params,this._botState.context);}else{return callLambda('EmailLambda',params,this._botState.context.aws).then(function(response){console.log('Back from email lambda '+JSON.stringify(response));return JSON.parse(response.Payload);});}}},{key:'isDeviceRegisteredForPush',value:function isDeviceRegisteredForPush(){var _this9=this;return this.notification.deviceInfo().then(function(deviceInfo){if(_this9._botState._.isEmpty(deviceInfo)){return false;}return deviceInfo.isRegistered;});}},{key:'registerDeviceForPushOnEdge',value:function registerDeviceForPushOnEdge(){if(this._botState.client===State.MOBILECLIENT()){this.notification.requestPermission();}}},{key:'deregisterDeviceForPushOnEdge',value:function deregisterDeviceForPushOnEdge(){var _this10=this;if(this._botState.client===State.MOBILECLIENT()){return this.notification.deregister().then(function(notificationDeviceInfo){return notificationDeviceInfo;}).catch(function(error){_this10._botState.addSystemErrorToStack(19,JSON.stringify(error));});}else{this._botState.addSystemErrorToStack(18);}}},{key:'registerDeviceForPushOnBackend',value:function registerDeviceForPushOnBackend(notificationDeviceInfo){try{var conversation=this._botState.conversation;var userId=this._botState.user.userId;var params={capability:'RegisterDevice',capabilityFileName:'deviceRegistration',deviceToken:notificationDeviceInfo.deviceId,deviceType:notificationDeviceInfo.deviceType,sync:true,userId:userId,conversation:conversation};var capabilities=this._botState.context.capabilities;var capFileName=params.capabilityFileName;var capabilityModule=capabilities[capFileName];if(capabilityModule){console.log('Executing the capability module');return capabilityModule.execute(params,this._botState.context);}else{return callLambda('CapabilityExecutorLambda',params,this._botState.context.aws);}}catch(error){this._botState.addSystemErrorToStack(16,error.message);}}},{key:'deregisterDeviceForPushOnBackend',value:function deregisterDeviceForPushOnBackend(notificationDeviceInfo){try{var conversation=this._botState.conversation;var userId=this._botState.user.userId;var params={capability:'DeregisterDevice',capabilityFileName:'deviceRegistration',deviceToken:notificationDeviceInfo.deviceId,deviceType:notificationDeviceInfo.deviceType,sync:true,userId:userId,conversation:conversation};var capabilities=this._botState.context.capabilities;var capFileName=params.capabilityFileName;var capabilityModule=capabilities[capFileName];if(capabilityModule){console.log('Executing the capability module');return capabilityModule.execute(params,this._botState.context);}else{return callLambda('CapabilityExecutorLambda',params,this._botState.context.aws);}}catch(error){this._botState.addSystemErrorToStack(16,error.message);}}},{key:'sendNotification',value:function sendNotification(target,type,message){try{var requestId=this._botState.getUniqueId();var params={target:target,capability:'BroadCastMessageCapability',capabilityFileName:'broadCastMessage',action:'get',bot:this._botState.conversation.bot,userDomain:this._botState.conversation.userDomain,requestUuid:requestId,sync:true,email:this._botState.user.userEmail,conversation:this._botState.conversation,messages:[{content:[message],contentType:type,createdBy:this._botState.user.userId,createdOn:Date.now(),messageId:this._botState.getUniqueId()}]};console.log(this._botState.R.toString(params));var capabilities=this._botState.context.capabilities;var capFileName=params.capabilityFileName;var capabilityModule=capabilities[capFileName];if(capabilityModule){console.log('Executing the capability module');return capabilityModule.execute(params,this._botState.context);}}catch(error){this._botState.addSystemErrorToStack(16,error.message);}}},{key:'sendMessageToUserInBot',value:function sendMessageToUserInBot(type,message,userIds,botId,userDomain){var target={bot:botId||this._botState.conversation.bot,userDomain:userDomain||this._botState.conversation.userDomain,users:userIds};return this.sendNotification(target,type,message);}},{key:'sendBroadcastNotificationToBot',value:function sendBroadcastNotificationToBot(botId,userDomain,type,message){var target={bot:botId||this._botState.conversation.bot,userDomain:userDomain||this._botState.conversation.userDomain};return this.sendNotification(target,type,message);}}]);return Notification;}();var Sites=function(){function Sites(botState){_classCallCheck(this,Sites);this['_botState']=botState;this['context']=botState.context;this['userId']=botState.user.userId;this['conversation']=botState.conversation;this['_']=botState._;}_createClass(Sites,[{key:'callCapLambda',value:function callCapLambda(params){var capabilities=this._botState.context.capabilities;var capFileName=params.capabilityFileName;var capabilityModule=capabilities[capFileName];if(capabilityModule){console.log('Executing the capability module');return capabilityModule.execute(params,this.context);}else{console.log('Old way: ',capFileName);return callLambda('CapabilityExecutorLambda',params,this.context.aws).then(function(response){return JSON.parse(response.Payload);});}}},{key:'getBaseParams',value:function getBaseParams(){return{capability:'SitesCapability',capabilityFileName:'sitesCapability',sync:true,userId:this.userId,conversation:this.conversation};}},{key:'getSites',value:function getSites(){var params=this.getBaseParams();params.action='GetUserSites';return this.callCapLambda(params);}},{key:'searchLocalSites',value:function searchLocalSites(searchTerm,type){var params=this.getBaseParams();params.action='SearchSites';params.searchTerm=searchTerm;params.siteType=type;return this.callCapLambda(params);}},{key:'searchGlobalSites',value:function searchGlobalSites(searchTerm,type){var params=this.getBaseParams();params.action='SearchGlobalSites';params.searchTerm=searchTerm;params.siteType=type;return this.callCapLambda(params);}},{key:'deleteSite',value:function deleteSite(site){var params=this.getBaseParams();params.action='DeleteSite';params.siteId=site.siteId;return this.callCapLambda(params);}},{key:'updateSite',value:function updateSite(site){var params=this.getBaseParams();params.action='UpdateSite';params.site=site;return this.callCapLambda(params);}},{key:'createSites',value:function createSites(sites,type){var params=this.getBaseParams();params.action='CreateSites';params.sites=sites;params.siteType=type;return this.callCapLambda(params);}}]);return Sites;}();var Contacts=function(){function Contacts(botState){_classCallCheck(this,Contacts);this['_botState']=botState;this['_']=botState._;if(this._botState.client===State.MOBILECLIENT()){this['contactCapability']=this._botState.context.getCapability('Contact');}}_createClass(Contacts,[{key:'refreshContactsOnEdge',value:function refreshContactsOnEdge(){if(this._botState.client===State.MOBILECLIENT()){this.contactCapability.refreshContacts();}else{this._botState.addSystemErrorToStack(18);}}},{key:'getAllContactsFromEdge',value:function getAllContactsFromEdge(){return this.contactCapability.getAddedContacts().then(function(contactIds){return contactIds;});}},{key:'getAllContactsFromBackend',value:function getAllContactsFromBackend(){var params={capability:'GetContacts',capabilityFileName:'contactsListCapability',userDomain:this._botState.conversation.userDomain,sync:true,userId:this._botState.user.userId,conversation:this._botState.conversation};var capabilities=this._botState.context.capabilities;var capFileName=params.capabilityFileName;var capabilityModule=capabilities[capFileName];if(capabilityModule){console.log('Executing the capability module');return capabilityModule.execute(params,this._botState.context);}}}]);return Contacts;}();var DB=function(){function DB(botState){_classCallCheck(this,DB);this['_botState']=botState;this['_']=botState._;}_createClass(DB,[{key:'getCatalogue',value:function getCatalogue(query){var _this11=this;var params={query:query,isAllBotsRequest:true,email:this._botState.user.userEmail};return callLambda('catalogueLambda',params,this._botState.context.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this11._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:'getData',value:function getData(table,query,scan,pagination,sort){var _this12=this;var params={collection:table,query:query,scan:scan,capability:'GetData',pagination:pagination,sort:sort,sync:true};return callLambda('SystemCapabilities',params,this._botState.context.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this12._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:'getDataFromIndex',value:function getDataFromIndex(index,queryString,pageSize,sort,exactMatch){var _this13=this;var params={method:'GET',action:'search',index:this._botState._.toLower(index),q:queryString,size:pageSize,sort:sort,exact:exactMatch};return callLambda('elastiSearch',params,this._botState.context.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this13._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:'deleteDataFromIndex',value:function deleteDataFromIndex(index,type,objectId){var _this14=this;var params={method:'DELETE',index:this._botState._.toLower(index),q:objectId,type:type};return callLambda('elastiSearch',params,this._botState.context.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this14._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:'getDataFromIndexWithQueryObject',value:function getDataFromIndexWithQueryObject(index,queryObject){var _this15=this;var params={method:'GET',action:'bodySearch',index:this._botState._.toLower(index),q:queryObject};return callLambda('elastiSearch',params,this._botState.context.aws).then(function(response){console.log(JSON.stringify(response));return JSON.parse(response.Payload);}).catch(function(error){console.log(JSON.stringify(response));_this15._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:'countDataInIndex',value:function countDataInIndex(index,queryString){var _this16=this;var params={method:'GET',action:'count',index:this._botState._.toLower(index),q:queryString};return callLambda('elastiSearch',params,this._botState.context.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this16._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:'writeDataIntoIndex',value:function writeDataIntoIndex(index,docType,doc){var _this17=this;var params={method:'POST',action:'insert',index:this._botState._.toLower(index),docType:docType,doc:doc};return callLambda('elastiSearch',params,this._botState.context.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this17._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:'updateDataInIndex',value:function updateDataInIndex(index,docType,doc){var _this18=this;var params={method:'PUT',docType:docType,index:this._botState._.toLower(index),doc:doc,id:doc.id};return callLambda('elastiSearch',params,this._botState.context.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this18._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:'writeData',value:function writeData(table,documents){var _this19=this;var params={collection:table,documents:documents,capability:'WriteData'};return callLambda('SystemCapabilities',params,this._botState.context.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this19._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:'deleteData',value:function deleteData(table,query){var _this20=this;var params={collection:table,query:query,capability:'DeleteData'};return callLambda('SystemCapabilities',params,this._botState.context.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this20._botState.addSystemErrorToStack(7,error.errorMessage);});}}]);return DB;}();var API=function(){function API(botState){_classCallCheck(this,API);this['_botState']=botState;this['_']=botState._;}_createClass(API,[{key:'callService',value:function callService(service,options){var _this21=this;console.log('*************** Inside call service');var params={capability:'GetDataFromAPI',capabilityFileName:'getDataFromApi',userDomain:this._botState.conversation.userDomain,serviceName:service,queryParams:this._.get(options,'queryParams'),pathParams:this._.get(options,'pathParams'),header:this._.get(options,'header'),body:this._.get(options,'body'),sync:true,userId:this._botState.user.userId,conversation:this._botState.conversation};var capabilities=this._botState.context.capabilities;var capFileName=params.capabilityFileName;var capabilityModule=capabilities[capFileName];if(capabilityModule){console.log('Executing the capability module');return capabilityModule.execute(params,this._botState.context).then(function(response){console.log('Answer from callDataFromAPI: '+response);_this21._botState.developer.debug(response);if(_this21._.get(response,'error')){_this21._botState.addSystemErrorToStack(7,response.error);}return response;});}else{return callLambda('GetDataFromApi',params,this._botState.context.aws).then(function(response){var payload=JSON.parse(response.Payload);console.log('Answer from callDataFromAPI: '+JSON.stringify(payload));_this21._botState.developer.debug(JSON.stringify(payload));if(_this21._.get(payload,'error')){_this21._botState.addSystemErrorToStack(7,payload.error);}return payload;});}}}]);return API;}();var JobScheduler=function(){function JobScheduler(botState){_classCallCheck(this,JobScheduler);this['_botState']=botState;this['_']=botState._;}_createClass(JobScheduler,[{key:'addNewJob',value:function addNewJob(client,params,jobId,repeats){var scheduleJobParams={jobId:jobId,capability:'ScheduleBatchJob',conversation:this._botState.conversation,params:this._botState.cleanFieldsForSave(params),repeats:repeats,requestUuid:this._botState.getUniqueId(),scheduledCapability:this._botState.conversation.bot+'_CustomCap',userEmail:this._botState.user.userEmail,userId:this._botState.user.userId,userDomain:this._botState.conversation.userDomain,botId:this._botState.conversation.bot,client:client,schedule:this._.get(params,'schedule')};console.log(scheduleJobParams);return callLambda('SystemCapabilities',scheduleJobParams,this._botState.context.aws).then(function(response){return JSON.parse(response.Payload);});}},{key:'deleteJob',value:function deleteJob(jobId){var scheduleJobParams={jobId:jobId,capability:'DeleteBatchJob'};console.log(scheduleJobParams);return callLambda('SystemCapabilities',scheduleJobParams,this._botState.context.aws);}},{key:'scheduleLocalJob',value:function scheduleLocalJob(jobId,interval){var bgTaskOptions={key:jobId,botId:this._botState.context.botManifest.botId,timeInterval:interval,conversationId:this._botState.conversationId};var backgroundTaskQueue=this._botState.context.getCapability('BackgroundTaskQueue');return backgroundTaskQueue.enqueue(bgTaskOptions);}},{key:'stopLocalJob',value:function stopLocalJob(jobId){var backgroundTaskQueue=this._botState.context.getCapability('BackgroundTaskQueue');var bgTaskOptions={key:jobId,botId:this._botState.context.botManifest.botId,conversationId:this._botState.conversationId};return backgroundTaskQueue.dequeue(bgTaskOptions);}}]);return JobScheduler;}();var BotFlow=function(){function BotFlow(botState,name,botFlowFromStorage){_classCallCheck(this,BotFlow);this['_botState']=botState;this['_']=botState._;this['_changed']=false;this['_events']=[];if(!botFlowFromStorage){this['_name']=name;this['_started']=false;this['_entities']=[];this['_steps']=[];this['_currentStep']=0;}else{this['_name']=botFlowFromStorage._name;this['_started']=botFlowFromStorage._started;var allEntitiesFromStorage=[];this._.forEach(botFlowFromStorage._entities,function(entity){var theNewEntity=new BotFlowEntity(botState,entity.name,entity);allEntitiesFromStorage.push(theNewEntity);});this['_entities']=allEntitiesFromStorage;this['_steps']=botFlowFromStorage._steps;this['_currentStep']=botFlowFromStorage._currentStep;}this._onStart=function(){};this._onEnd=function(){};}_createClass(BotFlow,[{key:'getAllProperties',value:function getAllProperties(){var entitiesArray=[];this._.forEach(this._entities,function(entity){entitiesArray.push(entity.getAllFields());});return{_name:this._name,_started:this._started,_entities:entitiesArray,_steps:this._steps,_currentStep:this._currentStep};}},{key:'setBotFlowChanged',value:function setBotFlowChanged(){this._changed=true;}},{key:'start',value:function start(){if(!this._started){this._changed=true;this._currentStep=0;this._started=true;this._onStart(this);if(this._botState.developer._debugMode){this._botState.developer.debug('Starting botFlow '+this._name);}}}},{key:'reset',value:function reset(){var _this22=this;if(this._started){this._changed=true;this._.each(this._steps,function(step){_this22._.each(step,function(intent){intent.done=false;});});this._entities=[];if(this._botState.developer._debugMode){this._botState.developer.debug('Ending botFlow '+this._name);}this._started=false;}}},{key:'end',value:function end(){if(this._started){this._changed=true;this.reset();this._onEnd(this);}}},{key:'getCurrentStep',value:function getCurrentStep(){return this._steps[this._currentStep];}},{key:'getFirstStep',value:function getFirstStep(){return this._steps[0];}},{key:'addStep',value:function addStep(intentsArray,events){var intentsStepArray=[];this._.each(intentsArray,function(intent){var intentsStep={intentId:intent.intentId,done:false};intentsStepArray.push(intentsStep);});var theEvents=events;if(!events){theEvents={};}this._events.push(theEvents);this._steps.push(intentsStepArray);}},{key:'markCurrentStepAsCompleted',value:function markCurrentStepAsCompleted(){this._changed=true;this._.each(this.getCurrentStep(),function(intent){intent.done=true;});if(this._currentStep<this._.size(this._steps)-1){this._currentStep++;}else{this.end();}}},{key:'goToStep',value:function goToStep(stepNumber){if(stepNumber<this._botState._.size(this._steps)&&stepNumber>this._currentStep){while(this._currentStep<stepNumber){this.markCurrentStepAsCompleted();}}}},{key:'markIntentResolved',value:function markIntentResolved(intentId){if(this.isStarted){this._changed=true;var step=this._steps[this._currentStep];var intentIndex=this._.findIndex(step,function(intentStep){return intentStep.intentId===intentId;});if(intentIndex>-1){var intentStep=step[intentIndex];intentStep.done=true;var stepCompleted=true;this._.forEach(step,function(intentStep){if(!intentStep.done){stepCompleted=false;}});if(stepCompleted){if(this._currentStep<this._.size(this._steps)-1){this._currentStep+=1;}else{this.end();}}}}}},{key:'getEntity',value:function getEntity(entityName){var i=this._.findIndex(this._entities,function(entity){return entity.name===entityName;});return this._entities[i]||null;}},{key:'addEntity',value:function addEntity(entity){this._entities.push(entity);}},{key:'name',get:function get(){return this._name;}},{key:'isStarted',get:function get(){return this._started;}},{key:'isChanged',get:function get(){return this._changed;}},{key:'onStart',set:function set(onStartBlock){this._onStart=onStartBlock;}},{key:'onEnd',set:function set(onEndBlock){this['_onEnd']=onEndBlock;}},{key:'currentStepIndex',get:function get(){return this._currentStep;}},{key:'steps',get:function get(){return this._steps;}}]);return BotFlow;}();var BotFlowEntity=function(){_createClass(BotFlowEntity,null,[{key:'LOCKED',value:function LOCKED(){return'Locked';}},{key:'CACHED',value:function CACHED(){return'Cached';}},{key:'IDLE',value:function IDLE(){return'Idle';}}]);function BotFlowEntity(botState,name,entityFromStorage){_classCallCheck(this,BotFlowEntity);this['_linkedForm']='';this['_botState']=botState;this['_promptIndex']=0;this['_']=botState._;this['name']=name;this['state']=BotFlowEntity.IDLE();if(entityFromStorage){this.addFieldsFromObject(entityFromStorage);}}_createClass(BotFlowEntity,[{key:'addFieldsFromObject',value:function addFieldsFromObject(record){for(var field in record){this[field]=record[field];}}},{key:'getAllFields',value:function getAllFields(){var allFields={};for(var field in this){if(field!=='_'&&field!=='_botState'){if(this[field]!==''){allFields[field]=this[field];}}}return allFields;}},{key:'addFieldsFromForm',value:function addFieldsFromForm(record){var _this23=this;this._.each(record.fields,function(field){_this23[field.id]=field.value;});}},{key:'moveToNextPrompt',value:function moveToNextPrompt(){this._promptIndex++;}},{key:'cancelPrompt',value:function cancelPrompt(){this._botState.blockSuggestions=true;this._promptIndex=0;}},{key:'restartPrompt',value:function restartPrompt(){this._promptIndex=0;}},{key:'goToPromptState',value:function goToPromptState(stepNum){this._promptIndex=stepNum;}},{key:'read',value:function read(){}},{key:'readWithLock',value:function readWithLock(){}},{key:'save',value:function save(){}},{key:'delete',value:function _delete(){}},{key:'form',set:function set(form){this._linkedForm=form;},get:function get(){return this._linkedForm;}},{key:'promptIndex',get:function get(){return this._promptIndex;}},{key:'onSave',get:function get(){return this['_onSave'];},set:function set(onSaveBlock){this['_onSave']=onSaveBlock;}},{key:'onDelete',get:function get(){return this['_onDelete'];},set:function set(onSaveBlock){this['_onDelete']=onSaveBlock;}}]);return BotFlowEntity;}();var FormFieldTypes=function(){function FormFieldTypes(){_classCallCheck(this,FormFieldTypes);}_createClass(FormFieldTypes,null,[{key:'TEXT_FIELD',value:function TEXT_FIELD(){return'text_field';}},{key:'NUMBER_FIELD',value:function NUMBER_FIELD(){return'number';}},{key:'TEXT_AREA',value:function TEXT_AREA(){return'text_area';}},{key:'CHECKBOX',value:function CHECKBOX(){return'checkbox';}},{key:'RADIOBUTTON',value:function RADIOBUTTON(){return'radiobutton';}},{key:'DROPDOWN',value:function DROPDOWN(){return'dropdown';}},{key:'SWITCH',value:function SWITCH(){return'switch';}},{key:'SLIDER',value:function SLIDER(){return'slider';}},{key:'DATE',value:function DATE(){return'date';}},{key:'DATETIME',value:function DATETIME(){return'datetime';}},{key:'TIME',value:function TIME(){return'time';}},{key:'MULTI_SELECTION',value:function MULTI_SELECTION(){return'multi_selection';}},{key:'PASSWORD_FIELD',value:function PASSWORD_FIELD(){return'password_field';}},{key:'LOOKUP',value:function LOOKUP(){return'lookup';}}]);return FormFieldTypes;}();var Form=function(){_createClass(Form,null,[{key:'CONFIRM_FORM_ACTION',value:function CONFIRM_FORM_ACTION(){return'confirm';}},{key:'CANCEL_FORM_ACTION',value:function CANCEL_FORM_ACTION(){return'cancel';}},{key:'CLOSE_FORM_ACTION',value:function CLOSE_FORM_ACTION(){return'close';}},{key:'MOVE_FORM_ACTION',value:function MOVE_FORM_ACTION(){return'move';}},{key:'SEARCH_FORM_ACTION',value:function SEARCH_FORM_ACTION(){return'search';}}]);function Form(botState,options,formFromStorage){_classCallCheck(this,Form);this['_botState']=botState;this['_']=botState._;if(!formFromStorage){this['_options']=options||{};this['_fields']=[];this['_open']=false;}else{this['_options']=formFromStorage._options;this['_fields']=formFromStorage._fields||[];this['_open']=formFromStorage._open;}}_createClass(Form,[{key:'getAllProperties',value:function getAllProperties(){return{_options:this._options,_fields:this._fields,_open:this._open};}},{key:'fieldsAsObject',value:function fieldsAsObject(){var fields={};this._.each(this._fields,function(field){fields[field.id]=field.value;});return fields;}},{key:'openForm',value:function openForm(){this._open=true;}},{key:'closeForm',value:function closeForm(){this._open=false;}},{key:'cancelForm',value:function cancelForm(){this._botState.addResponse('form_close',{formId:this._options.formId,action:'close'});}},{key:'getField',value:function getField(fieldId){var index=this._botState._.findIndex(this._fields,function(field){return fieldId===field.id;});if(index>-1){return this._fields[index];}else{return null;}}},{key:'clearAllFields',value:function clearAllFields(){this._botState._.each(this._fields,function(field){delete field.value;});}},{key:'assignValueToField',value:function assignValueToField(fieldId,value){var field=this.getField(fieldId);if(field){field.value=value;}}},{key:'addField',value:function addField(newField){var field=this.getField(newField.id);if(field===null){this._fields.push(newField);}else{field.options=newField.options;field.values=newField.values;}}},{key:'title',set:function set(title){this._options.title=title;}},{key:'description',set:function set(description){this._options.description=description;}},{key:'formId',get:function get(){return this._options.formId;}},{key:'isOpen',get:function get(){return this._open;}},{key:'options',get:function get(){return this._options;},set:function set(options){return this._options=options;}},{key:'fields',get:function get(){return this._fields;},set:function set(fields){this._fields=fields;}},{key:'onSubmit',set:function set(onSubmitBlock){this['_onSubmit']=onSubmitBlock;},get:function get(){return this['_onSubmit'];}},{key:'onCancel',set:function set(onCancelBlock){this['_onCancel']=onCancelBlock;},get:function get(){return this['_onCancel'];}},{key:'onClose',set:function set(onCloseBlock){this['_onClose']=onCloseBlock;},get:function get(){return this['_onClose'];}}]);return Form;}();var Orders=function(){_createClass(Orders,null,[{key:'CURRENT_STRIPE_TRANSACTIONS',value:function CURRENT_STRIPE_TRANSACTIONS(){return'currentStripeTransactions';}}]);function Orders(botState){_classCallCheck(this,Orders);this['_botState']=botState;this['context']=botState.context;this['userId']=botState.user.userId;this['conversation']=botState.conversation;this['location']=botState.location;this._botState.developer.debug('Initialising Orders');if(this._botState.client===State.MOBILECLIENT()&&this.location===Intent.EDGE()){if(this._botState.client===State.MOBILECLIENT()){this._botState.developer.debug('Initialising InAppPurchases');this['inAppPurchaseCap']=this.context.getCapability('InAppPurchase');this['productTypes']=this.inAppPurchaseCap.PRODUCT_NAMES;}else{this['inAppPurchaseCap']='false';this['productTypes']=[];}}}_createClass(Orders,[{key:'createNewStripeTransaction',value:function createNewStripeTransaction(amount,currency,description){var currentTransactions=this._botState.getField(Orders.CURRENT_STRIPE_TRANSACTIONS())||[];var transactionId=this._botState.UUID();currentTransactions.push({transactionId:transactionId,amount:amount,currency:currency,description:description});this._botState.setField(Orders.CURRENT_STRIPE_TRANSACTIONS(),currentTransactions);return transactionId;}},{key:'getStripeTransaction',value:function getStripeTransaction(transactionId){var currentTransactions=this._botState.getField(Orders.CURRENT_STRIPE_TRANSACTIONS())||[];var index=this._botState._.findIndex(currentTransactions,function(transaction){return transaction.transactionId===transactionId;});return index===-1?null:currentTransactions[index];}},{key:'removeStripeTransaction',value:function removeStripeTransaction(transactionId){var currentTransactions=this._botState.getField(Orders.CURRENT_STRIPE_TRANSACTIONS())||[];var index=this._botState._.findIndex(currentTransactions,function(transaction){return transaction.transactionId===transactionId;});this._botState._.pullAt(currentTransactions,[index]);this._botState.setField(Orders.CURRENT_STRIPE_TRANSACTIONS(),currentTransactions);}},{key:'inAppPurchase',value:function inAppPurchase(product){if(this.location===Intent.CLOUD()||this._botState.client===State.WEBCLIENT()){this._botState.addSystemErrorToStack(13);return;}this._botState.developer.debug('About to buy product '+product+' of type '+this.productTypes.VOIP);return this.inAppPurchaseCap.buyProduct({productCode:product,productName:this.productTypes.VOIP});}},{key:'processStripePayment',value:function processStripePayment(){console.log('Before stripe request: '+JSON.stringify(this._botState.messageFromUser));var _botState$messageFrom=this._botState.messageFromUser,transactionId=_botState$messageFrom.transactionId,currency=_botState$messageFrom.currency,amount=_botState$messageFrom.amount,paymentSuccessful=_botState$messageFrom.paymentSuccessful;if(paymentSuccessful){var stateTransaction=this.getStripeTransaction(transactionId);if(stateTransaction===null){return{error:'Invalid transaction id'};}var stateTransactionId=stateTransaction.transactionId,stateCurrency=stateTransaction.currency,stateAmount=stateTransaction.amount;if(stateTransactionId!==transactionId){return{error:'Invalid transaction id'};}if(stateAmount!==amount){return{error:'There is a discrepancy in amounts. Please report to the support team'};}if(stateCurrency!==currency){return{error:'There is a discrepancy in currencies. Please report to the support team'};}this.removeStripeTransaction(transactionId);return{error:0};}else{this.removeStripeTransaction(transactionId);return{error:'Your stripe payment was not successful'};}}}]);return Orders;}();var Accounts=function(){function Accounts(botState){_classCallCheck(this,Accounts);this['_botState']=botState;this['context']=botState.context;this['userId']=botState.user.userId;this['conversation']=botState.conversation;this['location']=botState.location;}_createClass(Accounts,[{key:'getBalance',value:function getBalance(account){var conversation=this.conversation;var userId=this.userId;var params={capability:'MessageQuotaCapability',capabilityFileName:'messageQuotaCapability',action:'getSpecificQuota',sync:true,userId:userId,conversation:conversation,botId:account};var capabilities=this._botState.context.capabilities;var capFileName=params.capabilityFileName;var capabilityModule=capabilities[capFileName];if(capabilityModule){console.log('Executing the capability module');return capabilityModule.execute(params,this._botState.context);}else{console.log('Old way');return callLambda('CapabilityExecutorLambda',params,this.context.aws).then(function(response){return JSON.parse(response.Payload);});}}},{key:'storeBalance',value:function storeBalance(account,balance){var conversation=this.conversation;var userId=this.userId;var params={capability:'MessageQuotaCapability',capabilityFileName:'messageQuotaCapability',action:'incrementUserAssignedQuota',sync:true,userId:userId,conversation:conversation,stats:{}};params.stats[account]=balance;var capabilities=this._botState.context.capabilities;var capFileName=params.capabilityFileName;var capabilityModule=capabilities[capFileName];if(capabilityModule){console.log('Executing the capability module');return capabilityModule.execute(params,this._botState.context);}else{console.log('Old way');return callLambda('CapabilityExecutorLambda',params,this.context.aws);}}},{key:'updateBalance',value:function updateBalance(account,balance){var conversation=this.conversation;var userId=this.userId;var params={capability:'MessageQuotaCapability',capabilityFileName:'messageQuotaCapability',action:'updateUserUsedQuota',sync:true,userId:userId,conversation:conversation,stats:{}};params.stats[account]=balance;var capabilities=this._botState.context.capabilities;var capFileName=params.capabilityFileName;var capabilityModule=capabilities[capFileName];if(capabilityModule){console.log('Executing the capability module');return capabilityModule.execute(params,this._botState.context);}else{console.log('Old way');return callLambda('CapabilityExecutorLambda',params,this.context.aws);}}},{key:'getCallRates',value:function getCallRates(isoCountry){try{var conversation=this.conversation;var userId=this.userId;var params={capability:'VoipCapability',capabilityFileName:'voipCapability',action:'getCallTariffsForCountry',isoCountry:isoCountry,userDomains:this._botState.userDomains,sync:true,userId:userId,conversation:conversation};var capabilities=this._botState.context.capabilities;var capFileName=params.capabilityFileName;var capabilityModule=capabilities[capFileName];if(capabilityModule){console.log('Executing the capability module');return capabilityModule.execute(params,this._botState.context);}else{console.log('Old way');return callLambda('CapabilityExecutorLambda',params,this.context.aws).then(function(response){console.log('Response from custom cap: '+JSON.stringify(response));return JSON.parse(response.Payload);});}}catch(error){this._botState.addSystemErrorToStack(8,error.message);}}},{key:'getCallHistory',value:function getCallHistory(){try{var params={action:'getCallHistory',capability:'VoipCapability',capabilityFileName:'voipCapability',userId:this.userId,conversation:this.conversation,sync:true,email:this._botState.user.userEmail};var capabilities=this._botState.context.capabilities;var capFileName=params.capabilityFileName;var capabilityModule=capabilities[capFileName];if(capabilityModule){console.log('Executing the capability module');return capabilityModule.execute(params,this._botState.context);}else{console.log('Param: '+JSON.stringify(params));return callLambda('CapabilityExecutorLambda',params,this.context.aws).then(function(response){console.log('Response from custom cap: '+JSON.stringify(response));return JSON.parse(response.Payload);});}}catch(error){this._botState.addSystemErrorToStack(8,error.message);}}}]);return Accounts;}();var Error=function(){_createClass(Error,null,[{key:'getErrorMessageforCodeAndLang',value:function getErrorMessageforCodeAndLang(errorCode,lang){var errorsLibrary={0:{en:'No error'},1:{en:'The valid values for RunLocation are Edge and Cloud'},2:{en:'RunLocation attribute is mandatory'},3:{en:'The onResolution function is mandatory'},4:{en:'To process your request, I need to reach the cloud and you appear to be offline at this moment. Please try again later'},5:{en:'Error in edge bot logic with message '},6:{en:'NLP cannot be called with other data than string'},7:{en:'Error processing botResolver in backend'},8:{en:'Error in cloud bot logic with message '},9:{en:'The name for the bot name already exists for your domain, please change it and try again'},10:{en:'An unknown problem has appeared during the bot publication process. Please contact FrontM support.'},11:{en:'Logic error in onError function'},12:{en:'Wrong debug command'},13:{en:'I Cannot run inApp purchases in the cloud'},14:{en:'Invalid message adding a response'},15:{en:'I have not received the authorisation to activate the notifications. You can request me to activate the notifications in any time.'},16:{en:'I could not register your device for notifications at this moment. Please try again later'},17:{en:'Password update error. '},18:{en:'Capability not available on the cloud'},19:{en:'I encountered a problem unregistering your device for notifications'},20:{en:'I could not deregister your device for notifications at this moment. Please try again later'},21:{en:'Invalid intent object found'},22:{en:'Ambiguous NLP results'},23:{en:'This method requires an array of Strings'},24:{en:'Invalid NLP Id'}};return errorsLibrary[errorCode][lang];}}]);function Error(botState,errorCode,errorMessage){_classCallCheck(this,Error);this._errorCode=errorCode;if(errorCode<1000){if(errorMessage){this._errorMessage=Error.getErrorMessageforCodeAndLang(errorCode,botState.lang)+' '+errorMessage;}else{this._errorMessage=Error.getErrorMessageforCodeAndLang(errorCode,botState.lang);}}else{this._errorMessage=errorMessage;}}_createClass(Error,[{key:'errorCode',get:function get(){return this._errorCode;}},{key:'errorMessage',get:function get(){return this._errorMessage;}}]);return Error;}();var MessageTypes=function(){function MessageTypes(){_classCallCheck(this,MessageTypes);}_createClass(MessageTypes,null,[{key:'MESSAGE_TYPE_STRING',value:function MESSAGE_TYPE_STRING(){return 10;}},{key:'MESSAGE_TYPE_IMAGE',value:function MESSAGE_TYPE_IMAGE(){return 30;}},{key:'MESSAGE_TYPE_VIDEO',value:function MESSAGE_TYPE_VIDEO(){return 40;}},{key:'MESSAGE_TYPE_AUDIO',value:function MESSAGE_TYPE_AUDIO(){return 60;}},{key:'MESSAGE_TYPE_HTML',value:function MESSAGE_TYPE_HTML(){return 140;}},{key:'BACKEND_RESPONSE',value:function BACKEND_RESPONSE(){return 150;}},{key:'BOT_TO_BOT',value:function BOT_TO_BOT(){return 160;}},{key:'MESSAGE_TYPE_LIST',value:function MESSAGE_TYPE_LIST(){return 200;}},{key:'MESSAGE_TYPE_SLIDER',value:function MESSAGE_TYPE_SLIDER(){return 210;}},{key:'MESSAGE_TYPE_BUTTON',value:function MESSAGE_TYPE_BUTTON(){return 220;}},{key:'MESSAGE_TYPE_FORM',value:function MESSAGE_TYPE_FORM(){return 230;}},{key:'MESSAGE_TYPE_MAP',value:function MESSAGE_TYPE_MAP(){return 240;}},{key:'MESSAGE_TYPE_SMART_SUGGESTIONS',value:function MESSAGE_TYPE_SMART_SUGGESTIONS(){return 250;}},{key:'MESSAGE_TYPE_WEB_CARD',value:function MESSAGE_TYPE_WEB_CARD(){return 260;}},{key:'MESSAGE_TYPE_STD_NOTIFICATION',value:function MESSAGE_TYPE_STD_NOTIFICATION(){return 270;}},{key:'MESSAGE_TYPE_CRITICAL_NOTIFICATION',value:function MESSAGE_TYPE_CRITICAL_NOTIFICATION(){return 280;}},{key:'MESSAGE_TYPE_LOCATION',value:function MESSAGE_TYPE_LOCATION(){return 290;}},{key:'MESSAGE_TYPE_PDF',value:function MESSAGE_TYPE_PDF(){return 300;}},{key:'MESSAGE_TYPE_TEXT',value:function MESSAGE_TYPE_TEXT(){return 320;}},{key:'MESSAGE_TYPE_OTHER_FILE',value:function MESSAGE_TYPE_OTHER_FILE(){return 330;}},{key:'MESSAGE_TYPE_CSV',value:function MESSAGE_TYPE_CSV(){return 340;}},{key:'MESSAGE_TYPE_JAVASCRIPT',value:function MESSAGE_TYPE_JAVASCRIPT(){return 350;}},{key:'MESSAGE_TYPE_FORM2',value:function MESSAGE_TYPE_FORM2(){return 400;}},{key:'MESSAGE_TYPE_MENU',value:function MESSAGE_TYPE_MENU(){return 410;}},{key:'MESSAGE_TYPE_TABLE',value:function MESSAGE_TYPE_TABLE(){return 420;}},{key:'MESSAGE_TYPE_CONTACT_CARD',value:function MESSAGE_TYPE_CONTACT_CARD(){return 430;}},{key:'MESSAGE_TYPE_DATA_CARD',value:function MESSAGE_TYPE_DATA_CARD(){return 440;}},{key:'MESSAGE_TYPE_FORM_RESPONSE',value:function MESSAGE_TYPE_FORM_RESPONSE(){return 450;}},{key:'MESSAGE_TYPE_STRIPE',value:function MESSAGE_TYPE_STRIPE(){return 460;}},{key:'MESSAGE_TYPE_STRIPE_RESPONSE',value:function MESSAGE_TYPE_STRIPE_RESPONSE(){return 470;}},{key:'MESSAGE_TYPE_CLOSE_FORM',value:function MESSAGE_TYPE_CLOSE_FORM(){return 480;}},{key:'MESSAGE_TYPE_MAP_RESPONSE',value:function MESSAGE_TYPE_MAP_RESPONSE(){return 490;}},{key:'MESSAGE_TYPE_SEARCH_BOX',value:function MESSAGE_TYPE_SEARCH_BOX(){return 510;}},{key:'MESSAGE_TYPE_SEARCH_BOX_RESPONSE',value:function MESSAGE_TYPE_SEARCH_BOX_RESPONSE(){return 520;}},{key:'MESSAGE_TYPE_CARDS',value:function MESSAGE_TYPE_CARDS(){return 530;}},{key:'MESSAGE_TYPE_CARD_ACTION',value:function MESSAGE_TYPE_CARD_ACTION(){return 540;}}]);return MessageTypes;}();var State=function(){_createClass(State,null,[{key:'MOBILECLIENT',value:function MOBILECLIENT(){return'mobile';}},{key:'WEBCLIENT',value:function WEBCLIENT(){return'web';}}]);function State(message,conversation,user,location,stateFromStorage,context){var _this24=this;_classCallCheck(this,State);this['conversationId']=conversation.conversationId;this['conversation']=conversation;this['client']=this.conversation.client;this['lang']='en';this['_activeIntent']='';this['_intentHistory']=[];this['_intentStats']={};this['error']=false;this['errorStack']=[];this['responsesArray']=[];this['smartSuggestionsArray']=[];this['_blockSuggestions']=false;this['toCustomCap']=false;this['_silentIntent']=false;this['user']=user;this['intentResolved']=false;this['waitingCustomCap']=0;this['location']=location;this['requestIdsArray']=[];this['context']=null;this['_']=null;this['R']=null;this['Immutable']=null;this['moment']=null;this['momentTimezone']=null;this['messageTypes']={};this['lastGreetingTime']=0;this['MessageCapability']=null;this['_forms']=[];this['_botFlows']=[];this['_log']=[];this['fields']={};this['logoutInProcess']=false;this.setContext(context);this['lastSession']=this._.toNumber(this._.now());this['developer']=new Developer(this);this['accounts']=new Accounts(this);this['orders']=new Orders(this);this['notification']=new Notification(this);this['marketplace']=new Marketplace(this);this['jobScheduler']=new JobScheduler(this);this['contacts']=new Contacts(this);this['api']=new API(this);this['db']=new DB(this);this['sites']=new Sites(this);this['locationServices']=new LocationServices(this);this['trackingServices']=new TrackingServices(this);this['nlp']=new NLP(this);this['promptAlive']='';this['amIOnline']=true;this['_searchBoxes']=[];this['_currentSearchBox']='';this['sendMessageParam']=null;this['compatibilityMode']=false;this['disambiguate']=false;this['disambiguationNLPId']='';this['_nlpResults']={};this['_lastNLPResults']={};this['_intentDurations']=[];if(stateFromStorage){for(var propertyName in stateFromStorage){if(propertyName==='_botFlows'){this._.each(stateFromStorage[propertyName],function(botFlowFromStorage){var botFlow=new BotFlow(_this24,botFlowFromStorage._name,botFlowFromStorage);_this24._botFlows.push(botFlow);});}else if(propertyName==='_forms'){this._.each(stateFromStorage[propertyName],function(formFromStorage){var form=new Form(_this24,null,formFromStorage);_this24._forms.push(form);});}else if(propertyName==='_debugMode'){this.developer._debugMode=true;}else{this[propertyName]=stateFromStorage[propertyName];}}}if(message){if(message.messageType){this['messageTypeFromUser']=message.messageType;this['messageFromUser']=message.messageFromUser||'';}else{this['messageTypeFromUser']=message.getMessageType();this['messageFromUser']=message.getMessage();}}console.log('*************** message type: '+this['messageTypeFromUser']);console.log('*************** message: '+JSON.stringify(this['messageFromUser']));this.defaultOnError=function(){if(_this24.developer.runMode!==Developer.PROD()){_this24._.forEach(_this24.errorStack,function(error){_this24.addStringResponse(error.errorMessage);});}else{_this24.addStringResponse("I don't seem to be able to perform your operation at this moment. Please try again later");_this24.addStringResponse('In the meantime I have reported the issue to our support team. They will make sure that this problem is not happening again');}};this.resetOnErrorMethod();}_createClass(State,[{key:'callCapability',value:function callCapability(params){var capabilities=this.context.capabilities;var capFileName=params.capabilityFileName;var capabilityModule=capabilities[capFileName];if(capabilityModule){console.log('Executing the capability module');return capabilityModule.execute(params,this.context);}}},{key:'resetOnErrorMethod',value:function resetOnErrorMethod(){this.clearError();this._onError=this.defaultOnError;}},{key:'getNlpResultsForId',value:function getNlpResultsForId(nlpId){if(this._nlpResults){if(this._nlpResults[nlpId]){return this._nlpResults[nlpId];}}return{};}},{key:'online',value:function online(){if(this.client===State.MOBILECLIENT()){var network=this.context.getCapability('Network');return network.isConnected().then(function(connected){return connected;});}else{return Promise.resolve(true);}}},{key:'addSearchBox',value:function addSearchBox(searchBox){var existingSearchBox=this.getSearchBox(searchBox.id);if(!existingSearchBox){this._searchBoxes.push(searchBox);}else{existingSearchBox.onSearch=searchBox.onSearch;existingSearchBox.onCompletion=searchBox.onCompletion;existingSearchBox.onCancel=searchBox.onCancel;}}},{key:'getSearchBox',value:function getSearchBox(searchBoxId){var i=this._.findIndex(this._searchBoxes,function(searchBox){return searchBox.id===searchBoxId;});return this._searchBoxes[i]||null;}},{key:'addBotFlow',value:function addBotFlow(botFlow){var existingBotFlow=this.getBotFlow(botFlow.name);if(!existingBotFlow){this._botFlows.push(botFlow);}else{existingBotFlow.onStart=botFlow._onStart;}}},{key:'getBotFlow',value:function getBotFlow(botFlowName){var i=this._.findIndex(this._botFlows,function(botFlow){return botFlow.name===botFlowName;});return this._botFlows[i]||null;}},{key:'runLocationVerification',value:function runLocationVerification(method,location){var locationPassed=location===this.location;if(!locationPassed){this.addErrorToStack(1,'Method '+method+' cannot run on the '+this.location);}return locationPassed;}},{key:'setNetworkModeTo',value:function setNetworkModeTo(mode){return this.context.getCapability('Settings').setPollingStrategy(mode);}},{key:'setContext',value:function setContext(context){var _this25=this;this.context=context;if(this.location===Intent.EDGE()){this['userName']=this.user.info.userName;this.user.userName=this.user.info.userName;var utils=this.context.getCapability('Utils');this._=utils.Lodash;this.R=this.context.getCapability('R')||{};this.immutable=this.context.getCapability('Immutable')||{};this.UUID=utils.UUID;this.messageTypes=this.context.getCapability('MessageTypeConstants');this.MessageCapability=this.context.getCapability('Message');this.userDomains=this.user.info.domains;this.moment=this.context.getCapability('Moment');this.momentTimezone=this.context.getCapability('MomentTimezone');}else{this._=this.context._;this.R=this.context.R||{};this.immutable=this.context.immutable||{};this.UUID=function(){var ShortUUID=_this25.context.UUID;var uuid=ShortUUID.uuid();return ShortUUID().fromUUID(uuid);};this.userDomains=this.user.userDomains;this.moment=this.context.moment;this.momentTimezone=this.context['moment-timezone'];}}},{key:'syncWithBackendState',value:function syncWithBackendState(state){var _this26=this;if(this.messageTypeFromUser===MessageTypes.BACKEND_RESPONSE()){console.log(JSON.stringify(state));if(state.intentResolved){this.intentResolved=state.intentResolved;}console.log('About to sync botFlows');if(state._botFlows){console.log('Botflows from backend '+JSON.stringify(state._botFlows));var botFlowArray=[];this._.each(state._botFlows,function(botFlowFromBackend){var botFlow=new BotFlow(_this26,botFlowFromBackend._name,botFlowFromBackend);botFlowArray.push(botFlow);});this._botFlows=botFlowArray;}if(state.responsesArray){this._.each(state.responsesArray,function(response){if(response.type==='form2'){var form=_this26.getForm(response.message._options.formId);if(form){form.options=response.message._options;form.fields=response.message._fields;}else{form=new Form(_this26,null,response.message);_this26.addForm(form);}_this26.addResponse('form2',form);}else if(response.type==='prompt'){_this26._.each(_this26.botFlows,function(botFlow){var entity=botFlow.getEntity(response.message.name);if(entity){var newMessage={type:response.type,message:entity};_this26.responsesArray.push(newMessage);}});}else{_this26.responsesArray.push(response);}});}if(state._activeIntent){this.addActiveIntent(state._activeIntent);}if(state._silentIntent){this._silentIntent=true;}if(state.nlpResponse){this.nlpResponse=state.nlpResponse;}if(state._nlpResults){this._nlpResults=state._nlpResults;this._lastNLPResults=state._nlpResults;}if(state.errorStack){this._.each(state.errorStack,function(error){_this26.addErrorToStack(error._errorCode,error._errorMessage);});}if(state.smartSuggestionsArray){this.smartSuggestionsArray=state.smartSuggestionsArray;}console.log('Starting with logs');if(state._log){this._.each(state._log,function(logEntry){_this26._log.push(logEntry);});}console.log('After logs');this.fields=this.R.merge(this.fields,state.fields);if(state.sendMessageParam){this.sendMessageParam=state.sendMessageParam;}if(state._blockSuggestions){this.blockSuggestions=true;}if(state.clearPrompt){this.promptAlive='';}if(Array.isArray(state.requestIdsArray)){this.requestIdsArray=this.requestIdsArray.concat(state.requestIdsArray);}if(state._intentDurations){this._intentDurations=state._intentDurations;}}else{console.log('I have not synced anything');}}},{key:'getNewRequestId',value:function getNewRequestId(){if(this.UUID){return this.UUID();}else{return null;}}},{key:'getAllProperties',value:function getAllProperties(){var botFlowArray=[];this._.forEach(this._botFlows,function(botFlow){botFlowArray.push(botFlow.getAllProperties());});var formsArray=[];this._.forEach(this._forms,function(form){formsArray.push(form.getAllProperties());});var response={conversationId:this['conversationId'],toCustomCap:this['toCustomCap'],intentResolved:this['intentResolved'],waitingCustomCap:this['waitingCustomCap'],lastGreetingTime:this['lastGreetingTime'],_log:this._log,_intentDurations:this['_intentDurations']};if(this.promptAlive!==''){response.promptAlive=this.promptAlive;}if(this._activeIntent!==''){response._activeIntent=this._activeIntent;}response.errorStack=this['errorStack'];response.requestIdsArray=this['requestIdsArray'];response._botFlows=botFlowArray;response._forms=formsArray;response.fields=this.fields;response._silentIntent=this._silentIntent;response._lastNLPResults=this._lastNLPResults;if(this.developer._debugMode){response._debugMode=true;}if(this._currentSearchBox!==''){response._currentSearchBox=this._currentSearchBox;}response._intentHistory=this._intentHistory;return response;}},{key:'runFunctionOnceAnHour',value:function runFunctionOnceAnHour(functionBlock){var latestTime=this._.now();if(this._.toNumber(latestTime)-this._.toNumber(this.lastGreetingTime)>3600000){this.lastGreetingTime=latestTime;functionBlock();}}},{key:'runFunctionOnceADay',value:function runFunctionOnceADay(functionBlock){var latestTime=this._.now();if(this._.toNumber(latestTime)-this._.toNumber(this.lastGreetingTime)>86400000){this.lastGreetingTime=latestTime;functionBlock();}}},{key:'getDeviceLocation',value:function getDeviceLocation(){return this.context.getCapability('DeviceLocation').getDeviceLocation();}},{key:'updatePassword',value:function updatePassword(oldPassword,newPassword){var _this27=this;var updatedUser={email:this.user.info.emailAddress,oldPassword:oldPassword,newPassword:newPassword};return this.context.getCapability('authContext').updatePassword(updatedUser,this.context).then(function(response){console.log('Password response :',JSON.stringify(response));}).catch(function(error){console.log('Password update error :',JSON.stringify(error));_this27.addSystemErrorToStack(17,error.message);});}},{key:'logout',value:function logout(){var _this28=this;this['logoutInProcess']=true;return this.context.getCapability('authContext').logout(this.context).then(function(){_this28.addResponse('silent',{});});}},{key:'sendMessage',value:function sendMessage(message){console.log('============> setting send  message param');this.developer.debug('User sending message with '+JSON.stringify(message));this.sendMessageParam=message;}},{key:'continueInIntentWithIdAndMessage',value:function continueInIntentWithIdAndMessage(intentId,message){var object={intentId:intentId};this.sendMessage(this.R.merge(object,message));}},{key:'processIntentWithIdAndMessage',value:function processIntentWithIdAndMessage(intentId,message){var object={intentId:intentId};this.sendMessage(this.R.merge(object,message));}},{key:'processIntentWithId',value:function processIntentWithId(intentId){var object={intentId:intentId};this.sendMessage(object);}},{key:'cleanFieldsForSave',value:function cleanFieldsForSave(fields){var _this29=this;var cleanFields={};if(typeof fields==='string'){if(fields===''){fields=' ';}return fields;}else if(typeof fields==='object'){if(Array.isArray(fields)){var newArray=[];this._.each(fields,function(entry){var newEntry=_this29.cleanFieldsForSave(entry);newArray.push(newEntry);});return newArray;}else{for(var properyName in fields){var theField=fields[properyName];switch(typeof theField){case'string':{cleanFields[properyName]=this.cleanFieldsForSave(theField);break;}case'object':{cleanFields[properyName]=this.cleanFieldsForSave(theField);break;}default:{cleanFields[properyName]=theField;break;}}}}}else{return fields;}return cleanFields;}},{key:'save',value:function save(){var _this30=this;if(!this['logoutInProcess']){this.fields=this.cleanFieldsForSave(this.fields);this._lastNLPResults=this.cleanFieldsForSave(this._lastNLPResults);return deviceStorageUtil.setInContext(this.getAllProperties(),this.context).then(function(){console.log('State Saved');_this30.error=false;return _this30;}).catch(function(err){console.log('State not Saved '+err.message);_this30.error=true;return _this30;});}}},{key:'getUniqueId',value:function getUniqueId(){return this.UUID();}},{key:'setField',value:function setField(fieldName,fieldValue){this.fields[fieldName]=fieldValue;}},{key:'clearField',value:function clearField(fieldName){delete this.fields[fieldName];}},{key:'getField',value:function getField(fieldName){var field=this.fields[fieldName];if(typeof field!=='undefined'){return field;}else{return null;}}},{key:'hasFieldInPath',value:function hasFieldInPath(path){return!!this.R.path(path,this.fields);}},{key:'addSmartSuggestions',value:function addSmartSuggestions(newSmartSuggestion){this.smartSuggestionsArray.push(newSmartSuggestion);}},{key:'addSmartSuggestionsArray',value:function addSmartSuggestionsArray(newSmartSuggestions){var _this31=this;var _=this._;_.each(newSmartSuggestions,function(suggestionObject){if(suggestionObject.lang===_this31.lang){_this31.smartSuggestionsArray=_this31.smartSuggestionsArray.concat(suggestionObject.list);}});}},{key:'addEnglishSmartSuggestions',value:function addEnglishSmartSuggestions(newSmartSuggestions){var smartSuggestionsArray=[{lang:'en',list:newSmartSuggestions}];this.addSmartSuggestionsArray(smartSuggestionsArray);}},{key:'setDefaultSmartSuggestions',value:function setDefaultSmartSuggestions(bot){var _this32=this;var _=this._;if(this.compatibilityMode){this.developer.debug('Start processing suggestions with params '+JSON.stringify(this.sendMessageParam));if(!this.blockSuggestions&&!this.sendMessageParam){if(this.promptAlive!==''){this.developer.debug('Start processing suggestions for Prompt');_.each(this._botFlows,function(botFlow){var entity=botFlow.getEntity(_this32.promptAlive);if(entity){_this32.clearSmartSuggestionsArray();var cancelPromptText=_this32.getForm(entity.form).options.cancel||'Cancel';var restartPromptText=_this32.getForm(entity.form).options.restart||'Restart';_this32.addEnglishSmartSuggestions([cancelPromptText,restartPromptText]);return false;}});}if(this.smartSuggestionsArray.length===0){this.developer.debug('Suggestions clean. Start finding defaults');var intentsAdded=[];var addedSuggestions=function addedSuggestions(intentStep){_this32.developer.debug('Adding suggestion for intent '+intentStep.intentId);var index=_this32._.findIndex(bot,function(intent){return intentStep.intentId===intent.intentId;});if(bot[index].suggestionsArray&&!intentStep.done){_this32.addSmartSuggestionsArray(bot[index].suggestionsArray);}};var startedBotFlows=false;_.each(this._botFlows,function(botFlow){if(botFlow.isStarted){_this32.developer.debug('BotFlow started. Finding suggestions for step');startedBotFlows=true;return false;}});_.each(this._botFlows,function(botFlow){var stepCount=0;_.each(botFlow.steps,function(step){_.each(step,function(intentStep){intentsAdded.push(intentStep.intentId);if(botFlow.isStarted){if(stepCount===botFlow.currentStepIndex){addedSuggestions(intentStep);}}else if(!startedBotFlows){if(stepCount===0){addedSuggestions(intentStep);}}});stepCount+=1;});});_.each(bot,function(intent){if(intent.suggestionsArray&&intentsAdded.indexOf(intent.intentId)===-1){_this32.addSmartSuggestionsArray(intent.suggestionsArray);}});}this.developer.debug('The suggestions are '+JSON.stringify(this.smartSuggestionsArray));}else{this.developer.debug('Suggestions blocked or sending message');}}}},{key:'clearSmartSuggestionsArray',value:function clearSmartSuggestionsArray(){console.log('Clearing Suggestions');this.smartSuggestionsArray=[];this._blockSuggestions=false;}},{key:'getForm',value:function getForm(formId){var i=this._.findIndex(this._forms,function(form){return form.formId===formId;});return this._forms[i]||null;}},{key:'addForm',value:function addForm(newForm){var _this33=this;var form=this.getForm(newForm.formId);var createSearchBox=function createSearchBox(field){if(field.type==='search_box'){var searchBox=new SearchBox(_this33,field.id,field.prompt,'single');searchBox.onSearch=field.onSearch;_this33.addSearchBox(searchBox);}};if(form){form.onSubmit=newForm.onSubmit;form.onCancel=newForm.onCancel;form.onClose=newForm.onClose;this._.each(form.fields,function(field){var newField=newForm.getField(field.id);if(newField){field.title=newField.title;field.type=newField.type;field.mandatory=newField.mandatory;field.validation=newField.validation;field.readOnly=newField.readOnly;field.options=newField.options;field.info=newField.info;field.onCompletion=newField.onCompletion;field.onSearch=newField.onSearch;field.onMoveOut=newField.onMoveOut;}createSearchBox(field);});}else{this._.each(newForm.fields,function(field){createSearchBox(field);});this._forms.push(newForm);}}},{key:'removeForm',value:function removeForm(formToDelete){var i=this._.findIndex(this._forms,function(form){return formToDelete.formId===form.formId;});if(i>-1){this._forms.splice(i,1);}}},{key:'addActiveIntent',value:function addActiveIntent(intentId){var _this34=this;var logHistory=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;var silent=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;this._silentIntent=silent;var cutIn10=function cutIn10(){if(_this34._intentHistory.length>10){_this34._intentHistory.splice(0,1);cutIn10();}};if(intentId==='main'){if(this._intentHistory.length>0){this._activeIntent=this.previousActiveIntent;}else{this._activeIntent=intentId;if(logHistory){this._intentHistory.push(intentId);}}}else{this._activeIntent=intentId;if(logHistory){this._intentHistory.push(intentId);}}cutIn10();}},{key:'removeActiveIntent',value:function removeActiveIntent(){if(this._activeIntent!==''){this._activeIntent='';}}},{key:'addSystemErrorToStack',value:function addSystemErrorToStack(code,message){var errorObject=new Error(this,code,message);this.developer.log(errorObject.errorMessage,LogEntrytype.SYSTEM_ERROR());this.errorStack.push(errorObject);}},{key:'addErrorToStack',value:function addErrorToStack(code,message){var errorObject={};if(code<999){errorObject=new Error(this,1000,message);}else{errorObject=new Error(this,code,message);}this.developer.log(errorObject.errorMessage,LogEntrytype.USER_ERROR());this.errorStack.push(errorObject);}},{key:'clearError',value:function clearError(){this.errorStack=[];}},{key:'addStringResponse',value:function addStringResponse(message){this.addResponse('string',message);}},{key:'addStringResponseFromArray',value:function addStringResponseFromArray(messages){var error=false;if(Array.isArray(messages)){var index=Math.round(Math.random()*(messages.length-1));var message=messages[index];if(typeof message==='string'){this.addResponse('string',message);}else{error=true;}}else{error=true;}if(error){this.addErrorToStack(23,Error.getErrorMessageforCodeAndLang(23,this.lang));}}},{key:'addSilentResponse',value:function addSilentResponse(){this.addResponse('silent',{});}},{key:'addResponse',value:function addResponse(type,message){if(this.developer._debugMode){if(type==='string'){this.developer.debug('Added response '+message);}else if(type==='form2'){this.developer.debug('Added response '+JSON.stringify(message.getAllProperties())+' of type '+type);}else{this.developer.debug('Added message type '+type);}}if(message){var messageToView=message;if(type==='form2'&&this.location===Intent.CLOUD()){messageToView=message.getAllProperties();}this.responsesArray.push({type:type,message:messageToView});}else{this.addSystemErrorToStack(14,type);}}},{key:'clearResponseArray',value:function clearResponseArray(){this.responsesArray=[];}},{key:'setWaitingCustomCap',value:function setWaitingCustomCap(){if(!this.silentIntent){this.waitingCustomCap+=1;}}},{key:'resetWaitingForCustomCapCounter',value:function resetWaitingForCustomCapCounter(){this.waitingCustomCap=0;}},{key:'addRequestId',value:function addRequestId(requestId){this.requestIdsArray.unshift(requestId);if(this.requestIdsArray.length>10){this.requestIdsArray.pop();}}},{key:'markRequestIdProcessed',value:function markRequestIdProcessed(requestId){var indexOfRequestId=this.requestIdsArray.indexOf(requestId);if(indexOfRequestId===-1){this.addRequestId(requestId);console.log('Adding requestId');if(this.waitingCustomCap>0){this.waitingCustomCap-=1;}return true;}else{console.log('did not find requestId');return false;}}},{key:'loadAPIParameters',value:function loadAPIParameters(serviceName,publicFlag,APIdomain){console.log('Inside LoadAPIParameters');if(this.location===Intent.CLOUD()){var domain=this.conversation.userDomain;if(APIdomain){domain=APIdomain;}if(publicFlag){domain=PUBLICDOMAIN;}var lambdaParams={collection:'APIParameters',query:[{operand:'userDomain',value:domain},{operand:'serviceName',value:serviceName}],capability:'GetData',botDomain:domain,sync:true};return invokeLambda(lambdaParams,'SystemCapabilities',this.context.aws);}}},{key:'getDataFromService',value:function getDataFromService(apiKey,apiService,serviceInput,domain){console.info('Service at getDataFromService: '+apiService);var getServiceDataParams={userDomain:domain,service:apiService,queryString:'key='+apiKey+'&q='+serviceInput+'&format=json',sync:true};console.info('Query String to getDataFromService: '+getServiceDataParams.queryString);return invokeLambda(getServiceDataParams,'GetDataFromService',this.context.aws);}},{key:'callBing',value:function callBing(q){var headers={'Ocp-Apim-Subscription-Key':'b6b1d246a3324d8d8c0a43d9b5ee6135'};var uri='https://api.cognitive.microsoft.com/bing/v7.0/search?q='+q;var search_options={method:'GET',uri:uri,headers:headers,json:true};return this.context.requestPromise.get(search_options);}},{key:'callWebhose',value:function callWebhose(query_params){var client=this.context.webhoseio.config({token:'9da9372c-42fd-4581-969d-33fe7ca8d928'});return client.query('filterWebContent',query_params);}},{key:'callWikipedia',value:function callWikipedia(query){var encodedStr=encodeURIComponent(query);var url='https://en.wikipedia.org/w/api.php?action=query&format=json&list=search&srsearch='+encodedStr+'&prop=extracts|info&generator=search&inprop=url&gsrsearch='+encodedStr+'&titles='+encodedStr+'&redirects=&exintro=true&exsentences=2&explaintext=true&utf8=';var wiki_search={method:'GET',uri:url};console.log('Calling Wikipedia');return this.context.requestPromise.get(wiki_search);}},{key:'getWeatherInLocationAndTime',value:function getWeatherInLocationAndTime(location,dateTime){var _this35=this;var _=this._;var getHourData=function getHourData(date,weatherData){var hourData=[];var days=[];var firstDayIndex=void 0;var dayList=_.get(weatherData,'data.weather');if(_.isEmpty(date)){date=new Date().toISOString().slice(0,10);firstDayIndex=_.findIndex(dayList,function(day){return day.date===date;});days.push(dayList[firstDayIndex]);}else{console.info('Getting hour data for date:',date);firstDayIndex=_.findIndex(dayList,function(day){return day.date===date.fromDate;});if(firstDayIndex!==-1){days.push(dayList[firstDayIndex]);}if(!_.isUndefined(date.toDate)){if(_.findIndex(dayList,function(day){return day.date===date.toDate;})!==-1){days.push(dayList[++firstDayIndex]);}}}console.info('Days : ',days.length);_.each(days,function(day){var data={};var hourlyList=[];data.date=day.date;console.info('Date: ',day.date);var hourlyArray=_.get(day,'hourly');_.each(hourlyArray,function(curHourForecast){hourlyList.push({time:_.replace(curHourForecast.time,'00',':00'),precip:curHourForecast.precipMM,humidity:curHourForecast.humidity,tempC:curHourForecast.tempC,tempF:curHourForecast.tempF,windDir:curHourForecast.winddir16Point,windSpeed:curHourForecast.windspeedKmph,weatherDesc:curHourForecast.weatherDesc[0].value});});data.hourlyWeather=hourlyList;hourData.push(data);});console.info('Returning value from getHoursData: ',JSON.stringify(hourData));return hourData;};var latLong={};var latLongList=[];var weatherDataResult={};console.log('Getting weather from API');return new Promise(function(resolve,reject){if(_.isUndefined(location)){weatherDataResult.message='Sorry! location is required to get weather data';resolve(weatherDataResult);}else{_this35.loadAPIParameters('WebSearch',false,'locationiq.org').then(function(apiParamsData){var apiParams=JSON.parse(apiParamsData.Payload).items[0];console.info('Got api key for location IQ: '+apiParams.apiKey);console.info('Location to get co-ordinates: '+JSON.stringify(location));return _this35.getDataFromService(apiParams.apiKey,'WebSearch',location,'locationiq.org');}).then(function(locationIqResponse){var locationData=JSON.parse(locationIqResponse.Payload);for(var _location in locationData){var currentLocation=locationData[_location];latLongList.push({latitude:currentLocation.lat,longitude:currentLocation.lon});}latLong.latitude=latLongList[0].latitude;latLong.longitude=latLongList[0].longitude;return _this35.loadAPIParameters('MaritimeWeather',false,'weatherworld.com');}).then(function(apiParamsData){var apiParams=JSON.parse(apiParamsData.Payload).items[0];console.info('Got api key for maritime weather'+apiParams.apiKey);var latLangInput=latLong.latitude+','+latLong.longitude;console.info('Latitude Longitude to Maritime API: '+latLangInput);return _this35.getDataFromService(apiParams.apiKey,'MaritimeWeather',latLangInput,'weatherworld.com');}).then(function(serviceData){var weatherData=JSON.parse(serviceData.Payload);console.info('Got maritime weather data');if(_.isEmpty(weatherData)){var msg='Maritime API did not return data';console.info(msg);reject(msg);}var errorObj=_.get(weatherData,'error');if(!_.isEmpty(errorObj)){var errMsg=_.get(errorObj,'data.error[0].msg');console.info('Maritime API returned error: ',errMsg);reject(errMsg);}var dateObj={};if(!_.isEmpty(dateTime)){var splitedDateTime=_.split(dateTime,'/');dateObj.fromDate=splitedDateTime[0];dateObj.toDate=splitedDateTime[1];var retVal=checkDate(dateObj,_);if(!retVal.flag){weatherDataResult.message='Sorry I can only get the forecast for up to 3 days ahead';dateObj.fromDate=retVal.date;}}var result=getHourData(dateObj,weatherData);weatherDataResult.result=result;resolve(weatherDataResult);});}});}},{key:'stateToBackEnd',value:function stateToBackEnd(){var botFlowArray=[];this._.each(this._botFlows,function(botFlow){botFlowArray.push(botFlow.getAllProperties());});var formsArray=[];this._.each(this._forms,function(form){formsArray.push(form.getAllProperties());});var stateToBackend={lang:this.lang,intentResolved:this.intentResolved,messageTypeFromUser:this.messageTypeFromUser,messageFromUser:this.messageFromUser,userName:this.userName,fields:this.fields,_intentHistory:this._intentHistory};if(this._.size(botFlowArray)>0){stateToBackend._botFlows=botFlowArray;}if(this.promptAlive!==''){stateToBackend.promptAlive=this.promptAlive;}if(this._activeIntent!==''){stateToBackend._activeIntent=this._activeIntent;}if(this._intentDurations!==''){stateToBackend._intentDurations=this._intentDurations;}if(this._.size(formsArray)>0){stateToBackend._forms=formsArray;}if(this.developer._debugMode){stateToBackend._debugMode=true;}if(this.client===State.WEBCLIENT()){stateToBackend.client=this.client;}if(this._currentSearchBox!==''){stateToBackend._currentSearchBox=this._currentSearchBox;}stateToBackend.client=this.client;return{state:stateToBackend};}},{key:'getFinalResponse',value:function getFinalResponse(){var _=this._;var finalResponse={};if(this['_activeIntent']!==''){finalResponse._activeIntent=this['_activeIntent'];}if(this.nlpResponse){finalResponse.nlpResponse=this.nlpResponse;}if(this._nlpResults){finalResponse._nlpResults=this._nlpResults;}if(_.size(this['errorStack'])>0){finalResponse.errorStack=this['errorStack'];}finalResponse.fields=this['fields'];if(_.size(this['_log'])>0){finalResponse._log=this['_log'];}if(_.size(this['responsesArray'])>0){finalResponse.responsesArray=this['responsesArray'];}if(this['smartSuggestionsArray']&&_.size(this['smartSuggestionsArray'])>0){finalResponse.smartSuggestionsArray=this['smartSuggestionsArray'];}if(this['intentResolved']){finalResponse.intentResolved=this['intentResolved'];}var botFlowArray=[];this._.forEach(this._botFlows,function(botFlow){if(botFlow.isChanged){botFlowArray.push(botFlow.getAllProperties());}});if(botFlowArray.length>0){finalResponse._botFlows=botFlowArray;}if(this.developer._debugMode){finalResponse._debugMode=true;}if(this.sendMessageParam){finalResponse.sendMessageParam=this.sendMessageParam;}if(this.blockSuggestions){finalResponse._blockSuggestions=true;}if(this.silentIntent){finalResponse._silentIntent=true;}if(this.clearPrompt){finalResponse.clearPrompt=true;}if(this.requestIdsArray.length>0){finalResponse.requestIdsArray=this.requestIdsArray;}if(this._intentDurations){finalResponse._intentDurations=this._intentDurations;}return finalResponse;}},{key:'onError',set:function set(onErrorBlock){this._onError=onErrorBlock;},get:function get(){return this._onError;}},{key:'forms',get:function get(){return this._forms;}},{key:'silentIntent',get:function get(){return this._silentIntent;}},{key:'activeIntent',get:function get(){return this._activeIntent;}},{key:'nlpResults',get:function get(){return this._nlpResults;},set:function set(nlpResults){this._nlpResults=nlpResults;}},{key:'previousActiveIntent',get:function get(){var l=this._intentHistory.length;var r='';if(l>1){if(this._activeIntent===''){r=this._intentHistory[l-1];}else{r=this._intentHistory[l-2];}}else{if(l===1){if(this._activeIntent===''){r=this._intentHistory[0];}}}return r;}},{key:'botFlows',get:function get(){return this._botFlows;}},{key:'searchBoxes',get:function get(){return this._searchBoxes;}},{key:'currentSearchBox',set:function set(searchBox){this._currentSearchBox=searchBox;},get:function get(){return this._currentSearchBox;}},{key:'blockSuggestions',set:function set(flag){this._blockSuggestions=flag;},get:function get(){return this._blockSuggestions;}},{key:'inError',get:function get(){return this._.size(this.errorStack)>0;}}]);return State;}();var LINKEDCUSTOMCAPA="onboarding-bot_CustomCap";var SYNC=false;var CANQUEUE=true;var NO_INTENT_MESSAGE="Sorry, I didn't get that";var iAmTheOne=null;var deviceStorageUtil={conversation:"",getContext:function getContext(botContext,DeviceStorage){DeviceStorage=DeviceStorage||botContext.getCapability("DeviceStorage");return DeviceStorage.get(deviceStorageUtil.conversation);},setInContext:function setInContext(state,botContext){var DeviceStorage=botContext.getCapability("DeviceStorage");return DeviceStorage.save(state.conversationId,state);},resetContext:function resetContext(conversationId,botContext){var DeviceStorage=botContext.getCapability("DeviceStorage");return DeviceStorage.save(conversationId,{});},removeFromContext:function removeFromContext(key,botContext){var DeviceStorage=botContext.getCapability("DeviceStorage");return deviceStorageUtil.getContext(botContext,DeviceStorage).then(function(state){delete state[key];return DeviceStorage.save(deviceStorageUtil.conversation,state);});}};var runMatchers=function runMatchers(state){console.log("************* Matchers method ****************");var start=Date.now();var _=state._;var promiseProcessed=false;return new Promise(function(resolve,reject){if(state.messageTypeFromUser===MessageTypes.BACKEND_RESPONSE()||state.messageTypeFromUser==="form_response"&&state.messageFromUser.action!==Form.SEARCH_FORM_ACTION()||state.activeIntent!==""){promiseProcessed=true;resolve();}else if(state.developer.isDeveloperIntent()){var devIntent=state.developer.identifyDeveloperIntent();if(devIntent){state.addActiveIntent(devIntent,false);}else{state.addSystemErrorToStack(12);state.addActiveIntent(Intent.NO_INTENT());}promiseProcessed=true;resolve();}else if(state.promptAlive===""&&state.messageTypeFromUser!=="form_response"){_.each(Bot(state),function(intent){if(intent.intentId){if(intent.runLocation){if(intent.runLocation!==Intent.EDGE()&&intent.runLocation!==Intent.CLOUD()){state.addSystemErrorToStack(1);resolve();promiseProcessed=true;return false;}if(intent.runLocation===Intent.EDGE()){if(typeof intent.onMatching==="function"&&intent.intentId!=="main"){if(intent.onMatching(state)){state.developer.log("Intent matched to "+intent.intentId,LogEntrytype.INFO());state.addActiveIntent(intent.intentId,intent.logHistory,intent.silentIntent);resolve();promiseProcessed=true;return false;}}}}else{state.addSystemErrorToStack(2);resolve();promiseProcessed=true;return false;}}else{state.addSystemErrorToStack(21);resolve();promiseProcessed=true;return false;}});}if(!promiseProcessed){if(state.messageTypeFromUser!==MessageTypes.BACKEND_RESPONSE()){state.toCustomCap=true;}resolve();}state.developer.logCurrentEventDurationWithStartTime("runMatchers",start,Date.now());});};var callCustomCap=function callCustomCap(state){console.log("************* Calling custom cap ****************");var start=Date.now();var agentGuardService=state.context.getCapability("agentGuardService");var requestId=state.getNewRequestId();console.log("State to backend "+JSON.stringify(state.stateToBackEnd()));return agentGuardService.executeCustomCapability(LINKEDCUSTOMCAPA,state.stateToBackEnd(),SYNC,requestId,state.context,state.user,CANQUEUE).then(function(response){console.log("Here within the then "+JSON.stringify(response));state.setWaitingCustomCap();state.developer.logCurrentEventDurationWithStartTime("callCustomCap",start,Date.now());}).catch(function(error){console.log("Here within the catch "+JSON.stringify(error));if(agentGuardService.AG_ERRORS.QUEUED_REQUEST===error){state.addStringResponse("Your device appears to be offline, but don't worry, I will process your message as soon as the connection is back and I will let you know.");}else{state.addSystemErrorToStack(5,error);}state.developer.logCurrentEventDurationWithStartTime("callCustomCap",start,Date.now());});};var runValidators=function runValidators(state){console.log("************* Validators method ****************");var start=Date.now();var _=state._;var activeIntent=state.activeIntent;var validationResult=true;if(activeIntent!==Intent.NO_INTENT()){_.each(Bot(state),function(intent){if(intent.intentId===activeIntent){if(intent.onError){state.onError=intent.onError;}try{if(intent.onValidation){state.developer.log("Starting onValidation for intent "+intent.intentId,LogEntrytype.INFO());intent.onValidation(state);if(state._.size(state.errorStack)>0){}}}catch(error){state.addSystemErrorToStack(5,error.message);}}});}state.developer.logCurrentEventDurationWithStartTime("runValidators",start,Date.now());return validationResult;};var runResolvers=function runResolvers(state){console.log("************* Resolvers method ****************");var start=Date.now();var _=state._;return new Promise(function(resolve,reject){console.log("In promise");var activeIntent=state.activeIntent;if(activeIntent.substring(0,5)==="_dev_"){if(activeIntent.substring(0,13)==="_dev_backend_"){return callCustomCap(state).then(function(){state.developer.logCurrentEventDurationWithStartTime("controller",start,Date.now());});}else{state.developer.processCommand(activeIntent);}resolve();}else if(activeIntent===""){console.log("Empty intent");state.addActiveIntent(Intent.NO_INTENT());resolve();}else if(activeIntent!==Intent.NO_INTENT()){console.log("Before loop");_.each(Bot(state),function(intent){if(intent.intentId===activeIntent){console.log("Found intent");if(intent.onResolution){state.developer.log("Starting onResolution for intent "+intent.intentId,LogEntrytype.INFO());return intent.onResolution(state).then(function(){resolve();state.developer.logCurrentEventDurationWithStartTime("runResolvers",start,Date.now());}).catch(function(error){state.addSystemErrorToStack(5,error.message);resolve();state.developer.logCurrentEventDurationWithStartTime("runResolvers",start,Date.now());});}else{state.addSystemErrorToStack(3);resolve();state.developer.logCurrentEventDurationWithStartTime("runResolvers",start,Date.now());}}});}});};var msgState={msgList:[]};var tell=function tell(msg,botContext){botContext.tell(msg);};var getGreetingIntent=function getGreetingIntent(state){var _=state._;var greetingIntent=null;_.each(Bot(state),function(intent){if(intent.intentId==="main"){greetingIntent=intent;return false;}});return greetingIntent;};var processGreeting=function processGreeting(state){console.log("Processing greeting");var start=Date.now();var greetingIntent=getGreetingIntent(state);state.developer.logCurrentEventDurationWithStartTime("searchForMainIntent",start,Date.now());state.addActiveIntent(greetingIntent.intentId,greetingIntent.logHistory,greetingIntent.silentIntent);if(greetingIntent){var onResolution=greetingIntent.onResolution;if(greetingIntent.onInit){var _start2=Date.now();greetingIntent.onInit(state);state.developer.logCurrentEventDurationWithStartTime("onInit",_start2,Date.now());}var _start=Date.now();if(onResolution){return onResolution(state).then(function(){state.developer.logCurrentEventDurationWithStartTime("mainOnResolution",_start,Date.now());});}}};var initialiseGreetingState=function initialiseGreetingState(conversation,user,stateParam,botContext){console.log("Initialising State");var emptyMessage=null;var state=new State(emptyMessage,conversation,user,"Edge",stateParam,botContext);state.resetWaitingForCustomCapCounter();return state;};var continueGreeting=function continueGreeting(botContext,previousMessages){var start=Date.now();var conversation=null;var user=null;var state={};var sendMessageParam=null;var startStorageCap=0;var endStorageCap=0;var startConvCap=0;var endConvCap=0;var startAuthCap=Date.now();var endAuthCap=0;var authContext=botContext.getCapability("authContext");return authContext.getAuthUser(botContext).then(function(usr){endAuthCap=Date.now();startConvCap=Date.now();user=usr;var conversationContext=botContext.getCapability("ConversationContext");return conversationContext.getConversationContext(botContext,user);}).then(function(context){endConvCap=Date.now();startStorageCap=Date.now();conversation=context;console.log("Conversation: "+JSON.stringify(conversation));deviceStorageUtil.conversation=conversation.conversationId;return deviceStorageUtil.getContext(botContext);}).then(function(stateFromStorage){endStorageCap=Date.now();var startState=Date.now();state=initialiseGreetingState(conversation,user,stateFromStorage,botContext);state.developer.logCurrentEventDurationWithStartTime("loadAuthCap",startAuthCap,endAuthCap);state.developer.logCurrentEventDurationWithStartTime("loadConversationCap",startConvCap,endConvCap);state.developer.logCurrentEventDurationWithStartTime("loadStorageCap",startStorageCap,endStorageCap);state.developer.logCurrentEventDurationWithStartTime("initialiseGreetingState",startState,Date.now());return processGreeting(state);}).then(function(){console.log("Setting greeting true");console.log(JSON.stringify(state.getAllProperties()));state.fromGreeting=true;return view(state,botContext);}).then(function(){if(state.sendMessageParam){sendMessageParam=state.sendMessageParam;state.sendMessageParam=null;}state.developer.logCurrentEventDurationWithStartTime("allGreeting",start,Date.now());return state.save();}).then(function(){console.log("============> Before If");if(sendMessageParam){console.log("============> Found the send message "+JSON.stringify(sendMessageParam));var message={messageFromUser:sendMessageParam};if(typeof sendMessageParam==="string"){message.messageType="string";}else{message.messageType="object";}return next(message,{},previousMessages,botContext);}}).then(function(){return{status:200};}).catch(function(error){return tell("Something wrong has happened "+error.message,botContext);});};var greeting=function greeting(state,previousMessages,botContext){console.log("************* Greeting method ****************");iAmTheOne="Initialised";if(state.reset){return continueGreeting(botContext,previousMessages);}else{var archiveUtils=botContext.getCapability("archiveUtils");return archiveUtils.overrideBotForArchive(this,msgState,botContext).then(function(){console.log("************* First then ****************");return archiveUtils.overrideTellForArchive(tell,msgState,botContext);}).then(function(newTell){tell=newTell;return continueGreeting(botContext,previousMessages);});}};var runPredictors=function runPredictors(state){var start,_,predictors,sortedPredictions,theBot,index,intent,predictionObject,predictor,_index;return regeneratorRuntime.async(function runPredictors$(_context86){while(1){switch(_context86.prev=_context86.next){case 0:start=Date.now();_=state._;console.log("*************** Running predictors ******************");if(!(_.size(state.smartSuggestionsArray)===0&&!state.blockSuggestions)){_context86.next=27;break;}predictors=false;sortedPredictions=[];theBot=Bot(state);index=0;case 8:if(!(index<theBot.length)){_context86.next=26;break;}intent=theBot[index];predictionObject={};if(!(_.size(intent.suggestionsArray)>0)){_context86.next=23;break;}predictor=intent.onPrediction;if(!predictor){_context86.next=20;break;}predictors=true;_context86.next=17;return regeneratorRuntime.awrap(predictor());case 17:predictionObject.weight=_context86.sent;_context86.next=21;break;case 20:predictionObject.weight=1;case 21:predictionObject.suggestionsArray=intent.suggestionsArray;if(predictionObject.weight>0){_index=_.sortedIndexBy(sortedPredictions,predictionObject,"weight");sortedPredictions.splice(_index,0,predictionObject);}case 23:index++;_context86.next=8;break;case 26:if(predictors){_.each(sortedPredictions,function(predictionObject){state.addSmartSuggestionsArray(predictionObject.suggestionsArray);});state.smartSuggestionsArray=_.reverse(state.smartSuggestionsArray);}case 27:state.developer.logCurrentEventDurationWithStartTime("runPredictors",start,Date.now());case 28:case'end':return _context86.stop();}}},null,_this);};var controller=function controller(state){var start=Date.now();var _=state._;console.log("************* Controller method ****************");return state.online().then(function(online){state.amIOnline=online;return runMatchers(state).then(function(){if(state.toCustomCap){return callCustomCap(state).then(function(){state.developer.logCurrentEventDurationWithStartTime("controller",start,Date.now());});}else{console.log(state.messageTypeFromUser);if(state.messageTypeFromUser==="form_response"){var formFromUser=state.messageFromUser;console.log(formFromUser.formId);var form=state.getForm(formFromUser.formId);if(form.isOpen){var formAction=formFromUser.action;var actionField=formFromUser.currentField;console.log("Running ",formAction);if(formAction===Form.CONFIRM_FORM_ACTION()){console.log("Running onSubmit");form.fields=formFromUser.fields;state.addActiveIntent(form.formId);form.onSubmit(form);}else if(formAction===Form.CANCEL_FORM_ACTION()){if(form.onCancel){console.log("Running form onCancel");form.onCancel(form);}else{console.log("No cancel defined for form. sending silent response");state.addResponse("silent",{});}}else if(formAction===Form.CLOSE_FORM_ACTION()){if(form.onCancel){console.log("Running onClose");form.onClose(form);}else{console.log("No close defined for form. sending silent response");state.addResponse("silent",{});}}else if(formAction===Form.MOVE_FORM_ACTION()){console.log("Running move");if(actionField){var field=form.getField(actionField);field.value=formFromUser.currentFieldValue;if(field.onMoveOut){console.log("Running onMove");var validationResponse=field.onMoveOut(form);state.addResponse("form_live_changes",{result:validationResponse,options:{formId:form.formId,action:"validation"}});}else{console.log("No move defined for form. sending silent response");state.addResponse("silent",{});}}else{console.log("No field in reply from form");state.addResponse("silent",{});}}if(formAction!==Form.MOVE_FORM_ACTION()&&formAction!==Form.SEARCH_FORM_ACTION()){form.closeForm();}}else{console.log("Adding silent response");state.addResponse("silent",{});}state.developer.logCurrentEventDurationWithStartTime("controller",start,Date.now());}else{console.log(state.activeIntent);if(!state.promptAlive||state.activeIntent.substring(0,5)==="_dev_"){if(runValidators(state)){return runResolvers(state).then(function(){state.developer.logCurrentEventDurationWithStartTime("controller",start,Date.now());});}}}}}).catch(function(error){state.addSystemErrorToStack(5,error.message);});});};var view=function view(state,botContext){console.log("************* View method ****************");var _=state._;var start=Date.now();return new Promise(function _callee85(resolve,reject){var smartSuggestions,MessageForSuggestions,messageForSuggestions;return regeneratorRuntime.async(function _callee85$(_context87){while(1){switch(_context87.prev=_context87.next){case 0:console.log("Suggestions before predictors: "+JSON.stringify(state.smartSuggestionsArray));console.log("Intent History "+JSON.stringify(state._intentHistory));console.log("Active Intent "+state.activeIntent);_context87.next=5;return regeneratorRuntime.awrap(runPredictors(state));case 5:console.log("Suggestions after predictors: "+JSON.stringify(state.smartSuggestionsArray));state.developer.debug("Start processing responses");if(state.inError){console.log(JSON.stringify(state.errorStack));state.onError(state);}else{if(!state.fromGreeting&&(state.responsesArray.length===0&&state.smartSuggestionsArray.length===0&&!state.sendMessageParam&&!state.toCustomCap||state.activeIntent===Intent.NO_INTENT())){console.log("Going to no intent");state.addStringResponse(NO_INTENT_MESSAGE);}}state.removeActiveIntent();if(!state.silentIntent){_context87.next=15;break;}console.log("Exiting view due to silent intent");state.clearResponseArray();state.clearError();resolve();return _context87.abrupt('return');case 15:if(state.fromGreeting){state.fromGreeting=false;}state.setDefaultSmartSuggestions(Bot(state));smartSuggestions=state.smartSuggestionsArray;console.log("Before evaluating responses");if(_.size(state.responsesArray)>0){_.each(state.responsesArray,function(response){var Message=state.context.getCapability("Message");var message=new Message();if(response.type===state.messageTypes.MESSAGE_TYPE_STRING){console.log("I am trying to tell something here");tell(response.message,state.context);}else if(response.type===state.messageTypes.MESSAGE_TYPE_WEB_CARD){var cards=response.message.cards;var previews=response.message.previews;message.webCard(cards,previews);tell(message,state.context);}else if(response.type===state.messageTypes.MESSAGE_TYPE_FORM2){console.log("************* Form capability ****************");var form=response.message;console.log("In view Form instance of Form? "+form instanceof Form);form.openForm();console.log(JSON.stringify(form.fields));console.log(JSON.stringify(form.options));message.form2Message(form.fields,form.options);tell(message,state.context);}else if(response.type==="form_live_changes"){console.log("Live form change "+JSON.stringify(response.message));if(response.message.result){message.form2Message(response.message.result,response.message.options);}else{message.form2Message(response.message.options);}tell(message,state.context);}else if(response.type==="form_close"){if(message.closeFormMessage){message.closeFormMessage(response.message);tell(message,state.context);}}else if(response.type===state.messageTypes.MESSAGE_TYPE_SMART_SUGGESTIONS){smartSuggestions=response.message;}else if(response.type===state.messageTypes.MESSAGE_TYPE_TABLE){console.log("printing a table");if(state.conversation.client===State.WEBCLIENT()){var table=response.message;message.tableMessage(table.rows,table.options);tell(message,state.context);}else{var msg="Tables are not yet available in your client";state.addSystemErrorToStack(5,msg);tell(msg,state.context);}}else if(response.type==="data_card"){console.log("printing a card");if(state.conversation.client===State.MOBILECLIENT()){var list=response.message;console.log(JSON.stringify(list));message.dataCard(list);tell(message,state.context);}else{var _msg="Data cards are not yet available in your client";state.addSystemErrorToStack(5,_msg);tell(_msg,state.context);}}else if(response.type===state.messageTypes.MESSAGE_TYPE_CARDS){console.log("printing the new cards");var _list=response.message;console.log(JSON.stringify(_list));message.cards(_list);tell(message,state.context);}else if(response.type===state.messageTypes.MESSAGE_TYPE_MAP){var map=response.message;var mapObject={region:map.region,markers:_.get(map,"markers"),polylines:_.get(map,"polylines"),planeRoutes:_.get(map,"planeRoutes"),cards:_.get(map,"cards")};console.log("Printing Map "+JSON.stringify(mapObject));message.mapMessage(mapObject,map.options);tell(message,state.context);}else if(response.type===state.messageTypes.MESSAGE_TYPE_STD_NOTIFICATION){console.log("Printing standard notification:: ",response.message);message.standardNotification(response.message);tell(message,state.context);}else if(response.type===state.messageTypes.MESSAGE_TYPE_CRITICAL_NOTIFICATION){message.criticalNotification(response.message);tell(message,state.context);}else if(response.type==="stripe"){if(state.client===State.MOBILECLIENT()){var _msg2="Message type not supported on this client";state.addSystemErrorToStack(5,_msg2);tell(_msg2,state.context);}else{var _response$message=response.message,amount=_response$message.amount,currency=_response$message.currency,description=_response$message.description;var transactionId=state.orders.createNewStripeTransaction(amount,currency,description);var payments=state.context.getCapability("Stripe");payments.startPayment(transactionId,amount,currency,description,state.context);}}else if(response.type===state.messageTypes.MESSAGE_TYPE_CHART){var chart=response.message;message.chartMessage(chart.data,chart.options);tell(message,state.context);}else if(response.type==="prompt"){var promptEntity=response.message;var fields=state.getForm(promptEntity.form).fields;var field=fields[promptEntity.promptIndex];state.promptAlive=promptEntity.name;tell(field.prompt,state.context);if(field.type==="search_box"){var searchBox=state.getSearchBox(field.id);message.searchBoxMessage(searchBox.getMessageWith());state.currentSearchBox=searchBox.id;smartSuggestions=[];tell(message,state.context);}}else if(response.type==="search_box"){var _searchBox=void 0;if(response.message.action){_searchBox=state.getSearchBox(response.message.id);}else{_searchBox=state.getSearchBox(response.message);}message.searchBoxMessage(_searchBox.getMessageWith(response.message.action,response.message.results));state.currentSearchBox=_searchBox.id;smartSuggestions=[];tell(message,state.context);}else if(response.type==="slider"){message.sliderMessage(response.message.list,response.message.options);tell(message,state.context);}else if(response.type==="oldChart"){message.chartMessage({chart_type:"scatter",data:response.message});tell(message,state.context);}else if(response.type===state.messageTypes.MESSAGE_TYPE_VIDEO){message.videoMessage(response.message);tell(message,state.context);}else if(response.type!=="silent"){var _msg3="Message type not supported";state.addSystemErrorToStack(5,_msg3);tell(_msg3,state.context);}});}else{console.log("Nothing in view");}state.clearResponseArray();state.clearError();MessageForSuggestions=state.context.getCapability("Message");messageForSuggestions=new MessageForSuggestions();if(_.size(state.smartSuggestionsArray)>0){messageForSuggestions.smartSuggestions(smartSuggestions);console.log(JSON.stringify(smartSuggestions));state.developer.debug("Displaying suggestions "+JSON.stringify(smartSuggestions));tell(messageForSuggestions,state.context);}else{if(state.blockSuggestions){messageForSuggestions.smartSuggestions([]);tell(messageForSuggestions,state.context);}}state.clearSmartSuggestionsArray();state.resetOnErrorMethod();state.developer.debug("Finished processing responses");state.toCustomCap=false;resolve();state.developer.logCurrentEventDurationWithStartTime("view",start,Date.now());case 31:case'end':return _context87.stop();}}},null,_this);});};var next=function next(msg,stateParam,previousMessages,botContext){console.log("************* Next method ****************");var start=Date.now();var startStorageCap=0;var endStorageCap=0;var startConvCap=0;var endConvCap=0;var startAuthCap=Date.now();var endAuthCap=0;var authContext=botContext.getCapability("authContext");var conversation=null;var user=null;var state=null;var sendMessageParam=null;return authContext.getAuthUser(botContext).then(function(usr){endAuthCap=Date.now();user=usr;var conversationContext=botContext.getCapability("ConversationContext");startConvCap=Date.now();return conversationContext.getConversationContext(botContext,user);}).then(function(context){endConvCap=Date.now();conversation=context;deviceStorageUtil.conversation=conversation.conversationId;console.log(JSON.stringify(conversation));startStorageCap=Date.now();return deviceStorageUtil.getContext(botContext);}).then(function(stateFromStorage){console.log("State from storage "+JSON.stringify(stateFromStorage));var startState=Date.now();endStorageCap=Date.now();state=new State(msg,conversation,user,"Edge",stateFromStorage,botContext);state.developer.logCurrentEventDurationWithStartTime("loadAuthCap",startAuthCap,endAuthCap);state.developer.logCurrentEventDurationWithStartTime("loadConversationCap",startConvCap,endConvCap);state.developer.logCurrentEventDurationWithStartTime("loadStorageCap",startStorageCap,endStorageCap);state.developer.logCurrentEventDurationWithStartTime("initialiseGreetingState",startState,Date.now());state.developer.debug("State initialised");var greetingIntent=getGreetingIntent(state);if(greetingIntent.onInit){greetingIntent.onInit(state);}if(msg.requestId){if(!state.markRequestIdProcessed(msg.requestId)){return Promise.resolve("ignore");}}console.log("Before syncing the state");state.syncWithBackendState(stateParam);if(state.intentResolved||state._.size(state.errorStack)>0){console.log("Intent resolved apparently");state.intentResolved=false;return Promise.resolve();}else{return controller(state);}}).then(function(noNeedForView){console.log("Entered view block");if(noNeedForView){console.log("Got a duplicated call");return noNeedForView;}return view(state,botContext);}).then(function(noNeedForView){console.log("Entered state save block");console.log("Last print "+JSON.stringify(state.getAllProperties()));botContext.wait(false);if(!state.silentIntent&&(state.waitingCustomCap>0&&state.messageTypeFromUser!=="search_box_response"&&state.messageTypeFromUser!=="form_response"||state.sendMessageParam)){console.log("Setting to wait");botContext.wait(true);}if(state.sendMessageParam){sendMessageParam=state.sendMessageParam;state.sendMessageParam=null;}state.developer.logCurrentEventDurationWithStartTime("totalNextMethod",start,Date.now());if(noNeedForView!=="ignore"){return state.save();}}).then(function(){console.log("Entered sendMessage block");if(sendMessageParam){console.log("Sending a new message");var message={messageFromUser:sendMessageParam};var toGreeting=false;if(typeof sendMessageParam==="string"){message.messageType="string";}else{message.messageType="object";if(sendMessageParam.intentId&&sendMessageParam.intentId==="@@reset"){toGreeting=true;}}if(toGreeting){return greeting({reset:true},previousMessages,botContext);}else{return next(message,{},previousMessages,botContext);}}}).then(function(){return{status:200};}).catch(function(error){console.log("Catch block");if(state instanceof State){state.developer.debug("Error catched in next block");state.addSystemErrorToStack(5,error.message);return view(state,botContext).then(function(){state.save();});}else{console.log("Something very wrong "+error.message);}}).then(function(){console.log("Are we here?");return{status:200};});};var asyncResult=function asyncResult(result,stateParam,previousMessages,botContext){console.log("************ Async Results *************");var utils=botContext.getCapability("Utils");var _=utils.Lodash;var state=_.get(result,"details[0].message");var requestId=_.get(result,"requestUuid");if(state&&requestId&&requestId!==""){var contentType=_.get(result,"contentType");var createdOn=_.get(result,"createdOn");var createdBy=_.get(result,"createdBy");var messageId=_.get(result,"messageId");var message={messageDate:createdOn,createdBy:createdBy,uuid:messageId,requestId:requestId,contentType:contentType};if(contentType===MessageTypes.BACKEND_RESPONSE()){message.messageType=MessageTypes.BACKEND_RESPONSE();}else{message.messageType=MessageTypes.BOT_TO_BOT();message.messageFromUser=state;}console.log("************* Data Received ****************");console.log(JSON.stringify(result));console.log("************* Data Received ****************");return next(message,state,previousMessages,botContext);}};var debug=function debug(state){return{localState:state};};var farewell=function farewell(msg,state,previousMessages,botContext){};return{done:farewell,init:greeting,next:next,debug:debug,asyncResult:asyncResult,version:"1.0.0"};})();