(function(){var PROFILE_PIC_BUCKET='profile-pics';var FormHandler={SIGN_UP_TIME:'SIGN_UP_TIME',LAST_RESET_TIME:'LAST_RESET_TIME',LAST_GREET_TIME:'LAST_GREET_TIME',LAST_RESET_GREET_TIME:'LAST_RESET_GREET_TIME',LAST_SIGNUP_GREET_TIME:'LAST_SIGNUP_GREET_TIME',DAY_MS:24*60*60*1000,HOUR_MS:60*60*100,signIn:function signIn(message,state,previousMessages,botContext){var formMsg=message.getMessage();var user={email:formMsg[1].value,password:formMsg[2].value};FormHandler.login(botContext,user,true);},signUp:function signUp(message,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');var _=botContext.getCapability('Utils').Lodash;var formMsg=message.getMessage();var user={given_name:formMsg[2].value,family_name:formMsg[3].value,name:formMsg[2].value+' '+formMsg[3].value,'custom:screenName':formMsg[4].value,email:formMsg[5].value,password:formMsg[6].value};botContext.wait(true);authContext.signupWithFrontm(botContext,user).then(function(){return DeviceStorageUtil.setInContext(FormHandler.SIGN_UP_TIME,_.now(),botContext);}).then(function(){botContext.wait(false);tell('A confirmation code, with a 24 hour validity, has been sent to your registered email address. You will have to enter it to complete the registration process.',botContext);botState.newUser=user;MenuHandler.showConfirmationCodeForm(message,state,previousMessages,botContext,user);}).catch(function(error){console.log('Signup error :',JSON.stringify(error));botContext.wait(false);tell(error.message,botContext);MenuHandler.showSignUpForm(message,state,previousMessages,botContext,user);});},signupConfirm:function signupConfirm(message,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');var formMsg=message.getMessage();var user={email:formMsg[1].value,confirmCode:formMsg[2].value};botContext.wait(true);authContext.confirmFrontmSignup(botContext,user).then(function(){return DeviceStorageUtil.removeFromContext(FormHandler.SIGN_UP_TIME,botContext);}).then(function(){botContext.wait(false);tell('Success!! You are now registered with FrontM',botContext);if(botState.newUser){tell('Logging you in now',botContext);var newUser=botState.newUser;delete botState.newUser;FormHandler.login(botContext,newUser,true);}else{tell('Now sign in entering your email and password',botContext);MenuHelper.showMenu(MENU.LOGIN,botContext);}}).catch(function(error){console.log('sign up confirm error :',JSON.stringify(error));botContext.wait(false);tell(error.message,botContext);tell("If you haven't yet signed up, then please choose that option from the menu. If you are already signed up with FrontM, then please sign in",botContext);MenuHelper.showMenu(MENU.LOGIN,botContext);});},resendConfirmationCode:function resendConfirmationCode(message,state,previousMessages,botContext){var _=botContext.getCapability('Utils').Lodash;var authContext=botContext.getCapability('authContext');var formMsg=message.getMessage();var user={email:formMsg[1].value};botContext.wait(true);authContext.resendConfirmationCode(botContext,user).then(function(){return DeviceStorageUtil.setInContext(FormHandler.SIGN_UP_TIME,_.now(),botContext);}).then(function(){botContext.wait(false);botContext.wait(false);tell('A new confirmation code, with a 24 hour validity, has been sent to your registered email address. Please enter it to complete the registration process.',botContext);botState.newUser=user;MenuHandler.showConfirmationCodeForm(message,state,previousMessages,botContext,user);}).catch(function(error){console.log('resend sign up confirm code error :',JSON.stringify(error));botContext.wait(false);tell(error.message,botContext);MenuHelper.showMenu(MENU.LOGIN,botContext);});},resetPassword:function resetPassword(message,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');var _=botContext.getCapability('Utils').Lodash;var formMsg=message.getMessage();var user={email:formMsg[1].value};botContext.wait(true);authContext.resetPassword(botContext,user).then(function(){return DeviceStorageUtil.setInContext(FormHandler.LAST_RESET_TIME,_.now(),botContext);}).then(function(){tell('A verification code, with a 60 minute validity, has been sent to your registered email address. You will have to enter it to complete the reset process',botContext);MenuHandler.showResetCodeForm(message,state,previousMessages,botContext,user);}).catch(function(error){botContext.wait(false);tell(error.message,botContext);tell("If you haven't yet signed up, then please choose that option from the menu",botContext);MenuHelper.showMenu(MENU.LOGIN,botContext);});},confirmResetPassword:function confirmResetPassword(message,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');var formMsg=message.getMessage();var user={email:formMsg[1].value,password:formMsg[2].value,verificationCode:formMsg[3].value};botContext.wait(true);authContext.confirmReset(botContext,user).then(function(){return DeviceStorageUtil.removeFromContext(FormHandler.LAST_RESET_TIME,botContext);}).then(function(){botContext.wait(false);tell('Success!! Your password has been reset',botContext);tell('Logging you in now with your new password',botContext);FormHandler.login(botContext,user,true);}).catch(function(error){console.log('reset confirm error :',JSON.stringify(error));botContext.wait(false);tell(error.message,botContext);MenuHelper.showMenu(MENU.LOGIN,botContext);});},login:function login(botContext,user,isFrontmLogin,providerId){botContext.wait(true);var authContext=botContext.getCapability('authContext');var loginPromise=null;if(isFrontmLogin){loginPromise=authContext.loginWithFrontm(botContext,user);}else{loginPromise=authContext.login(botContext,providerId);}loginPromise.then(function(user){botState.userLoggedIn=true;tell('Hi '+user.info.userName+'! Welcome aboard. FrontM here, the master bot of FrontM bot fleet',botContext);tell('Allow notifications?',botContext);MenuHelper.showMenu(MENU.PUSH_NOTIFICATION,botContext);}).catch(function(error){console.log('Login error :',error);if(error.code===0){botContext.wait(false);}else{if(isFrontmLogin){var msg=error.message||'Looks like you are not registered with us. Register with FrontM to access our chatbots';tell(msg,botContext);}else{tell('Error occurred while logging in',botContext);}}MenuHelper.showMenu(MENU.LOGIN,botContext);});},updateUserInfo:function updateUserInfo(msg,state,previousMessages,botContext){var _=botContext.getCapability('Utils').Lodash;var userDetails={};var newDomain=null;var addDomain=false;botContext.wait(true);var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(user){var userInfo=user.info||{};var dbDocument={};var screenName=msg.getMessage()[1].value||userInfo.screenName;var givenName=msg.getMessage()[2].value||userInfo.givenName;var lastName=msg.getMessage()[3].value||userInfo.surname;userDetails.screenName=screenName;userDetails.surname=lastName;userDetails.givenName=givenName;dbDocument.screenName=screenName;dbDocument.givenName=givenName;dbDocument.surname=lastName;var params={collection:'People',documents:[{key:{userId:user.userId},document:dbDocument}]};var agentGuardService=botContext.getCapability('agentGuardService');return agentGuardService.writeData(msg,botContext,user,previousMessages,params);}).then(function(){return authContext.updateUserDetails(userDetails,botContext);}).then(function(){tell('Done! Your details have been updated',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);}).catch(function(error){console.error('Error occurred while updating user details: ',error);tell('Error occurred: Unable to update your details',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);});},changeUserPwd:function changeUserPwd(msg,state,previousMessages,botContext){botContext.wait(true);var formMsg=msg.getMessage();var oldPassword=formMsg[3].value;var newPassword=formMsg[4].value;if(oldPassword===newPassword){botContext.wait(false);tell('Your new password must be different from your old password',botContext);return MenuHandler.showPwdChangeForm(msg,state,previousMessages,botContext);}var updatedUser={email:formMsg[2].value,oldPassword:oldPassword,newPassword:newPassword};var authContext=botContext.getCapability('authContext');authContext.updatePassword(updatedUser,botContext).then(function(){botContext.wait(false);tell('Your password has been updated',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);}).catch(function(error){console.log('Password update error :',JSON.stringify(error));botContext.wait(false);tell(error.message,botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);});},reportAccountHack:function reportAccountHack(msg,state,previousMessages,botContext){botContext.wait(true);var formMsg=msg.getMessage();var emailDetails=formMsg[1].value;var authContext=botContext.getCapability('authContext');return authContext.getAuthUser(botContext).then(function(user){var userInfo=user.info||{};var emailUserInfo={userName:userInfo.userName,emailAddress:userInfo.emailAddress,userId:userInfo.userId};var emailBody='User information: \n'+JSON.stringify(emailUserInfo,null,4)+'\n \n \nDetails reported by the user: \n'+emailDetails;var params={address:'support@frontm.com',body:emailBody,title:'User Hacked!'};var agentGuardService=botContext.getCapability('agentGuardService');return agentGuardService.sendEmail(null,botContext,user,null,params);}).then(function(){tell('I have reported your details to the support team. They should get in touch with you soon',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);});}};var MenuHandler={EMAIL_USER_DATA_CAPABILITY:'EmailUserData',ADD_DOMAIN_ROLE_CAPABILITY:'SubscribeDomainRole',MSG_QUOTA_CAPABILITY:'MessageQuotaCapability',showSignInForm:function showSignInForm(message,state,previousMessages,botContext){var Message=botContext.getCapability('Message');var formMsg=new Message();formMsg.formMessage([{id:1,title:'Enter your details to sign in',type:'title'},{id:2,title:'Email',type:'email_field',optional:false},{id:3,title:'Password',type:'password_field',optional:false},{id:4,title:'Login',type:'button',action:'signIn'}],'');tell(formMsg,botContext);},signInWithFacebook:function signInWithFacebook(message,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');var providers=authContext.getAuthProviders(botContext);FormHandler.login(botContext,null,false,providers.facebook);},signInWithGoogle:function signInWithGoogle(message,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');var providers=authContext.getAuthProviders(botContext);FormHandler.login(botContext,null,false,providers.google);},showSignUpForm:function showSignUpForm(message,state,previousMessages,botContext,user){user=user||botState.newUser||{};var Message=botContext.getCapability('Message');var formMsg=new Message();formMsg.formMessage([{id:1,title:'Enter your details',type:'title'},{id:2,text:'Password should be minimum 8 characters long with lower case, upper case, number and special characters in it',type:'text'},{id:3,title:'First Name',type:'text_field',optional:false,value:user.given_name},{id:4,title:'Last Name',type:'text_field',optional:false,value:user.family_name},{id:5,title:'Screen Name',type:'text_field',optional:false,value:user['custom:screenName']},{id:6,title:'Email',type:'email_field',optional:false,value:user.email},{id:7,title:'Password',type:'password_field',optional:false,retry:true},{id:8,title:'Register',type:'button',action:'signUp'}],'');tell(formMsg,botContext);},showConfirmationCodeForm:function showConfirmationCodeForm(message,state,previousMessages,botContext,user){user=user||{};var Message=botContext.getCapability('Message');var formMsg=new Message();formMsg.formMessage([{id:1,title:'Enter your confirmation code',type:'title'},{id:2,title:'Email',type:'text_field',optional:false,value:user.email},{id:3,title:'Code',type:'text_field',optional:false,value:user.confirmCode},{id:4,title:'Confirm',type:'button',action:'signupConfirm'}],'');tell(formMsg,botContext);},showResendConfirmationCodeForm:function showResendConfirmationCodeForm(message,state,previousMessages,botContext){var user=botState.newUser||{};var Message=botContext.getCapability('Message');var formMsg=new Message();formMsg.formMessage([{id:1,title:'Enter your details',type:'title'},{id:2,title:'Email',type:'text_field',optional:false,value:user.email},{id:3,title:'Resend code',type:'button',action:'resendConfirmationCode'}],'');tell(formMsg,botContext);},showResetForm:function showResetForm(message,state,previousMessages,botContext,user){user=user||{};var Message=botContext.getCapability('Message');var formMsg=new Message();formMsg.formMessage([{id:1,title:'Enter your details',type:'title'},{id:2,title:'Email',type:'text_field',optional:false,value:user.email},{id:3,title:'Reset',type:'button',action:'resetPassword'}],'');tell(formMsg,botContext);},showResetCodeForm:function showResetCodeForm(message,state,previousMessages,botContext,user){user=user||{};var Message=botContext.getCapability('Message');var formMsg=new Message();formMsg.formMessage([{id:1,title:'Enter your verification code',type:'title'},{id:2,title:'Email',type:'text_field',optional:false,value:user.email},{id:3,title:'New Password',type:'password_field',optional:false},{id:4,title:'Code',type:'text_field',optional:false},{id:5,title:'Reset',type:'button',action:'confirmResetPassword'}],'');tell(formMsg,botContext);},showUserForm:function showUserForm(message,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(usr){var Message=botContext.getCapability('Message');var message=new Message();message.formMessage([{id:1,title:'Enter your updated details',type:'title'},{id:2,title:'Screen Name',value:usr.info.screenName,type:'text_field',optional:false},{id:3,title:'First Name',value:usr.info.givenName,type:'text_field',optional:false},{id:4,title:'Last Name',value:usr.info.surname,type:'text_field',optional:false},{id:5,title:'Update',type:'button',action:'updateUserInfo'}],'');tell(message,botContext);});},showPwdChangeForm:function showPwdChangeForm(message,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(usr){var Message=botContext.getCapability('Message');var message=new Message();message.formMessage([{id:1,title:'Enter your new password',type:'title'},{id:2,text:'The new password should be different from your old password minimum 8 characters long with lower case, upper case, number and special characters in it',type:'text'},{id:3,title:'Email',type:'text_field',value:usr.info.emailAddress,editable:false},{id:4,title:'Old Password',type:'password_field',optional:false},{id:5,title:'New Password',type:'password_field',optional:false,retry:true},{id:6,title:'Change Password',type:'button',action:'changeUserPwd'}],'');tell(message,botContext);});},registerDevice:function registerDevice(message,state,previousMessages,botContext){var user=null;var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(usr){user=usr;var notification=botContext.getCapability('Notification');return notification.register();}).then(function(notificationDeviceInfo){botContext.wait(true);var agentGuardService=botContext.getCapability('agentGuardService');return agentGuardService.registerDevice(notificationDeviceInfo,botContext,user);}).then(function(){tell('Push notifications are activated for your device',botContext);if(botState.menuToShow===MENU.PUSH_NOTIFICATION){tell('Feel free to personalise the configuration from the menu below',botContext);tell("Touch the back arrow above to go to the home screen, your FrontM timeline. You will find collaboration tools in the menu there, and I'm always around to assist.",botContext);}return MenuHelper.showMenu(MENU.MAIN,botContext);});},deregisterDevice:function deregisterDevice(message,state,previousMessages,botContext){var user=null;var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(usr){user=usr;var notification=botContext.getCapability('Notification');return notification.deregister();}).then(function(notificationDeviceInfo){botContext.wait(true);var agentGuardService=botContext.getCapability('agentGuardService');return agentGuardService.deregisterDevice(notificationDeviceInfo,botContext,user);}).then(function(){tell('Push notifications are deactivated for your device',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);});},showNoPushNotificationMsg:function showNoPushNotificationMsg(message,state,previousMessages,botContext){tell('No problem, you can always ask me to activate them returning to this conversation',botContext);tell('Feel free to personalise the configuration from the menu below',botContext);tell("Touch the back arrow above to go to the home screen, your FrontM timeline. You will find collaboration tools in the menu there, and I'm always around to assist.",botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);},showConfigMenu:function showConfigMenu(message,state,previousMessages,botContext){return MenuHelper.showMenu(MENU.CONFIG,botContext);},showAccountMenu:function showAccountMenu(message,state,previousMessages,botContext){return MenuHelper.showMenu(MENU.ACCOUNT,botContext);},showAccountHackMenu:function showAccountHackMenu(message,state,previousMessages,botContext){tell('I will require more details about the hack and then I will let the administrators know about the issue',botContext);tell("Do you confirm you think you've been hacked?",botContext);return MenuHelper.showMenu(MENU.REPORT_ACCOUNT_HACK,botContext);},showLogoutMenu:function showLogoutMenu(message,state,previousMessages,botContext){return MenuHelper.showMenu(MENU.LOGOUT,botContext);},showDeleteDataMenu:function showDeleteDataMenu(message,state,previousMessages,botContext){tell('All your data will be permanently deleted. Do you want to proceed?',botContext);return MenuHelper.showMenu(MENU.DELETE_DATA,botContext);},showNetworkControlMenu:function showNetworkControlMenu(message,state,previousMessages,botContext){return MenuHelper.showMenu(MENU.NETWORK_CONTROL,botContext);},showArchiveMessages:function showArchiveMessages(message,state,previousMessages,botContext){tell('Do you want to archive messages in all bots?',botContext);return MenuHelper.showMenu(MENU.ARCHIVE_MSGS,botContext);},showStopArchiveMessages:function showStopArchiveMessages(message,state,previousMessages,botContext){tell('Do you want to stop archiving messages in all bots?',botContext);return MenuHelper.showMenu(MENU.STOP_ARCHIVE_MSGS,botContext);},showNetworkUsageMenu:function showNetworkUsageMenu(message,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(user){var agentGuardService=botContext.getCapability('agentGuardService');botContext.wait(true);var params={action:'getUserQuota'};return agentGuardService.executeCustomCapability(MenuHandler.MSG_QUOTA_CAPABILITY,params,true,undefined,botContext,user);}).then(function(data){var _=botContext.getCapability('Utils').Lodash;var msgCount=data[0]||{};if(_.isEmpty(msgCount)){tell('Looks like you have not used any bots yet. You do not have messages in your bots',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);}else{var botUsageOptions=[];_.forIn(msgCount,function(value,key){var used=value.used,available=value.available,assigned=value.assigned;var quota=[{key:'used',value:used}];if(available){quota.push({key:'available',value:available});}if(assigned){quota.push({key:'assigned',value:assigned});}botUsageOptions.push({title:key,data:{contact_info:quota}});});tell('Following is your message quotas across all your bots:',botContext);return MenuHelper.showMenu(botUsageOptions,botContext);}});},changePollingStrategy:function changePollingStrategy(message,state,previousMessages,botContext){var PollingStrategyTypes=botContext.getCapability('PollingStrategyTypes');var _=botContext.getCapability('Utils').Lodash;var selectedOption=message.getMessage();var chosenStrategy=_.get(PollingStrategyTypes,selectedOption.toLowerCase())||'gsm';var Settings=botContext.getCapability('Settings');return Settings.setPollingStrategy(chosenStrategy).then(function(){if(selectedOption==='Manual'){tell('You are in Manual Network Mode. You are consuming 0KB background data currently. You will need to touch the refresh button to fetch messages.',botContext);}else{tell('Network control has been updated to '+selectedOption,botContext);}return MenuHelper.showMenu(MENU.MAIN,botContext);});},showActivateBotMsg:function showActivateBotMsg(message,state,previousMessages,botContext){tell('If a company has invited you to use their Bots, please scan the QR Code or type the invitation code. Please note that invitation code is case sensitive',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);},emailMyData:function emailMyData(message,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(user){var agentGuardService=botContext.getCapability('agentGuardService');botContext.wait(true);var params={action:'Email'};return agentGuardService.executeCustomCapability(MenuHandler.EMAIL_USER_DATA_CAPABILITY,params,false,undefined,botContext,user);}).then(function(){tell('I will email your data to the email address you have used to login now. You should receive it shortly.',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);});},logout:function logout(message,state,previousMessages,botContext){var goodbyeMsg=null;var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(user){goodbyeMsg='Goodbye '+user.info.userName+', I will miss you and expect you back soon';return authContext.logout(botContext);}).then(function(){tell(goodbyeMsg||'Successfully logged out',botContext);return MenuHelper.showMenu(MENU.LOGIN,botContext);});},showNoLogoutMsg:function showNoLogoutMsg(message,state,previousMessages,botContext){tell('You can use this bot to logout anytime',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);},deleteDataAndLogout:function deleteDataAndLogout(message,state,previousMessages,botContext){var username=null;var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(user){username=user.info.userName;return authContext.deleteDataAndLogout(botContext);}).then(function(){tell('Goodbye '+username+'. Sorry to see you go',botContext);tell('Should you wish to sign up with FrontM again, you can choose one of the options in the menu below',botContext);return MenuHelper.showMenu(MENU.LOGIN,botContext);}).catch(function(){tell('We seem to be experiencing network difficulties at the moment. Please contact the support team and they will be able to help you',botContext);return MenuHelper.showMenu(MENU.LOGIN,botContext);});},showNoDeleteDataMsg:function showNoDeleteDataMsg(message,state,previousMessages,botContext){return MenuHelper.showMenu(MENU.MAIN,botContext);},enableArchiveMsgs:function enableArchiveMsgs(message,state,previousMessages,botContext){var _=botContext.getCapability('Utils').Lodash;botContext.wait(true);var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(user){var dbDoc={};dbDoc[MenuHelper.ARCHIVE_MSGS_SETTING]=true;var params={collection:'People',documents:[{key:{userId:user.userId},document:dbDoc}]};var agentGuardService=botContext.getCapability('agentGuardService');return agentGuardService.writeData(message,botContext,user,previousMessages,params);}).then(function(){return authContext.updateSetting(MenuHelper.ARCHIVE_MSGS_SETTING,true,botContext);}).then(function(){tell('Done! Messages will be archived in all the bots you have installed or will install',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);}).catch(function(error){console.error('Error occurred while updating user details: ',error);tell('Error occurred: Unable to enable archiving your messages. Please let the support team now',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);});},disableArchiveMsgs:function disableArchiveMsgs(message,state,previousMessages,botContext){var _=botContext.getCapability('Utils').Lodash;botContext.wait(true);var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(user){var dbDoc={};dbDoc[MenuHelper.ARCHIVE_MSGS_SETTING]=false;var params={collection:'People',documents:[{key:{userId:user.userId},document:dbDoc}]};var agentGuardService=botContext.getCapability('agentGuardService');return agentGuardService.writeData(message,botContext,user,previousMessages,params);}).then(function(){return authContext.updateSetting(MenuHelper.ARCHIVE_MSGS_SETTING,false,botContext);}).then(function(){tell('Done! Archiving of your messages has been disabled now',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);}).catch(function(error){console.error('Error occurred while updating user details: ',error);tell('Error occurred: Unable to enable archiving your messages. Please let the support team now',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);});},showNoArchiveMsg:function showNoArchiveMsg(message,state,previousMessages,botContext){return MenuHelper.showMenu(MENU.MAIN,botContext);},showAccountHackForm:function showAccountHackForm(message,state,previousMessages,botContext){var Message=botContext.getCapability('Message');var formMsg=new Message();formMsg.formMessage([{id:1,title:'Enter the details of your account hacking',type:'title'},{id:2,title:'Details',type:'text_area',optional:false},{id:3,title:'Report',type:'button',action:'reportAccountHack'}],'');tell(formMsg,botContext);},showNoHackMsg:function showNoHackMsg(message,state,previousMessages,botContext){tell('Ok, no problem',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);},uploadProfilePic:function uploadProfilePic(message,state,previousMessages,botContext){tell('Please choose a profile picture from your library',botContext);var authContext=botContext.getCapability('authContext');var _=botContext.getCapability('Utils').Lodash;var user=null;authContext.getAuthUser(botContext).then(function(usr){user=usr;var Media=botContext.getCapability('Media');return Media.pickMediaFromLibrary();}).then(function(media){if(media.cancelled){return null;}else{botContext.wait(true);var Resource=botContext.getCapability('Resource');var ResourceTypes=botContext.getCapability('ResourceTypes');return Resource.uploadFile(media.base64,media.uri,PROFILE_PIC_BUCKET,user.userId,ResourceTypes.Image,user,true);}}).then(function(fileUrl){if(_.isNull(fileUrl)){tell('You have disabled access to media library. Please enable access to upload a profile picture',botContext);}else{tell('Got it. This is your new profile picture',botContext);var Message=botContext.getCapability('Message');var _message=new Message();_message.imageMessage(fileUrl);tell(_message,botContext);}return MenuHelper.showMenu(MENU.MAIN,botContext);});},addDomainAndRoleToUser:function addDomainAndRoleToUser(msg,state,previousMessages,botContext){var _=botContext.getCapability('Utils').Lodash;botContext.wait(true);delete botState.activatePartnerBots;var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(user){var strMsg=msg.getMessage();var agentGuardService=botContext.getCapability('agentGuardService');return agentGuardService.executeCustomCapability(MenuHandler.ADD_DOMAIN_ROLE_CAPABILITY,{verificationCode:strMsg},true,undefined,botContext,user);}).then(function(data){if(_.isEmpty(_.compact(data))){tell("You should now be able to access the featured partner's bot",botContext);}else{tell('I do not recognise this code. Can you check if you entered that right?',botContext);}return MenuHelper.showMenu(MENU.MAIN,botContext);}).catch(function(error){console.error('Error occurred while updating user details: ',error);tell('Error occurred: Unable to activate the enterprise bots. Please reach out to the support team.',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);});}};var MENU={LOGIN:{menuRenderer:'showLoginMenu',options:[{title:'Login with Google',action:MenuHandler.signInWithGoogle},{title:'Login with Facebook',action:MenuHandler.signInWithFacebook},{title:'Sign in as an existing FrontM user',action:MenuHandler.showSignInForm},{title:'Sign up as a new FrontM user',action:MenuHandler.showSignUpForm},{title:'Reset FrontM user password',action:MenuHandler.showResetForm}]},PUSH_NOTIFICATION:{options:[{title:'Yes',action:MenuHandler.registerDevice},{title:'No',action:MenuHandler.showNoPushNotificationMsg}]},MAIN:{options:[{title:'Configuration',action:MenuHandler.showConfigMenu},{title:'My Account',action:MenuHandler.showAccountMenu},{title:'Logout',action:MenuHandler.showLogoutMenu}]},ACCOUNT:{options:[{title:'Add/change profile picture',action:MenuHandler.uploadProfilePic},{title:'Update user details',action:MenuHandler.showUserForm},{title:'Change password',action:MenuHandler.showPwdChangeForm},{title:'Activate Enterprise Bots',action:MenuHandler.showActivateBotMsg},{title:'Email my data',action:MenuHandler.emailMyData},{title:'My account has been hacked',action:MenuHandler.showAccountHackMenu}]},LOGOUT:{options:[{title:'Yes',action:MenuHandler.logout},{title:'No',action:MenuHandler.showNoLogoutMsg},{title:'Delete my data',action:MenuHandler.showDeleteDataMenu}]},DELETE_DATA:{options:[{title:'Yes',action:MenuHandler.deleteDataAndLogout},{title:'No',action:MenuHandler.showNoDeleteDataMsg}]},REPORT_ACCOUNT_HACK:{options:[{title:'Yes',action:MenuHandler.showAccountHackForm},{title:'No',action:MenuHandler.showNoHackMsg}]},CONFIG:{menuRenderer:'showConfigMenu',options:[{title:'Activate Push Notifications',action:MenuHandler.registerDevice,activateNotifications:true},{title:'Deactivate Push Notifications',action:MenuHandler.deregisterDevice,activateNotifications:false},{title:'Network control',action:MenuHandler.showNetworkControlMenu},{title:'Network usage',action:MenuHandler.showNetworkUsageMenu},{title:'Activate message archiving',action:MenuHandler.showArchiveMessages,archiveMessages:true},{title:'Stop archiving my messages',action:MenuHandler.showStopArchiveMessages,archiveMessages:false}]},ARCHIVE_MSGS:{options:[{title:'Yes',action:MenuHandler.enableArchiveMsgs},{title:'No',action:MenuHandler.showNoArchiveMsg}]},STOP_ARCHIVE_MSGS:{options:[{title:'Yes',action:MenuHandler.disableArchiveMsgs},{title:'No',action:MenuHandler.showNoArchiveMsg}]},NETWORK_CONTROL:{options:[{title:'Manual',action:MenuHandler.changePollingStrategy},{title:'Satellite',action:MenuHandler.changePollingStrategy},{title:'Terrestrial',action:MenuHandler.changePollingStrategy},{title:'Automatic',action:MenuHandler.changePollingStrategy}]}};var botState={};var MenuHelper={ARCHIVE_MSGS_SETTING:'archiveMessages',showMenu:function showMenu(menuToShow,botContext){var menuRenderer=menuToShow.menuRenderer||null;var _=botContext.getCapability('Utils').Lodash;if(menuRenderer===null){botState.menuToShow=menuToShow.options||menuToShow;var Message=botContext.getCapability('Message');var message=new Message();var options=_.map(botState.menuToShow,function(option){var finalOption={title:option.title};if(option.data){finalOption.data=option.data;}return finalOption;});message.sliderMessage(options,{smartReply:true});tell(message,botContext);}else{MenuHelper[menuRenderer](botContext,_);}},showConfigMenu:function showConfigMenu(botContext,_){var authContext=botContext.getCapability('authContext');var notification=botContext.getCapability('Notification');var isArchiveMsgsEnabled=false;authContext.getSetting(MenuHelper.ARCHIVE_MSGS_SETTING,false,botContext).then(function(archiveMessagesSetting){isArchiveMsgsEnabled=archiveMessagesSetting;return notification.deviceInfo();}).then(function(deviceInfo){var isDeviceUnregistered=_.isEmpty(deviceInfo)||!deviceInfo.isRegistered;var options=[];_.forEach(MENU.CONFIG.options,function(option){var optionActivateNotifications=option.activateNotifications;var optionArchiveMessages=option.archiveMessages;if(_.isUndefined(optionActivateNotifications)&&_.isUndefined(optionArchiveMessages)){options.push(option);}else if(!_.isUndefined(optionActivateNotifications)&&(isDeviceUnregistered&&optionActivateNotifications||!isDeviceUnregistered&&!optionActivateNotifications)){options.push(option);}else if(!_.isUndefined(optionArchiveMessages)&&(isArchiveMsgsEnabled&&!optionArchiveMessages||!isArchiveMsgsEnabled&&optionArchiveMessages)){options.push(option);}});MenuHelper.showMenu(options,botContext);});},showLoginMenu:function showLoginMenu(botContext,_){DeviceStorageUtil.getContext(botContext).then(function(context){var signupTime=_.get(context,FormHandler.SIGN_UP_TIME);if(signupTime&&_.toNumber(_.now())-_.toNumber(signupTime)<FormHandler.DAY_MS){var menuOptions=[{title:'Complete registration',action:MenuHandler.showConfirmationCodeForm},{title:'Resend confirmation code',action:MenuHandler.showResendConfirmationCodeForm},{title:'Sign up with another email',action:MenuHandler.showSignUpForm}];return MenuHelper.showMenu(menuOptions,botContext);}var lastResetTime=_.get(context,FormHandler.LAST_RESET_TIME);if(lastResetTime&&_.toNumber(_.now())-_.toNumber(lastResetTime)<FormHandler.HOUR_MS){var _menuOptions=[{title:'Complete password reset',action:MenuHandler.showResetCodeForm}];return MenuHelper.showMenu(_menuOptions,botContext);}return MenuHelper.showMenu(MENU.LOGIN.options,botContext);});}};var DeviceStorageUtil={BOT_CONTEXT:'MBot',getContext:function getContext(botContext,DeviceStorage){DeviceStorage=DeviceStorage||botContext.getCapability('DeviceStorage');return DeviceStorage.get(DeviceStorageUtil.BOT_CONTEXT);},setInContext:function setInContext(key,value,botContext){var DeviceStorage=botContext.getCapability('DeviceStorage');return DeviceStorageUtil.getContext(botContext,DeviceStorage).then(function(state){state=state||{};state[key]=value;return DeviceStorage.save(DeviceStorageUtil.BOT_CONTEXT,state);});},removeFromContext:function removeFromContext(key,botContext){var DeviceStorage=botContext.getCapability('DeviceStorage');return DeviceStorageUtil.getContext(botContext,DeviceStorage).then(function(state){delete state[key];return DeviceStorage.save(DeviceStorageUtil.BOT_CONTEXT,state);});}};var MessageProcessor={NEW_LOGIN_EVENT:'onboarding_bot_new',processFormMsg:function processFormMsg(message,state,previousMessages,botContext){var _=botContext.getCapability('Utils').Lodash;var formMsg=message.getMessage();var buttonIndex=_.findIndex(formMsg,function(formElement){return formElement.type==='button';});FormHandler[formMsg[buttonIndex].action](message,state,previousMessages,botContext);},processFormCloseMsg:function processFormCloseMsg(botContext){var authContext=botContext.getCapability('authContext');authContext.isUserLoggedIn(botContext).then(function(userLoggedIn){if(userLoggedIn){return MenuHelper.showMenu(MENU.MAIN,botContext);}else{return MenuHelper.showMenu(MENU.LOGIN,botContext);}});},processBackgroundEvent:function processBackgroundEvent(message,botContext){var _=botContext.getCapability('Utils').Lodash;var bgTaskKey=_.get(message.getMessageOptions(),'key');if(bgTaskKey===MessageProcessor.NEW_LOGIN_EVENT){tell('Hello There! How would you like to sign in?',botContext);}},processStringMsg:function processStringMsg(message,state,previousMessages,botContext){var _=botContext.getCapability('Utils').Lodash;var strMsg=message.getMessage().toLowerCase();var botStateMenu=botState.menuToShow;var index=_.findIndex(botStateMenu,function(option){return option.title.toLowerCase()===strMsg;});if(index===-1){if(botStateMenu===MENU.LOGIN){tell('I am sorry but I can only talk to authenticated users',botContext);return MenuHelper.showMenu(MENU.LOGIN,botContext);}else if(botState.activatePartnerBots){MenuHandler.addDomainAndRoleToUser(message,state,previousMessages,botContext);}else{MessageProcessor.processNlp(message,state,previousMessages,botContext);}}else{if(botState.menuToShow[index].title==='Activate Enterprise Bots'){botState.activatePartnerBots=true;}else{delete botState.activatePartnerBots;}var action=botState.menuToShow[index].action;if(action){action(message,state,previousMessages,botContext);}else{return MenuHelper.showMenu(MENU.MAIN,botContext);}}},processNlp:function processNlp(msg,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');var _=botContext.getCapability('Utils').Lodash;var ONBOARDING_NLP_ID='FMBot';botContext.wait(true);authContext.getAuthUser(botContext).then(function(user){var agentGuardService=botContext.getCapability('agentGuardService');return agentGuardService.nlp(msg,botContext,user,previousMessages,ONBOARDING_NLP_ID);}).then(function(queryResp){var Message=botContext.getCapability('Message');var messages=queryResp.messages||[];var action=queryResp.action;var _GREETING='smalltalk.';var _INPUT='input.';if(_.isEmpty(messages)){var strMsg=queryResp.speech||'Unable to get results for the query';tell(strMsg,botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);}else if(_.includes(action,_INPUT)||_.includes(action,_GREETING)){var respMsg=queryResp.speech;tell(respMsg,botContext);}else if(action==='1_configurationMenu'){return MenuHelper.showMenu(MENU.CONFIG,botContext);}else{var type0Msg=_.find(messages,function(element){return element.type===0;});var type0MsgSpeech=type0Msg.speech;if(type0MsgSpeech){tell(type0MsgSpeech,botContext);}var typ2Or4Msg=_.find(messages,function(element){return element.type===4;});if(_.isEmpty(typ2Or4Msg)){typ2Or4Msg=_.find(messages,function(element){return element.type===2;});}if(typ2Or4Msg){var _messages=_.get(typ2Or4Msg,'payload.messages')||_.get(typ2Or4Msg,'replies')||[];var sliderMsgList=[];_.each(_messages,function(element){sliderMsgList.push({title:element});});var message=new Message();message.sliderMessage(sliderMsgList,{smartReply:true});tell(message,botContext);}else{return MenuHelper.showMenu(MENU.MAIN,botContext);}}});}};var tell=function tell(msg,botContext){botContext.tell(msg);};var showGreeting=function showGreeting(botContext){var _=botContext.getCapability('Utils').Lodash;DeviceStorageUtil.getContext(botContext).then(function(context){var signupTime=_.get(context,FormHandler.SIGN_UP_TIME);var lastResetTime=_.get(context,FormHandler.LAST_RESET_TIME);var lastSignupGreetTime=_.get(context,FormHandler.LAST_SIGNUP_GREET_TIME);var lastResetGreetTime=_.get(context,FormHandler.LAST_RESET_GREET_TIME);var lastGreetingTime=_.get(context,FormHandler.LAST_GREET_TIME);var latestTime=_.now();if(signupTime&&_.toNumber(latestTime)-_.toNumber(signupTime)<FormHandler.DAY_MS){DeviceStorageUtil.setInContext(FormHandler.LAST_SIGNUP_GREET_TIME,latestTime,botContext).then(function(){if(_.isUndefined(lastSignupGreetTime)||_.toNumber(latestTime)-_.toNumber(lastSignupGreetTime)>FormHandler.HOUR_MS){tell('Did you try to register with us within the past day? If so, please enter the confirmation code emailed to you to continue with the registration process and login',botContext);}});}else if(lastResetTime&&_.toNumber(latestTime)-_.toNumber(lastResetTime)<FormHandler.DAY_MS){DeviceStorageUtil.setInContext(FormHandler.LAST_RESET_GREET_TIME,latestTime,botContext).then(function(){if(_.isUndefined(lastResetGreetTime)||_.toNumber(latestTime)-_.toNumber(lastResetGreetTime)>FormHandler.HOUR_MS){tell('Looks like you attempted to reset your password within the last hour. Please enter the reset code emailed to you to login.',botContext);}});}else if(_.isUndefined(lastGreetingTime)||_.toNumber(latestTime)-_.toNumber(lastGreetingTime)>FormHandler.HOUR_MS){DeviceStorageUtil.setInContext(FormHandler.LAST_GREET_TIME,latestTime,botContext).then(function(){tell('When you choose the Login with Google or Facebook options, we will send you over to their login page to authorize us access to only your name and email address',botContext);});}return MenuHelper.showMenu(MENU.LOGIN,botContext);});};var greeting=function greeting(state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');authContext.isUserLoggedIn(botContext).then(function(userLoggedIn){if(userLoggedIn){return MenuHelper.showMenu(MENU.MAIN,botContext);}else{showGreeting(botContext);}});};var next=function next(message,state,previousMessages,botContext){var MessageTypeConstants=botContext.getCapability('MessageTypeConstants');var msgType=message.getMessageType();switch(msgType){case MessageTypeConstants.MESSAGE_TYPE_STRING:MessageProcessor.processStringMsg(message,state,previousMessages,botContext);break;case MessageTypeConstants.MESSAGE_TYPE_FORM_RESPONSE:MessageProcessor.processFormMsg(message,state,previousMessages,botContext);break;case MessageTypeConstants.MESSAGE_TYPE_FORM_CANCEL:case MessageTypeConstants.MESSAGE_TYPE_SLIDER_CANCEL:MessageProcessor.processFormCloseMsg(botContext);break;case MessageTypeConstants.MESSAGE_TYPE_BACKGROUND_EVENT:MessageProcessor.processBackgroundEvent(message,botContext);break;}};var farewell=function farewell(){};var asyncResult=function asyncResult(result,state,previousMessages,botContext){};return{done:farewell,init:greeting,next:next,asyncResult:asyncResult,version:'1.0.0'};})();