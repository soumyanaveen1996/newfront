var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var PROFILE_PIC_BUCKET='profile-pics';var EMAIL_USER_DATA_CAPABILITY='EmailUserData';var ADD_DOMAIN_ROLE_CAPABILITY='SubscribeDomainRole';var AGENT_M='AgentM';var ROLE_ADMIN='ADMIN';var LAST_GREET_TIME='LAST_GREET_TIME';var DAY_MS=24*60*60*1000;function getEnterPriseDetails(botContext,user){var agentGuardService=botContext.getCapability('agentGuardService');var params={collection:'Companies',query:[{operand:'companyId',value:user.info.companyId}],fields:['companyAddress','companyCountry','companyDescription','companyId','companyName','domains']};return agentGuardService.readData(null,botContext,user,[],params,true).then(function(data){console.log('RETRIEVED BUSINESS DETAILS: ',JSON.stringify(data));if(!data||!data[0]||!data[0].items||!data[0].items[0]){return null;}return data[0].items[0];});}var BotContext=function(){function BotContext(){_classCallCheck(this,BotContext);}_createClass(BotContext,[{key:'setContext',value:function setContext(botContext){this.botContext=botContext;this.agentGuardService=botContext.getCapability('agentGuardService');this.authContext=botContext.getCapability('authContext');this.Message=botContext.getCapability('Message');this._=botContext.getCapability('Utils').Lodash;this.DeviceStorage=botContext.getCapability('DeviceStorage');this.tell=botContext.tell.bind(botContext);}}]);return BotContext;}();var ActionHandlers=function(_BotContext){_inherits(ActionHandlers,_BotContext);function ActionHandlers(menu){_classCallCheck(this,ActionHandlers);var _this=_possibleConstructorReturn(this,(ActionHandlers.__proto__||Object.getPrototypeOf(ActionHandlers)).call(this));_this.MENU=menu;return _this;}_createClass(ActionHandlers,[{key:'genericMenuRenderer',value:function genericMenuRenderer(options){var message=new this.Message();message.sliderMessage(options,{smartReply:true});this.tell(message);}},{key:'showMenu',value:function showMenu(menu){console.log('SHOWING MENU: '+JSON.stringify(menu));var menuRenderer=menu.menuRenderer||this.genericMenuRenderer;menuRenderer=menuRenderer.bind(this);botState.menuShown=menu.options;menuRenderer(menu.options);}},{key:'showAccountMenu',value:function showAccountMenu(){this.showMenu(this.MENU.ACCOUNT);}},{key:'showEnterpriseMenu',value:function showEnterpriseMenu(){var _this2=this;var menusOptions=this.MENU.ENTERPRISE.options;var that=this;this.authContext.getAuthUser(that.botContext).then(function(user){console.log('USER: ',JSON.stringify(user));if(user.info.companyId){menusOptions.push({title:'Update Enterprise Information',action:'showUpdateEnterpriseForm'});}else{menusOptions.push({title:'Create Enterprise',action:'showCreateEnterpriseForm'});}menusOptions.push({title:'Show Previous Menu',action:'showMainMenu'});that.showMenu(_this2.MENU.ENTERPRISE);});}},{key:'showConfigMenu',value:function showConfigMenu(){this.showMenu();}},{key:'showMainMenu',value:function showMainMenu(){this.showMenu(this.MENU.MAIN);}},{key:'uploadProfilePic',value:function uploadProfilePic(){var botContext=this.botContext;this.tell('Please choose a profile picture from your library');var that=this;var user=null;this.authContext.getAuthUser(botContext).then(function(usr){user=usr;return that.Media.pickMediaFromLibrary();}).then(function(media){if(media.cancelled){return null;}else{botContext.wait(true);return that.Resource.uploadFile(media.base64,media.uri,PROFILE_PIC_BUCKET,user.userId,that.ResourceTypes.Image,user,true);}}).then(function(fileUrl){if(!fileUrl){that.tell('You have disabled access to media library. Please enable access to upload a profile picture');}else{that.tell('Got it. This is your new profile picture');var message=new that.Message();message.imageMessage(fileUrl);that.tell(message);}return that.actionHandlers.showMainMenu();});}},{key:'showUserForm',value:function showUserForm(){var botContext=this.botContext;var that=this;this.authContext.getAuthUser(botContext).then(function(usr){var message=new that.Message();message.formMessage([{id:1,title:'Enter your details',type:'title'},{id:2,title:'Screen Name',value:usr.info.screenName,type:'text_field',optional:false},{id:3,title:'First Name',value:usr.info.givenName,type:'text_field',optional:false},{id:4,title:'Last Name',value:usr.info.surname,type:'text_field',optional:false},{id:5,title:'Update',type:'button',action:'updateUserInfo'}],'');that.tell(message);});}},{key:'updateUserInfo',value:function updateUserInfo(msg,state,previousMessages){var botContext=this.botContext;var userDetails={};botContext.wait(true);var that=this;that.authContext.getAuthUser(botContext).then(function(user){var userInfo=user.info||{};var dbDocument={};var screenName=msg.getMessage()[1].value||userInfo.screenName;var givenName=msg.getMessage()[2].value||userInfo.givenName;var lastName=msg.getMessage()[3].value||userInfo.surname;userDetails.screenName=screenName;userDetails.surname=lastName;userDetails.givenName=givenName;dbDocument.screenName=screenName;dbDocument.givenName=givenName;dbDocument.surname=lastName;var params={collection:'People',documents:[{key:{userId:userInfo.userId},document:dbDocument}]};return that.agentGuardService.writeData(msg,botContext,user,previousMessages,params);}).then(function(){return that.authContext.updateUserDetails(userDetails,botContext);}).then(function(){that.tell('Done! Your details have been updated');return that.showMainMenu();}).catch(function(error){console.error('Error occurred while updating user details: ',error);that.tell('Error occurred: Unable to update your details');return that.showMainMenu();});}},{key:'showPwdChangeForm',value:function showPwdChangeForm(){var botContext=this.botContext;var that=this;this.authContext.getAuthUser(botContext).then(function(usr){var message=new that.Message();message.formMessage([{id:1,title:'Enter your new password',type:'title'},{id:2,text:'The new password should be different from your old password minimum 8 characters long with lower case, upper case, number and special characters in it',type:'text'},{id:3,title:'Email',type:'text_field',value:usr.info.emailAddress,editable:false},{id:4,title:'Old Password',type:'password_field',optional:false},{id:5,title:'New Password',type:'password_field',optional:false,retry:true},{id:6,title:'Change Password',type:'button',action:'changeUserPwd'}],'');that.tell(message);});}},{key:'changeUserPwd',value:function changeUserPwd(msg){var that=this;var botContext=this.botContext;botContext.wait(true);var formMsg=msg.getMessage();var oldPassword=formMsg[3].value;var newPassword=formMsg[4].value;if(oldPassword===newPassword){this.botContext.wait(false);this.tell('Your new password must be different from your old password');return this.showPwdChangeForm();}var updatedUser={email:formMsg[2].value,oldPassword:oldPassword,newPassword:newPassword};this.authContext.updatePassword(updatedUser,botContext).then(function(){botContext.wait(false);that.tell('Your password has been updated');return that.showMainMenu();}).catch(function(error){console.log('Password update error :',JSON.stringify(error));botContext.wait(false);that.tell(error.message,botContext);return that.showMainMenu();});}},{key:'emailMyData',value:function emailMyData(){var botContext=this.botContext;var that=this;this.authContext.getAuthUser(botContext).then(function(user){botContext.wait(true);var params={action:'Email'};return that.agentGuardService.executeCustomCapability(EMAIL_USER_DATA_CAPABILITY,params,false,undefined,botContext,user);}).then(function(){that.tell('I will email your data to the email address you have used to login now. You should receive it shortly.');return that.showMainMenu();});}},{key:'showAccountHackMenu',value:function showAccountHackMenu(){this.tell('I will require more details about the hack and then I will let the administrators know about the issue');this.tell("Do you confirm you think you've been hacked?");this.showMenu(this.MENU.REPORT_ACCOUNT_HACK);}},{key:'showAccountHackForm',value:function showAccountHackForm(){var formMsg=new this.Message();formMsg.formMessage([{id:1,title:'Enter the details of your account hacking',type:'title'},{id:2,title:'Details',type:'text_area',optional:false},{id:3,title:'Report',type:'button',action:'reportAccountHack'}],'');this.tell(formMsg);}},{key:'showNoHackMsg',value:function showNoHackMsg(){this.tell('Ok, no problem');return this.showMainMenu();}},{key:'reportAccountHack',value:function reportAccountHack(msg){this.botContext.wait(true);var that=this;var formMsg=msg.getMessage();var emailDetails=formMsg[1].value;return this.authContext.getAuthUser(that.botContext).then(function(user){var userInfo=user.info||{};var emailUserInfo={userName:userInfo.userName,emailAddress:userInfo.emailAddress,userId:userInfo.userId};var emailBody='User information: \n'+JSON.stringify(emailUserInfo,null,4)+'\n \n \nDetails reported by the user: \n'+emailDetails;var params={address:'support@frontm.com',body:emailBody,title:'User Hacked!'};return that.agentGuardService.sendEmail(null,that.botContext,user,null,params);}).then(function(){that.tell('I have reported your details to the support team. They should get in touch with you soon');return that.showMainMenu();});}},{key:'showActivateBotMsg',value:function showActivateBotMsg(){this.tell('If a company has invited you to use their Bots, please scan the QR Code or type the invitation code. Please note that invitation code is case sensitive');}},{key:'addDomainAndRoleToUser',value:function addDomainAndRoleToUser(msg){var _=this._;this.botContext.wait(true);botState.activatePartnerBots=false;var that=this;this.authContext.getAuthUser(that.botContext).then(function(user){var strMsg=msg.getMessage();return that.agentGuardService.executeCustomCapability(ADD_DOMAIN_ROLE_CAPABILITY,{verificationCode:strMsg},true,undefined,that.botContext,user);}).then(function(data){if(_.isEmpty(_.compact(data))){that.tell("You should now be able to access the featured partner's bot");}else{that.tell('I do not recognise this code. Can you check if you entered that right?');}return that.showMainMenu();}).catch(function(error){console.error('Error occurred while updating user details: ',error);that.tell('Error occurred: Unable to activate the enterprise bots. Please reach out to the support team.');return that.showMainMenu();});}},{key:'showCreateEnterpriseForm',value:function showCreateEnterpriseForm(){var message=new this.Message();message.formMessage([{id:1,title:'Enter your Business details',type:'title'},{id:2,title:'Business Code',type:'text_field',optional:false},{id:3,title:'Business Name',type:'text_field',optional:false},{id:4,title:'Description - What is your business?',type:'text_area',optional:false},{id:5,title:'Business Address',type:'text_field',optional:false},{id:6,title:'Country',type:'select',options:[{label:'UK',value:'UK'},{label:'Ireland',value:'IR'},{label:'France',value:'FR'},{label:'Germany',value:'DE'},{label:'France',value:'FR'},{label:'Italy',value:'IT'},{label:'IN',value:'IN'}],optional:false},{id:7,title:'Create Business Account',type:'button',action:'createEnterprise'}],'');this.tell(message);}},{key:'createEnterprise',value:function createEnterprise(msg){var botContext=this.botContext;var _=this._;botContext.wait(true);var that=this;var companyId=msg.getMessage()[1].value;var companyName=msg.getMessage()[2].value;var companyDescription=msg.getMessage()[3].value;var companyAddress=msg.getMessage()[4].value;var companyCountry=msg.getMessage()[5].value;if(_.isEmpty(companyId)||_.isEmpty(companyName)||_.isEmpty(companyDescription)||_.isEmpty(companyAddress)||_.isEmpty(companyCountry)){this.tell('All fields are mandatory. Please fill in all the details.');this.showCreateEnterpriseForm();return;}var outUser=null;var roles=[ROLE_ADMIN];var companyDomains=[{domain:companyId+'_'+companyCountry+'_DEV',roles:roles},{domain:companyId+'_'+companyCountry+'_TEST',roles:roles},{domain:companyId+'_'+companyCountry+'_PROD',roles:roles}];this.authContext.getAuthUser(botContext).then(function(user){outUser=user;var params={companyId:companyId,companyName:companyName,companyDescription:companyDescription,companyAddress:companyAddress,companyCountry:companyCountry};params.action='CREATE_COMPANY';params.domains=companyDomains;return that.agentGuardService.executeCustomCapability('CompanyCapability',params,true,undefined,that.botContext,user);}).then(function(){var parameters={domains:companyDomains};return that.agentGuardService.executeCustomCapability('DomainRegister',parameters,true,undefined,that.botContext,outUser);}).then(function(){botContext.wait(false);that.tell('Congratulations! We have created the business account for you. You can manage it here.');that.tell('We have created the following domains for your business. You are assigned as Admin for each of these domains.');that.tell('Domains: '+companyDomains.map(function(domain){return domain.domain;}).join(', '));return that.showMainMenu();}).catch(function(error){console.log('Business signup :',JSON.stringify(error));botContext.wait(false);that.tell('Business signup failed. '+error.message);return that.showMainMenu();});}},{key:'showUpdateEnterpriseForm',value:function showUpdateEnterpriseForm(){var that=this;this.authContext.getAuthUser(that.botContext).then(function(user){return getEnterPriseDetails(that.botContext,user);}).then(function(company){if(!company){that.tell("Looks like you don't have a proper business account. Please try again.");that.showMainMenu();return;}var message=new that.Message();message.formMessage([{id:1,title:'Enter details that you wish to update',type:'title'},{id:2,title:'Business Name',value:company.companyName,type:'text_field',optional:false},{id:3,title:'Description - What is your business?',value:company.companyDescription,type:'text_area',optional:false},{id:4,title:'Business Address',value:company.companyAddress,type:'text_field',optional:false},{id:5,title:'Country',value:company.companyCountry,type:'select',options:[{label:'UK',value:'UK'},{label:'Ireland',value:'IR'},{label:'France',value:'FR'},{label:'Germany',value:'DE'},{label:'France',value:'FR'},{label:'Italy',value:'IT'},{label:'IN',value:'IN'}],optional:false},{id:6,title:'Update Business Account',type:'button',action:'updateEnterprise'}],'');that.tell(message);});}},{key:'updateEnterprise',value:function updateEnterprise(msg){var botContext=this.botContext;var that=this;botContext.wait(true);var outUser=null;this.authContext.getAuthUser(that.botContext).then(function(user){outUser=user;return getEnterPriseDetails(that.botContext,user);}).then(function(company){if(!company){that.tell("Looks like you don't have a proper business account. Please try again.");that.showMainMenu();return;}var params={companyId:company.companyId,companyName:msg.getMessage()[1].value||company.companyName,companyDescription:msg.getMessage()[2].value||company.companyDescription,companyAddress:msg.getMessage()[3].value||company.companyAddress,companyCountry:msg.getMessage()[4].value||company.companyAddress};params.action='UPDATE_COMPANY';return that.agentGuardService.executeCustomCapability('CompanyCapability',params,true,undefined,that.botContext,outUser);}).then(function(){botContext.wait(false);that.tell('Done! Your company details have been updated');return that.showMainMenu();}).catch(function(error){console.log('Business update failed:',JSON.stringify(error));botContext.wait(false);that.tell('Business update failed. '+error.message);return that.showMainMenu();});}}]);return ActionHandlers;}(BotContext);var MessageHandlers=function(_BotContext2){_inherits(MessageHandlers,_BotContext2);function MessageHandlers(actionHandlers){_classCallCheck(this,MessageHandlers);var _this3=_possibleConstructorReturn(this,(MessageHandlers.__proto__||Object.getPrototypeOf(MessageHandlers)).call(this));_this3.actionHandlers=actionHandlers;return _this3;}_createClass(MessageHandlers,[{key:'handleString',value:function handleString(message,state,previousMessages){var strMsg=message.getMessage().toLowerCase();var menuShown=botState.menuShown;var index=menuShown.findIndex(function(option){return option.title.toLowerCase()===strMsg;});if(index!==-1){if(menuShown[index].title==='Activate Enterprise Bots'){botState.activatePartnerBots=true;}else{delete botState.activatePartnerBots;}var handler=menuShown[index].action;if(handler){this.actionHandlers[handler](message,state,previousMessages);}return;}if(botState.activatePartnerBots){this.actionHandlers.addDomainAndRoleToUser(message,state,previousMessages);}else{var orgMessage=message.getMessage();if(orgMessage&&orgMessage.indexOf('access-code-')!==-1){var pass=new this.Message();var accessCode=orgMessage.substring(orgMessage.indexOf('access-code-')+12,orgMessage.length);pass.stringMessage(accessCode);this.actionHandlers.addDomainAndRoleToUser(pass,state,previousMessages);}else{this.processNlp(message,state,previousMessages);}}}},{key:'handleFormCloseMsg',value:function handleFormCloseMsg(){return this.actionHandlers.showMainMenu();}},{key:'handleFormResponse',value:function handleFormResponse(message,state,previousMessages){var _=this.botContext.getCapability('Utils').Lodash;var formMsg=message.getMessage();var buttonIndex=_.findIndex(formMsg,function(formElement){return formElement.type==='button';});this.actionHandlers[formMsg[buttonIndex].action](message,state,previousMessages);}},{key:'processNlp',value:function processNlp(msg,state,previousMessages){var botContext=this.botContext;var that=this;var tell=this.tell;var _=this._;var ONBOARDING_NLP_ID='FMBot';botContext.wait(true);this.authContext.getAuthUser(botContext).then(function(user){return that.agentGuardService.nlp(msg,botContext,user,previousMessages,ONBOARDING_NLP_ID);}).then(function(queryResp){var messages=queryResp.messages||[];var action=queryResp.action;var _GREETING='smalltalk.';var _INPUT='input.';if(_.isEmpty(messages)){var strMsg=queryResp.speech||'Unable to get results for the query';tell(strMsg);return that.actionHandlers.showMainMenu();}else if(_.includes(action,_INPUT)||_.includes(action,_GREETING)){var respMsg=queryResp.speech;tell(respMsg);}else if(action==='1_configurationMenu'){return that.actionHandlers.showConfigMenu();}else{var type0Msg=_.find(messages,function(element){return element.type===0;});var type0MsgSpeech=type0Msg.speech;if(type0MsgSpeech){tell(type0MsgSpeech);}var typ2Or4Msg=_.find(messages,function(element){return element.type===4;});if(_.isEmpty(typ2Or4Msg)){typ2Or4Msg=_.find(messages,function(element){return element.type===2;});}if(typ2Or4Msg){var _messages=_.get(typ2Or4Msg,'payload.messages')||_.get(typ2Or4Msg,'replies')||[];var sliderMsgList=[];_.each(_messages,function(element){sliderMsgList.push({title:element});});var message=new that.Message();message.sliderMessage(sliderMsgList,{smartReply:true});tell(message);}else{return that.actionHandlers.showMainMenu();}}});}}]);return MessageHandlers;}(BotContext);var MENU=function(){function MENU(){_classCallCheck(this,MENU);}_createClass(MENU,null,[{key:'getMenus',value:function getMenus(){return{MAIN:{options:[{title:'My Account',action:'showAccountMenu'},{title:'Enterprise Bots Access',action:'showEnterpriseMenu'}]},ACCOUNT:{options:[{title:'Update user details',action:'showUserForm'},{title:'Email my data',action:'emailMyData'},{title:'My account has been hacked',action:'showAccountHackMenu'},{title:'Show Previous Menu',action:'showMainMenu'}]},ENTERPRISE:{options:[{title:'Activate Enterprise Bots',action:'showActivateBotMsg'}]},REPORT_ACCOUNT_HACK:{options:[{title:'Yes',action:'showAccountHackForm'},{title:'No',action:'showNoHackMsg'}]}};}}]);return MENU;}();var botState=botContext.getCapability('BotState')||{};var FrontMBotWeb=function(){function FrontMBotWeb(){_classCallCheck(this,FrontMBotWeb);this.actionHandlers=new ActionHandlers(MENU.getMenus());this.messageHandlers=new MessageHandlers(this.actionHandlers);}_createClass(FrontMBotWeb,[{key:'setContext',value:function setContext(botContext){this.botContext=botContext;this.tell=this.botContext.tell.bind(botContext);this.actionHandlers.setContext(botContext);this.messageHandlers.setContext(botContext);}},{key:'showGreeting',value:function showGreeting(){var _this4=this;var _=this.botContext.getCapability('Utils').Lodash;var DeviceStorage=this.botContext.getCapability('DeviceStorage');DeviceStorage.get(LAST_GREET_TIME).then(function(lastGreetingTime){var latestTime=_.now();console.log('LAST_GREET_TIME: ',lastGreetingTime);if(!lastGreetingTime||_.toNumber(latestTime)-_.toNumber(lastGreetingTime)>DAY_MS){console.log('before sending the greeting');_this4.tell("Hi there!, Welcome to FrontM Web. I'm FrontM Bot. I'm there to help you get started.");_this4.tell('Please select/type one of the options given below.');DeviceStorage.save(LAST_GREET_TIME,latestTime);}else{console.log('no greeting. condition failed.');}});}},{key:'init',value:function init(state,previousMessages,botContext){this.setContext(botContext);this.showGreeting();this.actionHandlers.showMainMenu();}},{key:'next',value:function next(message,state,previousMessages,botContext){this.setContext(botContext);var MessageTypeConstants=botContext.getCapability('MessageTypeConstants');var msgType=message.getMessageType();switch(msgType){case MessageTypeConstants.MESSAGE_TYPE_STRING:this.messageHandlers.handleString(message,state,previousMessages,botContext);break;case MessageTypeConstants.MESSAGE_TYPE_FORM_RESPONSE:this.messageHandlers.handleFormResponse(message,state,previousMessages);break;case MessageTypeConstants.MESSAGE_TYPE_FORM_CANCEL:case MessageTypeConstants.MESSAGE_TYPE_SLIDER_CANCEL:this.messageHandlers.handleFormCloseMsg();break;}}}]);return FrontMBotWeb;}();module.exports=exports=new FrontMBotWeb();