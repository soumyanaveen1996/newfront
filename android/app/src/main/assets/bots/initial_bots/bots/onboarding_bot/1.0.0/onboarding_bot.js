(function(){var PROFILE_PIC_BUCKET='profile-pics';var FormHandler={signIn:function signIn(message,state,previousMessages,botContext){var formMsg=message.getMessage();var user={email:formMsg[1].value,password:formMsg[2].value};FormHandler.login(botContext,user,true);},signUp:function signUp(message,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');var formMsg=message.getMessage();var user={given_name:formMsg[2].value,family_name:formMsg[3].value,name:formMsg[2].value+' '+formMsg[3].value,'custom:screenName':formMsg[4].value,email:formMsg[5].value,password:formMsg[6].value};botContext.wait(true);authContext.signupWithFrontm(botContext,user).then(function(){botContext.wait(false);tell('Success! You are now registered in the FrontM Platform',botContext);tell('Logging you in now',botContext);FormHandler.login(botContext,user,true);}).catch(function(error){console.log('Signup error :',JSON.stringify(error));botContext.wait(false);tell(error.message,botContext);MenuHandler.showSignUpForm(message,state,previousMessages,botContext,user);});},login:function login(botContext,user,isFrontmLogin){botContext.wait(true);var authContext=botContext.getCapability('authContext');var loginPromise=null;if(isFrontmLogin){loginPromise=authContext.loginWithFrontm(botContext,user);}else{}loginPromise.then(function(user){botState.userLoggedIn=true;tell('Hi '+user.info.userName+'! Welcome aboard. M here, the master bot of FrontM bot fleet',botContext);tell('Allow notifications?',botContext);MenuHelper.showMenu(MENU.PUSH_NOTIFICATION,botContext);}).catch(function(error){console.log('Login error :',error);if(error.code===0){botContext.wait(false);}else{if(isFrontmLogin){var msg=error.message||'Looks like you are not registered with us. Register with FrontM to access our chatbots';tell(msg,botContext);}else{tell('Error occurred while logging in',botContext);}}MenuHelper.showMenu(MENU.LOGIN,botContext);});},updateUserInfo:function updateUserInfo(msg,state,previousMessages,botContext){var _=botContext.getCapability('Utils').Lodash;var isFormMsg=msg.getMessageType()==='form_response';var userDetails={};var newDomain=null;var addDomain=false;botContext.wait(true);var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(user){var userInfo=user.info||{};var dbDocument={};if(isFormMsg){var screenName=msg.getMessage()[1].value||userInfo.screenName;var givenName=msg.getMessage()[2].value||userInfo.givenName;var lastName=msg.getMessage()[3].value||userInfo.surname;userDetails.screenName=screenName;userDetails.surname=lastName;userDetails.givenName=givenName;dbDocument.screenName=screenName;dbDocument.givenName=givenName;dbDocument.surname=lastName;}else{var domains=userInfo.domains||[];newDomain=msg.getMessage();if(_.indexOf(domains,newDomain)===-1){addDomain=true;domains.push(newDomain);}dbDocument.domains=domains;}var params={collection:"People",documents:[{key:{userId:user.userId},document:dbDocument}]};var agentGuardService=botContext.getCapability('agentGuardService');return agentGuardService.writeData(msg,botContext,user,previousMessages,params);}).then(function(){if(isFormMsg){return authContext.updateUserDetails(userDetails,botContext);}else if(addDomain){return authContext.addDomains(newDomain,botContext);}}).then(function(){if(isFormMsg){tell('Done! Your details have been updated',botContext);}else{tell('You should now be able to access the featured partner\'s bot',botContext);}return MenuHelper.showMenu(MENU.MAIN,botContext);}).catch(function(error){console.error('Error occurred while updating user details: ',error);tell('Error occurred: Unable to update details',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);});},changeUserPwd:function changeUserPwd(msg,state,previousMessages,botContext){botContext.wait(true);var formMsg=msg.getMessage();var oldPassword=formMsg[3].value;var newPassword=formMsg[4].value;if(oldPassword===newPassword){botContext.wait(false);tell('Your new password must be different from your old password',botContext);return MenuHandler.showPwdChangeForm(msg,state,previousMessages,botContext);}var updatedUser={email:formMsg[2].value,oldPassword:oldPassword,newPassword:newPassword};var authContext=botContext.getCapability('authContext');authContext.updatePassword(updatedUser,botContext).then(function(){botContext.wait(false);tell('Your password has been updated',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);}).catch(function(error){console.log('Password update error :',JSON.stringify(error));botContext.wait(false);tell(error.message,botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);});}};var MenuHandler={showSignInForm:function showSignInForm(message,state,previousMessages,botContext){var Message=botContext.getCapability('Message');var formMsg=new Message();formMsg.formMessage([{id:1,title:'Enter your details to sign in',type:'title'},{id:2,title:'Email',type:'email_field',optional:false},{id:3,title:'Password',type:'password_field',optional:false},{id:4,title:'Login',type:'button',action:'signIn'}],'');tell(formMsg,botContext);},showSignUpForm:function showSignUpForm(message,state,previousMessages,botContext,user){user=user||{};var Message=botContext.getCapability('Message');var formMsg=new Message();formMsg.formMessage([{id:1,title:'Enter your details',type:'title'},{id:2,text:'Password should be minimum 8 characters long with lower case, upper case, number and special characters in it',type:'text'},{id:3,title:'First Name',type:'text_field',optional:false,value:user.given_name},{id:4,title:'Last Name',type:'text_field',optional:false,value:user.family_name},{id:5,title:'Screen Name',type:'text_field',optional:false,value:user['custom:screenName']},{id:6,title:'Email',type:'email_field',optional:false,value:user.email},{id:7,title:'Password',type:'password_field',optional:false,retry:true},{id:8,title:'Register',type:'button',action:'signUp'}],'');tell(formMsg,botContext);},showUserForm:function showUserForm(message,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(usr){var Message=botContext.getCapability('Message');var message=new Message();message.formMessage([{id:1,title:'Enter your updated details',type:'title'},{id:2,title:'Screen Name',value:usr.info.screenName,type:'text_field',optional:false},{id:3,title:'First Name',value:usr.info.givenName,type:'text_field',optional:false},{id:4,title:'Last Name',value:usr.info.surname,type:'text_field',optional:false},{id:5,title:'Update',type:'button',action:'updateUserInfo'}],'');tell(message,botContext);});},showPwdChangeForm:function showPwdChangeForm(message,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(usr){var Message=botContext.getCapability('Message');var message=new Message();message.formMessage([{id:1,title:'Enter your new password',type:'title'},{id:2,text:'The new password should be different from your old password minimum 8 characters long with lower case, upper case, number and special characters in it',type:'text'},{id:3,title:'Email',type:'text_field',value:usr.info.emailAddress,editable:false},{id:4,title:'Old Password',type:'password_field',optional:false},{id:5,title:'New Password',type:'password_field',optional:false,retry:true},{id:6,title:'Change Password',type:'button',action:'changeUserPwd'}],'');tell(message,botContext);});},registerDevice:function registerDevice(message,state,previousMessages,botContext){var user=null;var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(usr){user=usr;var notification=botContext.getCapability('Notification');return notification.register();}).then(function(notificationDeviceInfo){botContext.wait(true);var agentGuardService=botContext.getCapability('agentGuardService');return agentGuardService.registerDevice(notificationDeviceInfo,botContext,user);}).then(function(){tell("Push notifications are activated for your device",botContext);if(botState.menuToShow===MENU.PUSH_NOTIFICATION){tell('Feel free to personalise the configuration from the menu below',botContext);tell('Touch the back arrow above to go to the home screen, your FrontM timeline. You will find collaboration tools in the menu there, and I\'m always around to assist.',botContext);}return MenuHelper.showMenu(MENU.MAIN,botContext);});},deregisterDevice:function deregisterDevice(message,state,previousMessages,botContext){var user=null;var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(usr){user=usr;var notification=botContext.getCapability('Notification');return notification.deregister();}).then(function(notificationDeviceInfo){botContext.wait(true);var agentGuardService=botContext.getCapability('agentGuardService');return agentGuardService.deregisterDevice(notificationDeviceInfo,botContext,user);}).then(function(){tell("Push notifications are deactivated for your device",botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);});},showNoPushNotificationMsg:function showNoPushNotificationMsg(message,state,previousMessages,botContext){tell('No problem, you can always ask me to activate them returning to this conversation',botContext);tell('Feel free to personalise the configuration from the menu below',botContext);tell('Touch the back arrow above to go to the home screen, your FrontM timeline. You will find collaboration tools in the menu there, and I\'m always around to assist.',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);},showConfigMenu:function showConfigMenu(message,state,previousMessages,botContext){return MenuHelper.showMenu(MENU.CONFIG,botContext);},showLogoutMenu:function showLogoutMenu(message,state,previousMessages,botContext){return MenuHelper.showMenu(MENU.LOGOUT,botContext);},showNetworkControlMenu:function showNetworkControlMenu(message,state,previousMessages,botContext){return MenuHelper.showMenu(MENU.NETWORK_CONTROL,botContext);},showNetworkUsageMenu:function showNetworkUsageMenu(message,state,previousMessages,botContext){tell('This functionality is coming in next release',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);},changePollingStrategy:function changePollingStrategy(message,state,previousMessages,botContext){var PollingStrategyTypes=botContext.getCapability('PollingStrategyTypes');var _=botContext.getCapability('Utils').Lodash;var selectedOption=message.getMessage();var chosenStrategy=_.get(PollingStrategyTypes,selectedOption.toLowerCase())||'gsm';var Settings=botContext.getCapability('Settings');return Settings.setPollingStrategy(chosenStrategy).then(function(){if(selectedOption==='Manual'){tell('You are in Manual Network Mode. You are consuming 0KB background data currently. You will need to touch the refresh button to fetch messages.',botContext);}else{tell('Network control has been updated to '+selectedOption,botContext);}return MenuHelper.showMenu(MENU.MAIN,botContext);});},showActivateBotMsg:function showActivateBotMsg(message,state,previousMessages,botContext){tell('If a company has invited you to use their Bots, please scan the QR Code or type the invitation code',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);},logout:function logout(message,state,previousMessages,botContext){var goodbyeMsg=null;var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(user){goodbyeMsg='Goodbye '+user.info.userName+', I will miss you and expect you back soon';return authContext.logout(botContext);}).then(function(){tell(goodbyeMsg||'Successfully logged out',botContext);return MenuHelper.showMenu(MENU.LOGIN,botContext);});},showNoLogoutMsg:function showNoLogoutMsg(message,state,previousMessages,botContext){tell('You can use this bot to logout anytime',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);},uploadProfilePic:function uploadProfilePic(message,state,previousMessages,botContext){tell('Please choose a profile picture from your library',botContext);var authContext=botContext.getCapability('authContext');var _=botContext.getCapability('Utils').Lodash;var user=null;authContext.getAuthUser(botContext).then(function(usr){user=usr;var Media=botContext.getCapability('Media');return Media.pickMediaFromLibrary();}).then(function(media){if(media.cancelled){return null;}else{botContext.wait(true);var Resource=botContext.getCapability('Resource');var ResourceTypes=botContext.getCapability('ResourceTypes');return Resource.uploadFile(media.base64,media.uri,PROFILE_PIC_BUCKET,user.userId,ResourceTypes.Image,user,true);}}).then(function(fileUrl){if(_.isNull(fileUrl)){tell('You have disabled access to media library. Please enable access to upload a profile picture',botContext);}else{tell('Got it. This is your new profile picture',botContext);var Message=botContext.getCapability('Message');var _message=new Message();_message.imageMessage(fileUrl);tell(_message,botContext);}return MenuHelper.showMenu(MENU.MAIN,botContext);});}};var MENU={LOGIN:[{title:'Sign in as an existing user',action:MenuHandler.showSignInForm},{title:'Sign up as a new user',action:MenuHandler.showSignUpForm}],PUSH_NOTIFICATION:[{title:'Yes',action:MenuHandler.registerDevice},{title:'No',action:MenuHandler.showNoPushNotificationMsg}],MAIN:[{title:'Configuration',action:MenuHandler.showConfigMenu},{title:'Activate Enterprise Bots',action:MenuHandler.showActivateBotMsg},{title:'Logout',action:MenuHandler.showLogoutMenu}],LOGOUT:[{title:'Yes',action:MenuHandler.logout},{title:'No',action:MenuHandler.showNoLogoutMsg}],CONFIG:[{title:'Add/change profile picture',action:MenuHandler.uploadProfilePic},{title:'Update user details',action:MenuHandler.showUserForm},{title:'Change password',action:MenuHandler.showPwdChangeForm},{title:'Activate Push Notifications',action:MenuHandler.registerDevice,activateNotifications:true},{title:'Deactivate Push Notifications',action:MenuHandler.deregisterDevice,activateNotifications:false},{title:'Network control',action:MenuHandler.showNetworkControlMenu},{title:'Network usage',action:MenuHandler.showNetworkUsageMenu}],NETWORK_CONTROL:[{title:'Manual',action:MenuHandler.changePollingStrategy},{title:'Satellite',action:MenuHandler.changePollingStrategy},{title:'Terrestrial',action:MenuHandler.changePollingStrategy},{title:'Automatic',action:MenuHandler.changePollingStrategy}]};var botState={};var MenuHelper={showMenu:function showMenu(menuToShow,botContext){botState.menuToShow=menuToShow;var _=botContext.getCapability('Utils').Lodash;var Message=botContext.getCapability('Message');var message=new Message();if(menuToShow===MENU.CONFIG){MenuHelper.showConfigMenu(botContext,_,message);}else{var options=_.map(menuToShow,function(option){return{title:option.title};});message.sliderMessage(options,{smartReply:true});tell(message,botContext);}},showConfigMenu:function showConfigMenu(botContext,_,message){var notification=botContext.getCapability('Notification');notification.deviceInfo().then(function(deviceInfo){var isDeviceUnregistered=_.isEmpty(deviceInfo)||!deviceInfo.isRegistered;var options=[];_.forEach(MENU.CONFIG,function(option){var activateNotifications=option.activateNotifications;if(_.isUndefined(activateNotifications)){options.push({title:option.title});}else{if(isDeviceUnregistered&&activateNotifications||!isDeviceUnregistered&&!activateNotifications){options.push({title:option.title});}}});message.sliderMessage(options,{smartReply:true});tell(message,botContext);});}};var MessageProcessor={processFormMsg:function processFormMsg(message,state,previousMessages,botContext){var _=botContext.getCapability('Utils').Lodash;var formMsg=message.getMessage();var buttonIndex=_.findIndex(formMsg,function(formElement){return formElement.type==='button';});FormHandler[formMsg[buttonIndex].action](message,state,previousMessages,botContext);},processStringMsg:function processStringMsg(message,state,previousMessages,botContext){var _=botContext.getCapability('Utils').Lodash;var strMsg=message.getMessage().toLowerCase();var botStateMenu=botState.menuToShow;var index=_.findIndex(botStateMenu,function(option){return option.title.toLowerCase()===strMsg;});if(index===-1){if(botStateMenu===MENU.LOGIN){tell('I am sorry but I can only talk to authenticated users',botContext);return MenuHelper.showMenu(MENU.LOGIN,botContext);}else{MessageProcessor.processSpecialString(strMsg,message,state,previousMessages,botContext);}}else{botState.menuToShow[index].action(message,state,previousMessages,botContext);}},processSpecialString:function processSpecialString(strMsg,message,state,previousMessages,botContext){var Message=botContext.getCapability('Message');var companyMsg=new Message();if(strMsg==='addvaluefaq'){companyMsg.stringMessage('addvalue');return FormHandler.updateUserInfo(companyMsg,state,previousMessages,botContext);}else if(strMsg==='inmarsatchatbot'){companyMsg.stringMessage('inmarsat');return FormHandler.updateUserInfo(companyMsg,state,previousMessages,botContext);}else{return MessageProcessor.processNlp(message,state,previousMessages,botContext);}},processNlp:function processNlp(msg,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');var _=botContext.getCapability('Utils').Lodash;var ONBOARDING_NLP_ID='FMBot';botContext.wait(true);authContext.getAuthUser(botContext).then(function(user){var agentGuardService=botContext.getCapability('agentGuardService');return agentGuardService.nlp(msg,botContext,user,previousMessages,ONBOARDING_NLP_ID);}).then(function(queryResp){var Message=botContext.getCapability('Message');var messages=queryResp.messages||[];var action=queryResp.action;var _GREETING='smalltalk.';var _INPUT='input.';if(_.isEmpty(messages)){var strMsg=queryResp.speech||'Unable to get results for the query';tell(strMsg,botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);}else if(_.includes(action,_INPUT)||_.includes(action,_GREETING)){var respMsg=queryResp.speech;tell(respMsg,botContext);}else if(action==='1_configurationMenu'){return MenuHelper.showMenu(MENU.CONFIG,botContext);}else{var type0Msg=_.find(messages,function(element){return element.type===0;});var type0MsgSpeech=type0Msg.speech;if(type0MsgSpeech){tell(type0MsgSpeech,botContext);}var typ2Or4Msg=_.find(messages,function(element){return element.type===4;});if(_.isEmpty(typ2Or4Msg)){typ2Or4Msg=_.find(messages,function(element){return element.type===2;});}if(typ2Or4Msg){var _messages=_.get(typ2Or4Msg,"payload.messages")||_.get(typ2Or4Msg,"replies")||[];var sliderMsgList=[];_.each(_messages,function(element){sliderMsgList.push({title:element});});var message=new Message();message.sliderMessage(sliderMsgList,{smartReply:true});tell(message,botContext);}else{return MenuHelper.showMenu(MENU.MAIN,botContext);}}});}};var tell=function tell(msg,botContext){botContext.tell(msg);};var greeting=function greeting(state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');authContext.isUserLoggedIn(botContext).then(function(userLoggedIn){if(userLoggedIn){return MenuHelper.showMenu(MENU.MAIN,botContext);}else{tell('Hello There!',botContext);tell('How would you like to sign in?',botContext);return MenuHelper.showMenu(MENU.LOGIN,botContext);}});};var next=function next(message,state,previousMessages,botContext){var MessageTypeConstants=botContext.getCapability('MessageTypeConstants');var msgType=message.getMessageType();switch(msgType){case MessageTypeConstants.MESSAGE_TYPE_STRING:MessageProcessor.processStringMsg(message,state,previousMessages,botContext);break;case MessageTypeConstants.MESSAGE_TYPE_FORM_RESPONSE:MessageProcessor.processFormMsg(message,state,previousMessages,botContext);break;}};var farewell=function farewell(){};var asyncResult=function asyncResult(result,state,previousMessages,botContext){};return{done:farewell,init:greeting,next:next,asyncResult:asyncResult,version:"1.0.0"};})();
