(function(){var OnboardingStates={userLoggedIn:'userLoggedIn',userNotLoggedIn:'userNotLoggedIn'};var PROFILE_PIC_BUCKET='profile-pics';var ONBOARDING_NLP_ID='FMBot';var SIGN_UP='SIGN_UP';var FRONTM_SIGNIN='FrontM';var MAIN_MENU={CONFIGURATION:'CONFIGURATION',ACTIVATE_BOTS:'ACTIVATE_BOTS',CONFIRM_LOGOUT:'CONFIRM_LOGOUT'};var LOGOUT={YES:'LOGOUT_YES',NO:'LOGOUT_NO'};var CONFIGURATION_MENU={PROFILE_PIC:'PROFILE_PIC',UPDATE_INFO:'UPDATE_INFO',REGISTER_DEVICE:'REGISTER_DEVICE',DEREGISTER_DEVICE:'DEREGISTER_DEVICE',NETWORK_CONTROL:'NETWORK_CONTROL',NETWORK_USAGE:'NETWORK_USAGE'};var NETWORK_CONTROL_MENU={MANUAL:'Manual',SATELLITE:'Satellite',GSM:'GSM',AUTO:'Automatic'};var botState=OnboardingStates.userNotLoggedIn;var greeting=function greeting(state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');authContext.isUserLoggedIn(botContext).then(function(userLoggedIn){if(userLoggedIn){botState=OnboardingStates.userLoggedIn;return showMainMenu(botContext);}else{botState=OnboardingStates.userNotLoggedIn;tell('Hello There!',botContext);tell('How would you like to sign in?',botContext);return loginAsk(botContext);}});};var loginAsk=function loginAsk(botContext){var Message=botContext.getCapability('Message');var authContext=botContext.getCapability('authContext');var utils=botContext.getCapability('Utils');var _=utils.Lodash;var providers=authContext.getAuthProviders(botContext);var providerMessages=_.map(providers,function(provider){var sliderOption={id:provider};if(provider===FRONTM_SIGNIN){sliderOption.title='Login with an existing FrontM user';}else{sliderOption.title='Login with '+provider;}return sliderOption;});providerMessages.push({title:'Register a new FrontM user',id:SIGN_UP});var message=new Message();message.sliderMessage(providerMessages,{smartReply:true});tell(message,botContext);};var showMainMenu=function showMainMenu(botContext){var Message=botContext.getCapability('Message');var message=new Message();var options=[{title:'Configuration',id:MAIN_MENU.CONFIGURATION},{title:'Activate Enterprise Bots',id:MAIN_MENU.ACTIVATE_BOTS},{title:'Logout',id:MAIN_MENU.CONFIRM_LOGOUT}];message.sliderMessage(options,{smartReply:true});tell(message,botContext);};var next=function next(message,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');var msgType=message.getMessageType();if(botState===OnboardingStates.userNotLoggedIn){if(msgType==='string'){tell('I am sorry but I can only talk to authenticated users',botContext);return loginAsk(botContext);}else if(msgType==='slider_response'){var _authContext=botContext.getCapability('authContext');var sliderMsgId=message.getMessage()[0].id;if(sliderMsgId===SIGN_UP){showSignUpForm(botContext);}else if(sliderMsgId===FRONTM_SIGNIN){showSignInForm(botContext);}else{login(botContext,_authContext,sliderMsgId,null);}}else if(msgType==='form_response'){var formMsg=message.getMessage();var buttonTitle=formMsg[3].title;if(buttonTitle==='Login'){var user={email:formMsg[1].value,password:formMsg[2].value};login(botContext,authContext,null,user);}else{var _user={given_name:formMsg[2].value,family_name:formMsg[3].value,name:formMsg[2].value+' '+formMsg[3].value,email:formMsg[4].value,password:formMsg[5].value};signUp(botContext,authContext,_user);}}}else{if(msgType==='slider_response'){var _authContext2=botContext.getCapability('authContext');var _sliderMsgId=message.getMessage()[0].id;switch(_sliderMsgId){case MAIN_MENU.CONFIGURATION:showConfigurationMenu(botContext);break;case MAIN_MENU.ACTIVATE_BOTS:tell('If a company has invited you to use their Bots, please scan the QR Code or type the invitation code',botContext);break;case MAIN_MENU.CONFIRM_LOGOUT:tell('Are you sure you would like to logout? All your data will be deleted from the device',botContext);logoutConfirm(botContext);break;case LOGOUT.YES:_authContext2.logout(botContext).then(function(){botState=OnboardingStates.userNotLoggedIn;tell('Successfully logged out',botContext);loginAsk(botContext);});break;case LOGOUT.NO:tell('You can use this bot to logout anytime',botContext);break;case CONFIGURATION_MENU.PROFILE_PIC:uploadProfilePic(_authContext2,botContext);break;case CONFIGURATION_MENU.UPDATE_INFO:showUserForm(_authContext2,botContext);break;case CONFIGURATION_MENU.REGISTER_DEVICE:case CONFIGURATION_MENU.DEREGISTER_DEVICE:deviceRegisterDeregister(_sliderMsgId,_authContext2,botContext);break;case CONFIGURATION_MENU.NETWORK_CONTROL:showNetworkControlMenu(botContext);break;case CONFIGURATION_MENU.NETWORK_USAGE:tell('This functionality is coming in next release',botContext);showMainMenu(botContext);break;case NETWORK_CONTROL_MENU.MANUAL:case NETWORK_CONTROL_MENU.AUTO:case NETWORK_CONTROL_MENU.GSM:case NETWORK_CONTROL_MENU.SATELLITE:changePollingStrategy(_sliderMsgId,botContext);break;}}else if(msgType==='form_response'){return updateUserInfo(message,state,previousMessages,botContext);}else if(msgType==='string'){return processStringMsg(message,state,previousMessages,botContext);}}};var signUp=function signUp(botContext,authContext,user){botContext.wait(true);authContext.signupWithFrontm(botContext,user).then(function(){botContext.wait(false);tell('Success! You are now registered in the FrontM Platform',botContext);tell('Logging you in now',botContext);login(botContext,authContext,null,user);}).catch(function(error){console.log('Signup error :',JSON.stringify(error));botContext.wait(false);tell(error.message,botContext);showSignUpForm(botContext,user);});};var login=function login(botContext,authContext,sliderMsgId,user){botContext.wait(true);var isFrontmLogin=sliderMsgId===null;var loginPromise=null;if(isFrontmLogin){loginPromise=authContext.loginWithFrontm(botContext,user);}else{loginPromise=authContext.login(botContext,sliderMsgId);}loginPromise.then(function(user){displayPostLoginMsgs(user,botContext);}).catch(function(error){console.log('Login error :',error);if(error.code===0){botContext.wait(false);}else{if(isFrontmLogin){tell('Looks like you are not registered with us. Register with FrontM to access our chatbots',botContext);}else{tell('Error occurred while logging in',botContext);}}loginAsk(botContext);});};var displayPostLoginMsgs=function displayPostLoginMsgs(user,botContext){botState=OnboardingStates.userLoggedIn;tell('Hi '+user.info.name+'! Welcome aboard. M here, the master bot of FrontM bot fleet',botContext);tell('Touch < to see your timeline and explore our Chatbots. You\'ll always find me on your timeline!',botContext);showMainMenu(botContext);};var showSignUpForm=function showSignUpForm(botContext,user){user=user||{};var Message=botContext.getCapability('Message');var message=new Message();message.formMessage([{id:1,title:'Enter your details',type:'title'},{id:2,text:'Password should be minimum 8 characters long with lower case, upper case, number and special characters in it',type:'text'},{id:3,title:'First Name',type:'text_field',optional:false,value:user.given_name},{id:4,title:'Last Name',type:'text_field',optional:false,value:user.family_name},{id:5,title:'Email',type:'email_field',optional:false,value:user.email},{id:6,title:'Password',type:'password_field',optional:false,retry:true},{id:7,title:'Register',type:'button'}],'');tell(message,botContext);};var showSignInForm=function showSignInForm(botContext){var Message=botContext.getCapability('Message');var message=new Message();message.formMessage([{id:1,title:'Enter your details to sign in',type:'title'},{id:2,title:'Email',type:'email_field',optional:false},{id:3,title:'Password',type:'password_field',optional:false},{id:4,title:'Login',type:'button'}],'');tell(message,botContext);};var changePollingStrategy=function changePollingStrategy(option,botContext){var PollingStrategyTypes=botContext.getCapability('PollingStrategyTypes');var _=botContext.getCapability('Utils').Lodash;var chosenStrategy=_.get(PollingStrategyTypes,option.toLowerCase());if(_.isUndefined(chosenStrategy)||_.isEmpty(chosenStrategy)){tell('This functionality is coming in next release',botContext);return showMainMenu(botContext);}else{var Settings=botContext.getCapability('Settings');return Settings.setPollingStrategy(chosenStrategy).then(function(){tell('Network control has been updated to '+option,botContext);return showMainMenu(botContext);});}};var processStringMsg=function processStringMsg(message,state,previousMessages,botContext){var strMsg=message.getMessage().toLowerCase();var Message=botContext.getCapability('Message');var companyMsg=new Message();if(strMsg==='addvaluefaq'){companyMsg.stringMessage('addvalue');return updateUserInfo(companyMsg,state,previousMessages,botContext);}else if(strMsg==='inmarsatchatbot'){companyMsg.stringMessage('inmarsat');return updateUserInfo(companyMsg,state,previousMessages,botContext);}else{return processNlp(message,state,previousMessages,botContext);}};var processNlp=function processNlp(msg,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');var _=botContext.getCapability('Utils').Lodash;botContext.wait(true);authContext.getAuthUser(botContext).then(function(user){var agentGuardService=botContext.getCapability('agentGuardService');return agentGuardService.nlp(msg,botContext,user,previousMessages,ONBOARDING_NLP_ID);}).then(function(queryResp){var Message=botContext.getCapability('Message');var messages=queryResp.messages||[];var action=queryResp.action;if(_.isEmpty(messages)){var strMsg=queryResp.speech||'Unable to get results for the query';tell(strMsg,botContext);return showMainMenu(botContext);}else if(action==='1_configurationMenu'){return showMainMenu(botContext);}else{var type0Msg=_.find(messages,function(element){return element.type===0;});var type0MsgSpeech=type0Msg.speech;if(type0MsgSpeech){tell(type0MsgSpeech,botContext);}var typ2Or4Msg=_.find(messages,function(element){return element.type===4;});if(_.isEmpty(typ2Or4Msg)){typ2Or4Msg=_.find(messages,function(element){return element.type===2;});}if(typ2Or4Msg){var _messages=_.get(typ2Or4Msg,"payload.messages")||_.get(typ2Or4Msg,"replies")||[];var sliderMsgList=[];_.each(_messages,function(element){sliderMsgList.push({title:element});});var message=new Message();message.sliderMessage(sliderMsgList,{smartReply:true});tell(message,botContext);}else{return showMainMenu(botContext);}}});};var updateUserInfo=function updateUserInfo(msg,state,previousMessages,botContext){var _=botContext.getCapability('Utils').Lodash;var isFormMsg=msg.getMessageType()==='form_response';var userDetails={};var newDomain=null;var addDomain=false;botContext.wait(true);var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(user){var userInfo=user.info||{};var dbDocument={};if(isFormMsg){var screenName=msg.getMessage()[1].value||userInfo.screenName;var givenName=msg.getMessage()[2].value||userInfo.givenName;var lastName=msg.getMessage()[3].value||userInfo.surname;userDetails.screenName=screenName;userDetails.surname=lastName;userDetails.givenName=givenName;dbDocument.screenName=screenName;dbDocument.givenName=givenName;dbDocument.surname=lastName;}else{var domains=userInfo.domains||[];newDomain=msg.getMessage();if(_.indexOf(domains,newDomain)===-1){addDomain=true;domains.push(newDomain);}dbDocument.domains=domains;}var params={collection:"People",documents:[{queryString:"uuid=="+user.userUUID,document:dbDocument}]};var agentGuardService=botContext.getCapability('agentGuardService');return agentGuardService.writeData(msg,botContext,user,previousMessages,params);}).then(function(){if(isFormMsg){return authContext.updateUserDetails(userDetails,botContext);}else if(addDomain){return authContext.addDomains(newDomain,botContext);}}).then(function(){if(isFormMsg){tell('Done! Your details have been updated',botContext);}else{tell('You should now be able to access the featured partner\'s bot',botContext);}return showMainMenu(botContext);}).catch(function(error){console.error('Error occurred while updating user details: ',error);tell('Error occurred: Unable to update details',botContext);});};var deviceRegisterDeregister=function deviceRegisterDeregister(action,authContext,botContext){var registerAction=action===CONFIGURATION_MENU.REGISTER_DEVICE;var user=null;authContext.getAuthUser(botContext).then(function(usr){user=usr;var notification=botContext.getCapability('Notification');if(registerAction){return notification.register();}else{return notification.deregister();}}).then(function(notificationDeviceInfo){botContext.wait(true);var agentGuardService=botContext.getCapability('agentGuardService');if(registerAction){return agentGuardService.registerDevice(notificationDeviceInfo,botContext,user);}else{return agentGuardService.deregisterDevice(notificationDeviceInfo,botContext,user);}}).then(function(){if(registerAction){tell("Push notifications are activated for your device",botContext);}else{tell("Push notifications are deactivated for your device",botContext);}return showMainMenu(botContext);});};var showUserForm=function showUserForm(authContext,botContext){authContext.getAuthUser(botContext).then(function(usr){var Message=botContext.getCapability('Message');var message=new Message();message.formMessage([{id:1,title:'Enter your updated details',type:'text'},{id:2,title:'Screen Name',value:usr.info.screenName,type:'text_field',optional:false},{id:3,title:'First Name',value:usr.info.givenName,type:'text_field',optional:false},{id:4,title:'Last Name',value:usr.info.surname,type:'text_field',optional:false},{id:5,title:'Update',type:'button'}],'');tell(message,botContext);});};var uploadProfilePic=function uploadProfilePic(authContext,botContext){tell('Please choose a profile picture from your library',botContext);var _=botContext.getCapability('Utils').Lodash;var user=null;authContext.getAuthUser(botContext).then(function(usr){user=usr;var Media=botContext.getCapability('Media');return Media.pickMediaFromLibrary();}).then(function(media){if(media.cancelled){return null;}else{botContext.wait(true);var Resource=botContext.getCapability('Resource');var ResourceTypes=botContext.getCapability('ResourceTypes');return Resource.uploadFile(media.base64,media.uri,PROFILE_PIC_BUCKET,user.userUUID,ResourceTypes.Image,user,true);}}).then(function(fileUrl){if(!_.isNull(fileUrl)){tell('Got it. This is your new profile picture',botContext);var Message=botContext.getCapability('Message');var message=new Message();message.imageMessage(fileUrl);tell(message,botContext);}return showMainMenu(botContext);});};var logoutConfirm=function logoutConfirm(botContext){var Message=botContext.getCapability('Message');var message=new Message();message.sliderMessage([{title:'Yes',id:LOGOUT.YES},{title:'No',id:LOGOUT.NO}],{smartReply:true});tell(message,botContext);};var showNetworkControlMenu=function showNetworkControlMenu(botContext){var Message=botContext.getCapability('Message');var message=new Message();message.sliderMessage([{title:NETWORK_CONTROL_MENU.MANUAL,id:NETWORK_CONTROL_MENU.MANUAL},{title:NETWORK_CONTROL_MENU.SATELLITE,id:NETWORK_CONTROL_MENU.SATELLITE},{title:NETWORK_CONTROL_MENU.GSM,id:NETWORK_CONTROL_MENU.GSM},{title:NETWORK_CONTROL_MENU.AUTO,id:NETWORK_CONTROL_MENU.AUTO}],{smartReply:true});tell(message,botContext);};var showConfigurationMenu=function showConfigurationMenu(botContext){var _=botContext.getCapability('Utils').Lodash;var Message=botContext.getCapability('Message');var message=new Message();var options=[{title:'Add/change profile picture',id:CONFIGURATION_MENU.PROFILE_PIC},{title:'Update user details',id:CONFIGURATION_MENU.UPDATE_INFO}];var notification=botContext.getCapability('Notification');notification.deviceInfo().then(function(deviceInfo){if(_.isEmpty(deviceInfo)||!deviceInfo.isRegistered){options.push({title:'Activate Push Notifications',id:CONFIGURATION_MENU.REGISTER_DEVICE});}else{options.push({title:'Deactivate Push Notifications',id:CONFIGURATION_MENU.DEREGISTER_DEVICE});}options.push({title:'Network control',id:CONFIGURATION_MENU.NETWORK_CONTROL},{title:'Network usage',id:CONFIGURATION_MENU.NETWORK_USAGE});message.sliderMessage(options,{smartReply:true});tell(message,botContext);});};var tell=function tell(msg,botContext){botContext.tell(msg);};var farewell=function farewell(){};var asyncResult=function asyncResult(result,state,previousMessages,botContext){};return{done:farewell,init:greeting,next:next,asyncResult:asyncResult,version:"1.0.0"};})();
