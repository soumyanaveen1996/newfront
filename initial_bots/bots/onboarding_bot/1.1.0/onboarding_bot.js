(function(){var PROFILE_PIC_BUCKET='profile-pics';var FormHandler={SIGN_UP_IN_PROGRESS:'SIGN_UP_IN_PROGRESS',RESET_IN_PROGRESS:'RESET_IN_PROGRESS',signIn:function signIn(message,state,previousMessages,botContext){var formMsg=message.getMessage();var user={email:formMsg[1].value,password:formMsg[2].value};FormHandler.login(botContext,user,true);},signUp:function signUp(message,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');var formMsg=message.getMessage();var user={given_name:formMsg[2].value,family_name:formMsg[3].value,name:formMsg[2].value+' '+formMsg[3].value,'custom:screenName':formMsg[4].value,email:formMsg[5].value,password:formMsg[6].value};botContext.wait(true);authContext.signupWithFrontm(botContext,user).then(function(){return DeviceStorageUtil.setInContext(FormHandler.SIGN_UP_IN_PROGRESS,true,botContext);}).then(function(){botContext.wait(false);tell('A confirmation code has been sent to your registered email address. You will have to enter it to complete the registration process',botContext);botState.newUser=user;MenuHandler.showConfirmationCodeForm(message,state,previousMessages,botContext,user);}).catch(function(error){console.log('Signup error :',JSON.stringify(error));botContext.wait(false);tell(error.message,botContext);MenuHandler.showSignUpForm(message,state,previousMessages,botContext,user);});},signupConfirm:function signupConfirm(message,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');var formMsg=message.getMessage();var user={email:formMsg[1].value,confirmCode:formMsg[2].value};botContext.wait(true);authContext.confirmFrontmSignup(botContext,user).then(function(){return DeviceStorageUtil.removeFromContext(FormHandler.SIGN_UP_IN_PROGRESS,botContext);}).then(function(){botContext.wait(false);tell('Success!! You are now registered with FrontM',botContext);if(botState.newUser){tell('Logging you in now',botContext);var newUser=botState.newUser;delete botState.newUser;FormHandler.login(botContext,newUser,true);}else{tell('Now sign in entering your email and password',botContext);MenuHelper.showMenu(MENU.LOGIN,botContext);}}).catch(function(error){console.log('sign up confirm error :',JSON.stringify(error));botContext.wait(false);tell(error.message,botContext);tell("If you haven't yet signed up, then please choose that option from the menu. If you are already signed up with FrontM, then please sign in",botContext);MenuHelper.showMenu(MENU.LOGIN,botContext);});},resetPassword:function resetPassword(message,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');var formMsg=message.getMessage();var user={email:formMsg[1].value};botContext.wait(true);authContext.resetPassword(botContext,user).then(function(){return DeviceStorageUtil.setInContext(FormHandler.RESET_IN_PROGRESS,true,botContext);}).then(function(){tell('A verification code has been sent to your registered email address. You will have to enter it to complete the reset process',botContext);MenuHandler.showResetCodeForm(message,state,previousMessages,botContext,user);}).catch(function(error){botContext.wait(false);tell(error.message,botContext);tell("If you haven't yet signed up, then please choose that option from the menu",botContext);MenuHelper.showMenu(MENU.LOGIN,botContext);});},confirmResetPassword:function confirmResetPassword(message,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');var formMsg=message.getMessage();var user={email:formMsg[1].value,password:formMsg[2].value,verificationCode:formMsg[3].value};botContext.wait(true);authContext.confirmReset(botContext,user).then(function(){return DeviceStorageUtil.removeFromContext(FormHandler.RESET_IN_PROGRESS,botContext);}).then(function(){botContext.wait(false);tell('Success!! Your password has been reset',botContext);tell('Logging you in now with your new password',botContext);FormHandler.login(botContext,user,true);}).catch(function(error){console.log('reset confirm error :',JSON.stringify(error));botContext.wait(false);tell(error.message,botContext);MenuHelper.showMenu(MENU.LOGIN,botContext);});},login:function login(botContext,user,isFrontmLogin,providerId){botContext.wait(true);var authContext=botContext.getCapability('authContext');var loginPromise=null;if(isFrontmLogin){loginPromise=authContext.loginWithFrontm(botContext,user);}else{loginPromise=authContext.login(botContext,providerId);}loginPromise.then(function(user){botState.userLoggedIn=true;tell('Hi '+user.info.userName+'! Welcome aboard. M here, the master bot of FrontM bot fleet',botContext);tell('Allow notifications?',botContext);MenuHelper.showMenu(MENU.PUSH_NOTIFICATION,botContext);}).catch(function(error){console.log('Login error :',error);if(error.code===0){botContext.wait(false);}else{if(isFrontmLogin){var msg=error.message||'Looks like you are not registered with us. Register with FrontM to access our chatbots';tell(msg,botContext);}else{tell('Error occurred while logging in',botContext);}}MenuHelper.showMenu(MENU.LOGIN,botContext);});},updateUserInfo:function updateUserInfo(msg,state,previousMessages,botContext){var _=botContext.getCapability('Utils').Lodash;var userDetails={};var newDomain=null;var addDomain=false;botContext.wait(true);var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(user){var userInfo=user.info||{};var dbDocument={};var screenName=msg.getMessage()[1].value||userInfo.screenName;var givenName=msg.getMessage()[2].value||userInfo.givenName;var lastName=msg.getMessage()[3].value||userInfo.surname;userDetails.screenName=screenName;userDetails.surname=lastName;userDetails.givenName=givenName;dbDocument.screenName=screenName;dbDocument.givenName=givenName;dbDocument.surname=lastName;var params={collection:'People',documents:[{key:{userId:user.userId},document:dbDocument}]};var agentGuardService=botContext.getCapability('agentGuardService');return agentGuardService.writeData(msg,botContext,user,previousMessages,params);}).then(function(){return authContext.updateUserDetails(userDetails,botContext);}).then(function(){tell('Done! Your details have been updated',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);}).catch(function(error){console.error('Error occurred while updating user details: ',error);tell('Error occurred: Unable to update your details',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);});},changeUserPwd:function changeUserPwd(msg,state,previousMessages,botContext){botContext.wait(true);var formMsg=msg.getMessage();var oldPassword=formMsg[3].value;var newPassword=formMsg[4].value;if(oldPassword===newPassword){botContext.wait(false);tell('Your new password must be different from your old password',botContext);return MenuHandler.showPwdChangeForm(msg,state,previousMessages,botContext);}var updatedUser={email:formMsg[2].value,oldPassword:oldPassword,newPassword:newPassword};var authContext=botContext.getCapability('authContext');authContext.updatePassword(updatedUser,botContext).then(function(){botContext.wait(false);tell('Your password has been updated',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);}).catch(function(error){console.log('Password update error :',JSON.stringify(error));botContext.wait(false);tell(error.message,botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);});}};var MenuHandler={EMAIL_USER_DATA_CAPABILITY:'EmailUserData',ADD_DOMAIN_ROLE_CAPABILITY:'SubscribeDomainRole',showSignInForm:function showSignInForm(message,state,previousMessages,botContext){var Message=botContext.getCapability('Message');var formMsg=new Message();formMsg.formMessage([{id:1,title:'Enter your details to sign in',type:'title'},{id:2,title:'Email',type:'email_field',optional:false},{id:3,title:'Password',type:'password_field',optional:false},{id:4,title:'Login',type:'button',action:'signIn'}],'');tell(formMsg,botContext);},signInWithFacebook:function signInWithFacebook(message,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');var providers=authContext.getAuthProviders(botContext);FormHandler.login(botContext,null,false,providers.facebook);},signInWithGoogle:function signInWithGoogle(message,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');var providers=authContext.getAuthProviders(botContext);FormHandler.login(botContext,null,false,providers.google);},showSignUpForm:function showSignUpForm(message,state,previousMessages,botContext,user){user=user||{};var Message=botContext.getCapability('Message');var formMsg=new Message();formMsg.formMessage([{id:1,title:'Enter your details',type:'title'},{id:2,text:'Password should be minimum 8 characters long with lower case, upper case, number and special characters in it',type:'text'},{id:3,title:'First Name',type:'text_field',optional:false,value:user.given_name},{id:4,title:'Last Name',type:'text_field',optional:false,value:user.family_name},{id:5,title:'Screen Name',type:'text_field',optional:false,value:user['custom:screenName']},{id:6,title:'Email',type:'email_field',optional:false,value:user.email},{id:7,title:'Password',type:'password_field',optional:false,retry:true},{id:8,title:'Register',type:'button',action:'signUp'}],'');tell(formMsg,botContext);},showConfirmationCodeForm:function showConfirmationCodeForm(message,state,previousMessages,botContext,user){user=user||{};var Message=botContext.getCapability('Message');var formMsg=new Message();formMsg.formMessage([{id:1,title:'Enter your confirmation code',type:'title'},{id:2,title:'Email',type:'text_field',optional:false,value:user.email},{id:3,title:'Code',type:'text_field',optional:false,value:user.confirmCode},{id:4,title:'Confirm',type:'button',action:'signupConfirm'}],'');tell(formMsg,botContext);},showResetForm:function showResetForm(message,state,previousMessages,botContext,user){user=user||{};var Message=botContext.getCapability('Message');var formMsg=new Message();formMsg.formMessage([{id:1,title:'Enter your details',type:'title'},{id:2,title:'Email',type:'text_field',optional:false,value:user.email},{id:3,title:'Reset',type:'button',action:'resetPassword'}],'');tell(formMsg,botContext);},showResetCodeForm:function showResetCodeForm(message,state,previousMessages,botContext,user){user=user||{};var Message=botContext.getCapability('Message');var formMsg=new Message();formMsg.formMessage([{id:1,title:'Enter your verification code',type:'title'},{id:2,title:'Email',type:'text_field',optional:false,value:user.email},{id:3,title:'New Password',type:'password_field',optional:false},{id:4,title:'Code',type:'text_field',optional:false},{id:5,title:'Reset',type:'button',action:'confirmResetPassword'}],'');tell(formMsg,botContext);},showUserForm:function showUserForm(message,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(usr){var Message=botContext.getCapability('Message');var message=new Message();message.formMessage([{id:1,title:'Enter your updated details',type:'title'},{id:2,title:'Screen Name',value:usr.info.screenName,type:'text_field',optional:false},{id:3,title:'First Name',value:usr.info.givenName,type:'text_field',optional:false},{id:4,title:'Last Name',value:usr.info.surname,type:'text_field',optional:false},{id:5,title:'Update',type:'button',action:'updateUserInfo'}],'');tell(message,botContext);});},showPwdChangeForm:function showPwdChangeForm(message,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(usr){var Message=botContext.getCapability('Message');var message=new Message();message.formMessage([{id:1,title:'Enter your new password',type:'title'},{id:2,text:'The new password should be different from your old password minimum 8 characters long with lower case, upper case, number and special characters in it',type:'text'},{id:3,title:'Email',type:'text_field',value:usr.info.emailAddress,editable:false},{id:4,title:'Old Password',type:'password_field',optional:false},{id:5,title:'New Password',type:'password_field',optional:false,retry:true},{id:6,title:'Change Password',type:'button',action:'changeUserPwd'}],'');tell(message,botContext);});},registerDevice:function registerDevice(message,state,previousMessages,botContext){var user=null;var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(usr){user=usr;var notification=botContext.getCapability('Notification');return notification.register();}).then(function(notificationDeviceInfo){botContext.wait(true);var agentGuardService=botContext.getCapability('agentGuardService');return agentGuardService.registerDevice(notificationDeviceInfo,botContext,user);}).then(function(){tell('Push notifications are activated for your device',botContext);if(botState.menuToShow===MENU.PUSH_NOTIFICATION){tell('Feel free to personalise the configuration from the menu below',botContext);tell("Touch the back arrow above to go to the home screen, your FrontM timeline. You will find collaboration tools in the menu there, and I'm always around to assist.",botContext);}return MenuHelper.showMenu(MENU.MAIN,botContext);});},deregisterDevice:function deregisterDevice(message,state,previousMessages,botContext){var user=null;var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(usr){user=usr;var notification=botContext.getCapability('Notification');return notification.deregister();}).then(function(notificationDeviceInfo){botContext.wait(true);var agentGuardService=botContext.getCapability('agentGuardService');return agentGuardService.deregisterDevice(notificationDeviceInfo,botContext,user);}).then(function(){tell('Push notifications are deactivated for your device',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);});},showNoPushNotificationMsg:function showNoPushNotificationMsg(message,state,previousMessages,botContext){tell('No problem, you can always ask me to activate them returning to this conversation',botContext);tell('Feel free to personalise the configuration from the menu below',botContext);tell("Touch the back arrow above to go to the home screen, your FrontM timeline. You will find collaboration tools in the menu there, and I'm always around to assist.",botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);},showConfigMenu:function showConfigMenu(message,state,previousMessages,botContext){return MenuHelper.showMenu(MENU.CONFIG,botContext);},showAccountMenu:function showAccountMenu(message,state,previousMessages,botContext){return MenuHelper.showMenu(MENU.ACCOUNT,botContext);},showLogoutMenu:function showLogoutMenu(message,state,previousMessages,botContext){return MenuHelper.showMenu(MENU.LOGOUT,botContext);},showDeleteDataMenu:function showDeleteDataMenu(message,state,previousMessages,botContext){tell('All your data will be permanently deleted. Do you want to proceed?',botContext);return MenuHelper.showMenu(MENU.DELETE_DATA,botContext);},showNetworkControlMenu:function showNetworkControlMenu(message,state,previousMessages,botContext){return MenuHelper.showMenu(MENU.NETWORK_CONTROL,botContext);},showNetworkUsageMenu:function showNetworkUsageMenu(message,state,previousMessages,botContext){tell('This functionality is coming in next release',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);},changePollingStrategy:function changePollingStrategy(message,state,previousMessages,botContext){var PollingStrategyTypes=botContext.getCapability('PollingStrategyTypes');var _=botContext.getCapability('Utils').Lodash;var selectedOption=message.getMessage();var chosenStrategy=_.get(PollingStrategyTypes,selectedOption.toLowerCase())||'gsm';var Settings=botContext.getCapability('Settings');return Settings.setPollingStrategy(chosenStrategy).then(function(){if(selectedOption==='Manual'){tell('You are in Manual Network Mode. You are consuming 0KB background data currently. You will need to touch the refresh button to fetch messages.',botContext);}else{tell('Network control has been updated to '+selectedOption,botContext);}return MenuHelper.showMenu(MENU.MAIN,botContext);});},showActivateBotMsg:function showActivateBotMsg(message,state,previousMessages,botContext){tell('If a company has invited you to use their Bots, please scan the QR Code or type the invitation code. Please note that invitation code is case sensitive',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);},emailMyData:function emailMyData(message,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(user){var agentGuardService=botContext.getCapability('agentGuardService');botContext.wait(true);var params={action:'Email'};return agentGuardService.executeCustomCapability(MenuHandler.EMAIL_USER_DATA_CAPABILITY,params,false,undefined,botContext,user);}).then(function(){tell('I will email your data to the email address you have used to login now. You should receive it shortly.',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);});},logout:function logout(message,state,previousMessages,botContext){var goodbyeMsg=null;var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(user){goodbyeMsg='Goodbye '+user.info.userName+', I will miss you and expect you back soon';return authContext.logout(botContext);}).then(function(){tell(goodbyeMsg||'Successfully logged out',botContext);return MenuHelper.showMenu(MENU.LOGIN,botContext);});},showNoLogoutMsg:function showNoLogoutMsg(message,state,previousMessages,botContext){tell('You can use this bot to logout anytime',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);},deleteDataAndLogout:function deleteDataAndLogout(message,state,previousMessages,botContext){var username=null;var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(user){username=user.info.userName;return authContext.deleteDataAndLogout(botContext);}).then(function(){tell('Goodbye '+username+'. Sorry to see you go',botContext);tell('Should you wish to sign up with FrontM again, you can choose one of the options in the menu below',botContext);return MenuHelper.showMenu(MENU.LOGIN,botContext);}).catch(function(){tell('We seem to be experiencing network difficulties at the moment. Please contact the support team and they will be able to help you',botContext);return MenuHelper.showMenu(MENU.LOGIN,botContext);});},showNoDeleteDataMsg:function showNoDeleteDataMsg(message,state,previousMessages,botContext){return MenuHelper.showMenu(MENU.MAIN,botContext);},uploadProfilePic:function uploadProfilePic(message,state,previousMessages,botContext){tell('Please choose a profile picture from your library',botContext);var authContext=botContext.getCapability('authContext');var _=botContext.getCapability('Utils').Lodash;var user=null;authContext.getAuthUser(botContext).then(function(usr){user=usr;var Media=botContext.getCapability('Media');return Media.pickMediaFromLibrary();}).then(function(media){if(media.cancelled){return null;}else{botContext.wait(true);var Resource=botContext.getCapability('Resource');var ResourceTypes=botContext.getCapability('ResourceTypes');return Resource.uploadFile(media.base64,media.uri,PROFILE_PIC_BUCKET,user.userId,ResourceTypes.Image,user,true);}}).then(function(fileUrl){if(_.isNull(fileUrl)){tell('You have disabled access to media library. Please enable access to upload a profile picture',botContext);}else{tell('Got it. This is your new profile picture',botContext);var Message=botContext.getCapability('Message');var _message=new Message();_message.imageMessage(fileUrl);tell(_message,botContext);}return MenuHelper.showMenu(MENU.MAIN,botContext);});},addDomainAndRoleToUser:function addDomainAndRoleToUser(msg,state,previousMessages,botContext){var _=botContext.getCapability('Utils').Lodash;botContext.wait(true);delete botState.activatePartnerBots;var authContext=botContext.getCapability('authContext');authContext.getAuthUser(botContext).then(function(user){var strMsg=msg.getMessage();var agentGuardService=botContext.getCapability('agentGuardService');return agentGuardService.executeCustomCapability(MenuHandler.ADD_DOMAIN_ROLE_CAPABILITY,{verificationCode:strMsg},true,undefined,botContext,user);}).then(function(data){if(_.isEmpty(_.compact(data))){tell("You should now be able to access the featured partner's bot",botContext);}else{tell('I do not recognise this code. Can you check if you entered that right?',botContext);}return MenuHelper.showMenu(MENU.MAIN,botContext);}).catch(function(error){console.error('Error occurred while updating user details: ',error);tell('Error occurred: Unable to activate the enterprise bots. Please reach out to the support team.',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);});}};var MENU={LOGIN:{menuRenderer:'showLoginMenu',options:[{title:'Login with Google',action:MenuHandler.signInWithGoogle},{title:'Login with Facebook',action:MenuHandler.signInWithFacebook},{title:'Sign in as an existing FrontM user',action:MenuHandler.showSignInForm},{title:'Sign up as a new FrontM user',action:MenuHandler.showSignUpForm},{title:'Reset FrontM user password',action:MenuHandler.showResetForm}]},PUSH_NOTIFICATION:{options:[{title:'Yes',action:MenuHandler.registerDevice},{title:'No',action:MenuHandler.showNoPushNotificationMsg}]},MAIN:{options:[{title:'Configuration',action:MenuHandler.showConfigMenu},{title:'My Account',action:MenuHandler.showAccountMenu},{title:'Logout',action:MenuHandler.showLogoutMenu}]},ACCOUNT:{options:[{title:'Add/change profile picture',action:MenuHandler.uploadProfilePic},{title:'Update user details',action:MenuHandler.showUserForm},{title:'Change password',action:MenuHandler.showPwdChangeForm},{title:'Activate Enterprise Bots',action:MenuHandler.showActivateBotMsg},{title:'Email my data',action:MenuHandler.emailMyData}]},LOGOUT:{options:[{title:'Yes',action:MenuHandler.logout},{title:'No',action:MenuHandler.showNoLogoutMsg},{title:'Delete my data',action:MenuHandler.showDeleteDataMenu}]},DELETE_DATA:{options:[{title:'Yes',action:MenuHandler.deleteDataAndLogout},{title:'No',action:MenuHandler.showNoDeleteDataMsg}]},CONFIG:{menuRenderer:'showConfigMenu',options:[{title:'Activate Push Notifications',action:MenuHandler.registerDevice,activateNotifications:true},{title:'Deactivate Push Notifications',action:MenuHandler.deregisterDevice,activateNotifications:false},{title:'Network control',action:MenuHandler.showNetworkControlMenu},{title:'Network usage',action:MenuHandler.showNetworkUsageMenu}]},NETWORK_CONTROL:{options:[{title:'Manual',action:MenuHandler.changePollingStrategy},{title:'Satellite',action:MenuHandler.changePollingStrategy},{title:'Terrestrial',action:MenuHandler.changePollingStrategy},{title:'Automatic',action:MenuHandler.changePollingStrategy}]}};var botState={};var MenuHelper={showMenu:function showMenu(menuToShow,botContext){var menuRenderer=menuToShow.menuRenderer||null;var _=botContext.getCapability('Utils').Lodash;if(menuRenderer===null){botState.menuToShow=menuToShow.options||menuToShow;var Message=botContext.getCapability('Message');var message=new Message();var options=_.map(botState.menuToShow,function(option){return{title:option.title};});message.sliderMessage(options,{smartReply:true});tell(message,botContext);}else{MenuHelper[menuRenderer](botContext,_);}},showConfigMenu:function showConfigMenu(botContext,_){var notification=botContext.getCapability('Notification');notification.deviceInfo().then(function(deviceInfo){var isDeviceUnregistered=_.isEmpty(deviceInfo)||!deviceInfo.isRegistered;var options=[];_.forEach(MENU.CONFIG.options,function(option){var activateNotifications=option.activateNotifications;if(_.isUndefined(activateNotifications)){options.push(option);}else{if(isDeviceUnregistered&&activateNotifications||!isDeviceUnregistered&&!activateNotifications){options.push(option);}}});MenuHelper.showMenu(options,botContext);});},showLoginMenu:function showLoginMenu(botContext,_){DeviceStorageUtil.getContext(botContext).then(function(context){var isSignUpInProgress=_.get(context,FormHandler.SIGN_UP_IN_PROGRESS)||false;if(isSignUpInProgress){var menuOptions=[{title:'Complete registration',action:MenuHandler.showConfirmationCodeForm}];return MenuHelper.showMenu(menuOptions,botContext);}var isResetInProgress=_.get(context,FormHandler.RESET_IN_PROGRESS)||false;if(isResetInProgress){var _menuOptions=[{title:'Complete password reset',action:MenuHandler.showResetCodeForm}];return MenuHelper.showMenu(_menuOptions,botContext);}return MenuHelper.showMenu(MENU.LOGIN.options,botContext);});}};var DeviceStorageUtil={BOT_CONTEXT:'MBot',getContext:function getContext(botContext,DeviceStorage){DeviceStorage=DeviceStorage||botContext.getCapability('DeviceStorage');return DeviceStorage.get(DeviceStorageUtil.BOT_CONTEXT);},setInContext:function setInContext(key,value,botContext){var DeviceStorage=botContext.getCapability('DeviceStorage');return DeviceStorageUtil.getContext(botContext,DeviceStorage).then(function(state){state=state||{};state[key]=value;return DeviceStorage.save(DeviceStorageUtil.BOT_CONTEXT,state);});},removeFromContext:function removeFromContext(key,botContext){var DeviceStorage=botContext.getCapability('DeviceStorage');return DeviceStorageUtil.getContext(botContext,DeviceStorage).then(function(state){delete state[key];return DeviceStorage.save(DeviceStorageUtil.BOT_CONTEXT,state);});}};var MessageProcessor={processFormMsg:function processFormMsg(message,state,previousMessages,botContext){var _=botContext.getCapability('Utils').Lodash;var formMsg=message.getMessage();var buttonIndex=_.findIndex(formMsg,function(formElement){return formElement.type==='button';});FormHandler[formMsg[buttonIndex].action](message,state,previousMessages,botContext);},processStringMsg:function processStringMsg(message,state,previousMessages,botContext){var _=botContext.getCapability('Utils').Lodash;var strMsg=message.getMessage().toLowerCase();var botStateMenu=botState.menuToShow;var index=_.findIndex(botStateMenu,function(option){return option.title.toLowerCase()===strMsg;});if(index===-1){if(botStateMenu===MENU.LOGIN){tell('I am sorry but I can only talk to authenticated users',botContext);return MenuHelper.showMenu(MENU.LOGIN,botContext);}else if(botState.activatePartnerBots){MenuHandler.addDomainAndRoleToUser(message,state,previousMessages,botContext);}else{MessageProcessor.processNlp(message,state,previousMessages,botContext);}}else{if(botState.menuToShow[index].title==='Activate Enterprise Bots'){botState.activatePartnerBots=true;}else{delete botState.activatePartnerBots;}botState.menuToShow[index].action(message,state,previousMessages,botContext);}},processNlp:function processNlp(msg,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');var _=botContext.getCapability('Utils').Lodash;var ONBOARDING_NLP_ID='FMBot';botContext.wait(true);authContext.getAuthUser(botContext).then(function(user){var agentGuardService=botContext.getCapability('agentGuardService');return agentGuardService.nlp(msg,botContext,user,previousMessages,ONBOARDING_NLP_ID);}).then(function(queryResp){var Message=botContext.getCapability('Message');var messages=queryResp.messages||[];var action=queryResp.action;var _GREETING='smalltalk.';var _INPUT='input.';if(_.isEmpty(messages)){var strMsg=queryResp.speech||'Unable to get results for the query';tell(strMsg,botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);}else if(_.includes(action,_INPUT)||_.includes(action,_GREETING)){var respMsg=queryResp.speech;tell(respMsg,botContext);}else if(action==='1_configurationMenu'){return MenuHelper.showMenu(MENU.CONFIG,botContext);}else{var type0Msg=_.find(messages,function(element){return element.type===0;});var type0MsgSpeech=type0Msg.speech;if(type0MsgSpeech){tell(type0MsgSpeech,botContext);}var typ2Or4Msg=_.find(messages,function(element){return element.type===4;});if(_.isEmpty(typ2Or4Msg)){typ2Or4Msg=_.find(messages,function(element){return element.type===2;});}if(typ2Or4Msg){var _messages=_.get(typ2Or4Msg,'payload.messages')||_.get(typ2Or4Msg,'replies')||[];var sliderMsgList=[];_.each(_messages,function(element){sliderMsgList.push({title:element});});var message=new Message();message.sliderMessage(sliderMsgList,{smartReply:true});tell(message,botContext);}else{return MenuHelper.showMenu(MENU.MAIN,botContext);}}});}};var tell=function tell(msg,botContext){botContext.tell(msg);};var greeting=function greeting(state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');authContext.isUserLoggedIn(botContext).then(function(userLoggedIn){if(userLoggedIn){return MenuHelper.showMenu(MENU.MAIN,botContext);}else{tell('Hello There!',botContext);tell('How would you like to sign in?',botContext);return MenuHelper.showMenu(MENU.LOGIN,botContext);}});};var next=function next(message,state,previousMessages,botContext){var MessageTypeConstants=botContext.getCapability('MessageTypeConstants');var msgType=message.getMessageType();switch(msgType){case MessageTypeConstants.MESSAGE_TYPE_STRING:MessageProcessor.processStringMsg(message,state,previousMessages,botContext);break;case MessageTypeConstants.MESSAGE_TYPE_FORM_RESPONSE:MessageProcessor.processFormMsg(message,state,previousMessages,botContext);break;}};var farewell=function farewell(){};var asyncResult=function asyncResult(result,state,previousMessages,botContext){};return{done:farewell,init:greeting,next:next,asyncResult:asyncResult,version:'1.0.0'};})();
