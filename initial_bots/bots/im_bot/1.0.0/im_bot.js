(function(){var ADD_CONTACT_ACTION='AddContact';var IGNORE_CONTACT_ACTION='IgnoreContact';var SEND_IM_MSG_CAPABILITY='SendIMMessage';var next=function next(message,state,previousMessages,botContext){return decode(message,state,previousMessages,botContext);};var greeting=function greeting(state,previousMessages,botContext){state.status='greeting';};var decode=function decode(message,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');var _=botContext.getCapability('Utils').Lodash;authContext.getAuthUser(botContext).then(function(user){if(message.getMessageType()==='button_response'){var action=message.getMessage().action||'';var contact=message.getMessage().user;var Contact=botContext.getCapability('Contact');Contact.getContactFieldForUUIDs(contact.userId).then(function(contacts){if(_.isEmpty(contacts)){var capParams={users:[contact.userId]};var agentGuardService=botContext.getCapability('agentGuardService');if(ADD_CONTACT_ACTION===action){agentGuardService.executeCustomCapability(ADD_CONTACT_ACTION,capParams,true,undefined,botContext,user,false).then(function(){return Contact.addContacts(contact);}).then(function(){tell('Contact '+contact.userName+' added',botContext);});}else if(IGNORE_CONTACT_ACTION===action){agentGuardService.executeCustomCapability(IGNORE_CONTACT_ACTION,capParams,true,undefined,botContext,user,false).then(function(){return Contact.ignoreContact(contact);}).then(function(){tell('Contact '+contact.userName+' ignored',botContext);});}}else{var contactStatus=contacts[0].ignored?'ignored':'added';tell('Contact '+contact.userName+' already '+contactStatus,botContext);}});return'Contact proccessed';}else{return sendImMessage(message,botContext,user,previousMessages);}}).catch(function(err){tell('Error occurred making the call to agent guard'+err,botContext);});};var sendImMessage=function sendImMessage(msg,botContext,user,previousMessages){var conversationContext=botContext.getCapability('ConversationContext');var _=botContext.getCapability('Utils').Lodash;conversationContext.getConversationContext(botContext,user).then(function(conversation){var isNewConversation=_.isUndefined(conversation.created);var agentGuardService=botContext.getCapability('agentGuardService');return agentGuardService.sendIMMessage(msg,isNewConversation,botContext,user,previousMessages);}).then(function(newConversationId){if(!_.isEmpty(newConversationId)){botContext.updateConversationContextId(newConversationId);}});};var tell=function tell(msg,botContext){botContext.tell(msg);};var state={};var debug=function debug(){return{localState:state};};var farewell=function farewell(msg,state,previousMessages,botContext){};var asyncResult=function asyncResult(result,state,previousMessages,botContext){var utils=botContext.getCapability('Utils');var _=utils.Lodash;var content=_.get(result,'details[0].message');var contentType=_.get(result,'contentType');var createdOn=_.get(result,'createdOn');var createdBy=_.get(result,'createdBy');var messageId=_.get(result,'messageId');var Message=botContext.getCapability('Message');var message=new Message({messageDate:createdOn,createdBy:createdBy,uuid:messageId});if(content){if(contentType==30){message.imageMessage(content);}else if(contentType==40){message.videoMessage(content);}else if(contentType==60){message.audioMessage(content);}else if(contentType==140){message.htmlMessage(content);}else{message.stringMessage(content);}tell(message,botContext);}var authContext=botContext.getCapability('authContext');var loggedInUser={};authContext.getAuthUser(botContext).then(function(user){loggedInUser=user;var conversationContext=botContext.getCapability('ConversationContext');return conversationContext.getConversationContext(botContext,user);}).then(function(conversation){var channelsInfo=conversation.onChannels;if(_.isEmpty(channelsInfo)){var Contact=botContext.getCapability('Contact');return Contact.getContactFieldForUUIDs([result.createdBy]);}else{return' ';}}).then(function(contacts){if(_.isEmpty(contacts)){return getUserInfo(botContext,loggedInUser,previousMessages,result.createdBy);}else{return null;}}).then(function(users){if(!_.isEmpty(users)&&users.length>0&&!_.isEmpty(users[0].items)&&_.isUndefined(state['AddIgnoreMsgShown'])){var contact=users[0].items[0];tell('User '+contact.userName+' would like to connect with you. Add user to contacts?',botContext);var msg=new Message();msg.buttonMessage([{title:'Accept',action:ADD_CONTACT_ACTION,user:contact,style:1},{title:'Ignore',action:IGNORE_CONTACT_ACTION,user:contact,style:0}],{smartReply:true});tell(msg,botContext);state['AddIgnoreMsgShown']=true;}});};var getUserInfo=function getUserInfo(botContext,user,previousMessages,userId){var agentGuardService=botContext.getCapability('agentGuardService');var params={collection:"People",query:[{operand:'userId',value:userId}],fields:['emailAddress','givenName','screenName','surname','userName','userId']};return agentGuardService.readData(null,botContext,user,previousMessages,params);};return{done:farewell,init:greeting,asyncResult:asyncResult,next:next,debug:debug,version:'1.0.0'};})();
