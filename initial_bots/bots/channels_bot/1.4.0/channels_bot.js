var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};(function(){var MenuHelper={showMenu:function showMenu(menuToShow,botContext,options){delete botState.selectedMenuItem;botState.menuToShow=menuToShow;if(MENU.MAIN===menuToShow){delete botState.createChannel;delete botState.selectedChannel;}var Message=botContext.getCapability('Message');var message=new Message();options=options||{smartReply:true};message.sliderMessage(menuToShow,options);tell(message,botContext);},getSelectedSliderOption:function getSelectedSliderOption(message,botContext){var _=botContext.getCapability('Utils').Lodash;var strMsg=message.getMessage().toLowerCase();var botStateMenu=botState.menuToShow;return _.findIndex(botStateMenu,function(option){return option.title.toLowerCase()===strMsg;});}};var FormHandler={FRONTM_DOMAIN:'frontmai',FIND_CONTACTS:'FindContacts',CHANNELS_CAP:'ChannelsCapability',PUBLIC_CHANNEL_TYPE:'public',PRIVATE_CHANNEL_TYPE:'private',checkChannelBeforeCreate:function checkChannelBeforeCreate(message,state,previousMessages,botContext){var _=botContext.getCapability('Utils').Lodash;var formMsg=message.getMessage();var getFormElement=function getFormElement(id){var ind=_.findIndex(formMsg,function(o){return o.id===id;});return formMsg[ind]||{value:false};};var isTeam=getFormElement(4).value==='true';var isPrivate=getFormElement(6).value==='true';var isDiscoverable=(isPrivate?getFormElement(8).value:'true')==='true';botState.createChannel={channelName:getFormElement(2).value,description:getFormElement(3).value,channelType:isPrivate?FormHandler.PRIVATE_CHANNEL_TYPE:FormHandler.PUBLIC_CHANNEL_TYPE,discoverable:isDiscoverable};console.log('Channel being created:::!!!',JSON.stringify(botState.createChannel),JSON.stringify(formMsg));if(isTeam){var authContext=botContext.getCapability('authContext');return authContext.getAuthUser(botContext).then(function(user){var userDomains=user.info.domains;var domainsList=[];_.forEach(userDomains,function(usrDomain){var dom=usrDomain.domain;if(domainsList.indexOf(dom)===-1&&dom!==FormHandler.FRONTM_DOMAIN){domainsList.push(dom);}});if(domainsList.length===1){botState.createChannel.userDomain=domainsList[0];return FormHandler.createChannel(botContext);}else{tell('You have chosen to create a team channel and have access to multiple domains',botContext);tell('Please choose a domain from the list',botContext);var domList=domainsList.map(function(domain){return{title:domain,action:MenuHandler.createChannelWithSelectedDomain};});return MenuHelper.showMenu(domList,botContext);}});}else{botState.createChannel.userDomain=FormHandler.FRONTM_DOMAIN;FormHandler.createChannel(botContext);}},createChannel:function createChannel(botContext){botContext.wait(true);var channelCap=botContext.getCapability('Channel');channelCap.create(botState.createChannel).then(function(){tell('Channel created',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);}).catch(function(){tell('Unable to create the channel. Is a channel with the same name already created? If so, you can subscribe to it',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);});},editChannel:function editChannel(msg,state,previousMessages,botContext){var desc=msg.getMessage()[1].value;var channel=msg.getMessage()[3].channel;botContext.wait(true);var channelCap=botContext.getCapability('Channel');channelCap.update(channel.channelName,desc,channel.userDomain).then(function(){tell('Channel updated',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);}).catch(function(){tell('We seem to be experiencing network difficulties. Please contact the support team and tell them that the issue occurred while updating the channel',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);});},searchUser:function searchUser(message,state,previousMessages,botContext){botContext.wait(true);var userName=message.getMessage()[1].value;var params={queryString:'find '+userName,userDomain:botState.selectedChannel.userDomain,filterUser:true};MenuHandler.callAgentGuard(FormHandler.FIND_CONTACTS,params,botContext).then(function(users){var _=botContext.getCapability('Utils').Lodash;if(_.isEmpty(users)){tell('Unable to find users matching your search criteria',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);}MenuHandler.displayUsers(users,'addUsersToChannel',botContext);}).catch(function(){tell('We seem to be experiencing network difficulties. Please contact the support team and tell them that the issue occurred while updating the channel',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);});}};var SliderHandler={addAdminsToChannels:function addAdminsToChannels(message,state,previousMessages,botContext){var selectedUserIds=message.getMessage().map(function(user){return user.userId;});var _=botContext.getCapability('Utils').Lodash;if(_.isEmpty(selectedUserIds)){return MenuHelper.showMenu(MENU.MAIN,botContext);}botContext.wait(true);var params=_extends({action:'AddChannelAdmins'},botState.selectedChannel,{adminUserIds:selectedUserIds});MenuHandler.callAgentGuard(FormHandler.CHANNELS_CAP,params,botContext).then(function(){tell('Added the selected users as managers to the channel',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);}).catch(function(){tell('We seem to be experiencing network difficulties. Please contact the support team and tell them that the issue occurred while add managers to channels',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);});},addUsersToChannel:function addUsersToChannel(message,state,previousMessages,botContext){var selectedUserIds=message.getMessage().map(function(user){return user.userId;});var _=botContext.getCapability('Utils').Lodash;if(_.isEmpty(selectedUserIds)){console.log('No userID!!!');return MenuHelper.showMenu(MENU.MAIN,botContext);}botContext.wait(true);var params=_extends({action:'AddUsersToChannel'},botState.selectedChannel,{newUserIds:selectedUserIds});MenuHandler.callAgentGuard(FormHandler.CHANNELS_CAP,params,botContext).then(function(){tell('Added the selected users to the channel',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);}).catch(function(){tell('We seem to be experiencing network difficulties. Please contact the support team and tell them that the issue occurred while add managers to channels',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);});}};var MenuHandler={GET_UNSUBED_CHANNELS:'GetUnsubbedChannels',GET_ADMIN_CHANNELS:'GetAdminChannels',showUnsubedChannels:function showUnsubedChannels(message,state,previousMessages,botContext){return MenuHandler.getChannels(botContext,MenuHandler.GET_UNSUBED_CHANNELS,MenuHandler.subscribeToChannels);},showAdminChannelsForEdit:function showAdminChannelsForEdit(message,state,previousMessages,botContext){return MenuHandler.getChannels(botContext,MenuHandler.GET_ADMIN_CHANNELS,MenuHandler.showEditChannelForm);},getAdminChannelsToAddAdmins:function getAdminChannelsToAddAdmins(message,state,previousMessages,botContext){return MenuHandler.getChannels(botContext,MenuHandler.GET_ADMIN_CHANNELS,MenuHandler.getChannelParticipants);},getAdminChannelsToAddUsers:function getAdminChannelsToAddUsers(message,state,previousMessages,botContext){return MenuHandler.getChannels(botContext,MenuHandler.GET_ADMIN_CHANNELS,MenuHandler.showUserSearchForm);},getChannelParticipants:function getChannelParticipants(message,state,previousMessages,botContext){botContext.wait(true);var _=botContext.getCapability('Utils').Lodash;var selectedChannel=botState.selectedMenuItem;botState.selectedChannel={channelName:selectedChannel.title,userDomain:selectedChannel.userDomain};var params={action:'GetChannelParticipants',channelName:selectedChannel.title,userDomain:selectedChannel.userDomain};MenuHandler.callAgentGuard(FormHandler.CHANNELS_CAP,params,botContext).then(function(participants){if(_.isEmpty(participants)){tell('The selected channel does not have any other participants',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);}MenuHandler.displayUsers(participants,'addAdminsToChannels',botContext);});},showUserSearchForm:function showUserSearchForm(message,state,previousMessages,botContext){var selectedChannel=botState.selectedMenuItem;botState.selectedChannel={channelName:selectedChannel.title,userDomain:selectedChannel.userDomain};tell('Select users add to the channel '+selectedChannel.title,botContext);var Message=botContext.getCapability('Message');var formMsg=new Message();formMsg.formMessage([{id:1,title:'Search users to add to channel',type:'title'},{id:2,title:'User name',type:'text_field',optional:false},{id:3,title:'Search',type:'button',action:'searchUser'}],'');tell(formMsg,botContext);},displayUsers:function displayUsers(users,action,botContext){var userList=users.map(function(person){var name=person.userName||person.givenName+' '+(person.surname||person.familyName);return{title:name,userId:person.userId,action:action,data:{contact_info:[{key:'Name',value:name},{key:'Email',value:person.emailAddress},{key:'Screen Name',value:person.screenName},{key:'Given Name',value:person.givenName},{key:'Sur Name',value:person.surname||person.familyName}]}};});return MenuHelper.showMenu(userList,botContext,{select:true,multiSelect:true});},showCreateChannelForm:function showCreateChannelForm(message,state,previousMessages,botContext){var formMsgContent=[{id:1,title:"Please enter the channel's details",type:'title'},{id:2,title:'Name',type:'text_field',optional:false,value:''},{id:3,title:'Description',type:'text_field',optional:false,value:''},{id:6,title:'Private',type:'checkbox'},{id:7,text:'Make it PRIVATE so users need invitation to join',type:'text'},{id:8,title:'Discoverable',type:'checkbox'},{id:9,text:'Make it DISCOVERABLE',type:'text'},{id:10,title:'Create',type:'button',action:'checkChannelBeforeCreate'}];var _=botContext.getCapability('Utils').Lodash;var authContext=botContext.getCapability('authContext');return authContext.getAuthUser(botContext).then(function(user){var userDomains=user.info.domains;var domainsList=[];_.forEach(userDomains,function(usrDomain){var dom=usrDomain.domain;if(domainsList.indexOf(dom)===-1&&dom!==FormHandler.FRONTM_DOMAIN){domainsList.push(dom);}});if(!_.isEmpty(domainsList)){formMsgContent.push({id:4,title:'Team',type:'checkbox'});formMsgContent.push({id:5,text:'For your TEAM only',type:'text'});formMsgContent=_.sortBy(formMsgContent,[function(o){return o.id;}]);}var Message=botContext.getCapability('Message');var formMsg=new Message();formMsg.formMessage(formMsgContent,'');tell(formMsg,botContext);});},showEditChannelForm:function showEditChannelForm(message,state,previousMessages,botContext){var _=botContext.getCapability('Utils').Lodash;var selectedChannel=botState.selectedMenuItem;var channel={channelName:selectedChannel.title,userDomain:selectedChannel.userDomain,description:_.get(selectedChannel,'data.channel_info[1].value')};var Message=botContext.getCapability('Message');var formMsg=new Message();formMsg.formMessage([{id:1,title:'Please edit the channel '+channel.channelName+' details',type:'title'},{id:2,title:'Description',type:'text_field',optional:false,value:channel.description},{id:3,title:'Edit',type:'button',action:'editChannel'},{channel:channel}],'');tell(formMsg,botContext);},subscribeToChannels:function subscribeToChannels(message,state,previousMessages,botContext){var _=botContext.getCapability('Utils').Lodash;var selectedChannel=botState.selectedMenuItem;console.log('Selected channel!!!',JSON.stringify(selectedChannel));if(FormHandler.PRIVATE_CHANNEL_TYPE===selectedChannel.channelType){botContext.wait(true);var params={action:'GetChannelAdmins',channelName:selectedChannel.title,userDomain:selectedChannel.userDomain};MenuHandler.callAgentGuard(FormHandler.CHANNELS_CAP,params,botContext).then(function(response){var userStr='';_.forEach(response,function(admin){userStr=userStr+admin.userName+' : '+admin.emailAddress+'\n';});tell('The channel '+selectedChannel.title+' is a private channel. Please request the group admins for access',botContext);tell('The group admins are as follows: ',botContext);tell(userStr,botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);});}else{botContext.wait(true);var publicChannelToSub={channelId:selectedChannel.channelId,channelName:selectedChannel.title,userDomain:selectedChannel.userDomain,channelType:selectedChannel.channelType,logo:selectedChannel.logo,description:_.get(selectedChannel,'data.channel_info[1].value')};var channelCap=botContext.getCapability('Channel');channelCap.subscribe([publicChannelToSub]).then(function(){tell('Subscribed to the public channel '+selectedChannel.title,botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);}).catch(function(){tell('We seem to be experiencing network difficulties. Please contact the support team and tell them that the issue occurred while subscribing to channels',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);});}},callAgentGuard:function callAgentGuard(capability,params,botContext){var authContext=botContext.getCapability('authContext');return authContext.getAuthUser(botContext).then(function(user){var agentGuardService=botContext.getCapability('agentGuardService');return agentGuardService.executeCustomCapability(capability,params,true,undefined,botContext,user);});},getChannels:function getChannels(botContext,action,menuAction){botContext.wait(true);MenuHandler.callAgentGuard(FormHandler.CHANNELS_CAP,{action:action},botContext).then(function(channels){var isAdminChannels=action===MenuHandler.GET_ADMIN_CHANNELS;channels=channels||[];var _=botContext.getCapability('Utils').Lodash;if(_.isEmpty(channels)){if(isAdminChannels){tell('You do not manage any channels',botContext);}else{tell('You have subscribed to all the channels',botContext);}return MenuHelper.showMenu(MENU.MAIN,botContext);}else{var channelList=MenuHandler.getChannelsListForDisplay(channels,menuAction);return MenuHelper.showMenu(channelList,botContext);}}).catch(function(){tell('We seem to be experiencing network difficulties. Please contact the support team and tell them that the issue occurred while trying to see the channels',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);});},getChannelsListForDisplay:function getChannelsListForDisplay(channels,menuAction){return channels.map(function(channel){var scope=FormHandler.FRONTM_DOMAIN===channel.userDomain?'Platform':'Team';return{title:channel.channelName,action:menuAction,data:{channel_info:[{key:'Name',value:channel.channelName},{key:'Description',value:channel.description},{key:'Scope',value:scope},{key:'Discoverable',value:channel.discoverable?'Yes':'No'},{key:'Type',value:channel.channelType}]},userDomain:channel.userDomain,channelType:channel.channelType,channelId:channel.channelId,logo:channel.logo};});},createChannelWithSelectedDomain:function createChannelWithSelectedDomain(message,state,previousMessages,botContext){botState.createChannel.userDomain=botState.selectedMenuItem.title;FormHandler.createChannel(botContext);}};var MessageProcessor={FIND_UNSUBED_CHANNELS:'FindChannels',processFormMsg:function processFormMsg(message,state,previousMessages,botContext){var _=botContext.getCapability('Utils').Lodash;var formMsg=message.getMessage();var buttonIndex=_.findIndex(formMsg,function(formElement){return formElement.type==='button';});FormHandler[formMsg[buttonIndex].action](message,state,previousMessages,botContext);},processStringMsg:function processStringMsg(message,state,previousMessages,botContext){var index=MenuHelper.getSelectedSliderOption(message,botContext);if(index===-1){MessageProcessor.processNlp(message,state,previousMessages,botContext);}else{var selectedMenuItem=botState.menuToShow[index];botState.selectedMenuItem=selectedMenuItem;selectedMenuItem.action(message,state,previousMessages,botContext);}},processNlp:function processNlp(msg,state,previousMessages,botContext){var authContext=botContext.getCapability('authContext');botContext.wait(true);authContext.getAuthUser(botContext).then(function(user){var agentGuardService=botContext.getCapability('agentGuardService');return agentGuardService.executeCustomCapability(MessageProcessor.FIND_UNSUBED_CHANNELS,{queryString:msg.getMessage()},true,undefined,botContext,user);}).then(function(channels){MenuHandler.displayUnsubbedChannelList(channels,botContext);}).catch(function(err){console.log(err);tell('We seem to be experiencing network difficulties. Please contact the support team and tell them that the issue occurred while trying to see channels list',botContext);return MenuHelper.showMenu(MENU.MAIN,botContext);});},processSliderMsg:function processSliderMsg(message,state,previousMessages,botContext){var sliderSelections=message.getMessage();var _=botContext.getCapability('Utils').Lodash;if(_.isEmpty(sliderSelections)){return MenuHelper.showMenu(MENU.MAIN_MENU,botContext);}else{return SliderHandler[sliderSelections[0].action](message,state,previousMessages,botContext);}}};var MENU={MAIN:[{title:'Show me channel suggestions',action:MenuHandler.showUnsubedChannels},{title:'Show me the channels I manage',action:MenuHandler.showAdminChannelsForEdit},{title:'Add other managers to my channels',action:MenuHandler.getAdminChannelsToAddAdmins},{title:'Add users to my channels',action:MenuHandler.getAdminChannelsToAddUsers},{title:'Create Channel',action:MenuHandler.showCreateChannelForm}]};var botState={};var tell=function tell(msg,botContext){botContext.tell(msg);};var greeting=function greeting(state,previousMessages,botContext){return MenuHelper.showMenu(MENU.MAIN,botContext);};var next=function next(message,state,previousMessages,botContext){var MessageTypeConstants=botContext.getCapability('MessageTypeConstants');var msgType=message.getMessageType();switch(msgType){case MessageTypeConstants.MESSAGE_TYPE_STRING:MessageProcessor.processStringMsg(message,state,previousMessages,botContext);break;case MessageTypeConstants.MESSAGE_TYPE_FORM_RESPONSE:MessageProcessor.processFormMsg(message,state,previousMessages,botContext);break;case MessageTypeConstants.MESSAGE_TYPE_SLIDER_RESPONSE:MessageProcessor.processSliderMsg(message,state,previousMessages,botContext);break;case MessageTypeConstants.MESSAGE_TYPE_FORM_CANCEL:case MessageTypeConstants.MESSAGE_TYPE_SLIDER_CANCEL:return MenuHelper.showMenu(MENU.MAIN,botContext);break;}};var debug=function debug(){};var farewell=function farewell(msg,state,previousMessages,botContext){};var asyncResult=function asyncResult(result,state,previousMessages,botContext){};return{done:farewell,init:greeting,asyncResult:asyncResult,next:next,debug:debug,version:'1.0.0'};})();