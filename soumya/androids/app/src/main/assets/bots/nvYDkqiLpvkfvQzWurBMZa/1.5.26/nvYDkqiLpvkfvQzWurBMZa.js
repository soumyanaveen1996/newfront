var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[typeof Symbol==="function"?Symbol.iterator:"@@iterator"](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break;}}catch(err){_d=true;_e=err;}finally{try{if(!_n&&_i["return"])_i["return"]();}finally{if(_d)throw _e;}}return _arr;}return function(arr,i){if(Array.isArray(arr)){return arr;}else if((typeof Symbol==="function"?Symbol.iterator:"@@iterator")in Object(arr)){return sliceIterator(arr,i);}else{throw new TypeError("Invalid attempt to destructure non-iterable instance");}};}();var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i];}return arr2;}else{return Array.from(arr);}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}(function(){var _this=this;var Bot=function Bot(botState){var _=botState._;var R=botState.R;var D=botState.developer;D.runProfile=Developer.PROD();botState.nlp.nlpEngine=NLP.OPEN_AI();botState.nlp.assistantName="Emma";botState.conversational=true;var BROADCAST_NOTIFICATION_HANDLER="broadcastNotificationHandler";var broadcastNotificationHandler=new Intent(BROADCAST_NOTIFICATION_HANDLER,botState);broadcastNotificationHandler.runOnCloud();broadcastNotificationHandler.onMatching=function(){return botState.messageFromUser.intentId===BROADCAST_NOTIFICATION_HANDLER;};broadcastNotificationHandler.onResolution=function _callee(){var key,responseFromRedis,redisContent,conversationFromRedis;return regeneratorRuntime.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:key="Conversations_"+botState.conversationId+"_"+botState.currentUserDomain;_context.next=3;return regeneratorRuntime.awrap(botState.db.getValueFromCache(key));case 3:responseFromRedis=_context.sent;redisContent=_.get(responseFromRedis,"content");conversationFromRedis={};if(redisContent){conversationFromRedis=JSON.parse(redisContent);}if(!(conversationFromRedis!=={})){_context.next=10;break;}_context.next=10;return regeneratorRuntime.awrap(botState.notification.sendPushNotifications([conversationFromRedis],botState.messageFromUser.notificationContent,{botId:botState.botId,userDomain:botState.currentUserDomain,userId:botState.user.userId,video:false}));case 10:botState.addStringResponse(botState.messageFromUser.messageContent);case 11:case"end":return _context.stop();}}},null,_this);};var LAST_EMMA_BROADCAST_NOTIFICATION="lastEmmaBroadcastNotification";var main=new Intent('main',botState);main.runOnCloud();main.onResolution=function _callee2(){var lastBroadcastNotification;return regeneratorRuntime.async(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return regeneratorRuntime.awrap(botState.nlp.clearConversationContext());case 2:_context2.next=4;return regeneratorRuntime.awrap(botState.getSharedField(LAST_EMMA_BROADCAST_NOTIFICATION));case 4:lastBroadcastNotification=_context2.sent;if(typeof lastBroadcastNotification!=="number"||Date.now()>lastBroadcastNotification+7200000){botState.addStringResponse("Hello "+botState.user.userName+"!");}else{botState.addSilentResponse();}case 6:case"end":return _context2.stop();}}},null,_this);};};var ALL_CONSTANTS={PERSISTED_FIELD_PREFIX:'PERSISTED_FIELD_',AUTO_SAVE_BUFFER_FIELD:'AUTO_SAVE_BUFFER_',PERSISTED_STORAGE:'PERSISTENT_STORAGE_',TO_SYNC_WITH_BACKEND:'toSyncWithBackend',AUTO_SAVE_INTENT_EDGE:'autoSaveIntentEdge',AUTO_SAVE_INTENT_CLOUD:'autoSaveIntentCloud',ACTIVITY_COLLECTION:'_activity',TABLES:{CHANGE_ACTION:'change',APPEND_ACTION:'append',CHANGE_FILTER_ACTION:'changeFilter',RESULTS_FILTER_ACTION:'resultsFilter',VALIDATION_FILTER_ACTION:'validationFilter',CHANGE_FILTER_FORM_ACTION:'changeFilterForm',RENAME_FILTER_ACTION:'renameFilter',MULTIPLE_SELECTION_ACTION:'multipleSelection',CLEAR_FILTER_ACTION:'clearFilter',CLEAR_SEARCH_ACTION:'clearSearch'},CALENDAR:{MONTHLY_VIEW:0,WEEKLY_VIEW:1,DAILY_VIEW:2},ES_INDEX_PREFIXES:{AUDIT:'audit',INDEX:'index'},DB_OPERATIONS:{INSERT:'insert',UPDATE:'update',UPSERT:'upsert',DELETE:'delete',QUERY:'query'},ACTIONS:{ACTION:'action',SEARCH:'search',ON_ACTION:'onAction',ON_SEARCH:'onSearch',ON_REFRESH:'onRefresh',ON_ERROR:'onError',ERROR:'error',DISCARD:'onDiscard'},CALL_ACTIONS:{CALL:'call',HAND_UP:'hangUp',RING_START:'ringStart',CALL_START:'callEnd',CALL_END:'callEnd'},MESSAGE_TYPES:{VOICE_CALL_RESPONSE:'voice_call_response',HTML_RESPONSE:'html_response'},COLLECTION_TYPES:{CALENDAR:'calendar',TABLE:'table',MAP:'map'},POINT_TYPE:{MARKER:'marker',ROUTE:'route',PLANE_ROUTE:'planeRoute'},MARKER_ICON_TYPE:{VESSEL:'arrow',AIRCRAFT:'aircraft',CIRCLE:'circle',POI:'poi'},FILE_SCOPE:{CONVERSATION:'conversation',BOT:'bot',DOMAIN:'domain'},SYSTEM_DB:'frontmai',COMMON_FIELDS:{LAST_MAIN_TIMESTAMP:'lastMainTimeStamp'},SYSTEM_TABLES:{COUNTRIES:'_countries'},SYSTEM_FIELDS:{COUNTRIES:'_countries',COUNTRY_NAMES:'_countriesNames'},NLP:{ENGINES:{OPEN_AI:"openAI"},FIELDS:{EMMA_PROMPT_KEY:"emmaPrompt",DEFAULT_PROMPT_KEY:"defaultPrompt",EMMA_NLP_KEY:"emmaNLP",DEFAULT_NLP_KEY:"defaultNLP"}}};var NLP=function(){_createClass(NLP,null,[{key:"DIALOGFLOW",value:function DIALOGFLOW(){return'dialogflow';}},{key:"LEX",value:function LEX(){return'lex';}},{key:"OPEN_AI",value:function OPEN_AI(){return'openAI';}},{key:"DEFAULT_ASSISTANT_NAME",value:function DEFAULT_ASSISTANT_NAME(){return'AI';}},{key:"CONVERSATION_CONTEXT_FIELD",value:function CONVERSATION_CONTEXT_FIELD(){return"_conversationContextField";}}]);function NLP(botState){_classCallCheck(this,NLP);this['_botState']=botState;this._nlpEngine=NLP.DIALOGFLOW();this._nlpIds=[];this._nlpAlias='';this._assistantName=NLP.DEFAULT_ASSISTANT_NAME();}_createClass(NLP,[{key:"clearConversationContext",value:function clearConversationContext(){this._botState.clearField(NLP.CONVERSATION_CONTEXT_FIELD());}},{key:"addNlp",value:function addNlp(nlpId){var _=this._botState._;var index=_.findIndex(this.nlpIds,function(existingId){return existingId===nlpId;});if(index===-1){this._nlpIds.push(nlpId);}}},{key:"getNlpParameters",value:function getNlpParameters(nlpParameters){var _this2=this;return nlpParameters;var parsedParameters={};var fields=nlpParameters.fields;var _=this._botState._;var processFields=function processFields(field){switch(fields[field].kind){case'stringValue':{parsedParameters[field]=fields[field].stringValue;break;}case'numberValue':{parsedParameters[field]=fields[field].numberValue;break;}case'structValue':{parsedParameters[field]=_this2.getNlpParameters(fields[field].structValue);break;}case'listValue':{var listFromNLP=_.get(fields[field],'listValue.values');var listToBot=[];_.each(listFromNLP,function(value){if(_.get(value,'structValue')){listToBot.push(_this2.getNlpParameters(_.get(value,'structValue')));}else{listToBot.push(_.get(value,'stringValue')||_.get(value,'numberValue')||'unknownType');}});parsedParameters[field]=listToBot;break;}default:break;}};this._botState.R.forEach(processFields,this._botState.R.keys(fields));return parsedParameters;}},{key:"runNlpForMessage",value:function runNlpForMessage(message){var _this3=this;var state=this._botState;var D=state.developer;var _=state._;var R=state.R;var nlpBotsList=this.nlpIds;D.info({message:'Starting NLP event',data:nlpBotsList});if(this.nlpEngine===NLP.DIALOGFLOW()){if(nlpBotsList.length>0){var params={capability:'NLP2',capabilityFileName:'nlpv2',queryString:message,nlpIds:nlpBotsList,sync:true,userId:state.user.userId,conversation:state.conversation};return state.callCapability(params).then(function(dataArray){var startNLP=Date.now();_.each(dataArray,function(nlpResponse){D.info({message:'Response from NLP',data:nlpResponse});if(nlpResponse.error==='Invalid NLP ID'){state.addSystemErrorToStack(24,nlpResponse.nlpId);return;}var nlpParameters='';var action=nlpResponse.action;var nlpId=nlpResponse.nlpId;D.info({message:'Found NLP action: ',data:action});if(nlpResponse.parameters&&_.size(nlpResponse.parameters)>0){nlpParameters=nlpResponse.parameters;D.info({message:'Found NLP parameters: ',data:nlpParameters});}var suggestions=[];if(nlpResponse.messages){_.forEach(nlpResponse.messages,function(entry){if(entry.type===4){if(entry.payload.messages){state.addSmartSuggestionsArray([{lang:state.lang,list:entry.payload.messages}]);suggestions=entry.payload.messages;}}});}state.nlpResults[nlpId]={speech:''};if(nlpResponse.speech&&nlpResponse.speech!==''){state.nlpResults[nlpId].speech=nlpResponse.speech;}state.nlpResults[nlpId].action=action;state.nlpResults[nlpId].nlpParameters=_this3.getNlpParameters(nlpParameters);state.nlpResults[nlpId].nlpSuggestions=suggestions;});D.logCurrentEventDurationWithStartTime('nlpAnalysis',startNLP,Date.now());});}else{D.warning({message:'No NLP Engine added to the bot'});}}return[];}},{key:"callOpenAIWithMessageFromUser",value:function callOpenAIWithMessageFromUser(){var _,D,newContent,conversationContext,promptName,nlpName,nlpParameters,prompt,options,response,text;return regeneratorRuntime.async(function callOpenAIWithMessageFromUser$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_=this._botState._;D=this._botState.developer;if(!(typeof this._botState.messageFromUser==="string")){_context3.next=43;break;}newContent="Human: "+this._botState.messageFromUser+"\n"+this._assistantName+": ";conversationContext=this._botState.getField(NLP.CONVERSATION_CONTEXT_FIELD());D.log({message:"Context",data:conversationContext});if(!(_.size(conversationContext)===0)){_context3.next=19;break;}promptName=this._assistantName!==NLP.DEFAULT_ASSISTANT_NAME()?this._assistantName.toLowerCase()+"Prompt":ALL_CONSTANTS.NLP.FIELDS.DEFAULT_PROMPT_KEY;_context3.next=10;return regeneratorRuntime.awrap(this._botState.getStaticData(promptName));case 10:_context3.t1=_context3.sent;if(_context3.t1){_context3.next=15;break;}_context3.next=14;return regeneratorRuntime.awrap(this._botState.getSystemStaticData(ALL_CONSTANTS.NLP.FIELDS.DEFAULT_PROMPT_KEY));case 14:_context3.t1=_context3.sent;case 15:_context3.t0=_context3.t1;if(_context3.t0){_context3.next=18;break;}_context3.t0="";case 18:conversationContext=_context3.t0;case 19:nlpName=this._assistantName!==NLP.DEFAULT_ASSISTANT_NAME()?this._assistantName.toLowerCase()+"NLP":ALL_CONSTANTS.NLP.FIELDS.DEFAULT_NLP_KEY;_context3.next=22;return regeneratorRuntime.awrap(this._botState.getStaticData(nlpName));case 22:_context3.t3=_context3.sent;if(_context3.t3){_context3.next=27;break;}_context3.next=26;return regeneratorRuntime.awrap(this._botState.getSystemStaticData(ALL_CONSTANTS.NLP.FIELDS.DEFAULT_NLP_KEY));case 26:_context3.t3=_context3.sent;case 27:_context3.t2=_context3.t3;if(_context3.t2){_context3.next=30;break;}_context3.t2={};case 30:nlpParameters=_context3.t2;prompt=""+conversationContext+newContent;options={body:{model:nlpParameters.model,prompt:prompt,temperature:nlpParameters.temperature,max_tokens:nlpParameters.max_tokens,top_p:nlpParameters.top_p,frequency_penalty:nlpParameters.frequency_penalty,presence_penalty:nlpParameters.presence_penalty,best_of:nlpParameters.best_of,stop:nlpParameters.stop,user:this._botState.user.userId}};_context3.next=35;return regeneratorRuntime.awrap(this._botState.api.callService("GPT-3",options));case 35:response=_context3.sent;text=_.get(response,"choices[0].text","Nothing to say");prompt=prompt+" "+text+"\n";this._botState.setField(NLP.CONVERSATION_CONTEXT_FIELD(),prompt);text=text.replace("OnShip","onship");text=text.replace("Onship","onship");text=text.trim();this._botState.addStringResponse(text);case 43:case"end":return _context3.stop();}}},null,this);}},{key:"assistantName",set:function set(name){this._assistantName=name;},get:function get(){return this._assistantName;}},{key:"nlpEngine",set:function set(nlpEngine){this._nlpEngine=nlpEngine;},get:function get(){return this._nlpEngine;}},{key:"nlpIds",get:function get(){return this._nlpIds;}},{key:"nlpAlias",get:function get(){return this._nlpAlias;},set:function set(nlpAlias){this._nlpAlias=nlpAlias;}}]);return NLP;}();var View=function(){function View(name,_ref){var botState=_ref.botState,obj=_ref.obj;_classCallCheck(this,View);this._botState=botState;this._object=obj;}_createClass(View,[{key:"sendResponse",value:function sendResponse(){}}]);return View;}();var Intent=function(){_createClass(Intent,null,[{key:"EDGE",value:function EDGE(){return'Edge';}},{key:"CLOUD",value:function CLOUD(){return'Cloud';}},{key:"NO_INTENT",value:function NO_INTENT(){return'input.unknown';}},{key:"SPEECH",value:function SPEECH(){return'speech';}},{key:"LOCATION",value:function LOCATION(){return'__location_';}},{key:"CONTACT",value:function CONTACT(){return'__contact_';}},{key:"IMAGE",value:function IMAGE(){return'__image_';}},{key:"VIDEO",value:function VIDEO(){return'__video_';}},{key:"FILE",value:function FILE(){return'__file_';}}]);function Intent(intentId,botState,tabId){_classCallCheck(this,Intent);this['_intentId']=intentId;this['_runLocation']=Intent.EDGE();this['_edgeEvents']=[];this['_cloudEvents']=[];this['_presentEvent']='';this['_nlpId']='';this['_smartSuggestions']=[];this['_dependencies']=[];this['_logHistory']=true;this['_silentIntent']=false;this.tabId=tabId||intentId;if(botState){this._botState=botState;this._botState.setIntentWithId(intentId,this);}}_createClass(Intent,[{key:"runOnCloud",value:function runOnCloud(){this._runLocation=Intent.CLOUD();}},{key:"runOnCloudWithEdgeEvents",value:function runOnCloudWithEdgeEvents(events){if(events&&Array.isArray(events)&&events.length>0){this._edgeEvents=events;}this._runLocation=Intent.CLOUD();}},{key:"runOnEdge",value:function runOnEdge(){this._runLocation=Intent.EDGE();}},{key:"runOnEdgeWithCloudEvents",value:function runOnEdgeWithCloudEvents(events){if(events&&Array.isArray(events)&&events.length>0){this._cloudEvents=events;}this._runLocation=Intent.EDGE();}},{key:"disableHistoryLogging",value:function disableHistoryLogging(){this._logHistory=false;}},{key:"silenceIntent",value:function silenceIntent(){this._silentIntent=true;}},{key:"setEnglishSmartSuggestions",value:function setEnglishSmartSuggestions(suggestions){if(Array.isArray(suggestions)){this._smartSuggestions=[{lang:'en',list:suggestions.reverse()}];}}},{key:"setEnglishSmartSuggestionsWithCondition",value:function setEnglishSmartSuggestionsWithCondition(defaultSuggestions,newSuggestions,conditionBlock){if(Array.isArray(newSuggestions)&&Array.isArray(defaultSuggestions)){if(conditionBlock()){this._smartSuggestions=[{lang:'en',list:newSuggestions.reverse()}];}else{this._smartSuggestions=[{lang:'en',list:defaultSuggestions.reverse()}];}}else{this._smartSuggestions=[{lang:'en',list:['Invalid smart suggestion type. Must be array']}];}}},{key:"setSmartSuggestions",value:function setSmartSuggestions(lang,suggestions){this._smartSuggestions=[{lang:lang,list:suggestions}];}},{key:"matchSuggestions",value:function matchSuggestions(message){if(this._botState){if(typeof this._botState.messageFromUser==='string'){var findSuggestion=function findSuggestion(suggestion){var list=suggestion.list;return list.includes(message);};return!!this._smartSuggestions.find(findSuggestion);}}return false;}},{key:"silentIntent",get:function get(){return this._silentIntent;}},{key:"logHistory",get:function get(){return this._logHistory;}},{key:"runLocation",get:function get(){if(this._edgeEvents.indexOf(this._presentEvent)>-1){return Intent.EDGE();}if(this._cloudEvents.indexOf(this._presentEvent)>-1){return Intent.EDGE();}return this._runLocation;}},{key:"onValidation",get:function get(){return this._onValidation;},set:function set(onValidationBlock){this._onValidation=onValidationBlock;}},{key:"onError",get:function get(){return this._onError;},set:function set(onErrorBlock){this._onError=onErrorBlock;this._onError=onErrorBlock;}},{key:"intentId",get:function get(){return this._intentId;}},{key:"nlpId",set:function set(nlpId){this._nlpId=nlpId;},get:function get(){return this._nlpId;}},{key:"suggestionsArray",get:function get(){return this._smartSuggestions;},set:function set(suggestions){this._smartSuggestions=suggestions;}},{key:"onMatching",get:function get(){return this._onMatching;},set:function set(matcher){this._onMatching=matcher;}},{key:"onResolution",get:function get(){return this['_onResolution'];},set:function set(resolver){this['_onResolution']=resolver;}}]);return Intent;}();var VoiceCall=function(_Intent){_inherits(VoiceCall,_Intent);function VoiceCall(intentId,botState){var _this5=this;_classCallCheck(this,VoiceCall);var _this4=_possibleConstructorReturn(this,(VoiceCall.__proto__||Object.getPrototypeOf(VoiceCall)).call(this,intentId,botState));_this4._botState=botState;_this4.onRingStart=function _callee3(){return regeneratorRuntime.async(function _callee3$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:case"end":return _context4.stop();}}},null,_this5);};_this4.onCallStart=function _callee4(){return regeneratorRuntime.async(function _callee4$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:case"end":return _context5.stop();}}},null,_this5);};_this4.onCallEnd=function _callee5(){return regeneratorRuntime.async(function _callee5$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:case"end":return _context6.stop();}}},null,_this5);};return _this4;}_createClass(VoiceCall,[{key:"message",value:function message(action,number){return{controlId:this.intentId,action:action,number:number};}},{key:"call",value:function call(number){this._botState.addVoiceCallResponse(this.message(ALL_CONSTANTS.CALL_ACTIONS.CALL,number));}},{key:"hangUp",value:function hangUp(){this._botState.addVoiceCallResponse(this.message(ALL_CONSTANTS.CALL_ACTIONS.HAND_UP));}},{key:"onMatching",get:function get(){var _this6=this;return function(state){return state.messageTypeFromUser===ALL_CONSTANTS.MESSAGE_TYPES.VOICE_CALL_RESPONSE&&state.messageFromUser.controlId===_this6.intentId;};}},{key:"onResolution",get:function get(){var _this7=this;return function _callee6(state){return regeneratorRuntime.async(function _callee6$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:state.currentControlId=_this7.intentId;if(!(state.messageFromUser.action===ALL_CONSTANTS.CALL_ACTIONS.RING_START)){_context7.next=6;break;}_context7.next=4;return regeneratorRuntime.awrap(_this7.onRingStart());case 4:_context7.next=17;break;case 6:if(!(state.messageFromUser.action===ALL_CONSTANTS.CALL_ACTIONS.CALL_START)){_context7.next=11;break;}_context7.next=9;return regeneratorRuntime.awrap(_this7.onCallStart());case 9:_context7.next=17;break;case 11:if(!(state.messageFromUser.action===ALL_CONSTANTS.CALL_ACTIONS.CALL_END)){_context7.next=16;break;}_context7.next=14;return regeneratorRuntime.awrap(_this7.onCallEnd());case 14:_context7.next=17;break;case 16:if(state.messageFromUser.action===ALL_CONSTANTS.ACTIONS.ERROR){state.addSystemErrorToStack(30,state.messageFromUser.errorMessage);}else{state.addSystemErrorToStack(30,Error.getErrorMessageforCodeAndLang(30));}case 17:if(state.responsesArray.length===0){state.addSilentResponse();}case 18:case"end":return _context7.stop();}}},null,_this7);};}}]);return VoiceCall;}(Intent);var VideoCall=function(_Intent2){_inherits(VideoCall,_Intent2);_createClass(VideoCall,null,[{key:"VIDEO_RESPONSE",value:function VIDEO_RESPONSE(){return'video_response';}},{key:"START_VIDEO_ACTION",value:function START_VIDEO_ACTION(){return'startVideo';}},{key:"RING_START_ACTION",value:function RING_START_ACTION(){return'ringStart';}},{key:"RING_STOP_ACTION",value:function RING_STOP_ACTION(){return'ringStop';}},{key:"TEXT_ACTION",value:function TEXT_ACTION(){return'text';}},{key:"PEER_REQUEST_ACTION",value:function PEER_REQUEST_ACTION(){return'peerRequest';}},{key:"BUSY_LINE_ACTION",value:function BUSY_LINE_ACTION(){return'busyLine';}},{key:"CALL_ACTIVE_ACTION",value:function CALL_ACTIVE_ACTION(){return'callActive';}},{key:"CALL_END_ACTION",value:function CALL_END_ACTION(){return'callEnd';}},{key:"CALL_ERROR_ACTION",value:function CALL_ERROR_ACTION(){return'error';}},{key:"CALL_PICKUP_ACTION",value:function CALL_PICKUP_ACTION(){return'pickup';}},{key:"CALL_MISSED_ACTION",value:function CALL_MISSED_ACTION(){return'missed';}},{key:"CALL_REJECTED_ACTION",value:function CALL_REJECTED_ACTION(){return'callReject';}},{key:"END_RING",value:function END_RING(){return'CallEnd';}},{key:"callVideoCap",value:function callVideoCap(botState,callData,action){var params=action===VideoCall.END_RING()?{capability:'VoipCapability',capabilityFileName:'voipCapability',callAction:action,action:"sendVoipPushNotification",videoSessionId:callData.videoSessionId,callerUserId:callData.userId,receiverUserId:callData.drId,userDomain:botState.currentUserDomain,video:true}:{capability:'VoiceCallCapability',capabilityFileName:'voiceCallCapability',action:action,videoSessionId:callData.videoSessionId,callInitiatorUserId:callData.userId,callConnectedUserId:callData.drId,userDomain:botState.currentUserDomain,metadata:{callData:callData}};botState.developer.log({message:"Params",data:params});return botState.callCapability(params);}},{key:"startVideoCallRequest",value:function startVideoCallRequest(botState,callData){return VideoCall.callVideoCap(botState,callData,'initiateVideoCall');}},{key:"videoCallConnected",value:function videoCallConnected(botState,callData){return VideoCall.callVideoCap(botState,callData,'connectSuccessVideoCall');}},{key:"endVideoCall",value:function endVideoCall(botState,callData){return VideoCall.callVideoCap(botState,callData,'endVideoCall');}},{key:"stopRing",value:function stopRing(botState,callData){try{botState.developer.log({message:"Stopping ring"});return VideoCall.callVideoCap(botState,callData,VideoCall.END_RING());}catch(e){return{error:e.message};}}},{key:"preConnectVideoCallCheck",value:function preConnectVideoCallCheck(botState,callData){return VideoCall.callVideoCap(botState,callData,'preConnectVideoCallCheck');}}]);function VideoCall(intentId,botState){var _this9=this;_classCallCheck(this,VideoCall);var _this8=_possibleConstructorReturn(this,(VideoCall.__proto__||Object.getPrototypeOf(VideoCall)).call(this,intentId,botState));_this8.onPeerRequest=function _callee7(){return regeneratorRuntime.async(function _callee7$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:case"end":return _context8.stop();}}},null,_this9);};_this8.onBusyLine=function _callee8(){return regeneratorRuntime.async(function _callee8$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:case"end":return _context9.stop();}}},null,_this9);};_this8.onCallActive=function _callee9(){return regeneratorRuntime.async(function _callee9$(_context10){while(1){switch(_context10.prev=_context10.next){case 0:case"end":return _context10.stop();}}},null,_this9);};_this8.onCallEnd=function _callee10(){return regeneratorRuntime.async(function _callee10$(_context11){while(1){switch(_context11.prev=_context11.next){case 0:case"end":return _context11.stop();}}},null,_this9);};_this8.onCallRejected=function _callee11(){return regeneratorRuntime.async(function _callee11$(_context12){while(1){switch(_context12.prev=_context12.next){case 0:case"end":return _context12.stop();}}},null,_this9);};_this8._botState=botState;_this8._video=true;_this8.action=VideoCall.START_VIDEO_ACTION();_this8._queue=0;return _this8;}_createClass(VideoCall,[{key:"message",value:function message(action){return{controlId:this.intentId,action:action,userDomain:this._botState.currentUserDomain,botId:this._botState.conversation.bot,conversationId:this._botState.conversation.conversationId,userId:this._botState.user.userId,userEmail:this._botState.user.userEmail,video:this._video,videoSessionId:this._videoSessionId,queue:this._queue,text:action===VideoCall.TEXT_ACTION()||action===VideoCall.CALL_PICKUP_ACTION()||action===VideoCall.START_VIDEO_ACTION()?this._text:null};}},{key:"startVideoRecording",value:function startVideoRecording(_ref2){var roomId=_ref2.roomId,participants=_ref2.participants,botId=_ref2.botId,intentId=_ref2.intentId,data=_ref2.data;var jobId,videoRecordingBot,params;return regeneratorRuntime.async(function startVideoRecording$(_context13){while(1){switch(_context13.prev=_context13.next){case 0:if(roomId){_context13.next=2;break;}return _context13.abrupt("return",{error:'Room Id is required parameter'});case 2:if(botId){_context13.next=4;break;}return _context13.abrupt("return",{error:'Bot Id is required parameter'});case 4:if(intentId){_context13.next=6;break;}return _context13.abrupt("return",{error:'IntentId Id is required parameter'});case 6:jobId=this._botState.getUniqueId();_context13.next=9;return regeneratorRuntime.awrap(this._botState.cc.getConfigurationForKey('videoRecordingBot'));case 9:videoRecordingBot=_context13.sent;params={toBot:videoRecordingBot,messages:[{content:{jobId:jobId,data:data,initiatorBotId:botId,initiatorIntentId:intentId,intentId:'startVideoRecording',botDomain:this._botState.conversation.userDomain,mediaSoupRoomId:roomId,participants:participants}}],jobId:jobId};_context13.next=13;return regeneratorRuntime.awrap(this._botState.jobScheduler.scheduleMessage(params));case 13:case"end":return _context13.stop();}}},null,this);}},{key:"getPaginatedVideoCalls",value:function getPaginatedVideoCalls(){var params,response;return regeneratorRuntime.async(function getPaginatedVideoCalls$(_context14){while(1){switch(_context14.prev=_context14.next){case 0:params={capability:'VoipCapability',capabilityFileName:'voipCapability',action:'getPaginatedVideoCalls',userId:this._botState.user.userId};_context14.next=3;return regeneratorRuntime.awrap(this._botState.callCapability(params));case 3:response=_context14.sent;state.developer.log({message:'Video calls response',data:this._botState._.size(response)});return _context14.abrupt("return",response);case 6:case"end":return _context14.stop();}}},null,this);}},{key:"video",set:function set(video){this._video=video;}},{key:"text",set:function set(text){this._text=text;}},{key:"queue",set:function set(queue){this._queue=queue;},get:function get(){return this._queue;}},{key:"videoSessionId",set:function set(videoSessionId){this._videoSessionId=videoSessionId;}},{key:"onMatching",get:function get(){var _this10=this;return function(state){return state.messageTypeFromUser===VideoCall.VIDEO_RESPONSE()&&state.messageFromUser.controlId===_this10.intentId;};}},{key:"onResolution",get:function get(){var _this11=this;return function _callee12(state){return regeneratorRuntime.async(function _callee12$(_context15){while(1){switch(_context15.prev=_context15.next){case 0:state.currentControlId=_this11.intentId;if(!(state.messageFromUser.action===VideoCall.PEER_REQUEST_ACTION())){_context15.next=6;break;}_context15.next=4;return regeneratorRuntime.awrap(_this11.onPeerRequest());case 4:_context15.next=27;break;case 6:if(!(state.messageFromUser.action===VideoCall.BUSY_LINE_ACTION())){_context15.next=11;break;}_context15.next=9;return regeneratorRuntime.awrap(_this11.onBusyLine());case 9:_context15.next=27;break;case 11:if(!(state.messageFromUser.action===VideoCall.CALL_ACTIVE_ACTION())){_context15.next=16;break;}_context15.next=14;return regeneratorRuntime.awrap(_this11.onCallActive());case 14:_context15.next=27;break;case 16:if(!(state.messageFromUser.action===VideoCall.CALL_END_ACTION())){_context15.next=21;break;}_context15.next=19;return regeneratorRuntime.awrap(_this11.onCallEnd());case 19:_context15.next=27;break;case 21:if(!(state.messageFromUser.action===VideoCall.CALL_REJECTED_ACTION())){_context15.next=26;break;}_context15.next=24;return regeneratorRuntime.awrap(_this11.onCallRejected());case 24:_context15.next=27;break;case 26:if(state.messageFromUser.action===VideoCall.CALL_ERROR_ACTION()){state.addSystemErrorToStack(30,state.messageFromUser.errorMessage);}else{state.developer.warning({message:Error.getErrorMessageforCodeAndLang(30),data:state.messageFromUser});}case 27:if(state.responsesArray.length===0){state.addSilentResponse();}case 28:case"end":return _context15.stop();}}},null,_this11);};}}]);return VideoCall;}(Intent);var Country=function(){_createClass(Country,null,[{key:"loadAllCountriesToCache",value:function loadAllCountriesToCache(botState){var data;return regeneratorRuntime.async(function loadAllCountriesToCache$(_context16){while(1){switch(_context16.prev=_context16.next){case 0:_context16.next=2;return regeneratorRuntime.awrap(botState.db.getDataFromCollection({collection:ALL_CONSTANTS.SYSTEM_TABLES.COUNTRIES,cache:false,system:true,limit:500}));case 2:data=_context16.sent;return _context16.abrupt("return",data.body);case 4:case"end":return _context16.stop();}}},null,this);}},{key:"setListOfCountryNamesForDropdowns",value:function setListOfCountryNamesForDropdowns(botState){var countries,countriesList;return regeneratorRuntime.async(function setListOfCountryNamesForDropdowns$(_context17){while(1){switch(_context17.prev=_context17.next){case 0:_context17.next=2;return regeneratorRuntime.awrap(Country.loadAllCountriesToCache(botState));case 2:countries=_context17.sent;countriesList=countries.map(function(country){return country.name;});botState.setField(ALL_CONSTANTS.SYSTEM_FIELDS.COUNTRY_NAMES,countriesList);return _context17.abrupt("return",countriesList);case 6:case"end":return _context17.stop();}}},null,this);}}]);function Country(_ref3){var botState=_ref3.botState,alpha2=_ref3.alpha2,alpha3=_ref3.alpha3,name=_ref3.name;_classCallCheck(this,Country);this._botState=botState;var D=this._botState.developer;this.alpha2=alpha2;this.alpha3=alpha3;this.name=name;}_createClass(Country,[{key:"load",value:function load(){var D,countryId,query,response,data;return regeneratorRuntime.async(function load$(_context18){while(1){switch(_context18.prev=_context18.next){case 0:D=this._botState.developer;countryId="_countryIdField_";query={};if(!this.alpha2){_context18.next=8;break;}query={alpha2:this.alpha2};countryId=countryId+this.alpha2;_context18.next=20;break;case 8:if(!this.alpha3){_context18.next=13;break;}query={alpha3:this.alpha3};countryId=countryId+this.alpha3;_context18.next=20;break;case 13:if(!this.name){_context18.next=18;break;}query={name:this.name};countryId=countryId+this.name;_context18.next=20;break;case 18:D.warning({message:"country has no identifier and cannot be found in the DB"});return _context18.abrupt("return");case 20:response=this._botState.getField(countryId);if(response){_context18.next=28;break;}_context18.next=24;return regeneratorRuntime.awrap(this._botState.db.getDataFromCollection({collection:ALL_CONSTANTS.SYSTEM_TABLES.COUNTRIES,query:query,cache:false,system:true}));case 24:data=_context18.sent;response=this._botState._.get(data,'body[0]');this._botState.setField(countryId,response);if(!response){D.warning({message:"Missing country in list",data:query});}case 28:return _context18.abrupt("return",response);case 29:case"end":return _context18.stop();}}},null,this);}}]);return Country;}();var GallerySelection=function(_Intent3){_inherits(GallerySelection,_Intent3);_createClass(GallerySelection,null,[{key:"GALLERY_SELECTION_RESPONSE",value:function GALLERY_SELECTION_RESPONSE(){return'gallerySelection_response';}},{key:"GALLERY_SELECTION_MESSAGE",value:function GALLERY_SELECTION_MESSAGE(){return'gallerySelection';}}]);function GallerySelection(intentId,botState){var _this13=this;_classCallCheck(this,GallerySelection);var _this12=_possibleConstructorReturn(this,(GallerySelection.__proto__||Object.getPrototypeOf(GallerySelection)).call(this,intentId,botState));_this12._gallery=[];_this12._onEnd=function _callee13(){return regeneratorRuntime.async(function _callee13$(_context19){while(1){switch(_context19.prev=_context19.next){case 0:case"end":return _context19.stop();}}},null,_this13);};return _this12;}_createClass(GallerySelection,[{key:"message",value:function message(){return{options:{controlId:this.intentId},gallery:this._gallery};}},{key:"gallery",set:function set(gallery){this._gallery=gallery;}},{key:"onMatching",get:function get(){var _this14=this;return function(state){return state.messageTypeFromUser===GallerySelection.GALLERY_SELECTION_RESPONSE()&&state.messageFromUser.controlId===_this14.intentId;};}},{key:"onResolution",get:function get(){var _this15=this;return function _callee14(state){return regeneratorRuntime.async(function _callee14$(_context20){while(1){switch(_context20.prev=_context20.next){case 0:state.currentControlId=_this15.intentId;if(!(state.messageFromUser.action==='end')){_context20.next=4;break;}_context20.next=4;return regeneratorRuntime.awrap(_this15.onEnd());case 4:if(state.responsesArray.length===0){state.addSilentResponse();}case 5:case"end":return _context20.stop();}}},null,_this15);};}},{key:"onEnd",set:function set(onEnd){this._onEnd=onEnd;},get:function get(){return this._onEnd;}}]);return GallerySelection;}(Intent);var JourneyPlan=function(_Intent4){_inherits(JourneyPlan,_Intent4);_createClass(JourneyPlan,null,[{key:"JOURNEY_PLAN_RESPONSE",value:function JOURNEY_PLAN_RESPONSE(){return'journeyPlan_response';}},{key:"JOURNEY_PLAN_MESSAGE",value:function JOURNEY_PLAN_MESSAGE(){return'journeyPlan';}}]);function JourneyPlan(intentId,botState){var _this17=this;_classCallCheck(this,JourneyPlan);var _this16=_possibleConstructorReturn(this,(JourneyPlan.__proto__||Object.getPrototypeOf(JourneyPlan)).call(this,intentId,botState));_this16._plan=[];_this16._label='';_this16._onEnd=function _callee15(){return regeneratorRuntime.async(function _callee15$(_context21){while(1){switch(_context21.prev=_context21.next){case 0:case"end":return _context21.stop();}}},null,_this17);};return _this16;}_createClass(JourneyPlan,[{key:"message",value:function message(){return{options:{controlId:this.intentId,label:this._label},plan:this._plan};}},{key:"label",set:function set(label){this._label=label;}},{key:"plan",set:function set(plan){this._plan=plan;}},{key:"onMatching",get:function get(){var _this18=this;return function(state){return state.messageTypeFromUser===JourneyPlan.JOURNEY_PLAN_RESPONSE()&&state.messageFromUser.controlId===_this18.intentId;};}},{key:"onResolution",get:function get(){var _this19=this;return function _callee16(state){return regeneratorRuntime.async(function _callee16$(_context22){while(1){switch(_context22.prev=_context22.next){case 0:state.currentControlId=_this19.intentId;if(state.responsesArray.length===0){state.addSilentResponse();}case 2:case"end":return _context22.stop();}}},null,_this19);};}}]);return JourneyPlan;}(Intent);var MenuEntry=function(_Intent5){_inherits(MenuEntry,_Intent5);function MenuEntry(intentId,_ref4){var _this21=this;var tabId=_ref4.tabId,menu=_ref4.menu,menuEntry=_ref4.menuEntry,label=_ref4.label,icon=_ref4.icon,description=_ref4.description,color=_ref4.color,_ref4$hidden=_ref4.hidden,hidden=_ref4$hidden===undefined?false:_ref4$hidden,botState=_ref4.botState,_ref4$order=_ref4.order,order=_ref4$order===undefined?999:_ref4$order,_ref4$onResponse=_ref4.onResponse,onResponse=_ref4$onResponse===undefined?function(self){}:_ref4$onResponse;_classCallCheck(this,MenuEntry);var _this20=_possibleConstructorReturn(this,(MenuEntry.__proto__||Object.getPrototypeOf(MenuEntry)).call(this,intentId,botState,tabId));_this20.onClick=function _callee17(){return regeneratorRuntime.async(function _callee17$(_context23){while(1){switch(_context23.prev=_context23.next){case 0:case"end":return _context23.stop();}}},null,_this21);};_this20._onResponse=onResponse;_this20._menuEntries=[];_this20._label=label;_this20._icon=icon;_this20._description=description;_this20._hidden=hidden;_this20._order=order;_this20._color=color;if(menu){_this20._menu=menu;}if(menuEntry){menuEntry.addMenuEntry(_this20);}else{if(menu)_this20.menu.addMenuEntry(_this20);}return _this20;}_createClass(MenuEntry,[{key:"addMenuEntry",value:function addMenuEntry(menuEntry){this._menuEntries.push(menuEntry);}},{key:"message",value:function message(){var getMenuArray=function getMenuArray(menuEntries){var menuArray=[];menuEntries.forEach(function(menuEntry){var entry=menuEntry.message();if(entry)menuArray.push(entry);});return menuArray;};this.onResponse(this);if(!this._hidden){var menuToReturn={id:this.intentId,tabId:this.tabId,label:this._label,icon:this._icon,description:this._description,color:this._color};if(this._menuEntries.length>0){var submenu=getMenuArray(this._menuEntries);menuToReturn.submenu=submenu;return menuToReturn;}return menuToReturn;}}},{key:"onResponse",set:function set(onResponse){this._onResponse=onResponse;},get:function get(){return this._onResponse;}},{key:"menu",set:function set(menu){this._menu=menu;menu.addMenuEntry(this);},get:function get(){return this._menu;}},{key:"label",set:function set(label){this._label=label;}},{key:"subMenu",get:function get(){return this._menuEntries;}},{key:"hidden",get:function get(){return this._hidden;},set:function set(hidden){this._hidden=hidden;}},{key:"onMatching",get:function get(){var _this22=this;return function(state){return state.messageTypeFromUser===Menu.MENU_RESPONSE()&&(_this22.menu&&state.messageFromUser.controlId===_this22.menu.intentId||_this22.menuEntry&&state.messageFromUser.controlId===_this22.menuEntry.intentId)&&state.messageFromUser.selectedEntry===_this22.intentId;};}},{key:"onResolution",get:function get(){var _this23=this;return function _callee18(state){return regeneratorRuntime.async(function _callee18$(_context24){while(1){switch(_context24.prev=_context24.next){case 0:state.currentControlId=_this23.intentId;_context24.next=3;return regeneratorRuntime.awrap(_this23.onClick());case 3:case"end":return _context24.stop();}}},null,_this23);};}}]);return MenuEntry;}(Intent);var Menu=function(_Intent6){_inherits(Menu,_Intent6);_createClass(Menu,null,[{key:"MENU_RESPONSE",value:function MENU_RESPONSE(){return'menu_response';}}]);function Menu(intentId,botState,tabId,title,pullDown){_classCallCheck(this,Menu);var _this24=_possibleConstructorReturn(this,(Menu.__proto__||Object.getPrototypeOf(Menu)).call(this,intentId,botState,tabId));_this24._menuEntries=[];_this24._pullDown=pullDown||false;_this24.title=title||"Menu";return _this24;}_createClass(Menu,[{key:"addMenuEntry",value:function addMenuEntry(menuEntry){if(this._menuEntries.length===0||menuEntry._order===999){this._menuEntries.push(menuEntry);}else{var index=0;var last=true;for(var i=0;i<this._menuEntries.length;i++){index=i;if(menuEntry._order<=this._menuEntries[i]._order){last=false;break;}}if(last){this._menuEntries.push(menuEntry);}else{this._menuEntries.splice(index,0,menuEntry);}}}},{key:"message",value:function message(){var _this25=this;var getMenuArray=function getMenuArray(){var menuArray=[];_this25._menuEntries.forEach(function(menuEntry){var entry=menuEntry.message();if(entry)menuArray.push(entry);});return menuArray;};return{menuEntries:getMenuArray(),options:{controlId:this.intentId,title:this.title,tabId:this.tabId,pullDown:this._pullDown}};}}]);return Menu;}(Intent);var Chat=function(_Intent7){_inherits(Chat,_Intent7);_createClass(Chat,null,[{key:"ASSIGNED_TO_USER",value:function ASSIGNED_TO_USER(){return'assignedToUser';}},{key:"TIMEOUT_REACHED",value:function TIMEOUT_REACHED(){return'timeoutReached';}},{key:"CONVERSATION_CLOSED",value:function CONVERSATION_CLOSED(){return'conversationClosed';}}]);function Chat(intentId,botState){var _this27=this;_classCallCheck(this,Chat);var _this26=_possibleConstructorReturn(this,(Chat.__proto__||Object.getPrototypeOf(Chat)).call(this,intentId,botState));_this26.onChatModeration=function _callee19(){return regeneratorRuntime.async(function _callee19$(_context25){while(1){switch(_context25.prev=_context25.next){case 0:case"end":return _context25.stop();}}},null,_this27);};return _this26;}_createClass(Chat,[{key:"onMatching",get:function get(){return function(state){return state.inSilence;};}},{key:"onResolution",get:function get(){var _this28=this;return function _callee20(state){var sendEmail;return regeneratorRuntime.async(function _callee20$(_context27){while(1){switch(_context27.prev=_context27.next){case 0:state.currentControlId=_this28.intentId;sendEmail=function sendEmail(emailAddress,userName,operatorName,operatorUserId,botId,conversationId){var _,emailBody,transcription,messages;return regeneratorRuntime.async(function sendEmail$(_context26){while(1){switch(_context26.prev=_context26.next){case 0:_=state._;emailBody='';_context26.next=4;return regeneratorRuntime.awrap(state.cc.getTranscriptionForCurrentConversation({}));case 4:transcription=_context26.sent;messages=[];_.forEach(_.get(transcription,'messages'),function(message){var i=0;while(i<messages.length&&message.createdOn>messages[i].createdOn){i++;}messages.splice(i,0,message);});_.forEach(messages,function(message){var content=_.get(message,'content');if(_.get(message,'contentType')==='10'){if(_.get(message,'createdBy')===state.user.userId){emailBody=emailBody+("<p>"+userName+": "+content[0]+"</p>");}else if(!_.get(message,'createdBy')){emailBody=emailBody+("<p>Chatbot: "+content[0]+"</p>");}else if(_.get(message,'createdBy')===operatorUserId){emailBody=emailBody+("<p>"+operatorName+": "+content[0]+"</p>");}else{emailBody=emailBody+("<p>Chatbot: "+content[0]+"</p>");}}else if(_.get(message,'contentType')==='400'){var form=state._.get(message,'content')[0];if(state._.get(form,'action')===Doc.CONFIRM_FORM_ACTION()){var fields=Doc.formResponseAsObject(form);emailBody=emailBody+"<p>Personal information</p>";emailBody=emailBody+"<ul>";state._.forEach(fields,function(value,key){emailBody=emailBody+("<li>"+key+": "+value+"</li>");});emailBody=emailBody+"</ul>";}}});_context26.next=10;return regeneratorRuntime.awrap(state.notification.sendEmail(emailAddress,'Conversation transcription',emailBody));case 10:case"end":return _context26.stop();}}},null,_this28);};_context27.next=4;return regeneratorRuntime.awrap(_this28.onChatModeration());case 4:if(!(state.responsesArray.length===0)){_context27.next=30;break;}if(!(state.messageFromUser.intentId===Chat.ASSIGNED_TO_USER())){_context27.next=9;break;}state.addStringResponse("You will start a conversation with "+state.messageFromUser.userName);_context27.next=26;break;case 9:if(!(state.messageFromUser.intentId===Chat.TIMEOUT_REACHED())){_context27.next=16;break;}state.addStringResponse("All our operators are busy at this moment, your contact details have been sent to our advisory team and they will contact you soon");state.wakeUpBot();_context27.next=14;return regeneratorRuntime.awrap(sendEmail('support@frontm.com',state.messageFromUser.userName,state.messageFromUser.operatorName,state.messageFromUser.operatorUserId));case 14:_context27.next=26;break;case 16:if(!(state.messageFromUser.intentId===Chat.CONVERSATION_CLOSED())){_context27.next=26;break;}state.addStringResponse("The conversation has been closed. Thank you very much for talking with us");state.wakeUpBot();if(!state.messageFromUser.emailEndUser){_context27.next=23;break;}_context27.next=22;return regeneratorRuntime.awrap(sendEmail(state.messageFromUser.emailAddress,state.messageFromUser.userName,state.messageFromUser.operatorName,state.messageFromUser.operatorUserId,state.messageFromUser.botId,state.messageFromUser.conversationId));case 22:state.addStringResponse('We have sent you an email with the transcription of the conversation');case 23:if(!state.messageFromUser.ccEmailAddress){_context27.next=26;break;}_context27.next=26;return regeneratorRuntime.awrap(sendEmail(state.messageFromUser.ccEmailAddress,state.messageFromUser.userName,state.messageFromUser.operatorName,state.messageFromUser.operatorUserId,state.messageFromUser.botId,state.messageFromUser.conversationId));case 26:state.addSilentResponse();state.notification.sendIMMessage();_context27.next=30;break;case 30:case"end":return _context27.stop();}}},null,_this28);};}}]);return Chat;}(Intent);var HTML=function(_Intent8){_inherits(HTML,_Intent8);function HTML(intentId,_ref5){var title=_ref5.title,url=_ref5.url,_ref5$autopopup=_ref5.autopopup,autopopup=_ref5$autopopup===undefined?false:_ref5$autopopup,_ref5$modal=_ref5.modal,modal=_ref5$modal===undefined?true:_ref5$modal,_ref5$external=_ref5.external,external=_ref5$external===undefined?true:_ref5$external,_ref5$embedded=_ref5.embedded,embedded=_ref5$embedded===undefined?false:_ref5$embedded,_ref5$toPDF=_ref5.toPDF,toPDF=_ref5$toPDF===undefined?false:_ref5$toPDF,_ref5$kibana=_ref5.kibana,kibana=_ref5$kibana===undefined?false:_ref5$kibana,_ref5$height=_ref5.height,height=_ref5$height===undefined?0:_ref5$height,content=_ref5.content,botState=_ref5.botState;_classCallCheck(this,HTML);var _this29=_possibleConstructorReturn(this,(HTML.__proto__||Object.getPrototypeOf(HTML)).call(this,intentId,botState));_this29.title=title;_this29.controlId=intentId;_this29.url=url;_this29.autopopup=autopopup;_this29.modal=modal;_this29.external=external;_this29.embedded=embedded;_this29.toPDF=toPDF;_this29.content=content;_this29.height=height;_this29.kibana=kibana;return _this29;}_createClass(HTML,[{key:"message",value:function message(){return{name:this.intentId,controlId:this.controlId,title:this.title,url:this.url,autopopup:this.autopopup,modal:this.modal,external:this.external,embedded:this.embedded,toPDF:this.toPDF,height:this.height,content:this.content,kibana:this.kibana};}},{key:"sendMessage",value:function sendMessage(){this._botState.addHTMLResponse(this.message());}},{key:"onMatching",get:function get(){var _this30=this;return function(state){return state.messageTypeFromUser===ALL_CONSTANTS.MESSAGE_TYPES.HTML_RESPONSE&&state.messageFromUser.controlId===_this30.intentId;};}},{key:"onResolution",get:function get(){var _this31=this;return function _callee21(state){return regeneratorRuntime.async(function _callee21$(_context28){while(1){switch(_context28.prev=_context28.next){case 0:state.addSilentResponse();case 1:case"end":return _context28.stop();}}},null,_this31);};}}]);return HTML;}(Intent);var Container=function(_Intent9){_inherits(Container,_Intent9);_createClass(Container,null,[{key:"CONTAINER_CLOSE",value:function CONTAINER_CLOSE(){return'close';}},{key:"CONTAINER_RESPONSE",value:function CONTAINER_RESPONSE(){return'container_response';}},{key:"CONFIRM_CONTAINER_ACTION",value:function CONFIRM_CONTAINER_ACTION(){return'confirm';}},{key:"CANCEL_CONTAINER_ACTION",value:function CANCEL_CONTAINER_ACTION(){return'cancel';}},{key:"MORE_CONTAINER_ACTION",value:function MORE_CONTAINER_ACTION(){return'more';}},{key:"ExpandShortContainerResponse",value:function ExpandShortContainerResponse(shortResponse,botState){var _,D;return regeneratorRuntime.async(function ExpandShortContainerResponse$(_context29){while(1){switch(_context29.prev=_context29.next){case 0:_=botState._;D=botState.developer;_.forEach(shortResponse,function(entry){if(_.get(entry,'type')==='table'||_.get(entry,'type')==='calendar'||_.get(entry,'type')==='map'){var newOptions=_.get(entry,'message.options');var key=_.get(newOptions,'controlId');var rowsArr=_.get(entry,'message.rows');var rows=[];_.forEach(rowsArr,function(rowArr){var row={};_.forEach(newOptions.keysForShortMessage,function(key,i){if(rowArr[0][i])row[key]=rowArr[0][i];});row.docId=rowArr[1][0];row.allowEdit=rowArr[1][1];row.allowDelete=rowArr[1][2];row.rowMenu=rowArr[1][3];rows.push(row);});var collection=botState._intents[key];collection.overrideOptions(newOptions);collection.clearRows();collection.buildRowsFromArray(rows);var preserveFieldDataFields=Object.keys(collection._preserveFieldData);collection._rows.map(function(row,rowIdx){preserveFieldDataFields.map(function(field,fieldIdx){collection._preserveFieldData[field].map(function(fieldProp,fieldPropIdx){row.f[field][fieldProp]=rowsArr[rowIdx][2][fieldIdx][fieldPropIdx];});});});entry.message.options=collection.options;entry.message.rows=collection.message(false,false).rows;}else if(_.get(entry,'type')==='form2'){var fieldKeys=_.get(entry.message.fields,"fieldKeys",[]);var fieldData=_.get(entry.message.fields,"fieldData",[]);var fields=[];_.forEach(fieldData,function(fieldArray){var fieldObj={};_.forEach(fieldKeys,function(fieldParam,index){if(fieldArray[index]!=null){fieldObj[fieldParam]=fieldArray[index];}});fields.push(fieldObj);});entry.message.fields=fields;}});return _context29.abrupt("return",shortResponse);case 4:case"end":return _context29.stop();}}},null,this);}},{key:"containerResponseAsObject",value:function containerResponseAsObject(message){var container=message.container;var results={};if(Array.isArray(container)){container.forEach(function(entry){if(entry.formId){results[entry.formId]=Doc.formResponseAsObject(entry);}else{if(entry.tableId){results[entry.tableId]=entry.rows;}}});}return results;}}]);function Container(intentId,_ref6){var _this33=this;var tabId=_ref6.tabId,title=_ref6.title,description=_ref6.description,allowMinimize=_ref6.allowMinimize,allowClose=_ref6.allowClose,_ref6$minimizeOnConfi=_ref6.minimizeOnConfirm,minimizeOnConfirm=_ref6$minimizeOnConfi===undefined?false:_ref6$minimizeOnConfi,_ref6$promptOnClose=_ref6.promptOnClose,promptOnClose=_ref6$promptOnClose===undefined?false:_ref6$promptOnClose,_ref6$updateInBackgro=_ref6.updateInBackground,updateInBackground=_ref6$updateInBackgro===undefined?false:_ref6$updateInBackgro,zone=_ref6.zone,confirm=_ref6.confirm,cancel=_ref6.cancel,_ref6$more=_ref6.more,more=_ref6$more===undefined?[]:_ref6$more,keysDocument=_ref6.keysDocument,_ref6$modal=_ref6.modal,modal=_ref6$modal===undefined?true:_ref6$modal,botState=_ref6.botState,_ref6$onResponse=_ref6.onResponse,onResponse=_ref6$onResponse===undefined?function(self){}:_ref6$onResponse;_classCallCheck(this,Container);var _this32=_possibleConstructorReturn(this,(Container.__proto__||Object.getPrototypeOf(Container)).call(this,intentId,botState,tabId));_this32.onClose=function _callee22(){return regeneratorRuntime.async(function _callee22$(_context30){while(1){switch(_context30.prev=_context30.next){case 0:case"end":return _context30.stop();}}},null,_this33);};_this32.onSubmit=function _callee23(){return regeneratorRuntime.async(function _callee23$(_context31){while(1){switch(_context31.prev=_context31.next){case 0:case"end":return _context31.stop();}}},null,_this33);};_this32.onCancel=function _callee24(){return regeneratorRuntime.async(function _callee24$(_context32){while(1){switch(_context32.prev=_context32.next){case 0:case"end":return _context32.stop();}}},null,_this33);};_this32.onMoreButtons=function _callee25(){return regeneratorRuntime.async(function _callee25$(_context33){while(1){switch(_context33.prev=_context33.next){case 0:case"end":return _context33.stop();}}},null,_this33);};_this32.onResponse=onResponse;_this32.controlId=intentId;_this32.title=title;_this32.description=description;_this32.allowMinimize=allowMinimize;_this32.minimizeOnConfirm=minimizeOnConfirm;_this32.allowClose=allowClose;_this32.updateInBackground=updateInBackground;_this32._fields=[];_this32.zone=zone;_this32._children=[];_this32._keys=[];_this32._more=more;_this32.confirm=confirm;_this32.cancel=cancel;_this32.modal=modal;_this32.docId=botState?botState.user.userId:_this32.intentId;_this32.promptOnClose=promptOnClose;_this32._keysDocument=keysDocument;if(keysDocument&&keysDocument._fields){_this32._keys=keysDocument._fields;}return _this32;}_createClass(Container,[{key:"setContainerTabId",value:function setContainerTabId(tabId){var _=this.document._botState._;this.tabId=tabId;_.forEach(this._rows,function(row){row.tabId=tabId;});}},{key:"insertChild",value:function insertChild(index,child){if(child){child.parent=this;this._children.splice(index,0,child);}else{if(this._botState){this._botState.addSystemErrorToStack(7,'A null child is being added to a container');}}}},{key:"addChild",value:function addChild(child){if(child){child.parent=this;this._children.push(child);}else{if(this._botState){this._botState.addSystemErrorToStack(7,'A null child is being added to a container');}}}},{key:"removeChild",value:function removeChild(child){if(child){delete child.parent;var index=0;for(var i=0;i<this._children.length;i++){var oldChild=this._children[i];if(oldChild.intentId===child.intentId){index=i;}}this._children.splice(index,1);}else{if(this._botState){this._botState.addSystemErrorToStack(7,'A null child is being added to a container');}}}},{key:"addForm",value:function addForm(formMessage){this._fields.push({type:'form2',message:formMessage});}},{key:"addTable",value:function addTable(tableMessage){this._fields.push({type:'table',message:tableMessage});}},{key:"setKeysDocument",value:function setKeysDocument(document){if(document instanceof Doc&&document._fields){this._keys=document._fields;this._keysDocument=document;}}},{key:"addKeys",value:function addKeys(keys){var _this34=this;if(Array.isArray(keys)){keys.forEach(function(key){_this34.addKey(key);});}else{this.addKey(keys);}}},{key:"addKey",value:function addKey(key){if(key instanceof Field){this._keys.push(key);}}},{key:"loadDocFromAutoSaveBuffer",value:function loadDocFromAutoSaveBuffer(tabId,skipCollections,withPostBuilds){var _this35=this;var botState,skipPostBuilds,_2,_D,currentTabId,autoSaveBuffer;return regeneratorRuntime.async(function loadDocFromAutoSaveBuffer$(_context34){while(1){switch(_context34.prev=_context34.next){case 0:botState=this._botState;if(!botState){_context34.next=15;break;}skipPostBuilds=true;if(withPostBuilds)skipPostBuilds=false;botState.duringBuild=true;_2=botState._;_D=botState.developer;currentTabId=tabId||botState.currentTabId||this.intentId;autoSaveBuffer=_2.get(botState.autoSaveBuffer,""+currentTabId);if(!(_2.size(autoSaveBuffer)===0)){_context34.next=13;break;}_context34.next=12;return regeneratorRuntime.awrap(botState.loadAutoSaveBuffer());case 12:autoSaveBuffer=_2.get(botState.autoSaveBuffer,""+currentTabId);case 13:_2.forEach(autoSaveBuffer,function(value,key){var collection=_this35._botState._intents[key];var doc=collection.document;if(_2.keys(value).length>0){var docId=botState.user.userId;if(!_2.get(_this35._botState.messageFromUser,'parentDocId')){_this35._botState.messageFromUser.parentDocId=docId;}doc.docId=docId;var docFromAutoSave=value[docId];_2.forEach(doc.fields,function(field){field.value=docFromAutoSave[field.intentId];});if(_2.size(doc._subDocs)>0){_2.forEach(doc._subDocs,function(subDoc){var doc=docFromAutoSave[subDoc.intentId];if(doc){subDoc.buildDocument(doc,true);}});}else{doc.buildDocument(docFromAutoSave);}if(!skipCollections){_2.forEach(doc._subCollections,function(subCollection){var collectionFromAutoSave=docFromAutoSave[subCollection.intentId];subCollection.clearRows();_2.forEach(collectionFromAutoSave,function(value,key){var newDoc=Doc.createNewInstanceFromDoc(subCollection._document);subCollection.addRow(newDoc);newDoc.docId=key;if(newDoc.hasSubDocs){newDoc.buildDocumentFromContainer(value,skipPostBuilds);}else{newDoc.buildDocument(value,skipPostBuilds);}});});}}else{_this35._botState.addSystemErrorToStack(52);}});this._botState.duringBuild=false;case 15:case"end":return _context34.stop();}}},null,this);}},{key:"generateAutoSaveBufferFromContainer",value:function generateAutoSaveBufferFromContainer(){this._children.forEach(function(child){if(child instanceof Doc){child.generateAutoSaveBufferFromDoc();}else if(child instanceof Collection){child.generateAutoSaveBufferFromCollection();}});}},{key:"clearAutoSaveBuffer",value:function clearAutoSaveBuffer(tabId){this._children.forEach(function(child){if(child instanceof Doc){child.clearAutoSaveBuffer(tabId);}else if(child instanceof Collection){child.rows.forEach(function(row){row.clearAutoSaveBuffer(tabId);});}});}},{key:"clearAutoSaveBufferChanges",value:function clearAutoSaveBufferChanges(tabId){this._children.forEach(function(child){if(child instanceof Doc){child.clearAutoSaveBufferChanges(tabId);}else if(child instanceof Collection){child.rows.forEach(function(row){row.clearAutoSaveBufferChanges(tabId);});}});}},{key:"clear",value:function clear(){var _=this._botState._;_.forEach(this._children,function(child){if(child instanceof Doc){child.clearDocument();}else if(child instanceof Collection){child.clearRows();}});}},{key:"getParentDoc",value:function getParentDoc(){var parentDoc=void 0;if(this._children.length>0){this._children.forEach(function(child){if(!parentDoc&&child instanceof Doc&&!child._parentDoc&&!child.temp){parentDoc=child;}});}return parentDoc;}},{key:"options",value:function options(){var headerKeys=this._keys.map(function(key){return key.message();});var parentDocId=this.getParentDoc();if(parentDocId){parentDocId=parentDocId.docId;}else{parentDocId=this.intentId;}return{controlId:this.intentId,tabId:this.tabId,parentDocId:parentDocId,docId:parentDocId,title:this.title,description:this.description,allowMinimize:this.allowMinimize,allowClose:this.allowClose,minimizeOnConfirm:this.minimizeOnConfirm,updateInBackground:this.updateInBackground,promptOnClose:this.promptOnClose,confirm:this.confirm,cancel:this.cancel,zone:this.zone,keys:headerKeys,modal:this.modal,more:this._more};}},{key:"getChildrenMessage",value:function getChildrenMessage(forShortResponse,skipOnResponse){var preserveFieldDataContainer=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var botState=arguments[3];var finalMessage=[];this._children.forEach(function(child){var message={};if(child instanceof Doc){message.type='form2';message.message=child.shortMessage(skipOnResponse);}else if(child instanceof Collection){message.type=child.style===ALL_CONSTANTS.COLLECTION_TYPES.MAP?'map':child.style===ALL_CONSTANTS.COLLECTION_TYPES.CALENDAR?'calendar':'table';if(forShortResponse){var preserveFieldData={};if(preserveFieldDataContainer.hasOwnProperty(child.intentId)){preserveFieldData=preserveFieldDataContainer[child.intentId];}child.prepareCollectionOptions(preserveFieldData);message.message={rows:child.getRowsForShortResponse(preserveFieldData),options:child.options};}}if(!message.message)message.message=child.message(skipOnResponse);finalMessage.push(message);});return finalMessage;}},{key:"message",value:function message(skipOnResponse){if(!skipOnResponse){this.onResponse(this);}var parentDoc=this.getParentDoc();if(parentDoc){parentDoc.docId=parentDoc._botState.user.userId;}return{fields:this._children.length>0?this.getChildrenMessage(false,skipOnResponse):this._fields,options:this.options()};}},{key:"sendShortResponse",value:function sendShortResponse(botState,skipOnResponse){var preserveFieldDataContainer=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var state=this._botState||botState;if(!skipOnResponse){this.onResponse(this);}var parentDoc=this.getParentDoc();if(parentDoc){parentDoc.docId=parentDoc._botState.user.userId;}state.addResponse(MessageTypes.SHORT_CONTAINER_RESPONSE(),{fields:this._children.length>0?this.getChildrenMessage(true,skipOnResponse,preserveFieldDataContainer,botState):this._fields,options:this.options()});}},{key:"buildContainerFromUserMessage",value:function buildContainerFromUserMessage(messageFromUser,tabId,state){var D=state.developer;D.log({message:"messageFromUser",data:messageFromUser});var messageFromUserRefactored={};messageFromUser.forEach(function(message){if(message.hasOwnProperty("formId")){messageFromUserRefactored[message.formId]=message;}else if(message.hasOwnProperty("tableId")){messageFromUserRefactored[message.tableId]=message;}});this._children.forEach(function(child){if(child instanceof Doc&&messageFromUserRefactored[child.intentId]){D.log({message:"messageFromUser Doc",data:messageFromUserRefactored[child.intentId]});child.buildDocumentFromUserMessage(messageFromUserRefactored[child.intentId]);}else if(child instanceof Collection&&child.style!==ALL_CONSTANTS.COLLECTION_TYPES.MAP&&messageFromUserRefactored[child.intentId]){D.log({message:"messageFromUser Collection",data:messageFromUserRefactored[child.intentId]});child.buildRowsFromUserMessage(tabId,messageFromUserRefactored[child.intentId],state);}});var parentDoc=this.getParentDoc();if(parentDoc instanceof Doc){parentDoc.rebuildDocumentObject();}}},{key:"more",set:function set(moreArray){this._more=moreArray;}},{key:"fields",set:function set(fields){this._fields=fields;}},{key:"onMatching",get:function get(){var _this36=this;return function(state){return state.messageTypeFromUser===Container.CONTAINER_RESPONSE()&&state.messageFromUser.controlId===_this36.controlId&&!state.messageFromUser.currentField;};}},{key:"onResolution",get:function get(){var _this37=this;return function _callee26(state){var _,D,docId,tabId,parentDocId,parentDoc;return regeneratorRuntime.async(function _callee26$(_context35){while(1){switch(_context35.prev=_context35.next){case 0:_=state._;D=state.developer;docId=_.get(state.messageFromUser,'docId');tabId=_.get(state.messageFromUser,'tabId');if(docId){parentDocId=_.get(state.messageFromUser,'parentDocId',docId);parentDoc=_this37.getParentDoc();if(parentDoc){parentDoc.loadDocFromAutoSaveBuffer(tabId,docId,parentDocId);}}state.currentControlId=_this37.intentId;if(!(state.messageFromUser.action===Container.CONTAINER_CLOSE())){_context35.next=13;break;}_this37.clearAutoSaveBuffer();_this37.clearAutoSaveBufferChanges();_context35.next=11;return regeneratorRuntime.awrap(_this37.onClose());case 11:_context35.next=35;break;case 13:if(!(state.messageFromUser.action===Container.CONFIRM_CONTAINER_ACTION())){_context35.next=19;break;}_this37.buildContainerFromUserMessage(state.messageFromUser.container,state.messageFromUser.tabId,state);_context35.next=17;return regeneratorRuntime.awrap(_this37.onSubmit());case 17:_context35.next=35;break;case 19:if(!(state.messageFromUser.action===Container.CANCEL_CONTAINER_ACTION())){_context35.next=26;break;}_this37.clearAutoSaveBuffer();_this37.clearAutoSaveBufferChanges();_context35.next=24;return regeneratorRuntime.awrap(_this37.onCancel());case 24:_context35.next=35;break;case 26:if(!(state.messageFromUser.action===Container.MORE_CONTAINER_ACTION())){_context35.next=34;break;}D.log({message:"Message from web app",data:state.messageFromUser.container});_this37.buildContainerFromUserMessage(state.messageFromUser.container,state.messageFromUser.tabId,state);D.log({message:"AutoSaveBuffer",data:state.autoSaveBuffer});_context35.next=32;return regeneratorRuntime.awrap(_this37.onMoreButtons());case 32:_context35.next=35;break;case 34:state.addSystemErrorToStack(47,Error.getErrorMessageforCodeAndLang(47));case 35:if(state.responsesArray.length===0){state.addSilentResponse();}case 36:case"end":return _context35.stop();}}},null,_this37);};}}]);return Container;}(Intent);var Geofence=function(_Intent10){_inherits(Geofence,_Intent10);_createClass(Geofence,null,[{key:"GEOFENCE_MESSAGE",value:function GEOFENCE_MESSAGE(){return'geofence';}},{key:"GEOFENCE_RESPONSE",value:function GEOFENCE_RESPONSE(){return'geofence_response';}},{key:"SAVE_ACTION",value:function SAVE_ACTION(){return'save';}},{key:"NEW_ACTION",value:function NEW_ACTION(){return'new';}},{key:"UPDATE_ACTION",value:function UPDATE_ACTION(){return'update';}},{key:"DISPLAY_ACTION",value:function DISPLAY_ACTION(){return'display';}},{key:"DELETE_ACTION",value:function DELETE_ACTION(){return'delete';}}]);function Geofence(intentId,_ref7){var _this39=this;var tabId=_ref7.tabId,id=_ref7.id,name=_ref7.name,description=_ref7.description,color=_ref7.color,coordinates=_ref7.coordinates,botState=_ref7.botState;_classCallCheck(this,Geofence);var _this38=_possibleConstructorReturn(this,(Geofence.__proto__||Object.getPrototypeOf(Geofence)).call(this,intentId,botState,tabId));_this38.onSave=function _callee27(){return regeneratorRuntime.async(function _callee27$(_context36){while(1){switch(_context36.prev=_context36.next){case 0:case"end":return _context36.stop();}}},null,_this39);};_this38.onDelete=function _callee28(){return regeneratorRuntime.async(function _callee28$(_context37){while(1){switch(_context37.prev=_context37.next){case 0:case"end":return _context37.stop();}}},null,_this39);};_this38._id=id;_this38._name=name;_this38._description=description;_this38._color=color;_this38._coordinates=coordinates;return _this38;}_createClass(Geofence,[{key:"message",value:function message(action){return{options:{controlId:this.intentId,tabId:this.tabId,id:this._id,name:this._name,description:this._description,color:this._color,action:action},coordinates:this._coordinates};}},{key:"onMatching",get:function get(){var _this40=this;return function(state){return state.messageTypeFromUser===Geofence.GEOFENCE_RESPONSE()&&state.messageFromUser.controlId===_this40.intentId;};}},{key:"onResolution",get:function get(){var _this41=this;return function _callee29(state){return regeneratorRuntime.async(function _callee29$(_context38){while(1){switch(_context38.prev=_context38.next){case 0:state.currentControlId=_this41.intentId;if(!(state.messageFromUser.action===Geofence.SAVE_ACTION())){_context38.next=6;break;}_context38.next=4;return regeneratorRuntime.awrap(_this41.onSave());case 4:_context38.next=12;break;case 6:if(!(state.messageFromUser.action===Geofence.DELETE_ACTION())){_context38.next=11;break;}_context38.next=9;return regeneratorRuntime.awrap(_this41.onDelete());case 9:_context38.next=12;break;case 11:state.addSystemErrorToStack(49,Error.getErrorMessageforCodeAndLang(49));case 12:if(state.responsesArray.length===0){state.addSilentResponse();}case 13:case"end":return _context38.stop();}}},null,_this41);};}}]);return Geofence;}(Intent);var FloorPlan=function(_Intent11){_inherits(FloorPlan,_Intent11);_createClass(FloorPlan,null,[{key:"FLOOR_PLAN_MESSAGE",value:function FLOOR_PLAN_MESSAGE(){return'floorplan';}},{key:"FLOOR_PLAN_RESPONSE_MESSAGE",value:function FLOOR_PLAN_RESPONSE_MESSAGE(){return'floorplan_response';}}]);function FloorPlan(intentId,botState){var _this43=this;_classCallCheck(this,FloorPlan);var _this42=_possibleConstructorReturn(this,(FloorPlan.__proto__||Object.getPrototypeOf(FloorPlan)).call(this,intentId,botState));_this42.onSelection=function _callee30(){return regeneratorRuntime.async(function _callee30$(_context39){while(1){switch(_context39.prev=_context39.next){case 0:case"end":return _context39.stop();}}},null,_this43);};return _this42;}_createClass(FloorPlan,[{key:"message",value:function message(){return{controlId:this.intentId};}},{key:"onMatching",get:function get(){return function(state){return state.messageTypeFromUser===FloorPlan.FLOOR_PLAN_RESPONSE_MESSAGE();};}},{key:"onResolution",get:function get(){var _this44=this;return function _callee31(state){return regeneratorRuntime.async(function _callee31$(_context40){while(1){switch(_context40.prev=_context40.next){case 0:state.currentControlId=_this44.intentId;_context40.next=3;return regeneratorRuntime.awrap(_this44.onSelection());case 3:if(state.responsesArray.length===0){state.addSilentResponse();}case 4:case"end":return _context40.stop();}}},null,_this44);};}}]);return FloorPlan;}(Intent);var Maps=function(_Intent12){_inherits(Maps,_Intent12);_createClass(Maps,null,[{key:"MAP_RESPONSE_MESSAGE",value:function MAP_RESPONSE_MESSAGE(){return'map_response';}},{key:"MAP_MESSAGE",value:function MAP_MESSAGE(){return'map';}}]);function Maps(intentId,_ref8){var _this46=this;var tabId=_ref8.tabId,title=_ref8.title,type=_ref8.type,description=_ref8.description,_ref8$source=_ref8.source,source=_ref8$source===undefined?'mapbox':_ref8$source,_ref8$carrousel=_ref8.carrousel,carrousel=_ref8$carrousel===undefined?false:_ref8$carrousel,_ref8$table=_ref8.table,table=_ref8$table===undefined?false:_ref8$table,_ref8$collapsableCard=_ref8.collapsableCards,collapsableCards=_ref8$collapsableCard===undefined?false:_ref8$collapsableCard,_ref8$adsSidebar=_ref8.adsSidebar,adsSidebar=_ref8$adsSidebar===undefined?false:_ref8$adsSidebar,_ref8$adsHeader=_ref8.adsHeader,adsHeader=_ref8$adsHeader===undefined?false:_ref8$adsHeader,botState=_ref8.botState,_ref8$allowSearch=_ref8.allowSearch,allowSearch=_ref8$allowSearch===undefined?false:_ref8$allowSearch,_ref8$allowRefresh=_ref8.allowRefresh,allowRefresh=_ref8$allowRefresh===undefined?false:_ref8$allowRefresh;_classCallCheck(this,Maps);var _this45=_possibleConstructorReturn(this,(Maps.__proto__||Object.getPrototypeOf(Maps)).call(this,intentId,botState));_this45.onAction=function _callee32(){return regeneratorRuntime.async(function _callee32$(_context41){while(1){switch(_context41.prev=_context41.next){case 0:case"end":return _context41.stop();}}},null,_this46);};_this45.onSearch=function _callee33(){return regeneratorRuntime.async(function _callee33$(_context42){while(1){switch(_context42.prev=_context42.next){case 0:case"end":return _context42.stop();}}},null,_this46);};_this45.onRefresh=function _callee34(){return regeneratorRuntime.async(function _callee34$(_context43){while(1){switch(_context43.prev=_context43.next){case 0:case"end":return _context43.stop();}}},null,_this46);};_this45.title=title;_this45.type=type;_this45._carrousel=carrousel;_this45._table=table;_this45.description=description;_this45._cards=[];_this45._polylines=[];_this45._markers=[];_this45._planeRoutes=[];_this45._source=source;_this45._collapsableCards=collapsableCards;_this45._adsSidebar=adsSidebar;_this45._adsHeader=adsHeader;_this45._allowSearch=allowSearch;_this45._allowRefresh=allowRefresh;_this45._region={latitude:0.1,longitude:0.1,zoom:2};return _this45;}_createClass(Maps,[{key:"message",value:function message(){return{geoJsonUrl:this._geoJsonUrl,region:this._region,markers:this._markers,cards:this._cards,polylines:this._polylines,planeRoutes:this._planeRoutes,carrousel:this._carrousel,table:this._table,options:{mapId:this.intentId,controlId:this.intentId,tabId:this.tabId,title:this.title,description:this.description,type:this.type,source:this._source,collapsableCards:this._collapsableCards,adsSidebar:this._adsSidebar,adsHeader:this._adsHeader,table:this._table,carrousel:this._carrousel,allowSearch:this._allowSearch,allowRefresh:this._allowRefresh}};}},{key:"addCard",value:function addCard(card){this._cards.push(card);}},{key:"addCards",value:function addCards(cards){this._cards=cards;}},{key:"addMarker",value:function addMarker(marker){var index=-1;for(var i=0;i<this._markers.length;i++){if(this._markers[i].id===marker.id){index=i;}}if(index>-1){this._markers.splice(index,1);}this._markers.push(marker);}},{key:"addRoute",value:function addRoute(route){this._polylines.push(route);}},{key:"addPlaneRoute",value:function addPlaneRoute(route){var index=-1;for(var i=0;i<this._planeRoutes.length;i++){if(this._planeRoutes[i].id===route.id){index=i;}}if(index>-1){this._markers.splice(index,1);}this._planeRoutes.push(route);}},{key:"mapId",get:function get(){return this.intentId;}},{key:"region",get:function get(){return this._region;},set:function set(_ref9){var _ref9$latitude=_ref9.latitude,latitude=_ref9$latitude===undefined?0.1:_ref9$latitude,_ref9$longitude=_ref9.longitude,longitude=_ref9$longitude===undefined?0.1:_ref9$longitude,_ref9$zoom=_ref9.zoom,zoom=_ref9$zoom===undefined?2:_ref9$zoom,fitBounds=_ref9.fitBounds;this._region={latitude:latitude,longitude:longitude,zoom:zoom,fitBounds:fitBounds};}},{key:"geoJsonUrl",set:function set(url){this._geoJsonUrl=url;},get:function get(){return this._geoJsonUrl;}},{key:"routes",set:function set(routes){this._polylines=routes;}},{key:"onMatching",get:function get(){return function(state){return state.messageTypeFromUser===Maps.MAP_RESPONSE_MESSAGE();};}},{key:"onResolution",get:function get(){var _this47=this;return function _callee35(state){return regeneratorRuntime.async(function _callee35$(_context44){while(1){switch(_context44.prev=_context44.next){case 0:state.currentControlId=_this47.intentId;if(!(state.messageFromUser.action===ALL_CONSTANTS.ACTIONS.ON_ACTION||!state.messageFromUser.action)){_context44.next=6;break;}_context44.next=4;return regeneratorRuntime.awrap(_this47.onAction());case 4:_context44.next=17;break;case 6:if(!(state.messageFromUser.action===ALL_CONSTANTS.ACTIONS.SEARCH)){_context44.next=11;break;}_context44.next=9;return regeneratorRuntime.awrap(_this47.onSearch());case 9:_context44.next=17;break;case 11:if(!(state.messageFromUser.action===ALL_CONSTANTS.ACTIONS.ON_REFRESH)){_context44.next=16;break;}_context44.next=14;return regeneratorRuntime.awrap(_this47.onRefresh());case 14:_context44.next=17;break;case 16:state.addSystemErrorToStack(48,Error.getErrorMessageforCodeAndLang(49));case 17:if(state.responsesArray.length===0){state.addSilentResponse();}case 18:case"end":return _context44.stop();}}},null,_this47);};}}]);return Maps;}(Intent);var Card=function(_Intent13){_inherits(Card,_Intent13);function Card(intentId,_ref10){var title=_ref10.title,pictureUrl=_ref10.pictureUrl,defaultPictureUrl=_ref10.defaultPictureUrl,description=_ref10.description,html=_ref10.html,data=_ref10.data,url=_ref10.url,action=_ref10.action,botState=_ref10.botState;_classCallCheck(this,Card);var _this48=_possibleConstructorReturn(this,(Card.__proto__||Object.getPrototypeOf(Card)).call(this,intentId,botState));_this48.onAction=function(){};_this48.title=title;_this48.pictureUrl=pictureUrl;_this48.defaultPictureUrl=defaultPictureUrl;_this48.description=description;_this48.html=html;_this48.data=data;_this48.url=url;_this48.action=action;_this48.disableHistoryLogging();return _this48;}_createClass(Card,[{key:"message",value:function message(){return{id:this.intentId,title:this.title,pictureUrl:this.pictureUrl,defaultPictureUrl:this.defaultPictureUrl,description:this.description,html:this.html,data:this.data,url:this.url,action:this.action};}},{key:"id",get:function get(){return this.intentId;}},{key:"onMatching",get:function get(){var _this49=this;return function(state){return state.messageTypeFromUser===Cards.CARD_RESPONSE_ACTION()&&state.messageFromUser===_this49.id;};}},{key:"onResolution",get:function get(){var _this50=this;return function _callee36(state){return regeneratorRuntime.async(function _callee36$(_context45){while(1){switch(_context45.prev=_context45.next){case 0:state.currentControlId=_this50.intentId;_context45.next=3;return regeneratorRuntime.awrap(_this50.onAction());case 3:if(state.responsesArray.length===0){state.addSilentResponse();}case 4:case"end":return _context45.stop();}}},null,_this50);};}}]);return Card;}(Intent);var Cards=function(_Intent14){_inherits(Cards,_Intent14);_createClass(Cards,null,[{key:"CARD_RESPONSE_ACTION",value:function CARD_RESPONSE_ACTION(){return'card_response';}}]);function Cards(intentId,_ref11){var type=_ref11.type,size=_ref11.size,_ref11$popup=_ref11.popup,popup=_ref11$popup===undefined?true:_ref11$popup,grid=_ref11.grid,botState=_ref11.botState;_classCallCheck(this,Cards);var _this51=_possibleConstructorReturn(this,(Cards.__proto__||Object.getPrototypeOf(Cards)).call(this,intentId,botState));_this51.type=type;_this51.size=size;_this51.grid=grid;_this51.popup=popup;_this51._cards=[];return _this51;}_createClass(Cards,[{key:"message",value:function message(){var cards=[];this._cards.forEach(function(card){return cards.push(card.message());});return{cards:cards,options:{type:this.type,size:this.size,grid:this.grid,popup:this.popup}};}},{key:"addCards",value:function addCards(cards){var _this52=this;if(Array.isArray(cards)){cards.forEach(function(card){_this52.addCard(card);});}}},{key:"addCard",value:function addCard(card){if(card instanceof Card){this._cards.push(card);}else{state.addSystemErrorToStack(Error.getErrorMessageforCodeAndLang(28));}}},{key:"id",get:function get(){return this.intentId;}},{key:"cards",get:function get(){return this._cards;}},{key:"onMatching",get:function get(){return function(state){return false;};}}]);return Cards;}(Intent);var TrackingView=function(_Intent15){_inherits(TrackingView,_Intent15);_createClass(TrackingView,null,[{key:"CLOSE_VIEW_ACTION",value:function CLOSE_VIEW_ACTION(){return'close';}},{key:"REFRESH_VIEW_ACTION",value:function REFRESH_VIEW_ACTION(){return'refresh';}},{key:"TRACKING_VIEW_RESPONSE",value:function TRACKING_VIEW_RESPONSE(){return'tracking_view_response';}}]);function TrackingView(intentId,_ref12){var title=_ref12.title,icon=_ref12.icon,allowMinimize=_ref12.allowMinimize,allowClose=_ref12.allowClose,notification=_ref12.notification,botState=_ref12.botState;_classCallCheck(this,TrackingView);var _this53=_possibleConstructorReturn(this,(TrackingView.__proto__||Object.getPrototypeOf(TrackingView)).call(this,intentId,botState));_this53.onClose=function(){};_this53.onRefresh=function(){};_this53.title=title;_this53.icon=icon;_this53.allowMinimize=allowMinimize;_this53.allowClose=allowClose;_this53._origin={};_this53._destination={};_this53._currentPosition={};_this53._altitudeArray=[];_this53._speedArray=[];_this53._notification=notification;_this53._cancelled=false;return _this53;}_createClass(TrackingView,[{key:"message",value:function message(){return{options:{controlId:this.intentId,title:this.title,icon:this.icon,allowMinimize:this.allowMinimize,allowClose:this.allowClose,notification:this._notification,cancelled:this._cancelled},data:{tracking:{origin:this._origin,destination:this._destination,currentPosition:this._currentPosition},charts:{altitude:this._altitudeArray,speed:this._speedArray}}};}},{key:"addOrigin",value:function addOrigin(_ref13){var title=_ref13.title,code=_ref13.code,place=_ref13.place,timeStamp=_ref13.timeStamp;this._origin={title:title,code:code,place:place,timeStamp:timeStamp};}},{key:"addDestination",value:function addDestination(_ref14){var title=_ref14.title,code=_ref14.code,place=_ref14.place,timeStamp=_ref14.timeStamp;this._destination={title:title,code:code,place:place,timeStamp:timeStamp};}},{key:"addCurrentPosition",value:function addCurrentPosition(_ref15){var totalTripTimeEstimation=_ref15.totalTripTimeEstimation,totalTimeElapsed=_ref15.totalTimeElapsed,currentAltitude=_ref15.currentAltitude,currentSpeed=_ref15.currentSpeed;this._currentPosition={totalTripTimeEstimation:totalTripTimeEstimation,totalTimeElapsed:totalTimeElapsed,currentAltitude:currentAltitude,currentSpeed:currentSpeed};}},{key:"addAltitude",value:function addAltitude(){}},{key:"addSpeed",value:function addSpeed(){}},{key:"notification",set:function set(notification){this._notification=notification;}},{key:"cancelled",set:function set(cancelled){this._cancelled=cancelled;}},{key:"onMatching",get:function get(){var _this54=this;return function(state){return state.messageTypeFromUser===TrackingView.TRACKING_VIEW_RESPONSE()&&(state.messageFromUser.controlId===_this54.intentId||state.messageFromUser.controlId===11111);};}},{key:"onResolution",get:function get(){var _this55=this;return function _callee37(state){return regeneratorRuntime.async(function _callee37$(_context46){while(1){switch(_context46.prev=_context46.next){case 0:state.currentControlId=_this55.intentId;if(!(state.messageFromUser.action===TrackingView.CLOSE_VIEW_ACTION())){_context46.next=6;break;}_context46.next=4;return regeneratorRuntime.awrap(_this55.onClose());case 4:_context46.next=12;break;case 6:if(!(state.messageFromUser.action===TrackingView.REFRESH_VIEW_ACTION())){_context46.next=11;break;}_context46.next=9;return regeneratorRuntime.awrap(_this55.onRefresh());case 9:_context46.next=12;break;case 11:state.addSystemErrorToStack(Error.getErrorMessageforCodeAndLang(28));case 12:if(state.responsesArray.length===0){state.addSilentResponse();}case 13:case"end":return _context46.stop();}}},null,_this55);};}}]);return TrackingView;}(Intent);var LocationServices=function(){_createClass(LocationServices,null,[{key:"START_TRACKING",value:function START_TRACKING(){return'startTracking';}},{key:"STOP_TRACKING",value:function STOP_TRACKING(){return'stopTracking';}},{key:"VESSEL",value:function VESSEL(){return'vessel';}},{key:"FLIGHT",value:function FLIGHT(){return'flight';}},{key:"TRACKER_BOT",value:function TRACKER_BOT(){return'tracker-bot';}}]);function LocationServices(botState){_classCallCheck(this,LocationServices);this._botState=botState;this._=botState._;var capabilities=botState.context.capabilities.capabilities;if(capabilities){this._turf=botState.context.capabilities.turf;}else{this._turf=botState.context.turf;}this.offlineMaps={};if(this._botState.client===State.MOBILECLIENT()&&this._botState.location===Intent.EDGE()){this.offlineMaps=this._botState.context.getCapability('OfflineMap');}}_createClass(LocationServices,[{key:"getDeviceLocation",value:function getDeviceLocation(){var _this56=this;if(this._botState.location===Intent.EDGE()){return this._botState.context.getCapability('DeviceLocation').getDeviceLocation().catch(function(error){_this56._botState.addSystemErrorToStack(53,null,error);});}else{this._botState.addSystemErrorToStack(54);return Promise.resolve();}}},{key:"getLocationWithQuery",value:function getLocationWithQuery(query){var stringQuery,response;return regeneratorRuntime.async(function getLocationWithQuery$(_context47){while(1){switch(_context47.prev=_context47.next){case 0:_context47.prev=0;stringQuery=query;if(typeof stringQuery!=='string'){stringQuery=JSON.stringify(query);}_context47.next=5;return regeneratorRuntime.awrap(this._botState.api.callService('Geocode',{queryParams:'q='+stringQuery}));case 5:response=_context47.sent;if(response){_context47.next=8;break;}return _context47.abrupt("return",[]);case 8:return _context47.abrupt("return",JSON.parse(response));case 11:_context47.prev=11;_context47.t0=_context47["catch"](0);this._botState.developer.log({message:'Getting error while calling Geocode: '+_context47.t0.message});return _context47.abrupt("return",{error:'err'});case 15:case"end":return _context47.stop();}}},null,this,[[0,11]]);}},{key:"startLocationTracking",value:function startLocationTracking(){var precision=arguments.length>0&&arguments[0]!==undefined?arguments[0]:5;var heartbeatInterval=arguments.length>1&&arguments[1]!==undefined?arguments[1]:180;return this._botState.context.getCapability('LocationTracker').start_tracking({botId:this._botState.context.botManifest.botId,conversationId:this._botState.conversationId},precision,heartbeatInterval);}},{key:"stopLocationTracking",value:function stopLocationTracking(){return this._botState.context.getCapability('LocationTracker').stop_tracking({botId:this._botState.context.botManifest.botId,conversationId:this._botState.conversationId});}},{key:"saveMap",value:function saveMap(_ref16){var name=_ref16.name,neBound=_ref16.neBound,swBound=_ref16.swBound,_ref16$minZoom=_ref16.minZoom,minZoom=_ref16$minZoom===undefined?12:_ref16$minZoom,_ref16$maxZoom=_ref16.maxZoom,maxZoom=_ref16$maxZoom===undefined?16:_ref16$maxZoom,_ref16$progressListen=_ref16.progressListener,progressListener=_ref16$progressListen===undefined?this.progressListener:_ref16$progressListen,_ref16$errorListener=_ref16.errorListener,errorListener=_ref16$errorListener===undefined?this.errorListener:_ref16$errorListener;var botState,D;return regeneratorRuntime.async(function saveMap$(_context48){while(1){switch(_context48.prev=_context48.next){case 0:botState=this._botState;D=botState.developer;if(!(botState.client===State.MOBILECLIENT())){_context48.next=17;break;}_context48.prev=3;if(!botState.maps[name]){_context48.next=7;break;}_context48.next=7;return regeneratorRuntime.awrap(this.deleteMap(name));case 7:botState.maps[name]=true;_context48.next=10;return regeneratorRuntime.awrap(this.offlineMaps.saveMap(name,neBound,swBound,minZoom,maxZoom,function(completedResourceCount,completedResourceSize,completedTileCount,completedTileSize,name,percentage,requiredResourceCount,state){D.log({message:"Progress being made downloading map",data:percentage});},function(offLinePack,error){D.log({message:"Error downloading map",data:error});}));case 10:_context48.next=15;break;case 12:_context48.prev=12;_context48.t0=_context48["catch"](3);D.log({message:"Error downloading map",data:_context48.t0});case 15:_context48.next=18;break;case 17:D.warning({message:"Maps cannot be downloaded on web app for now"});case 18:case"end":return _context48.stop();}}},null,this,[[3,12]]);}},{key:"deleteMap",value:function deleteMap(name){return regeneratorRuntime.async(function deleteMap$(_context49){while(1){switch(_context49.prev=_context49.next){case 0:_context49.next=2;return regeneratorRuntime.awrap(this.offlineMaps.deleteMap(name));case 2:delete this._botState.maps[name];case 3:case"end":return _context49.stop();}}},null,this);}},{key:"startTracking",value:function startTracking(assetType,assetDetails,schedule,intentId){var trackingSessionId,messageToTracker;return regeneratorRuntime.async(function startTracking$(_context50){while(1){switch(_context50.prev=_context50.next){case 0:trackingSessionId=this._botState.getUniqueId();messageToTracker={intentId:LocationServices.START_TRACKING(),jobId:trackingSessionId,assetType:assetType,assetDetails:assetDetails};if(schedule){messageToTracker.repeats=schedule;}if(intentId){messageToTracker.respondsTo={userId:this._botState.user.userId,botId:this._botState.conversation.bot,userDomain:this._botState.conversation.userDomain,intentId:intentId};}_context50.next=6;return regeneratorRuntime.awrap(this._botState.notification.sendBroadcastNotificationToBot(LocationServices.TRACKER_BOT(),this._botState.conversation.userDomain,MessageTypes.BOT_TO_BOT(),messageToTracker));case 6:return _context50.abrupt("return",trackingSessionId);case 7:case"end":return _context50.stop();}}},null,this);}},{key:"startTrackingVessel",value:function startTrackingVessel(assetDetails,schedule,intentId){return this.startTracking(LocationServices.VESSEL(),assetDetails,schedule,intentId);}},{key:"startTrackingFlight",value:function startTrackingFlight(assetDetails,schedule,intentId){return this.startTracking(LocationServices.FLIGHT(),assetDetails,schedule,intentId);}},{key:"stopTracking",value:function stopTracking(trackingSessionId){}},{key:"getLatestKnownLocation",value:function getLatestKnownLocation(asset,trackingSessionId,tableName){var params={capability:'AssetTrackerCapability',capabilityFileName:'assetTrackerCapability',action:'getLatestAssetLocation',assetId:asset,sessionId:trackingSessionId,userId:this._botState.user.userId,conversation:this._botState.conversation};if(tableName){params['tableName']=tableName;}return this._botState.callCapability(params);}},{key:"getLocation",value:function getLocation(asset,trackingSessionId,from,to,tableName){var params={capability:'AssetTrackerCapability',capabilityFileName:'assetTrackerCapability',action:'getAssetLocationForDuration',assetId:asset,sessionId:trackingSessionId,from:from,to:to,userId:this._botState.user.userId,conversation:this._botState.conversation};if(tableName){params['tableName']=tableName;}return this._botState.callCapability(params);}},{key:"getLocationWithPagination",value:function getLocationWithPagination(asset,trackingSessionId){var pageSize=arguments.length>2&&arguments[2]!==undefined?arguments[2]:50;var last=arguments[3];var tableName=arguments[4];var params={capability:'AssetTrackerCapability',capabilityFileName:'assetTrackerCapability',action:'getAssetLocationsWithPagination',assetId:asset,sessionId:trackingSessionId,pageSize:pageSize,userId:this._botState.user.userId,conversation:this._botState.conversation};if(last){params.last=last;}if(tableName){params['tableName']=tableName;}return this._botState.callCapability(params);}},{key:"storeNewLocation",value:function storeNewLocation(trackingSessionId,assetId,assetDetails,createdOn,tableName){var params={capability:'AssetTrackerCapability',capabilityFileName:'assetTrackerCapability',action:'addNewLocation',assetId:assetId,sessionId:trackingSessionId,details:assetDetails,userId:this._botState.user.userId,conversation:this._botState.conversation};if(createdOn){params.createdOn=createdOn;}if(tableName){params['tableName']=tableName;}return this._botState.callCapability(params);}},{key:"getWeatherOnLocation",value:function getWeatherOnLocation(latitude,longitude){var location,WEATHER_SERVICE,response;return regeneratorRuntime.async(function getWeatherOnLocation$(_context51){while(1){switch(_context51.prev=_context51.next){case 0:location=latitude+","+longitude;WEATHER_SERVICE='MaritimeWeather';_context51.prev=2;response=this._botState.api.callService(WEATHER_SERVICE,{queryParams:'q='+location});return _context51.abrupt("return",response);case 7:_context51.prev=7;_context51.t0=_context51["catch"](2);d.log({message:'Getting error while calling WEATHER_SERVICE '+JSON.stringify(_context51.t0)});return _context51.abrupt("return",{error:_context51.t0});case 11:case"end":return _context51.stop();}}},null,this,[[2,7]]);}},{key:"getPolygonsThatContainsLocation",value:function getPolygonsThatContainsLocation(location,polygonList){var _this57=this;var foundPolygons=[];var turfPoint=this._turf.point(location);try{this._.forEach(polygonList,function(poly){var polygon=_this57._turf.polygon(poly.coordinates);if(_this57._turf.booleanPointInPolygon(turfPoint,polygon)){foundPolygons.push(poly);}});return foundPolygons;}catch(err){throw err;}}}]);return LocationServices;}();var Sensors=function(){function Sensors(botState){_classCallCheck(this,Sensors);this._botState=botState;this._=botState._;this.R=botState.R;}_createClass(Sensors,[{key:"startMotionDetection",value:function startMotionDetection(frequency){this._botState.context.getCapability('Accelerometer').startUpdates(this._botState.context.botManifest.botId,this._botState.conversationId,frequency);}},{key:"stopMotionDetection",value:function stopMotionDetection(){this._botState.context.getCapability('Accelerometer').stopUpdates(this._botState.context.botManifest.botId,this._botState.conversationId);}}]);return Sensors;}();var TrackingServices=function(){function TrackingServices(botState){_classCallCheck(this,TrackingServices);this._botState=botState;this._=botState._;}_createClass(TrackingServices,[{key:"startTracking",value:function startTracking(){return this._botState.context.getCapability('LocationTracker').start_tracking({botId:this._botState.context.botManifest.botId,conversationId:this._botState.conversationId});}},{key:"stopTracking",value:function stopTracking(){return this._botState.context.getCapability('LocationTracker').stop_tracking({botId:this._botState.context.botManifest.botId,conversationId:this._botState.conversationId});}}]);return TrackingServices;}();var Security=function(){function Security(botState){_classCallCheck(this,Security);this._botState=botState;this._=botState._;this._frontmlib=botState.frontmlib;}_createClass(Security,[{key:"createNewVerificationCode",value:function createNewVerificationCode(role,customAction,numberOfLicenses,autoInstallBotIds){var addCurrentConversationBot=arguments.length>4&&arguments[4]!==undefined?arguments[4]:true;var verificationCode,newCode;return regeneratorRuntime.async(function createNewVerificationCode$(_context52){while(1){switch(_context52.prev=_context52.next){case 0:verificationCode=this._botState.UUID().substr(0,10);if(this._.isUndefined(autoInstallBotIds)){autoInstallBotIds=[];}if(!this._.isArray(autoInstallBotIds)){autoInstallBotIds=[autoInstallBotIds];}if(addCurrentConversationBot)autoInstallBotIds.push(this._botState.conversation.bot);newCode={codeUsage:{existing:0},domain:this._botState.conversation.userDomain,role:role,verificationCode:verificationCode,customAction:customAction,botsToInstall:autoInstallBotIds};if(numberOfLicenses>0){newCode.codeUsage.maximum=numberOfLicenses;}_context52.prev=6;_context52.next=9;return regeneratorRuntime.awrap(this._frontmlib.dbPutItem('DomainVerification',newCode));case 9:return _context52.abrupt("return",verificationCode);case 12:_context52.prev=12;_context52.t0=_context52["catch"](6);return _context52.abrupt("return",null);case 15:case"end":return _context52.stop();}}},null,this,[[6,12]]);}},{key:"getVerificationCode",value:function getVerificationCode(role){var verificationCodeRow;return regeneratorRuntime.async(function getVerificationCode$(_context53){while(1){switch(_context53.prev=_context53.next){case 0:_context53.prev=0;_context53.next=3;return regeneratorRuntime.awrap(this._frontmlib.dbGetWithIndex('DomainVerification','domain-role-index','#domain = :domain AND #role = :role',{':domain':this._botState.conversation.userDomain,':role':role},null,{'#domain':'domain','#role':'role'}));case 3:verificationCodeRow=_context53.sent;return _context53.abrupt("return",verificationCodeRow.Items[0].verificationCode);case 7:_context53.prev=7;_context53.t0=_context53["catch"](0);return _context53.abrupt("return",null);case 10:case"end":return _context53.stop();}}},null,this,[[0,7]]);}},{key:"encryptData",value:function encryptData(data){var key;return regeneratorRuntime.async(function encryptData$(_context54){while(1){switch(_context54.prev=_context54.next){case 0:_context54.prev=0;_context54.next=3;return regeneratorRuntime.awrap(this._botState.cc.getConfigurationForKey('encryptionKey'));case 3:key=_context54.sent;return _context54.abrupt("return",this._frontmlib.encryptData(key,data));case 7:_context54.prev=7;_context54.t0=_context54["catch"](0);this._botState.addSystemErrorToStack(31,_context54.t0.message);case 10:case"end":return _context54.stop();}}},null,this,[[0,7]]);}},{key:"decryptData",value:function decryptData(data){return regeneratorRuntime.async(function decryptData$(_context55){while(1){switch(_context55.prev=_context55.next){case 0:_context55.prev=0;return _context55.abrupt("return",this._frontmlib.decryptData(data));case 4:_context55.prev=4;_context55.t0=_context55["catch"](0);this._botState.addSystemErrorToStack(32,_context55.t0.message);case 7:case"end":return _context55.stop();}}},null,this,[[0,4]]);}}]);return Security;}();var LogEntrytype=function(){function LogEntrytype(){_classCallCheck(this,LogEntrytype);}_createClass(LogEntrytype,null,[{key:"SYSTEM_ERROR",value:function SYSTEM_ERROR(){return'SYSTEM_ERROR';}},{key:"USER_ERROR",value:function USER_ERROR(){return'USER_ERROR';}},{key:"WARNING",value:function WARNING(){return'WARNING';}},{key:"INFO",value:function INFO(){return'INFO';}},{key:"DEBUG",value:function DEBUG(){return'DEBUG';}},{key:"LOG",value:function LOG(){return'LOG';}},{key:"PERF",value:function PERF(){return'PERF';}}]);return LogEntrytype;}();var SearchBox=function(){function SearchBox(botState,theId,name,selectionType){_classCallCheck(this,SearchBox);this['_botState']=botState;this['_']=botState._;this['_id']=theId;this['name']=name;this['selectionType']=selectionType;}_createClass(SearchBox,[{key:"getMessageWith",value:function getMessageWith(action,results){if(results){return{action:action,results:results,selectionType:this.selectionType};}else{return{action:'open',placeholder:this.name,selectionType:this.selectionType};}}},{key:"id",get:function get(){return this._id;}},{key:"onSearch",set:function set(onSearchBlock){this._onSearch=onSearchBlock;},get:function get(){return this._onSearch;}},{key:"onCompletion",set:function set(onCompletionBlock){this._onCompletion=onCompletionBlock;},get:function get(){return this._onCompletion;}},{key:"onCancel",set:function set(onCancelBlock){this._onCancel=onCancelBlock;},get:function get(){return this._onCancel;}}]);return SearchBox;}();var Companies=function(){function Companies(botState){_classCallCheck(this,Companies);this['_botState']=botState;this['_']=botState._;}_createClass(Companies,[{key:"callCreateCompanyCapability",value:function callCreateCompanyCapability(params){var capabilities=this._botState.context.capabilities.capabilities;var capFileName=params.capabilityFileName;var capabilityModule=capabilities[capFileName];return capabilityModule.execute(params,this._botState.context.capabilities);}},{key:"createChildCompany",value:function createChildCompany(_ref17){var _this58=this;var companyAddress=_ref17.companyAddress,companyName=_ref17.companyName,phoneNumbers=_ref17.phoneNumbers,contractDuration=_ref17.contractDuration,account=_ref17.account;var companyId=this._botState.getUniqueId();var params={capability:'CompanyCapability',capabilityFileName:'companyCapability',sync:true,userId:this._botState.user.userId,conversation:this._botState.conversation,action:'createCompany',company:{companyAddress:companyAddress,companyId:companyId,companyName:companyName,phoneNumbers:phoneNumbers,contractDuration:contractDuration,account:account},companyDomain:{userDomain:this._botState.currentUserDomain}};return this.callCreateCompanyCapability(params).then(function(response){_this58._botState.developer.info({message:'After created company',data:response});if(_this58._.get(response,'status')){return{status:true,companyId:companyId};}else{return{status:false,errorMessage:_this58._.get(_this58._botState._.compact(response),'errorMessage','There was a problem creating the company')};}});}},{key:"addOfferToCompany",value:function addOfferToCompany(_ref18){var _this59=this;var companyId=_ref18.companyId,verificationCode=_ref18.verificationCode,validFrom=_ref18.validFrom,validTo=_ref18.validTo,maxUsersPerLicense=_ref18.maxUsersPerLicense,offers=_ref18.offers,offerType=_ref18.offerType,description=_ref18.description,role=_ref18.role;var params={capability:'CompanyCapability',capabilityFileName:'companyCapability',sync:true,userId:this._botState.user.userId,conversation:this._botState.conversation,action:'createCompany',company:{companyId:companyId},companyDomain:{userDomain:this._botState.currentUserDomain},userOffers:[{verificationCode:verificationCode,offerType:offerType,description:description,role:role,valid_from:validFrom,valid_to:validTo,codeUsage:{maximum:maxUsersPerLicense},offers:offers}]};return this.callCreateCompanyCapability(params).then(function(response){_this59._botState.developer.info({message:'After added offer to company',data:response});if(_this59._.get(response,'status')){return{status:true,companyId:companyId};}else{return{status:false,errorMessage:_this59._.get(_this59._botState._.compact(response),'errorMessage','There was a problem creating the company')};}});}}]);return Companies;}();var Marketplace=function(){function Marketplace(botState){_classCallCheck(this,Marketplace);this['_botState']=botState;this['_']=botState._;}_createClass(Marketplace,[{key:"validateActivationCode",value:function validateActivationCode(code,userId,userEmail){var params={capability:'SubscribeDomainRole',capabilityFileName:'subscribeDomainRole',verificationCode:code,sync:true,userId:userId||this._botState.user.userId,userEmail:userEmail||this._botState.user.userEmail,conversation:this._botState.conversation};return this._botState.callCapability(params);}},{key:"activateDomainsOnEdge",value:function activateDomainsOnEdge(domains){return this._botState.context.getCapability('authContext').setDomains(domains,this._botState.context);}},{key:"autoInstallAllBotsOnEdge",value:function autoInstallAllBotsOnEdge(){return this._botState.context.getCapability('RemoteBotInstall').syncronizeBots();}}]);return Marketplace;}();var UnitTest=function(_Intent16){_inherits(UnitTest,_Intent16);_createClass(UnitTest,null,[{key:"RUN_COMMAND",value:function RUN_COMMAND(){return'@@run';}},{key:"TEST_RUN_MSG",value:function TEST_RUN_MSG(){return'Test request submitted successfully';}},{key:"VERIFICATION_RUN_MSG",value:function VERIFICATION_RUN_MSG(){return'Verification process finished';}},{key:"TEST_CASES_FIELD",value:function TEST_CASES_FIELD(){return'testCases';}},{key:"CURRENT_TEST_FIELD",value:function CURRENT_TEST_FIELD(){return'currentTest';}}]);function UnitTest(intentId,botState){var _this61=this;_classCallCheck(this,UnitTest);var _this60=_possibleConstructorReturn(this,(UnitTest.__proto__||Object.getPrototypeOf(UnitTest)).call(this,intentId,botState));_this60.onTest=function _callee38(){return regeneratorRuntime.async(function _callee38$(_context56){while(1){switch(_context56.prev=_context56.next){case 0:case"end":return _context56.stop();}}},null,_this61);};_this60.onVerification=function _callee39(){return regeneratorRuntime.async(function _callee39$(_context57){while(1){switch(_context57.prev=_context57.next){case 0:case"end":return _context57.stop();}}},null,_this61);};return _this60;}_createClass(UnitTest,[{key:"unitTestIntent",get:function get(){return true;}},{key:"onMatching",get:function get(){var _this62=this;return function(state){return state.messageTypeFromUser==='string'&&state.messageFromUser.substring(0,5)===UnitTest.RUN_COMMAND()&&state.R.toLower(state.messageFromUser.substring(6,state.messageFromUser.length))===state.R.toLower(_this62.intentId);};}},{key:"onResolution",get:function get(){var _this63=this;return function _callee40(state){return regeneratorRuntime.async(function _callee40$(_context58){while(1){switch(_context58.prev=_context58.next){case 0:_context58.next=2;return regeneratorRuntime.awrap(_this63.onTest());case 2:if(state.responsesArray.length===0){state.addStringResponse(UnitTest.TEST_RUN_MSG());}case 3:case"end":return _context58.stop();}}},null,_this63);};}}]);return UnitTest;}(Intent);var Developer=function(){_createClass(Developer,null,[{key:"DEBUG",value:function DEBUG(){return'Debug';}},{key:"DEV",value:function DEV(){return'Dev';}},{key:"PROD",value:function PROD(){return'Prod';}},{key:"TEST",value:function TEST(){return'Test';}},{key:"PERF",value:function PERF(){return'Perf';}}]);function Developer(botState){_classCallCheck(this,Developer);this['_botState']=botState;this['_']=botState._;this['R']=botState.R;this['_debugMode']=false;this['_command']=[];this['_runProfile']=Developer.PROD();}_createClass(Developer,[{key:"callBotPublisher",value:function callBotPublisher(newBot,action){var _this64=this;var params={action:action,conversation:this._botState.conversation,botMetadata:newBot,userId:this._botState.user.userId};return callLambda('BotPublisher',params,this._botState.aws).then(function(response){var payload=JSON.parse(response.Payload);if(payload.error!==0){if(payload.error===9){_this64._botState.addSystemErrorToStack(9);}else{_this64._botState.addSystemErrorToStack(7,payload.error);}}return payload.error;});}},{key:"publishBot",value:function publishBot(newBot){return this.callBotPublisher(newBot,'publishNewBot');}},{key:"updateBot",value:function updateBot(newBot){return this.callBotPublisher(newBot,'updateBot');}},{key:"deleteBotFromCatalogue",value:function deleteBotFromCatalogue(newBot){return this.callBotPublisher(newBot,'deleteBot');}},{key:"publishApp",value:function publishApp(newBot){return this.callBotPublisher(newBot,'publishNewBotInNewFormat');}},{key:"updateApp",value:function updateApp(newBot){return this.callBotPublisher(newBot,'updateBotInNewFormat');}},{key:"deleteAppFromCatalogue",value:function deleteAppFromCatalogue(newBot){return this.callBotPublisher(newBot,'deleteBotInNewFormat');}},{key:"setDebugActive",value:function setDebugActive(){this.log({message:'Activating debug mode'});this._debugMode=true;}},{key:"validDeveloperDomains",value:function validDeveloperDomains(){var _this65=this;var domains=[];if(this._botState.conversation.userDomain==='frontmai'){this._botState._.each(this._botState.userDomains,function(userDomain){var index=_this65._botState._.findIndex(userDomain.roles,function(role){return role='developer';});if(index>-1){domains.push(userDomain.domain);}});}else{domains.push(this._botState.conversation.userDomain);}return domains;}},{key:"isDeveloperIntent",value:function isDeveloperIntent(){if(typeof this._botState.messageFromUser==='string'&&this._botState.messageFromUser.substring(0,2)==='@@'&&this._botState.messageFromUser.substring(0,5)!=='@@run'){return true;}return false;}},{key:"identifyDeveloperIntent",value:function identifyDeveloperIntent(){if(typeof this._botState.messageFromUser==='string'){var command=this.R.toLower(this._botState.messageFromUser);switch(command){case'@@reset conversation':return'_dev_reset_conversation';case'@@show log':return'_dev_show_log';case'@@clear log':return'_dev_clearLog';case'@@debug on':return'_dev_debug_switch_on';case'@@debug off':return'_dev_debug_switch_off';case'@@inspect all':return'_dev_inspect_all';case'@@inspect nlp':return'_dev_inspect_nlp';case'@@inspect history':return'_dev_inspect_history';case'@@show performance':return'_dev_show_performance';case'@@email performance':return'_dev_backend_email_performance';case'@@inspect messages':return'_dev_inspect_messages';case'@@inspect old fields':return'_dev_inspect_old';default:if(this.R.includes('@@inspect state',command)){return'_dev_inspect_state';}else if(this.R.includes('@@inspect',command)){return'_dev_inspect';}}}return null;}},{key:"badCommandSyntax",value:function badCommandSyntax(){this._botState.addActiveIntent(Intent.NO_INTENT());}},{key:"debug",value:function debug(_ref19){var message=_ref19.message,errorCode=_ref19.errorCode,data=_ref19.data,more=_ref19.more;if(this.runProfile===Developer.DEBUG()){this.addEntryInES({level:LogEntrytype.DEBUG(),message:message,errorCode:errorCode,data:data,more:more});}}},{key:"log",value:function log(_ref20){var message=_ref20.message,errorCode=_ref20.errorCode,data=_ref20.data,more=_ref20.more;if(this.runProfile===Developer.DEV()||this.runProfile===Developer.DEBUG()){this.addEntryInES({level:LogEntrytype.LOG(),message:message,errorCode:errorCode,data:data,more:more});}}},{key:"info",value:function info(_ref21){var message=_ref21.message,errorCode=_ref21.errorCode,data=_ref21.data,more=_ref21.more;if(this.runProfile===Developer.DEBUG()){this.addEntryInES({level:LogEntrytype.INFO(),message:message,errorCode:errorCode,data:data,more:more});}}},{key:"warning",value:function warning(_ref22){var message=_ref22.message,errorCode=_ref22.errorCode,data=_ref22.data,more=_ref22.more;this.addEntryInES({level:LogEntrytype.WARNING(),message:message,errorCode:errorCode,data:data,more:more});}},{key:"perf",value:function perf(_ref23){var message=_ref23.message,errorCode=_ref23.errorCode,data=_ref23.data,more=_ref23.more;if(this.runProfile===Developer.DEBUG()||this.runProfile===Developer.PERF()){this.addEntryInES({level:LogEntrytype.PERF(),message:message,errorCode:errorCode,data:data,more:more});}}},{key:"systemError",value:function systemError(_ref24){var message=_ref24.message,errorCode=_ref24.errorCode,data=_ref24.data,more=_ref24.more;this.addEntryInES({level:LogEntrytype.SYSTEM_ERROR(),message:message,errorCode:errorCode,data:data,more:more});}},{key:"userError",value:function userError(_ref25){var message=_ref25.message,errorCode=_ref25.errorCode,data=_ref25.data,more=_ref25.more;this.addEntryInES({level:LogEntrytype.USER_ERROR(),message:message,errorCode:errorCode,data:data,more:more});}},{key:"addEntryInES",value:function addEntryInES(_ref26){var level=_ref26.level,errorCode=_ref26.errorCode,message=_ref26.message,data=_ref26.data,more=_ref26.more;try{var activeIntent=void 0;if(this._botState.activeIntent!==''){activeIntent=this._botState.activeIntent;}var params={type:'USER',entry:{userDomain:this._botState.currentUserDomain,userId:this._botState.user.userId,userEmail:this._botState.user.userEmail,botId:this._botState.conversation.bot,conversationId:this._botState.conversationId,entity:'Micro-App',intent:activeIntent,client:this._botState.client,location:this._botState.location,timestamp:Date.now(),level:level,errorCode:errorCode,message:message,data:!data||typeof data==='string'?data:JSON.stringify(data)}};if(more){params.entry=_extends({},params.entry,more);}var size=this._botState.sizeOfObject(JSON.stringify(params));if(size>200000){this.warning({message:Error.getErrorMessageforCodeAndLang(50,'en'),data:message});return;}if(this._botState.location===Intent.CLOUD()||this._botState.location===Intent.EDGE()&&this._botState.v1Compatibility){try{var lambda=this._botState.frontmlib;return lambda.invokeLambda('logger','Event',params);}catch(err){this._botState.context.log(params);}}else{params.data=params.entry.data;this._botState.context.log(params);}}catch(err){this._botState.addSystemErrorToStack(26,'1 '+err.name+': '+err.message);}}},{key:"processCommand",value:function processCommand(command){switch(command){case'_dev_reset_conversation':{this.resetConversation();break;}case'_dev_show_log':{this.showLog();break;}case'_dev_clearLog':{this.clearLogCommand();break;}case'_dev_debug_switch_on':{this.debugSwitch(true);break;}case'_dev_debug_switch_off':{this.debugSwitch(false);break;}case'_dev_inspect':{this.inspectField();break;}case'_dev_inspect_all':{this.inspectAllFields();break;}case'_dev_show_performance':{this.showPerformance();break;}case'_dev_inspect_nlp':{this.inspectNLPFields();break;}case'_dev_inspect_state':{this.inspectStateField();break;}case'_dev_inspect_history':{this.inspectHistory();break;}case'_dev_backend_email_performance':{return this.emailPerformance();break;}case'_dev_inspect_messages':{return this.inspectMessages();break;}case'_dev_inspect_old':{return this.inspectOldFields();break;}default:break;}}},{key:"inspectField",value:function inspectField(){var fieldName=this.R.head(this.R.drop(1,this.R.split(' ')(this._botState.messageFromUser)));if(fieldName){var fieldContent=this.R.toString(this._.get(this._botState.fields,fieldName));if(fieldContent){this._botState.addStringResponse(fieldContent);return;}}this._botState.addStringResponse('Could not find '+fieldName);}},{key:"inspectAllFields",value:function inspectAllFields(){var fieldContent=this.R.toString(this._botState.fields);this._botState.addStringResponse(fieldContent);}},{key:"inspectOldFields",value:function inspectOldFields(){var fieldContent=this.R.toString(this._botState._oldFields);this._botState.addStringResponse(fieldContent);}},{key:"inspectNLPFields",value:function inspectNLPFields(){var fieldContent=this.R.toString(this._botState._lastNLPResults);this._botState.addStringResponse(fieldContent);}},{key:"inspectStateField",value:function inspectStateField(){this._botState.addStringResponse(this._botState.R.toString(this._botState.getAllProperties()));}},{key:"inspectHistory",value:function inspectHistory(){this._botState.addStringResponse(this._botState.R.toString(this._botState._intentHistory));}},{key:"inspectMessages",value:function inspectMessages(){this._botState.addStringResponse(this._botState.R.toString(this._botState._inputHistory));}},{key:"debugSwitch",value:function debugSwitch(mode){if(this._debugMode&&mode){this._botState.addStringResponse('Debug mode is already active');}else if(this._debugMode===mode){this._botState.addStringResponse('Debug mode is already inactive');}else{this._debugMode=mode;if(this._debugMode){this.log({message:'Debug mode set to active'});this._botState.addStringResponse('Debug mode activated');}else{this.log({message:'Debug mode set to inactive'});this._botState.addStringResponse('Debug mode deactivated');}}}},{key:"genericShowLogs",value:function genericShowLogs(options,rows){if(this._botState.client===State.WEBCLIENT()){this._botState.addResponse(this._botState.messageTypes.MESSAGE_TYPE_TABLE,{options:options,rows:rows});}else{this._botState.addResponse(this._botState.messageTypes.MESSAGE_TYPE_DATA_CARD,rows);}}},{key:"showLog",value:function showLog(){var _this66=this;var options={title:'Logged data',description:'App log data',columnNames:['date','type','message']};var rows=[];var rowIterator=function rowIterator(logEntry){var row={date:new Date(logEntry.dateTime),type:logEntry.entryType,message:logEntry.loggedMessage};if(_this66._botState.client===State.MOBILECLIENT()){row.title='Log Entry';}rows.push(row);};this.R.forEach(rowIterator,this.R.reverse(this._botState._log));this.genericShowLogs(options,rows);}},{key:"resetConversation",value:function resetConversation(){console.log("Resetting conversation");this._botState._activeIntent='';this._botState.requestIdsArray=[];this._botState._log=[];this._botState._intentHistory=[];this._botState._intentStats={};this._botState.lastGreetingTime=0;this._botState.errorStack=[];this._botState.fields={};this._botState.sessionFields={};this._botState.waitingCustomCap=0;this._botState.promptAlive='';this._botState._currentSearchBox='';this._botState._inSilence=false;this._botState._intentDurations=[];this._botState._lastNLPResults={};this._botState_maps={};this._botState.clearSmartSuggestionsArray();this._botState.blockSuggestions=true;this._botState._silentIntent=false;this._botState.clearAutoSaveBuffer();this._botState.clearAutoSaveBufferChanges();this._botState.addStringResponse('The conversation has been reset');this._botState.sendMessage({intentId:'@@reset'});}},{key:"clearLogCommand",value:function clearLogCommand(){var _this67=this;return new Promise(function(resolve,reject){_this67._botState.addStringResponse('The log has been cleared');_this67._botState._log=[];resolve();});}},{key:"showPerformance",value:function showPerformance(){var _this68=this;var options={title:'Performance report',description:'Performance readings'};var rows=[];var intentIterator=function intentIterator(entry){var row={intent:entry.intent,event:entry.event,statTime:entry.startTime,duration:_this68.R.toString(entry.duration)};rows.push(row);};this.R.forEach(intentIterator,this.R.reverse(this._botState._intentDurations));this.genericShowLogs(options,rows);}},{key:"emailPerformance",value:function emailPerformance(){var _this69=this;var email='support@frontm.com';var title='Performance report';var body='See attached performance report from '+this._botState.user.userEmail;var attachment={name:'performance.json',content:this._botState._intentDurations};return this._botState.notification.sendEmail(email,title,body,attachment).then(function(){_this69._botState.addStringResponse('The email with the performance report has been sent');});}},{key:"logCurrentEventDurationWithStartTime",value:function logCurrentEventDurationWithStartTime(event,startTime,endTime){try{var newEventLog={event:event,startTime:startTime,duration:endTime-startTime};this.perf({more:newEventLog});}catch(error){return;}}},{key:"generateTestCaseStep",value:function generateTestCaseStep(_ref27){var message=_ref27.message;var params={state:this._botState.getAllProperties(),schedule:Date.now()};params.state.messageTypeFromUser=message.type;params.state.messageFromUser=message.content;params.state.client=this._botState.client;params.state.userName=this._botState.userName;params.state.lang='en';params.state.waitingCustomCap=0;params.state.messageFromUser.page=0;params.state.unitTestMode=true;return params;}},{key:"submitTest",value:function submitTest(_ref28){var testCases=_ref28.testCases;var currentTestCase,fullState,jobId,response;return regeneratorRuntime.async(function submitTest$(_context59){while(1){switch(_context59.prev=_context59.next){case 0:currentTestCase=testCases[0];this._botState.setField(UnitTest.TEST_CASES_FIELD(),testCases);this._botState.setField(UnitTest.CURRENT_TEST_FIELD(),this._botState.activeIntent);fullState=this.generateTestCaseStep({message:currentTestCase});jobId=this._botState.getUniqueId();_context59.next=7;return regeneratorRuntime.awrap(this._botState.jobScheduler.addNewJob(this._botState.client,fullState,jobId,null));case 7:response=_context59.sent;if(!(response.jobId!==jobId)){_context59.next=12;break;}this._botState.addErrorToStack(1000,"Problems submitting test case");_context59.next=13;break;case 12:return _context59.abrupt("return",response.jobId);case 13:case"end":return _context59.stop();}}},null,this);}},{key:"runProfile",get:function get(){return this._runProfile;},set:function set(runProfile){this._runProfile=runProfile;if(this._botState.client===State.MOBILECLIENT()&&this._botState.location===Intent.EDGE()&&!this._botState.v1Compatibility){this._botState.context.devMode();}}}]);return Developer;}();var SFTP=function(){function SFTP(botState){_classCallCheck(this,SFTP);this['_botState']=botState;this['_']=botState._;var capabilities=botState.context.capabilities.capabilities;if(capabilities){this['_context']=botState.context.capabilities;this['_sftpClient']=botState.context.capabilities.ssh2SftpClient;}else{this['_context']=botState.context;this['_sftpClient']=botState.context.ssh2SftpClient;}}_createClass(SFTP,[{key:"connect",value:function connect(host,port,username,password){var sftpClient;return regeneratorRuntime.async(function connect$(_context60){while(1){switch(_context60.prev=_context60.next){case 0:_context60.prev=0;sftpClient=new this._sftpClient();_context60.next=4;return regeneratorRuntime.awrap(sftpClient.connect({host:host,port:port,username:username,password:password}));case 4:return _context60.abrupt("return",sftpClient);case 7:_context60.prev=7;_context60.t0=_context60["catch"](0);throw _context60.t0;case 10:case"end":return _context60.stop();}}},null,this,[[0,7]]);}},{key:"disconnect",value:function disconnect(sftpClient){return regeneratorRuntime.async(function disconnect$(_context61){while(1){switch(_context61.prev=_context61.next){case 0:_context61.prev=0;_context61.next=3;return regeneratorRuntime.awrap(sftpClient.end());case 3:_context61.next=8;break;case 5:_context61.prev=5;_context61.t0=_context61["catch"](0);throw _context61.t0;case 8:case"end":return _context61.stop();}}},null,this,[[0,5]]);}},{key:"getFilesList",value:function getFilesList(sftpClient,path){return regeneratorRuntime.async(function getFilesList$(_context62){while(1){switch(_context62.prev=_context62.next){case 0:_context62.prev=0;_context62.next=3;return regeneratorRuntime.awrap(sftpClient.list(path));case 3:return _context62.abrupt("return",_context62.sent);case 6:_context62.prev=6;_context62.t0=_context62["catch"](0);throw _context62.t0;case 9:case"end":return _context62.stop();}}},null,this,[[0,6]]);}},{key:"downloadFileToS3",value:function downloadFileToS3(sftpClient,S3,fromPath,toPath,fileName){var config,env,stream,putParams;return regeneratorRuntime.async(function downloadFileToS3$(_context63){while(1){switch(_context63.prev=_context63.next){case 0:_context63.prev=0;config=this._.get(this._context,'capabilities.config');env=this._.get(this._context,'capabilities.env');if(!config){config=this._.get(this._context,'config');env=this._.get(this._context,'env');}_context63.next=6;return regeneratorRuntime.awrap(sftpClient.get(fromPath+"/"+fileName));case 6:stream=_context63.sent;putParams={Bucket:config[env].CONVERSATIONS_BUCKET,Key:toPath+"/"+fileName,Body:stream};_context63.next=10;return regeneratorRuntime.awrap(S3.putObject(putParams).promise());case 10:_context63.next=15;break;case 12:_context63.prev=12;_context63.t0=_context63["catch"](0);throw _context63.t0;case 15:case"end":return _context63.stop();}}},null,this,[[0,12]]);}},{key:"putFileToFTPServer",value:function putFileToFTPServer(sftpConnection,readStream,remotePath){var _D2;return regeneratorRuntime.async(function putFileToFTPServer$(_context64){while(1){switch(_context64.prev=_context64.next){case 0:_context64.prev=0;_D2=this._botState.developer;_context64.next=4;return regeneratorRuntime.awrap(sftpConnection.put(readStream,remotePath));case 4:_context64.next=10;break;case 6:_context64.prev=6;_context64.t0=_context64["catch"](0);D.systemError({message:'putFileToFTPServer:Error occurred while putting the file to the server',errorCode:_context64.t0.message,data:_context64.t0});throw _context64.t0;case 10:case"end":return _context64.stop();}}},null,this,[[0,6]]);}}]);return SFTP;}();var Notification=function(){function Notification(botState){_classCallCheck(this,Notification);this['_botState']=botState;this['_']=botState._;if(this._botState.client===State.MOBILECLIENT()){this['notification']=this._botState.context.getCapability('Notification');}}_createClass(Notification,[{key:"sendEmail",value:function sendEmail(to,title,body,attachments,from,cc){var params={capability:'SendEmailCustomCapability',capabilityFileName:'email',address:to,cc:cc,fromEmail:from,htmlBody:body,title:title,sync:true,userId:this._botState.user.userId,conversation:this._botState.conversation,attachments:[]};var allAttachments=[];if(attachments){this._.each(attachments,function(attachment){var a={fileContentName:attachment.name};if(attachment.type==='csv'||attachment.type==='string'){a.stringContent=attachment.content;}else{a.jsonContent=attachment.content;}allAttachments.push(a);});params.attachments=allAttachments;}return this._botState.callCapability(params);}},{key:"sendIMMessage",value:function sendIMMessage(){var messageToSend={messageId:this._botState.messageIdFromUser,contentType:this._botState.messageTypeIntFromUser,createdOn:this._botState.messageCreatedOnFromUser,createdBy:this._botState.user.userId,content:this._botState.messageContentFromUser,options:this._botState.messageOptionsFromUser};var params={capability:'SendIMMessage',capabilityFileName:'sendIMMessage',sync:true,userId:this._botState.user.userId,conversation:this._botState.conversation,messages:[messageToSend],isNewConversation:false};return this._botState.callCapability(params);}},{key:"sendVoipPushNotificationToUserDevices",value:function sendVoipPushNotificationToUserDevices(userDevices,sns,conversationId,message,data){var _this70=this;var _,D,createVoipMsg,callVoipMessage;return regeneratorRuntime.async(function sendVoipPushNotificationToUserDevices$(_context65){while(1){switch(_context65.prev=_context65.next){case 0:_=this._botState._;D=this._botState.developer;createVoipMsg=function createVoipMsg(conversationId){var apsMsg={aps:{alert:message,data:{videoSessionId:_.get(data,'videoSessionId'),botId:_.get(data,'botId'),userDomain:_.get(data,'userDomain'),userId:_.get(data,'userId'),videoControlId:_.get(data,'videoControlId'),video:_.get(data,'video'),mediasoupHost:_.get(data,'mediasoupHost'),codec:_.get(data,'codec'),iAmHost:_.get(data,'iAmHost'),startWithVideoMuted:_.get(data,'startWithVideoMuted'),preConnectCallCheck:_.get(data,'preConnectCallCheck'),uid:_.get(data,'uid'),ur:_.get(data,'ur'),callAction:_.get(data,'callAction'),conversationId:conversationId,roomName:_.get(data,'roomName'),brand:_.get(data,'brand')},sound:_.get(data,'soundName','default')}};var gcmMsg={data:{message:message,conversationId:conversationId,videoSessionId:_.get(data,'videoSessionId'),botId:_.get(data,'botId'),userDomain:_.get(data,'userDomain'),userId:_.get(data,'userId'),videoControlId:_.get(data,'videoControlId'),video:_.get(data,'video'),mediasoupHost:_.get(data,'mediasoupHost'),iAmHost:_.get(data,'iAmHost'),startWithVideoMuted:_.get(data,'startWithVideoMuted'),preConnectCallCheck:_.get(data,'preConnectCallCheck'),uid:_.get(data,'uid'),ur:_.get(data,'ur'),callAction:_.get(data,'callAction'),codec:_.get(data,'codec'),soundName:_.get(data,'soundName'),roomName:_.get(data,'roomName'),brand:_.get(data,'brand')},time_to_live:10,priority:'high'};var snsMsg={default:message,GCM:JSON.stringify(gcmMsg),APNS_VOIP:JSON.stringify(apsMsg),APNS_VOIP_SANDBOX:JSON.stringify(apsMsg)};return JSON.stringify(snsMsg);};callVoipMessage=function callVoipMessage(conversationId,sns,message,arn){var snsParams={Message:createVoipMsg(conversationId,message),MessageStructure:'json',MessageAttributes:{'AWS.SNS.MOBILE.APNS.TTL':{DataType:'String',StringValue:'10'},'AWS.SNS.MOBILE.APNS.PRIORITY':{DataType:'String',StringValue:'10'},'AWS.SNS.MOBILE.APNS.PUSH_TYPE':{DataType:'String',StringValue:'voip'}},TargetArn:arn};return sns.publish(snsParams).promise();};_.forEach(userDevices,function(arn){callVoipMessage(conversationId,sns,message,arn).then(function(){_this70._botState.developer.info({message:'Push notification sent with no error'});}).catch(function(err){_this70._botState.developer.warning({message:'Could not send push notification to a device',data:JSON.stringify(err)});return'error occurred while sending notification to :'+arn;});});case 5:case"end":return _context65.stop();}}},null,this);}},{key:"sendVoipCallPushNotifications",value:function sendVoipCallPushNotifications(conversations,message,data,onlyAndroid,onlyIOS,ignoreTimeDelay){var botState,R,_,D,sns,devices,notificationsTargets,keys,i,conversation,participants,j,participant,notificationKey,previousNotificationTime,key,people,allDevices,webPushAppType,sendWebPush,webPushPromises,_i3,_key,target;return regeneratorRuntime.async(function sendVoipCallPushNotifications$(_context66){while(1){switch(_context66.prev=_context66.next){case 0:botState=this._botState;R=botState.R;_=botState._;D=botState.developer;sns=new this._botState.aws.SNS({apiVersion:'2010-03-31'});devices=[];notificationsTargets={};keys=[];i=0;case 9:if(!(i<conversations.length)){_context66.next=32;break;}conversation=conversations[i];participants=_.get(conversation,'participants')||[];j=0;case 13:if(!(j<participants.length)){_context66.next=29;break;}participant=participants[j];if(!(participant!==_.get(conversation,'bot'))){_context66.next=26;break;}notificationKey="PUSH_NOTIFICATION_KEY_"+participant;_context66.next=19;return regeneratorRuntime.awrap(this._botState.getSharedField(notificationKey));case 19:previousNotificationTime=_context66.sent;if(!(Date.now()-_.get(previousNotificationTime,'timeStamp',0)>10000||ignoreTimeDelay)){_context66.next=26;break;}_context66.next=23;return regeneratorRuntime.awrap(this._botState.setSharedField(notificationKey,{timeStamp:Date.now()},10));case 23:key="People_"+participant;keys.push(key);notificationsTargets[key]={conversationId:conversation.conversationId};case 26:j++;_context66.next=13;break;case 29:i++;_context66.next=9;break;case 32:if(!_.isEmpty(notificationsTargets)){_context66.next=34;break;}return _context66.abrupt("return");case 34:_context66.next=36;return regeneratorRuntime.awrap(this._botState.db.getMultipleValuesFromCache(keys));case 36:people=_context66.sent;allDevices=[];_context66.next=40;return regeneratorRuntime.awrap(this._botState.getStaticData("webPushAppType"));case 40:webPushAppType=_context66.sent;sendWebPush=function sendWebPush(person){D.log({message:"webPushAppType",data:webPushAppType});if(webPushAppType){var params={pushType:"WEB_PUSH",action:"SendNotification",webPushAppType:webPushAppType,userId:_.get(person,"userId"),userEmail:_.get(person,"emailAddress"),message:{title:"FrontM Notifications",text:message}};D.log({message:"params",data:params});return botState.callLambda("PushNotificationHandler",params,"Event");}};webPushPromises=[];_.forEach(people,function(person,key){var parsedPerson=JSON.parse(person.content);var personDevices=_.get(parsedPerson,'voipDevices',[]);var _loop=function _loop(device,_i){var index=_.findIndex(allDevices,function(currentDevice){return currentDevice===device;});if(index>-1){personDevices.splice(_i,1);}else{if(onlyAndroid){if(device.includes("APN")){personDevices.splice(_i,1);}}else if(onlyIOS){if(device.includes("GCM")){personDevices.splice(_i,1);}}allDevices.push(device);}};for(var _iterator=personDevices.entries(),_isArray=Array.isArray(_iterator),_i2=0,_iterator=_isArray?_iterator:_iterator[typeof Symbol==="function"?typeof Symbol==="function"?Symbol.iterator:"@@iterator":"@@iterator"]();;){var _ref31;if(_isArray){if(_i2>=_iterator.length)break;_ref31=_iterator[_i2++];}else{_i2=_iterator.next();if(_i2.done)break;_ref31=_i2.value;}var _ref29=_ref31;var _ref30=_slicedToArray(_ref29,2);var _i=_ref30[0];var device=_ref30[1];_loop(device,_i);}if(_.size(personDevices)>0){notificationsTargets[key].devices=personDevices;}else{delete notificationsTargets[key];}webPushPromises.push(sendWebPush(parsedPerson));});_context66.next=46;return regeneratorRuntime.awrap(Promise.all(webPushPromises));case 46:_i3=0;case 47:if(!(_i3<_.keys(notificationsTargets).length)){_context66.next=56;break;}_key=_.keys(notificationsTargets)[_i3];target=notificationsTargets[_key];_context66.next=52;return regeneratorRuntime.awrap(this.sendVoipPushNotificationToUserDevices(_.get(target,'devices'),sns,_.get(target,'conversationId'),message,data));case 52:D.info({message:'Sent to device',data:target});case 53:_i3++;_context66.next=47;break;case 56:case"end":return _context66.stop();}}},null,this);}},{key:"sendPushNotificationToUserDevices",value:function sendPushNotificationToUserDevices(userDevices,sns,conversationId,message,data){var _this71=this;var _,createSNSMsg,callSNS;return regeneratorRuntime.async(function sendPushNotificationToUserDevices$(_context67){while(1){switch(_context67.prev=_context67.next){case 0:_=this._botState._;createSNSMsg=function createSNSMsg(conversationId){var apsMsg={aps:{alert:message,sound:_.get(data,'soundName','default')},videoSessionId:_.get(data,'videoSessionId'),botId:_.get(data,'botId'),userDomain:_.get(data,'userDomain'),userId:_.get(data,'userId'),videoControlId:_.get(data,'videoControlId'),video:_.get(data,'video'),conversationId:conversationId};var gcmMsg={collapse_key:'FrontM messages',notification:{title:message,conversationId:conversationId,botId:_.get(data,'botId'),userDomain:_.get(data,'userDomain'),userId:_.get(data,'userId'),soundName:_.get(data,'soundName')},data:{message:message,conversationId:conversationId,videoSessionId:_.get(data,'videoSessionId'),botId:_.get(data,'botId'),userDomain:_.get(data,'userDomain'),userId:_.get(data,'userId'),videoControlId:_.get(data,'videoControlId'),video:_.get(data,'video'),soundName:_.get(data,'soundName')}};var snsMsg={default:message,GCM:JSON.stringify(gcmMsg),APNS:JSON.stringify(apsMsg),APNS_SANDBOX:JSON.stringify(apsMsg)};return JSON.stringify(snsMsg);};callSNS=function callSNS(conversationId,sns,message,arn){var snsParams={Message:createSNSMsg(conversationId,message),MessageStructure:'json',Subject:'New Message',TargetArn:arn};return sns.publish(snsParams).promise();};_.forEach(userDevices,function(arn){callSNS(conversationId,sns,message,arn).then(function(){_this71._botState.developer.info({message:'Push notification sent with no error'});}).catch(function(err){_this71._botState.developer.warning({message:'Could not send push notification to a device',data:JSON.stringify(err)});return'error occurred while sending notification to :'+arn;});});case 4:case"end":return _context67.stop();}}},null,this);}},{key:"sendPushNotifications",value:function sendPushNotifications(conversations,message,data){var _this72=this;var R,_,D,sns,devices,notificationsTargets,keys,people;return regeneratorRuntime.async(function sendPushNotifications$(_context68){while(1){switch(_context68.prev=_context68.next){case 0:R=this._botState.R;_=this._botState._;D=this._botState.developer;D.debug({message:"Sending push",data:{conversations:conversations,message:message,data:data}});sns=new this._botState.aws.SNS({apiVersion:'2010-03-31'});devices=[];notificationsTargets={};keys=[];_.forEach(conversations,function(conversation){_.forEach(_.get(conversation,'participants'),function(participant){if(participant!==_.get(conversation,'bot')){var key="People_"+participant;keys.push(key);notificationsTargets[key]={conversationId:conversation.conversationId};}});});if(!(keys.length>0)){_context68.next=18;break;}_context68.next=12;return regeneratorRuntime.awrap(this._botState.db.getMultipleValuesFromCache(keys));case 12:people=_context68.sent;_.forEach(people,function(person,key){var parsedPerson=JSON.parse(person.content);notificationsTargets[key].devices=devices.concat(_.get(parsedPerson,'devices',[]));});D.debug({message:'Targets ',data:JSON.stringify(notificationsTargets)});_.forEach(notificationsTargets,function(target){_this72.sendPushNotificationToUserDevices(_.get(target,'devices'),sns,_.get(target,'conversationId'),message,data).then(function(){});});_context68.next=19;break;case 18:D.warning({message:"No participants within the conversation"});case 19:case"end":return _context68.stop();}}},null,this);}},{key:"ringParticipantsInConversationList",value:function ringParticipantsInConversationList(conversations,alertMessage,data){var _,D,i,conversation,_conversationId,participants,l,participant;return regeneratorRuntime.async(function ringParticipantsInConversationList$(_context69){while(1){switch(_context69.prev=_context69.next){case 0:_=this._botState._;D=this._botState.developer;i=0;case 3:if(!(i<conversations.length)){_context69.next=20;break;}conversation=conversations[i];_conversationId=_.get(conversation,'conversationId');participants=_.get(conversation,'participants');l=0;case 8:if(!(l<participants.length)){_context69.next=17;break;}participant=participants[l];data.conversationId=_conversationId;if(!(participant!==this._botState.user.userId)){_context69.next=14;break;}_context69.next=14;return regeneratorRuntime.awrap(this.sendVoipPushNotifications(participant,alertMessage,data));case 14:l++;_context69.next=8;break;case 17:i++;_context69.next=3;break;case 20:case"end":return _context69.stop();}}},null,this);}},{key:"sendVoipPushNotifications",value:function sendVoipPushNotifications(receiverUserId,alertMessage,data){var _this73=this;var R,_,D,createVoipMsg,sendVoipNotification,frontmLib,receiver,voipDevices,sns;return regeneratorRuntime.async(function sendVoipPushNotifications$(_context70){while(1){switch(_context70.prev=_context70.next){case 0:R=this._botState.R;_=this._botState._;D=this._botState.developer;_context70.prev=3;createVoipMsg=function createVoipMsg(alertMessage,data){var apsMsg={aps:{alert:alertMessage,data:data}};var androidMessage={notification:{title:alertMessage,body:data.message,sound:'incallmanager_ringback.mp3',android_channel_id:'500'},data:data,"priority":"high"};var snsMsg={APNS_VOIP_SANDBOX:JSON.stringify(apsMsg),APNS_VOIP:JSON.stringify(apsMsg),GCM:JSON.stringify(androidMessage)};return JSON.stringify(snsMsg);};sendVoipNotification=function sendVoipNotification(alertMessage,data,arn,sns){var snsParams={Message:createVoipMsg(alertMessage,data),MessageStructure:'json',MessageAttributes:{"AWS.SNS.MOBILE.APNS.PRIORITY":{"DataType":"String","StringValue":"10"},"AWS.SNS.MOBILE.APNS.PUSH_TYPE":{"DataType":"String","StringValue":"voip"}},TargetArn:arn};return sns.publish(snsParams).promise();};frontmLib=this._botState.frontmlib;_context70.next=9;return regeneratorRuntime.awrap(frontmLib.dbGetWithKey('People',{userId:receiverUserId}));case 9:receiver=_context70.sent;voipDevices=_.get(receiver,'Item.voipDevices',[]);sns=new this._botState.aws.SNS({apiVersion:'2010-03-31'});_.forEach(voipDevices,function(arn){sendVoipNotification(alertMessage,data,arn,sns).then(function(){_this73._botState.developer.info({message:"Voip Push notification sent with no error: "+arn});}).catch(function(err){_this73._botState.developer.warning({message:"Could not send voip push notification to a device to: "+arn,data:JSON.stringify(err)});});});_context70.next=18;break;case 15:_context70.prev=15;_context70.t0=_context70["catch"](3);D.warning({message:'Fail voip push',data:_context70.t0.message});case 18:case"end":return _context70.stop();}}},null,this,[[3,15]]);}},{key:"endCall",value:function endCall(_ref32){var receiverUserId=_ref32.receiverUserId,videoSessionId=_ref32.videoSessionId,video=_ref32.video;var params={capability:'VoipCapability',capabilityFileName:'voipCapability',action:'sendVoipPushNotification',callAction:'CallEnd',callerUserId:this._botState.user.userId,receiverUserId:receiverUserId,videoSessionId:videoSessionId,video:video};return this._botState.callCapability(params);}},{key:"ringMultipleUsers",value:function ringMultipleUsers(conversations,alertMessage,data){var _,D,callerId,receivers,i,conversation;return regeneratorRuntime.async(function ringMultipleUsers$(_context71){while(1){switch(_context71.prev=_context71.next){case 0:_=this._botState._;D=this._botState.developer;callerId=this._botState.user.userId;receivers=[];i=0;case 5:if(!(i<conversations.length)){_context71.next=12;break;}conversation=conversations[i];_context71.next=9;return regeneratorRuntime.awrap(this.sendVoipCallPushNotifications(conversation,alertMessage,data));case 9:i++;_context71.next=5;break;case 12:case"end":return _context71.stop();}}},null,this);}},{key:"ringSingleUser",value:function ringSingleUser(receiverUserId,alertMessage,data){var _=this._botState._;var D=this._botState.developer;var callerId=this._botState.user.userId;var params={capability:'VoipCapability',capabilityFileName:'voipCapability',action:'sendVoipPushNotification',callAction:'CallStart',callerUserId:callerId,receiverUserId:receiverUserId,videoSessionId:data.videoSessionId,video:data.video||false,alertMessage:alertMessage};return this._botState.callCapability(params);}},{key:"handleCallConnected",value:function handleCallConnected(_ref33){var callerUserId=_ref33.callerUserId,receiverUserId=_ref33.receiverUserId;var params={capability:'VoipCapability',capabilityFileName:'voipCapability',action:'handleMultiUserCalls',callAction:'CallConnected',callerUserId:callerUserId,receiverUserId:receiverUserId};return this._botState.callCapability(params);}},{key:"inviteUsers",value:function inviteUsers(emailIds){var params={capability:'InviteUsers',capabilityFileName:'userInvitation',emailIds:emailIds,sync:true,userId:this._botState.user.userId,conversation:this._botState.conversation};var capabilities=this._botState.context.capabilities.capabilities;var capFileName=params.capabilityFileName;var capabilityModule=capabilities[capFileName];if(capabilityModule){return capabilityModule.execute(params,this._botState.context.capabilities);}else{return callLambda('EmailLambda',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);});}}},{key:"isDeviceRegisteredForPush",value:function isDeviceRegisteredForPush(){var _this74=this;return this.notification.deviceInfo().then(function(deviceInfo){if(_this74._botState._.isEmpty(deviceInfo)){return false;}return deviceInfo.isRegistered;});}},{key:"registerDeviceForPushOnEdge",value:function registerDeviceForPushOnEdge(){if(this._botState.client===State.MOBILECLIENT()){this.notification.requestPermission();}}},{key:"deregisterDeviceForPushOnEdge",value:function deregisterDeviceForPushOnEdge(){var _this75=this;if(this._botState.client===State.MOBILECLIENT()){return this.notification.deregister().then(function(notificationDeviceInfo){return notificationDeviceInfo;}).catch(function(error){_this75._botState.addSystemErrorToStack(19,JSON.stringify(error));});}else{this._botState.addSystemErrorToStack(18);}}},{key:"registerDeviceForPushOnBackend",value:function registerDeviceForPushOnBackend(notificationDeviceInfo){try{var conversation=this._botState.conversation;var userId=this._botState.user.userId;var params={capability:'RegisterDevice',capabilityFileName:'deviceRegistration',deviceToken:notificationDeviceInfo.deviceId,deviceType:notificationDeviceInfo.deviceType,sync:true,userId:userId,conversation:conversation};return this._botState.callCapability(params);}catch(error){this._botState.addSystemErrorToStack(16,null,error.message);}}},{key:"deregisterDeviceForPushOnBackend",value:function deregisterDeviceForPushOnBackend(notificationDeviceInfo){try{var conversation=this._botState.conversation;var userId=this._botState.user.userId;var params={capability:'DeregisterDevice',capabilityFileName:'deviceRegistration',deviceToken:notificationDeviceInfo.deviceId,deviceType:notificationDeviceInfo.deviceType,sync:true,userId:userId,conversation:conversation};return this._botState.callCapability(params);}catch(error){this._botState.addSystemErrorToStack(16,null,error.message);}}},{key:"sendDelayedNotification",value:function sendDelayedNotification(params){return this._botState.callCapability(params);}},{key:"sendNotification",value:function sendNotification(target,type,message,realTimeMessage,v1Compatibility){var _this76=this;try{var _3=this._botState._;var _D3=this._botState.developer;var generateFullMessageForMessage=function generateFullMessageForMessage(msg){var requestId=_this76._botState.getUniqueId();var messageToSend=msg;if(!realTimeMessage){var _state=_3.get(target,'bot')===_this76._botState.botId?_this76._botState.stateToBackEnd():{state:{}};_state.state.messageFromUser=msg;_state.state.messageTypeFromUser='object';_state.state.fromGreeting=false;_state.state.responsesArray=[];_state.state._syncToCloud={};_state.state._syncToEdge={};_state.state.responseToClient=State.WEBCLIENT();_state.state._activeIntent='';if(!realTimeMessage&&v1Compatibility){_state.state.v1Compatibility=true;}messageToSend=_state;}var size=_this76._botState.sizeOfObject(JSON.stringify(messageToSend));if(size>=200000){_D3.log({message:'********** Danger danger danger!! Your PARAMS is too big!! **********',data:size});}return{content:[messageToSend],contentType:type,requestUuid:requestId,createdBy:_this76._botState.user.userId,createdOn:Date.now(),messageId:_this76._botState.getUniqueId()};};var messages=[];if(Array.isArray(message)){_3.forEach(message,function(msg){messages.push(generateFullMessageForMessage(msg));});}else{messages.push(generateFullMessageForMessage(message));}var requestUuid=this._botState.getUniqueId();var params={target:target,capability:'BroadCastMessageCapability',capabilityFileName:'broadCastMessage',action:'get',bot:this._botState.conversation.bot||_3.get(this._botState.context,'botManifest.botId'),userDomain:this._botState.conversation.userDomain,requestUuid:requestUuid,sync:true,email:this._botState.user.userEmail,conversation:this._botState.conversation,realTimeMessage:realTimeMessage,messages:messages};return this._botState.online().then(function(online){if(online){var lambda=new _this76._botState.aws.Lambda();return lambda.invoke({FunctionName:'CapabilityExecutorLambda',InvocationType:'Event',Payload:JSON.stringify(params,null,0)}).promise();}else{_this76._botState.addDelayedNotification(params);return Promise.resolve();}});}catch(error){this._botState.addSystemErrorToStack(16,null,error.message);}}},{key:"sendMessageToUserInBot",value:function sendMessageToUserInBot(type,message,userIds,botId,userDomain,realTimeMessage,delay,v1Compatibility){var _this77=this;var _=this._botState._;var D=this._botState.developer;if(!userIds||_.isEmpty(userIds)){D.warning({message:"The userIds array is empty. This request acts as a broadcast and could duplicate messages"});}var target={bot:botId||this._botState.botId,userDomain:userDomain||this._botState.currentUserDomain,users:userIds};if(delay){setTimeout(function(){return _this77.sendNotification(target,type,message,realTimeMessage,v1Compatibility);},delay);}else{return this.sendNotification(target,type,message,realTimeMessage,v1Compatibility);}}},{key:"sendBroadcastNotificationToBot",value:function sendBroadcastNotificationToBot(botId,userDomain,type,message,realTimeMessage,delay,v1Compatibility){var _this78=this;var target={bot:botId||this._botState.botId,userDomain:userDomain||this._botState.currentUserDomain};if(delay){setTimeout(function(){return _this78.sendNotification(target,type,message,realTimeMessage,v1Compatibility);},delay);}else{return this.sendNotification(target,type,message,realTimeMessage,v1Compatibility);}}}]);return Notification;}();var Vessel=function(){function Vessel(_ref34){var botState=_ref34.botState;_classCallCheck(this,Vessel);this._botState=botState;this.VESSELS_SEARCH_SERVICE="VESSELS_SEARCH_SERVICE";}_createClass(Vessel,[{key:"getRecord",value:function getRecord(_ref35){var imo=_ref35.imo,mmsi=_ref35.mmsi,name=_ref35.name,vesselDoc=_ref35.vesselDoc;var _,D,params,response;return regeneratorRuntime.async(function getRecord$(_context72){while(1){switch(_context72.prev=_context72.next){case 0:_=this._botState._;D=this._botState.developer;params={};if(imo){params.pathParams="";}else if(mmsi){params.pathParams="";}else{params.pathParams="";}_context72.next=6;return regeneratorRuntime.awrap(this._botState.api.callService(this.VESSELS_SEARCH_SERVICE,params));case 6:response=_context72.sent;if(!response){_context72.next=9;break;}return _context72.abrupt("return",response);case 9:case"end":return _context72.stop();}}},null,this);}}]);return Vessel;}();var Sites=function(){function Sites(botState){_classCallCheck(this,Sites);this['_botState']=botState;this['context']=botState.context;this['userId']=botState.user.userId;this['conversation']=botState.conversation;this['_']=botState._;}_createClass(Sites,[{key:"getBaseParams",value:function getBaseParams(){return{capability:'SitesCapability',capabilityFileName:'sitesCapability',sync:true,userId:this.userId,conversation:this.conversation};}},{key:"getSites",value:function getSites(){var params=this.getBaseParams();params.action='GetUserSites';return this._botState.callCapability(params);}},{key:"searchLocalSites",value:function searchLocalSites(searchTerm,type){var params=this.getBaseParams();params.action='SearchSites';params.searchTerm=searchTerm;params.siteType=type;return this._botState.callCapability(params);}},{key:"searchGlobalSites",value:function searchGlobalSites(searchTerm,type){var searchFields=arguments.length>2&&arguments[2]!==undefined?arguments[2]:['IMO','MMSI'];var params=this.getBaseParams();params.action='SearchGlobalSites';params.searchTerm=searchTerm;params.siteType=type;params.searchFields=searchFields;return this._botState.callCapability(params);}},{key:"deleteSite",value:function deleteSite(site){var params=this.getBaseParams();params.action='DeleteSite';params.siteId=site.siteId;return this._botState.callCapability(params);}},{key:"updateSite",value:function updateSite(site){var params=this.getBaseParams();params.action='UpdateSite';params.site=site;return this._botState.callCapability(params);}},{key:"createSites",value:function createSites(sites,type){var params=this.getBaseParams();params.action='CreateSites';params.sites=sites;params.siteType=type;return this._botState.callCapability(params);}}]);return Sites;}();var Contacts=function(){function Contacts(botState){_classCallCheck(this,Contacts);this['_botState']=botState;this['_']=botState._;if(this._botState.client===State.MOBILECLIENT()){this['contactCapability']=this._botState.context.getCapability('Contact');}}_createClass(Contacts,[{key:"refreshContactsOnEdge",value:function refreshContactsOnEdge(){if(this._botState.client===State.MOBILECLIENT()){this.contactCapability.refreshContacts();}else{this._botState.addSystemErrorToStack(18);}}},{key:"getAllContactsFromEdge",value:function getAllContactsFromEdge(){return this.contactCapability.getAddedContacts().then(function(contactIds){return contactIds;});}},{key:"getAllContactsFromBackend",value:function getAllContactsFromBackend(){var params={capability:'GetContacts',capabilityFileName:'contactsListCapability',userDomain:this._botState.conversation.userDomain,sync:true,userId:this._botState.user.userId,conversation:this._botState.conversation};return this._botState.callCapability(params);}},{key:"syncContacts",value:function syncContacts(usersToSync,userId){var params,lambda,response;return regeneratorRuntime.async(function syncContacts$(_context73){while(1){switch(_context73.prev=_context73.next){case 0:params={userId:userId||this._botState.user.userId,usersToSync:usersToSync};_context73.prev=1;lambda=this._botState.frontmlib;_context73.next=5;return regeneratorRuntime.awrap(lambda.invokeLambda("SyncContacts","RequestResponse",params));case 5:response=_context73.sent;return _context73.abrupt("return",response);case 9:_context73.prev=9;_context73.t0=_context73["catch"](1);this._botState.addSystemErrorToStack(7,"Error in sync contacts");case 12:case"end":return _context73.stop();}}},null,this,[[1,9]]);}}]);return Contacts;}();var File=function(){function File(botState){_classCallCheck(this,File);this['_botState']=botState;this['_']=botState._;var capabilities=botState.context.capabilities.capabilities;var context=null;if(capabilities){context=botState.context.capabilities;}else{context=botState.context;}this['_context']=context;}_createClass(File,[{key:"read",value:function read(){var s3Params={Bucket:envConfig.BOT_LOGO_BUCKET,CopySource:conversationBucket+'/'+conversationId+'/'+fileName,Key:botName.replace(/[^A-Z0-9]+/gi,'_')+'_'+botId+'.'+fileExtension,ACL:'public-read'};return s3.copyObject(s3Params).promise();}},{key:"createQRCode",value:function createQRCode(qrText,qrImageName){var _context74,QRCode,config,env,aws,_s,qrString,base64Data,bucket,_conversationId2,params;return regeneratorRuntime.async(function createQRCode$(_context75){while(1){switch(_context75.prev=_context75.next){case 0:if(qrText){_context75.next=2;break;}throw new Error('qrText is required');case 2:if(!qrImageName){qrImageName=this._botState.getUniqueId()+".png";}_context75.prev=3;_context74=this._context,QRCode=_context74.QRCode,config=_context74.config,env=_context74.env,aws=_context74.aws;_s=new aws.S3();_context75.next=8;return regeneratorRuntime.awrap(QRCode.toDataURL(qrText));case 8:qrString=_context75.sent;base64Data=Buffer.from(qrString.replace(/^data:image\/\w+;base64,/,""),'base64');bucket=config[env].CONVERSATIONS_BUCKET;_conversationId2=this._botState.conversationId;params={Bucket:bucket,Key:_conversationId2+"/"+qrImageName,Body:base64Data,ContentType:'image/png',ContentEncoding:'base64'};this._botState.developer.log({message:'createQRCode',data:{bucket:bucket,conversationId:_conversationId2,qrImageName:qrImageName}});_context75.next=16;return regeneratorRuntime.awrap(_s.upload(params).promise());case 16:return _context75.abrupt("return",qrImageName);case 19:_context75.prev=19;_context75.t0=_context75["catch"](3);throw new Error('Error while creating QR Code'+_context75.t0.message);case 22:case"end":return _context75.stop();}}},null,this,[[3,19]]);}},{key:"generateCsvFileFromMongo",value:function generateCsvFileFromMongo(query,options,conversationId,fileName,withAutoDownload){var startTime,_context76,stream,config,env,frontmlib,aws,moment,headers,headerTitles,collection,limit,sort,projection,skip,stringCSV,headerString,finalProjection,_s2,_moment,finalArr,final,bucket,params,dataSaved;return regeneratorRuntime.async(function generateCsvFileFromMongo$(_context77){while(1){switch(_context77.prev=_context77.next){case 0:if(!(options&&options.headers&&options.headerTitles&&options.collection&&fileName&&conversationId)){_context77.next=41;break;}startTime=Date.now();_context76=this._context,stream=_context76.stream,config=_context76.config,env=_context76.env,frontmlib=_context76.frontmlib,aws=_context76.aws,moment=_context76.moment;headers=options.headers,headerTitles=options.headerTitles,collection=options.collection,limit=options.limit,sort=options.sort,projection=options.projection,skip=options.skip;stringCSV="";headerString=headerTitles.join(',')+'\n';this._botState.developer.log({message:'generateCsvFileFromMongo: Header String Logging',data:{headerString:headerString}});stringCSV=stringCSV+headerString;finalProjection={};headers.map(function(h){finalProjection[h]=1;});collection.document.cache=false;_context77.next=13;return regeneratorRuntime.awrap(collection.loadCollectionWithQuery({query:query||{},projection:finalProjection,sort:sort||{},skip:skip||0,limit:limit||100,collation:{}}));case 13:if(!(collection.rows.length>0)){_context77.next=38;break;}_s2=new aws.S3();_moment=this._botState.moment;finalArr=collection.rows.map(function(row){return headers.map(function(h){var value=void 0;for(var _iterator2=row.fields,_isArray2=Array.isArray(_iterator2),_i4=0,_iterator2=_isArray2?_iterator2:_iterator2[typeof Symbol==="function"?typeof Symbol==="function"?Symbol.iterator:"@@iterator":"@@iterator"]();;){var _ref36;if(_isArray2){if(_i4>=_iterator2.length)break;_ref36=_iterator2[_i4++];}else{_i4=_iterator2.next();if(_i4.done)break;_ref36=_i4.value;}var field=_ref36;if(field.id===h||field.dbName===h){if(field.type===FormFieldTypes.DATETIME()){var dateValue=new Date(field.value);value=!isNaN(dateValue)?_moment(dateValue).format('YYYY/MM/DD hh:mm:ss Z'):" ";}else if(field.type===FormFieldTypes.DATE()){var _dateValue=new Date(field.value);value=!isNaN(_dateValue)?_moment(_dateValue).format('YYYY/MM/DD'):" ";}else if(typeof field.value!=="string"&&typeof field.value!=="undefined")value=field.value.toString();else value=field.value;}}return value||'" "';});});final=finalArr.map(function(e){return e.join(",");}).join("\n");stringCSV=stringCSV+final;this._botState.developer.log({message:'generateCsvFileFromMongo: final csv string before upload',data:{stringCSV:stringCSV}});fileName=fileName||"mongoUpload"+this._botState.UUID()+".csv";bucket=config[env].CONVERSATIONS_BUCKET;params={Bucket:bucket,Key:conversationId+"/"+fileName,Body:stringCSV};if(withAutoDownload){params.ContentDisposition="attachment;filename=\""+fileName+"\"";params.ACL='public-read';}_context77.prev=24;_context77.next=27;return regeneratorRuntime.awrap(_s2.upload(params).promise());case 27:dataSaved=_context77.sent;this._botState.developer.log({message:'generateCsvFileFromMongo: Successfully Uploaded to S3',data:{datafromUpload:dataSaved}});return _context77.abrupt("return",dataSaved);case 32:_context77.prev=32;_context77.t0=_context77["catch"](24);this._botState.developer.log({message:'generateCsvFileFromMongo: Error Uploading to S3',data:{err:_context77.t0}});return _context77.abrupt("return",{error:_context77.t0});case 36:_context77.next=39;break;case 38:this._botState.developer.log({message:'generateCsvFileFromMongo: No Data from MongoDb'});case 39:_context77.next=42;break;case 41:this._botState.developer.log({message:'generateCsvFileFromMongo: Validation failed'});case 42:case"end":return _context77.stop();}}},null,this,[[24,32]]);}},{key:"generateCsvFileFromDynamo",value:function generateCsvFileFromDynamo(query,options,conversationId,fileName){var _this79=this;var startTime,_context78,stream,config,env,frontmlib,aws,moment,s3,headers,specialFields,specialFieldNames,defaultsObj,inStream,bucket,params,uploadPromise,response;return regeneratorRuntime.async(function generateCsvFileFromDynamo$(_context80){while(1){switch(_context80.prev=_context80.next){case 0:startTime=Date.now();_context78=this._context,stream=_context78.stream,config=_context78.config,env=_context78.env,frontmlib=_context78.frontmlib,aws=_context78.aws,moment=_context78.moment;s3=new aws.S3();headers=options.headers,specialFields=options.specialFields;specialFieldNames=Object.keys(options.specialFields||{});defaultsObj=this._(headers).mapKeys().mapValues(function(){return'';}).value();inStream=new stream.Readable({read:function read(){}});bucket=config[env].CONVERSATIONS_BUCKET;params={Bucket:bucket,Key:conversationId+"/"+fileName,Body:inStream};this._botState.developer.log({message:'generateCsvFileFromDynamo',data:{bucket:bucket,conversationId:conversationId,fileName:fileName}});uploadPromise=new Promise(function _callee41(resolve,reject){var headerString,_ref37,Items,LastEvaluatedKey;return regeneratorRuntime.async(function _callee41$(_context79){while(1){switch(_context79.prev=_context79.next){case 0:s3.upload(params,function(err,data){if(err!==null){reject(err);}else{resolve(data);}});headerString='"'+headers.join('","')+'"\n';inStream.push(headerString);_this79._botState.developer.log({message:'generateCsvFileFromDynamo: Wrote header to the csv file'});case 4:_context79.next=6;return regeneratorRuntime.awrap(frontmlib.dbGetWithPagination(query.TableName,query.IndexName,query.KeyConditionExpression,query.FilterExpression,query.ExpressionAttributeValues,query.ExclusiveStartKey||null,query.Fields,query.options));case 6:_ref37=_context79.sent;Items=_ref37.Items;LastEvaluatedKey=_ref37.LastEvaluatedKey;_this79._botState.developer.log({message:'generateCsvFileFromDynamo: got items from dynamo',data:{size:_this79._.size(Items),LastEvaluatedKey:LastEvaluatedKey}});_this79._.map(Items,function(obj){var newObjWithHeaders=_this79._({}).assign(defaultsObj,_this79._.pick(obj,headers)).value();if(specialFieldNames){_this79._.forEach(specialFieldNames,function(headerName){var headerProcessor=specialFields[headerName];var fieldValue=newObjWithHeaders[headerName];if(!_this79._.isNumber(fieldValue)&&_this79._.isEmpty(fieldValue)){return true;}switch(headerProcessor.type){case'dateTime':newObjWithHeaders[headerName]=moment(_this79._.toNumber(fieldValue)).format(headerProcessor.format||'DD/MMMM/YYYY hh:mm a');break;}});}var line=_this79._(newObjWithHeaders).values().join('","');inStream.push("\""+line+"\"\n");});if(!(!LastEvaluatedKey||_.size(Items)===0)){_context79.next=13;break;}return _context79.abrupt("break",15);case 13:query.ExclusiveStartKey=LastEvaluatedKey;case 14:if(query.ExclusiveStartKey!==null){_context79.next=4;break;}case 15:inStream.push(null);inStream.on('end',function(){var totalTime=Date.now()-startTime;_this79._botState.developer.log({message:'generateCsvFileFromDynamo: totalTime to create csv in generateCsvFileFromDynamo:',data:{totalTime:totalTime}});});inStream.on('error',function(data){_this79._botState.developer.log({message:'generateCsvFileFromDynamo: Stream erred',data:data});reject(data);});case 18:case"end":return _context79.stop();}}},null,_this79);});_context80.prev=11;_context80.next=14;return regeneratorRuntime.awrap(uploadPromise);case 14:response=_context80.sent;this._botState.developer.log({message:'generateCsvFileFromDynamo: final response:',data:response});return _context80.abrupt("return",response);case 19:_context80.prev=19;_context80.t0=_context80["catch"](11);case 21:case"end":return _context80.stop();}}},null,this,[[11,19]]);}},{key:"compressVideo",value:function compressVideo(bucket,filename){var _this80=this;var params;return regeneratorRuntime.async(function compressVideo$(_context81){while(1){switch(_context81.prev=_context81.next){case 0:params={'Records':[{'s3':{'bucket':{'name':bucket},'object':{'key':filename}}}]};return _context81.abrupt("return",callLambda('videoConverterLambda',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this80._botState.addSystemErrorToStack(7,error.errorMessage);}));case 2:case"end":return _context81.stop();}}},null,this);}},{key:"validateGeoJSON",value:function validateGeoJSON(bucket,fileName){var _this81=this;var params;return regeneratorRuntime.async(function validateGeoJSON$(_context82){while(1){switch(_context82.prev=_context82.next){case 0:params={bucket:bucket,fileName:fileName};return _context82.abrupt("return",callLambda('geoJSONValidationLambda',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this81._botState.addSystemErrorToStack(7,error.errorMessage);}));case 2:case"end":return _context82.stop();}}},null,this);}}]);return File;}();var Field=function(_Intent17){_inherits(Field,_Intent17);_createClass(Field,null,[{key:"MOVE_FORM_ACTION",value:function MOVE_FORM_ACTION(){return'move';}},{key:"SEARCH_FORM_ACTION",value:function SEARCH_FORM_ACTION(){return'search';}},{key:"CLICK_FORM_ACTION",value:function CLICK_FORM_ACTION(){return'click';}},{key:"FIELD_COMPLETION_FORM_ACTION",value:function FIELD_COMPLETION_FORM_ACTION(){return'completion';}},{key:"FIELD_BUFFER_PREFIX",value:function FIELD_BUFFER_PREFIX(){return'AUTOSAVED_FIELD_';}},{key:"FIELD_LOOKUP_PREFIX",value:function FIELD_LOOKUP_PREFIX(){return'LOOKUP_FIELD_';}},{key:"IsFieldAction",value:function IsFieldAction(action){return action===Field.MOVE_FORM_ACTION()||action===Field.CLICK_FORM_ACTION();}},{key:"createNewDynamicField",value:function createNewDynamicField(field,doc,state){var newField=new Field(field.id,{title:field.title,tabId:field.tabId,type:field.type,doc:doc,botState:state,primaryKey:field.primaryKey,value:field.value,hidden:field.hidden});field.doc=doc.intentId;var f={id:field.id,type:'Field',options:field};state.addDynamicIntent(f);return newField;}},{key:"createNewFieldFromField",value:function createNewFieldFromField(field,doc,suffix){var fieldName=typeof suffix==="undefined"?field.intentId:field.intentId+suffix;var newField=new Field(fieldName,{doc:doc,tabId:field.tabId,primaryKey:field.primaryKey,title:field.title,type:field.type,mandatory:field.mandatory,validation:field.validation,readOnly:field.readOnly,options:field.options,info:field.info,minLength:field.minLength,maxLength:field.maxLength,section:field.section,fileScope:field.fileScope,column:field.column,hidden:field.hidden,quickView:field.quickView,lookup:field.lookup,lookUpCollection:field.lookUpCollection,lookUpFilter:field.lookUpFilter,valueFromLookUp:field.valueFromLookUp,lookUpForeignKey:field.lookUpForeignKey,searchKey:field.searchKey,temp:field.temp,botState:doc._botState,onResponse:field.onResponse,onMessage:field.onMessage,dbName:field.dbName,activeIconUrl:field.activeIconUrl,inactiveIconUrl:field.inactiveIconUrl,routeId:field._routeId});newField._changed=field._changed;return newField;}}]);function Field(intentId,_ref38){var _this83=this;var tabId=_ref38.tabId,doc=_ref38.doc,_ref38$primaryKey=_ref38.primaryKey,primaryKey=_ref38$primaryKey===undefined?false:_ref38$primaryKey,title=_ref38.title,activeIconUrl=_ref38.activeIconUrl,inactiveIconUrl=_ref38.inactiveIconUrl,type=_ref38.type,_ref38$mandatory=_ref38.mandatory,mandatory=_ref38$mandatory===undefined?false:_ref38$mandatory,_ref38$validation=_ref38.validation,validation=_ref38$validation===undefined?false:_ref38$validation,_ref38$readOnly=_ref38.readOnly,readOnly=_ref38$readOnly===undefined?false:_ref38$readOnly,value=_ref38.value,options=_ref38.options,info=_ref38.info,minLength=_ref38.minLength,maxLength=_ref38.maxLength,section=_ref38.section,_ref38$column=_ref38.column,column=_ref38$column===undefined?0:_ref38$column,_ref38$hidden=_ref38.hidden,hidden=_ref38$hidden===undefined?false:_ref38$hidden,_ref38$quickView=_ref38.quickView,quickView=_ref38$quickView===undefined?true:_ref38$quickView,_ref38$lookup=_ref38.lookup,lookup=_ref38$lookup===undefined?false:_ref38$lookup,lookUpCollection=_ref38.lookUpCollection,lookUpFilter=_ref38.lookUpFilter,valueFromLookUp=_ref38.valueFromLookUp,lookUpForeignKey=_ref38.lookUpForeignKey,_ref38$searchKey=_ref38.searchKey,searchKey=_ref38$searchKey===undefined?false:_ref38$searchKey,_ref38$temp=_ref38.temp,temp=_ref38$temp===undefined?false:_ref38$temp,_ref38$includeInQuick=_ref38.includeInQuickEdit,includeInQuickEdit=_ref38$includeInQuick===undefined?false:_ref38$includeInQuick,_ref38$onMessage=_ref38.onMessage,onMessage=_ref38$onMessage===undefined?function(self){}:_ref38$onMessage,_ref38$onResponse=_ref38.onResponse,onResponse=_ref38$onResponse===undefined?function(self){}:_ref38$onResponse,botState=_ref38.botState,_ref38$onlineStatus=_ref38.onlineStatus,onlineStatus=_ref38$onlineStatus===undefined?0:_ref38$onlineStatus,pointType=_ref38.pointType,iconType=_ref38.iconType,routeId=_ref38.routeId,iconColor=_ref38.iconColor,iconUrl=_ref38.iconUrl,fileScope=_ref38.fileScope,_ref38$encrypted=_ref38.encrypted,encrypted=_ref38$encrypted===undefined?false:_ref38$encrypted,dbName=_ref38.dbName;_classCallCheck(this,Field);var _this82=_possibleConstructorReturn(this,(Field.__proto__||Object.getPrototypeOf(Field)).call(this,intentId,botState,tabId));_this82.onMoveOut=function _callee42(){return regeneratorRuntime.async(function _callee42$(_context83){while(1){switch(_context83.prev=_context83.next){case 0:case"end":return _context83.stop();}}},null,_this83);};_this82.onClick=function _callee43(){return regeneratorRuntime.async(function _callee43$(_context84){while(1){switch(_context84.prev=_context84.next){case 0:case"end":return _context84.stop();}}},null,_this83);};_this82.onSearch=function _callee44(){return regeneratorRuntime.async(function _callee44$(_context85){while(1){switch(_context85.prev=_context85.next){case 0:case"end":return _context85.stop();}}},null,_this83);};_this82.onCompletion=function _callee45(){return regeneratorRuntime.async(function _callee45$(_context86){while(1){switch(_context86.prev=_context86.next){case 0:case"end":return _context86.stop();}}},null,_this83);};_this82.onMessage=onMessage;_this82.onResponse=onResponse;if((typeof primaryKey!=='boolean'||!title||!type)&&!lookup&&type!==FormFieldTypes.COLOR_FIELD()){if(doc){doc._botState.addSystemErrorToStack(7,'Field title or type missing on field '+intentId);}return _possibleConstructorReturn(_this82);}_this82.title=title;_this82.type=type;_this82.primaryKey=primaryKey;_this82.mandatory=mandatory;_this82.validation=validation;_this82.readOnly=readOnly;_this82._originalValue=value;_this82.options=options;_this82.info=info;_this82.maxLength=maxLength;_this82.minLength=minLength;_this82.section=section;_this82.column=column;_this82.hidden=hidden;_this82.temp=temp;_this82.lookup=lookup;_this82.onlineStatus=onlineStatus;_this82._changed=false;_this82.fileScope=fileScope;_this82._defaultValue=value;_this82.quickView=quickView;_this82.lookUpCollection=lookUpCollection;_this82.includeInQuickEdit=includeInQuickEdit;_this82.activeIconUrl=activeIconUrl;_this82.inactiveIconUrl=inactiveIconUrl;_this82._encrypted=encrypted;_this82._dbName=dbName;if(lookUpFilter){if(Array.isArray(lookUpFilter)){_this82.lookUpFilter=lookUpFilter;}else{_this82.lookUpFilter=[lookUpFilter];}}if(Array.isArray(lookUpForeignKey)){_this82.lookUpForeignKey=lookUpForeignKey;}else{_this82.lookUpForeignKey=[lookUpForeignKey];}_this82.valueFromLookUp=valueFromLookUp;_this82.formId=doc.intentId;_this82.searchKey=searchKey;_this82._doc=null;_this82._pointType=pointType;_this82._iconType=iconType;_this82._routeId=routeId;_this82._iconColor=iconColor;_this82._iconUrl=iconUrl;_this82.disableHistoryLogging();if(doc){_this82.formId=doc.formId;_this82._doc=doc;_this82._index=doc.addField(_this82);}if(value)_this82.value=value;return _this82;}_createClass(Field,[{key:"message",value:function message(skipOnResponse,withDefault){if(!skipOnResponse){this.onMessage(this);this.onResponse(this);}var _=this._doc._botState._;var v=this.value;var type=this.type;var fileName='';if(typeof this.value==='object'&&_!==null&&_.get(this.value,'fileName')){v=_.get(this.value,'value');fileName=_.get(this.value,'fileName');}if(this.type===FormFieldTypes.COORDINATES()){v=v[0]+", "+v[1];type=FormFieldTypes.TEXT_FIELD();}return{id:this.intentId,tabId:this.tabId,title:this.title,type:type,info:this.info,mandatory:this.mandatory,validation:this.validation,readOnly:this.readOnly,primaryKey:this.primaryKey,value:withDefault?this._defaultValue:v,fileName:fileName,maxLength:this.maxLength,minLength:this.minLength,section:_.get(this.section,'intentId'),column:this.column,options:this.options,search:this.search,hidden:this.hidden,index:this._index,onlineStatus:this.onlineStatus,pointType:this._pointType,iconType:this._iconType,fileScope:this.fileScope,quickView:this.quickView,activeIconUrl:this.activeIconUrl,inactiveIconUrl:this.inactiveIconUrl,routeId:this._routeId,iconColor:this._iconColor,iconUrl:this._iconUrl};}},{key:"shortMessage",value:function shortMessage(skipOnResponse,withDefault){if(!skipOnResponse){this.onMessage(this);this.onResponse(this);}var _=this._doc?this._doc._botState._:null;var v=this.value;var type=this.type;var fileName='';if(typeof this.value==='object'&&_!==null&&_.get(this.value,'fileName')){v=_.get(this.value,'value');fileName=_.get(this.value,'fileName');}if(this.type===FormFieldTypes.COORDINATES()){v=v[0]+", "+v[1];type=FormFieldTypes.TEXT_FIELD();}return[this.intentId,this.tabId,this.title,type,this.info,this.mandatory,this.validation,this.readOnly,this.primaryKey,withDefault?this._defaultValue:v,fileName,this.maxLength,this.minLength,_.get(this.section,'intentId'),this.column,this.options,this.search,this.hidden,this._index,this.onlineStatus,this._pointType,this._iconType,this.fileScope,this.quickView];}},{key:"updateFieldFromMessage",value:function updateFieldFromMessage(message){var _=this._doc?this._doc._botState._:null;if(message&&message.hasOwnProperty("id")&&message.id===this.id&&_!==null){this.tabId=_.get(message,"tabId",this.tabId);this.title=_.get(message,"title",this.title);this.type=_.get(message,"type",this.type);this.info=_.get(message,"info",this.info);this.mandatory=_.get(message,"mandatory",this.mandatory);this.validation=_.get(message,"validation",this.validation);this.readOnly=_.get(message,"readOnly",this.readOnly);this.primaryKey=_.get(message,"primaryKey",this.primaryKey);this.maxLength=_.get(message,"maxLength",this.maxLength);this.minLength=_.get(message,"minLength",this.minLength);this.column=_.get(message,"column",this.column);this.options=_.get(message,"options",this.options);this.search=_.get(message,"search",this.search);this.hidden=_.get(message,"hidden",this.hidden);this._index=_.get(message,"index",this._index);this.onlineStatus=_.get(message,"onlineStatus",this.onlineStatus);this._pointType=_.get(message,"pointType",this._pointType);this._iconType=_.get(message,"iconType",this._iconType);this.fileScope=_.get(message,"fileScope",this.fileScope);this.quickView=_.get(message,"quickView",this.quickView);}}},{key:"getAutoSavePath",value:function getAutoSavePath(tabId,parentDocId){var botState=this.doc._botState;var _=botState._;var D=this._doc._botState.developer;try{var docPath=this.doc.getAutoSavePath(tabId,parentDocId);if(docPath){return docPath+"."+this.id;}}catch(error){botState.addSystemErrorToStack(999,'Error in field getAutoSavePath',this.id);}}},{key:"setAutoSaveFieldValue",value:function setAutoSaveFieldValue(value){var botState=this.doc._botState;var D=botState.developer;if(this.doc.autoSave&&this.doc.docId){var _4=botState._;var path=this.getAutoSavePath();if(!path)return;if(value||value===0){_4.set(this.doc._botState.autoSaveBuffer,path,value);}else{if(_4.get(this.doc._botState.autoSaveBuffer,path)){_4.unset(this.doc._botState.autoSaveBuffer,path);}}if(!this.doc._botState.duringBuild){_4.set(this.doc._botState.autoSaveBufferChanges,path,true);}}}},{key:"getAutoSavedValue",value:function getAutoSavedValue(tabId,parentDocId){var botState=this.doc._botState;if(this.doc.autoSave){var _5=botState._;var path=this.getAutoSavePath(tabId,parentDocId);if(path){var v=_5.get(this.doc._botState.autoSaveBuffer,path);return _5.get(this.doc._botState.autoSaveBuffer,path);}}}},{key:"getAutoSavedValueChanged",value:function getAutoSavedValueChanged(tabId,parentDocId){var botState=this.doc._botState;if(this.doc.autoSave){var _6=botState._;var path=this.getAutoSavePath(tabId,parentDocId);if(path){return _6.get(this.doc._botState.autoSaveBufferChanges,path);}}}},{key:"clearAutoSavedValue",value:function clearAutoSavedValue(){this.setAutoSaveFieldValue();}},{key:"setValueFromAutoSave",value:function setValueFromAutoSave(tabId,parentDocId){var _=this._doc._botState._;var autoSavedValue=this.getAutoSavedValue(tabId,parentDocId);this.value=_.isNil(autoSavedValue)?this.value:autoSavedValue;}},{key:"autoSaveLogic",value:function autoSaveLogic(state,currentFieldValue){var _=this._doc._botState._;var D=this._doc._botState.developer;if(this._doc.autoSave){if(typeof currentFieldValue!=='undefined'&&currentFieldValue!==null){if(typeof currentFieldValue==='object'&&_.size(currentFieldValue)>0&&this.type===FormFieldTypes.LOOKUP()&&this.lookUpCollection){this.value=_.get(currentFieldValue,'text');var lookupArray=state.getField(Field.FIELD_LOOKUP_PREFIX()+this.id);var index=_.findIndex(lookupArray,function(entry){return _.get(entry,'info')===_.get(currentFieldValue,'info');});if(index>-1){var lookUpRecord=_.get(lookupArray[index],'doc');var changedFields=[];_.forEach(this._doc.fields,function(field){if(field.valueFromLookUp){_.forEach(lookUpRecord,function(value,key){if(key===field.valueFromLookUp){field.value=lookUpRecord[key];changedFields.push(field.message(true));}});}});if(changedFields.length>0){if(state.messageTypeFromUser===Collection.TABLE_RESPONSE()){state.addInLineFormChangeResponse(this._doc.message(Doc.FORM_CHANGE_ACTION(),changedFields,null,true,true));}else{state.addFormChangeResponse(this._doc.message(Doc.FORM_CHANGE_ACTION(),changedFields,null,null,true));}}}}else{if(currentFieldValue===''||_.get(currentFieldValue,'text')===''){this.clearAutoSavedValue();}else{this.value=currentFieldValue;}state.storeAutoSaveBuffer();}}}}},{key:"lookupLogic",value:function lookupLogic(state){var _this84=this;var _,D,currentFieldValue,query,and,i,or,orArray,rows,resultsArray,queryResults,results,_results;return regeneratorRuntime.async(function lookupLogic$(_context87){while(1){switch(_context87.prev=_context87.next){case 0:_=state._;D=state.developer;currentFieldValue=_.get(state.messageFromUser,'currentFieldValue',_.get(state.messageFromUser,'content.currentFieldValue'));if(!(currentFieldValue!==''&&this.lookUpCollection)){_context87.next=21;break;}query={};and=[];if(this.lookUpFilter){i=0;_.forEach(this.lookUpFilter,function(filter){var filterValue=filter.tempValue;if(filterValue!==null){var fieldQuery={};fieldQuery[_this84.lookUpForeignKey[i]]=filterValue;and.push(fieldQuery);}i++;});}or={};orArray=[];this.lookUpCollection.document.fields.forEach(function(field){var fieldQuery={};if(field.type===FormFieldTypes.NUMBER_FIELD()){fieldQuery[field.id]=field.value;}else{var regexSearch={};regexSearch['$regex']="^(.*?)"+currentFieldValue;regexSearch['$options']="i";fieldQuery[field.id]=regexSearch;}orArray.push(fieldQuery);});or['$or']=orArray;and.push(or);query['$and']=and;_context87.next=15;return regeneratorRuntime.awrap(this.lookUpCollection.loadCollectionWithQuery({query:query}));case 15:rows=_context87.sent;resultsArray=[];queryResults=[];_.forEach(this.lookUpCollection.rows,function(doc){var text=_this84.valueFromLookUp?doc.document[_this84.valueFromLookUp]:doc.getPrimaryKeyAsStringForSearch(doc.getPrimaryKey());var info=doc.getPrimaryKeyAsStringForSearch(doc.getNonPrimaryKey());var newResultEntry={text:text,info:info!==""?info:null};resultsArray.push(newResultEntry);var resultsToStore=_.cloneDeep(newResultEntry);resultsToStore.doc=doc.document;queryResults.push(resultsToStore);});if(_.get(this.doc,'_botState.messageTypeFromUser')===Collection.TABLE_RESPONSE()){results=this._doc.message(Doc.FORM_SEARCH_RESULTS_ACTION(),{field:this.id,results:resultsArray},null,true,true);state.addInLineFormChangeResponse(results);}else{_results=this._doc.message(Doc.FORM_SEARCH_RESULTS_ACTION(),{field:this.id,results:resultsArray},null,null,true);state.addFormChangeResponse(_results);}state.setField(Field.FIELD_LOOKUP_PREFIX()+this.id,queryResults);case 21:case"end":return _context87.stop();}}},null,this);}},{key:"dbName",get:function get(){return this._dbName;},set:function set(dbName){this._dbName=dbName;}},{key:"encrypted",get:function get(){return this._encrypted;}},{key:"pointType",get:function get(){return this._pointType;},set:function set(pointType){this._pointType=pointType;}},{key:"iconType",get:function get(){return this._iconType;},set:function set(iconType){this._iconType=iconType;}},{key:"routeId",get:function get(){return this._routeId;},set:function set(routeId){this._routeId=routeId;}},{key:"doc",get:function get(){return this._doc;}},{key:"value",get:function get(){var _=this._doc._botState._;if(!_.isArray(this._value)&&typeof this._value==='object'&&_.size(this._value)===0){return;}else{return this._value;}},set:function set(value){var _=this._doc._botState._;var D=this._doc._botState.developer;if(this.type===FormFieldTypes.COORDINATES()&&!Array.isArray(value)){this._doc._botState.addSystemErrorToStack(41);}if(!_.isArray(value)&&typeof value==='object'&&_.size(value)===0)return;var v=value;if(typeof v==='string'&&(this.type===FormFieldTypes.DATE()||this.type===FormFieldTypes.DATETIME())){if(v.substring(0,5)==='#date'){v=parseInt(v.substring(6,19));}else{v=parseInt(v);}}if(this.type===FormFieldTypes.LOOKUP()&&typeof v==='object'&&_.size(v)>1){v=_.get(v,'text');}if(this.type!==FormFieldTypes.COLOR_FIELD()){if(v!==this.tempValue){this._change=true;}this.setAutoSaveFieldValue(v);if(!this.temp){this._doc._document[this._intentId]=v;this._doc._dbDocument[this.dbName||this._intentId]=v;}}this._doc._documentForShortResponse[this._intentId]=v;this._value=v;}},{key:"tempValue",get:function get(){return this.getAutoSavedValue();}},{key:"id",get:function get(){return this.intentId;}},{key:"onMatching",get:function get(){var _this85=this;return function(state){var _=state._;var inputControlId=state.messageFromUser.controlId||state.messageFromUser.formId;return(state.messageTypeFromUser===Doc.FORM_RESPONSE()||state.messageTypeFromUser===Collection.TABLE_RESPONSE()||state.messageTypeFromUser===Container.CONTAINER_RESPONSE())&&state.messageFromUser.currentField===_this85.id&&(inputControlId===_this85.formId||inputControlId===_this85.doc._filteredCollectionName||inputControlId===_this85.doc._collection);};}},{key:"onResolution",get:function get(){var _this86=this;return function _callee46(state){var D,_,currentFieldValue,currentFileValue,docId,tabId,parentDocId;return regeneratorRuntime.async(function _callee46$(_context88){while(1){switch(_context88.prev=_context88.next){case 0:D=state.developer;_=state._;currentFieldValue=_.get(state.messageFromUser,'currentFieldValue',_.get(state.messageFromUser,'content.currentFieldValue'));currentFileValue=_.get(state.messageFromUser,'fileName',_.get(state.messageFromUser,'content.fileName'));if(currentFileValue){currentFieldValue={value:currentFieldValue,fileName:currentFileValue};}if(_this86._doc&&_this86._doc._parent&&_this86._doc._parent._intentId===state.currentControlId){state.currentControlId=_this86._doc._parent._intentId;}else{state.currentControlId=_this86._doc.intentId;}docId=_.get(state.messageFromUser,'docId');if(docId){tabId=_.get(state.messageFromUser,'tabId');parentDocId=_.get(state.messageFromUser,'parentDocId');_this86.doc.loadDocFromAutoSaveBuffer(tabId,docId,parentDocId);}if(!(state.messageFromUser.action===Field.MOVE_FORM_ACTION())){_context88.next=16;break;}state.messageFromUser.oldFieldValue=_this86.tempValue;if(!(currentFieldValue!==state.messageFromUser.oldFieldValue||_this86.type===FormFieldTypes.RADIOBUTTON())){_context88.next=14;break;}_this86.autoSaveLogic(state,currentFieldValue);_context88.next=14;return regeneratorRuntime.awrap(_this86.onMoveOut());case 14:_context88.next=36;break;case 16:if(!(state.messageFromUser.action===Field.CLICK_FORM_ACTION())){_context88.next=22;break;}_this86.autoSaveLogic(state,currentFieldValue);_context88.next=20;return regeneratorRuntime.awrap(_this86.onClick());case 20:_context88.next=36;break;case 22:if(!(state.messageFromUser.action===Field.SEARCH_FORM_ACTION())){_context88.next=29;break;}_context88.next=25;return regeneratorRuntime.awrap(_this86.lookupLogic(state));case 25:_context88.next=27;return regeneratorRuntime.awrap(_this86.onSearch());case 27:_context88.next=36;break;case 29:if(!(state.messageFromUser.action===Field.FIELD_COMPLETION_FORM_ACTION())){_context88.next=35;break;}_this86.autoSaveLogic(state,currentFieldValue);_context88.next=33;return regeneratorRuntime.awrap(_this86.onCompletion());case 33:_context88.next=36;break;case 35:state.addSystemErrorToStack(46,Error.getErrorMessageforCodeAndLang(46));case 36:state.developer.debug({message:'About to leave onResolution'});if(state.responsesArray.length===0){state.addSilentResponse();}case 38:case"end":return _context88.stop();}}},null,_this86);};}},{key:"onResponse",set:function set(onResponse){this._onResponse=onResponse;},get:function get(){return this._onResponse;}}],[{key:"getGenericKeys",value:function getGenericKeys(){return['id','tabId','title','type','info','mandatory','validation','readOnly','primaryKey','value','fileName','maxLength','minLength','section','column','options','search','hidden','index','onlineStatus','pointType','iconType','fileScope','quickView '];}}]);return Field;}(Intent);var Collection=function(_Intent18){_inherits(Collection,_Intent18);_createClass(Collection,null,[{key:"TABLE_RESPONSE",value:function TABLE_RESPONSE(){return'table_response';}},{key:"ON_ACTION",value:function ON_ACTION(){return'onAction';}},{key:"ON_QUICK_ACTION",value:function ON_QUICK_ACTION(){return'quickAction';}},{key:"ON_FIELD_ACTION",value:function ON_FIELD_ACTION(){return'onFieldAction';}},{key:"ON_SELECTION",value:function ON_SELECTION(){return'onSelection';}},{key:"ON_MENU_ACTION",value:function ON_MENU_ACTION(){return'onMenuAction';}},{key:"ON_REFRESH",value:function ON_REFRESH(){return'onRefresh';}},{key:"ON_DOWNLOAD",value:function ON_DOWNLOAD(){return'onDownload';}},{key:"ON_CONFIRM",value:function ON_CONFIRM(){return'onConfirm';}},{key:"ON_DELETE",value:function ON_DELETE(){return'onDelete';}},{key:"ON_SAVE",value:function ON_SAVE(){return'onSave';}},{key:"ON_CLOSE",value:function ON_CLOSE(){return'close';}},{key:"ON_SEARCH",value:function ON_SEARCH(){return'search';}},{key:"ON_PREVIOUS_PAGE",value:function ON_PREVIOUS_PAGE(){return'previousPage';}},{key:"ON_NEXT_PAGE",value:function ON_NEXT_PAGE(){return'nextPage';}},{key:"CLASSIC_TABLE_STYLE",value:function CLASSIC_TABLE_STYLE(){return'table';}},{key:"CALENDAR_TABLE_STYLE",value:function CALENDAR_TABLE_STYLE(){return'calendar';}},{key:"MAP_TABLE_STYLE",value:function MAP_TABLE_STYLE(){return'map';}},{key:"ON_FILTER_ACTION",value:function ON_FILTER_ACTION(){return'filter';}},{key:"ON_EDIT_FILTER_ACTION",value:function ON_EDIT_FILTER_ACTION(){return'editFilter';}},{key:"ON_FILTER_DELETE_ACTION",value:function ON_FILTER_DELETE_ACTION(){return'filterDelete';}},{key:"ON_CREATE_OVERLAY",value:function ON_CREATE_OVERLAY(){return'createOverlay';}},{key:"ON_EDIT_OVERLAY",value:function ON_EDIT_OVERLAY(){return'editOverlay';}},{key:"ON_DELETE_OVERLAY",value:function ON_DELETE_OVERLAY(){return'deleteOverlay';}},{key:"ON_TOP_MENU_ACTION",value:function ON_TOP_MENU_ACTION(){return'topMenu';}},{key:"ON_SHOW_AREAS",value:function ON_SHOW_AREAS(){return'showAreas';}},{key:"FILTER_PREFIX",value:function FILTER_PREFIX(){return'filter_prefix_';}},{key:"ALL_FILTERS",value:function ALL_FILTERS(){return'filter_prefix_all_filters';}},{key:"createNewInstanceFromCollection",value:function createNewInstanceFromCollection(collection,intentId){return new Collection(intentId||collection.intentId,{title:collection.title,description:collection.description,columnNames:collection.columnNames,keys:collection.keys,selectableRows:collection.selectableRows,actionableRows:collection.actionableRows,addNewRows:collection.addNewRows,addNewRowsLabel:collection.addNewRowsLabel,allowMinimize:collection.allowMinimize,allowClose:collection.allowClose,minimizeOnAction:collection.minimizeOnAction,updateInBackground:collection.updateInBackground,promptOnClose:collection.promptOnClose,footer:collection.footer,rowMenu:collection.rowMenu,pages:collection.pages,allowEdit:collection.allowEdit||collection.allowChange,allowDelete:collection.allowDelete,allowDeleteWhileOffline:collection.allowDeleteWhileOffline,allowRefresh:collection.allowRefresh,allowDownload:collection.allowDownload,allowSearch:collection.allowSearch,confirmAction:collection.confirmAction,parentDoc:collection.parentDoc,document:collection._document,modal:collection.modal,style:collection.style,calendarEntry:collection.calendarEntry,activeFilterName:collection._activeFilterName,availableFilters:collection._availableFilters,filterDoc:collection._filterDoc,botState:collection.document._botState,version:collection._version,cache:collection._cache,timeScaleView:collection._timeScaleView,startDate:collection._startDate,activeQueryString:collection._activeQueryString,mapOptions:collection._mapOptions,selectionAction:collection.selectionAction,acceptAttachments:collection.acceptAttachments,topTableMenu:collection.topTableMenu,searchPlaceholder:collection.searchPlaceholder,system:collection._system});}},{key:"ExpandShortTableResponse",value:function ExpandShortTableResponse(shortResponse,botState){var _this88=this;var _,toSyncMessages,collectionId,TEMP_ROWS,collection,newOptions,totalExpectedRows,asyncPages,rowsArr,rows,columnTemplateRefactored,tempRows,newTempRows,preserveFieldDataFields,_loop2,i;return regeneratorRuntime.async(function ExpandShortTableResponse$(_context90){while(1){switch(_context90.prev=_context90.next){case 0:_=botState._;_context90.next=3;return regeneratorRuntime.awrap(botState.deviceStorage.getKeyFromStorage(ALL_CONSTANTS.TO_SYNC_WITH_BACKEND));case 3:toSyncMessages=_context90.sent;collectionId=_.get(shortResponse,'options.controlId');if(!collectionId){_context90.next=48;break;}TEMP_ROWS="TEMP_ROWS";collection=botState._intents[collectionId];newOptions=_.get(shortResponse,'options');totalExpectedRows=_.get(shortResponse,'totalExpectedRows');asyncPages=_.get(shortResponse,'asyncPages');collection.overrideOptions(newOptions);rowsArr=_.get(shortResponse,'rows');rows=[];_.forEach(rowsArr,function(rowArr){var row={};_.forEach(newOptions.keysForShortMessage,function(key,i){if(rowArr[0][i])row[key]=rowArr[0][i];});row.docId=rowArr[1][0];row.allowEdit=rowArr[1][1];row.allowDelete=rowArr[1][2];row.rowMenu=rowArr[1][3];rows.push(row);});columnTemplateRefactored={};_.forEach(newOptions.columnTemplate,function(message){columnTemplateRefactored[message.id]=message;});collection.document._fields.map(function(field){if(columnTemplateRefactored.hasOwnProperty(field.id)){field.updateFieldFromMessage(columnTemplateRefactored[field.id]);}});if(!totalExpectedRows){_context90.next=35;break;}_context90.next=21;return regeneratorRuntime.awrap(botState.deviceStorage.loadDocument(collectionId,TEMP_ROWS));case 21:_context90.t0=_context90.sent;if(_context90.t0){_context90.next=24;break;}_context90.t0=[];case 24:tempRows=_context90.t0;newTempRows=_.union(tempRows,rows);if(!(newTempRows.length<totalExpectedRows)){_context90.next=32;break;}_context90.next=29;return regeneratorRuntime.awrap(botState.deviceStorage.saveDocument(collectionId,TEMP_ROWS,newTempRows));case 29:return _context90.abrupt("return");case 32:rows=newTempRows;_context90.next=35;return regeneratorRuntime.awrap(botState.deviceStorage.deleteDocument(collectionId,TEMP_ROWS));case 35:collection.clearRows();collection.buildRowsFromArray(rows);preserveFieldDataFields=Object.keys(collection._preserveFieldData);collection._rows.map(function(row,rowIdx){preserveFieldDataFields.map(function(field,fieldIdx){collection._preserveFieldData[field].map(function(fieldProp,fieldPropIdx){row.f[field][fieldProp]=rowsArr[rowIdx][2][fieldIdx][fieldPropIdx];});});});_loop2=function _loop2(i){var row,primaryKey,hashedKey,fromStorage,flag;return regeneratorRuntime.async(function _loop2$(_context89){while(1){switch(_context89.prev=_context89.next){case 0:row=collection.rows[i];primaryKey=row.getPrimaryKey();hashedKey=botState.sha1(JSON.stringify(primaryKey));_context89.next=5;return regeneratorRuntime.awrap(botState.deviceStorage.loadDocument(collectionId,hashedKey));case 5:fromStorage=_context89.sent;flag=0;if(fromStorage){flag=1;_.forEach(toSyncMessages,function(document,collection){if(collection===collectionId){var toSyncCollection=botState._intents[collection];_.forEach(document,function(record){var doc=toSyncCollection.document;doc.buildDocument(record);if(_.isEqual(primaryKey,doc.getPrimaryKey())){flag=2;return false;}});return false;}});if(flag!==0){_.forEach(row.fields,function(field){if(field.primaryKey){field.onlineStatus=flag;}});}}case 8:case"end":return _context89.stop();}}},null,_this88);};i=0;case 41:if(!(i<collection.rows.length)){_context90.next=47;break;}_context90.next=44;return regeneratorRuntime.awrap(_loop2(i));case 44:i++;_context90.next=41;break;case 47:return _context90.abrupt("return",collection.message(asyncPages,true));case 48:case"end":return _context90.stop();}}},null,this);}}]);function Collection(intentId,_ref39){var _this89=this;var tabId=_ref39.tabId,name=_ref39.name,title=_ref39.title,description=_ref39.description,_ref39$columnNames=_ref39.columnNames,columnNames=_ref39$columnNames===undefined?[]:_ref39$columnNames,_ref39$keys=_ref39.keys,keys=_ref39$keys===undefined?[]:_ref39$keys,_ref39$selectableRows=_ref39.selectableRows,selectableRows=_ref39$selectableRows===undefined?false:_ref39$selectableRows,_ref39$actionableRows=_ref39.actionableRows,actionableRows=_ref39$actionableRows===undefined?false:_ref39$actionableRows,_ref39$addNewRows=_ref39.addNewRows,addNewRows=_ref39$addNewRows===undefined?false:_ref39$addNewRows,addNewRowsLabel=_ref39.addNewRowsLabel,_ref39$allowMinimize=_ref39.allowMinimize,allowMinimize=_ref39$allowMinimize===undefined?true:_ref39$allowMinimize,_ref39$allowClose=_ref39.allowClose,allowClose=_ref39$allowClose===undefined?true:_ref39$allowClose,_ref39$minimizeOnActi=_ref39.minimizeOnAction,minimizeOnAction=_ref39$minimizeOnActi===undefined?false:_ref39$minimizeOnActi,_ref39$updateInBackgr=_ref39.updateInBackground,updateInBackground=_ref39$updateInBackgr===undefined?false:_ref39$updateInBackgr,_ref39$topTableMenu=_ref39.topTableMenu,topTableMenu=_ref39$topTableMenu===undefined?false:_ref39$topTableMenu,promptOnClose=_ref39.promptOnClose,footer=_ref39.footer,rowMenu=_ref39.rowMenu,pages=_ref39.pages,zone=_ref39.zone,_ref39$allowEdit=_ref39.allowEdit,allowEdit=_ref39$allowEdit===undefined?false:_ref39$allowEdit,_ref39$allowDelete=_ref39.allowDelete,allowDelete=_ref39$allowDelete===undefined?false:_ref39$allowDelete,_ref39$allowDeleteWhi=_ref39.allowDeleteWhileOffline,allowDeleteWhileOffline=_ref39$allowDeleteWhi===undefined?false:_ref39$allowDeleteWhi,_ref39$allowRefresh=_ref39.allowRefresh,allowRefresh=_ref39$allowRefresh===undefined?false:_ref39$allowRefresh,_ref39$allowDownload=_ref39.allowDownload,allowDownload=_ref39$allowDownload===undefined?false:_ref39$allowDownload,_ref39$allowSearch=_ref39.allowSearch,allowSearch=_ref39$allowSearch===undefined?false:_ref39$allowSearch,_ref39$allowQuickActi=_ref39.allowQuickAction,allowQuickAction=_ref39$allowQuickActi===undefined?true:_ref39$allowQuickActi,confirmAction=_ref39.confirmAction,selectionAction=_ref39.selectionAction,parentDoc=_ref39.parentDoc,_ref39$temp=_ref39.temp,temp=_ref39$temp===undefined?false:_ref39$temp,document=_ref39.document,modal=_ref39.modal,style=_ref39.style,calendarEntry=_ref39.calendarEntry,activeFilterName=_ref39.activeFilterName,availableFilters=_ref39.availableFilters,filterDoc=_ref39.filterDoc,botState=_ref39.botState,version=_ref39.version,_ref39$cache=_ref39.cache,cache=_ref39$cache===undefined?true:_ref39$cache,timeScaleView=_ref39.timeScaleView,startDate=_ref39.startDate,activeQueryString=_ref39.activeQueryString,mapOptions=_ref39.mapOptions,acceptAttachments=_ref39.acceptAttachments,_ref39$system=_ref39.system,system=_ref39$system===undefined?false:_ref39$system,searchPlaceholder=_ref39.searchPlaceholder;_classCallCheck(this,Collection);if(!document){var _ret2;return _ret2=null,_possibleConstructorReturn(_this87,_ret2);}var _this87=_possibleConstructorReturn(this,(Collection.__proto__||Object.getPrototypeOf(Collection)).call(this,intentId,botState,tabId));_this87.onAction=function _callee47(){return regeneratorRuntime.async(function _callee47$(_context91){while(1){switch(_context91.prev=_context91.next){case 0:case"end":return _context91.stop();}}},null,_this89);};_this87.onQuickAction=function _callee48(){return regeneratorRuntime.async(function _callee48$(_context92){while(1){switch(_context92.prev=_context92.next){case 0:case"end":return _context92.stop();}}},null,_this89);};_this87.onFieldAction=function _callee49(){return regeneratorRuntime.async(function _callee49$(_context93){while(1){switch(_context93.prev=_context93.next){case 0:case"end":return _context93.stop();}}},null,_this89);};_this87.onSelection=function _callee50(){return regeneratorRuntime.async(function _callee50$(_context94){while(1){switch(_context94.prev=_context94.next){case 0:case"end":return _context94.stop();}}},null,_this89);};_this87.onRefresh=function _callee51(){return regeneratorRuntime.async(function _callee51$(_context95){while(1){switch(_context95.prev=_context95.next){case 0:case"end":return _context95.stop();}}},null,_this89);};_this87.onSearch=function _callee52(){return regeneratorRuntime.async(function _callee52$(_context96){while(1){switch(_context96.prev=_context96.next){case 0:case"end":return _context96.stop();}}},null,_this89);};_this87.onDownload=function _callee53(){return regeneratorRuntime.async(function _callee53$(_context97){while(1){switch(_context97.prev=_context97.next){case 0:case"end":return _context97.stop();}}},null,_this89);};_this87.onConfirm=function _callee54(){return regeneratorRuntime.async(function _callee54$(_context98){while(1){switch(_context98.prev=_context98.next){case 0:case"end":return _context98.stop();}}},null,_this89);};_this87.onTopMenuAction=function _callee55(){return regeneratorRuntime.async(function _callee55$(_context99){while(1){switch(_context99.prev=_context99.next){case 0:case"end":return _context99.stop();}}},null,_this89);};_this87.onDelete=function _callee56(){return regeneratorRuntime.async(function _callee56$(_context100){while(1){switch(_context100.prev=_context100.next){case 0:case"end":return _context100.stop();}}},null,_this89);};_this87.onSave=function _callee57(){return regeneratorRuntime.async(function _callee57$(_context101){while(1){switch(_context101.prev=_context101.next){case 0:case"end":return _context101.stop();}}},null,_this89);};_this87.onClose=function _callee58(){return regeneratorRuntime.async(function _callee58$(_context102){while(1){switch(_context102.prev=_context102.next){case 0:case"end":return _context102.stop();}}},null,_this89);};_this87.onMenuAction=function _callee59(){return regeneratorRuntime.async(function _callee59$(_context103){while(1){switch(_context103.prev=_context103.next){case 0:case"end":return _context103.stop();}}},null,_this89);};_this87.onPreviousPage=function _callee60(){return regeneratorRuntime.async(function _callee60$(_context104){while(1){switch(_context104.prev=_context104.next){case 0:case"end":return _context104.stop();}}},null,_this89);};_this87.onNextPage=function _callee61(){return regeneratorRuntime.async(function _callee61$(_context105){while(1){switch(_context105.prev=_context105.next){case 0:case"end":return _context105.stop();}}},null,_this89);};_this87.onFilter=function _callee62(){return regeneratorRuntime.async(function _callee62$(_context106){while(1){switch(_context106.prev=_context106.next){case 0:case"end":return _context106.stop();}}},null,_this89);};_this87.onFilterDelete=function _callee63(){return regeneratorRuntime.async(function _callee63$(_context107){while(1){switch(_context107.prev=_context107.next){case 0:case"end":return _context107.stop();}}},null,_this89);};_this87.onFilterEdit=function _callee64(){return regeneratorRuntime.async(function _callee64$(_context108){while(1){switch(_context108.prev=_context108.next){case 0:case"end":return _context108.stop();}}},null,_this89);};_this87.onRenameFilter=function _callee65(){return regeneratorRuntime.async(function _callee65$(_context109){while(1){switch(_context109.prev=_context109.next){case 0:case"end":return _context109.stop();}}},null,_this89);};_this87.onMultipleSelection=function _callee66(){return regeneratorRuntime.async(function _callee66$(_context110){while(1){switch(_context110.prev=_context110.next){case 0:case"end":return _context110.stop();}}},null,_this89);};_this87.onDiscard=function _callee67(){return regeneratorRuntime.async(function _callee67$(_context111){while(1){switch(_context111.prev=_context111.next){case 0:case"end":return _context111.stop();}}},null,_this89);};_this87.onClearFilter=function _callee68(){return regeneratorRuntime.async(function _callee68$(_context112){while(1){switch(_context112.prev=_context112.next){case 0:case"end":return _context112.stop();}}},null,_this89);};_this87.onClearSearch=function _callee69(){return regeneratorRuntime.async(function _callee69$(_context113){while(1){switch(_context113.prev=_context113.next){case 0:case"end":return _context113.stop();}}},null,_this89);};_this87.onCreateOverlay=function _callee70(){return regeneratorRuntime.async(function _callee70$(_context114){while(1){switch(_context114.prev=_context114.next){case 0:case"end":return _context114.stop();}}},null,_this89);};_this87.onEditOverlay=function _callee71(){return regeneratorRuntime.async(function _callee71$(_context115){while(1){switch(_context115.prev=_context115.next){case 0:case"end":return _context115.stop();}}},null,_this89);};_this87.onDeleteOverlay=function _callee72(){return regeneratorRuntime.async(function _callee72$(_context116){while(1){switch(_context116.prev=_context116.next){case 0:case"end":return _context116.stop();}}},null,_this89);};_this87.onShowAreas=function _callee73(){return regeneratorRuntime.async(function _callee73$(_context117){while(1){switch(_context117.prev=_context117.next){case 0:case"end":return _context117.stop();}}},null,_this89);};_this87.title=title;_this87.description=description;_this87.columnNames=columnNames;_this87.keys=keys;_this87.selectableRows=selectableRows;_this87.actionableRows=actionableRows;_this87.addNewRows=addNewRows;_this87.addNewRowsLabel=addNewRowsLabel;_this87.allowMinimize=allowMinimize;_this87.allowClose=allowClose;_this87.allowSearch=allowSearch;_this87.minimizeOnAction=minimizeOnAction;_this87.updateInBackground=updateInBackground;_this87.promptOnClose=promptOnClose;_this87.style=style;_this87.calendarEntry=calendarEntry;_this87.footer=footer;_this87.rowMenu=rowMenu;_this87.pages=pages;_this87.zone=zone;_this87.modal=modal;_this87.allowChange=allowEdit;_this87.allowEdit=allowEdit;_this87.allowDelete=allowDelete;_this87.allowDeleteWhileOffline=allowDeleteWhileOffline;_this87.allowRefresh=allowRefresh;_this87.allowDownload=allowDownload;_this87.confirmAction=confirmAction;_this87._activeFilterName=activeFilterName;_this87._availableFilters=availableFilters;_this87._filteredColumns=[];_this87._version=version;_this87._columns=[];_this87._action=null;_this87._activeQueryString=activeQueryString;_this87._columnTemplate=[];_this87._preserveFieldData={};_this87._mapOptions=mapOptions;_this87.selectionAction=selectionAction;_this87._keysForShortMessage=[];_this87.allowQuickAction=allowQuickAction;_this87.acceptAttachments=acceptAttachments;_this87.parentDocId=_this87.intentId;_this87.topTableMenu=topTableMenu;_this87.searchPlaceholder=searchPlaceholder;if(style===Collection.CALENDAR_TABLE_STYLE()){_this87._timeScaleView=timeScaleView;_this87._startDate=startDate;}_this87._name=name||intentId;_this87._botState=document._botState;_this87._=document._botState._;_this87._rows=[];_this87._document=document;_this87.documentId=document.intentId;_this87._cache=cache;_this87._system=system;_this87.temp=temp;if(_this87._document){_this87._botState=_this87._document._botState;}_this87._subCollection=false;_this87.filterDoc=filterDoc;if(parentDoc){if(parentDoc instanceof Doc){_this87._subCollection=true;_this87._parentDoc=parentDoc;parentDoc.addChildDoc(_this87);}else{_this87._botState.addSystemErrorToStack(7,"Sub documents cannot be saved "+_this87._intentId);}}var _=document._botState._;if(_this87.addNewRows){_this87.newRowFieldsOptions=_.get(document.message(true),'fields');}_this87._document.setCollection(_this87);return _this87;}_createClass(Collection,[{key:"overrideOptions",value:function overrideOptions(newOptions){var _=this._;this.tabId=newOptions.tabId;this.title=_.get(newOptions,'title');this.columnNames=_.get(newOptions,'columnNames');this._columns=_.get(newOptions,'columns');this._filteredColumns=newOptions.filteredColumns;this.keys=newOptions.keys;this.selectableRows=newOptions.selectableRows;this.actionableRows=newOptions.actionableRows;this.addNewRows=newOptions.addNewRows;this.addNewRowsLabel=newOptions.addNewRowsLabel;this.allowMinimize=newOptions.allowMinimize;this.allowClose=newOptions.allowClose;this.minimizeOnAction=newOptions.minimizeOnAction;this.updateInBackground=newOptions.updateInBackground;this.promptOnClose=newOptions.promptOnClose;this.footer=newOptions.footer;this.rowMenu=newOptions.rowMenu;this.pages=newOptions.pages;this.zone=newOptions.zone;this.modal=newOptions.modal;this.allowChange=newOptions.allowChange;this.allowEdit=newOptions.allowEdit;this.allowDelete=newOptions.allowDelete;this.allowDeleteWhileOffline=newOptions.allowDeleteWhileOffline;this.allowRefresh=newOptions.allowRefresh;this.allowDownload=newOptions.allowDownload;this.confirmAction=newOptions.confirmAction;this.allowSearch=newOptions.allowSearch;this.allowQuickAction=newOptions.allowQuickAction;this.style=newOptions.style;this.calendarEntry=newOptions.calendarEntry;this._activeFilterName=newOptions.activeFilterName;this._availableFilters=newOptions.availableFilters;this._filterActive=newOptions.filterActive;this.newRowFieldsOptions=newOptions.newRowFieldsOptions;this._timeScaleView=newOptions.timeScaleView;this._startDate=newOptions.startDate;this._activeQueryString=newOptions.activeQueryString;this._columnTemplate=newOptions.columnTemplate;this._preserveFieldData=newOptions.preserveFieldData;this._mapOptions=newOptions.mapOptions;this._keysForShortMessage=newOptions.keysForShortMessage;this.parentDocId=newOptions.parentDocId;this.acceptAttachments=newOptions.acceptAttachments;if(this._botState){if(!newOptions.parent){delete this._parent;}else{this._parent=this._botState.intents[newOptions.parent];}}this.selectionAction=_.get(newOptions,'selectionAction');this.topTableMenu=_.get(newOptions,'topTableMenu');}},{key:"sendResponse",value:function sendResponse(skipOnResponse){this._botState.addTableResponse(this.message(false,skipOnResponse));}},{key:"generateTableColumnLabels",value:function generateTableColumnLabels(){var _this90=this;var _=this._botState._;var tableRowLabels=[];var columnNamesObject={};_.forEach(this._document.fields,function(field){if(!field.hidden){if(field.type===FormFieldTypes.FILE_FIELD()){if(_this90._version===1){tableRowLabels.push(field.title+"_attachment");}else{columnNamesObject[field.id]=field.title;}}else{if(_this90._version===1){tableRowLabels.push(field.title);}else{columnNamesObject[field.id]=field.title;}}}});if(this._version===1){return tableRowLabels;}else{return columnNamesObject;}}},{key:"generateTableColumnTemplate",value:function generateTableColumnTemplate(){var _=this._botState._;var columnNamesObject=[];_.forEach(this._document.fields,function(field){columnNamesObject.push(field.message(true,true));});return columnNamesObject;}},{key:"generateTableKeyLabels",value:function generateTableKeyLabels(){var _=this._botState._;var tableRowKeyLabels=[];_.forEach(this._document.fields,function(field){if(field.primaryKey){tableRowKeyLabels.push(field.title);}});return tableRowKeyLabels;}},{key:"generateKeysForShortMessage",value:function generateKeysForShortMessage(){var _=this._botState._;var tableRowKey=[];_.forEach(this._document.fields,function(field){tableRowKey.push(field.id);});return tableRowKey;}},{key:"generateTableRows",value:function generateTableRows(skipOnResponse){var _this91=this;var _=this._botState._;var D=this._botState.developer;var tableRows=[];_.forEach(this._rows,function(row){var doc=row.document;var tableRow={};if(_this91._version===2){tableRow=_.get(row.message(null,null,null,null,skipOnResponse),'fields');}else if(_this91._version===3){var rowMessage=row.message(null,null,null,null,skipOnResponse);var rowOptions={};if(row.allowEdit===false){rowOptions.allowEdit=false;}if(row.allowDelete===false){rowOptions.allowDelete=false;}rowOptions.rowMenu=row.rowMenu;tableRow[row.docId]={fields:_.get(rowMessage,'fields'),rowOptions:rowOptions};}else{_.forEach(row.fields,function(field){if(field)field.onMessage(skipOnResponse);if(field.primaryKey||!field.hidden){if(field.type===FormFieldTypes.DATE()||field.type===FormFieldTypes.DATETIME()){tableRow[field.title]="#date("+field.value+")";}else{tableRow[field.title]=field.value;}}});}tableRows.push(tableRow);});return tableRows;}},{key:"setFilterColumns",value:function setFilterColumns(){var _=this._;if(this._filterDoc&&this._filteredColumns.length===0){var columns=[];this._.forEach(this._filterDoc.fields,function(field){if(!field.hidden){var fieldDetails=field.message();if(fieldDetails)columns.push(fieldDetails);}});this._filteredColumns=columns;}}},{key:"prepareCollectionOptions",value:function prepareCollectionOptions(){var preserveFieldData=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(!this.allowChange&&!this.allowEdit&&!this.addNewRows&&!this.allowDelete&&!this._parentDoc){this._document._autoSave=false;}this.setFilterColumns();this.columnNames=this.generateTableColumnLabels();this._columnTemplate=this.generateTableColumnTemplate();this._keysForShortMessage=this.generateKeysForShortMessage();this._preserveFieldData=preserveFieldData;if(this._version===2){this.keys=[];}else{this.keys=this.generateTableKeyLabels();}}},{key:"getRowsForShortResponse",value:function getRowsForShortResponse(){var _this92=this;var preserveFieldData=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var _=this._;this.message(undefined,undefined,preserveFieldData);var rowsResponseDelta=[];_.forEach(this._rows,function(row){var shortArr=[];_.forEach(_this92._keysForShortMessage,function(key){shortArr.push(row._documentForShortResponse[key]);});var preservedFields=[];_.forEach(Object.keys(preserveFieldData),function(field){var preservedFieldsArr=[];_.forEach(preserveFieldData[field],function(fieldKey){preservedFieldsArr.push(row.f[field][fieldKey]);});preservedFields.push(preservedFieldsArr);});rowsResponseDelta.push([shortArr,[row.docId,row.allowEdit,row.allowDelete,row.rowMenu],preservedFields]);});return rowsResponseDelta;}},{key:"sendShortResponse",value:function sendShortResponse(asyncPages,totalExpectedRows){var preserveFieldData=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var _=this._;this.prepareCollectionOptions(preserveFieldData);this._botState.addShortTableResponse({options:this.options,asyncPages:asyncPages,totalExpectedRows:totalExpectedRows,rows:this.getRowsForShortResponse(preserveFieldData)});}},{key:"message",value:function message(asyncPages,skipOnResponse){var preserveFieldData=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var _=this._botState._;this.prepareCollectionOptions(preserveFieldData);if(asyncPages){this._action=ALL_CONSTANTS.TABLES.CHANGE_ACTION;return{rows:{append:this.generateTableRows(skipOnResponse)},options:this.options};}else{return{rows:this.generateTableRows(skipOnResponse),options:this.options};}}},{key:"sendEditFilterResponse",value:function sendEditFilterResponse(){var D=this._botState.developer;this._action=ALL_CONSTANTS.TABLES.CHANGE_FILTER_ACTION;this.setFilterColumns();this._botState.addTableResponse({rows:[],options:this.options});}},{key:"sendFilterChangeResponse",value:function sendFilterChangeResponse(action,results){var D=this._botState.developer;this._action=action;this._filteredColumns=results;this._botState.addTableResponse({rows:[],options:this.options});}},{key:"getFilterCriteriaWithName",value:function getFilterCriteriaWithName(name){return this._botState.getField(Collection.FILTER_PREFIX()+name);}},{key:"addRow",value:function addRow(row){row.index=this._rows.length;this._rows.push(row);}},{key:"clearRows",value:function clearRows(){this._rows=[];}},{key:"rowAsDocumentsArray",value:function rowAsDocumentsArray(){var _=this._botState._;var resultsArray=[];_.forEach(this.rows,function(row){resultsArray.push(row.document);});return resultsArray;}},{key:"buildRowsFromArray",value:function buildRowsFromArray(rows){var _this93=this;var _=this._botState._;if(_.isArray(rows)){this.clearRows();var _i5=0;rows.forEach(function(row){var newDoc=Doc.createNewInstanceFromDoc(_this93._document);_this93.addRow(newDoc);if(newDoc.hasSubDocs){newDoc.buildDocumentFromContainer(row,true);}else{newDoc.buildDocument(row,true);}_i5++;});}}},{key:"buildRowsFromUserMessage",value:function buildRowsFromUserMessage(tabId,messageFromUser,state){var D=state.developer;D.log({message:"messageFromUser building table",data:messageFromUser});this._botState.duringBuild=true;this._botState._.unset(this._botState.autoSaveBuffer,this.getAutoSavePath(tabId));this.buildRowsFromArray(messageFromUser.rows);this._botState.duringBuild=false;}},{key:"getAutoSavePath",value:function getAutoSavePath(tabId,parentDocId){var botState=this.document._botState;try{var _7=botState._;var _D4=botState.developer;var tabIdToLoad=tabId||botState.currentTabId||this.document.tabId;if(this._parentDoc){var docPath=this._parentDoc.getAutoSavePath(tabIdToLoad,parentDocId);return docPath+"."+this.intentId;}else{return tabIdToLoad+"."+this.intentId;}}catch(error){botState.addSystemErrorToStack(999,error.message,this.intentId);}}},{key:"loadRowsFromAutoSaveBuffer",value:function loadRowsFromAutoSaveBuffer(tabId){var _this94=this;var botState=this.document._botState;var _=botState._;var D=botState.developer;var path=this.getAutoSavePath(tabId);var autoSavedRows=_.get(botState.autoSaveBuffer,path);_.forEach(autoSavedRows,function(autoSavedRow){var newRow=Doc.createNewInstanceFromDoc(_this94.document);_this94.addRow(newRow);if(_this94.document._subDocs){newRow.buildDocumentFromContainer(autoSavedRow);}else{newRow.buildDocument(autoSavedRow);}});}},{key:"generateAutoSaveBufferFromCollection",value:function generateAutoSaveBufferFromCollection(){this._rows.forEach(function(row){row.generateAutoSaveBufferFromDoc();});}},{key:"clearAutoSaveBuffer",value:function clearAutoSaveBuffer(tabId){var botState=this.document._botState;var _=botState._;var path=this.getAutoSavePath(tabId);_.unset(botState.autoSaveBuffer,path);}},{key:"clearAutoSaveBufferChanges",value:function clearAutoSaveBufferChanges(tabId){var botState=this.document._botState;var _=botState._;var path=this.getAutoSavePath(tabId);_.unset(botState.autoSaveBufferChanges,path);}},{key:"buildTheDocsFromPayload",value:function buildTheDocsFromPayload(payload){var _this95=this;var _,D,online,_ret4;return regeneratorRuntime.async(function buildTheDocsFromPayload$(_context120){while(1){switch(_context120.prev=_context120.next){case 0:_=this._botState._;D=this._botState.developer;_context120.next=4;return regeneratorRuntime.awrap(this._botState.online());case 4:online=_context120.sent;if(!(Array.isArray(payload)&&payload.length>0)){_context120.next=13;break;}_context120.next=8;return regeneratorRuntime.awrap(function _callee74(){var allDocs,allKeys,_loop3,_i6;return regeneratorRuntime.async(function _callee74$(_context119){while(1){switch(_context119.prev=_context119.next){case 0:allDocs=[];_this95._rows=[];allKeys={};if(!_this95.allowChange&&!_this95.allowEdit&&!_this95.addNewRows&&!_this95.allowDelete){_this95._document._autoSave=false;}_loop3=function _loop3(_i6){var document,docClone,addDocClone,primaryKey,fromStorage;return regeneratorRuntime.async(function _loop3$(_context118){while(1){switch(_context118.prev=_context118.next){case 0:document=payload[_i6];docClone=Doc.createNewInstanceFromDoc(_this95._document);allDocs.push(document);if(_this95._document.hasSubDocs){docClone.buildDocumentFromContainer(document);}else{docClone.buildDocument(document);}_context118.next=6;return regeneratorRuntime.awrap(docClone.onPostLoad(docClone));case 6:addDocClone=function addDocClone(primaryKey){if(!allKeys[primaryKey]){_this95.addRow(docClone);allKeys[primaryKey]=true;}};primaryKey=_this95.document._botState.sha1(JSON.stringify(docClone.getPrimaryKey()));if(!online){_context118.next=12;break;}addDocClone(primaryKey);_context118.next=16;break;case 12:_context118.next=14;return regeneratorRuntime.awrap(_this95._botState.deviceStorage.loadDocument(_this95.intentId,primaryKey));case 14:fromStorage=_context118.sent;if(fromStorage){addDocClone(primaryKey);}case 16:case"end":return _context118.stop();}}},null,_this95);};_i6=0;case 6:if(!(_i6<payload.length)){_context119.next=12;break;}_context119.next=9;return regeneratorRuntime.awrap(_loop3(_i6));case 9:_i6++;_context119.next=6;break;case 12:return _context119.abrupt("return",{v:allDocs});case 13:case"end":return _context119.stop();}}},null,_this95);}());case 8:_ret4=_context120.sent;if(!(typeof _ret4==="object")){_context120.next=11;break;}return _context120.abrupt("return",_ret4.v);case 11:_context120.next=13;break;case 13:case"end":return _context120.stop();}}},null,this);}},{key:"loadCollectionWithQuery",value:function loadCollectionWithQuery(_ref40){var _ref40$action=_ref40.action,action=_ref40$action===undefined?'query':_ref40$action,_ref40$query=_ref40.query,query=_ref40$query===undefined?{}:_ref40$query,_ref40$projection=_ref40.projection,projection=_ref40$projection===undefined?{}:_ref40$projection,_ref40$sort=_ref40.sort,sort=_ref40$sort===undefined?{}:_ref40$sort,_ref40$skip=_ref40.skip,skip=_ref40$skip===undefined?0:_ref40$skip,_ref40$limit=_ref40.limit,limit=_ref40$limit===undefined?20:_ref40$limit,_ref40$collation=_ref40.collation,collation=_ref40$collation===undefined?{}:_ref40$collation;var _,D,results,payload;return regeneratorRuntime.async(function loadCollectionWithQuery$(_context121){while(1){switch(_context121.prev=_context121.next){case 0:if(!this._subCollection){_context121.next=3;break;}this._botState.addErrorToStack(7,'We cannot retrieve data from subCollections');return _context121.abrupt("return");case 3:_=this._botState._;D=this._botState.developer;_context121.next=7;return regeneratorRuntime.awrap(this._botState.db.getDataFromCollection({collection:this._name,action:action,query:query,projection:projection,sort:sort,skip:skip,limit:limit,collation:collation,system:this._system,cache:this._cache,securedFields:this.document.getSecuredFieldsArray()}));case 7:results=_context121.sent;if(!(results.statusCode===200)){_context121.next=11;break;}payload=results.body;return _context121.abrupt("return",this.buildTheDocsFromPayload(payload));case 11:case"end":return _context121.stop();}}},null,this);}},{key:"countCollectionWithQuery",value:function countCollectionWithQuery(_ref41){var _ref41$query=_ref41.query,query=_ref41$query===undefined?{}:_ref41$query,_ref41$projection=_ref41.projection,projection=_ref41$projection===undefined?{}:_ref41$projection,_ref41$collation=_ref41.collation,collation=_ref41$collation===undefined?{}:_ref41$collation;var results,payload;return regeneratorRuntime.async(function countCollectionWithQuery$(_context122){while(1){switch(_context122.prev=_context122.next){case 0:_context122.next=2;return regeneratorRuntime.awrap(this._botState.db.countDataFromCollection({collection:this._name,query:query,projection:projection,collation:collation}));case 2:results=_context122.sent;if(!(results.statusCode===200)){_context122.next=6;break;}payload=results.body;return _context122.abrupt("return",payload);case 6:case"end":return _context122.stop();}}},null,this);}},{key:"loadCollectionFromIndex",value:function loadCollectionFromIndex(queryObject,index){var _,D,payload;return regeneratorRuntime.async(function loadCollectionFromIndex$(_context123){while(1){switch(_context123.prev=_context123.next){case 0:_=this._botState._;D=this._botState.developer;if(!index)index=this.intentId;_context123.next=5;return regeneratorRuntime.awrap(this._botState.db.getDataFromIndexWithQueryObject(index,queryObject));case 5:payload=_context123.sent;D.log({message:'Results from ES query',data:payload});if(!(_.get(payload,"errorMessage")||_.get(payload,"error"))){_context123.next=11;break;}return _context123.abrupt("return");case 11:return _context123.abrupt("return",this.buildTheDocsFromPayload(payload));case 12:case"end":return _context123.stop();}}},null,this);}},{key:"getQueryForSearch",value:function getQueryForSearch(queryString){var _=this._botState._;var query={};var OR='$or';query[OR]=[];_.forEach(this._document.fields,function(field){if(field.searchKey||field.primaryKey){var fieldQuery={};if(field.type===FormFieldTypes.NUMBER_FIELD()){fieldQuery[field.dbName||field.id]=parseInt(queryString,10);}else{var regexSearch={};regexSearch['$regex']="^(.*?)"+queryString;regexSearch['$options']="i";fieldQuery[field.dbName||field.id]=regexSearch;}if(_.size(fieldQuery)>0){query[OR].push(fieldQuery);}}});return query;}},{key:"insertRow",value:function insertRow(i,row){this._rows.splice(i,0,row);}},{key:"_callEvents",value:function _callEvents(state){return regeneratorRuntime.async(function _callEvents$(_context124){while(1){switch(_context124.prev=_context124.next){case 0:if(this._parent&&this._parent._intentId===state.currentControlId){state.currentControlId=this._parent._intentId;}else{state.currentControlId=this.intentId;}if(!(state.messageFromUser.action===Collection.ON_ACTION())){_context124.next=6;break;}_context124.next=4;return regeneratorRuntime.awrap(this.onAction());case 4:_context124.next=137;break;case 6:if(!(state.messageFromUser.action===Collection.ON_QUICK_ACTION())){_context124.next=11;break;}_context124.next=9;return regeneratorRuntime.awrap(this.onQuickAction());case 9:_context124.next=137;break;case 11:if(!(state.messageFromUser.action===Collection.ON_SELECTION())){_context124.next=16;break;}_context124.next=14;return regeneratorRuntime.awrap(this.onSelection());case 14:_context124.next=137;break;case 16:if(!(state.messageFromUser.action===Collection.ON_SAVE())){_context124.next=21;break;}_context124.next=19;return regeneratorRuntime.awrap(this.onSave());case 19:_context124.next=137;break;case 21:if(!(state.messageFromUser.action===ALL_CONSTANTS.ACTIONS.DISCARD)){_context124.next=26;break;}_context124.next=24;return regeneratorRuntime.awrap(this.onDiscard());case 24:_context124.next=137;break;case 26:if(!(state.messageFromUser.action===Collection.ON_CLOSE())){_context124.next=31;break;}_context124.next=29;return regeneratorRuntime.awrap(this.onClose());case 29:_context124.next=137;break;case 31:if(!(state.messageFromUser.action===Collection.ON_SEARCH())){_context124.next=36;break;}_context124.next=34;return regeneratorRuntime.awrap(this.onSearch());case 34:_context124.next=137;break;case 36:if(!(state.messageFromUser.action===Collection.ON_MENU_ACTION())){_context124.next=41;break;}_context124.next=39;return regeneratorRuntime.awrap(this.onMenuAction());case 39:_context124.next=137;break;case 41:if(!(state.messageFromUser.action===Collection.ON_FIELD_ACTION())){_context124.next=46;break;}_context124.next=44;return regeneratorRuntime.awrap(this.onFieldAction());case 44:_context124.next=137;break;case 46:if(!(state.messageFromUser.action===Collection.ON_REFRESH())){_context124.next=51;break;}_context124.next=49;return regeneratorRuntime.awrap(this.onRefresh());case 49:_context124.next=137;break;case 51:if(!(state.messageFromUser.action===Collection.ON_DOWNLOAD())){_context124.next=56;break;}_context124.next=54;return regeneratorRuntime.awrap(this.onDownload());case 54:_context124.next=137;break;case 56:if(!(state.messageFromUser.action===Collection.ON_CONFIRM())){_context124.next=61;break;}_context124.next=59;return regeneratorRuntime.awrap(this.onConfirm());case 59:_context124.next=137;break;case 61:if(!(state.messageFromUser.action===Collection.ON_DELETE())){_context124.next=66;break;}_context124.next=64;return regeneratorRuntime.awrap(this.onDelete());case 64:_context124.next=137;break;case 66:if(!(state.messageFromUser.action===Collection.ON_PREVIOUS_PAGE())){_context124.next=71;break;}_context124.next=69;return regeneratorRuntime.awrap(this.onPreviousPage());case 69:_context124.next=137;break;case 71:if(!(state.messageFromUser.action===Collection.ON_NEXT_PAGE())){_context124.next=76;break;}_context124.next=74;return regeneratorRuntime.awrap(this.onNextPage());case 74:_context124.next=137;break;case 76:if(!(state.messageFromUser.action===Collection.ON_FILTER_ACTION())){_context124.next=81;break;}_context124.next=79;return regeneratorRuntime.awrap(this.onFilter());case 79:_context124.next=137;break;case 81:if(!(state.messageFromUser.action===Collection.ON_FILTER_DELETE_ACTION())){_context124.next=86;break;}_context124.next=84;return regeneratorRuntime.awrap(this.onFilterDelete());case 84:_context124.next=137;break;case 86:if(!(state.messageFromUser.action===Collection.ON_EDIT_FILTER_ACTION())){_context124.next=91;break;}_context124.next=89;return regeneratorRuntime.awrap(this.onFilterEdit());case 89:_context124.next=137;break;case 91:if(!(state.messageFromUser.action===ALL_CONSTANTS.TABLES.MULTIPLE_SELECTION_ACTION)){_context124.next=96;break;}_context124.next=94;return regeneratorRuntime.awrap(this.onMultipleSelection());case 94:_context124.next=137;break;case 96:if(!(state.messageFromUser.action===ALL_CONSTANTS.TABLES.RENAME_FILTER_ACTION)){_context124.next=101;break;}_context124.next=99;return regeneratorRuntime.awrap(this.onRenameFilter());case 99:_context124.next=137;break;case 101:if(!(state.messageFromUser.action===ALL_CONSTANTS.TABLES.CLEAR_FILTER_ACTION)){_context124.next=106;break;}_context124.next=104;return regeneratorRuntime.awrap(this.onClearFilter());case 104:_context124.next=137;break;case 106:if(!(state.messageFromUser.action===ALL_CONSTANTS.TABLES.CLEAR_SEARCH_ACTION)){_context124.next=111;break;}_context124.next=109;return regeneratorRuntime.awrap(this.onClearSearch());case 109:_context124.next=137;break;case 111:if(!(state.messageFromUser.action===Collection.ON_CREATE_OVERLAY())){_context124.next=116;break;}_context124.next=114;return regeneratorRuntime.awrap(this.onCreateOverlay());case 114:_context124.next=137;break;case 116:if(!(state.messageFromUser.action===Collection.ON_EDIT_OVERLAY())){_context124.next=121;break;}_context124.next=119;return regeneratorRuntime.awrap(this.onEditOverlay());case 119:_context124.next=137;break;case 121:if(!(state.messageFromUser.action===Collection.ON_DELETE_OVERLAY())){_context124.next=126;break;}_context124.next=124;return regeneratorRuntime.awrap(this.onDeleteOverlay());case 124:_context124.next=137;break;case 126:if(!(state.messageFromUser.action===Collection.ON_SHOW_AREAS())){_context124.next=131;break;}_context124.next=129;return regeneratorRuntime.awrap(this.onShowAreas());case 129:_context124.next=137;break;case 131:if(!(state.messageFromUser.action===Collection.ON_TOP_MENU_ACTION())){_context124.next=136;break;}_context124.next=134;return regeneratorRuntime.awrap(this.onTopMenuAction());case 134:_context124.next=137;break;case 136:state.addSystemErrorToStack(28,Error.getErrorMessageforCodeAndLang(28));case 137:if(state.responsesArray.length===0){state.addSilentResponse();}case 138:case"end":return _context124.stop();}}},null,this);}},{key:"options",get:function get(){var parent=null;if(this._parent){parent=this._parent._intentId;}var parentDocId=void 0;if(this._botState){parentDocId=this._botState._.get(this._botState,'messageFromUser.parentDocId')||this.parentDocId;}return{parent:parent,tableId:this.intentId,controlId:this.intentId,documentId:this.documentId,action:this._action,tabId:this.tabId,title:this.title,description:this.description,columnNames:this.columnNames,columns:this._columns,filteredColumns:this._filteredColumns,keys:this.keys,selectableRows:this.selectableRows,actionableRows:this.actionableRows,addNewRows:this.addNewRows,addNewRowsLabel:this.addNewRowsLabel,allowMinimize:this.allowMinimize,allowClose:this.allowClose,minimizeOnAction:this.minimizeOnAction,updateInBackground:this.updateInBackground,promptOnClose:this.promptOnClose,footer:this.footer,rowMenu:this.rowMenu,pages:this.pages,zone:this.zone,modal:this.modal,allowChange:this.allowChange,allowEdit:this.allowEdit,allowDelete:this.allowDelete,allowDeleteWhileOffline:this.allowDeleteWhileOffline,allowRefresh:this.allowRefresh,allowDownload:this.allowDownload,confirmAction:this.confirmAction,allowSearch:this.allowSearch,style:this.style,calendarEntry:this.calendarEntry,activeFilterName:this._activeFilterName,availableFilters:this._availableFilters,filterActive:this._filterActive,newRowFieldsOptions:this.newRowFieldsOptions,timeScaleView:this._timeScaleView,startDate:this._startDate,activeQueryString:this._activeQueryString,columnTemplate:this._columnTemplate,preserveFieldData:this._preserveFieldData,mapOptions:this._mapOptions,selectionAction:this.selectionAction,keysForShortMessage:this._keysForShortMessage,acceptAttachments:this.acceptAttachments,allowQuickAction:this.allowQuickAction,topTableMenu:this.topTableMenu,searchPlaceholder:this.searchPlaceholder,parentDocId:parentDocId};}},{key:"document",set:function set(document){this._document=document;},get:function get(){return this._document;}},{key:"parentDoc",set:function set(parentDoc){this._parentDoc=parentDoc;},get:function get(){return this._parentDoc;}},{key:"system",get:function get(){return this._system;}},{key:"filterDoc",get:function get(){return this._filterDoc;},set:function set(filterDoc){this._filterDoc=filterDoc;if(this._filterDoc){this._filterActive=true;this._filterDoc._filteredCollectionName=this.intentId;}else{this._filterActive=false;}}},{key:"mapOptions",get:function get(){return this._mapOptions;}},{key:"activeQueryString",set:function set(activeQueryString){this._activeQueryString=activeQueryString;},get:function get(){return this._activeQueryString;}},{key:"startDate",set:function set(startDate){this._startDate=startDate;},get:function get(){return this._startDate;}},{key:"timeScaleView",set:function set(timeScaleView){this._timeScaleView=timeScaleView;},get:function get(){return this._timeScaleView;}},{key:"availableFilters",set:function set(availableFilters){this._availableFilters=availableFilters;},get:function get(){return this._availableFilters;}},{key:"activeFilterName",set:function set(activeFilterName){this._activeFilterName=activeFilterName;},get:function get(){return this._activeFilterName;}},{key:"parent",set:function set(parent){this._parent=parent;}},{key:"tableId",get:function get(){return this.intentId;}},{key:"rows",get:function get(){return this._rows;},set:function set(rows){this._rows=rows;}},{key:"onMatching",get:function get(){var _this96=this;return function(state){var _=state._;var D=state.developer;var NO_VALUE='no value';var action=_.get(state.messageFromUser,'action');var field=_.get(state.messageFromUser,'currentFieldValue',_.get(state.messageFromUser,'content.currentFieldValue',NO_VALUE));return state.messageTypeFromUser===Collection.TABLE_RESPONSE()&&(state.messageFromUser.controlId===_this96.intentId||state.messageFromUser.tableId===_this96.intentId)&&field===NO_VALUE&&!(action&&Field.IsFieldAction(action));};}},{key:"onResolution",get:function get(){var _this97=this;var _=this.document._botState._;var D=this.document._botState.developer;return function _callee75(state){var docId,parentDocId,tabId,rawDocToRestore,docToRestore,_rawDocToRestore,_docToRestore;return regeneratorRuntime.async(function _callee75$(_context125){while(1){switch(_context125.prev=_context125.next){case 0:docId=_.get(state.messageFromUser,'docId');parentDocId=_.get(state.messageFromUser,'parentDocId');if(!docId&&parentDocId){docId=parentDocId;}if(docId){tabId=_.get(state.messageFromUser,'tabId');_this97.document.loadDocFromAutoSaveBuffer(tabId,docId,parentDocId);if(state.messageFromUser.action===Collection.ON_DELETE()||state.messageFromUser.action===ALL_CONSTANTS.ACTIONS.DISCARD&&state.messageFromUser.newRow){_this97.document.clearAutoSaveBuffer(tabId,docId,parentDocId);}else if(state.messageFromUser.action===ALL_CONSTANTS.ACTIONS.DISCARD&&!state.messageFromUser.newRow){rawDocToRestore=_.get(state.messageFromUser,"content."+docId);docToRestore=Doc.formResponseAsObject(rawDocToRestore);_this97.document.docId=docId;_this97.document.buildDocument(docToRestore,true);}else if(state.messageFromUser.action===Collection.ON_SAVE()){_rawDocToRestore=_.get(state.messageFromUser,"content");D.log({message:"rawDocToRestore",data:_rawDocToRestore});_docToRestore=Doc.formResponseAsObject({fields:_rawDocToRestore});D.log({message:"docToRestore",data:_docToRestore});_this97.document.docId=docId;_this97.document.buildDocument(_docToRestore,true,true);D.log({message:"builtDocument",data:_this97.document.document});}}_context125.next=6;return regeneratorRuntime.awrap(_this97._callEvents(state));case 6:case"end":return _context125.stop();}}},null,_this97);};}}]);return Collection;}(Intent);var AuthorizationRequest=function(_Intent19){_inherits(AuthorizationRequest,_Intent19);_createClass(AuthorizationRequest,null,[{key:"MESSAGE_TYPE",value:function MESSAGE_TYPE(){return'authorization_request';}},{key:"MESSAGE_RESPONSE",value:function MESSAGE_RESPONSE(){return'authorization_request_response';}},{key:"CONFIRM_ACTION",value:function CONFIRM_ACTION(){return'confirm';}},{key:"CANCEL_ACTION",value:function CANCEL_ACTION(){return'cancel';}}]);function AuthorizationRequest(intentId,_ref42){var _this99=this;var text=_ref42.text,confirm=_ref42.confirm,cancel=_ref42.cancel,tabId=_ref42.tabId,botState=_ref42.botState;_classCallCheck(this,AuthorizationRequest);var _this98=_possibleConstructorReturn(this,(AuthorizationRequest.__proto__||Object.getPrototypeOf(AuthorizationRequest)).call(this,intentId,botState));_this98.onConfirm=function _callee76(){return regeneratorRuntime.async(function _callee76$(_context126){while(1){switch(_context126.prev=_context126.next){case 0:case"end":return _context126.stop();}}},null,_this99);};_this98.onCancel=function _callee77(){return regeneratorRuntime.async(function _callee77$(_context127){while(1){switch(_context127.prev=_context127.next){case 0:case"end":return _context127.stop();}}},null,_this99);};_this98.text=text;_this98.confirm=confirm;_this98.cancel=cancel;_this98.tabId=tabId;return _this98;}_createClass(AuthorizationRequest,[{key:"message",value:function message(){return{controlId:this.intentId,message:this.text,confirm:this.confirm,tabId:this.tabId,cancel:this.cancel};}},{key:"onMatching",get:function get(){var _this100=this;return function(state){return state.messageTypeFromUser===AuthorizationRequest.MESSAGE_RESPONSE()&&state.messageFromUser.controlId===_this100.intentId;};}},{key:"onResolution",get:function get(){var _this101=this;return function _callee78(state){return regeneratorRuntime.async(function _callee78$(_context128){while(1){switch(_context128.prev=_context128.next){case 0:if(!(state.messageFromUser.action===AuthorizationRequest.CONFIRM_ACTION())){_context128.next=5;break;}_context128.next=3;return regeneratorRuntime.awrap(_this101.onConfirm());case 3:_context128.next=11;break;case 5:if(!(state.messageFromUser.action===AuthorizationRequest.CANCEL_ACTION())){_context128.next=10;break;}_context128.next=8;return regeneratorRuntime.awrap(_this101.onCancel());case 8:_context128.next=11;break;case 10:state.addSystemErrorToStack(28,Error.getErrorMessageforCodeAndLang(28));case 11:if(state.responsesArray.length===0){state.addSilentResponse();}case 12:case"end":return _context128.stop();}}},null,_this101);};}}]);return AuthorizationRequest;}(Intent);var Section=function(_Intent20){_inherits(Section,_Intent20);function Section(intentId,_ref43){var botState=_ref43.botState,label=_ref43.label,_ref43$collapsable=_ref43.collapsable,collapsable=_ref43$collapsable===undefined?false:_ref43$collapsable,_ref43$defaultCollaps=_ref43.defaultCollapsableState,defaultCollapsableState=_ref43$defaultCollaps===undefined?false:_ref43$defaultCollaps,columns=_ref43.columns,doc=_ref43.doc,_ref43$hidden=_ref43.hidden,hidden=_ref43$hidden===undefined?false:_ref43$hidden;_classCallCheck(this,Section);var _this102=_possibleConstructorReturn(this,(Section.__proto__||Object.getPrototypeOf(Section)).call(this,intentId,botState));_this102.label=label;_this102.collapsable=collapsable;_this102.defaultCollapsableState=defaultCollapsableState;_this102.columns=columns;_this102.doc=doc;_this102.hidden=hidden;_this102.doc.addSection(_this102);return _this102;}_createClass(Section,[{key:"message",value:function message(){return{label:this.label,collapsable:this.collapsable,hidden:this.hidden,defaultCollapsableState:this.defaultCollapsableState,columns:this.columns};}},{key:"sectionId",get:function get(){return this.intentId;}}]);return Section;}(Intent);var Doc=function(_Intent21){_inherits(Doc,_Intent21);_createClass(Doc,null,[{key:"CONFIRM_FORM_ACTION",value:function CONFIRM_FORM_ACTION(){return'confirm';}},{key:"CANCEL_FORM_ACTION",value:function CANCEL_FORM_ACTION(){return'cancel';}},{key:"CLOSE_FORM_ACTION",value:function CLOSE_FORM_ACTION(){return'close';}},{key:"FORM_RESPONSE",value:function FORM_RESPONSE(){return'form_response';}},{key:"FORM_SEARCH_RESULTS_ACTION",value:function FORM_SEARCH_RESULTS_ACTION(){return'results';}},{key:"FORM_MAP_RESULTS_ACTION",value:function FORM_MAP_RESULTS_ACTION(){return'map_results';}},{key:"FORM_CHANGE_ACTION",value:function FORM_CHANGE_ACTION(){return'change';}},{key:"DELETE_ROW_ACTION",value:function DELETE_ROW_ACTION(){return'deleteRow';}},{key:"ADD_ROW_ACTION",value:function ADD_ROW_ACTION(){return'append';}},{key:"CHANGE_COLUMN_TEMPLATE_ACTION",value:function CHANGE_COLUMN_TEMPLATE_ACTION(){return'changeColumnTemplate';}},{key:"FORM_VALIDATION_ACTION",value:function FORM_VALIDATION_ACTION(){return'validation';}},{key:"formResponseAsObject",value:function formResponseAsObject(message){var fields={};if(message.fields){message.fields.forEach(function(field){if(field.fileName){fields[field.id]={value:field.value,fileName:field.fileName};}else{fields[field.id]=field.value;}});}else{if(message.currentField){fields[message.currentField]=message.currentFieldValue;}}return fields;}},{key:"createNewInstanceFromDoc",value:function createNewInstanceFromDoc(doc,intentId,fieldsSuffix){var _=doc._botState._;var D=doc._botState.developer;var newDoc=new Doc(intentId||doc.intentId,doc._botState,{title:doc.title,description:doc.description,allowMinimize:doc.allowMinimize,allowClose:doc.allowClose,minimizeOnConfirm:doc.minimizeOnConfirm,updateInBackground:doc.updateInBackground,promptOnClose:doc.promptOnClose,confirm:doc.confirm,cancel:doc.cancel,icon:doc.icon,readOnly:doc.readOnly,allowEdit:doc.allowEdit,zone:doc.zone,autoSave:doc.autoSave,modal:doc.modal,onResponse:doc.onResponse,onPostBuild:doc.onPostBuild,onPostBuildContainer:doc.onPostBuildContainer,audit:doc._audit,allowDelete:doc.allowDelete,allowDeleteWhileOffline:doc.allowDeleteWhileOffline,rowMenu:doc.rowMenu});newDoc._sections=doc._sections;newDoc.onPostBuild=doc.onPostBuild;newDoc.onSave=doc.onSave;newDoc.onPostBuildContainer=doc.onPostBuildContainer;newDoc.onPostLoad=doc.onPostLoad;if(doc._collection){newDoc._collection=doc._collection;newDoc._collectionDBName=doc._collectionDBName;}doc._botState.duringBuild=true;_.forEach(doc.fields,function(field){Field.createNewFieldFromField(field,newDoc,fieldsSuffix);});doc._botState.duringBuild=false;_.forEach(doc._subDocs,function(subDoc){var newSubDoc=Doc.createNewInstanceFromDoc(subDoc);newSubDoc._autoSave=newDoc._autoSave;newSubDoc._parentDoc=newDoc;newSubDoc._subDoc=true;newDoc.addChildDoc(newSubDoc);});return newDoc;}},{key:"getTermQueryForObject",value:function getTermQueryForObject(object,botState){var _=botState._;var termsArray=[];_.forEach(object,function(value,key){var termObject={};termObject[key]=value;var term={term:termObject};termsArray.push(term);});var queryObject={query:{bool:{must:termsArray}}};return queryObject;}},{key:"ExpandShortFormResponse",value:function ExpandShortFormResponse(shortResponse,botState){var _,D,fieldKeys,fieldData,fields;return regeneratorRuntime.async(function ExpandShortFormResponse$(_context129){while(1){switch(_context129.prev=_context129.next){case 0:_=botState._;D=botState.developer;fieldKeys=_.get(shortResponse,"fieldKeys",[]);fieldData=_.get(shortResponse,"fieldData",[]);fields=[];_.forEach(fieldData,function(fieldArray){var fieldObj={};_.forEach(fieldKeys,function(fieldParam,index){if(fieldArray[index]!=null){fieldObj[fieldParam]=fieldArray[index];}});fields.push(fieldObj);});return _context129.abrupt("return",fields);case 7:case"end":return _context129.stop();}}},null,this);}}]);function Doc(intentId,botState,_ref44){var _this104=this;var tabId=_ref44.tabId,_ref44$title=_ref44.title,title=_ref44$title===undefined?'Lookup':_ref44$title,_ref44$description=_ref44.description,description=_ref44$description===undefined?'lookup':_ref44$description,_ref44$allowMinimize=_ref44.allowMinimize,allowMinimize=_ref44$allowMinimize===undefined?true:_ref44$allowMinimize,_ref44$allowClose=_ref44.allowClose,allowClose=_ref44$allowClose===undefined?true:_ref44$allowClose,_ref44$minimizeOnConf=_ref44.minimizeOnConfirm,minimizeOnConfirm=_ref44$minimizeOnConf===undefined?true:_ref44$minimizeOnConf,_ref44$updateInBackgr=_ref44.updateInBackground,updateInBackground=_ref44$updateInBackgr===undefined?false:_ref44$updateInBackgr,promptOnClose=_ref44.promptOnClose,confirm=_ref44.confirm,cancel=_ref44.cancel,icon=_ref44.icon,_ref44$readOnly=_ref44.readOnly,readOnly=_ref44$readOnly===undefined?false:_ref44$readOnly,_ref44$allowEdit=_ref44.allowEdit,allowEdit=_ref44$allowEdit===undefined?true:_ref44$allowEdit,zone=_ref44.zone,parentDoc=_ref44.parentDoc,_ref44$temp=_ref44.temp,temp=_ref44$temp===undefined?false:_ref44$temp,subDocs=_ref44.subDocs,_ref44$autoSave=_ref44.autoSave,autoSave=_ref44$autoSave===undefined?false:_ref44$autoSave,modal=_ref44.modal,_ref44$onResponse=_ref44.onResponse,onResponse=_ref44$onResponse===undefined?function(){}:_ref44$onResponse,audit=_ref44.audit,_ref44$autoIndex=_ref44.autoIndex,autoIndex=_ref44$autoIndex===undefined?false:_ref44$autoIndex,_ref44$docId=_ref44.docId,docId=_ref44$docId===undefined?botState.getUniqueId():_ref44$docId,rowMenu=_ref44.rowMenu,allowDelete=_ref44.allowDelete,allowDeleteWhileOffline=_ref44.allowDeleteWhileOffline,_id=_ref44._id,_ref44$onPostBuild=_ref44.onPostBuild,onPostBuild=_ref44$onPostBuild===undefined?function(self,doc){}:_ref44$onPostBuild,_ref44$onPostBuildCon=_ref44.onPostBuildContainer,onPostBuildContainer=_ref44$onPostBuildCon===undefined?function(self,container){}:_ref44$onPostBuildCon,_ref44$onSave=_ref44.onSave,onSave=_ref44$onSave===undefined?function _callee79(self){return regeneratorRuntime.async(function _callee79$(_context130){while(1){switch(_context130.prev=_context130.next){case 0:case"end":return _context130.stop();}}},null,_this104);}:_ref44$onSave,_ref44$onPostLoad=_ref44.onPostLoad,onPostLoad=_ref44$onPostLoad===undefined?function _callee80(self){return regeneratorRuntime.async(function _callee80$(_context131){while(1){switch(_context131.prev=_context131.next){case 0:case"end":return _context131.stop();}}},null,_this104);}:_ref44$onPostLoad,_ref44$onSubmit=_ref44.onSubmit,onSubmit=_ref44$onSubmit===undefined?function _callee81(){return regeneratorRuntime.async(function _callee81$(_context132){while(1){switch(_context132.prev=_context132.next){case 0:case"end":return _context132.stop();}}},null,_this104);}:_ref44$onSubmit,_ref44$onCancel=_ref44.onCancel,onCancel=_ref44$onCancel===undefined?function _callee82(){return regeneratorRuntime.async(function _callee82$(_context133){while(1){switch(_context133.prev=_context133.next){case 0:case"end":return _context133.stop();}}},null,_this104);}:_ref44$onCancel,_ref44$onClose=_ref44.onClose,onClose=_ref44$onClose===undefined?function _callee83(){return regeneratorRuntime.async(function _callee83$(_context134){while(1){switch(_context134.prev=_context134.next){case 0:case"end":return _context134.stop();}}},null,_this104);}:_ref44$onClose;_classCallCheck(this,Doc);var _this103=_possibleConstructorReturn(this,(Doc.__proto__||Object.getPrototypeOf(Doc)).call(this,intentId,botState,tabId));var D=_this103._botState.developer;_this103._botState=botState;_this103._children={};_this103._document={};_this103._dbDocument={};_this103._documentForShortResponse={};_this103._subDoc=false;_this103._subDocs=subDocs||[];_this103._subCollections=[];_this103._autoSave=autoSave;_this103._audit=audit;_this103.index=-1;_this103._filteredCollectionName="";_this103._sections={};_this103._id=_id;_this103.temp=temp;_this103._autoIndex=autoIndex;_this103.title=title;_this103.description=description;_this103.allowMinimize=allowMinimize;_this103.allowClose=allowClose;_this103.minimizeOnConfirm=minimizeOnConfirm;_this103.updateInBackground=updateInBackground;_this103.confirm=confirm;_this103.cancel=cancel;_this103.icon=icon;_this103.modal=modal;_this103.readOnly=readOnly;_this103.allowEdit=allowEdit;_this103.promptOnClose=promptOnClose;_this103._rowMenu=rowMenu;_this103._allowDelete=allowDelete;_this103._allowDeleteWhileOffline=allowDeleteWhileOffline;_this103.zone=zone;_this103._fields=[];_this103._f={};_this103.docId=docId;_this103.onPostBuild=onPostBuild;_this103.onPostBuildContainer=onPostBuildContainer;_this103.onSave=onSave;_this103.onPostLoad=onPostLoad;_this103.onSubmit=onSubmit;_this103.onCancel=onCancel;_this103.onClose=onClose;_this103.onResponse=onResponse;if(parentDoc){if(parentDoc instanceof Doc){_this103._subDoc=true;_this103._parentDoc=parentDoc;parentDoc.addChildDoc(_this103);}else{_this103._botState.addSystemErrorToStack(7,"Sub documents cannot be saved "+_this103._intentId);}}return _this103;}_createClass(Doc,[{key:"options",value:function options(parent,quickForm){return{parent:parent,formId:this.intentId,controlId:this.intentId,docId:this.docId,tabId:this.tabId,title:this.title,description:this.description,allowMinimize:this.allowMinimize,allowClose:this.allowClose,minimizeOnConfirm:this.minimizeOnConfirm,updateInBackground:this.updateInBackground,promptOnClose:this.promptOnClose,confirm:this.confirm,cancel:this.cancel,icon:this.icon,readOnly:this.readOnly,allowEdit:this.allowEdit,zone:this.zone,allowDelete:this._allowDelete,allowDeleteWhileOffline:this._allowDeleteWhileOffline,rowMenu:this._rowMenu,modal:!!quickForm,sections:this._sections};}},{key:"formResponseWithAction",value:function formResponseWithAction(action,result,quickForm,forCollection,parent){var oldAllowDelete=this._allowDelete;var oldAllowEdit=this.allowEdit;var r=result;var a=action;var columnTemplate=void 0;if(action===Doc.FORM_CHANGE_ACTION()&&Array.isArray(r)){r={fields:result};}else if(action===Doc.DELETE_ROW_ACTION()){r={deleteRow:[this.docId]};a=Doc.FORM_CHANGE_ACTION();}else if(action===Doc.ADD_ROW_ACTION()&&Array.isArray(r)){r={append:result};a=Doc.FORM_CHANGE_ACTION();}else if(action===Doc.CHANGE_COLUMN_TEMPLATE_ACTION()){r=[];var _collection=this.collection;if(_collection){columnTemplate=_collection.generateTableColumnTemplate();}}var collection=this.collection;var tableId=void 0;var parentDocId=void 0;var rowOptions=void 0;if(forCollection&&collection){tableId=collection.intentId;if(this._botState&&this._botState.messageFromUser){parentDocId=this._botState.messageFromUser.parentDocId;}if(this._botState&&this._botState.messageFromUser.action!==Field.MOVE_FORM_ACTION()&&this._botState.messageFromUser.action!==Field.SEARCH_FORM_ACTION()&&(oldAllowDelete!==this._allowDelete||oldAllowEdit!==this.allowEdit)){rowOptions={allowDelete:this._allowDelete,allowEdit:this.allowEdit,rowMenu:this.rowMenu};}}return{result:r,options:{parent:parent,tableId:tableId,parentDocId:parentDocId,formId:this.intentId,tabId:this.tabId,controlId:this.intentId,docId:this.docId,action:a,rowOptions:rowOptions,columnTemplate:columnTemplate}};}},{key:"getParentForMessage",value:function getParentForMessage(skipOnResponse){if(!skipOnResponse){this.onResponse(this);}var parent=null;if(this._parent){parent=this._parent._intentId;}return parent;}},{key:"message",value:function message(action,result,quickForm,forCollection,skipOnResponse){var parent=this.getParentForMessage(skipOnResponse);if(action){return this.formResponseWithAction(action,result,quickForm,forCollection,parent);}else{var fields=[];this._fields.forEach(function(field){var fieldMessage=field.message(skipOnResponse);if(fieldMessage&&(!quickForm||quickForm&&field.includeInQuickEdit)){fields.push(fieldMessage);}});return{fields:fields,options:this.options(parent,quickForm)};}}},{key:"shortMessage",value:function shortMessage(action,result,quickForm,forCollection,skipOnResponse){var parent=this.getParentForMessage(skipOnResponse);if(action){return this.formResponseWithAction(action,result,quickForm,forCollection,parent);}else{var fieldKeys=Field.getGenericKeys();var fieldData=[];this._fields.forEach(function(field){var fieldMessage=field.shortMessage(skipOnResponse);if(fieldMessage&&(!quickForm||quickForm&&field.includeInQuickEdit)){fieldData.push(fieldMessage);}});return{fields:{fieldKeys:fieldKeys,fieldData:fieldData},options:this.options(parent,quickForm)};}}},{key:"addField",value:function addField(field){if(field instanceof Field){this._fields.push(field);this._f[field._intentId]=field;return this._fields.length>0?this._fields.length-1:0;}else{state.addSystemErrorToStack(Error.getErrorMessageforCodeAndLang(28));}}},{key:"addFields",value:function addFields(fields){var _this105=this;if(Array.isArray(fields)){fields.forEach(function(field){_this105.addField(field);});}}},{key:"removeFieldWithId",value:function removeFieldWithId(id){delete this._f[id];var _=this._botState._;var index=_.findIndex(this._fields,function(field){return field.id===id;});if(index>-1){this._fields.splice(index,0,1);}}},{key:"addSection",value:function addSection(section){this._sections[section.sectionId]=section.message();}},{key:"sendResponse",value:function sendResponse(){this._botState.addFormResponse(this.message());}},{key:"sendShortResponse",value:function sendShortResponse(){this._botState.addShortFormResponse(this.shortMessage());}},{key:"sendQuickDocResponse",value:function sendQuickDocResponse(){this._botState.addFormResponse(this.message(null,null,true));}},{key:"setCollection",value:function setCollection(collection){this._collection=collection.intentId;this._collectionDBName=collection._name;}},{key:"getPrimaryKey",value:function getPrimaryKey(){var _=this._botState._;var D=this._botState.developer;var primaryKey={};_.forEach(this._fields,function(field){if(field.primaryKey&&field.value&&!field.temp){primaryKey[field.dbName||field._intentId]=field.value;}});return primaryKey;}},{key:"getPrimaryKeyAsStringForSearch",value:function getPrimaryKeyAsStringForSearch(object){var _this106=this;var result="";this._botState._.forEach(object,function(field){var f=field;if(typeof field!=='string'){f=_this106._botState.R.toString(field);}if(result===""){result=result+f;}else{result=result+"-"+f;}});return result;}},{key:"getNonPrimaryKey",value:function getNonPrimaryKey(){var _=this._botState._;var D=this._botState.developer;var primaryKey={};_.forEach(this._fields,function(field){if(!field.primaryKey&&field.value){primaryKey[field._intentId]=field.value;}});return primaryKey;}},{key:"buildDocumentFromContainer",value:function buildDocumentFromContainer(container,skipPostBuild){var _this107=this;var _=this._botState._;var D=this._botState.developer;var rootDoc=container[this.intentId];var start=Date.now();if(typeof rootDoc!=='undefined'){this.buildDocument(rootDoc,skipPostBuild);}else{this.buildDocument(container,skipPostBuild);}_.forEach(this._subDocs,function(subDoc){var doc=container[subDoc.intentId];if(doc&&!subDoc.temp){subDoc.buildDocument(doc,skipPostBuild);_this107._document[subDoc.intentId]=subDoc.document;_this107._dbDocument[subDoc.intentId]=subDoc.document;}});_.forEach(this._subCollections,function(subCollection){var collection=container[subCollection.intentId];if(collection&&!subCollection.temp){var childArray=[];_.forEach(collection,function(entry){var newDoc=Doc.createNewInstanceFromDoc(subCollection.document);subCollection.addRow(newDoc);newDoc.buildDocument(entry,skipPostBuild);childArray.push(newDoc.document);});_this107._document[subCollection.intentId]=childArray;_this107._dbDocument[subCollection.intentId]=childArray;}});return this._document;}},{key:"buildDocument",value:function buildDocument(docFromDB,skipPostBuild,withAutoSave){var _this108=this;var _=this._botState._;var D=this._botState.developer;try{if(!withAutoSave)this._botState.duringBuild=true;var doc={};_.forEach(docFromDB,function(value,key){if(key==='_id'){_this108._id=value;}else if(key==='docId'){_this108.docId=value;}else if(key==='allowEdit'){_this108.allowEdit=value;}else if(key==='allowDelete'){_this108.allowDelete=value;}else if(key==='rowMenu'){_this108.rowMenu=value;}else{var v=docFromDB[key];if(typeof v==='object'&&_.get(v,'text')){v=_.get(v,'text');}if(typeof v==='object'&&_.get(v,'fileName')){v={value:_.get(v,'value'),fileName:_.get(v,'fileName')};}if(_this108.f[key]){_this108.f[key].value=v;doc[key]=_this108.f[key].value;}else{_.forEach(_this108._fields,function(field){if(field._intentId===key||field.title===key||field.dbName===key){field.value=v;doc[field._intentId]=field.value;}});}}});if(!skipPostBuild){this.onPostBuild(this,docFromDB);}this._botState.duringBuild=false;return this._document;}catch(error){D.log({message:'Error building document',data:docFromDB});this._botState.addSystemErrorToStack(45,null,error.message);}}},{key:"buildDocumentFromUserMessage",value:function buildDocumentFromUserMessage(messageFromUser){var _=this._botState._;this._botState.duringBuild=true;var messageFromUserRefactored={};_.forEach(messageFromUser.fields,function(message){messageFromUserRefactored[message.id]=message;});_.forEach(this._fields,function(field){if(_.get(messageFromUserRefactored[field.intentId],'fileName')){field.value={value:_.get(messageFromUserRefactored[field.intentId],'value'),fileName:_.get(messageFromUserRefactored[field.intentId],'fileName')};}else{field.value=_.get(messageFromUserRefactored[field.intentId],'value');}});this._botState.duringBuild=false;}},{key:"clearDocument",value:function clearDocument(){var _=this._botState._;var D=this._botState.developer;this._document={};this._dbDocument={};_.forEach(this._fields,function(field){if(!field.primaryKey){field._value=field._originalValue;}});}},{key:"processDataFromDB",value:function processDataFromDB(payload){if(Array.isArray(payload)){if(payload.length===1){var result={};if(this.hasSubDocs){result=this.buildDocumentFromContainer(payload[0]);}else{result=this.buildDocument(payload[0]);}return result;}else if(payload.length>1){this._botState.addErrorToStack(7,'Multiple records returned by query while expecting only one',payload);}else return{};}else{return this.buildDocument(payload);}}},{key:"loadDocument",value:function loadDocument(query){var start,_,R,D,primaryKey,results,payload,result;return regeneratorRuntime.async(function loadDocument$(_context135){while(1){switch(_context135.prev=_context135.next){case 0:start=Date.now();if(!this._subDoc){_context135.next=4;break;}this._botState.addSystemErrorToStack(7,"Sub documents cannot be loaded "+this._intentId);return _context135.abrupt("return");case 4:if(this._collection){_context135.next=7;break;}this._botState.addSystemErrorToStack(7,"Collection not assigned to document "+this._intentId);return _context135.abrupt("return");case 7:_=this._botState._;R=this._botState.R;D=this._botState.developer;this.clearDocument();this.docId=this._botState.user.userId;this.clearAutoSaveBuffer();primaryKey={};if(query){primaryKey=query;}else{primaryKey=this.getPrimaryKey();}if(!(_.size(primaryKey)>0)){_context135.next=30;break;}_context135.next=18;return regeneratorRuntime.awrap(this._botState.db.getDataFromCollection({collection:this._collectionDBName,query:primaryKey,expectOneResult:true,system:_.get(this.collection,'system'),cache:_.get(this.collection,'_cache'),securedFields:this.getSecuredFieldsArray()}));case 18:results=_context135.sent;if(!(_.get(results,'statusCode')===200)){_context135.next=27;break;}payload=results.body;result=this.processDataFromDB(payload);_context135.next=24;return regeneratorRuntime.awrap(this.onPostLoad(this));case 24:return _context135.abrupt("return",result);case 27:this._botState.addSystemErrorToStack(7,'Error reading MongoDB');case 28:_context135.next=31;break;case 30:this._botState.addErrorToStack(7,'You need to add some values to the primary key or passing a value in query before calling loadDocument(query)');case 31:case"end":return _context135.stop();}}},null,this);}},{key:"saveDelta",value:function saveDelta(sync,withKey){var D,_,query,options;return regeneratorRuntime.async(function saveDelta$(_context136){while(1){switch(_context136.prev=_context136.next){case 0:D=this._botState.developer;_=this._botState._;_context136.next=4;return regeneratorRuntime.awrap(this.onSave(this));case 4:if(!this._subDoc){_context136.next=7;break;}this._botState.addSystemErrorToStack(7,"Sub documents cannot be saved "+this._intentId);return _context136.abrupt("return");case 7:query={};if(withKey){query=withKey;}else{query=this.getPrimaryKey();}options={upsert:true};D.info({message:'Saving doc delta',data:{collection:this._collectionDBName,document:this.deltaDoc,query:query}});if(!this._autoIndex){_context136.next=14;break;}_context136.next=14;return regeneratorRuntime.awrap(this.saveToIndex());case 14:_context136.next=16;return regeneratorRuntime.awrap(this._botState.db.updateDataInCollection({collection:this._collectionDBName,document:this.deltaDoc,query:query,options:options,audit:this._audit,sync:sync,system:_.get(this.collection,'system'),securedFields:this.getSecuredFieldsArray(),cache:this.collection.cache}));case 16:case"end":return _context136.stop();}}},null,this);}},{key:"save",value:function save(sync,withKey,legacy){var D,_,query,options;return regeneratorRuntime.async(function save$(_context137){while(1){switch(_context137.prev=_context137.next){case 0:D=this._botState.developer;_=this._botState._;_context137.next=4;return regeneratorRuntime.awrap(this.onSave(this));case 4:if(!this._subDoc){_context137.next=7;break;}this._botState.addSystemErrorToStack(7,"Sub documents cannot be saved "+this._intentId);return _context137.abrupt("return");case 7:query={};if(withKey){query=withKey;}else{query=this.getPrimaryKey();}options={upsert:true};D.log({message:'Saving doc',data:{collection:this._collectionDBName,document:this._dbDocument,query:query}});if(!this._autoIndex){_context137.next=14;break;}_context137.next=14;return regeneratorRuntime.awrap(this.saveToIndex());case 14:_context137.next=16;return regeneratorRuntime.awrap(this._botState.db.updateDataInCollection({collection:this._collectionDBName,document:legacy?this._document:this._dbDocument,query:query,options:options,audit:this._audit,sync:sync,system:_.get(this.collection,'system'),securedFields:this.getSecuredFieldsArray(),cache:this.collection.cache}));case 16:case"end":return _context137.stop();}}},null,this);}},{key:"legacySave",value:function legacySave(sync,withKey){return regeneratorRuntime.async(function legacySave$(_context138){while(1){switch(_context138.prev=_context138.next){case 0:_context138.next=2;return regeneratorRuntime.awrap(this.save(sync,withKey,true));case 2:case"end":return _context138.stop();}}},null,this);}},{key:"queryKeyFromIndex",value:function queryKeyFromIndex(){var D,_,primaryKey,queryObject,payload;return regeneratorRuntime.async(function queryKeyFromIndex$(_context139){while(1){switch(_context139.prev=_context139.next){case 0:D=this._botState.developer;_=this._botState._;primaryKey=this.getPrimaryKey();queryObject=Doc.getTermQueryForObject(primaryKey,this._botState);_context139.next=6;return regeneratorRuntime.awrap(this._botState.db.getDataFromIndexWithQueryObject(this.indexName,queryObject));case 6:payload=_context139.sent;if(!(!_.get(payload,"errorMessage")&&!_.get(payload,"error"))){_context139.next=9;break;}return _context139.abrupt("return",payload);case 9:case"end":return _context139.stop();}}},null,this);}},{key:"loadDocumentFromIndex",value:function loadDocumentFromIndex(){var _,D,payload,result;return regeneratorRuntime.async(function loadDocumentFromIndex$(_context140){while(1){switch(_context140.prev=_context140.next){case 0:_=this._botState._;D=this._botState.developer;this.clearDocument();_context140.next=5;return regeneratorRuntime.awrap(this.queryKeyFromIndex());case 5:payload=_context140.sent;_context140.next=8;return regeneratorRuntime.awrap(this.processDataFromDB(payload));case 8:result=_context140.sent;return _context140.abrupt("return",result);case 10:case"end":return _context140.stop();}}},null,this);}},{key:"saveToIndex",value:function saveToIndex(){var _,D,payload,docToUpdate;return regeneratorRuntime.async(function saveToIndex$(_context141){while(1){switch(_context141.prev=_context141.next){case 0:_=this._botState._;D=this._botState.developer;_context141.next=4;return regeneratorRuntime.awrap(this.queryKeyFromIndex());case 4:payload=_context141.sent;if(!payload){_context141.next=13;break;}D.info({message:'Updating record in ES'});docToUpdate=_.cloneDeep(this._dbDocument);docToUpdate.id=_.get(payload[0],'_id');_context141.next=11;return regeneratorRuntime.awrap(this._botState.db.updateDataInIndex({index:this.indexName,doc:docToUpdate}));case 11:_context141.next=16;break;case 13:D.info({message:'Inserting record in ES'});_context141.next=16;return regeneratorRuntime.awrap(this._botState.db.writeDataIntoIndex({index:this.indexName,doc:this._dbDocument}));case 16:case"end":return _context141.stop();}}},null,this);}},{key:"delete",value:function _delete(){var D,_,query;return regeneratorRuntime.async(function _delete$(_context142){while(1){switch(_context142.prev=_context142.next){case 0:D=this._botState.developer;_=this._botState._;D.info({message:'Deleting doc',data:{collection:this._collectionDBName,document:this._dbDocument}});query=this.getPrimaryKey();_context142.next=6;return regeneratorRuntime.awrap(this._botState.db.deleteDataFromCollection({collection:this._collectionDBName,document:this._dbDocument,query:query,system:_.get(this.collection,'system')}));case 6:case"end":return _context142.stop();}}},null,this);}},{key:"rebuildDocumentObject",value:function rebuildDocumentObject(){var _this109=this;var _=this._botState._;if(_.size(this._document)===0){_.forEach(this._fields,function(field){if(!field.temp){_this109._document[field._intentId]=field.value;_this109._dbDocument[field.dbName||field._intentId]=field.value;}});}if(this.hasSubDocs){_.forEach(this._subDocs,function(subDoc){if(!subDoc.temp){_this109._document[subDoc.intentId]=subDoc.rebuildDocumentObject();_this109._dbDocument[subDoc.intentId]=_this109._document[subDoc.intentId];}});_.forEach(this._subCollections,function(subCollection){if(!subCollection.temp){var rowDocuments=[];_.forEach(subCollection.rows,function(row){rowDocuments.push(row.rebuildDocumentObject());});_this109._document[subCollection.intentId]=rowDocuments;_this109._dbDocument[subCollection.intentId]=_this109._document[subCollection.intentId];}});}return this._document;}},{key:"getSecuredFieldsArray",value:function getSecuredFieldsArray(){var _=this._botState._;var D=this._botState.developer;var securedFieldsArray=[];_.forEach(this._fields,function(field){if(field.encrypted){securedFieldsArray.push(field.dbName||field.id);}});if(this.hasSubDocs){_.forEach(this._subDocs,function(subDoc){var subDocArray=subDoc.getSecuredFieldsArray();_.forEach(subDocArray,function(entry){securedFieldsArray.push(subDoc.intentId+"."+entry);});});_.forEach(this._subCollections,function(subCollection){var subDoc=subCollection.document;var subDocArray=subDoc.getSecuredFieldsArray();_.forEach(subDocArray,function(entry){securedFieldsArray.push(subDoc.intentId+"."+entry);});});}return securedFieldsArray;}},{key:"addChildDoc",value:function addChildDoc(child){if(child instanceof Doc){this._subDocs.push(child);}else if(child instanceof Collection){this._subCollections.push(child);}else{this._botState.addSystemErrorToStack(7,"Child must be instance of either Doc or Collection classes "+this._intentId);return false;}this._children[child.intentId]=child;return true;}},{key:"_callEvents",value:function _callEvents(state){return regeneratorRuntime.async(function _callEvents$(_context143){while(1){switch(_context143.prev=_context143.next){case 0:if(this._parent&&this._parent._intentId===state.currentControlId){state.currentControlId=this._parent._intentId;}else{state.currentControlId=this.intentId;}if(!(state.messageFromUser.action===Doc.CONFIRM_FORM_ACTION())){_context143.next=6;break;}_context143.next=4;return regeneratorRuntime.awrap(this.onSubmit());case 4:_context143.next=17;break;case 6:if(!(state.messageFromUser.action===Doc.CANCEL_FORM_ACTION())){_context143.next=11;break;}_context143.next=9;return regeneratorRuntime.awrap(this.onCancel());case 9:_context143.next=17;break;case 11:if(!(state.messageFromUser.action===Doc.CLOSE_FORM_ACTION())){_context143.next=16;break;}_context143.next=14;return regeneratorRuntime.awrap(this.onClose());case 14:_context143.next=17;break;case 16:state.addSystemErrorToStack(29,Error.getErrorMessageforCodeAndLang(29));case 17:if(state.responsesArray.length===0){state.addSilentResponse();}case 18:case"end":return _context143.stop();}}},null,this);}},{key:"overrideParentDocId",value:function overrideParentDocId(parentDocId){var _=this._botState._;if(this._parentDoc){this._parentDoc.overrideParentDocId(parentDocId);}else{if(this._collection){var collection=_.get(this._botState.intents,this._collection);if(collection._parentDoc){collection._parentDoc.overrideParentDocId(parentDocId);}else{if(_.size(this._children)>0){this.docId=parentDocId;}}}}}},{key:"loadDocFromAutoSaveBuffer",value:function loadDocFromAutoSaveBuffer(tabId,docId,parentDocId){if(this.autoSave){var _8=this._botState._;var _D5=this._botState.developer;if(docId)this.docId=docId;if(parentDocId)this.overrideParentDocId(parentDocId);this._botState.duringBuild=true;_8.forEach(this._fields,function(field){field.setValueFromAutoSave(tabId,parentDocId);});this._botState.duringBuild=false;}}},{key:"generateAutoSaveBufferFromDoc",value:function generateAutoSaveBufferFromDoc(){if(!this.docId){this.docId=this._botState.getUniqueId();this._fields.forEach(function(field){field.setAutoSaveFieldValue(field.value);});}}},{key:"getAutoSavePath",value:function getAutoSavePath(tabId,parentDocId){var botState=this._botState;try{var _9=botState._;var _D6=botState.developer;var tabIdToLoad=tabId||botState.currentTabId||this.tabId;if(this._parentDoc){var docPath=this._parentDoc.getAutoSavePath(tabIdToLoad,parentDocId);return docPath+"."+this.intentId;}else{var collectionName=_9.get(this,'_collection');if(collectionName){var collection=_9.get(botState.intents,collectionName);if(collection){var _docPath=collection.getAutoSavePath(tabIdToLoad,parentDocId);var docIdToUse=this.docId;if(!collection._parentDoc){if(parentDocId){docIdToUse=parentDocId;}}return botState._version===3?_docPath+"."+docIdToUse:_docPath+"."+this.intentId;}}}}catch(error){botState.addSystemErrorToStack(999,error.message,this.intentId);}}},{key:"clearAutoSaveBuffer",value:function clearAutoSaveBuffer(tabId,docId,parentDocId){if(!this.autoSave)return;var _=this._botState._;var autoSaveBuffer=this._botState.autoSaveBuffer;var tabIdToUse=tabId||this._botState.currentTabId||this.tabId;if(docId)this.docId=docId;if(parentDocId)this.overrideParentDocId(parentDocId);if(_.get(autoSaveBuffer,tabIdToUse)){var path=this.getAutoSavePath(tabIdToUse,parentDocId);if(path){_.unset(autoSaveBuffer,path);}}}},{key:"clearAutoSaveBufferChanges",value:function clearAutoSaveBufferChanges(tabId,docId,parentDocId){var _=this._botState._;var autoSaveBufferChanges=this._botState.autoSaveBufferChanges;var tabIdToUse=tabId||this._botState.currentTabId||this.tabId;if(docId)this.docId=docId;if(parentDocId)this.overrideParentDocId(parentDocId);if(_.get(autoSaveBufferChanges,tabIdToUse)){var path=this.getAutoSavePath(tabIdToUse,parentDocId);if(path){_.unset(autoSaveBufferChanges,path);}}}},{key:"parent",set:function set(parent){this._parent=parent;}},{key:"formId",get:function get(){return this.intentId;}},{key:"fields",get:function get(){return this._fields;},set:function set(fields){this._fields=[];this.addFields(fields);}},{key:"f",get:function get(){return this._f;}},{key:"allowDelete",get:function get(){return this._allowDelete;},set:function set(allowDelete){this._allowDelete=allowDelete;}},{key:"rowMenu",get:function get(){return this._rowMenu;},set:function set(rowMenu){this._rowMenu=rowMenu;}},{key:"collection",get:function get(){return this._botState.intents[this._collection];}},{key:"deltaDoc",get:function get(){var _=this._botState._;var delta={};var D=this._botState.developer;_.forEach(this._fields,function(field){if(field.getAutoSavedValueChanged()){delta[field.dbName||field._intentId]=field.value;}});if(this.hasSubDocs){_.forEach(this._subDocs,function(subDoc){var deltaSubDoc=subDoc.deltaDoc;if(_.size(deltaSubDoc)>0){_.forEach(deltaSubDoc,function(value,key){delta[subDoc.intentId+"."+key]=value;});}});_.forEach(this._subCollections,function(subCollection){delta[subCollection.intentId]=subCollection.rowAsDocumentsArray();});}return delta;}},{key:"indexName",get:function get(){return ALL_CONSTANTS.ES_INDEX_PREFIXES.INDEX+"_"+this._botState.currentUserDomain+"_"+this._collectionDBName;}},{key:"document",get:function get(){var _this110=this;var _=this._botState._;if(_.size(this._document)===0){_.forEach(this._fields,function(field){_this110._document[field._intentId]=field.value;});}return this._document;},set:function set(doc){this._document=doc;}},{key:"hasSubDocs",get:function get(){return this._subDocs.length>0||this._subCollections.length>0;}},{key:"autoSave",get:function get(){return this._autoSave;}},{key:"children",get:function get(){return this._children;}},{key:"onMatching",get:function get(){var _this111=this;return function(state){var inputControlId=state.messageFromUser.controlId||state.messageFromUser.formId;return state.messageTypeFromUser===Doc.FORM_RESPONSE()&&!state.messageFromUser.currentField&&inputControlId===_this111.formId;};}},{key:"onResolution",get:function get(){var _this112=this;return function _callee84(state){var _,docId,tabId,parentDocId,_document;return regeneratorRuntime.async(function _callee84$(_context144){while(1){switch(_context144.prev=_context144.next){case 0:_=state._;docId=_.get(state.messageFromUser,'docId');tabId=_.get(state.messageFromUser,'tabId');if(docId){parentDocId=_.get(state.messageFromUser,'parentDocId');_this112.loadDocFromAutoSaveBuffer(tabId,docId,parentDocId);}if(!docId||_.get(state.messageFromUser,'action')===Doc.CONFIRM_FORM_ACTION()){_document=Doc.formResponseAsObject(state.messageFromUser);_this112.buildDocument(_document);}state.currentControlId=_this112.intentId;if(tabId){_this112.tabId=tabId;}_context144.next=9;return regeneratorRuntime.awrap(_this112._callEvents(state));case 9:case"end":return _context144.stop();}}},null,_this112);};}}]);return Doc;}(Intent);var DeviceStorage=function(){function DeviceStorage(botState){_classCallCheck(this,DeviceStorage);this._botState=botState;this.botContext=botState.context;var D=this._botState.developer;try{D.log({message:'On Edge'});this.deviceStorageCapability=this.botContext.getCapability('DeviceStorage');this.sha1=botState.context.getCapability('sha1');}catch(err){}}_createClass(DeviceStorage,[{key:"getKeyFromStorage",value:function getKeyFromStorage(key){return this.deviceStorageCapability.get(key).then(function(result){return result;});}},{key:"saveKeyInStorage",value:function saveKeyInStorage(key,value){return this.deviceStorageCapability.save(key,value);}},{key:"removeKeyFromStorage",value:function removeKeyFromStorage(key){return this.deviceStorageCapability.delete(key);}},{key:"getStateForConversation",value:function getStateForConversation(conversationId){if(!conversationId){return;}return this.getKeyFromStorage.get(conversationId);}},{key:"saveConversationState",value:function saveConversationState(state){if(!state){return;}return this.saveKeyInStorage(state.conversationId,state);}},{key:"saveDocument",value:function saveDocument(collection,primaryKey,document){var _,D,key,collectionKey,allCollectionKeys,index;return regeneratorRuntime.async(function saveDocument$(_context145){while(1){switch(_context145.prev=_context145.next){case 0:_=this._botState._;D=this._botState.developer;key=collection+"_"+primaryKey;collectionKey="Collection_"+collection;_context145.next=6;return regeneratorRuntime.awrap(this.getKeyFromStorage(collectionKey));case 6:_context145.t0=_context145.sent;if(_context145.t0){_context145.next=9;break;}_context145.t0=[];case 9:allCollectionKeys=_context145.t0;index=_.findIndex(allCollectionKeys,function(keyFromArray){return keyFromArray===key;});if(index>-1){allCollectionKeys.splice(index,1);}allCollectionKeys.push(key);if(!(allCollectionKeys.length>10)){_context145.next=17;break;}allCollectionKeys.splice(0,1);_context145.next=17;return regeneratorRuntime.awrap(this.removeKeyFromStorage(key));case 17:_context145.next=19;return regeneratorRuntime.awrap(this.saveKeyInStorage(collectionKey,allCollectionKeys));case 19:_context145.next=21;return regeneratorRuntime.awrap(this.saveKeyInStorage(key,document));case 21:case"end":return _context145.stop();}}},null,this);}},{key:"deleteDocument",value:function deleteDocument(collection,primaryKey){var _,D,key,collectionKey,allCollectionKeys,index;return regeneratorRuntime.async(function deleteDocument$(_context146){while(1){switch(_context146.prev=_context146.next){case 0:_=this._botState._;D=this._botState.developer;key=collection+"_"+primaryKey;collectionKey="Collection_"+collection;_context146.next=6;return regeneratorRuntime.awrap(this.getKeyFromStorage(collectionKey));case 6:_context146.t0=_context146.sent;if(_context146.t0){_context146.next=9;break;}_context146.t0=[];case 9:allCollectionKeys=_context146.t0;index=_.findIndex(allCollectionKeys,function(keyFromArray){return keyFromArray===key;});if(index>-1){allCollectionKeys.splice(index,1);}_context146.next=14;return regeneratorRuntime.awrap(this.saveKeyInStorage(collectionKey,allCollectionKeys));case 14:_context146.next=16;return regeneratorRuntime.awrap(this.removeKeyFromStorage(key));case 16:case"end":return _context146.stop();}}},null,this);}},{key:"loadDocument",value:function loadDocument(collection,primaryKey){var _10,key,_document2;return regeneratorRuntime.async(function loadDocument$(_context147){while(1){switch(_context147.prev=_context147.next){case 0:_context147.prev=0;_10=this._botState._;key=collection+"_"+primaryKey;_context147.next=5;return regeneratorRuntime.awrap(this.getKeyFromStorage(key));case 5:_document2=_context147.sent;return _context147.abrupt("return",_document2);case 9:_context147.prev=9;_context147.t0=_context147["catch"](0);case 11:case"end":return _context147.stop();}}},null,this,[[0,9]]);}},{key:"queryCollection",value:function queryCollection(collection,query){var _11,_D7,collectionKey,allCollectionKeys,allDocs,_i7,key,doc,body;return regeneratorRuntime.async(function queryCollection$(_context148){while(1){switch(_context148.prev=_context148.next){case 0:_context148.prev=0;_11=this._botState._;_D7=this._botState.developer;collectionKey="Collection_"+collection;_context148.next=6;return regeneratorRuntime.awrap(this.getKeyFromStorage(collectionKey));case 6:_context148.t0=_context148.sent;if(_context148.t0){_context148.next=9;break;}_context148.t0=[];case 9:allCollectionKeys=_context148.t0;allDocs=[];_i7=0;case 12:if(!(_i7<allCollectionKeys.length)){_context148.next=22;break;}key=allCollectionKeys[_i7];_context148.next=16;return regeneratorRuntime.awrap(this.getKeyFromStorage(key));case 16:doc=_context148.sent;body=_11.get(doc,'body');if(body){allDocs=allDocs.concat(body);}case 19:_i7++;_context148.next=12;break;case 22:return _context148.abrupt("return",{statusCode:200,body:allDocs});case 25:_context148.prev=25;_context148.t1=_context148["catch"](0);case 27:case"end":return _context148.stop();}}},null,this,[[0,25]]);}}]);return DeviceStorage;}();var DB=function(){_createClass(DB,null,[{key:"CONVERSATIONS_INDEX",value:function CONVERSATIONS_INDEX(){return'conversations*';}}]);function DB(botState){_classCallCheck(this,DB);this['_botState']=botState;this['_']=botState._;}_createClass(DB,[{key:"checkMongoResponse",value:function checkMongoResponse(response,params,cache,audit,expectOneResult,operation,sync){var D,results,parsedResponse,auditDoc,_12,payload;return regeneratorRuntime.async(function checkMongoResponse$(_context149){while(1){switch(_context149.prev=_context149.next){case 0:D=this._botState.developer;results=response.Payload;parsedResponse=JSON.parse(results);if(!(parsedResponse.statusCode===500)){_context149.next=7;break;}this._botState.addSystemErrorToStack(7,"Error in database with error "+response.Payload);_context149.next=12;break;case 7:auditDoc=params.document;if(params.query){_12=this._botState._;auditDoc=_12.merge(auditDoc,params.query);}_context149.next=11;return regeneratorRuntime.awrap(this.writeAuditIndex(params.collection,auditDoc,audit,operation,sync));case 11:if(cache){payload=parsedResponse.body;if(payload==='success'&&params.document||Array.isArray(payload)&&payload.length>0&&expectOneResult){if(payload==='success'){parsedResponse.body=[params.document];}this._botState.addObjectToSyncMessage(params.collection,JSON.stringify(params.query),parsedResponse);}}case 12:return _context149.abrupt("return",parsedResponse);case 13:case"end":return _context149.stop();}}},null,this);}},{key:"countDataFromCollection",value:function countDataFromCollection(_ref45){var collection=_ref45.collection,_ref45$query=_ref45.query,query=_ref45$query===undefined?{}:_ref45$query,_ref45$projection=_ref45.projection,projection=_ref45$projection===undefined?{}:_ref45$projection,collation=_ref45.collation,_ref45$system=_ref45.system,system=_ref45$system===undefined?false:_ref45$system;var params,lambda,response,results,parsedResponse;return regeneratorRuntime.async(function countDataFromCollection$(_context150){while(1){switch(_context150.prev=_context150.next){case 0:params={action:'count',db:system?ALL_CONSTANTS.SYSTEM_DB:this._botState.currentUserDomain,collection:collection,query:query,projection:projection,collation:collation,userId:this._botState.user.userId};_context150.t0=this._botState.location===Intent.CLOUD()||this._botState.client===State.WEBCLIENT();if(_context150.t0){_context150.next=6;break;}_context150.next=5;return regeneratorRuntime.awrap(this._botState.online());case 5:_context150.t0=_context150.sent;case 6:if(!_context150.t0){_context150.next=18;break;}lambda=this._botState.frontmlib;_context150.next=10;return regeneratorRuntime.awrap(lambda.invokeLambda('MongoDBManager','RequestResponse',params));case 10:response=_context150.sent;results=response.Payload;parsedResponse=JSON.parse(results);if(!(parsedResponse.statusCode===500)){_context150.next=17;break;}this._botState.addSystemErrorToStack(7,"Error in database with error "+response.Payload);_context150.next=18;break;case 17:return _context150.abrupt("return",parsedResponse);case 18:case"end":return _context150.stop();}}},null,this);}},{key:"getDataFromCollection",value:function getDataFromCollection(_ref46){var collection=_ref46.collection,_ref46$action=_ref46.action,action=_ref46$action===undefined?'query':_ref46$action,_ref46$query=_ref46.query,query=_ref46$query===undefined?{}:_ref46$query,_ref46$projection=_ref46.projection,projection=_ref46$projection===undefined?{}:_ref46$projection,_ref46$sort=_ref46.sort,sort=_ref46$sort===undefined?{}:_ref46$sort,_ref46$skip=_ref46.skip,skip=_ref46$skip===undefined?0:_ref46$skip,_ref46$limit=_ref46.limit,limit=_ref46$limit===undefined?20:_ref46$limit,collation=_ref46.collation,_ref46$expectOneResul=_ref46.expectOneResult,expectOneResult=_ref46$expectOneResul===undefined?false:_ref46$expectOneResul,_ref46$cache=_ref46.cache,cache=_ref46$cache===undefined?true:_ref46$cache,_ref46$system=_ref46.system,system=_ref46$system===undefined?false:_ref46$system,securedFields=_ref46.securedFields;var params,lambda,response,hashedKey,fromStorage;return regeneratorRuntime.async(function getDataFromCollection$(_context151){while(1){switch(_context151.prev=_context151.next){case 0:_context151.prev=0;params={action:action,db:system?ALL_CONSTANTS.SYSTEM_DB:this._botState.currentUserDomain,collection:collection,query:query,projection:projection,sort:sort,skip:skip,limit:limit,collation:collation,userId:this._botState.user.userId,securedFields:securedFields};_context151.t0=this._botState.location===Intent.CLOUD()||this._botState.client===State.WEBCLIENT();if(_context151.t0){_context151.next=7;break;}_context151.next=6;return regeneratorRuntime.awrap(this._botState.online());case 6:_context151.t0=_context151.sent;case 7:if(!_context151.t0){_context151.next=15;break;}lambda=this._botState.frontmlib;_context151.next=11;return regeneratorRuntime.awrap(lambda.invokeLambda('MongoDBManager','RequestResponse',params));case 11:response=_context151.sent;return _context151.abrupt("return",this.checkMongoResponse(response,params,cache,false,expectOneResult,ALL_CONSTANTS.DB_OPERATIONS.QUERY));case 15:hashedKey=this._botState.sha1(JSON.stringify(params.query));fromStorage=void 0;if(!expectOneResult){_context151.next=23;break;}_context151.next=20;return regeneratorRuntime.awrap(this._botState.deviceStorage.loadDocument(params.collection,hashedKey));case 20:fromStorage=_context151.sent;_context151.next=26;break;case 23:_context151.next=25;return regeneratorRuntime.awrap(this._botState.deviceStorage.queryCollection(params.collection,hashedKey));case 25:fromStorage=_context151.sent;case 26:if(!fromStorage){fromStorage={statusCode:200,body:[]};}return _context151.abrupt("return",fromStorage);case 28:_context151.next=33;break;case 30:_context151.prev=30;_context151.t1=_context151["catch"](0);this._botState.addSystemErrorToStack(26,'3 '+_context151.t1.name+': '+_context151.t1.message);case 33:case"end":return _context151.stop();}}},null,this,[[0,30]]);}},{key:"archiveMessages",value:function archiveMessages(){var state,_,frontmlib,THIRTY_DAYS_IN_MILLISECONDS,messageToArchive,messages;return regeneratorRuntime.async(function archiveMessages$(_context152){while(1){switch(_context152.prev=_context152.next){case 0:state=this._botState;_=state._;frontmlib=state.frontmlib;THIRTY_DAYS_IN_MILLISECONDS=1000*60*60*24*30;messageToArchive={conversationId:state.conversationId,messageId:state.messageIdFromUser,content:[state.messageFromUser],contentType:"10",createdOn:Date.now(),ttl:Date.now()+THIRTY_DAYS_IN_MILLISECONDS,deleted:[],delivered:[],opened:[],userDomain:state.currentUserDomain};messages=[];if(_.isEmpty(state.responsesArray)){if(state.messageTypeFromUser==="10"){messages.push(messageToArchive);}}else{if(!_.isEmpty(state.nlpResults)){messages.push(messageToArchive);}_.forEach(state.responsesArray,function(response){if(response.type==="string"){var newMessageToArchive=_.clone(messageToArchive);newMessageToArchive.messageId=response.messageId||state.getUniqueId();newMessageToArchive.content=[response.message];messages.push(newMessageToArchive);}});}if(!(messages.length>0)){_context152.next=10;break;}_context152.next=10;return regeneratorRuntime.awrap(frontmlib.insertMessages(messages));case 10:case"end":return _context152.stop();}}},null,this);}},{key:"writeAuditIndex",value:function writeAuditIndex(collection,document,audit,operation,sync){var auditDoc,doc,index;return regeneratorRuntime.async(function writeAuditIndex$(_context153){while(1){switch(_context153.prev=_context153.next){case 0:if(!audit){_context153.next=9;break;}auditDoc={operation:operation,location:sync?Intent.EDGE():Intent.CLOUD(),timestamp:Date.now(),userId:this._botState.user.userId,userEmail:this._botState.user.userEmail,client:this._botState.client,appVersion:this._botState.appVersion,botId:this._botState.botId,userDomain:this._botState.currentUserDomain};doc={};if(collection===ALL_CONSTANTS.ACTIVITY_COLLECTION){doc=this._botState.R.merge(auditDoc,document);}else{doc=this._botState.R.merge(auditDoc,{document:document});}index=ALL_CONSTANTS.ES_INDEX_PREFIXES.AUDIT+"_"+this._botState.currentUserDomain+"_"+collection;_context153.next=7;return regeneratorRuntime.awrap(this._botState.db.writeDataIntoIndex({index:index,doc:doc}));case 7:_context153.next=9;return regeneratorRuntime.awrap(this.archiveMessages());case 9:case"end":return _context153.stop();}}},null,this);}},{key:"insertDocumentInCollection",value:function insertDocumentInCollection(_ref47){var _this113=this;var collection=_ref47.collection,document=_ref47.document,audit=_ref47.audit,_ref47$sync=_ref47.sync,sync=_ref47$sync===undefined?false:_ref47$sync,_ref47$system=_ref47.system,system=_ref47$system===undefined?false:_ref47$system,securedFields=_ref47.securedFields,_ref47$cache=_ref47.cache,cache=_ref47$cache===undefined?false:_ref47$cache;var params;return regeneratorRuntime.async(function insertDocumentInCollection$(_context154){while(1){switch(_context154.prev=_context154.next){case 0:params={action:'insertOne',db:system?ALL_CONSTANTS.SYSTEM_DB:this._botState.currentUserDomain,collection:collection,document:document,userId:this._botState.user.userId,securedFields:securedFields};return _context154.abrupt("return",callLambda('MongoDBManager',params,this._botState.aws).then(function(response){return _this113.checkMongoResponse(response,params,cache,audit,false,ALL_CONSTANTS.DB_OPERATIONS.INSERT,sync);}).catch(function(error){_this113._botState.addSystemErrorToStack(7,error.errorMessage);}));case 2:case"end":return _context154.stop();}}},null,this);}},{key:"updateDataInCollection",value:function updateDataInCollection(_ref48){var _this114=this;var collection=_ref48.collection,document=_ref48.document,query=_ref48.query,options=_ref48.options,audit=_ref48.audit,_ref48$sync=_ref48.sync,sync=_ref48$sync===undefined?false:_ref48$sync,_ref48$system=_ref48.system,system=_ref48$system===undefined?false:_ref48$system,securedFields=_ref48.securedFields,_ref48$cache=_ref48.cache,cache=_ref48$cache===undefined?false:_ref48$cache;var _,params,hashedKey,fromStorage,docArray,docInStorage,_i8;return regeneratorRuntime.async(function updateDataInCollection$(_context155){while(1){switch(_context155.prev=_context155.next){case 0:_=this._botState._;params={action:'update',db:system?ALL_CONSTANTS.SYSTEM_DB:this._botState.currentUserDomain,collection:collection,document:document,query:query,options:options,userId:this._botState.user.userId,securedFields:securedFields};_context155.t0=this._botState.location===Intent.CLOUD()||this._botState.client===State.WEBCLIENT();if(_context155.t0){_context155.next=10;break;}_context155.next=6;return regeneratorRuntime.awrap(this._botState.online());case 6:_context155.t1=_context155.sent;if(!_context155.t1){_context155.next=9;break;}_context155.t1=!(this._botState.location===Intent.EDGE());case 9:_context155.t0=_context155.t1;case 10:if(!_context155.t0){_context155.next=14;break;}return _context155.abrupt("return",callLambda('MongoDBManager',params,this._botState.aws).then(function(response){return _this114.checkMongoResponse(response,params,cache,audit,false,ALL_CONSTANTS.DB_OPERATIONS.UPSERT,sync);}).catch(function(error){_this114._botState.addSystemErrorToStack(7,error.errorMessage);}));case 14:hashedKey=this._botState.sha1(JSON.stringify(query));_context155.next=17;return regeneratorRuntime.awrap(this._botState.deviceStorage.loadDocument(collection,hashedKey));case 17:_context155.t2=_context155.sent;if(_context155.t2){_context155.next=20;break;}_context155.t2={};case 20:fromStorage=_context155.t2;if(_.size(fromStorage)>0){docArray=_.get(fromStorage,'body');if(Array.isArray(docArray)){docInStorage=[];for(_i8=0;_i8<docArray.length;_i8++){docInStorage.push(_.merge(docArray[_i8],document));}fromStorage.body=docInStorage;}else{this._botState.addSystemErrorToStack(7,'Error updating document in local storage');}}else{fromStorage={statusCode:200,body:[document]};}_context155.next=24;return regeneratorRuntime.awrap(this._botState.deviceStorage.saveDocument(collection,hashedKey,fromStorage));case 24:this._botState.addObjectToSyncMessage(collection,JSON.stringify(params.query),fromStorage);case 25:case"end":return _context155.stop();}}},null,this);}},{key:"updateManyDataInCollection",value:function updateManyDataInCollection(_ref49){var _this115=this;var collection=_ref49.collection,document=_ref49.document,query=_ref49.query,options=_ref49.options,audit=_ref49.audit,_ref49$sync=_ref49.sync,sync=_ref49$sync===undefined?false:_ref49$sync,_ref49$system=_ref49.system,system=_ref49$system===undefined?false:_ref49$system,securedFields=_ref49.securedFields,_ref49$cache=_ref49.cache,cache=_ref49$cache===undefined?false:_ref49$cache,_ref49$updateMany=_ref49.updateMany,updateMany=_ref49$updateMany===undefined?true:_ref49$updateMany,_ref49$updateOperator=_ref49.updateOperator,updateOperator=_ref49$updateOperator===undefined?'$set':_ref49$updateOperator;var _,params,hashedKey,fromStorage,docArray,docInStorage,_i9;return regeneratorRuntime.async(function updateManyDataInCollection$(_context156){while(1){switch(_context156.prev=_context156.next){case 0:_=this._botState._;params={action:updateMany?'updateMany':'update',db:system?ALL_CONSTANTS.SYSTEM_DB:this._botState.currentUserDomain,collection:collection,document:document,query:query,options:options,userId:this._botState.user.userId,updateOperator:updateOperator,securedFields:securedFields};_context156.t0=this._botState.location===Intent.CLOUD()||this._botState.client===State.WEBCLIENT();if(_context156.t0){_context156.next=10;break;}_context156.next=6;return regeneratorRuntime.awrap(this._botState.online());case 6:_context156.t1=_context156.sent;if(!_context156.t1){_context156.next=9;break;}_context156.t1=!(this._botState.location===Intent.EDGE());case 9:_context156.t0=_context156.t1;case 10:if(!_context156.t0){_context156.next=14;break;}return _context156.abrupt("return",callLambda('MongoDBManager',params,this._botState.aws).then(function(response){return _this115.checkMongoResponse(response,params,cache,audit,false,ALL_CONSTANTS.DB_OPERATIONS.UPSERT,sync);}).catch(function(error){_this115._botState.addSystemErrorToStack(7,error.errorMessage);}));case 14:hashedKey=this._botState.sha1(JSON.stringify(query));_context156.next=17;return regeneratorRuntime.awrap(this._botState.deviceStorage.loadDocument(collection,hashedKey));case 17:_context156.t2=_context156.sent;if(_context156.t2){_context156.next=20;break;}_context156.t2={};case 20:fromStorage=_context156.t2;if(_.size(fromStorage)>0){docArray=_.get(fromStorage,'body');if(Array.isArray(docArray)){docInStorage=[];for(_i9=0;_i9<docArray.length;_i9++){docInStorage.push(_.merge(docArray[_i9],document));}fromStorage.body=docInStorage;}else{this._botState.addSystemErrorToStack(7,'Error updating document in local storage');}}else{fromStorage={statusCode:200,body:[document]};}_context156.next=24;return regeneratorRuntime.awrap(this._botState.deviceStorage.saveDocument(collection,hashedKey,fromStorage));case 24:this._botState.addObjectToSyncMessage(collection,JSON.stringify(params.query),fromStorage);case 25:case"end":return _context156.stop();}}},null,this);}},{key:"deleteDataFromCollection",value:function deleteDataFromCollection(_ref50){var _this116=this;var collection=_ref50.collection,query=_ref50.query,sync=_ref50.sync,audit=_ref50.audit,_ref50$system=_ref50.system,system=_ref50$system===undefined?false:_ref50$system;var params;return regeneratorRuntime.async(function deleteDataFromCollection$(_context157){while(1){switch(_context157.prev=_context157.next){case 0:params={action:'delete',db:system?ALL_CONSTANTS.SYSTEM_DB:this._botState.currentUserDomain,collection:collection,query:query,userId:this._botState.user.userId};return _context157.abrupt("return",callLambda('MongoDBManager',params,this._botState.aws).then(function(response){return _this116.checkMongoResponse(response,params,false,audit,false,ALL_CONSTANTS.DB_OPERATIONS.DELETE,sync);}).catch(function(error){_this116._botState.addSystemErrorToStack(7,error.errorMessage);}));case 2:case"end":return _context157.stop();}}},null,this);}},{key:"getCatalogue",value:function getCatalogue(_ref51){var query=_ref51.query,userDomain=_ref51.userDomain;var params,response;return regeneratorRuntime.async(function getCatalogue$(_context158){while(1){switch(_context158.prev=_context158.next){case 0:_context158.prev=0;params={query:query,isAllBotsRequest:true,selectedDomain:userDomain,email:this._botState.user.userEmail};_context158.next=4;return regeneratorRuntime.awrap(callLambda('catalogueLambda',params,this._botState.aws));case 4:response=_context158.sent;if(!response){_context158.next=7;break;}return _context158.abrupt("return",JSON.parse(response.Payload));case 7:_context158.next=12;break;case 9:_context158.prev=9;_context158.t0=_context158["catch"](0);this._botState.addSystemErrorToStack(7,null,_context158.t0.message);case 12:case"end":return _context158.stop();}}},null,this,[[0,9]]);}},{key:"getStaticData",value:function getStaticData(query,scan,pagination,sort){var tableName='KeyValues_'+this._botState.currentUserDomain;return this.getData(tableName,query,scan,pagination,sort);}},{key:"getData",value:function getData(table,query,scan,pagination,sort){var _this117=this;var params={collection:table,query:query,scan:scan,capability:'GetData',pagination:pagination,sort:sort,sync:true};return callLambda('SystemCapabilities',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this117._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:"getDataFromIndex",value:function getDataFromIndex(index,queryString,pageSize,sort,exactMatch){var _this118=this;var params={method:'GET',action:'search',index:this._botState._.toLower(index),q:queryString,size:pageSize,sort:sort,exact:exactMatch};return callLambda('elastiSearch',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this118._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:"getDataFromIndexWithID",value:function getDataFromIndexWithID(index,type,id){var _this119=this;var params={method:'GET_WITH_ID',index:this._botState._.toLower(index),docType:type,id:id};return callLambda('elastiSearch',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this119._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:"getDataFromIndexWithSQL",value:function getDataFromIndexWithSQL(queryString){var _this120=this;var params={method:'SQL',q:queryString};return callLambda('elastiSearch',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this120._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:"deleteDataFromIndex",value:function deleteDataFromIndex(index,type,objectId){var _this121=this;var params={method:'DELETE',index:this._botState._.toLower(index),q:objectId,docType:type};return callLambda('elastiSearch',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this121._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:"deleteDataFromIndexByID",value:function deleteDataFromIndexByID(index,type,objectId){var _this122=this;var params={method:'DELETE',index:this._botState._.toLower(index),docType:type,id:objectId};return callLambda('elastiSearch',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this122._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:"getDataFromIndexWithQueryObject",value:function getDataFromIndexWithQueryObject(index,queryObject){var _this123=this;var params={method:'GET',action:'bodySearch',index:this._botState._.toLower(index),q:queryObject};return callLambda('elastiSearch',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this123._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:"countDataInIndex",value:function countDataInIndex(index,queryString){var _this124=this;var params={method:'GET',action:'count',index:this._botState._.toLower(index),q:queryString};return callLambda('elastiSearch',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this124._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:"writeDataIntoIndex",value:function writeDataIntoIndex(_ref52){var _this125=this;var index=_ref52.index,_ref52$docType=_ref52.docType,docType=_ref52$docType===undefined?'_doc':_ref52$docType,doc=_ref52.doc;var params={method:'POST',action:'insert',index:this._botState._.toLower(index),docType:docType,doc:doc};return this._botState.callLambda("elastiSearch",params,"Event").then(function(response){}).catch(function(error){_this125._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:"bulkWriteDataIntoIndex",value:function bulkWriteDataIntoIndex(_ref53){var _this126=this;var index=_ref53.index,_ref53$docType=_ref53.docType,docType=_ref53$docType===undefined?'_doc':_ref53$docType,docs=_ref53.docs,docIdField=_ref53.docIdField;var params={method:'BULK_INSERT',action:'insert',index:this._botState._.toLower(index),docType:docType,docs:docs,docIdField:docIdField};return callLambda('elastiSearch',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this126._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:"updateDataInIndex",value:function updateDataInIndex(_ref54){var _this127=this;var index=_ref54.index,_ref54$docType=_ref54.docType,docType=_ref54$docType===undefined?'_doc':_ref54$docType,doc=_ref54.doc;var params={method:'PUT',docType:docType,index:this._botState._.toLower(index),doc:doc,id:doc.id};return this._botState.callLambda("elastiSearch",params,"Event").then(function(response){}).catch(function(error){_this127._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:"writeTransactionData",value:function writeTransactionData(documents){var tableName='Transactions_'+this._botState.currentUserDomain;return this.writeData(tableName,documents);}},{key:"writeStaticData",value:function writeStaticData(documents){var tableName='KeyValues_'+this._botState.currentUserDomain;return this.writeData(tableName,documents);}},{key:"writeData",value:function writeData(table,documents){var _this128=this;var params={collection:table,documents:documents,capability:'WriteData'};return callLambda('SystemCapabilities',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this128._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:"updateStaticData",value:function updateStaticData(filter,expression,expressionAttributeValues,expressionAttributeNames){var tableName,state,D,frontmLib,updateQueryResponse;return regeneratorRuntime.async(function updateStaticData$(_context159){while(1){switch(_context159.prev=_context159.next){case 0:tableName='KeyValues_'+this._botState.currentUserDomain;state=this._botState;D=state.developer;_context159.prev=3;if(!(this._botState.location===Intent.CLOUD()||this._botState.location===Intent.EDGE()&&this._botState.v1Compatibility)){_context159.next=10;break;}frontmLib=this._botState.frontmlib;_context159.next=8;return regeneratorRuntime.awrap(frontmLib.dbUpdateItem(tableName,filter,expression,expressionAttributeValues,expressionAttributeNames));case 8:updateQueryResponse=_context159.sent;return _context159.abrupt("return",updateQueryResponse);case 10:_context159.next=16;break;case 12:_context159.prev=12;_context159.t0=_context159["catch"](3);D.log({message:'Error updateStaticData::: ',data:JSON.stringify(_context159.t0)});this._botState.addSystemErrorToStack(7,null,_context159.t0.message);case 16:case"end":return _context159.stop();}}},null,this,[[3,12]]);}},{key:"deleteTransactionData",value:function deleteTransactionData(query){var tableName='Transactions_'+this._botState.currentUserDomain;return this.deleteData(tableName,query);}},{key:"deleteStaticData",value:function deleteStaticData(query){var tableName='KeyValues_'+this._botState.currentUserDomain;return this.deleteData(tableName,query);}},{key:"deleteData",value:function deleteData(table,query){var _this129=this;var params={collection:table,query:query,capability:'DeleteData'};return callLambda('SystemCapabilities',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this129._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:"strigifyValue",value:function strigifyValue(value){if(this._.isString(value)){return value;}return this._.isObjectLike(value)?JSON.stringify(value):this._.toString(value);}},{key:"createParamsForAdd",value:function createParamsForAdd(keyValuePairs){var _this130=this;if(!this._.isArray(keyValuePairs)){keyValuePairs=[keyValuePairs];}return keyValuePairs.map(function(keyValue){var key=keyValue.key,value=keyValue.value,expiry=keyValue.expiry,isArrayElement=keyValue.isArrayElement,index=keyValue.index;value=_this130.strigifyValue(value);return{key:key,value:value,expiry:expiry,isArrayElement:isArrayElement,index:index};});}},{key:"callRedisWriteQueue",value:function callRedisWriteQueue(keyValuePairs){var lambdaParams={action:'add',data:keyValuePairs};var size=this._botState.sizeOfObject(JSON.stringify(lambdaParams,null,0));if(size>=200000){}else{}return callLambda('RedisWriteQueue',lambdaParams,this._botState.aws).then(function(response){return JSON.parse(response.Payload);});}},{key:"callRedisDeleteQueue",value:function callRedisDeleteQueue(key){var lambdaParams={action:'delete',key:key};return callLambda('RedisWriteQueue',lambdaParams,this._botState.aws).then(function(response){return JSON.parse(response.Payload);});}},{key:"deleteOneKeyInCache",value:function deleteOneKeyInCache(key){return this.callRedisDeleteQueue(key);}},{key:"setOneValueInCache",value:function setOneValueInCache(key,value){return this.callRedisWriteQueue(this.createParamsForAdd({key:key,value:value}));}},{key:"setOneValueInCacheWithExpiry",value:function setOneValueInCacheWithExpiry(key,value,expiry){var lambdaParams=this.createParamsForAdd({key:key,value:value,expiry:expiry});return this.callRedisWriteQueue(lambdaParams);}},{key:"setMultipleValuesInCache",value:function setMultipleValuesInCache(keyValuePairs){return this.callRedisWriteQueue(this.createParamsForAdd(keyValuePairs));}},{key:"addOneListElementInCache",value:function addOneListElementInCache(key,value){return this.addMultipleListElementInCache({key:key,value:value});}},{key:"updateOneListElementInCache",value:function updateOneListElementInCache(key,value,index){return this.addMultipleListElementInCache({key:key,value:value,index:index});}},{key:"addMultipleListElementInCache",value:function addMultipleListElementInCache(keyValuePairs){if(!this._.isArray(keyValuePairs)){keyValuePairs=[keyValuePairs];}keyValuePairs=keyValuePairs.map(function(keyValue){keyValue.isArrayElement=true;return keyValue;});return this.callRedisWriteQueue(this.createParamsForAdd(keyValuePairs));}},{key:"getValueFromCache",value:function getValueFromCache(key){return this.getMultipleValuesFromCache(key).then(function(data){return data[key];});}},{key:"getMultipleValuesFromCache",value:function getMultipleValuesFromCache(keys){if(!this._.isArray(keys)){keys=[keys];}var lambdaParams={multiKeys:keys};return callLambda('RedisReadQueue',lambdaParams,this._botState.aws).then(function(response){return JSON.parse(response.Payload);});}},{key:"getKeysOnPattern",value:function getKeysOnPattern(pattern){var lambdaParams={pattern:pattern};return callLambda('RedisReadQueue',lambdaParams,this._botState.aws).then(function(response){return JSON.parse(response.Payload);});}},{key:"getUser",value:function getUser(userId){var frontmLib,userData;return regeneratorRuntime.async(function getUser$(_context160){while(1){switch(_context160.prev=_context160.next){case 0:_context160.prev=0;if(!(this._botState.location===Intent.CLOUD()||this._botState.location===Intent.EDGE()&&this._botState.v1Compatibility)){_context160.next=7;break;}frontmLib=this._botState.frontmlib;_context160.next=5;return regeneratorRuntime.awrap(frontmLib.getUser(userId));case 5:userData=_context160.sent;return _context160.abrupt("return",userData);case 7:_context160.next=12;break;case 9:_context160.prev=9;_context160.t0=_context160["catch"](0);this._botState.addSystemErrorToStack(7,null,_context160.t0.message);case 12:case"end":return _context160.stop();}}},null,this,[[0,9]]);}}]);return DB;}();var Surveys=function(){_createClass(Surveys,null,[{key:"SURVEY_DEFINITIONS_COLLECTION",value:function SURVEY_DEFINITIONS_COLLECTION(){return'surveyDefinitions';}},{key:"SURVEY_DOC_CONSTANT",value:function SURVEY_DOC_CONSTANT(){return'surveyDoc_';}},{key:"SURVEY_DOC_STATE_CONSTANT",value:function SURVEY_DOC_STATE_CONSTANT(){return'allSurveysInState';}},{key:"SURVEY_INSTANCE_ID_TITLE",value:function SURVEY_INSTANCE_ID_TITLE(){return'SurveyInstance Id';}},{key:"ALL_SURVEYS_COLLECTION",value:function ALL_SURVEYS_COLLECTION(){return'allSurveys';}},{key:"SURVEY_BASIC_FIELDS",value:function SURVEY_BASIC_FIELDS(){return{SURVEY_USER_ID:'surveyUserId',SURVEY_INSTANCE_ID:'surveyInstanceId',SURVEY_TITLE:'surveyTitle',SURVEY_DATE:'surveyDate',SURVEY_TYPE:'surveyType',NOTIFICATION_ID:'notificationId'};}}]);function Surveys(state){_classCallCheck(this,Surveys);this._botState=state;this._surveys={};}_createClass(Surveys,[{key:"initialiseSurveys",value:function initialiseSurveys(){var _,D,allSurveysObject,allKeys,_i10,key;return regeneratorRuntime.async(function initialiseSurveys$(_context161){while(1){switch(_context161.prev=_context161.next){case 0:_=this._botState._;D=this._botState.developer;allSurveysObject=this._botState.getField(Surveys.SURVEY_DOC_STATE_CONSTANT());if(!(allSurveysObject===null)){_context161.next=5;break;}return _context161.abrupt("return");case 5:allKeys=_.keys(allSurveysObject);_i10=0;case 7:if(!(_i10<allKeys.length)){_context161.next=15;break;}key=allKeys[_i10];if(this._botState.intents[key]){_context161.next=12;break;}_context161.next=12;return regeneratorRuntime.awrap(this.prepareSurveyDefinitionWithId(key));case 12:_i10++;_context161.next=7;break;case 15:case"end":return _context161.stop();}}},null,this);}},{key:"hideNonRequiredFieldFromSurvey",value:function hideNonRequiredFieldFromSurvey(document){var _=this._botState._;var D=this._botState.developer;var allSurveysObject=this._botState.getField(Surveys.SURVEY_DOC_STATE_CONSTANT());if(allSurveysObject!==null){var surveyDefinition=allSurveysObject[_.get(document.f[Surveys.SURVEY_BASIC_FIELDS().SURVEY_TYPE],'value')];_.forEach(document.fields,function(field){field.hidden=true;});_.forEach(surveyDefinition.fields,function(field){document.f[field.id].hidden=false;});}}},{key:"prepareSurveyDefinitionWithId",value:function prepareSurveyDefinitionWithId(id,notificationId){var _this131=this;var createSurveyCollection,_,D,surveyDefinition,array,surveyTitle,options,fields,doc,surveyDoc,query,_d,allSurveysObject;return regeneratorRuntime.async(function prepareSurveyDefinitionWithId$(_context162){while(1){switch(_context162.prev=_context162.next){case 0:createSurveyCollection=function createSurveyCollection(surveyDoc){var surveysCollection=new Collection(Surveys.ALL_SURVEYS_COLLECTION(),{document:surveyDoc,title:'Survey Centre',description:'All surveys',botState:_this131._botState});var c={id:Surveys.ALL_SURVEYS_COLLECTION(),type:'Collection',options:{document:surveyDoc.intentId,title:'Survey Centre',description:'All surveys'}};_this131._botState.addDynamicIntent(c);return surveysCollection;};_=this._botState._;D=this._botState.developer;if(!(typeof id==='string')){_context162.next=45;break;}_context162.next=6;return regeneratorRuntime.awrap(this._botState.db.getDataFromCollection({collection:Surveys.SURVEY_DEFINITIONS_COLLECTION(),query:{surveyId:id}}));case 6:surveyDefinition=_context162.sent;array=_.get(surveyDefinition,'body');if(!(Array.isArray(array)&&array.length===1)){_context162.next=42;break;}surveyTitle=_.get(array[0],Surveys.SURVEY_BASIC_FIELDS().SURVEY_TITLE);options=_.get(array[0],'options');fields=_.get(array[0],'fields');if(!(options&&fields)){_context162.next=39;break;}doc={id:Surveys.SURVEY_DOC_CONSTANT(),type:'Doc',options:options,fields:fields};this._botState.addDynamicIntent(doc);surveyDoc=new Doc(Surveys.SURVEY_DOC_CONSTANT(),this._botState,{title:options.title,description:options.description,confirm:options.confirm,cancel:options.cancel});Field.createNewDynamicField({id:Surveys.SURVEY_BASIC_FIELDS().SURVEY_USER_ID,title:'User Id',type:FormFieldTypes.TEXT_FIELD(),value:this._botState.user.userId,hidden:true},surveyDoc,this._botState);Field.createNewDynamicField({id:Surveys.SURVEY_BASIC_FIELDS().SURVEY_INSTANCE_ID,title:Surveys.SURVEY_INSTANCE_ID_TITLE(),type:FormFieldTypes.TEXT_FIELD(),primaryKey:true,value:this._botState.getUniqueId(),hidden:true},surveyDoc,this._botState);Field.createNewDynamicField({id:Surveys.SURVEY_BASIC_FIELDS().SURVEY_TITLE,title:'Survey Title',type:FormFieldTypes.TEXT_FIELD(),value:surveyTitle,hidden:true},surveyDoc,this._botState);Field.createNewDynamicField({id:Surveys.SURVEY_BASIC_FIELDS().SURVEY_DATE,title:'Survey Date',type:FormFieldTypes.DATETIME(),value:Date.now(),hidden:true},surveyDoc,this._botState);Field.createNewDynamicField({id:Surveys.SURVEY_BASIC_FIELDS().SURVEY_TYPE,title:'Survey Type',type:FormFieldTypes.TEXT_FIELD(),value:id,hidden:true},surveyDoc,this._botState);Field.createNewDynamicField({id:Surveys.SURVEY_BASIC_FIELDS().NOTIFICATION_ID,title:'Notification Id',type:FormFieldTypes.TEXT_FIELD(),value:notificationId,hidden:true},surveyDoc,this._botState);_.forEach(fields,function(field){Field.createNewDynamicField(field,surveyDoc,_this131._botState);});createSurveyCollection(surveyDoc);if(!notificationId){_context162.next=31;break;}query={};query[Surveys.SURVEY_BASIC_FIELDS().NOTIFICATION_ID]=notificationId;_context162.next=29;return regeneratorRuntime.awrap(surveyDoc.loadDocument(query));case 29:_d=_context162.sent;if(_d){surveyDoc.readOnly=true;surveyDoc.confirm='Ok';delete surveyDoc.cancel;}case 31:this._surveys[id]=doc;allSurveysObject=this._botState.getField(Surveys.SURVEY_DOC_STATE_CONSTANT());if(allSurveysObject===null){allSurveysObject={};}allSurveysObject[id]=array[0];this._botState.setField(Surveys.SURVEY_DOC_STATE_CONSTANT(),allSurveysObject);return _context162.abrupt("return",surveyDoc);case 39:this._botState.addSystemErrorToStack(7,'Bad survey definition');case 40:_context162.next=43;break;case 42:this._botState.addSystemErrorToStack(7,'Survey Definition not found');case 43:_context162.next=46;break;case 45:this._botState.addSystemErrorToStack(7,'SurveyId must be string');case 46:case"end":return _context162.stop();}}},null,this);}},{key:"getAllSurveysCollectionForUser",value:function getAllSurveysCollectionForUser(){var D,allSurveysCollection;return regeneratorRuntime.async(function getAllSurveysCollectionForUser$(_context163){while(1){switch(_context163.prev=_context163.next){case 0:D=this._botState.developer;allSurveysCollection=this._botState.intents[Surveys.ALL_SURVEYS_COLLECTION()];if(!allSurveysCollection){_context163.next=5;break;}_context163.next=5;return regeneratorRuntime.awrap(allSurveysCollection.loadCollectionWithQuery({query:{surveyUserId:this._botState.user.userId}}));case 5:return _context163.abrupt("return",allSurveysCollection);case 6:case"end":return _context163.stop();}}},null,this);}},{key:"getBasicSurveyTable",value:function getBasicSurveyTable(){var _,D,surveysCollection,_document3,_i11,_row;return regeneratorRuntime.async(function getBasicSurveyTable$(_context164){while(1){switch(_context164.prev=_context164.next){case 0:_=this._botState._;D=this._botState.developer;_context164.next=4;return regeneratorRuntime.awrap(this.getAllSurveysCollectionForUser());case 4:surveysCollection=_context164.sent;if(!surveysCollection){_context164.next=19;break;}_document3=surveysCollection.document;_.forEach(_.get(_document3,'fields'),function(field){if(field.id===Surveys.SURVEY_BASIC_FIELDS().SURVEY_TITLE||field.id===Surveys.SURVEY_BASIC_FIELDS().SURVEY_DATE){field.hidden=false;}else{field.hidden=true;}});surveysCollection.actionableRows=true;_i11=0;case 10:if(!(_i11<surveysCollection.rows.length)){_context164.next=18;break;}_row=surveysCollection.rows[_i11];_context164.next=14;return regeneratorRuntime.awrap(this.prepareSurveyDefinitionWithId(_.get(_row.f[Surveys.SURVEY_BASIC_FIELDS().SURVEY_TYPE],'value')));case 14:_.forEach(_.get(_row,'fields'),function(field){if(field.id===Surveys.SURVEY_BASIC_FIELDS().SURVEY_TITLE||field.id===Surveys.SURVEY_BASIC_FIELDS().SURVEY_DATE){field.hidden=false;}else{field.hidden=true;}});case 15:_i11++;_context164.next=10;break;case 18:;case 19:return _context164.abrupt("return",surveysCollection);case 20:case"end":return _context164.stop();}}},null,this);}},{key:"surveys",get:function get(){return this._surveys;}}]);return Surveys;}();var ContactCentre=function(){_createClass(ContactCentre,null,[{key:"WAITING_STATUS",value:function WAITING_STATUS(){return'Waiting';}},{key:"WAITING_VESSEL_STATUS",value:function WAITING_VESSEL_STATUS(){return'WaitingVessel';}},{key:"ACTIVE_STATUS",value:function ACTIVE_STATUS(){return'Active';}},{key:"ENDED_STATUS",value:function ENDED_STATUS(){return'Ended';}},{key:"MISSED_STATUS",value:function MISSED_STATUS(){return'Missed';}},{key:"MISSED_CALL_TEXT",value:function MISSED_CALL_TEXT(){return'Missed call';}},{key:"CONTACT_CENTRE_APP",value:function CONTACT_CENTRE_APP(){return'callCentreBot';}},{key:"CLIENT_APP",value:function CLIENT_APP(){return'clientBot';}},{key:"MANAGER_APP",value:function MANAGER_APP(){return'shiftManagerBot';}}]);function ContactCentre(botState){_classCallCheck(this,ContactCentre);this['_botState']=botState;this['_']=botState._;}_createClass(ContactCentre,[{key:"getBotIDs",value:function getBotIDs(key){var query,response,items,botIDs;return regeneratorRuntime.async(function getBotIDs$(_context165){while(1){switch(_context165.prev=_context165.next){case 0:query=[{operand:'dataKey',value:key,operator:'eq'}];_context165.next=3;return regeneratorRuntime.awrap(this._botState.db.getStaticData(query));case 3:response=_context165.sent;items=this._.get(response,'items');if(!(Array.isArray(items)&&items.length>0)){_context165.next=9;break;}botIDs=items[0].value;if(!(this._.size(botIDs)>0)){_context165.next=9;break;}return _context165.abrupt("return",botIDs);case 9:case"end":return _context165.stop();}}},null,this);}},{key:"loadContactCentreTeam",value:function loadContactCentreTeam(contactCentreBotId){var SHIFT_MANAGER_KEY_PREFIX,pattern,response;return regeneratorRuntime.async(function loadContactCentreTeam$(_context166){while(1){switch(_context166.prev=_context166.next){case 0:if(!contactCentreBotId){_context166.next=13;break;}_context166.prev=1;SHIFT_MANAGER_KEY_PREFIX='CONTACT_CENTRE_SHIFT_';pattern=SHIFT_MANAGER_KEY_PREFIX+"_"+contactCentreBotId+"*";_context166.next=6;return regeneratorRuntime.awrap(this._botState.db.getKeysOnPattern(pattern));case 6:response=_context166.sent;return _context166.abrupt("return",response);case 10:_context166.prev=10;_context166.t0=_context166["catch"](1);botState.addSystemErrorToStack(100,"Error reading call centre staff "+this._botState.R.toString(_context166.t0));case 13:case"end":return _context166.stop();}}},null,this,[[1,10]]);}},{key:"getTranscriptionForCurrentConversation",value:function getTranscriptionForCurrentConversation(_ref55){var epochTime=_ref55.epochTime,bot=_ref55.bot,conversation=_ref55.conversation;var params;return regeneratorRuntime.async(function getTranscriptionForCurrentConversation$(_context167){while(1){switch(_context167.prev=_context167.next){case 0:params={capability:'ArchivedMessagesReader',action:'getPaginatedMessages',conversationId:this._botState._.get(conversation,'conversationId')||this._botState.conversationId,bot:bot||this._botState.conversation.bot,sync:true,conversation:conversation||this._botState.conversation,capabilityDomain:this._botState.currentUserDomain,userEmail:this._botState.user.userEmail,userId:this._botState.user.userId,userDomain:this._botState.userDomains};return _context167.abrupt("return",callLambda('ArchivedMessagesReader',params,this._botState.aws).then(function(response){var payload=JSON.parse(response.Payload);return payload;}));case 2:case"end":return _context167.stop();}}},null,this);}},{key:"addEntryToContactCentreQueue",value:function addEntryToContactCentreQueue(entry,contactCentreBot){var chatForm,conversationToQueue,CONTACT_CENTRE_CACHE,OPEN_STATUS,key;return regeneratorRuntime.async(function addEntryToContactCentreQueue$(_context168){while(1){switch(_context168.prev=_context168.next){case 0:_context168.prev=0;chatForm=this._botState._.cloneDeep(entry);chatForm.botDetails=this._botState._.cloneDeep(contactCentreBot);chatForm.userId=this._botState.user.userId;conversationToQueue={ticket:Math.round(Math.random()*(99999999-1)+1),content:chatForm,createdOn:Date.now(),open:true,status:ContactCentre.WAITING_STATUS(),botId:this._botState.conversation.bot,conversationId:this._botState.conversationId,userId:this._botState.user.userId};CONTACT_CENTRE_CACHE='CONTACT_CENTRE_';OPEN_STATUS='open';key=CONTACT_CENTRE_CACHE+"_"+OPEN_STATUS+"_"+this._botState.conversation.bot+"_"+this._botState.conversationId;_context168.next=10;return regeneratorRuntime.awrap(this._botState.db.setOneValueInCacheWithExpiry(key,conversationToQueue,3600*24*7));case 10:return _context168.abrupt("return",conversationToQueue);case 13:_context168.prev=13;_context168.t0=_context168["catch"](0);this._botState.addSystemErrorToStack(5,"Error adding entry to queue "+_context168.t0);case 16:case"end":return _context168.stop();}}},null,this,[[0,13]]);}},{key:"closeEntryInContactCentreQueue",value:function closeEntryInContactCentreQueue(entry){var CONTACT_CENTRE_CACHE,OPEN_STATUS,key;return regeneratorRuntime.async(function closeEntryInContactCentreQueue$(_context169){while(1){switch(_context169.prev=_context169.next){case 0:entry.open=false;entry.owner=this._botState.user.userId;CONTACT_CENTRE_CACHE='CONTACT_CENTRE_';OPEN_STATUS='open';key=CONTACT_CENTRE_CACHE+"_"+OPEN_STATUS+"_"+entry.botId+"_"+entry.conversationId;_context169.next=7;return regeneratorRuntime.awrap(this._botState.db.setOneValueInCacheWithExpiry(key,entry,3600*24*7));case 7:return _context169.abrupt("return",entry);case 8:case"end":return _context169.stop();}}},null,this);}},{key:"changeQueueEntryStatus",value:function changeQueueEntryStatus(entry,status){var CONTACT_CENTRE_CACHE,OPEN_STATUS,key;return regeneratorRuntime.async(function changeQueueEntryStatus$(_context170){while(1){switch(_context170.prev=_context170.next){case 0:entry.status=status;CONTACT_CENTRE_CACHE='CONTACT_CENTRE_';OPEN_STATUS='open';key=CONTACT_CENTRE_CACHE+"_"+OPEN_STATUS+"_"+entry.botId+"_"+entry.conversationId;_context170.next=6;return regeneratorRuntime.awrap(this._botState.db.setOneValueInCacheWithExpiry(key,entry,3600*24*7));case 6:return _context170.abrupt("return",entry);case 7:case"end":return _context170.stop();}}},null,this);}},{key:"changeQueueVideoSessionId",value:function changeQueueVideoSessionId(entry,videoSessionId){var CONTACT_CENTRE_CACHE,OPEN_STATUS,key;return regeneratorRuntime.async(function changeQueueVideoSessionId$(_context171){while(1){switch(_context171.prev=_context171.next){case 0:entry.content.videoSessionId=videoSessionId;CONTACT_CENTRE_CACHE='CONTACT_CENTRE_';OPEN_STATUS='open';key=CONTACT_CENTRE_CACHE+"_"+OPEN_STATUS+"_"+entry.botId+"_"+entry.conversationId;_context171.next=6;return regeneratorRuntime.awrap(this._botState.db.setOneValueInCacheWithExpiry(key,entry,3600*24*7));case 6:return _context171.abrupt("return",entry);case 7:case"end":return _context171.stop();}}},null,this);}},{key:"storeQueueEntry",value:function storeQueueEntry(entry){var CONTACT_CENTRE_CACHE,OPEN_STATUS,key;return regeneratorRuntime.async(function storeQueueEntry$(_context172){while(1){switch(_context172.prev=_context172.next){case 0:CONTACT_CENTRE_CACHE='CONTACT_CENTRE_';OPEN_STATUS='open';key=CONTACT_CENTRE_CACHE+"_"+OPEN_STATUS+"_"+entry.botId+"_"+entry.conversationId;_context172.next=5;return regeneratorRuntime.awrap(this._botState.db.setOneValueInCacheWithExpiry(key,entry,3600*24*7));case 5:return _context172.abrupt("return",entry);case 6:case"end":return _context172.stop();}}},null,this);}},{key:"loadConversationsInQueue",value:function loadConversationsInQueue(botId){var botToLoad,CONTACT_CENTRE_CACHE,OPEN_STATUS,pattern,response,parsedResponse,R;return regeneratorRuntime.async(function loadConversationsInQueue$(_context173){while(1){switch(_context173.prev=_context173.next){case 0:_context173.prev=0;botToLoad=botId||this._botState.conversation.bot;CONTACT_CENTRE_CACHE='CONTACT_CENTRE_';OPEN_STATUS='open';pattern=CONTACT_CENTRE_CACHE+"_"+OPEN_STATUS+"_"+botToLoad+"*";_context173.next=7;return regeneratorRuntime.awrap(this._botState.db.getKeysOnPattern(pattern));case 7:response=_context173.sent;parsedResponse=[];R=this._botState.R;this._botState._.forEach(response,function(conversation){var parsedConversation=JSON.parse(conversation.content);var i=0;while(i<parsedResponse.length&&parsedConversation.createdOn>parsedResponse[i].createdOn){i++;}parsedResponse.splice(i,0,parsedConversation);});return _context173.abrupt("return",parsedResponse);case 14:_context173.prev=14;_context173.t0=_context173["catch"](0);this._botState.addSystemErrorToStack(100,"Error reading conversations "+this._botState.R.toString(_context173.t0));case 17:case"end":return _context173.stop();}}},null,this,[[0,14]]);}},{key:"getQueueEntry",value:function getQueueEntry(_ref56){var videoSessionId=_ref56.videoSessionId,botId=_ref56.botId,ticket=_ref56.ticket;var parsedQueue,index,_i12;return regeneratorRuntime.async(function getQueueEntry$(_context174){while(1){switch(_context174.prev=_context174.next){case 0:_context174.next=2;return regeneratorRuntime.awrap(this.loadConversationsInQueue(botId));case 2:parsedQueue=_context174.sent;index=-1;for(_i12=0;_i12<parsedQueue.length;_i12++){if(videoSessionId&&parsedQueue[_i12].content.videoSessionId===videoSessionId||ticket&&parsedQueue[_i12].ticket===ticket){index=_i12;}}return _context174.abrupt("return",parsedQueue[index]);case 6:case"end":return _context174.stop();}}},null,this);}},{key:"loadConversationsForBot",value:function loadConversationsForBot(botId,pagination,sort){var size,from,docQuery,rangeDuration,allConversations,finalResponse;return regeneratorRuntime.async(function loadConversationsForBot$(_context175){while(1){switch(_context175.prev=_context175.next){case 0:_context175.prev=0;size=this._botState._.get(pagination,'size')||6;from=this._botState._.get(pagination,'from')||0;docQuery={_source:['conversationId','createdOn','modifiedOn','duration'],query:{bool:{must:{term:{bot:botId}}}},sort:{createdOn:{order:'desc'}},size:size};rangeDuration={duration:{gte:10000}};if(from===0){docQuery.query.bool.filter={range:rangeDuration};}else{docQuery.query.bool.filter=[{range:rangeDuration},{range:{createdOn:{lt:from}}}];}_context175.next=8;return regeneratorRuntime.awrap(this._botState.db.getDataFromIndexWithQueryObject(DB.CONVERSATIONS_INDEX(),docQuery));case 8:allConversations=_context175.sent;finalResponse=[];this._botState._.forEach(allConversations,function(conversation){finalResponse.push(conversation);});return _context175.abrupt("return",finalResponse);case 14:_context175.prev=14;_context175.t0=_context175["catch"](0);this._botState.addSystemErrorToStack(100,"Error reading conversations "+this._botState.R.toString(_context175.t0));case 17:case"end":return _context175.stop();}}},null,this,[[0,14]]);}},{key:"loadConversationData",value:function loadConversationData(conversationId){var tableName,query;return regeneratorRuntime.async(function loadConversationData$(_context176){while(1){switch(_context176.prev=_context176.next){case 0:_context176.prev=0;tableName='Conversations';query=[{operand:'conversationId',value:conversationId,operator:'eq'}];return _context176.abrupt("return",this._botState.db.getData(tableName,query));case 6:_context176.prev=6;_context176.t0=_context176["catch"](0);this._botState.addSystemErrorToStack(100,"Error reading conversations "+this._botState.R.toString(_context176.t0));case 9:case"end":return _context176.stop();}}},null,this,[[0,6]]);}},{key:"getConfigurationForKey",value:function getConfigurationForKey(key){var _this132=this;var query,returnResponse,STATIC_DATA,response,_response;return regeneratorRuntime.async(function getConfigurationForKey$(_context177){while(1){switch(_context177.prev=_context177.next){case 0:query=[{operand:'dataKey',value:key,operator:'eq'}];returnResponse=function returnResponse(response){var items=_this132._botState._.get(response,'items');if(Array.isArray(items)&&items.length>0){var botIDs=items[0].value;return botIDs;}};STATIC_DATA='staticData';if(!(this._botState.location===Intent.CLOUD()||this._botState.client===State.WEBCLIENT()||this._botState.location===Intent.EDGE()&&this._botState.v1Compatibility)){_context177.next=11;break;}_context177.next=6;return regeneratorRuntime.awrap(this._botState.db.getStaticData(query));case 6:response=_context177.sent;this._botState.addObjectToSyncMessage(STATIC_DATA,key,response);return _context177.abrupt("return",returnResponse(response));case 11:this._botState.developer.log({message:'Reading from local'});_context177.next=14;return regeneratorRuntime.awrap(this._botState.deviceStorage.loadDocument(STATIC_DATA,this._botState.sha1(key)));case 14:_response=_context177.sent;return _context177.abrupt("return",returnResponse(_response));case 16:case"end":return _context177.stop();}}},null,this);}}]);return ContactCentre;}();var API=function(){function API(botState){_classCallCheck(this,API);this['_botState']=botState;this['_']=botState._;}_createClass(API,[{key:"loadServicesForMyDomains",value:function loadServicesForMyDomains(){var tableName='APIParameters';var query=[{operand:'userDomain',value:this._botState.currentUserDomain,operator:'eq'}];return this._botState.db.getData(tableName,query);}},{key:"createNewService",value:function createNewService(service){var tableName,response;return regeneratorRuntime.async(function createNewService$(_context178){while(1){switch(_context178.prev=_context178.next){case 0:tableName='APIParameters';_context178.next=3;return regeneratorRuntime.awrap(this._botState.db.writeData(tableName,service));case 3:response=_context178.sent;if(this._.get(response,"errorMessage")){this._botState.addSystemErrorToStack(36);}case 5:case"end":return _context178.stop();}}},null,this);}},{key:"callService",value:function callService(service,options){var _this133=this;var params={capability:'GetDataFromAPI',capabilityFileName:'getDataFromApi',userDomain:this._botState.conversation.userDomain,serviceName:service,queryParams:this._.get(options,'queryParams'),pathParams:this._.get(options,'pathParams'),header:this._.get(options,'header'),body:this._.get(options,'body'),sync:true,userId:this._botState.user.userId,conversation:this._botState.conversation};try{return this._botState.callCapability(params).then(function(response){_this133._botState.developer.info({message:'Returned from service successfully',data:_this133._botState.R.toString(response)});if(_this133._.get(response,'error')){_this133._botState.addSystemErrorToStack(37,response.error,response);}return response;}).catch(function(error){_this133._botState.addSystemErrorToStack(37,error.message,params);return error;});}catch(err){this._botState.addSystemErrorToStack(37,err.message,params);}}},{key:"createUser",value:function createUser(userDetailsArray,emailTemplateName,delayRequired){var _this134=this;var params={users:userDetailsArray,domain:this._botState.currentUserDomain,delayRequired:typeof delayRequired===undefined?true:delayRequired,emailTemplateName:emailTemplateName};var invocationType="RequestResponse";if(this._botState.messageTypeFromUser==="payload"){invocationType="Event";}return this._botState.callLambda("CreateUserLambda",params,invocationType).then(function(response){_this134._botState.developer.info({message:'Returned from service create user',data:response});var payload=JSON.parse(_this134._botState._.get(response,"Payload"));if(_this134._.get(payload,'error')){_this134._botState.addSystemErrorToStack(7,payload.error);}return payload;}).catch(function(error){_this134._botState.addSystemErrorToStack(7,error.errorMessage);_this134._botState.developer.log({message:'Returned with error',data:error});return error;});}},{key:"deleteUser",value:function deleteUser(userIds){var _this135=this;var params;return regeneratorRuntime.async(function deleteUser$(_context179){while(1){switch(_context179.prev=_context179.next){case 0:params={capability:"DeleteUser",capabilityFileName:"deleteUser",appType:this._botState.currentUserDomain};if(!Array.isArray(userIds)){_context179.next=4;break;}if(userIds.length==1){params.action="deleteUser";params.userId=userIds[0];}else{params.action="deleteMultipleUsers";params.userIdsToDelete=userIds;}return _context179.abrupt("return",this._botState.callCapability(params).then(function(response){_this135._botState.developer.info({message:'DeleteUser response',data:response});if(_this135._.get(response,'error')){_this135._botState.addSystemErrorToStack(7,response.error);}return response;}).catch(function(error){_this135._botState.addSystemErrorToStack(7,error.errorMessage);_this135._botState.developer.log({message:'DeleteUser Returned with error',data:error});return error;}));case 4:return _context179.abrupt("return",false);case 5:case"end":return _context179.stop();}}},null,this);}},{key:"authenticateUser",value:function authenticateUser(_ref57){var _this136=this;var _ref57$appType=_ref57.appType,appType=_ref57$appType===undefined?'frontmai':_ref57$appType,userEmail=_ref57.userEmail,password=_ref57.password,otpToken=_ref57.otpToken;var params;return regeneratorRuntime.async(function authenticateUser$(_context180){while(1){switch(_context180.prev=_context180.next){case 0:params={capability:"AuthCapability",capabilityFileName:"authCapability",appType:appType,userEmail:userEmail,password:password,action:"AuthenticateUser",otpToken:otpToken};return _context180.abrupt("return",this._botState.callCapability(params).then(function(response){return _this136._.get(response,'success');}).catch(function(error){_this136._botState.developer.log({message:'Authenticate user returned with error',data:error});return _this136._.get(error,'success');}));case 2:case"end":return _context180.stop();}}},null,this);}},{key:"encodeFile",value:function encodeFile(fileName){var params;return regeneratorRuntime.async(function encodeFile$(_context181){while(1){switch(_context181.prev=_context181.next){case 0:params={capability:'ConversationFilesCapability',capabilityFileName:'conversationFilesCapability',targetConversationId:this._botState.conversationId,targetFileName:fileName,conversation:this._botState.conversation,sync:true,email:this._botState.user.userEmail,userId:this._botState.user.userId};_context181.next=3;return regeneratorRuntime.awrap(this._botState.callCapability(params));case 3:return _context181.abrupt("return",_context181.sent);case 4:case"end":return _context181.stop();}}},null,this);}},{key:"sendResponse",value:function sendResponse(_ref58){var _ref58$code=_ref58.code,code=_ref58$code===undefined?200:_ref58$code,_ref58$response=_ref58.response,response=_ref58$response===undefined?{}:_ref58$response;var finalResponse;return regeneratorRuntime.async(function sendResponse$(_context182){while(1){switch(_context182.prev=_context182.next){case 0:finalResponse=_extends({code:code},response);this._botState.apiResponse=true;this._botState.addResponse("payload_response",finalResponse);case 3:case"end":return _context182.stop();}}},null,this);}}]);return API;}();var JobScheduler=function(){function JobScheduler(botState){_classCallCheck(this,JobScheduler);this['_botState']=botState;this['_']=botState._;}_createClass(JobScheduler,[{key:"addNewJob",value:function addNewJob(client,params,jobId,repeats){var scheduleJobParams={jobId:jobId,capability:'ScheduleBatchJob',conversation:this._botState.conversation,params:this._botState.cleanFieldsForSave(params),repeats:repeats,requestUuid:this._botState.getUniqueId(),scheduledCapability:this._botState.conversation.bot+'_CustomCap',userEmail:this._botState.user.userEmail,userId:this._botState.user.userId,userDomain:this._botState.conversation.userDomain,botId:this._botState.conversation.bot,client:client,schedule:this._.get(params,'schedule')};return callLambda('SystemCapabilities',scheduleJobParams,this._botState.aws).then(function(response){return JSON.parse(response.Payload);});}},{key:"scheduleMessage",value:function scheduleMessage(_ref59){var _this137=this;var _ref59$toBot=_ref59.toBot,toBot=_ref59$toBot===undefined?this._botState.conversation.bot:_ref59$toBot,toUser=_ref59.toUser,messages=_ref59.messages,_ref59$jobId=_ref59.jobId,jobId=_ref59$jobId===undefined?this._botState.getUniqueId():_ref59$jobId,_ref59$schedule=_ref59.schedule,schedule=_ref59$schedule===undefined?Date.now():_ref59$schedule,repeats=_ref59.repeats,_ref59$client=_ref59.client,client=_ref59$client===undefined?State.WEBCLIENT():_ref59$client,_ref59$realTimeMessag=_ref59.realTimeMessage,realTimeMessage=_ref59$realTimeMessag===undefined?true:_ref59$realTimeMessag,_ref59$v1Compatibilit=_ref59.v1Compatibility,v1Compatibility=_ref59$v1Compatibilit===undefined?false:_ref59$v1Compatibilit;var requestUuid=this._botState.getUniqueId();var generateFullMessageForMessage=function generateFullMessageForMessage(msg){var messageToSend=msg;if(!realTimeMessage){var _state2=toBot===_this137._botState.botId?_this137._botState.stateToBackEnd():{state:{}};_state2.state.messageFromUser=msg;_state2.state.messageTypeFromUser='object';_state2.state.fromGreeting=false;_state2.state.responsesArray=[];_state2.state._syncToCloud={};_state2.state._syncToEdge={};_state2.state._activeIntent='';if(!realTimeMessage&&v1Compatibility){_state2.state.v1Compatibility=true;}messageToSend=_state2;}return{content:[messageToSend],contentType:MessageTypes.BOT_TO_BOT(),requestUuid:requestUuid,createdBy:_this137._botState.user.userId,createdOn:Date.now(),messageId:_this137._botState.getUniqueId()};};var _=this._botState._;var allMessages=[];if(Array.isArray(messages)){_.forEach(messages,function(msg){allMessages.push(generateFullMessageForMessage(msg));});}else{allMessages.push(generateFullMessageForMessage(messages));}var params={target:{bot:toBot,users:Array.isArray(toUser)?toUser:toUser?[toUser]:toUser,userDomain:this._botState.currentUserDomain},action:'get',bot:this._botState.conversation.bot||_.get(this._botState.context,'botManifest.botId'),sync:true,userDomain:this._botState.conversation.userDomain,email:this._botState.user.userEmail,conversation:this._botState.conversation,requestUuid:requestUuid,messages:allMessages,realTimeMessage:realTimeMessage};var scheduleJobParams={jobId:jobId,capability:'ScheduleBatchJob',conversation:this._botState.conversation,params:params,repeats:repeats,requestUuid:requestUuid,scheduledCapability:'BroadCastMessageCapability',userEmail:this._botState.user.userEmail,userId:this._botState.user.userId,userDomain:this._botState.conversation.userDomain,botId:this._botState.conversation.bot,client:client,schedule:schedule};return callLambda('SystemCapabilities',scheduleJobParams,this._botState.aws).then(function(response){return JSON.parse(response.Payload);});}},{key:"deleteJob",value:function deleteJob(jobId){var scheduleJobParams={jobId:jobId,capability:'DeleteBatchJob'};return callLambda('SystemCapabilities',scheduleJobParams,this._botState.aws);}},{key:"scheduleLocalJob",value:function scheduleLocalJob(jobId,interval){var bgTaskOptions={key:jobId,botId:this._botState.context.botManifest.botId,timeInterval:interval,conversationId:this._botState.conversationId};var backgroundTaskQueue=this._botState.context.getCapability('BackgroundTaskQueue');return backgroundTaskQueue.enqueue(bgTaskOptions);}},{key:"stopLocalJob",value:function stopLocalJob(jobId){var backgroundTaskQueue=this._botState.context.getCapability('BackgroundTaskQueue');var bgTaskOptions={key:jobId,botId:this._botState.context.botManifest.botId,conversationId:this._botState.conversationId};return backgroundTaskQueue.dequeue(bgTaskOptions);}}]);return JobScheduler;}();var FormFieldTypes=function(){function FormFieldTypes(){_classCallCheck(this,FormFieldTypes);}_createClass(FormFieldTypes,null,[{key:"TEXT_FIELD",value:function TEXT_FIELD(){return'text_field';}},{key:"NUMBER_FIELD",value:function NUMBER_FIELD(){return'number';}},{key:"TEXT_AREA",value:function TEXT_AREA(){return'text_area';}},{key:"CHECKBOX",value:function CHECKBOX(){return'checkbox';}},{key:"RADIOBUTTON",value:function RADIOBUTTON(){return'radiobutton';}},{key:"DROPDOWN",value:function DROPDOWN(){return'dropdown';}},{key:"SWITCH",value:function SWITCH(){return'switch';}},{key:"SLIDER",value:function SLIDER(){return'slider';}},{key:"DATE",value:function DATE(){return'date';}},{key:"DATETIME",value:function DATETIME(){return'datetime';}},{key:"TIME",value:function TIME(){return'time';}},{key:"MULTI_SELECTION",value:function MULTI_SELECTION(){return'multi_selection';}},{key:"PASSWORD_FIELD",value:function PASSWORD_FIELD(){return'password_field';}},{key:"LOOKUP",value:function LOOKUP(){return'lookup';}},{key:"IMAGE_FIELD",value:function IMAGE_FIELD(){return'image_field';}},{key:"VIDEO_FIELD",value:function VIDEO_FIELD(){return'video_field';}},{key:"FILE_FIELD",value:function FILE_FIELD(){return'file_field';}},{key:"BUTTONS_FIELD",value:function BUTTONS_FIELD(){return'buttons_field';}},{key:"CHAT_FIELD",value:function CHAT_FIELD(){return'chat_field';}},{key:"VIDEO_CALL_FIELD",value:function VIDEO_CALL_FIELD(){return'video_call_field';}},{key:"VOICE_CALL_FIELD",value:function VOICE_CALL_FIELD(){return'voice_call_field';}},{key:"ROW_MENU_FIELD",value:function ROW_MENU_FIELD(){return'row_menu_field';}},{key:"COLOR_FIELD",value:function COLOR_FIELD(){return'color_field';}},{key:"ALERT_FIELD",value:function ALERT_FIELD(){return'alert_field';}},{key:"COORDINATES",value:function COORDINATES(){return'coordinates_field';}},{key:"GEO_POINT_FIELD",value:function GEO_POINT_FIELD(){return'geo_point_field';}},{key:"GEO_AREA_FIELD",value:function GEO_AREA_FIELD(){return'geo_area_field';}},{key:"OBJECT_DROPDOWN",value:function OBJECT_DROPDOWN(){return'object_dropdown';}},{key:"OBJECT_LOOKUP",value:function OBJECT_LOOKUP(){return'object_lookup';}},{key:"OBJECT_MULTI_SELECTION",value:function OBJECT_MULTI_SELECTION(){return'object_multi_selection';}},{key:"MAP_AREA",value:function MAP_AREA(){return'map_area';}},{key:"MAP_DATA",value:function MAP_DATA(){return'map_data';}},{key:"PHONE_NUMBER_FIELD",value:function PHONE_NUMBER_FIELD(){return'phone_number';}},{key:"EMAIL_FIELD",value:function EMAIL_FIELD(){return'email_field';}},{key:"COLOR_PICKER_FIELD",value:function COLOR_PICKER_FIELD(){return'color_picker';}},{key:"ICON_FIELD",value:function ICON_FIELD(){return'icon_field';}}]);return FormFieldTypes;}();var Schedules=function(){_createClass(Schedules,null,[{key:"SCHD_INDEX",value:function SCHD_INDEX(){return'scheduler';}},{key:"SCHD_MASTER_DB",value:function SCHD_MASTER_DB(){return'schedulerMaster';}},{key:"SCHD_DETAIL_DB",value:function SCHD_DETAIL_DB(){return'schedulerDetail';}}]);function Schedules(botState){_classCallCheck(this,Schedules);this['_botState']=botState;this['_']=botState._;var capabilities=botState.context.capabilities.capabilities;var context=null;if(capabilities){context=botState.context.capabilities;}else{context=botState.context;}this['_context']=context;this['userId']=botState.user.userId;this['conversation']=botState.conversation;this['location']=botState.location;}_createClass(Schedules,[{key:"_validateResources",value:function _validateResources(resourceData){var domain=resourceData.domain,resourceName=resourceData.resourceName,resourceId=resourceData.resourceId,resourceType=resourceData.resourceType,resourceSubType=resourceData.resourceSubType,availStartTime=resourceData.availStartTime,availEndTime=resourceData.availEndTime,dailyStartTime=resourceData.dailyStartTime,dailyEndTime=resourceData.dailyEndTime,weeklyOffDays=resourceData.weeklyOffDays,adhocOffTime=resourceData.adhocOffTime;if(!domain||!resourceName||!resourceId||!resourceType||!resourceSubType||!availStartTime||!availEndTime)return false;if(availStartTime>=availEndTime)return false;if(dailyStartTime&&dailyStartTime<0)return false;if(dailyEndTime&&dailyEndTime>24)return false;if(weeklyOffDays&&!Array.isArray(weeklyOffDays))return false;if(adhocOffTime&&!Array.isArray(adhocOffTime))return false;return true;}},{key:"_getWeekdaysBetweenDates",value:function _getWeekdaysBetweenDates(inReqStartTime,inReqEndTime,tz){var momentTimeZone=this._context.momentTimeZone;var momentStart=momentTimeZone.tz(inReqStartTime,tz);var momentFinal=momentTimeZone.tz(inReqEndTime,tz);var diff=momentFinal.diff(momentStart,"days");if(diff>=7){return momentTimeZone.weekdays();}var firstDay=momentStart.day();var weekdaysBetween=[];for(var _i13=0;_i13<=diff;_i13++){weekdaysBetween.push(momentTimeZone.weekdays((firstDay+_i13)%7));}return weekdaysBetween;}},{key:"_extractTimeDetails",value:function _extractTimeDetails(inReqStartTime,inReqEndTime,resourceTimezone){var enteredTz=resourceTimezone||"GMT +00:00 (Etc/GMT)";var timezoneString=enteredTz?enteredTz.split("(")[1].substring(0,enteredTz.split("(")[1].length-1):"Etc/GMT";var _context183=this._context,moment=_context183.moment,momentTimeZone=_context183.momentTimeZone;var reqStartHrs=momentTimeZone.tz(inReqStartTime,timezoneString).hours();var reqEndHrs=momentTimeZone.tz(inReqEndTime,timezoneString).hours();var reqIsMultiDay=!momentTimeZone.tz(inReqStartTime,timezoneString).isSame(momentTimeZone.tz(inReqEndTime,timezoneString),'day');var reqWeekDays=this._getWeekdaysBetweenDates(inReqStartTime,inReqEndTime,timezoneString);return{reqStartHrs:reqStartHrs,reqEndHrs:reqEndHrs,reqIsMultiDay:reqIsMultiDay,reqWeekDays:reqWeekDays};}},{key:"_checkAdhocOffTime",value:function _checkAdhocOffTime(adhocSlots,inReqStartTime,inReqEndTime){var _=this._;var offTimeConflict=false;if(!adhocSlots||!Array.isArray(adhocSlots)||adhocSlots.length<1)return offTimeConflict;_.forEach(adhocSlots,function(slot){if(inReqStartTime>slot.endTime||inReqEndTime<slot.startTime){return true;}else{offTimeConflict=true;return false;}});return offTimeConflict;}},{key:"_checkConflictingBookings",value:function _checkConflictingBookings(id,inReqStartTime,inReqEndTime,scheduleIdArr){var _,bookingConflict,finalScheduleDataArr,additionalQuery,_iterator3,_isArray3,_i14,_ref60,schedule,scheduleData,initialOrQuery,query,responsesArray,allResponses,finalAllresponses;return regeneratorRuntime.async(function _checkConflictingBookings$(_context184){while(1){switch(_context184.prev=_context184.next){case 0:_=this._;bookingConflict=false;if(!(!id||!inReqStartTime||!inReqEndTime)){_context184.next=4;break;}return _context184.abrupt("return",bookingConflict);case 4:finalScheduleDataArr=[];additionalQuery=[];if(!(scheduleIdArr&&scheduleIdArr.length)){_context184.next=26;break;}_iterator3=scheduleIdArr,_isArray3=Array.isArray(_iterator3),_i14=0,_iterator3=_isArray3?_iterator3:_iterator3[typeof Symbol==="function"?typeof Symbol==="function"?Symbol.iterator:"@@iterator":"@@iterator"]();case 8:if(!_isArray3){_context184.next=14;break;}if(!(_i14>=_iterator3.length)){_context184.next=11;break;}return _context184.abrupt("break",25);case 11:_ref60=_iterator3[_i14++];_context184.next=18;break;case 14:_i14=_iterator3.next();if(!_i14.done){_context184.next=17;break;}return _context184.abrupt("break",25);case 17:_ref60=_i14.value;case 18:schedule=_ref60;_context184.next=21;return regeneratorRuntime.awrap(this._botState.db.getDataFromCollection({collection:Schedules.SCHD_DETAIL_DB(),action:'query',query:{_id:schedule},projection:{},sort:{},skip:0,limit:1,collation:{},expectOneResult:false,cache:false}));case 21:scheduleData=_context184.sent;if(scheduleData&&scheduleData.statusCode==200&&scheduleData.body&&scheduleData.body.length){finalScheduleDataArr.push(scheduleData.body[0]);}case 23:_context184.next=8;break;case 25:additionalQuery=finalScheduleDataArr.map(function(entry){return{$and:[{bookedStartTime:{$eq:entry.bookedStartTime}},{bookedEndTime:{$eq:entry.bookedEndTime}}]};});case 26:initialOrQuery=[{"$and":[{"bookedStartTime":{"$lte":inReqStartTime}},{"bookedEndTime":{"$gt":inReqStartTime}}]},{"$and":[{"bookedStartTime":{"$lt":inReqEndTime}},{"bookedEndTime":{"$gt":inReqEndTime}}]},{"$and":[{"bookedStartTime":{"$gt":inReqStartTime}},{"bookedEndTime":{"$lte":inReqEndTime}}]}];query={"$and":[{"origId":id},{"$or":[].concat(_toConsumableArray(additionalQuery),initialOrQuery)}]};_context184.next=30;return regeneratorRuntime.awrap(this._botState.db.getDataFromCollection({collection:Schedules.SCHD_DETAIL_DB(),action:'query',query:query,projection:{},sort:{},skip:0,limit:1,collation:{},expectOneResult:false,cache:false}));case 30:responsesArray=_context184.sent;if(responsesArray.statusCode===200&&responsesArray.body&&Array.isArray(responsesArray.body)){allResponses=responsesArray.body;finalAllresponses=[];allResponses.map(function(sch){if(scheduleIdArr.indexOf(sch._id)==-1){finalAllresponses.push(sch);}});bookingConflict=_.size(finalAllresponses)>0?true:false;}else{bookingConflict=true;}return _context184.abrupt("return",bookingConflict);case 33:case"end":return _context184.stop();}}},null,this);}},{key:"_filterQueriedResources",value:function _filterQueriedResources(inpResourceArray,inReqStartTime,inReqEndTime,scheduleIdArr){var _,outResourceArray,_extractTimeDetails2,reqStartHrs,reqEndHrs,reqIsMultiDay,reqWeekDays,_iterator4,_isArray4,_i15,_ref61,currRes,id,dailyStartTime,dailyEndTime,weeklyOffDays,adhocOffTime,t1,t2,t3,t4,existingBooking;return regeneratorRuntime.async(function _filterQueriedResources$(_context185){while(1){switch(_context185.prev=_context185.next){case 0:_=this._;outResourceArray=[];if(!(!inpResourceArray||!Array.isArray(inpResourceArray)||inpResourceArray.length<1)){_context185.next=4;break;}return _context185.abrupt("return",outResourceArray);case 4:if(!(inReqStartTime>=inReqEndTime)){_context185.next=6;break;}return _context185.abrupt("return",outResourceArray);case 6:_extractTimeDetails2=this._extractTimeDetails(inReqStartTime,inReqEndTime,inpResourceArray[0].resourceTimezone),reqStartHrs=_extractTimeDetails2.reqStartHrs,reqEndHrs=_extractTimeDetails2.reqEndHrs,reqIsMultiDay=_extractTimeDetails2.reqIsMultiDay,reqWeekDays=_extractTimeDetails2.reqWeekDays;this._botState.developer.log({message:'From Schedules, extractTimeDetails resp',data:{reqStartHrs:reqStartHrs,reqEndHrs:reqEndHrs,reqIsMultiDay:reqIsMultiDay,reqWeekDays:reqWeekDays}});_iterator4=inpResourceArray,_isArray4=Array.isArray(_iterator4),_i15=0,_iterator4=_isArray4?_iterator4:_iterator4[typeof Symbol==="function"?typeof Symbol==="function"?Symbol.iterator:"@@iterator":"@@iterator"]();case 9:if(!_isArray4){_context185.next=15;break;}if(!(_i15>=_iterator4.length)){_context185.next=12;break;}return _context185.abrupt("break",43);case 12:_ref61=_iterator4[_i15++];_context185.next=19;break;case 15:_i15=_iterator4.next();if(!_i15.done){_context185.next=18;break;}return _context185.abrupt("break",43);case 18:_ref61=_i15.value;case 19:currRes=_ref61;id=currRes.id,dailyStartTime=currRes.dailyStartTime,dailyEndTime=currRes.dailyEndTime,weeklyOffDays=currRes.weeklyOffDays,adhocOffTime=currRes.adhocOffTime;t1=reqStartHrs>=dailyStartTime;if(reqStartHrs>=dailyStartTime){_context185.next=24;break;}return _context185.abrupt("return");case 24:t2=reqEndHrs<=dailyEndTime;if(reqEndHrs<=dailyEndTime){_context185.next=27;break;}return _context185.abrupt("return");case 27:t3=_.intersection(reqWeekDays,weeklyOffDays);if(!(_.size(_.intersection(reqWeekDays,weeklyOffDays))>0)){_context185.next=30;break;}return _context185.abrupt("return");case 30:t4=reqIsMultiDay&&(dailyStartTime!==0||dailyEndTime!==24);if(!(reqIsMultiDay&&(dailyStartTime!==0||dailyEndTime!==24))){_context185.next=33;break;}return _context185.abrupt("return");case 33:if(!this._checkAdhocOffTime(adhocOffTime,inReqStartTime,inReqEndTime)){_context185.next=35;break;}return _context185.abrupt("return");case 35:_context185.next=37;return regeneratorRuntime.awrap(this._checkConflictingBookings(id,inReqStartTime,inReqEndTime,scheduleIdArr));case 37:existingBooking=_context185.sent;if(!existingBooking){_context185.next=40;break;}return _context185.abrupt("return");case 40:outResourceArray.push(currRes);case 41:_context185.next=9;break;case 43:return _context185.abrupt("return",outResourceArray);case 44:case"end":return _context185.stop();}}},null,this);}},{key:"createSingleResource",value:function createSingleResource(resource){var newResource,isValid,writeResp;return regeneratorRuntime.async(function createSingleResource$(_context186){while(1){switch(_context186.prev=_context186.next){case 0:this._botState.developer.log({message:'From Schedules, createSingleRes with',data:resource});newResource={};isValid=this._validateResources(resource);if(!isValid){_context186.next=30;break;}newResource.id=this._botState.getUniqueId();newResource.domain=resource.domain;newResource.resourceId=resource.resourceId;newResource.resourceName=resource.resourceName;newResource.resourceType=resource.resourceType;newResource.resourceSubType=resource.resourceSubType;newResource.availStartTime=resource.availStartTime;newResource.availEndTime=resource.availEndTime;newResource.dailyStartTime=parseInt(resource.dailyStartTime)||0;newResource.dailyEndTime=parseInt(resource.dailyEndTime)||24;newResource.weeklyOffDays=resource.weeklyOffDays||[];newResource.adhocOffTime=resource.adhocOffTime||[];newResource.resourceTimezone=resource.resourceTimezone||"GMT +00:00 (Etc/GMT)";newResource.multiTask=resource.multiTask;newResource.availableStatus=resource.availableStatus;_context186.next=21;return regeneratorRuntime.awrap(this._botState.db.insertDocumentInCollection({collection:Schedules.SCHD_MASTER_DB(),document:newResource,audit:false,sync:false}));case 21:writeResp=_context186.sent;if(!(writeResp.statusCode===200&&writeResp.body==='success')){_context186.next=26;break;}return _context186.abrupt("return",{'status':'success',newId:newResource.id});case 26:this._botState.developer.log({message:'From Schedules Class Create ERROR',data:writeResp});return _context186.abrupt("return",{'status':'error',newId:undefined});case 28:_context186.next=32;break;case 30:this._botState.developer.log({message:'From Schedules Class Create ERROR',data:"Incomplete details"});return _context186.abrupt("return",{'status':'error',newId:undefined});case 32:case"end":return _context186.stop();}}},null,this);}},{key:"updateSingleResource",value:function updateSingleResource(resource){var updResource,isValid,query,options,writeResp;return regeneratorRuntime.async(function updateSingleResource$(_context187){while(1){switch(_context187.prev=_context187.next){case 0:updResource={};isValid=this._validateResources(resource);if(!(isValid&&resource.id)){_context187.next=31;break;}updResource.id=resource.id;updResource.domain=resource.domain;updResource.resourceId=resource.resourceId;updResource.resourceName=resource.resourceName;updResource.resourceType=resource.resourceType;updResource.resourceSubType=resource.resourceSubType;updResource.availStartTime=resource.availStartTime;updResource.availEndTime=resource.availEndTime;updResource.dailyStartTime=parseInt(resource.dailyStartTime)||0;updResource.dailyEndTime=parseInt(resource.dailyEndTime)||24;updResource.weeklyOffDays=resource.weeklyOffDays||[];updResource.adhocOffTime=resource.adhocOffTime||[];updResource.multiTask=resource.multiTask;updResource.availableStatus=resource.availableStatus;updResource.resourceTimezone=resource.resourceTimezone;query={id:resource.id};options={upsert:true};_context187.next=22;return regeneratorRuntime.awrap(this._botState.db.updateDataInCollection({collection:Schedules.SCHD_MASTER_DB(),document:updResource,query:query,options:options,audit:false,sync:false}));case 22:writeResp=_context187.sent;if(!(writeResp.statusCode===200&&writeResp.body==='success')){_context187.next=27;break;}return _context187.abrupt("return",true);case 27:this._botState.developer.log({message:'From Schedules Class Update ERROR',data:writeResp});return _context187.abrupt("return",false);case 29:_context187.next=33;break;case 31:this._botState.developer.log({message:'From Schedules Class Update ERROR',data:"Incomplete details"});return _context187.abrupt("return",false);case 33:case"end":return _context187.stop();}}},null,this);}},{key:"deleteSingleResource",value:function deleteSingleResource(resourceId){var query,delResp;return regeneratorRuntime.async(function deleteSingleResource$(_context188){while(1){switch(_context188.prev=_context188.next){case 0:if(resourceId){_context188.next=2;break;}return _context188.abrupt("return",false);case 2:query={id:resourceId};_context188.next=5;return regeneratorRuntime.awrap(this._botState.db.deleteDataFromCollection({collection:Schedules.SCHD_MASTER_DB(),query:query,audit:false,sync:false}));case 5:delResp=_context188.sent;if(!(delResp.statusCode===200&&delResp.body==='success')){_context188.next=10;break;}return _context188.abrupt("return",true);case 10:this._botState.developer.log({message:'From Schedules Class Delete ERROR',data:delResp});return _context188.abrupt("return",false);case 12:case"end":return _context188.stop();}}},null,this);}},{key:"createRecurringResource",value:function createRecurringResource(){return regeneratorRuntime.async(function createRecurringResource$(_context189){while(1){switch(_context189.prev=_context189.next){case 0:case"end":return _context189.stop();}}},null,this);}},{key:"updateRecurringResource",value:function updateRecurringResource(){return regeneratorRuntime.async(function updateRecurringResource$(_context190){while(1){switch(_context190.prev=_context190.next){case 0:case"end":return _context190.stop();}}},null,this);}},{key:"deleteRecurringResource",value:function deleteRecurringResource(){return regeneratorRuntime.async(function deleteRecurringResource$(_context191){while(1){switch(_context191.prev=_context191.next){case 0:case"end":return _context191.stop();}}},null,this);}},{key:"searchResourcesByInterval",value:function searchResourcesByInterval(startTime,endTime){var query,sort,responsesArray,filterResp;return regeneratorRuntime.async(function searchResourcesByInterval$(_context192){while(1){switch(_context192.prev=_context192.next){case 0:this._botState.developer.log({message:'From Schedules, searchResourcesByInterval with',data:{startTime:startTime,endTime:endTime}});if(!(startTime>=endTime)){_context192.next=3;break;}return _context192.abrupt("return",[]);case 3:query={"availStartTime":{"$lte":startTime},"availEndTime":{"$gte":endTime},"availableStatus":true};sort={"availStartTime":1};this._botState.developer.log({message:'From Schedules Class searchResourcesByInterval QUERY',data:query});_context192.next=8;return regeneratorRuntime.awrap(this._botState.db.getDataFromCollection({collection:Schedules.SCHD_MASTER_DB(),action:'query',query:query,projection:{},sort:sort,skip:0,limit:999,collation:{},expectOneResult:false,cache:false}));case 8:responsesArray=_context192.sent;this._botState.developer.log({message:'From Schedules Class searchResourcesByInterval RESP',data:responsesArray});if(!(responsesArray.statusCode===200&&responsesArray.body&&Array.isArray(responsesArray.body)&&responsesArray.body.length>0)){_context192.next=17;break;}_context192.next=13;return regeneratorRuntime.awrap(this._filterQueriedResources(responsesArray.body,startTime,endTime));case 13:filterResp=_context192.sent;return _context192.abrupt("return",filterResp);case 17:return _context192.abrupt("return",[]);case 18:case"end":return _context192.stop();}}},null,this);}},{key:"searchResourcesByIntervalByType",value:function searchResourcesByIntervalByType(resType,startTime,endTime){var query,sort,responsesArray,filterResp;return regeneratorRuntime.async(function searchResourcesByIntervalByType$(_context193){while(1){switch(_context193.prev=_context193.next){case 0:this._botState.developer.log({message:'From Schedules, searchResourcesByIntervalByType with',data:{resType:resType,startTime:startTime,endTime:endTime}});if(!(startTime>=endTime||!resType)){_context193.next=3;break;}return _context193.abrupt("return",[]);case 3:query={"resourceType":resType,"availStartTime":{"$lte":startTime},"availEndTime":{"$gte":endTime},"availableStatus":true};sort={"availStartTime":1};this._botState.developer.log({message:'From Schedules Class searchResourcesByIntervalByType QUERY',data:query});_context193.next=8;return regeneratorRuntime.awrap(this._botState.db.getDataFromCollection({collection:Schedules.SCHD_MASTER_DB(),action:'query',query:query,projection:{},sort:sort,skip:0,limit:999,collation:{},expectOneResult:false,cache:false}));case 8:responsesArray=_context193.sent;if(!(responsesArray.statusCode===200&&responsesArray.body&&Array.isArray(responsesArray.body)&&responsesArray.body.length>0)){_context193.next=16;break;}_context193.next=12;return regeneratorRuntime.awrap(this._filterQueriedResources(responsesArray.body,startTime,endTime));case 12:filterResp=_context193.sent;return _context193.abrupt("return",filterResp);case 16:return _context193.abrupt("return",[]);case 17:case"end":return _context193.stop();}}},null,this);}},{key:"searchResourcesByIntervalBySubType",value:function searchResourcesByIntervalBySubType(resSubType,startTime,endTime){var query,sort,responsesArray,filterResp;return regeneratorRuntime.async(function searchResourcesByIntervalBySubType$(_context194){while(1){switch(_context194.prev=_context194.next){case 0:this._botState.developer.log({message:'From Schedules, searchResourcesByIntervalBySubType with',data:{resSubType:resSubType,startTime:startTime,endTime:endTime}});if(!(startTime>=endTime||!resSubType)){_context194.next=3;break;}return _context194.abrupt("return",[]);case 3:query={"resourceSubType":resSubType,"availStartTime":{"$lte":startTime},"availEndTime":{"$gte":endTime},"availableStatus":true};sort={"availStartTime":1};_context194.next=7;return regeneratorRuntime.awrap(this._botState.db.getDataFromCollection({collection:Schedules.SCHD_MASTER_DB(),action:'query',query:query,projection:{},sort:sort,skip:0,limit:999,collation:{},expectOneResult:false,cache:false}));case 7:responsesArray=_context194.sent;this._botState.developer.log({message:'From Schedules Class searchResourcesByIntervalBySubType RESP',data:responsesArray});if(!(responsesArray.statusCode===200&&responsesArray.body&&Array.isArray(responsesArray.body)&&responsesArray.body.length>0)){_context194.next=16;break;}_context194.next=12;return regeneratorRuntime.awrap(this._filterQueriedResources(responsesArray.body,startTime,endTime));case 12:filterResp=_context194.sent;return _context194.abrupt("return",filterResp);case 16:return _context194.abrupt("return",[]);case 17:case"end":return _context194.stop();}}},null,this);}},{key:"searchResourcesByIntervalByResId",value:function searchResourcesByIntervalByResId(resId,startTime,endTime,scheduleIdArr){var gotConflict,query,sort,responsesArray,filterResp;return regeneratorRuntime.async(function searchResourcesByIntervalByResId$(_context195){while(1){switch(_context195.prev=_context195.next){case 0:if(!(startTime>=endTime||!resId)){_context195.next=2;break;}return _context195.abrupt("return",[]);case 2:_context195.next=4;return regeneratorRuntime.awrap(this._checkConflictingBookings(resId,startTime,endTime,scheduleIdArr));case 4:gotConflict=_context195.sent;if(!gotConflict){_context195.next=7;break;}return _context195.abrupt("return",null);case 7:query={"resourceId":resId,"availStartTime":{"$lte":startTime},"availEndTime":{"$gte":endTime},"availableStatus":true};sort={"availStartTime":1};_context195.next=11;return regeneratorRuntime.awrap(this._botState.db.getDataFromCollection({collection:Schedules.SCHD_MASTER_DB(),action:'query',query:query,projection:{},sort:sort,skip:0,limit:999,collation:{},expectOneResult:false,cache:false}));case 11:responsesArray=_context195.sent;if(!(responsesArray.statusCode===200&&responsesArray.body&&Array.isArray(responsesArray.body)&&responsesArray.body.length>0)){_context195.next=19;break;}_context195.next=15;return regeneratorRuntime.awrap(this._filterQueriedResources(responsesArray.body,startTime,endTime,scheduleIdArr));case 15:filterResp=_context195.sent;return _context195.abrupt("return",filterResp);case 19:return _context195.abrupt("return",[]);case 20:case"end":return _context195.stop();}}},null,this);}},{key:"searchResourcesByIntervalByTypeSubType",value:function searchResourcesByIntervalByTypeSubType(resType,resSubType,startTime,endTime){var query,sort,responsesArray,filterResp;return regeneratorRuntime.async(function searchResourcesByIntervalByTypeSubType$(_context196){while(1){switch(_context196.prev=_context196.next){case 0:this._botState.developer.log({message:'From Schedules, searchResourcesByIntervalByTypeSubType with',data:{resType:resType,resSubType:resSubType,startTime:startTime,endTime:endTime}});if(!(startTime>=endTime||!resType||!resSubType)){_context196.next=3;break;}return _context196.abrupt("return",[]);case 3:query={"resourceType":resType,"resourceSubType":resSubType,"availStartTime":{"$lte":startTime},"availEndTime":{"$gte":endTime},"availableStatus":true};sort={"availStartTime":1};this._botState.developer.log({message:'From Schedules Class searchResourcesByIntervalByTypeSubType QUERY',data:query});_context196.next=8;return regeneratorRuntime.awrap(this._botState.db.getDataFromCollection({collection:Schedules.SCHD_MASTER_DB(),action:'query',query:query,projection:{},sort:sort,skip:0,limit:999,collation:{},expectOneResult:false,cache:false}));case 8:responsesArray=_context196.sent;this._botState.developer.log({message:'From Schedules Class searchResourcesByIntervalByTypeSubType RESP',data:responsesArray});if(!(responsesArray.statusCode===200&&responsesArray.body&&Array.isArray(responsesArray.body)&&responsesArray.body.length>0)){_context196.next=17;break;}_context196.next=13;return regeneratorRuntime.awrap(this._filterQueriedResources(responsesArray.body,startTime,endTime));case 13:filterResp=_context196.sent;return _context196.abrupt("return",filterResp);case 17:return _context196.abrupt("return",[]);case 18:case"end":return _context196.stop();}}},null,this);}},{key:"searchResourcesByIntervalByTypeSubTypeResId",value:function searchResourcesByIntervalByTypeSubTypeResId(resType,resSubType,resId,startTime,endTime){var query,sort,responsesArray,filterResp;return regeneratorRuntime.async(function searchResourcesByIntervalByTypeSubTypeResId$(_context197){while(1){switch(_context197.prev=_context197.next){case 0:if(!(startTime>=endTime||!resType||!resSubType||!resId)){_context197.next=2;break;}return _context197.abrupt("return",[]);case 2:query={"resourceType":resType,"resourceSubType":resSubType,"resourceId":resId,"availStartTime":{"$lte":startTime},"availEndTime":{"$gte":endTime},"availableStatus":true};sort={"availStartTime":1};_context197.next=6;return regeneratorRuntime.awrap(this._botState.db.getDataFromCollection({collection:Schedules.SCHD_MASTER_DB(),action:'query',query:query,projection:{},sort:sort,skip:0,limit:999,collation:{},expectOneResult:false,cache:false}));case 6:responsesArray=_context197.sent;if(!(responsesArray.statusCode===200&&responsesArray.body&&Array.isArray(responsesArray.body)&&responsesArray.body.length>0)){_context197.next=14;break;}_context197.next=10;return regeneratorRuntime.awrap(this._filterQueriedResources(responsesArray.body,startTime,endTime));case 10:filterResp=_context197.sent;return _context197.abrupt("return",filterResp);case 14:return _context197.abrupt("return",[]);case 15:case"end":return _context197.stop();}}},null,this);}},{key:"searchResourcesByEventId",value:function searchResourcesByEventId(eventId){var query,sort,responsesArray;return regeneratorRuntime.async(function searchResourcesByEventId$(_context198){while(1){switch(_context198.prev=_context198.next){case 0:this._botState.developer.log({message:'From Schedules, searchResourcesByEventId with',data:eventId});if(!(!eventId||eventId==='')){_context198.next=3;break;}return _context198.abrupt("return",[]);case 3:query={"eventId":eventId};sort={"availStartTime":1};this._botState.developer.log({message:'From Schedules Class searchResourcesByEventId QUERY',data:query});_context198.next=8;return regeneratorRuntime.awrap(this._botState.db.getDataFromCollection({collection:Schedules.SCHD_DETAIL_DB(),action:'query',query:query,projection:{},sort:sort,skip:0,limit:999,collation:{},expectOneResult:false,cache:false}));case 8:responsesArray=_context198.sent;this._botState.developer.log({message:'From Schedules Class searchResourcesByEventId RESP',data:responsesArray});if(!(responsesArray.statusCode===200&&responsesArray.body&&Array.isArray(responsesArray.body)&&responsesArray.body.length>0)){_context198.next=14;break;}return _context198.abrupt("return",responsesArray.body);case 14:return _context198.abrupt("return",[]);case 15:case"end":return _context198.stop();}}},null,this);}},{key:"searchResourcesByIds",value:function searchResourcesByIds(idArrayIn){var idArray,query,sort,responsesArray;return regeneratorRuntime.async(function searchResourcesByIds$(_context199){while(1){switch(_context199.prev=_context199.next){case 0:this._botState.developer.log({message:'From Schedules, searchResourcesByIds with',data:idArrayIn});if(idArrayIn){_context199.next=3;break;}return _context199.abrupt("return",[]);case 3:idArray=void 0;if(Array.isArray(idArrayIn)){idArray=idArrayIn;}else{idArray=[idArrayIn];}if(!(idArray.length<1)){_context199.next=7;break;}return _context199.abrupt("return",[]);case 7:query={"resourceId":{"$in":idArrayIn},"availableStatus":true};sort={"availStartTime":1};this._botState.developer.log({message:'From Schedules Class searchResourcesByInterval QUERY',data:query});_context199.next=12;return regeneratorRuntime.awrap(this._botState.db.getDataFromCollection({collection:Schedules.SCHD_MASTER_DB(),action:'query',query:query,projection:{},sort:sort,skip:0,limit:999,collation:{},expectOneResult:false,cache:false}));case 12:responsesArray=_context199.sent;this._botState.developer.log({message:'From Schedules Class searchResourcesByIds RESP',data:responsesArray});if(!(responsesArray.statusCode===200&&responsesArray.body&&Array.isArray(responsesArray.body)&&responsesArray.body.length>0)){_context199.next=18;break;}return _context199.abrupt("return",responsesArray.body);case 18:return _context199.abrupt("return",[]);case 19:case"end":return _context199.stop();}}},null,this);}},{key:"searchResourcesByResIdEventId",value:function searchResourcesByResIdEventId(eventId,resId){var query,sort,responsesArray;return regeneratorRuntime.async(function searchResourcesByResIdEventId$(_context200){while(1){switch(_context200.prev=_context200.next){case 0:this._botState.developer.log({message:'From Schedules, searchResourcesByResIdEventId with',data:{eventId:eventId,resId:resId}});if(!(!eventId||eventId===''||!resId||resId==='')){_context200.next=3;break;}return _context200.abrupt("return",[]);case 3:query={"origId":resId,"eventId":eventId};sort={"availStartTime":1};this._botState.developer.log({message:'From Schedules Class searchResourcesByResIdEventId QUERY',data:query});_context200.next=8;return regeneratorRuntime.awrap(this._botState.db.getDataFromCollection({collection:Schedules.SCHD_DETAIL_DB(),action:'query',query:query,projection:{},sort:sort,skip:0,limit:999,collation:{},expectOneResult:false,cache:false}));case 8:responsesArray=_context200.sent;this._botState.developer.log({message:'From Schedules Class searchResourcesByResIdEventId RESP',data:responsesArray});if(!(responsesArray.statusCode===200&&responsesArray.body&&Array.isArray(responsesArray.body)&&responsesArray.body.length>0)){_context200.next=14;break;}return _context200.abrupt("return",responsesArray.body);case 14:return _context200.abrupt("return",[]);case 15:case"end":return _context200.stop();}}},null,this);}},{key:"getAvailableTimeSlots",value:function getAvailableTimeSlots(resourceId,slotTime,startEpoch,endEpoch,scheduleIdArr){var botState,_,takenSlots,timeSlots,_loop4;return regeneratorRuntime.async(function getAvailableTimeSlots$(_context201){while(1){switch(_context201.prev=_context201.next){case 0:botState=this._botState;_=botState._;if(!(!resourceId||!slotTime||!startEpoch||!endEpoch)){_context201.next=4;break;}return _context201.abrupt("return",[]);case 4:_context201.next=6;return regeneratorRuntime.awrap(botState.db.getDataFromCollection({collection:Schedules.SCHD_DETAIL_DB(),query:{origId:resourceId,bookedStartTime:{$gte:startEpoch},bookedEndTime:{$lte:endEpoch}},projection:{projection:{bookedStartTime:1,bookedEndTime:1}}}));case 6:takenSlots=_context201.sent;takenSlots=_.get(takenSlots,'body',[]);timeSlots=[];_loop4=function _loop4(){var taken=false;var endTime=startEpoch+slotTime;_.forEach(takenSlots,function(e){var cantStart=e.bookedStartTime<=startEpoch&&e.bookedEndTime>startEpoch;var cantEnd=e.bookedStartTime<endTime&&e.bookedEndTime>endTime;var cantIncludes=startEpoch<e.bookedStartTime&&endTime>=e.bookedEndTime;if(cantStart||cantEnd||cantIncludes){taken=true;return;}});if(!taken){timeSlots.push({start:startEpoch,end:startEpoch+slotTime});}startEpoch+=slotTime;};while(endEpoch-startEpoch>=slotTime){_loop4();}return _context201.abrupt("return",timeSlots);case 12:case"end":return _context201.stop();}}},null,this);}},{key:"blockResource",value:function blockResource(resIdArrayIn,startTime,endTime,eventId){var resIdArray,resultsArray,_i16,currentID,resp,gotConflict,newBooking,writeResp;return regeneratorRuntime.async(function blockResource$(_context202){while(1){switch(_context202.prev=_context202.next){case 0:resIdArray=void 0;if(Array.isArray(resIdArrayIn)){resIdArray=resIdArrayIn;}else{resIdArray=[resIdArrayIn];}resIdArray=[].concat(_toConsumableArray(new Set(resIdArray)));if(!(startTime>=endTime||resIdArray.length<1)){_context202.next=5;break;}return _context202.abrupt("return",false);case 5:resultsArray=[];_i16=0;case 7:if(!(_i16<resIdArray.length)){_context202.next=29;break;}currentID=resIdArray[_i16];resp={};_context202.next=12;return regeneratorRuntime.awrap(this._checkConflictingBookings(currentID,startTime,endTime));case 12:gotConflict=_context202.sent;if(!gotConflict){_context202.next=17;break;}resp[currentID]=undefined;resultsArray.push(resp);return _context202.abrupt("continue",26);case 17:newBooking={};newBooking._id=this._botState.getUniqueId();newBooking.origId=currentID;newBooking.bookedStartTime=startTime,newBooking.bookedEndTime=endTime,newBooking.eventId=eventId;_context202.next=23;return regeneratorRuntime.awrap(this._botState.db.insertDocumentInCollection({collection:Schedules.SCHD_DETAIL_DB(),document:newBooking,audit:false,sync:false}));case 23:writeResp=_context202.sent;if(writeResp.statusCode===200&&writeResp.body==='success'){resp[currentID]=newBooking._id;}else{resp[currentID]=undefined;}resultsArray.push(resp);case 26:_i16++;_context202.next=7;break;case 29:return _context202.abrupt("return",resultsArray);case 30:case"end":return _context202.stop();}}},null,this);}},{key:"_internalUnblocker",value:function _internalUnblocker(resId){var query,delResp;return regeneratorRuntime.async(function _internalUnblocker$(_context203){while(1){switch(_context203.prev=_context203.next){case 0:this._botState.developer.log({message:'From Schedules, _internalUnblocker with',data:resId});query={_id:resId};_context203.next=4;return regeneratorRuntime.awrap(this._botState.db.deleteDataFromCollection({collection:Schedules.SCHD_DETAIL_DB(),query:query,audit:false,sync:false}));case 4:delResp=_context203.sent;if(!(delResp.statusCode===200&&delResp.body==='success')){_context203.next=10;break;}this._botState.developer.log({message:'From Schedules Class _internalUnblocker success',data:delResp});return _context203.abrupt("return",{'result':'success','msg':'Resource released'});case 10:this._botState.developer.log({message:'From Schedules Class _internalUnblocker ERROR',data:delResp});return _context203.abrupt("return",{'result':'error','msg':'Resource was not released'});case 12:case"end":return _context203.stop();}}},null,this);}},{key:"unBlockResource",value:function unBlockResource(resIdArrayIn){var resultsArray,resIdArray,_i17,currentID,resp;return regeneratorRuntime.async(function unBlockResource$(_context204){while(1){switch(_context204.prev=_context204.next){case 0:this._botState.developer.log({message:'From Schedules, unBlockResource with',data:{resIdArrayIn:resIdArrayIn}});resultsArray=[];resIdArray=void 0;if(Array.isArray(resIdArrayIn)){resIdArray=resIdArrayIn;}else{resIdArray=[resIdArrayIn];}resIdArray=[].concat(_toConsumableArray(new Set(resIdArray)));if(!(resIdArray.length<1)){_context204.next=7;break;}return _context204.abrupt("return",false);case 7:_i17=0;case 8:if(!(_i17<resIdArray.length)){_context204.next=18;break;}currentID=resIdArray[_i17];resp={};_context204.next=13;return regeneratorRuntime.awrap(this._internalUnblocker(currentID));case 13:resp[currentID]=_context204.sent;resultsArray.push(resp);case 15:_i17++;_context204.next=8;break;case 18:this._botState.developer.log({message:'From Schedules, unBlockResource final',data:resultsArray});return _context204.abrupt("return",resultsArray);case 20:case"end":return _context204.stop();}}},null,this);}}]);return Schedules;}();var Orders=function(){_createClass(Orders,null,[{key:"PAYMENT_CODES",value:function PAYMENT_CODES(){return{TOP_UP_WALLET:'100',PURCHASE_PRODUCT:'101'};}},{key:"CURRENT_STRIPE_TRANSACTIONS",value:function CURRENT_STRIPE_TRANSACTIONS(){return'currentStripeTransactions';}}]);function Orders(botState){_classCallCheck(this,Orders);this['_botState']=botState;this['context']=botState.context;this['userId']=botState.user.userId;this['conversation']=botState.conversation;this['location']=botState.location;this._botState.developer.log({message:'Initialising Orders'});if(this._botState.client===State.MOBILECLIENT()&&this.location===Intent.EDGE()){if(this._botState.client===State.MOBILECLIENT()){this._botState.developer.log({message:'Initialising InAppPurchases'});this['inAppPurchaseCap']=this.context.getCapability('InAppPurchase');this['productTypes']=this.inAppPurchaseCap.ProductTypes;}else{this['inAppPurchaseCap']='false';this['productTypes']=[];}}}_createClass(Orders,[{key:"createNewStripeTransaction",value:function createNewStripeTransaction(amount,currency,description){var currentTransactions=this._botState.getField(Orders.CURRENT_STRIPE_TRANSACTIONS())||[];var transactionId=this._botState.UUID();currentTransactions.push({transactionId:transactionId,amount:amount,currency:currency,description:description});this._botState.setField(Orders.CURRENT_STRIPE_TRANSACTIONS(),currentTransactions);return transactionId;}},{key:"getStripeTransaction",value:function getStripeTransaction(transactionId){var currentTransactions=this._botState.getField(Orders.CURRENT_STRIPE_TRANSACTIONS())||[];var index=this._botState._.findIndex(currentTransactions,function(transaction){return transaction.transactionId===transactionId;});return index===-1?null:currentTransactions[index];}},{key:"removeStripeTransaction",value:function removeStripeTransaction(transactionId){var currentTransactions=this._botState.getField(Orders.CURRENT_STRIPE_TRANSACTIONS())||[];var index=this._botState._.findIndex(currentTransactions,function(transaction){return transaction.transactionId===transactionId;});this._botState._.pullAt(currentTransactions,[index]);this._botState.setField(Orders.CURRENT_STRIPE_TRANSACTIONS(),currentTransactions);}},{key:"inAppPurchase",value:function inAppPurchase(product){if(this.location===Intent.CLOUD()||this._botState.client===State.WEBCLIENT()){this._botState.addSystemErrorToStack(13);return;}this._botState.developer.log({message:'About to buy product '+product+' of type '+this.productTypes.VOIP});return this.inAppPurchaseCap.buyProduct({productCode:product,productName:this.productTypes.VOIP});}},{key:"processStripePayment",value:function processStripePayment(){var _botState$messageFrom=this._botState.messageFromUser,transactionId=_botState$messageFrom.transactionId,currency=_botState$messageFrom.currency,amount=_botState$messageFrom.amount,paymentSuccessful=_botState$messageFrom.paymentSuccessful;if(paymentSuccessful){var stateTransaction=this.getStripeTransaction(transactionId);if(stateTransaction===null){return{error:'Invalid transaction id'};}var stateTransactionId=stateTransaction.transactionId,stateCurrency=stateTransaction.currency,stateAmount=stateTransaction.amount;if(stateTransactionId!==transactionId){return{error:'Invalid transaction id'};}if(stateAmount!==amount){return{error:'There is a discrepancy in amounts. Please report to the support team'};}if(stateCurrency!==currency){return{error:'There is a discrepancy in currencies. Please report to the support team'};}this.removeStripeTransaction(transactionId);return{error:0};}else{this.removeStripeTransaction(transactionId);return{error:'Your stripe payment was not successful'};}}}]);return Orders;}();var Accounts=function(){function Accounts(botState){_classCallCheck(this,Accounts);this['_botState']=botState;this['context']=botState.context;this['userId']=botState.user.userId;this['conversation']=botState.conversation;this['location']=botState.location;}_createClass(Accounts,[{key:"getBalance",value:function getBalance(account){var conversation=this.conversation;var userId=this.userId;var params={capability:'MessageQuotaCapability',capabilityFileName:'messageQuotaCapability',action:'getSpecificQuota',sync:true,userId:userId,conversation:conversation,botId:account};return this._botState.callCapability(params);}},{key:"storeBalance",value:function storeBalance(account,balance){var conversation=this.conversation;var userId=this.userId;var params={capability:'MessageQuotaCapability',capabilityFileName:'messageQuotaCapability',action:'incrementUserAssignedQuota',sync:true,userId:userId,conversation:conversation,stats:{}};params.stats[account]=balance;return this._botState.callCapability(params);}},{key:"updateBalance",value:function updateBalance(account,balance){var conversation=this.conversation;var userId=this.userId;var params={capability:'MessageQuotaCapability',capabilityFileName:'messageQuotaCapability',action:'updateUserUsedQuota',sync:true,userId:userId,conversation:conversation,stats:{}};params.stats[account]=balance;return this._botState.callCapability(params);}},{key:"resetBalance",value:function resetBalance(account,balance){var conversation=this.conversation;var userId=this.userId;var params={capability:'MessageQuotaCapability',capabilityFileName:'messageQuotaCapability',action:'setUserAssignedClearUsedQuota',sync:true,userId:userId,conversation:conversation,stats:{}};params.stats[account]=balance;return this._botState.callCapability(params);}},{key:"getCallRates",value:function getCallRates(isoCountry){try{var conversation=this.conversation;var userId=this.userId;var params={capability:'VoipCapability',capabilityFileName:'voipCapability',action:'getCallTariffsForCountry',isoCountry:isoCountry,userDomains:this._botState.userDomains,sync:true,userId:userId,conversation:conversation};return this._botState.callCapability(params);}catch(error){this._botState.addSystemErrorToStack(8,null,error.message);}}},{key:"getCallHistory",value:function getCallHistory(){try{var params={action:'getCallHistory',capability:'VoipCapability',capabilityFileName:'voipCapability',userId:this.userId,conversation:this.conversation,sync:true,email:this._botState.user.userEmail};return this._botState.callCapability(params);}catch(error){this._botState.addSystemErrorToStack(8,null,error.message);}}}]);return Accounts;}();var Error=function(){_createClass(Error,null,[{key:"getErrorMessageforCodeAndLang",value:function getErrorMessageforCodeAndLang(errorCode,lang){var errorsLibrary={0:{en:'No error'},1:{en:'The valid values for RunLocation are Edge and Cloud'},2:{en:'RunLocation attribute is mandatory'},3:{en:'The onResolution function is mandatory'},4:{en:'To process your request, I need to reach the cloud and you appear to be offline at this moment. Please try again later'},5:{en:'Error in edge bot logic with message '},6:{en:'NLP cannot be called with other data than string'},7:{en:'Error processing botResolver in backend'},8:{en:'Error in cloud bot logic with message '},9:{en:'The name for the bot name already exists for your domain, please change it and try again'},10:{en:'An unknown problem has appeared during the bot publication process. Please contact FrontM support.'},11:{en:'Logic error in onError function'},12:{en:'Wrong debug command'},13:{en:'I Cannot run inApp purchases in the cloud'},14:{en:'Invalid message adding a response'},15:{en:'I have not received the authorisation to activate the notifications. You can request me to activate the notifications in any time.'},16:{en:'I could not register your device for notifications at this moment. Please try again later'},17:{en:'I could not modify your password. Please be sure that your old password is correct and that you are following the FrontM password policy'},18:{en:'Capability not available on the cloud'},19:{en:'I encountered a problem unregistering your device for notifications'},20:{en:'I could not deregister your device for notifications at this moment. Please try again later'},21:{en:'Invalid intent object found'},22:{en:'Ambiguous NLP results'},23:{en:'This method requires an array of Strings'},24:{en:'Invalid NLP Id'},25:{en:'Invalid backend capability'},26:{en:'Backend capabilities are not present on edge'},27:{en:'Error running predictors with message '},28:{en:'Bad table action '},29:{en:'Bad form action '},30:{en:'Action not recognised during video call'},31:{en:'Error while encrypting data'},32:{en:'Error while decrypting data'},33:{en:'Could not send push notification '},34:{en:'Ambiguous intent matching. Please review your forms, tables and containers looking for duplicated names'},35:{en:'Ambiguous intent matching. Please review your intentIds looking for duplicated names or check your matching rules'},36:{en:'Could not write data in DB'},37:{en:'Error calling service'},38:{en:'Unidentified intent or control'},39:{en:'Bad data from cache in backend'},40:{en:'The Record you are trying to open is not available offline'},41:{en:'Invalid coordinates'},42:{en:'Error synchronising data '},43:{en:'Error sending a message in backend'},45:{en:'Error building document'},46:{en:'Bad field action '},47:{en:'Bad container action '},48:{en:'Bad map action '},49:{en:'Bad geofence action '},50:{en:'The data property is too big and it cannot be logged. Message: '},51:{en:'Duplicated entries in autoSave buffer'},52:{en:'The autoSave buffer is empty'},53:{en:'Location not available or with very weak signal'},54:{en:'Location not available on the cloud'},55:{en:'SQS Messages can only be sent from the cloud'},56:{en:'Your system appears to be offline. Please check your internet connection and try again later'},999:{en:''}};return errorsLibrary[errorCode][lang];}}]);function Error(botState,errorCode,errorMessage){_classCallCheck(this,Error);this._errorCode=errorCode;if(errorCode<1000){if(errorMessage){this._errorMessage=Error.getErrorMessageforCodeAndLang(errorCode,botState.lang)+' '+errorMessage;}else{this._errorMessage=Error.getErrorMessageforCodeAndLang(errorCode,botState.lang);}}else{this._errorMessage=errorMessage;}}_createClass(Error,[{key:"errorCode",get:function get(){return this._errorCode;}},{key:"errorMessage",get:function get(){return this._errorMessage;}}]);return Error;}();var MessageTypes=function(){function MessageTypes(){_classCallCheck(this,MessageTypes);}_createClass(MessageTypes,null,[{key:"MESSAGE_TYPE_STRING",value:function MESSAGE_TYPE_STRING(){return 10;}},{key:"MESSAGE_TYPE_IMAGE",value:function MESSAGE_TYPE_IMAGE(){return 30;}},{key:"MESSAGE_TYPE_VIDEO",value:function MESSAGE_TYPE_VIDEO(){return 40;}},{key:"MESSAGE_TYPE_AUDIO",value:function MESSAGE_TYPE_AUDIO(){return 60;}},{key:"MESSAGE_TYPE_HTML",value:function MESSAGE_TYPE_HTML(){return 140;}},{key:"BACKEND_RESPONSE",value:function BACKEND_RESPONSE(){return 150;}},{key:"BOT_TO_BOT",value:function BOT_TO_BOT(){return 160;}},{key:"MESSAGE_TYPE_LIST",value:function MESSAGE_TYPE_LIST(){return 200;}},{key:"MESSAGE_TYPE_SLIDER",value:function MESSAGE_TYPE_SLIDER(){return 210;}},{key:"MESSAGE_TYPE_BUTTON",value:function MESSAGE_TYPE_BUTTON(){return 220;}},{key:"MESSAGE_TYPE_FORM",value:function MESSAGE_TYPE_FORM(){return 230;}},{key:"MESSAGE_TYPE_MAP",value:function MESSAGE_TYPE_MAP(){return 240;}},{key:"MESSAGE_TYPE_SMART_SUGGESTIONS",value:function MESSAGE_TYPE_SMART_SUGGESTIONS(){return 250;}},{key:"MESSAGE_TYPE_WEB_CARD",value:function MESSAGE_TYPE_WEB_CARD(){return 260;}},{key:"MESSAGE_TYPE_STD_NOTIFICATION",value:function MESSAGE_TYPE_STD_NOTIFICATION(){return 270;}},{key:"MESSAGE_TYPE_CRITICAL_NOTIFICATION",value:function MESSAGE_TYPE_CRITICAL_NOTIFICATION(){return 280;}},{key:"MESSAGE_TYPE_LOCATION",value:function MESSAGE_TYPE_LOCATION(){return 290;}},{key:"MESSAGE_TYPE_PDF",value:function MESSAGE_TYPE_PDF(){return 300;}},{key:"MESSAGE_TYPE_TEXT",value:function MESSAGE_TYPE_TEXT(){return 320;}},{key:"MESSAGE_TYPE_OTHER_FILE",value:function MESSAGE_TYPE_OTHER_FILE(){return 330;}},{key:"MESSAGE_TYPE_CSV",value:function MESSAGE_TYPE_CSV(){return 340;}},{key:"MESSAGE_TYPE_JAVASCRIPT",value:function MESSAGE_TYPE_JAVASCRIPT(){return 350;}},{key:"MESSAGE_TYPE_FORM2",value:function MESSAGE_TYPE_FORM2(){return 400;}},{key:"MESSAGE_TYPE_MENU",value:function MESSAGE_TYPE_MENU(){return 410;}},{key:"MESSAGE_TYPE_TABLE",value:function MESSAGE_TYPE_TABLE(){return 420;}},{key:"MESSAGE_TYPE_CONTACT_CARD",value:function MESSAGE_TYPE_CONTACT_CARD(){return 430;}},{key:"MESSAGE_TYPE_DATA_CARD",value:function MESSAGE_TYPE_DATA_CARD(){return 440;}},{key:"MESSAGE_TYPE_FORM_RESPONSE",value:function MESSAGE_TYPE_FORM_RESPONSE(){return 450;}},{key:"MESSAGE_TYPE_STRIPE",value:function MESSAGE_TYPE_STRIPE(){return 460;}},{key:"MESSAGE_TYPE_STRIPE_RESPONSE",value:function MESSAGE_TYPE_STRIPE_RESPONSE(){return 470;}},{key:"MESSAGE_TYPE_CLOSE_FORM",value:function MESSAGE_TYPE_CLOSE_FORM(){return 480;}},{key:"MESSAGE_TYPE_MAP_RESPONSE",value:function MESSAGE_TYPE_MAP_RESPONSE(){return 490;}},{key:"MESSAGE_TYPE_SEARCH_BOX",value:function MESSAGE_TYPE_SEARCH_BOX(){return 510;}},{key:"MESSAGE_TYPE_SEARCH_BOX_RESPONSE",value:function MESSAGE_TYPE_SEARCH_BOX_RESPONSE(){return 520;}},{key:"MESSAGE_TYPE_CARDS",value:function MESSAGE_TYPE_CARDS(){return 530;}},{key:"MESSAGE_TYPE_CARD_ACTION",value:function MESSAGE_TYPE_CARD_ACTION(){return 540;}},{key:"MESSAGE_RUN_MODE",value:function MESSAGE_RUN_MODE(){return 550;}},{key:"SHORT_TABLE_RESPONSE",value:function SHORT_TABLE_RESPONSE(){return 1000;}},{key:"SHORT_CONTAINER_RESPONSE",value:function SHORT_CONTAINER_RESPONSE(){return 1100;}},{key:"MESSAGE_VOICE_CALL",value:function MESSAGE_VOICE_CALL(){return 1200;}},{key:"SHORT_FORM_RESPONSE",value:function SHORT_FORM_RESPONSE(){return 1300;}}]);return MessageTypes;}();var State=function(){_createClass(State,null,[{key:"MOBILECLIENT",value:function MOBILECLIENT(){return'mobile';}},{key:"WEBCLIENT",value:function WEBCLIENT(){return'web';}},{key:"EDGE_WEBCLIENT",value:function EDGE_WEBCLIENT(){return'web2';}}]);function State(message,conversation,user,location,stateFromStorage,context,args){var _this138=this;_classCallCheck(this,State);this['conversationId']=conversation.conversationId;this['conversation']=conversation;this['client']=this.conversation.client;this['args']=args;this['lang']='en';this['_activeIntent']='';this['_intentHistory']=[];this['_intentStats']={};this['error']=false;this['errorStack']=[];this['responsesArray']=[];this['smartSuggestionsArray']=[];this['_blockSuggestions']=false;this['toCustomCap']=false;this['_silentIntent']=false;this['user']=user;this['intentResolved']=false;this['waitingCustomCap']=0;this['location']=location;this['requestIdsArray']=[];this['context']=null;this['_']=null;this['R']=null;this['Immutable']=null;this['moment']=null;this['momentTimezone']=null;this['messageTypes']={};this['lastGreetingTime']=0;this['lastUserActivity']=0;this['MessageCapability']=null;this['_log']=[];this['fields']={};this['sessionFields']={};this['fieldsChanged']={};this['fieldsCleared']=[];this['_oldFields']={};this['logoutInProcess']=false;this['currentWorkspace']='';this['developer']=new Developer(this);this.setContext(context);this['botId']=this.conversation.bot||this._.get(this.context,'botManifest.botId');this['lastSession']=this._.toNumber(this._.now());this['accounts']=new Accounts(this);this['orders']=new Orders(this);this['sftp']=new SFTP(this);this['notification']=new Notification(this);this['marketplace']=new Marketplace(this);this['jobScheduler']=new JobScheduler(this);this['contacts']=new Contacts(this);this['api']=new API(this);this['db']=new DB(this);this['file']=new File(this);this['sites']=new Sites(this);this['sensors']=new Sensors(this);this['locationServices']=new LocationServices(this);this['trackingServices']=new TrackingServices(this);this['security']=new Security(this);this['nlp']=new NLP(this);this['cc']=new ContactCentre(this);this['companies']=new Companies(this);this['schedules']=new Schedules(this);this['surveys']=new Surveys(this);if((this.client===State.MOBILECLIENT()||this.client===State.EDGE_WEBCLIENT())&&this.location===Intent.EDGE()){this['deviceStorage']=new DeviceStorage(this);}this['promptAlive']='';this['amIOnline']=true;this['_searchBoxes']=[];this['_currentSearchBox']='';this['sendMessageParam']=null;this['compatibilityMode']=false;this['disambiguate']=false;this['disambiguationNLPId']='';this['_nlpResults']={};this['_lastNLPResults']={};this['_intentDurations']=[];this['_conversational']=true;this['_background']={};this['waitingIcon']={};this['_inputHistory']=[];this['_currentControlId']=null;this['_suggestionsLayout']='horizontal';this['_sidebar']={hidden:false,frozen:false};this['_navbar']={hidden:false,frozen:false};this['fromGreeting']=false;this['chatButtonHidden']=false;this['_unitTestMode']=false;this['_inSilence']=false;this['_cssFilePath']=null;this['_modal']=false;this['_routesQueue']={};this['_dynamicIntents']={};this._version=2;this._autoSavePresent=false;this._intents={};this._syncToEdge={};this._syncToCloud={};this.autoSaveBuffer={};this.autoSaveBufferChanges={};this.duringBuild=false;this._delayedNotification=[];this.v1Compatibility=false;this.appVersion='';this.autoResponse=false;this.backendResponseType=0;this.onlineRequired=false;this.maps={};this.apiResponse=false;this.responseToClient=this.client;if(stateFromStorage){for(var propertyName in stateFromStorage){if(propertyName==='_debugMode'){this.developer._debugMode=true;}else{this[propertyName]=stateFromStorage[propertyName];}}}if(message){if(message.messageType){this['messageTypeFromUser']=message.messageType;this['messageFromUser']=message.messageFromUser||'';}else{this['messageTypeFromUser']=message.getMessageType();this['messageFromUser']=message.getMessage();if(this.messageTypeFromUser===this.messageTypes.MESSAGE_TYPE_STRING){this['messageIdFromUser']=message.getMessageId();var getMessageContentType=function getMessageContentType(message){var MessageTypeConstantsToInt=_this138.context.getCapability('MessageTypeConstantsToInt');return MessageTypeConstantsToInt[message.getMessageType()]||0;};this['messageTypeIntFromUser']=getMessageContentType(message);this['messageCreatedOnFromUser']=message.getMessageDate().valueOf();this['messageCreatedByFromUser']=message.getCreatedBy();var msgContent=message.getMessage();var temp=JSON.stringify(msgContent);temp=temp.replace(/\"\"/g,'" "');msgContent=JSON.parse(temp);this['messageContentFromUser']=this._.isArray(msgContent)?msgContent:[msgContent];this['messageOptionsFromUser']=message.getMessageOptions();}}this._inputHistory.push({type:this.R.toString(this.messageTypeFromUser),content:this.R.toString(this.messageFromUser)});this._oldFields=this.fields;if(this._inputHistory.length>5){this._inputHistory.splice(0,1);}}if(this.messageFromUser&&!this.messageFromUser.intentId){this.lastUserActivity=Date.now();}console.log('*************** message type: '+this['messageTypeFromUser']);this.developer.info({message:'*************** message type: ',data:this['messageTypeFromUser']});console.log('*************** message from user: '+JSON.stringify(this['messageFromUser']));this.developer.info({message:'*************** message from user: ',data:this['messageFromUser']});this.currentTabId=this._.get(this.messageFromUser,'tabId');this.onStart=function _callee85(){return regeneratorRuntime.async(function _callee85$(_context205){while(1){switch(_context205.prev=_context205.next){case 0:case"end":return _context205.stop();}}},null,_this138);};this.defaultOnError=function(){if(_this138.developer.runProfile!==Developer.PROD()){_this138._.forEach(_this138.errorStack,function(error){if(error.errorCode===40){_this138.addCriticalNotificationResponse(error.errorMessage);}else{_this138.addStringResponse(error.errorMessage);}});}else{_this138.addStringResponse('Requested information is currently unavailable. Please check back later');}};this.resetOnErrorMethod();}_createClass(State,[{key:"callCapability",value:function callCapability(params){try{var capabilities=this.context.capabilities.capabilities;var capabilityDependencies=this.context.capabilities;if(!capabilities){capabilities=this.context.capabilities;capabilityDependencies=this.context;}var capFileName=params.capabilityFileName;var capabilityModule=capabilities[capFileName];if(capabilityModule){return capabilityModule.execute(params,capabilityDependencies);}}catch(err){this.addSystemErrorToStack(26,'4 '+err.name+': '+err.message);}}},{key:"callLambda",value:function callLambda(functionName,params){var InvocationType=arguments.length>2&&arguments[2]!==undefined?arguments[2]:'RequestResponse';var lambda;return regeneratorRuntime.async(function callLambda$(_context206){while(1){switch(_context206.prev=_context206.next){case 0:lambda=new this.aws.Lambda();return _context206.abrupt("return",lambda.invoke({FunctionName:functionName,InvocationType:InvocationType,Payload:JSON.stringify(params,null,0)}).promise());case 2:case"end":return _context206.stop();}}},null,this);}},{key:"resetOnErrorMethod",value:function resetOnErrorMethod(){this.clearError();this._onError=this.defaultOnError;}},{key:"getNlpResultsForId",value:function getNlpResultsForId(nlpId){if(this._nlpResults){if(this._nlpResults[nlpId]){return this._nlpResults[nlpId];}}return{};}},{key:"getStaticData",value:function getStaticData(key,system){var KEY_VALUES,query,data,response;return regeneratorRuntime.async(function getStaticData$(_context207){while(1){switch(_context207.prev=_context207.next){case 0:KEY_VALUES='_keyValues';query={key:key};_context207.next=4;return regeneratorRuntime.awrap(this.db.getDataFromCollection({collection:KEY_VALUES,query:query,cache:true,system:system}));case 4:data=_context207.sent;response=this._.get(data,'body[0].value');if(!response){this.developer.warning({message:"Missing static data for key",data:key});}return _context207.abrupt("return",response);case 8:case"end":return _context207.stop();}}},null,this);}},{key:"getSystemStaticData",value:function getSystemStaticData(key){return regeneratorRuntime.async(function getSystemStaticData$(_context208){while(1){switch(_context208.prev=_context208.next){case 0:return _context208.abrupt("return",this.getStaticData(key,true));case 1:case"end":return _context208.stop();}}},null,this);}},{key:"saveStaticData",value:function saveStaticData(key,value){var KEY_VALUES,query,document;return regeneratorRuntime.async(function saveStaticData$(_context209){while(1){switch(_context209.prev=_context209.next){case 0:KEY_VALUES='_keyValues';query={key:key};document={value:value};_context209.next=5;return regeneratorRuntime.awrap(this.db.updateDataInCollection({collection:KEY_VALUES,document:document,query:query,cache:true}));case 5:case"end":return _context209.stop();}}},null,this);}},{key:"recordActivity",value:function recordActivity(){if(this.activeIntent!==''&&!this.toCustomCap){var _13=this._;var direction=_13.size(this.responsesArray)===0?0:1;var messageFromUser={controlId:_13.get(this.messageFromUser,"controlId"),formId:_13.get(this.messageFromUser,"formId"),action:_13.get(this.messageFromUser,"action"),tableId:_13.get(this.messageFromUser,"tableId"),currentField:_13.get(this.messageFromUser,"currentField"),selectedEntry:_13.get(this.messageFromUser,"selectedEntry"),messageTypeFromUser:this.messageTypeFromUser};var _document4={botId:this.botId,userId:this.user.userId,userEmail:this.user.userEmail,timestamp:Date.now(),intent:this.activeIntent,messageFromUserMetadata:messageFromUser};if(_13.size(this.responsesArray)===0){_document4.direction=0;}else{_document4.direction=1;var responseMetadataArray=[];_13.forEach(this.responsesArray,function(response){var responseMetadata={type:_13.get(response,"type"),controlId:_13.get(response,"message.options.controlId"),action:_13.get(response,"message.options.action")};responseMetadataArray.push(responseMetadata);});_document4.responsesArray=responseMetadataArray;}var query={botId:this.botId,userId:this.user.userId,direction:direction};var options={upsert:true};return this.db.updateDataInCollection({collection:ALL_CONSTANTS.ACTIVITY_COLLECTION,document:_document4,query:query,options:options,audit:true,cache:true});}}},{key:"online",value:function online(){if((this.client===State.MOBILECLIENT()||this.client===State.EDGE_WEBCLIENT())&&this.location===Intent.EDGE()&&!this.v1Compatibility){try{var network=this.context.getCapability('Network');return network.isConnected().then(function(connected){console.log("Status "+connected);return connected;}).catch(function(){return false;});}catch(error){console.log('Error checking for online status '+error.message);}}else{return Promise.resolve(true);}}},{key:"addSearchBox",value:function addSearchBox(searchBox){var existingSearchBox=this.getSearchBox(searchBox.id);if(!existingSearchBox){this._searchBoxes.push(searchBox);}else{existingSearchBox.onSearch=searchBox.onSearch;existingSearchBox.onCompletion=searchBox.onCompletion;existingSearchBox.onCancel=searchBox.onCancel;}}},{key:"getSearchBox",value:function getSearchBox(searchBoxId){var i=this._.findIndex(this._searchBoxes,function(searchBox){return searchBox.id===searchBoxId;});return this._searchBoxes[i]||null;}},{key:"runLocationVerification",value:function runLocationVerification(method,location){var locationPassed=location===this.location;if(!locationPassed){this.addErrorToStack(1,'Method '+method+' cannot run on the '+this.location);}return locationPassed;}},{key:"setNetworkModeTo",value:function setNetworkModeTo(mode){return this.context.getCapability('Settings').setPollingStrategy(mode);}},{key:"getUserRolesForDomain",value:function getUserRolesForDomain(domain){for(var _iterator5=this.userDomains,_isArray5=Array.isArray(_iterator5),_i18=0,_iterator5=_isArray5?_iterator5:_iterator5[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var _ref62;if(_isArray5){if(_i18>=_iterator5.length)break;_ref62=_iterator5[_i18++];}else{_i18=_iterator5.next();if(_i18.done)break;_ref62=_i18.value;}var domainObject=_ref62;if(domainObject.domain===domain){return domainObject.roles;}}}},{key:"setContext",value:function setContext(context){var _this139=this;this.context=context;if(this.location===Intent.EDGE()){this['userName']=this.user.info.userName;this.user.userName=this.user.info.userName;var utils=this.context.getCapability('Utils');this._=utils.Lodash;this.R=this.context.getCapability('R')||{};this.immutable=this.context.getCapability('Immutable')||{};this.UUID=utils.UUID;this.messageTypes=this.context.getCapability('MessageTypeConstants');this.MessageCapability=this.context.getCapability('Message');this.userDomains=this.user.info.domains;this.moment=this.context.getCapability('Moment');this.momentTimezone=this.context.getCapability('MomentTimezone');if(this.client===State.WEBCLIENT()){this.aws=this.context.getCapability('aws');this.frontmlib=this.context.getCapability('frontmlib');var capabilities=this.context.capabilities.capabilities;if(capabilities){this.sha1=this.context.capabilities.sha1;}else{this.sha1=this.context.sha1;}}else{this.sha1=this.context.getCapability('sha1');}this.currentWorkspace=this.user.info.lastLoggedInDomain;}else{this._=this.context._;this.R=this.context.R||{};this.immutable=this.context.immutable||{};this.UUID=function(){var ShortUUID=_this139.context.UUID;var uuid=ShortUUID.uuid();return ShortUUID().fromUUID(uuid);};this.userDomains=this.user.userDomains;this.moment=this.context.moment;this.momentTimezone=this.context['momentTimeZone'];this.aws=this.context['aws'];this.frontmlib=this.context['frontmlib'];this.sha1=this.context['sha1'];}this.user.roles=this.getUserRolesForDomain(this.currentUserDomain);}},{key:"syncWithBackendState",value:function syncWithBackendState(state){var _this140=this;var _=this._;if(this.messageTypeFromUser===MessageTypes.BACKEND_RESPONSE()){if(state.intentResolved){this.intentResolved=state.intentResolved;}if(state.responsesArray){this._.each(state.responsesArray,function(response){if(response.type==='form2'){var form={};form.options=response.message.options;form.fields=response.message.fields;_this140.addResponse('form2',form);}else{_this140.responsesArray.push(response);}});}if(state._activeIntent){this.addActiveIntent(state._activeIntent);}if(state._silentIntent){this._silentIntent=true;}if(state.nlpResponse){this.nlpResponse=state.nlpResponse;}if(state._nlpResults){this._nlpResults=state._nlpResults;this._lastNLPResults=state._nlpResults;}if(state.errorStack){this._.each(state.errorStack,function(error){_this140.addErrorToStack(error._errorCode,error._errorMessage);});}if(state.smartSuggestionsArray){this.smartSuggestionsArray=state.smartSuggestionsArray;}if(this._.size(state.fieldsChanged)){this.fields=this.R.merge(this.fields,state.fieldsChanged);}if(state.fieldsCleared&&Array.isArray(state.fieldsCleared)&&state.fieldsCleared.length>0){this._.forEach(state.fieldsCleared,function(field){delete _this140.fields[field];});}if(state.sendMessageParam){this.sendMessageParam=state.sendMessageParam;}if(state._blockSuggestions){this.blockSuggestions=true;}if(state.clearPrompt){this.promptAlive='';}if(Array.isArray(state.requestIdsArray)){this.requestIdsArray=this.requestIdsArray.concat(state.requestIdsArray);}if(state._intentDurations){this._intentDurations=state._intentDurations;}if(typeof state._conversational==='boolean'){this._conversational=state._conversational;}if(state._background){this._background=state._background;}if(state._sidebar){this._sidebar=state._sidebar;}if(state._navbar){this._navbar=state._navbar;}if(state.fromGreeting){this.fromGreeting=state.fromGreeting;}if(state._inSilence){this._inSilence=state._inSilence;}if(state.currentTabId){this.currentTabId=state.currentTabId;}if(this._.size(state._dynamicIntents)>0){this._dynamicIntents=state._dynamicIntents;}this._syncToEdge=state._syncToEdge;this.autoSaveBufferChanges=state.autoSaveBufferChanges;if(state.backendResponseType){this.backendResponseType=state.backendResponseType;}this.responseToClient=state.responseToClient;}else{}}},{key:"getNewRequestId",value:function getNewRequestId(){if(this.UUID){return this.UUID();}else{return null;}}},{key:"getAllProperties",value:function getAllProperties(){var response={conversationId:this['conversationId'],toCustomCap:this['toCustomCap'],intentResolved:this['intentResolved'],waitingCustomCap:this['waitingCustomCap'],lastGreetingTime:this['lastGreetingTime'],lastUserActivity:this['lastUserActivity'],_log:this._log,_intentDurations:this['_intentDurations']};if(this.promptAlive!==''){response.promptAlive=this.promptAlive;}response.errorStack=this['errorStack'];response.requestIdsArray=this['requestIdsArray'];response.fields=this.fields;response._silentIntent=this._silentIntent;response._lastNLPResults=this._lastNLPResults;response._background=this._background;response._conversational=this._conversational;response._sidebar=this._sidebar;response._inputHistory=this._inputHistory;response._routesQueue=this._routesQueue;if(this.developer._debugMode){response._debugMode=true;}if(this._currentSearchBox!==''){response._currentSearchBox=this._currentSearchBox;}response._intentHistory=this._intentHistory;response.fromGreeting=this.fromGreeting;response._inSilence=this._inSilence;if(this._.size(this._dynamicIntents)>0){response._dynamicIntents=this._dynamicIntents;}response._delayedNotification=this._.clone(this._delayedNotification)||[];response._syncToCloud=this._.clone(this._syncToCloud);response.autoSaveBufferChanges=this.autoSaveBufferChanges;return response;}},{key:"loadAutoSaveBuffer",value:function loadAutoSaveBuffer(){var _this141=this;var _=this._;var D=this.developer;return this.getPersistedField(this.autoSaveBufferKey).then(function(value){if(value){_.forEach(_.keys(value),function(key){_this141.autoSaveBuffer[key]=value[key];});}});}},{key:"storeAutoSaveBuffer",value:function storeAutoSaveBuffer(){if(this.autoSaveBuffer){return this.setPersistedField(this.autoSaveBufferKey,this.autoSaveBuffer);}}},{key:"clearAutoSaveBuffer",value:function clearAutoSaveBuffer(){this.autoSaveBuffer={};}},{key:"clearAutoSaveBufferChanges",value:function clearAutoSaveBufferChanges(){this.autoSaveBufferChanges={};}},{key:"resetAutoSaveBuffer",value:function resetAutoSaveBuffer(){return regeneratorRuntime.async(function resetAutoSaveBuffer$(_context210){while(1){switch(_context210.prev=_context210.next){case 0:_context210.next=2;return regeneratorRuntime.awrap(this.clearPersistedField(this.autoSaveBufferKey));case 2:case"end":return _context210.stop();}}},null,this);}},{key:"addObjectToSyncMessage",value:function addObjectToSyncMessage(collection,primaryKey,object){var key=this.sha1(primaryKey);if(this.location===Intent.CLOUD()){var doc=this._syncToEdge[collection]||{};doc[key]=object;this._syncToEdge[collection]=doc;}else{var _doc=this._syncToCloud[collection]||{};_doc[key]=object;this._syncToCloud[collection]=_doc;}}},{key:"addDelayedNotification",value:function addDelayedNotification(notificationParams){if(Array.isArray(this._delayedNotification)){this._delayedNotification.push(notificationParams);}else{this._delayedNotification=[notificationParams];}}},{key:"syncDataToDB",value:function syncDataToDB(){var _this142=this;var _=this._;var D=this.developer;if(this.client!==State.WEBCLIENT()){var allPromises=[];_.forEach(this._syncToCloud,function(document,collection){var collectionObject=_this142._intents[collection];if(collectionObject||collection===ALL_CONSTANTS.PERSISTED_STORAGE){_.forEach(document,function(record,key){if(collection===ALL_CONSTANTS.PERSISTED_STORAGE){allPromises.push(_this142.db.setOneValueInCacheWithExpiry(key,record,3600*24*7).catch(function(error){_this142.addSystemErrorToStack(42,'',error);}));}else{var docArray=_.get(record,'body');_.forEach(docArray,function(doc){var newDoc=collectionObject.document;if(newDoc.hasSubDocs){newDoc.buildDocumentFromContainer(doc);}else{newDoc.buildDocument(doc);}allPromises.push(newDoc.save(true).catch(function(error){_this142.addSystemErrorToStack(42,'',error);}));});}});}});if(allPromises.length>0){return Promise.all(allPromises).then(function(){_this142._syncToCloud={};}).catch(function(error){_this142.addSystemErrorToStack(42,'',error);});}else{return Promise.resolve();}}}},{key:"sendDelayedNotifications",value:function sendDelayedNotifications(){var _this143=this;if(this.location===Intent.CLOUD()&&!(this.client===State.WEBCLIENT())){var promisesArray=[];this._.forEach(this._delayedNotification,function(notification){if(notification.userDomain==='aagehempel'||notification.userDomain==='aagehempeltest'){_this143.developer.log({message:'AHG sendDelayedNotifications',data:JSON.stringify(notification)});}promisesArray.push(_this143.notification.sendDelayedNotification(notification));});this._delayedNotification=[];if(promisesArray.length>0){return Promise.all(promisesArray);}else{return Promise.resolve();}}else{return Promise.resolve();}}},{key:"removeObjectFromSyncMessage",value:function removeObjectFromSyncMessage(collection,primaryKey){var key=this.sha1(primaryKey);if(this.location===Intent.CLOUD()){delete this._syncToEdge[collection][key];}else{delete this._syncToCloud[collection][key];}}},{key:"runFunctionOnceAnHour",value:function runFunctionOnceAnHour(functionBlock){var latestTime=this._.now();if(this._.toNumber(latestTime)-this._.toNumber(this.lastGreetingTime)>3600000){this.lastGreetingTime=latestTime;return functionBlock();}}},{key:"runFunctionOnceADay",value:function runFunctionOnceADay(functionBlock){var latestTime=this._.now();if(this._.toNumber(latestTime)-this._.toNumber(this.lastGreetingTime)>86400000){this.lastGreetingTime=latestTime;return functionBlock();}}},{key:"getDeviceLocation",value:function getDeviceLocation(){return this.context.getCapability('DeviceLocation').getDeviceLocation();}},{key:"updatePassword",value:function updatePassword(oldPassword,newPassword){var _this144=this;var updatedUser={email:this.user.info.emailAddress,oldPassword:oldPassword,newPassword:newPassword};return this.context.getCapability('authContext').updatePassword(updatedUser,this.context).then(function(response){}).catch(function(error){_this144.addSystemErrorToStack(17);});}},{key:"logout",value:function logout(){var _this145=this;this['logoutInProcess']=true;return this.context.getCapability('authContext').logout(this.context).then(function(){_this145.addResponse('silent',{});});}},{key:"sendMessage",value:function sendMessage(message){this.developer.log({message:'User sending message with '+JSON.stringify(message)});this.sendMessageParam=message;}},{key:"continueInIntentWithIdAndMessage",value:function continueInIntentWithIdAndMessage(intentId,message){var object={intentId:intentId};this.sendMessage(this.R.merge(object,message));}},{key:"processIntentWithIdAndMessage",value:function processIntentWithIdAndMessage(intentId,message){var object={intentId:intentId};this.sendMessage(this.R.merge(object,message));}},{key:"processIntentWithId",value:function processIntentWithId(intentId){var object={intentId:intentId};this.sendMessage(object);}},{key:"cleanFieldsForSave",value:function cleanFieldsForSave(fields){var _this146=this;var cleanFields={};if(typeof fields==='string'){if(fields===''){fields=' ';}return fields;}else if(typeof fields==='object'){if(Array.isArray(fields)){var newArray=[];this._.each(fields,function(entry){var newEntry=_this146.cleanFieldsForSave(entry);newArray.push(newEntry);});return newArray;}else{for(var properyName in fields){var theField=fields[properyName];switch(typeof theField){case'string':{cleanFields[properyName]=this.cleanFieldsForSave(theField);break;}case'object':{cleanFields[properyName]=this.cleanFieldsForSave(theField);break;}default:{cleanFields[properyName]=theField;break;}}}}}else{return fields;}return cleanFields;}},{key:"save",value:function save(){var _this147=this;if(!this['logoutInProcess']){this.fields=this.cleanFieldsForSave(this.fields);this._lastNLPResults=this.cleanFieldsForSave(this._lastNLPResults);return deviceStorageUtil.setInContext(this.getAllProperties(),this.context).then(function(){_this147.developer.info({message:'State saved'});_this147.error=false;return _this147;}).catch(function(err){_this147.developer.info({message:"Error saving the state: "+err.message});_this147.error=true;return _this147;});}}},{key:"getUniqueId",value:function getUniqueId(){return this.UUID();}},{key:"setField",value:function setField(fieldName,fieldValue){this.fields[fieldName]=fieldValue;this.fieldsChanged[fieldName]=fieldValue;var index=this.fieldsCleared.indexOf(fieldName);if(index>-1){this.fieldsCleared.splice(index,1);}}},{key:"commonSetFieldLogic",value:function commonSetFieldLogic(key,fieldValue,expire){this.addObjectToSyncMessage(ALL_CONSTANTS.PERSISTED_STORAGE,key,fieldValue);var redisKey=this.sha1(key);if(this.location===Intent.CLOUD()||this.client===State.WEBCLIENT()||this.location===Intent.EDGE()&&this.v1Compatibility){var redisExpire=expire||3600*24*7;return this.db.setOneValueInCacheWithExpiry(redisKey,fieldValue,redisExpire);}else{return this.deviceStorage.saveKeyInStorage(redisKey,fieldValue);}}},{key:"commonGetFieldLogic",value:function commonGetFieldLogic(key){var result,response;return regeneratorRuntime.async(function commonGetFieldLogic$(_context211){while(1){switch(_context211.prev=_context211.next){case 0:if(!(this.location===Intent.CLOUD()||this.client===State.WEBCLIENT()||this.location===Intent.EDGE()&&this.v1Compatibility)){_context211.next=14;break;}_context211.next=3;return regeneratorRuntime.awrap(this.db.getValueFromCache(key));case 3:result=_context211.sent;if(!result){_context211.next=12;break;}_context211.prev=5;return _context211.abrupt("return",JSON.parse(this._.get(result,'content')));case 9:_context211.prev=9;_context211.t0=_context211["catch"](5);return _context211.abrupt("return",this._.get(result,'content'));case 12:_context211.next=18;break;case 14:_context211.next=16;return regeneratorRuntime.awrap(this.deviceStorage.getKeyFromStorage(key));case 16:response=_context211.sent;return _context211.abrupt("return",response);case 18:case"end":return _context211.stop();}}},null,this,[[5,9]]);}},{key:"commonClearFieldLogic",value:function commonClearFieldLogic(key){return regeneratorRuntime.async(function commonClearFieldLogic$(_context212){while(1){switch(_context212.prev=_context212.next){case 0:if(!(this.location===Intent.CLOUD()||this.client===State.WEBCLIENT()||this.location===Intent.EDGE()&&this.v1Compatibility)){_context212.next=5;break;}_context212.next=3;return regeneratorRuntime.awrap(this.db.deleteOneKeyInCache(key));case 3:_context212.next=7;break;case 5:_context212.next=7;return regeneratorRuntime.awrap(this.deviceStorage.removeKeyFromStorage(key));case 7:case"end":return _context212.stop();}}},null,this);}},{key:"setSharedField",value:function setSharedField(fieldName,fieldValue,expire){var key=ALL_CONSTANTS.PERSISTED_FIELD_PREFIX+"_"+fieldName;return this.commonSetFieldLogic(key,fieldValue,expire);}},{key:"getSharedField",value:function getSharedField(fieldName){var key=this.sha1(ALL_CONSTANTS.PERSISTED_FIELD_PREFIX+"_"+fieldName);return this.commonGetFieldLogic(key);}},{key:"clearSharedField",value:function clearSharedField(fieldName){var key=ALL_CONSTANTS.PERSISTED_FIELD_PREFIX+"_"+fieldName;return this.commonClearFieldLogic(this.sha1(key));}},{key:"setPersistedField",value:function setPersistedField(fieldName,fieldValue){var key=""+ALL_CONSTANTS.PERSISTED_FIELD_PREFIX+this.conversationId+"_"+fieldName;var expire=3600*24*7;return this.commonSetFieldLogic(key,fieldValue,expire);}},{key:"getPersistedField",value:function getPersistedField(fieldName){var key=""+ALL_CONSTANTS.PERSISTED_FIELD_PREFIX+this.conversationId+"_"+fieldName;return this.commonGetFieldLogic(this.sha1(key));}},{key:"clearPersistedField",value:function clearPersistedField(fieldName){var key=""+ALL_CONSTANTS.PERSISTED_FIELD_PREFIX+this.conversationId+"_"+fieldName;return this.commonClearFieldLogic(this.sha1(key));}},{key:"getPersistedFields",value:function getPersistedFields(fieldNames){var _this148=this;var keysArray,response,_i19,redisKey,responseFromCache,_i21,_redisKey,value;return regeneratorRuntime.async(function getPersistedFields$(_context213){while(1){switch(_context213.prev=_context213.next){case 0:if(!Array.isArray(fieldNames)){_context213.next=25;break;}keysArray=[];response={};if(!(this.location===Intent.CLOUD()||this.client===State.WEBCLIENT()||this.location===Intent.EDGE()&&this.v1Compatibility)){_context213.next=12;break;}for(_i19=0;_i19<fieldNames.length;_i19++){redisKey=""+ALL_CONSTANTS.PERSISTED_FIELD_PREFIX+this.conversationId+"_"+fieldNames[_i19];keysArray.push(this.sha1(redisKey));}_context213.next=7;return regeneratorRuntime.awrap(this.db.getMultipleValuesFromCache(keysArray));case 7:responseFromCache=_context213.sent;this.developer.log({message:'Content from Redis',data:responseFromCache});if(responseFromCache){this._.forEach(keysArray,function(key){var payload=responseFromCache[key];if(payload){try{var field='';var _i20=_this148._.findIndex(fieldNames,function(fieldName){var redisKey=""+ALL_CONSTANTS.PERSISTED_FIELD_PREFIX+_this148.conversationId+"_"+fieldName;field=fieldName;return key===_this148.sha1(redisKey);});if(_i20!==-1){response[field]=JSON.parse(_this148._.get(payload,'content'));}}catch(error){_this148.addSystemErrorToStack(39,null,error.message);_this148.developer.log({message:'Data from Redis',data:_this148._.get(payload,'content')});}}});}_context213.next=22;break;case 12:_i21=0;case 13:if(!(_i21<fieldNames.length)){_context213.next=22;break;}_redisKey=""+ALL_CONSTANTS.PERSISTED_FIELD_PREFIX+this.conversationId+"_"+fieldNames[_i21];_context213.next=17;return regeneratorRuntime.awrap(this.deviceStorage.getKeyFromStorage(this.sha1(_redisKey)));case 17:value=_context213.sent;if(value)response[fieldNames[_i21]]=value;case 19:_i21++;_context213.next=13;break;case 22:return _context213.abrupt("return",response);case 25:this.addSystemErrorToStack(7,'getPersistedFields: fieldNames parameter must be an array');return _context213.abrupt("return",null);case 27:case"end":return _context213.stop();}}},null,this);}},{key:"clearField",value:function clearField(fieldName){delete this.fields[fieldName];this.fieldsCleared.push(fieldName);}},{key:"getField",value:function getField(fieldName){var field=this.fields[fieldName];if(typeof field!=='undefined'){return field;}else{return null;}}},{key:"hasFieldInPath",value:function hasFieldInPath(path){return!!this.R.path(path,this.fields);}},{key:"addSmartSuggestions",value:function addSmartSuggestions(newSmartSuggestion){this.smartSuggestionsArray.push(newSmartSuggestion);}},{key:"addSmartSuggestionsArray",value:function addSmartSuggestionsArray(newSmartSuggestions){var _this149=this;this.developer.log({message:'Adding smart suggestions',data:newSmartSuggestions});var _=this._;_.each(newSmartSuggestions,function(suggestionObject){if(suggestionObject.lang===_this149.lang){_this149.smartSuggestionsArray=_this149.smartSuggestionsArray.concat(suggestionObject.list);}});}},{key:"addEnglishSmartSuggestions",value:function addEnglishSmartSuggestions(newSmartSuggestions){var smartSuggestionsArray=[{lang:'en',list:newSmartSuggestions}];this.addSmartSuggestionsArray(smartSuggestionsArray);}},{key:"clearSmartSuggestionsArray",value:function clearSmartSuggestionsArray(){this.smartSuggestionsArray=[];this._blockSuggestions=false;}},{key:"addActiveIntent",value:function addActiveIntent(intentId){var _this150=this;var logHistory=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;var silent=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;this._silentIntent=silent;var cutIn10=function cutIn10(){if(_this150._intentHistory.length>10){_this150._intentHistory.splice(0,1);cutIn10();}};this._activeIntent=intentId;if(logHistory){this._intentHistory.push(intentId);}cutIn10();}},{key:"removeActiveIntent",value:function removeActiveIntent(){if(this._activeIntent!==''){this._activeIntent='';}}},{key:"addSystemErrorToStack",value:function addSystemErrorToStack(code,message,data){var errorObject=new Error(this,code,message);this.developer.systemError({message:errorObject.errorMessage,errorCode:code,data:data});this.errorStack.push(errorObject);}},{key:"addErrorToStack",value:function addErrorToStack(code,message,data){var errorObject={};if(code<999){errorObject=new Error(this,1000,message);}else{errorObject=new Error(this,code,message);}this.developer.userError({message:errorObject.errorMessage,errorCode:code,data:data});this.errorStack.push(errorObject);}},{key:"clearError",value:function clearError(){this.errorStack=[];}},{key:"addStringResponse",value:function addStringResponse(message){this.addResponse('string',message);}},{key:"addStandardNotificationResponse",value:function addStandardNotificationResponse(message){this.addResponse('standard_notification',message);}},{key:"addCriticalNotificationResponse",value:function addCriticalNotificationResponse(message){this.addResponse('critical_notification',message);}},{key:"addAuthorizationRequestResponse",value:function addAuthorizationRequestResponse(message){this.addResponse('authorization_request',message);}},{key:"addFormResponse",value:function addFormResponse(message){this.addResponse('form2',message);}},{key:"addShortFormResponse",value:function addShortFormResponse(message){this.addResponse(MessageTypes.SHORT_FORM_RESPONSE(),message);}},{key:"addFormChangeResponse",value:function addFormChangeResponse(message){this.addResponse('form_live_changes',message);}},{key:"addInLineFormChangeResponse",value:function addInLineFormChangeResponse(message){this.addResponse('table_live_changes',message);}},{key:"addMapResponse",value:function addMapResponse(message){this.addResponse('map',message);}},{key:"addChartResponse",value:function addChartResponse(message){this.addResponse('chart',message);}},{key:"addTableResponse",value:function addTableResponse(message){this.addResponse('table',message);}},{key:"addShortTableResponse",value:function addShortTableResponse(message){this.addResponse(MessageTypes.SHORT_TABLE_RESPONSE(),message);}},{key:"addTrackingViewResponse",value:function addTrackingViewResponse(message){this.addResponse('trackerForm',message);}},{key:"addCardsResponse",value:function addCardsResponse(message){this.addResponse('cards',message);}},{key:"addHTMLResponse",value:function addHTMLResponse(message){this.addResponse('html',{message:{},options:message});}},{key:"addContainerResponse",value:function addContainerResponse(message){this.addResponse('container',message);}},{key:"addVideoCallResponse",value:function addVideoCallResponse(message){this.addResponse('videoCall',message);}},{key:"addVoiceCallResponse",value:function addVoiceCallResponse(message){this.addResponse(MessageTypes.MESSAGE_VOICE_CALL(),message);}},{key:"addMenuResponse",value:function addMenuResponse(message){this.addResponse('menuMessage',message);}},{key:"addSoundResponse",value:function addSoundResponse(message){var soundMessage=message;if(!message){soundMessage={sound:'FrontM_Ring.mp3'};}this.addResponse('sound',soundMessage);}},{key:"addCsvResponse",value:function addCsvResponse(message){this.addResponse('csv',message);}},{key:"addFloorPlanResponse",value:function addFloorPlanResponse(message){this.addResponse(FloorPlan.FLOOR_PLAN_MESSAGE(),message);}},{key:"addGeofenceResponse",value:function addGeofenceResponse(message){this.addResponse(Geofence.GEOFENCE_MESSAGE(),message);}},{key:"addGallerySelectionResponse",value:function addGallerySelectionResponse(message){this.addResponse(GallerySelection.GALLERY_SELECTION_MESSAGE(),message);}},{key:"addJourneyPlanResponse",value:function addJourneyPlanResponse(message){this.addResponse(JourneyPlan.JOURNEY_PLAN_MESSAGE(),message);}},{key:"addRunModeResponse",value:function addRunModeResponse(){var runModeMessage={background:this.background,sidebar:this.sidebar,navbar:this.navbar,chatButtonHidden:this.chatButtonHidden,waitingIcon:this._waitingIcon,cssFilePath:this._cssFilePath,suggestionsLayout:this._suggestionsLayout,modal:this._modal};var Message=this.context.getCapability('Message');var message=new Message();message.runMode(runModeMessage);this.context.tell(message);}},{key:"addStringResponseFromArray",value:function addStringResponseFromArray(messages){var error=false;if(Array.isArray(messages)){var index=Math.round(Math.random()*(messages.length-1));var message=messages[index];if(typeof message==='string'){this.addResponse('string',message);}else{error=true;}}else{error=true;}if(error){this.addErrorToStack(23,Error.getErrorMessageforCodeAndLang(23,this.lang));}}},{key:"addSilentResponse",value:function addSilentResponse(){this.developer.info({message:'Adding Silent response'});this.addResponse('silent',{});}},{key:"addResponse",value:function addResponse(type,message){if(this.developer.runProfile){if(type==='string'){this.developer.info({message:'Added response '+message});}else{this.developer.info({message:'Added message type '+type});}}if(message){if(message.options){if(this.currentControlId!==null){message.options['parentControlId']=this.currentControlId;}if(this.currentTabId){message.options.tabId=this.currentTabId;}if(!message.options.controlId){message.options.controlId=this.getUniqueId();}}else{if(message.tabId&&this.currentTabId){message.tabId=this.currentTabId;}}var messageToView=message;this.responsesArray.push({type:type,message:messageToView,messageId:this.getUniqueId()});}else{this.addSystemErrorToStack(14,type);}}},{key:"clearRoutesQueue",value:function clearRoutesQueue(){this._routesQueue={};}},{key:"clearResponseArray",value:function clearResponseArray(){this.responsesArray=[];}},{key:"setWaitingCustomCap",value:function setWaitingCustomCap(){if(!this.silentIntent){this.waitingCustomCap+=1;}}},{key:"resetWaitingForCustomCapCounter",value:function resetWaitingForCustomCapCounter(){this.waitingCustomCap=0;}},{key:"addRequestId",value:function addRequestId(requestId){this.requestIdsArray.unshift(requestId);if(this.requestIdsArray.length>10){this.requestIdsArray.pop();}}},{key:"markRequestIdProcessed",value:function markRequestIdProcessed(requestId){var indexOfRequestId=this.requestIdsArray.indexOf(requestId);if(indexOfRequestId===-1){this.addRequestId(requestId);if(this.waitingCustomCap>0){this.waitingCustomCap-=1;}return true;}else{return false;}}},{key:"stateToBackEnd",value:function stateToBackEnd(){var _=this._;var stateToBackend={lang:this.lang,intentResolved:this.intentResolved,messageTypeFromUser:this.messageTypeFromUser,messageFromUser:this.messageFromUser,messageIdFromUser:this.messageIdFromUser,messageTypeIntFromUser:this.messageTypeIntFromUser,messageCreatedOnFromUser:this.messageCreatedOnFromUser,messageCreatedByFromUser:this.messageCreatedByFromUser,messageContentFromUser:this.messageContentFromUser,messageOptionsFromUser:this.messageOptionsFromUser,userName:this.userName,tz:this.user.tz,fields:this.fields,_intentHistory:this._intentHistory};if(this.fromGreeting){stateToBackend.fromGreeting=this.fromGreeting;}if(this.promptAlive!==''){stateToBackend.promptAlive=this.promptAlive;}if(this._activeIntent!==''){stateToBackend._activeIntent=this._activeIntent;}if(this._intentDurations!==''){stateToBackend._intentDurations=this._intentDurations;}if(this.developer._debugMode){stateToBackend._debugMode=true;}stateToBackend.client=this.client;if(this._currentSearchBox!==''){stateToBackend._currentSearchBox=this._currentSearchBox;}stateToBackend.client=this.client;stateToBackend.currentWorkspace=this.currentWorkspace;stateToBackend._inSilence=this._inSilence;if(_.size(this._dynamicIntents)>0){stateToBackend._dynamicIntents=this._dynamicIntents;}stateToBackend._syncToCloud=this._syncToCloud;if(Array.isArray(this._delayedNotification)&&this._delayedNotification.length>0){stateToBackend._delayedNotification=_.clone(this._delayedNotification);this._delayedNotification=[];}stateToBackend.autoSaveBufferChanges=this.autoSaveBufferChanges;return{state:stateToBackend};}},{key:"getFinalResponsesArray",value:function getFinalResponsesArray(){var _=this._;var finalResponse={};if(this.nlpResponse){finalResponse.nlpResponse=this.nlpResponse;}if(this._nlpResults){finalResponse._nlpResults=this._nlpResults;}if(_.size(this['errorStack'])>0){finalResponse.errorStack=this['errorStack'];}if(_.size(this['responsesArray'])>0){finalResponse.responsesArray=this['responsesArray'];}if(this['smartSuggestionsArray']&&_.size(this['smartSuggestionsArray'])>0){finalResponse.smartSuggestionsArray=this['smartSuggestionsArray'];}if(this['intentResolved']){finalResponse.intentResolved=this['intentResolved'];}finalResponse.responseToClient=this.client;return finalResponse;}},{key:"getFinalResponseState",value:function getFinalResponseState(){var _=this._;var finalResponse={};if(this['_activeIntent']!==''){finalResponse._activeIntent=this['_activeIntent'];}finalResponse.fieldsChanged=this.fieldsChanged;finalResponse.fieldsCleared=this.fieldsCleared;if(this.developer._debugMode){finalResponse._debugMode=true;}if(this.sendMessageParam){finalResponse.sendMessageParam=this.sendMessageParam;}if(this.blockSuggestions){finalResponse._blockSuggestions=true;}if(this.silentIntent){finalResponse._silentIntent=true;}if(this.clearPrompt){finalResponse.clearPrompt=true;}if(this.requestIdsArray.length>0){finalResponse.requestIdsArray=this.requestIdsArray;}if(this._intentDurations){finalResponse._intentDurations=this._intentDurations;}if(this._autoSavePresent){finalResponse._autoSavePresent=this._autoSavePresent;}if(this.fromGreeting){finalResponse._conversational=this._conversational;finalResponse._background=this._background;finalResponse._sidebar=this._sidebar;finalResponse.fromGreeting=this.fromGreeting;}if(this._inSilence){finalResponse._inSilence=this._inSilence;}if(this._.size(this._dynamicIntents)>0){finalResponse._dynamicIntents=this._dynamicIntents;}if(this.currentTabId){finalResponse.currentTabId=this.currentTabId;}finalResponse.backendResponseType=1;finalResponse.responseToClient=this.client;return finalResponse;}},{key:"getFinalResponseSync",value:function getFinalResponseSync(){var _=this._;var finalResponse={};finalResponse._syncToEdge=this._syncToEdge;finalResponse.autoSaveBufferChanges=this.autoSaveBufferChanges;finalResponse.backendResponseType=2;finalResponse.responseToClient=this.client;return finalResponse;}},{key:"sizeOfObject",value:function sizeOfObject(object){try{var typeSizes={symbol:function symbol(){return 0;},function:function _function(){return 0;},undefined:function undefined(){return 0;},boolean:function boolean(){return 4;},number:function number(){return 8;},string:function string(item){return 2*item.length;},object:function object(item){return!item?0:Object.keys(item).reduce(function(total,key){return _sizeOf(key)+_sizeOf(item[key])+total;},0);}};var _sizeOf=function _sizeOf(object){return typeSizes[typeof object](object);};return _sizeOf(object);}catch(error){return 0;}}},{key:"getGreetingIntent",value:function getGreetingIntent(Bot){var _this151=this;var bot=this.bot(Bot);if(this._intents['main']){return this._intents['main'];}var _=this._;var greetingIntent=null;_.each(bot,function(intent){if(_.get(intent,'intentId')==='main'){greetingIntent=intent;return false;}else if(!_.get(intent,'intentId')){_this151.addSystemErrorToStack(38);}else{_this151.developer.debug({message:'Looping intents',data:_.get(intent,'intentId')});}});return greetingIntent;}},{key:"silenceBot",value:function silenceBot(){this._inSilence=true;}},{key:"wakeUpBot",value:function wakeUpBot(){this._inSilence=false;}},{key:"resumeBot",value:function resumeBot(){this._inSilence=false;}},{key:"setVerticalSuggestions",value:function setVerticalSuggestions(){this._suggestionsLayout='vertical';}},{key:"addMeToTheConversation",value:function addMeToTheConversation(conversationId){var CONVERSATIONS_TABLE,query,conversationObject,participants,doc,key,cachedConversation,parsedCacheConversation;return regeneratorRuntime.async(function addMeToTheConversation$(_context214){while(1){switch(_context214.prev=_context214.next){case 0:CONVERSATIONS_TABLE='Conversations';query=[{operand:'conversationId',value:conversationId,operator:'eq'},{operand:'userDomain',value:this.currentUserDomain,operator:'eq'}];_context214.next=4;return regeneratorRuntime.awrap(this.db.getData(CONVERSATIONS_TABLE,query));case 4:conversationObject=_context214.sent;if(!conversationObject.items){_context214.next=20;break;}participants=this._.get(conversationObject.items[0],'participants');if(!(participants.indexOf(this.user.userId)===-1)){_context214.next=20;break;}participants.push(this.user.userId);doc=[{key:{conversationId:conversationId,userDomain:this.currentUserDomain},document:{participants:participants}}];_context214.next=12;return regeneratorRuntime.awrap(this.db.writeData(CONVERSATIONS_TABLE,doc));case 12:key='Conversations_'+conversationId+'_'+this.currentUserDomain;_context214.next=15;return regeneratorRuntime.awrap(this.db.getValueFromCache(key));case 15:cachedConversation=_context214.sent;parsedCacheConversation=JSON.parse(cachedConversation.content);parsedCacheConversation.participants=participants;_context214.next=20;return regeneratorRuntime.awrap(this.db.setOneValueInCache(key,parsedCacheConversation));case 20:case"end":return _context214.stop();}}},null,this);}},{key:"setIntentWithId",value:function setIntentWithId(id,intent){this._intents[id]=intent;}},{key:"addDynamicIntent",value:function addDynamicIntent(intent){this._dynamicIntents[intent.id]=intent;}},{key:"clearDynamicIntents",value:function clearDynamicIntents(){this._dynamicIntents={};}},{key:"createAutoSaveIntent",value:function createAutoSaveIntent(intentName,location){var _this152=this;var autoSaveIntent=new Intent(intentName);if(location===Intent.EDGE()){autoSaveIntent.onMatching=function(){return _this152.client!==State.WEBCLIENT()&&_this152._.get(_this152.messageFromUser,'intentId')===ALL_CONSTANTS.AUTO_SAVE_INTENT_EDGE;};}else{autoSaveIntent.runOnCloud();autoSaveIntent.onMatching=function(){return _this152.client!==State.WEBCLIENT()&&_this152._.get(_this152.messageFromUser,'intentId')===ALL_CONSTANTS.AUTO_SAVE_INTENT_CLOUD;};}autoSaveIntent.onResolution=function _callee86(){var _,tabId,value,field,autoSaveBuffer,autoSavedDoc;return regeneratorRuntime.async(function _callee86$(_context215){while(1){switch(_context215.prev=_context215.next){case 0:_=_this152._;tabId=_.get(_this152.messageFromUser,'tabId');value=_.get(_this152.messageFromUser,'value');field=_.get(_this152.messageFromUser,'field');autoSaveBuffer=_this152.autoSaveBuffer;if(tabId){autoSavedDoc=_.get(autoSaveBuffer,tabId,{});if(value){autoSavedDoc[field]=value;}else{if(autoSavedDoc[field]){delete autoSavedDoc[field];}}autoSaveBuffer[tabId]=autoSavedDoc;}case 6:case"end":return _context215.stop();}}},null,_this152);};this.setIntentWithId(autoSaveIntent.intentId,autoSaveIntent);this.addSilentResponse();}},{key:"bot",value:function bot(BOT){var _this153=this;var _=this._;var D=this.developer;var createDynamicIntents=function createDynamicIntents(){var dynamicIntentsObject={};_.forEach(_this153._dynamicIntents,function(dynamicIntent){if(_.get(dynamicIntent,'type')==='Doc'){var id=dynamicIntent.id;var options=dynamicIntent.options;var doc=new Doc(id,_this153,{title:options.title,description:options.description,confirm:options.confirm,cancel:options.cancel});doc.onSubmit=function _callee87(){return regeneratorRuntime.async(function _callee87$(_context216){while(1){switch(_context216.prev=_context216.next){case 0:_context216.next=2;return regeneratorRuntime.awrap(doc.save());case 2:case"end":return _context216.stop();}}},null,_this153);};dynamicIntentsObject[id]=doc;}});var c=void 0;_.forEach(_this153._dynamicIntents,function(dynamicIntent){if(_.get(dynamicIntent,'type')==='Field'){var doc=_.get(dynamicIntent,'options.doc');var dynamicDocument=_this153._intents[doc];if(dynamicDocument){var f=Field.createNewDynamicField(_.get(dynamicIntent,'options'),dynamicDocument,_this153);dynamicIntentsObject[_.get(dynamicIntent,'id')]=f;}}else if(_.get(dynamicIntent,'type')==='Collection'){var id=_.get(dynamicIntent,'id');var title=_.get(dynamicIntent,'options.title');var description=_.get(dynamicIntent,'options.description');var _document5=_.get(dynamicIntent,'options.document');var _dynamicDocument=_this153._intents[_document5];if(_dynamicDocument){c=new Collection(id,{document:_this153._intents[_document5],title:title,description:description,botState:_this153});dynamicIntentsObject[id]=c;}}});if(c){c.onAction=function _callee88(){var surveyInstanceIdFromSelection,surveyInstanceId;return regeneratorRuntime.async(function _callee88$(_context217){while(1){switch(_context217.prev=_context217.next){case 0:surveyInstanceIdFromSelection=_this153.messageFromUser.content[Surveys.SURVEY_INSTANCE_ID_TITLE()];surveyInstanceId=c.document.f[Surveys.SURVEY_BASIC_FIELDS().SURVEY_INSTANCE_ID];surveyInstanceId.value=surveyInstanceIdFromSelection;c.document.readOnly=true;c.document.confirm='Ok';delete c.document.cancel;_context217.next=8;return regeneratorRuntime.awrap(c.document.loadDocument());case 8:_this153.surveys.hideNonRequiredFieldFromSurvey(c.document);c.document.sendResponse();case 10:case"end":return _context217.stop();}}},null,_this153);};}return dynamicIntentsObject;};var botArray=BOT(this);if(Array.isArray(botArray)&&botArray.length>0){_.forEach(botArray,function(intent){_this153.setIntentWithId(intent.intentId,intent);});return botArray;}else{var newIntentsObject=createDynamicIntents();var valueToReturn=_extends({},this._intents,newIntentsObject);return _.values(valueToReturn);}}},{key:"sendMessageToQueue",value:function sendMessageToQueue(queue,message){var params;return regeneratorRuntime.async(function sendMessageToQueue$(_context218){while(1){switch(_context218.prev=_context218.next){case 0:if(!(this.location===Intent.CLOUD())){_context218.next=12;break;}_context218.prev=1;params={message:JSON.stringify(message),sqsQueue:queue};_context218.next=5;return regeneratorRuntime.awrap(this.frontmlib.invokeLambda("SendSQSMessages","Event",params));case 5:_context218.next=10;break;case 7:_context218.prev=7;_context218.t0=_context218["catch"](1);this.addSystemErrorToStack(7,"Error sending SQS message",_context218.t0);case 10:_context218.next=13;break;case 12:this.addSystemErrorToStack(55);case 13:case"end":return _context218.stop();}}},null,this,[[1,7]]);}},{key:"sendResponseToClient",value:function sendResponseToClient(content){var createdOn,createdBy,contentType,messageId,message,data;return regeneratorRuntime.async(function sendResponseToClient$(_context219){while(1){switch(_context219.prev=_context219.next){case 0:createdOn=Date.now();createdBy='AgentM';contentType=150;messageId=this.getUniqueId();message={createdOn:createdOn,createdBy:createdBy,contentType:contentType,messageId:messageId,message:content};data={queueMsgs:[{userId:this.user.userId,userEmail:this.user.userEmail,conversation:this.conversationId,bot:this.botId,requestUuid:this.getUniqueId(),createdOn:createdOn,createdBy:createdBy,contentType:contentType,messageId:messageId,conversational:this.conversational,details:[message]}]};_context219.next=8;return regeneratorRuntime.awrap(this.frontmlib.invokeLambda("RedisWriteQueue","RequestResponse",data));case 8:case"end":return _context219.stop();}}},null,this);}},{key:"version",set:function set(version){this._version=version;}},{key:"lastMainTimeStamp",get:function get(){return this.getField(ALL_CONSTANTS.COMMON_FIELDS.LAST_MAIN_TIMESTAMP);}},{key:"onError",set:function set(onErrorBlock){this._onError=onErrorBlock;},get:function get(){return this._onError;}},{key:"silentIntent",get:function get(){return this._silentIntent;}},{key:"activeIntent",get:function get(){return this._activeIntent;}},{key:"nlpResults",get:function get(){return this._nlpResults;},set:function set(nlpResults){this._nlpResults=nlpResults;}},{key:"previousActiveIntent",get:function get(){var l=this._intentHistory.length;var r='';if(l>1){if(this._activeIntent===''){r=this._intentHistory[l-1];}else{r=this._intentHistory[l-2];}}else{if(l===1){if(this._activeIntent===''){r=this._intentHistory[0];}}}return r;}},{key:"searchBoxes",get:function get(){return this._searchBoxes;}},{key:"currentSearchBox",set:function set(searchBox){this._currentSearchBox=searchBox;},get:function get(){return this._currentSearchBox;}},{key:"autoSaveBufferKey",get:function get(){if(this.currentTabId){return ALL_CONSTANTS.AUTO_SAVE_BUFFER_FIELD+"_"+this.currentTabId;}else{return ALL_CONSTANTS.AUTO_SAVE_BUFFER_FIELD;}}},{key:"blockSuggestions",set:function set(flag){this._blockSuggestions=flag;},get:function get(){return this._blockSuggestions;}},{key:"inError",get:function get(){return this._.size(this.errorStack)>0;}},{key:"conversational",set:function set(flag){this._conversational=flag;},get:function get(){return this._conversational;}},{key:"waitingIcon",set:function set(waitingIcon){this._waitingIcon=waitingIcon;},get:function get(){return this._waitingIcon;}},{key:"background",set:function set(message){this._background=message;},get:function get(){return this._background;}},{key:"sidebar",set:function set(message){this._sidebar=message;},get:function get(){return this._sidebar;}},{key:"navbar",set:function set(message){this._navbar=message;},get:function get(){return this._navbar;}},{key:"cssFilePath",set:function set(message){this._cssFilePath=message;},get:function get(){return this._cssFilePath;}},{key:"intentHistory",get:function get(){return this.intentHistory;}},{key:"currentUserDomain",get:function get(){return this.conversation.userDomain;}},{key:"isPublic",get:function get(){if(this.user.userName.substring(0,5)==='Anon_'){return true;}return false;}},{key:"unitTestMode",get:function get(){return this._unitTestMode;},set:function set(mode){this._unitTestMode=true;}},{key:"inSilence",get:function get(){return this._inSilence;}},{key:"modal",get:function get(){return this._modal;},set:function set(modal){this._modal=modal;}},{key:"currentControlId",get:function get(){return this._currentControlId;},set:function set(currentControlId){this._currentControlId=currentControlId;}},{key:"dynamicIntents",get:function get(){return this._dynamicIntents;}},{key:"intents",get:function get(){return this._intents;}}]);return State;}();var SYNC=false;var NO_INTENT_MESSAGE="Sorry, I didn't get that";var iAmTheOne=null;var waitForRunmode=500;var timeout=function timeout(ms){return new Promise(function(resolve){return setTimeout(resolve,ms);});};var deviceStorageUtil={conversation:'',getContext:function getContext(botContext,DeviceStorage){DeviceStorage=DeviceStorage||botContext.getCapability('DeviceStorage');return DeviceStorage.get(deviceStorageUtil.conversation);},setInContext:function setInContext(state,botContext){var DeviceStorage=botContext.getCapability('DeviceStorage');return DeviceStorage.save(state.conversationId,state);},resetContext:function resetContext(conversationId,botContext){var DeviceStorage=botContext.getCapability('DeviceStorage');return DeviceStorage.save(conversationId,{});},removeFromContext:function removeFromContext(key,botContext){var DeviceStorage=botContext.getCapability('DeviceStorage');return deviceStorageUtil.getContext(botContext,DeviceStorage).then(function(state){delete state[key];return DeviceStorage.save(deviceStorageUtil.conversation,state);});}};var callLambda=function callLambda(functionName,params,aws){var lambda=new aws.Lambda();return lambda.invoke({FunctionName:functionName,InvocationType:'RequestResponse',Payload:JSON.stringify(params,null,0)}).promise();};var runMatchers=function runMatchers(state){state.developer.info({message:'Starting matching event'});var start=Date.now();var _=state._;var promiseProcessed=false;return new Promise(function(resolve,reject){if(state.messageTypeFromUser===MessageTypes.BACKEND_RESPONSE()||state.activeIntent!==''){promiseProcessed=true;resolve();}else if(state.developer.isDeveloperIntent()){var devIntent=state.developer.identifyDeveloperIntent();if(devIntent){state.addActiveIntent(devIntent,false);}else{state.addSystemErrorToStack(12);state.addActiveIntent(Intent.NO_INTENT());}promiseProcessed=true;resolve();}else{var bot=state.bot(Bot);_.each(bot,function(intent){if(intent.intentId){if(intent.runLocation){if(intent.runLocation!==Intent.EDGE()&&intent.runLocation!==Intent.CLOUD()){state.addSystemErrorToStack(1);resolve();promiseProcessed=true;return false;}if(typeof intent.onMatching==='function'&&intent.intentId!=='main'){if(intent.onMatching(state)){if(promiseProcessed){state.developer.info({message:'Second intent matched to '+intent.intentId});if(state.messageTypeFromUser===Doc.FORM_RESPONSE()||state.messageTypeFromUser===Collection.TABLE_RESPONSE()||state.messageTypeFromUser===Container.CONTAINER_RESPONSE()){state.addSystemErrorToStack(34);}else{state.addSystemErrorToStack(35);}state.removeActiveIntent();return false;}else{state.developer.info({message:'Intent matched to '+intent.intentId});state.addActiveIntent(intent.intentId,intent.logHistory,intent.silentIntent);promiseProcessed=true;var action=_.get(state.messageFromUser,'action');if(action){intent._presentEvent=action;}if(intent.runLocation===Intent.CLOUD()&&(state.client===State.MOBILECLIENT()||state.client===State.EDGE_WEBCLIENT()))state.toCustomCap=true;}}}}else{state.addSystemErrorToStack(2);resolve();promiseProcessed=true;return false;}}else{state.addSystemErrorToStack(21);resolve();promiseProcessed=true;return false;}});}return state.online().then(function(online){if(!promiseProcessed){if(online&&state.messageTypeFromUser===state.messageTypes.MESSAGE_TYPE_STRING&&(state.client===State.MOBILECLIENT()||state.client===State.EDGE_WEBCLIENT())){state.toCustomCap=true;}}else{if(!online&&state.toCustomCap){state.toCustomCap=false;}}resolve();state.developer.logCurrentEventDurationWithStartTime('runMatchers',start,Date.now());});});};var callCustomCap=function callCustomCap(state){console.log('************* Calling custom cap ****************');state.developer.info({message:'Calling cloud capabilities'});state.context.wait(true);var start=Date.now();var agentGuardService=state.context.getCapability('agentGuardService');var requestId=state.getNewRequestId();var stateToBackend=state.stateToBackEnd();return state.deviceStorage.getKeyFromStorage(ALL_CONSTANTS.TO_SYNC_WITH_BACKEND).then(function(sync){console.log("************* "+JSON.stringify(stateToBackend));return agentGuardService.executeBackendBot(stateToBackend,SYNC,requestId,state.context,state.user).then(function(response){state.developer.info({message:'Backend call successful'});state.setWaitingCustomCap();state.developer.logCurrentEventDurationWithStartTime('callCustomCap',start,Date.now());state._delayedNotification={};state._syncToCloud={};return state.deviceStorage.removeKeyFromStorage(ALL_CONSTANTS.TO_SYNC_WITH_BACKEND);}).catch(function(error){console.log("************* Some sort of problem "+JSON.stringify(error));if(agentGuardService.AG_ERRORS.QUEUED_REQUEST===error){return state.online().then(function(online){if(!online){state.addStringResponse("You are offline, but dont worry, information is not lost and will be processed when the connection is back");}});}else{state.addSystemErrorToStack(5,error);}state.developer.logCurrentEventDurationWithStartTime('callCustomCap',start,Date.now());});});};var runValidators=function runValidators(state){state.developer.info({message:'Starting validation event'});var start=Date.now();var _=state._;var activeIntent=state.activeIntent;var validationResult=true;if(activeIntent!==Intent.NO_INTENT()){var bot=state.bot(Bot);_.forEach(bot,function(intent){if(intent.intentId===activeIntent){if(intent.onError){state.onError=intent.onError;}try{if(intent.onValidation){state.developer.info({message:'Starting onValidation for intent '+intent.intentId});intent.onValidation(state);if(state._.size(state.errorStack)>0){}}}catch(error){var errorCode=state.location===Intent.EDGE()?5:7;state.addSystemErrorToStack(errorCode,error.message);}}});}state.developer.logCurrentEventDurationWithStartTime('runValidators',start,Date.now());return validationResult;};var runResolvers=function runResolvers(state){console.log('************* Resolvers method ****************');state.developer.info({message:'Starting resolution event'});var start=Date.now();var _=state._;return new Promise(function(resolve,reject){var activeIntent=state.activeIntent;if(activeIntent.substring(0,5)==='_dev_'){if(activeIntent.substring(0,13)==='_dev_backend_'){return callCustomCap(state).then(function(){state.developer.logCurrentEventDurationWithStartTime('controller',start,Date.now());});}else{state.developer.processCommand(activeIntent);}resolve();}else if(activeIntent===''){state.addActiveIntent(Intent.NO_INTENT());resolve();}else if(activeIntent!==Intent.NO_INTENT()){var bot=state.bot(Bot);_.each(bot,function(intent){if(intent.intentId===activeIntent){if(intent.onResolution){state.developer.info({message:'Starting onResolution for intent '+intent.intentId});return intent.onResolution(state).then(function(){state.developer.info({message:'Resolution passed'});resolve();state.developer.logCurrentEventDurationWithStartTime('runResolvers',start,Date.now());return state.recordActivity();}).catch(function(error){var errorCode=state.location===Intent.EDGE()?5:7;state.addSystemErrorToStack(errorCode,'Error processing resolution on edge '+error.message);resolve();state.developer.logCurrentEventDurationWithStartTime('runResolvers',start,Date.now());});}else{state.addSystemErrorToStack(3);resolve();state.developer.logCurrentEventDurationWithStartTime('runResolvers',start,Date.now());}}});}});};var msgState={msgList:[]};var tellOrTest=function tellOrTest(state,msg,botContext){if(state.unitTestMode){var currentUnitTest=void 0;var bot=state.bot(Bot);_.get(bot,function(intent){if(intent.intentId===state.activeIntent&&intent.runLocation===Intent.EDGE()){currentUnitTest=intent;return false;}});if(currentUnitTest){return currentUnitTest.onVerification().then(function(){tell(UnitTest.VERIFICATION_RUN_MSG(),botContext);});}}else{tell(msg,botContext);}};var tell=function tell(msg,botContext){botContext.tell(msg);};var syncData=function syncData(state){var promisesArray=[];if(state.location===Intent.EDGE()&&!(state.client===State.WEBCLIENT())){state._.forEach(state._syncToEdge,function(documents,collection){state._.forEach(documents,function(value,key){if(collection===ALL_CONSTANTS.PERSISTED_STORAGE){promisesArray.push(state.deviceStorage.saveKeyInStorage(key,value));}else{promisesArray.push(state.deviceStorage.saveDocument(collection,key,value));}});});if(promisesArray.length>0){return Promise.all(promisesArray).then(function(){return state.online();}).then(function(online){if(online){state._syncToEdge={};return Promise.resolve({noDataToSync:true});}else{return state.deviceStorage.getKeyFromStorage(ALL_CONSTANTS.TO_SYNC_WITH_BACKEND);}}).then(function(existingSync){var dataToSync=existingSync||{};if(state._.get(dataToSync,'noDataToSync')){return Promise.resolve();}state._.forEach(state._syncToCloud,function(documents,collection){var collectionObject=dataToSync[collection]||{};state._.forEach(documents,function(value,key){collectionObject[key]=value;});dataToSync[collection]=collectionObject;});if(state._.size(dataToSync)>0){return state.deviceStorage.saveKeyInStorage(ALL_CONSTANTS.TO_SYNC_WITH_BACKEND,dataToSync);}else{return Promise.resolve();}});}else{return Promise.resolve();}}else{return Promise.resolve();}};var processShortResponse=function processShortResponse(state){var _=state._;var D=state.developer;if(state.location===Intent.EDGE()&&state.client!==State.WEBCLIENT()){var promisesArray=[];_.forEach(state.responsesArray,function(response){if(response.type===MessageTypes.SHORT_TABLE_RESPONSE()){var processShortTableResponse=function processShortTableResponse(response){var tableMessage;return regeneratorRuntime.async(function processShortTableResponse$(_context220){while(1){switch(_context220.prev=_context220.next){case 0:D.log({message:'Calling expand table'});_context220.next=3;return regeneratorRuntime.awrap(Collection.ExpandShortTableResponse(response.message,state));case 3:tableMessage=_context220.sent;if(tableMessage){response.message=tableMessage;response.type='table';}else{delete response.message;response.type='silent';}case 5:case"end":return _context220.stop();}}},null,_this);};promisesArray.push(processShortTableResponse(response));}else if(response.type===MessageTypes.SHORT_CONTAINER_RESPONSE()){var _processShortTableResponse=function _processShortTableResponse(response){var containerData,containerMessage;return regeneratorRuntime.async(function _processShortTableResponse$(_context221){while(1){switch(_context221.prev=_context221.next){case 0:containerData=_.get(response,'message.fields');if(!containerData){_context221.next=6;break;}_context221.next=4;return regeneratorRuntime.awrap(Container.ExpandShortContainerResponse(containerData,state));case 4:containerMessage=_context221.sent;if(containerMessage){response.message.fields=containerMessage;response.type='container';}case 6:case"end":return _context221.stop();}}},null,_this);};promisesArray.push(_processShortTableResponse(response));}else if(response.type===MessageTypes.SHORT_FORM_RESPONSE()){var processShortFormResponse=function processShortFormResponse(response){var formData,formMessage;return regeneratorRuntime.async(function processShortFormResponse$(_context222){while(1){switch(_context222.prev=_context222.next){case 0:formData=_.get(response,'message.fields');if(!formData){_context222.next=6;break;}_context222.next=4;return regeneratorRuntime.awrap(Doc.ExpandShortFormResponse(formData,state));case 4:formMessage=_context222.sent;if(formMessage){response.message.fields=formMessage;response.type='form2';}case 6:case"end":return _context222.stop();}}},null,_this);};promisesArray.push(processShortFormResponse(response));}});return Promise.all(promisesArray);}return Promise.resolve();};var processGreeting=function processGreeting(state){var start,greetingIntent,onEdgeInit,onResolution,_start;return regeneratorRuntime.async(function processGreeting$(_context223){while(1){switch(_context223.prev=_context223.next){case 0:console.log('Processing greeting');start=Date.now();_context223.next=4;return regeneratorRuntime.awrap(state.resetAutoSaveBuffer());case 4:greetingIntent=state.getGreetingIntent(Bot);state.developer.logCurrentEventDurationWithStartTime('searchForMainIntent',start,Date.now());state.addActiveIntent(greetingIntent.intentId,greetingIntent.logHistory,greetingIntent.silentIntent);state._routesQueue={};state.setField(ALL_CONSTANTS.COMMON_FIELDS.LAST_MAIN_TIMESTAMP,Date.now());if(state.nlp.assistantName===NLP.DEFAULT_ASSISTANT_NAME()){state.nlp.clearConversationContext();}if(!greetingIntent){_context223.next=35;break;}state.waitingCustomCap=0;state.addRunModeResponse();onEdgeInit=greetingIntent.onInitEdge;if(!onEdgeInit){_context223.next=17;break;}_context223.next=17;return regeneratorRuntime.awrap(onEdgeInit());case 17:_context223.next=19;return regeneratorRuntime.awrap(state.onStart());case 19:_context223.t1=greetingIntent.runLocation===Intent.CLOUD();if(!_context223.t1){_context223.next=24;break;}_context223.next=23;return regeneratorRuntime.awrap(state.online());case 23:_context223.t1=_context223.sent;case 24:_context223.t0=_context223.t1;if(!_context223.t0){_context223.next=27;break;}_context223.t0=state.client===State.MOBILECLIENT()||state.client===State.EDGE_WEBCLIENT();case 27:if(!_context223.t0){_context223.next=30;break;}state.context.wait(true);return _context223.abrupt("return",callCustomCap(state));case 30:onResolution=greetingIntent.onResolution;_start=Date.now();if(greetingIntent.onError){state.onError=greetingIntent.onError;}if(!onResolution){_context223.next=35;break;}return _context223.abrupt("return",onResolution(state).then(function(){state.developer.logCurrentEventDurationWithStartTime('mainOnResolution',_start,Date.now());return state.recordActivity();}).catch(function(error){console.log('Error in main');state.addSystemErrorToStack(5,error.message);}));case 35:case"end":return _context223.stop();}}},null,_this);};var initialiseGreetingState=function initialiseGreetingState(conversation,user,stateParam,botContext,args){var emptyMessage=null;var state=new State(emptyMessage,conversation,user,Intent.EDGE(),stateParam,botContext,args);state.resetWaitingForCustomCapCounter();return state;};var startInfoLogs=function startInfoLogs(state,event,stateFromStorage){state.bot(Bot);if(event==='Greeting'){state.developer.info({message:'State initialised (Greeting)'});}else{state.developer.info({message:'State initialised (Next)'});}state.developer.info({message:'State from storage: ',data:stateFromStorage});state.developer.info({message:'Message type from user: ',data:state.messageTypeFromUser});state.developer.info({message:'Message from User: ',data:state.messageFromUser});};var continueGreeting=function continueGreeting(botContext,previousMessages,args){var start=Date.now();var conversation=null;var user=null;var state={};var sendMessageParam=null;var startStorageCap=0;var endStorageCap=0;var startConvCap=0;var endConvCap=0;var startAuthCap=Date.now();var endAuthCap=0;var authContext=botContext.getCapability('authContext');return new Promise(function(resolve,reject){if(typeof authContext.getUserData==="function"){resolve(authContext.getUserData());}else{resolve();}}).then(function(usr){if(!usr){return authContext.getAuthUser(botContext);}}).then(function(usr){endAuthCap=Date.now();startConvCap=Date.now();user=usr;var conversationContext=botContext.getCapability('ConversationContext');return conversationContext.getConversationContext(botContext,user);}).then(function(context){endConvCap=Date.now();startStorageCap=Date.now();conversation=context;deviceStorageUtil.conversation=conversation.conversationId;return deviceStorageUtil.getContext(botContext);}).then(function(stateFromStorage){endStorageCap=Date.now();var startState=Date.now();user.userName=user.info.name;user.userId=user.info.userId;user.userEmail=user.info.emailAddress;user.tz=user.info.userTimezone;state=initialiseGreetingState(conversation,user,stateFromStorage,botContext,args);state.addActiveIntent("main");startInfoLogs(state,'Greeting',stateFromStorage);state.developer.logCurrentEventDurationWithStartTime('loadAuthCap',startAuthCap,endAuthCap);state.developer.logCurrentEventDurationWithStartTime('loadConversationCap',startConvCap,endConvCap);state.developer.logCurrentEventDurationWithStartTime('loadStorageCap',startStorageCap,endStorageCap);state.developer.logCurrentEventDurationWithStartTime('initialiseGreetingState',startState,Date.now());state.fromGreeting=true;state.clearRoutesQueue();console.log("Before processing greeting");if(!state.inSilence)return processGreeting(state);}).then(function(){return processShortResponse(state);}).then(function(){return view(state,botContext);}).then(function(){return syncData(state);}).then(function(){if(state.intentResolved){state.intentResolved=false;}if(state.sendMessageParam){sendMessageParam=state.sendMessageParam;state.sendMessageParam=null;}state.developer.logCurrentEventDurationWithStartTime('allGreeting',start,Date.now());return state.save();}).then(function(){if(sendMessageParam){var message={messageFromUser:sendMessageParam};if(typeof sendMessageParam==='string'){message.messageType='string';}else{message.messageType='object';}return next(message,{},previousMessages,botContext);}}).then(function(){return{status:200};}).catch(function(error){if(state!=={}){state.developer.systemError({message:'Critical error running Greeting',data:error.message});}console.log("Critical error during greeting");return tellOrTest(state,'Something wrong has happened '+error.message,botContext);});};var greeting=function greeting(state,previousMessages,botContext){iAmTheOne='Initialised';return continueGreeting(botContext,previousMessages,state.args);};var runPredictors=function runPredictors(state){var start,_,R,predictors,sortedPredictions,theBot,index,intent,predictionObject,predictor,_index;return regeneratorRuntime.async(function runPredictors$(_context224){while(1){switch(_context224.prev=_context224.next){case 0:start=Date.now();_=state._;R=state.R;state.developer.info({message:'Starting prediction event'});if(!(_.size(state.smartSuggestionsArray)===0&&!state.blockSuggestions)){_context224.next=34;break;}predictors=false;sortedPredictions=[];theBot=state.bot(Bot);index=0;case 9:if(!(index<theBot.length)){_context224.next=33;break;}intent=theBot[index];predictionObject={};if(!(_.size(intent.suggestionsArray)>0)){_context224.next=30;break;}predictor=intent.onPrediction;if(!predictor){_context224.next=27;break;}_context224.prev=15;predictors=true;_context224.next=19;return regeneratorRuntime.awrap(predictor());case 19:predictionObject.weight=_context224.sent;_context224.next=25;break;case 22:_context224.prev=22;_context224.t0=_context224["catch"](15);state.addSystemErrorToStack(27,_context224.t0.errorMessage);case 25:_context224.next=28;break;case 27:predictionObject.weight=1;case 28:predictionObject.suggestionsArray=intent.suggestionsArray;if(predictionObject.weight>0){_index=_.sortedIndexBy(sortedPredictions,predictionObject,'weight');sortedPredictions.splice(_index,0,predictionObject);}case 30:index++;_context224.next=9;break;case 33:if(predictors){_.each(sortedPredictions,function(predictionObject){state.addSmartSuggestionsArray(predictionObject.suggestionsArray);});state.smartSuggestionsArray=_.reverse(state.smartSuggestionsArray);}case 34:state.developer.logCurrentEventDurationWithStartTime('runPredictors',start,Date.now());case 35:case"end":return _context224.stop();}}},null,_this,[[15,22]]);};var controller=function controller(state){var start=Date.now();var _=state._;state.developer.info({message:'Starting controller event'});return state.online().then(function(online){state.amIOnline=online;if(state.onlineRequired&&!online){state.addSystemErrorToStack(56);return;}return matchingLogic(state).then(function(){if(state.activeIntent!==Intent.SPEECH()&&state.activeIntent!==Intent.NO_INTENT()){if(state.toCustomCap){return callCustomCap(state).then(function(){state.developer.logCurrentEventDurationWithStartTime('controller',start,Date.now());});}else{return state.onStart().then(function(){if(!state.promptAlive||state.activeIntent.substring(0,5)==='_dev_'){if(runValidators(state)){var intentLocation=_.get(state,"intents."+state.activeIntent+".runLocation",Intent.EDGE());if(state.location===intentLocation||state.location===Intent.EDGE()&&state.client===State.WEBCLIENT()){return runResolvers(state).then(function(){state.developer.logCurrentEventDurationWithStartTime('controller',start,Date.now());return state.storeAutoSaveBuffer();});}else{state.developer.warning({message:"Bot tried to run a "+intentLocation+" intent in "+state.location,data:state.activeIntent});}}}});}}}).catch(function(error){console.log('Error in controller');var errorCode=state.location===Intent.EDGE()?5:7;state.addSystemErrorToStack(errorCode,error.message);});});};var view=function view(state,botContext){state.developer.info({message:'Starting view event'});var _=state._;var start=Date.now();return new Promise(function _callee89(resolve,reject){var noResponse,smartSuggestions,MessageForSuggestions,messageForSuggestions;return regeneratorRuntime.async(function _callee89$(_context225){while(1){switch(_context225.prev=_context225.next){case 0:if(!(state.fromGreeting&&!state.conversational&&!state.inError&&state.waitingCustomCap>0&&_.get(state.responsesArray,'length',0)===0)){_context225.next=5;break;}state.developer.info({message:'Ending here',data:{fromGreeting:state.fromGreeting,conversational:state.conversational,waitingForCustomCap:state.waitingCustomCap,responsesArrayLength:_.get(state.responsesArray,'length',0)}});state.fromGreeting=false;resolve();return _context225.abrupt("return");case 5:if(!(state.conversational&&!state.inSilence)){_context225.next=8;break;}_context225.next=8;return regeneratorRuntime.awrap(runPredictors(state));case 8:state.developer.info({message:'Start processing responses'});if(state.inError){state.onError(state);}else{if(!state.fromGreeting&&state.responsesArray.length===0&&state.smartSuggestionsArray.length===0&&!state.sendMessageParam&&!state.toCustomCap&&!state.autoResponse){noResponse={fromGreeting:state.fromGreeting,responsesQ:state.responsesArray.length,suggestionsQ:state.smartSuggestionsArray.length,sendMSG:state.sendMessageParam,toCustomCap:state.toCustomCap,activeIntent:state.activeIntent};state.developer.info({message:'Found No Intent',data:noResponse});state.addStringResponse(NO_INTENT_MESSAGE);}}state.removeActiveIntent();if(!state.silentIntent){_context225.next=16;break;}state.clearResponseArray();state.clearError();resolve();return _context225.abrupt("return");case 16:if(state.fromGreeting){state.fromGreeting=false;}smartSuggestions=state.smartSuggestionsArray;if(_.size(state.responsesArray)>0){state.intentResolved=true;_.each(state.responsesArray,function(response){var Message=state.context.getCapability('Message');var message=new Message({uuid:response.messageId});if(response.type===state.messageTypes.MESSAGE_TYPE_STRING){message.stringMessage(response.message);tellOrTest(state,message,state.context);}else if(response.type===state.messageTypes.MESSAGE_TYPE_WEB_CARD){var cards=response.message.cards;var previews=response.message.previews;message.webCard(cards,previews);tellOrTest(state,message,state.context);}else if(response.type===state.messageTypes.MESSAGE_TYPE_FORM2){var form=response.message;message.form2Message(form.fields,form.options);tellOrTest(state,message,state.context);}else if(response.type==='form_live_changes'){if(response.message.result){message.form2Message(response.message.result,response.message.options);}else{message.form2Message(response.message.options);}tellOrTest(state,message,state.context);}else if(response.type==='table_live_changes'){message.tableMessage(response.message.result,response.message.options);tellOrTest(state,message,state.context);}else if(response.type==='form_close'){if(message.closeFormMessage){message.closeFormMessage(response.message);tellOrTest(state,message,state.context);}}else if(response.type===state.messageTypes.MESSAGE_TYPE_SMART_SUGGESTIONS){smartSuggestions=response.message;}else if(response.type===state.messageTypes.MESSAGE_TYPE_TABLE){var table=response.message;if(table.options&&table.options.style===Collection.CALENDAR_TABLE_STYLE()){message.calendarMessage(table.rows,table.options);}else if(table.options&&table.options.style===ALL_CONSTANTS.COLLECTION_TYPES.MAP){message.mapMessage(table.rows,table.options);}else{message.tableMessage(table.rows,table.options);}tellOrTest(state,message,state.context);}else if(response.type==='data_card'){if(state.conversation.client===State.MOBILECLIENT()){var list=response.message;message.dataCard(list);tellOrTest(state,message,state.context);}else{var msg='Data cards are not yet available in your client';state.addSystemErrorToStack(5,msg);tellOrTest(state,msg,state.context);}}else if(response.type===state.messageTypes.MESSAGE_TYPE_CARDS){var _list=response.message.cards;var options=response.message.options;message.cards(_list,options);tellOrTest(state,message,state.context);}else if(response.type===state.messageTypes.MESSAGE_TYPE_MAP){var map=response.message;var mapObject={region:map.region,markers:_.get(map,'markers'),polylines:_.get(map,'polylines'),planeRoutes:_.get(map,'planeRoutes'),cards:_.get(map,'cards'),geoJsonUrl:_.get(map,'geoJsonUrl','')};message.mapMessage(mapObject,map.options);tellOrTest(state,message,state.context);}else if(response.type==='standard_notification'){message.standardNotification(response.message);tellOrTest(state,message,state.context);}else if(response.type==='critical_notification'){message.criticalNotification(response.message);tellOrTest(state,message,state.context);}else if(response.type==='authorization_request'){message.authorizationRequest(response.message);tellOrTest(state,message,state.context);}else if(response.type==='stripe'){if(state.client===State.MOBILECLIENT()||state.client===State.EDGE_WEBCLIENT()){var _msg='Message type not supported on this client';state.addSystemErrorToStack(5,_msg);tellOrTest(state,_msg,state.context);}else{var _response$message=response.message,amount=_response$message.amount,currency=_response$message.currency,description=_response$message.description,paymentCode=_response$message.paymentCode;if(_.isUndefined(paymentCode)||_.isEmpty(paymentCode)){paymentCode=Orders.PAYMENT_CODES().TOP_UP_WALLET;}var transactionId=state.orders.createNewStripeTransaction(amount,currency,description);var payments=state.context.getCapability('Stripe');payments.startPayment(transactionId,amount,currency,description,state.context,paymentCode);}}else if(response.type===state.messageTypes.MESSAGE_TYPE_CHART){var chart=response.message;message.chartMessage(chart.data,chart.options);tellOrTest(state,message,state.context);}else if(response.type==='prompt'){var promptEntity=response.message;var fields=state.getForm(promptEntity.form).fields;var field=fields[promptEntity.promptIndex];state.promptAlive=promptEntity.name;tellOrTest(state,field.prompt,state.context);if(field.type==='search_box'){var searchBox=state.getSearchBox(field.id);message.searchBoxMessage(searchBox.getMessageWith());state.currentSearchBox=searchBox.id;smartSuggestions=[];tellOrTest(state,message,state.context);}}else if(response.type==='search_box'){var _searchBox=void 0;if(response.message.action){_searchBox=state.getSearchBox(response.message.id);}else{_searchBox=state.getSearchBox(response.message);}message.searchBoxMessage(_searchBox.getMessageWith(response.message.action,response.message.results));state.currentSearchBox=_searchBox.id;smartSuggestions=[];tellOrTest(state,message,state.context);}else if(response.type==='slider'){message.sliderMessage(response.message.list,response.message.options);tellOrTest(state,message,state.context);}else if(response.type==='oldChart'){message.chartMessage({chart_type:'scatter',data:response.message});tellOrTest(state,message,state.context);}else if(response.type===state.messageTypes.MESSAGE_TYPE_VIDEO){message.videoMessage(response.message);tellOrTest(state,message,state.context);}else if(response.type==='trackerForm'){message.trackingViewMessage(response.message.data,response.message.options);tellOrTest(state,message,state.context);}else if(response.type==='html'){message.htmlMessage(response.message.message,response.message.options);tellOrTest(state,message,state.context);}else if(response.type==='container'){message.containerMessage(response.message.fields,response.message.options);tellOrTest(state,message,state.context);}else if(response.type==='close_control'){message.closeControlMessage(response.message);}else if(response.type==='videoCall'){message.videoCallMessage(response.message);tellOrTest(state,message,state.context);}else if(response.type==='menuMessage'){message.menuMessage(response.message);tellOrTest(state,message,state.context);}else if(response.type==='sound'){message.soundResponse(response.message);tellOrTest(state,message,state.context);}else if(response.type==='image'){message.imageMessage(response.message);tellOrTest(state,message,state.context);}else if(response.type===state.messageTypes.MESSAGE_TYPE_CSV){message.csvMessage(response.message);tellOrTest(state,message,state.context);}else if(response.type===FloorPlan.FLOOR_PLAN_MESSAGE()){message.floorplan(response.message);tellOrTest(state,message,state.context);}else if(response.type===Geofence.GEOFENCE_MESSAGE()){message.geofenceMessage(response.message.coordinates,response.message.options);tellOrTest(state,message,state.context);}else if(response.type===MessageTypes.SHORT_TABLE_RESPONSE()){}else if(response.type===MessageTypes.SHORT_CONTAINER_RESPONSE()){}else if(response.type===MessageTypes.MESSAGE_VOICE_CALL()){message.voiceCall(response.message);tellOrTest(state,message,state.context);}else if(response.type!=='silent'){var _msg2='Message type not supported';state.addSystemErrorToStack(5,_msg2);tellOrTest(state,_msg2,state.context);}});state.waitingCustomCap=0;}state.clearResponseArray();state.clearError();MessageForSuggestions=state.context.getCapability('Message');messageForSuggestions=new MessageForSuggestions();if(_.size(state.smartSuggestionsArray)>0){messageForSuggestions.smartSuggestions(smartSuggestions);state.developer.info({message:'Displaying suggestions '+JSON.stringify(smartSuggestions)});tellOrTest(state,messageForSuggestions,state.context);}else{if(state.blockSuggestions||state.inSilence){messageForSuggestions.smartSuggestions([]);tellOrTest(state,messageForSuggestions,state.context);}}state.clearSmartSuggestionsArray();state.resetOnErrorMethod();state.developer.info({message:'Finished processing responses'});state.toCustomCap=false;resolve();state.developer.logCurrentEventDurationWithStartTime('view',start,Date.now());case 30:case"end":return _context225.stop();}}},null,_this);});};var next=function next(msg,stateParam,previousMessages,botContext){var start=Date.now();var startStorageCap=0;var endStorageCap=0;var startConvCap=0;var endConvCap=0;var startAuthCap=Date.now();var endAuthCap=0;var authContext=botContext.getCapability('authContext');var conversation=null;var user=null;var state=null;var sendMessageParam=null;return new Promise(function(resolve,reject){if(typeof authContext.getUserData==="function"){resolve(authContext.getUserData());}else{resolve();}}).then(function(usr){if(!usr){return authContext.getAuthUser(botContext);}}).then(function(usr){endAuthCap=Date.now();user=usr;var conversationContext=botContext.getCapability('ConversationContext');startConvCap=Date.now();return conversationContext.getConversationContext(botContext,user);}).then(function(context){endConvCap=Date.now();conversation=context;deviceStorageUtil.conversation=conversation.conversationId;startStorageCap=Date.now();return deviceStorageUtil.getContext(botContext);}).then(function(stateFromStorage){var startState=Date.now();endStorageCap=Date.now();user.userName=user.info.name;user.userId=user.info.userId;user.userEmail=user.info.emailAddress;user.tz=user.info.userTimezone;state=new State(msg,conversation,user,Intent.EDGE(),stateFromStorage,botContext);state.removeActiveIntent();startInfoLogs(state,'Next',stateFromStorage);state.developer.logCurrentEventDurationWithStartTime('loadAuthCap',startAuthCap,endAuthCap);state.developer.logCurrentEventDurationWithStartTime('loadConversationCap',startConvCap,endConvCap);state.developer.logCurrentEventDurationWithStartTime('loadStorageCap',startStorageCap,endStorageCap);state.developer.logCurrentEventDurationWithStartTime('initialiseState',startState,Date.now());return state.loadAutoSaveBuffer();}).then(function(){state.syncWithBackendState(stateParam);if(state.client!==state.responseToClient&&state.responseToClient!==State.WEBCLIENT()){throw"Exit promise chain";}if(state.backendResponseType===0){if(msg.requestId){if(!state.markRequestIdProcessed(msg.requestId)){return Promise.resolve('ignore');}}if(state.intentResolved||state._.size(state.errorStack)>0){return Promise.resolve();}else{return controller(state);}}else if(state.backendResponseType===1){return state.save().then(function(){throw"Exit promise chain";});}else if(state.backendResponseType===2){return syncData(state).then(function(){return state.save().then(function(){throw"Exit promise chain";});});}else{return Promise.resolve('ignore');}}).then(function(noNeedForView){if(noNeedForView==='ignore'){return noNeedForView;}return processShortResponse(state);}).then(function(noNeedForView){if(noNeedForView==='ignore'){return noNeedForView;}return view(state,botContext);}).then(function(){botContext.wait(false);if(!state.silentIntent&&!state.intentResolved&&(state.waitingCustomCap>0&&state.messageTypeFromUser!=='search_box_response'&&state.messageFromUser.action!=='close'&&state.messageFromUser.action!=='move'&&state.messageFromUser.action!=='cancel'&&state.messageTypeFromUser!==MessageTypes.BOT_TO_BOT()||state.sendMessageParam)){botContext.wait(true);}if(state.intentResolved){state.intentResolved=false;}if(state.sendMessageParam){sendMessageParam=state.sendMessageParam;state.sendMessageParam=null;}state.developer.logCurrentEventDurationWithStartTime('totalNextMethod',start,Date.now());return state.save();}).then(function(){if(sendMessageParam){var message={messageFromUser:sendMessageParam};var toGreeting=false;if(typeof sendMessageParam==='string'){message.messageType='string';}else{message.messageType='object';if(sendMessageParam.intentId&&sendMessageParam.intentId==='@@reset'){toGreeting=true;}}if(toGreeting){return greeting({reset:true},previousMessages,botContext);}else{return next(message,{},previousMessages,botContext);}}}).then(function(){return{status:200};}).catch(function(error){if(error.message==="1"||typeof error==="string"){return;}if(state instanceof State){if(state.backendResponseType===0){state.addSystemErrorToStack(5,error.message);return view(state,botContext).then(function(){state.save();});}}else{console.log('Something very wrong '+error.message);}}).then(function(){return{status:200};});};var asyncResult=function asyncResult(result,stateParam,previousMessages,botContext){var utils=botContext.getCapability('Utils');var _=utils.Lodash;var state=_.get(result,'details[0].message');if(_.get(state,'success')){return;}var data={state:state,messageId:_.get(result,'messageId'),requestId:_.get(result,'requestUuid')};var requestId=_.get(result,'requestUuid');console.log('************* Data Received ****************');console.log(JSON.stringify(state));console.log('************* Data Received ****************');if(state&&requestId&&requestId!==''){var contentType=_.get(result,'contentType');var createdOn=_.get(result,'createdOn');var createdBy=_.get(result,'createdBy');var messageId=_.get(result,'messageId');var message={messageDate:createdOn,createdBy:createdBy,uuid:messageId,requestId:requestId,contentType:contentType};if(contentType===MessageTypes.BACKEND_RESPONSE()){message.messageType=MessageTypes.BACKEND_RESPONSE();}else{message.messageType=MessageTypes.BOT_TO_BOT();message.messageFromUser=state;}return next(message,state,previousMessages,botContext);}};var debug=function debug(state){return{localState:state};};var runNlp=function runNlp(state){var D=state.developer;var nlpBotsList=state.nlp.nlpIds;state.developer.info({message:'Starting NLP event',data:nlpBotsList});if(!state.inSilence&&state.messageTypeFromUser==='string'){if(state.nlp.nlpEngine===NLP.DIALOGFLOW()){if(nlpBotsList.length>0){var params={capability:'NLP2',capabilityFileName:'nlpv2',queryString:state.messageFromUser,nlpIds:nlpBotsList,sync:true,userId:state.user.userId,conversation:state.conversation};return state.callCapability(params);}else{state.developer.warning({message:'No NLP Engine added to the bot'});}return[];}else if(state.nlp.nlpEngine===NLP.OPEN_AI()){return state.nlp.callOpenAIWithMessageFromUser();}else{return new Promise(function(resolve,reject){var params={botAlias:state.nlp.nlpAlias,botName:state.nlp.nlpIds[0],inputText:state.messageFromUser,userId:state.conversationId,sessionAttributes:{}};var lexRuntime=new state.aws.LexRuntime();lexRuntime.postText(params,function(err,data){if(err)resolve(err);else resolve(data);});});}}};var processNLPResponse=function processNLPResponse(state,dataArray){var _=state._;var R=state.R;var startNLP=Date.now();if(state.nlp.nlpEngine===NLP.DIALOGFLOW()){_.each(dataArray,function(nlpResponse){state.developer.info({message:'Response from NLP',data:nlpResponse});if(nlpResponse.error==='Invalid NLP ID'){state.addSystemErrorToStack(24,nlpResponse.nlpId);return;}var nlpParameters='';var action=nlpResponse.action;var nlpId=nlpResponse.nlpId;state.developer.info({message:'Found NLP action: ',data:action});if(nlpResponse.parameters&&_.size(nlpResponse.parameters)>0){nlpParameters=nlpResponse.parameters;state.developer.info({message:'Found NLP parameters: ',data:nlpParameters});}var suggestions=[];if(nlpResponse.messages){_.forEach(nlpResponse.messages,function(entry){if(entry.type===4){if(entry.payload.messages){state.addSmartSuggestionsArray([{lang:state.lang,list:entry.payload.messages}]);suggestions=entry.payload.messages;}}});}state.nlpResults[nlpId]={speech:''};if(nlpResponse.speech&&nlpResponse.speech!==''){state.nlpResults[nlpId].speech=nlpResponse.speech;}state.nlpResults[nlpId].action=action;state.nlpResults[nlpId].nlpParameters=state.nlp.getNlpParameters(nlpParameters);state.nlpResults[nlpId].nlpSuggestions=suggestions;});}else{var nlpId=state.nlp.nlpIds[0];state.nlpResults[nlpId]={action:dataArray.intentName,nlpParameters:dataArray.slots};if(dataArray.message!==''){state.nlpResults[nlpId].speech=dataArray.message;}}state.developer.logCurrentEventDurationWithStartTime('nlpAnalysis',startNLP,Date.now());};var matchingLogic=function matchingLogic(state){var _,R,D,devIntent,startNLP,dataArray,unambiguousResults,latestNoIntentSpeech;return regeneratorRuntime.async(function matchingLogic$(_context226){while(1){switch(_context226.prev=_context226.next){case 0:_=state._;R=state.R;D=state.developer;if(!state.developer.isDeveloperIntent()){_context226.next=8;break;}devIntent=state.developer.identifyDeveloperIntent();if(!devIntent){_context226.next=8;break;}state.addActiveIntent(devIntent,false);return _context226.abrupt("return");case 8:state.developer.info({message:'Starting matching logic'});if(!(state.fromGreeting&&!state.inSilence&&state.location===Intent.CLOUD())){_context226.next=13;break;}state.developer.info({message:'No matching required'});_context226.next=38;break;case 13:if(!(state.activeIntent==='')){_context226.next=35;break;}_context226.next=16;return regeneratorRuntime.awrap(runMatchers(state));case 16:if(!(state.activeIntent==='')){_context226.next=32;break;}startNLP=Date.now();if(!(state.location===Intent.CLOUD()||state.client===State.WEBCLIENT())){_context226.next=24;break;}_context226.next=21;return regeneratorRuntime.awrap(runNlp(state));case 21:_context226.t0=_context226.sent;_context226.next=25;break;case 24:_context226.t0=[];case 25:dataArray=_context226.t0;D.logCurrentEventDurationWithStartTime('nlpCalls',startNLP,Date.now());if(!(Array.isArray(dataArray)&&dataArray.length>0)){_context226.next=32;break;}D.debug({message:'Before processing NLP',data:dataArray});processNLPResponse(state,dataArray);_context226.next=32;return regeneratorRuntime.awrap(runMatchers(state));case 32:if(state.activeIntent===''){if(_.size(state.nlpResults)>0){unambiguousResults=true;latestNoIntentSpeech="Sorry, I didn't get that";_.each(state.nlpResults,function(result){if(result.speech!==''){if(result.action===Intent.NO_INTENT()){latestNoIntentSpeech=result.speech;state.addActiveIntent(Intent.NO_INTENT());}else{if(unambiguousResults){state.addActiveIntent(Intent.SPEECH());state.addStringResponse(result.speech);unambiguousResults=false;}else{if(!state.disambiguate){state.addSystemErrorToStack(22);}}}}});if(state.responsesArray.length===0){state.addStringResponse(latestNoIntentSpeech);}}}_context226.next=36;break;case 35:state.developer.info({message:'Intent already matched ',data:state.activeIntent});case 36:_context226.next=38;return regeneratorRuntime.awrap(state.recordActivity());case 38:case"end":return _context226.stop();}}},null,_this);};var asyncRequest=function asyncRequest(params,dependencies,botContext){var Promise=dependencies.promise;var _=dependencies._;var R=dependencies.R;var start=Date.now();var startAutoSaveBuffer=0;var stateFromEdge=params.state;var conversationFromEdge=params.conversation;var userFromEdge={userId:params.userId,userEmail:params.userEmail,userDomains:params.userDomains,userName:params.state.userName,tz:params.userTimezone};var emptyMessage=null;var state=void 0;if(stateFromEdge.v1Compatibility){userFromEdge.info={};userFromEdge.info.userName=params.state.userName;userFromEdge.info.domains=params.userDomains;conversationFromEdge.client=State.WEBCLIENT();state=new State(emptyMessage,conversationFromEdge,userFromEdge,Intent.EDGE(),stateFromEdge,botContext);}else{state=new State(emptyMessage,conversationFromEdge,userFromEdge,Intent.CLOUD(),stateFromEdge,dependencies);}state.developer.info({message:'State initialised (cloud)',data:params});state.bot(Bot);var greetingIntent=state.getGreetingIntent(Bot);return state.onStart().then(function(){if(state.v1Compatibility){return Promise.resolve();}return state.syncDataToDB();}).then(function(){if(state.v1Compatibility){return Promise.resolve();}return state.sendDelayedNotifications();}).then(function(){if(state.v1Compatibility){return Promise.resolve();}if(state.fromGreeting){return state.resetAutoSaveBuffer();}else{return state.loadAutoSaveBuffer();}}).then(function(){state.nlpResults={};return matchingLogic(state);}).then(function(){var onInitCloud=greetingIntent.onInitCloud;if(onInitCloud){return onInitCloud();}}).then(function(){if(state.fromGreeting&&!state.inSilence){var _start2=Date.now();var onResolution=greetingIntent.onResolution;if(greetingIntent.onError){state.onError=greetingIntent.onError;}if(onResolution){state.addActiveIntent('main');return onResolution(state).then(function(){var size=state.sizeOfObject(JSON.stringify(state.getAllProperties()));state.developer.logCurrentEventDurationWithStartTime('mainOnResolution',_start2,Date.now());startAutoSaveBuffer=Date.now();if(state.inError){state.onError();}return state.storeAutoSaveBuffer().then(function(){return state.recordActivity();});});}else{return;}}if(state.inError){return;}var startController=Date.now();if(state.activeIntent!==''&&state.activeIntent!==Intent.SPEECH()&&state.activeIntent!==Intent.NO_INTENT()){runValidators(state);if(_.size(state.errorStack)===0){return runResolvers(state).then(function(){state.developer.logCurrentEventDurationWithStartTime('backendController',startController,Date.now());if(state.v1Compatibility){return Promise.resolve();}startAutoSaveBuffer=Date.now();return state.storeAutoSaveBuffer();});}}}).then(function(){state.developer.logCurrentEventDurationWithStartTime('startAutoSaveBuffer',startAutoSaveBuffer,Date.now());if(_.size(state.responsesArray)>0||state.inError||state.sendMessageParam||state.fromGreeting){state.intentResolved=true;if(state.activeIntent.substring(0,5)==='_dev_'){state.removeActiveIntent();}}else{if(state.cloudIntent){state.intentResolved=false;state.developer.info({message:'Found No intent'});state.addActiveIntent(Intent.NO_INTENT());}}try{if(state._.size(state.errorStack)>0){state.onError(state);state.resetOnErrorMethod();}}catch(err){state.addSystemErrorToStack(11,err.message);}state.fromGreeting=false;if(state.v1Compatibility){return view(state,botContext);}else{state.developer.logCurrentEventDurationWithStartTime('fullCustomCap',start,Date.now());var content=state.getFinalResponseState();return state.sendResponseToClient(content);}}).then(function(){if(state.v1Compatibility)return;var content=state.getFinalResponseSync();return state.sendResponseToClient(content);}).then(function(){if(state.v1Compatibility)return;var response=state.getFinalResponsesArray();state.developer.info({message:'Response to Edge',data:response});return state.apiResponse?response:state.sendResponseToClient(response);}).then(function(){var responseArray=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};state=null;return responseArray;}).catch(function(error){state.addSystemErrorToStack(8,error);var response=state.getFinalResponseState();state=null;return response;});};var farewell=function farewell(msg,state,previousMessages,botContext){};var open=function open(msg,state,previousMessages,botContext){};return{done:farewell,init:greeting,next:next,open:open,debug:debug,asyncResult:asyncResult,asyncRequest:asyncRequest,version:'1.0.0'};})();